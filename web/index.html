<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>StudyBot Pro ‚Äî Smart Study Companion</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,400;1,700&family=Playfair+Display:ital,wght@0,600;0,700;0,800;0,900;1,700;1,900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{font-size:18px;scroll-behavior:smooth}
:root{
  --bg:#F4F6FF;--surface:#FFFFFF;--surface2:#EEF1FB;--surface3:#E2E7F7;
  --border:#DDE2F5;--border2:#BFC8EE;
  --tx:#080E28;--tx2:#1E2A5E;--tx3:#5A6490;--tx4:#9AA4CC;
  --acc:#3D5AFE;--acc2:#7986FF;--acc-bg:#EBF0FF;--acc-dark:#2344E8;
  --green:#15A352;--green-bg:#EDFAF3;--green-border:#A8EEC8;
  --red:#E03131;--red-bg:#FFF0F0;--red-border:#FFC9C9;
  --amber:#D97706;--amber-bg:#FFFBEB;--amber-border:#FDE68A;
  --purple:#7B2FBE;--purple-bg:#F6F0FF;--purple-border:#C9B0F0;
  --teal:#0B8E85;--teal-bg:#EDFAF9;--pink:#D63384;
  --shadow-xs:0 1px 3px rgba(61,90,254,.07);
  --shadow-sm:0 2px 10px rgba(61,90,254,.10),0 1px 3px rgba(0,0,0,.04);
  --shadow:0 6px 24px rgba(61,90,254,.12),0 2px 8px rgba(0,0,0,.04);
  --shadow-lg:0 14px 48px rgba(61,90,254,.14),0 4px 14px rgba(0,0,0,.06);
  --shadow-xl:0 28px 72px rgba(61,90,254,.18),0 8px 24px rgba(0,0,0,.08);
  --r:16px;--r-sm:11px;--r-lg:22px;--r-xl:30px;
  --font:'Plus Jakarta Sans',sans-serif;--font-d:'Plus Jakarta Sans',sans-serif;--font-mono:'JetBrains Mono',monospace;
  --tr:.22s cubic-bezier(.4,0,.2,1);
}
[data-theme="dark"]{
  --bg:#07091A;--surface:#0D1126;--surface2:#13192E;--surface3:#1A213A;
  --border:#222A48;--border2:#2E3860;
  --tx:#ECF0FF;--tx2:#A8B6E8;--tx3:#5C6A9A;--tx4:#333D62;
  --acc:#6B8BFF;--acc2:#9AABFF;--acc-bg:#131E48;--acc-dark:#8BA5FF;
  --green:#22C55E;--green-bg:#061612;--green-border:#134E29;
  --red:#F87171;--red-bg:#1A0808;--red-border:#7F1D1D;
  --amber:#FBBF24;--amber-bg:#180E00;--amber-border:#78350F;
  --purple:#C084FC;--purple-bg:#130A28;--purple-border:#581C87;
  --teal:#2DD4BF;--teal-bg:#031412;--pink:#F472B6;
  --shadow-xs:0 1px 3px rgba(0,0,0,.5);
  --shadow-sm:0 2px 10px rgba(0,0,0,.6);
  --shadow:0 6px 24px rgba(0,0,0,.55);
  --shadow-lg:0 14px 48px rgba(0,0,0,.65);
  --shadow-xl:0 28px 72px rgba(0,0,0,.75);
}
body{background:var(--bg);color:var(--tx);font-family:var(--font);font-size:1rem;line-height:1.65;-webkit-font-smoothing:antialiased;overflow-x:hidden;transition:background .4s,color .4s;max-width:100vw}
*{max-width:100%;word-break:break-word}
::-webkit-scrollbar{width:5px;height:5px}::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px}
button,input,select,textarea{font-family:var(--font)}a{color:var(--acc);text-decoration:none}

@keyframes fadeUp{from{opacity:0;transform:translateY(28px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes scaleIn{from{opacity:0;transform:scale(.9) translateY(12px)}to{opacity:1;transform:scale(1) translateY(0)}}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes toastIn{from{opacity:0;transform:translateX(110%) scale(.9)}to{opacity:1;transform:translateX(0) scale(1)}}
@keyframes toastOut{from{opacity:1;transform:translateX(0) scale(1)}to{opacity:0;transform:translateX(110%) scale(.9)}}
@keyframes floatBg{0%,100%{transform:translateY(0) rotate(0)}50%{transform:translateY(-22px) rotate(6deg)}}
@keyframes countUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
@keyframes popIn{from{transform:scale(.3);opacity:0}to{transform:scale(1);opacity:1}}
@keyframes xpFloat{0%{opacity:1;transform:translateY(0) scale(1)}100%{opacity:0;transform:translateY(-70px) scale(.7)}}
@keyframes confetti{0%{transform:translateY(0) rotate(0);opacity:1}100%{transform:translateY(-120px) rotate(720deg);opacity:0}}
@keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-9px)}}
@keyframes shimmer{0%{background-position:-200% 0}100%{background-position:200% 0}}
@keyframes glow{0%,100%{box-shadow:0 0 20px rgba(61,90,254,.3)}50%{box-shadow:0 0 40px rgba(61,90,254,.6)}}
@keyframes slideRight{from{transform:translateX(-100%)}to{transform:translateX(0)}}
@keyframes typewriter{from{width:0}to{width:100%}}

/* ‚îÄ‚îÄ LANDING ‚îÄ‚îÄ */
#landingPage{min-height:100vh;display:flex;flex-direction:column}
.land-nav{position:sticky;top:0;z-index:50;background:rgba(244,246,255,.9);backdrop-filter:blur(22px);-webkit-backdrop-filter:blur(22px);border-bottom:1px solid var(--border);padding:0 5%;height:72px;display:flex;align-items:center;justify-content:space-between;transition:all .4s}
[data-theme="dark"] .land-nav{background:rgba(7,9,26,.9)}
.land-logo{display:flex;align-items:center;gap:12px;font-family:var(--font-d);font-weight:900;font-size:1.5rem;color:var(--tx)}
.land-logo-ic{width:42px;height:42px;background:linear-gradient(135deg,var(--acc),var(--purple));border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:1.2rem;box-shadow:0 4px 16px rgba(61,90,254,.4);transition:transform .25s}
.land-logo:hover .land-logo-ic{transform:rotate(-10deg) scale(1.12)}
.land-nav-right{display:flex;align-items:center;gap:11px}
.btn-outline{padding:9px 22px;border-radius:100px;border:1.5px solid var(--border2);background:transparent;color:var(--tx2);font-size:.9rem;font-weight:700;cursor:pointer;transition:all var(--tr)}
.btn-outline:hover{border-color:var(--acc);color:var(--acc);background:var(--acc-bg)}
.btn-solid{padding:10px 24px;border-radius:100px;border:none;background:var(--acc);color:#fff;font-size:.9rem;font-weight:800;cursor:pointer;transition:all var(--tr);box-shadow:0 4px 16px rgba(61,90,254,.35)}
.btn-solid:hover{background:var(--acc-dark);transform:translateY(-2px);box-shadow:0 10px 28px rgba(61,90,254,.45)}
.theme-toggle-btn{width:40px;height:40px;border-radius:13px;border:1.5px solid var(--border);background:transparent;color:var(--tx2);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1.05rem;transition:all var(--tr)}
.theme-toggle-btn:hover{background:var(--surface2);transform:rotate(20deg)}

.hero{flex:1;display:flex;align-items:center;justify-content:center;padding:110px 5% 90px;text-align:center;position:relative;overflow:hidden}
.hero-bg{position:absolute;inset:0;pointer-events:none;overflow:hidden}
.hero-blob{position:absolute;border-radius:50%;filter:blur(100px);opacity:.12;animation:floatBg 10s ease-in-out infinite}
.hero-blob1{width:750px;height:750px;background:var(--acc);top:-280px;left:-280px}
.hero-blob2{width:650px;height:650px;background:var(--purple);top:50px;right:-280px;animation-delay:3s}
.hero-blob3{width:550px;height:550px;background:var(--teal);bottom:-180px;left:28%;animation-delay:1.5s}
.hero-grid{position:absolute;inset:0;background-image:linear-gradient(rgba(61,90,254,.05) 1px,transparent 1px),linear-gradient(90deg,rgba(61,90,254,.05) 1px,transparent 1px);background-size:52px 52px}
.hero-content{position:relative;z-index:1;max-width:780px}
.hero-badge{display:inline-flex;align-items:center;gap:8px;padding:8px 20px;background:var(--acc-bg);border:1px solid rgba(61,90,254,.3);border-radius:100px;font-size:.76rem;font-weight:800;color:var(--acc);letter-spacing:1.8px;text-transform:uppercase;margin-bottom:34px;animation:fadeUp .7s ease both}
.hero-h1{font-family:var(--font-d);font-size:clamp(3.2rem,7vw,6rem);font-weight:900;line-height:1.02;letter-spacing:-2px;margin-bottom:30px;color:var(--tx);animation:fadeUp .7s .1s ease both}
.hero-h1 em{font-style:italic;color:var(--acc)}
.hero-sub{font-size:1.18rem;color:var(--tx3);max-width:560px;margin:0 auto 48px;line-height:1.8;animation:fadeUp .7s .2s ease both;font-weight:400}
.hero-btns{display:flex;gap:16px;justify-content:center;flex-wrap:wrap;animation:fadeUp .7s .3s ease both}
.btn-hero-prim{padding:18px 44px;border-radius:100px;border:none;background:var(--acc);color:#fff;font-size:1.05rem;font-weight:800;cursor:pointer;transition:all .28s;box-shadow:0 8px 28px rgba(61,90,254,.45);display:inline-flex;align-items:center;gap:9px}
.btn-hero-prim:hover{background:var(--acc-dark);transform:translateY(-3px);box-shadow:0 16px 40px rgba(61,90,254,.55)}
.btn-hero-sec{padding:18px 44px;border-radius:100px;border:1.5px solid var(--border2);background:var(--surface);color:var(--tx2);font-size:1.05rem;font-weight:700;cursor:pointer;transition:all .28s}
.btn-hero-sec:hover{border-color:var(--acc);color:var(--acc);background:var(--acc-bg);transform:translateY(-2px)}
.hero-stats{display:flex;gap:56px;justify-content:center;margin-top:72px;animation:fadeUp .7s .45s ease both;flex-wrap:wrap}
.hero-stat-val{font-family:var(--font-d);font-size:2.6rem;font-weight:900;color:var(--tx)}
.hero-stat-lbl{font-size:.78rem;font-weight:700;color:var(--tx3);text-transform:uppercase;letter-spacing:.5px}

/* LANDING SECTIONS */
.section-label{display:inline-block;padding:6px 18px;background:var(--acc-bg);border-radius:100px;font-size:.74rem;font-weight:800;color:var(--acc);letter-spacing:1.8px;text-transform:uppercase;margin-bottom:18px}
.section-h2{font-family:var(--font-d);font-size:clamp(2rem,4vw,3.2rem);font-weight:900;line-height:1.08;color:var(--tx);margin-bottom:18px}
.section-h2 em{font-style:italic;color:var(--acc)}
.section-p{color:var(--tx3);font-size:1.05rem;max-width:540px;line-height:1.8;margin-bottom:56px}
.feat-section{padding:100px 5%;background:var(--surface)}
.features-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(295px,1fr));gap:22px}
.feat-card{background:var(--bg);border:1px solid var(--border);border-radius:var(--r-lg);padding:34px;transition:all .3s;position:relative;overflow:hidden;cursor:default}
.feat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--acc),var(--purple));opacity:0;transition:opacity .3s}
.feat-card:hover{transform:translateY(-7px);box-shadow:var(--shadow-lg);border-color:rgba(61,90,254,.3)}
.feat-card:hover::before{opacity:1}
.feat-icon{width:62px;height:62px;border-radius:18px;display:flex;align-items:center;justify-content:center;font-size:1.8rem;margin-bottom:20px;transition:transform .3s}
.feat-card:hover .feat-icon{transform:scale(1.12) rotate(-6deg)}
.feat-title{font-weight:800;font-size:1.08rem;margin-bottom:10px;color:var(--tx)}
.feat-desc{font-size:.93rem;color:var(--tx3);line-height:1.7}

/* HOW IT WORKS SECTION */
.how-section{padding:100px 5%;background:var(--bg)}
.steps-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:28px}
.step-card{text-align:center;padding:36px 28px}
.step-num{width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,var(--acc),var(--purple));color:#fff;font-family:var(--font-d);font-weight:900;font-size:1.6rem;display:flex;align-items:center;justify-content:center;margin:0 auto 20px;box-shadow:0 8px 24px rgba(61,90,254,.4);animation:glow 3s ease infinite}
.step-title{font-family:var(--font-d);font-size:1.15rem;font-weight:700;color:var(--tx);margin-bottom:10px}
.step-desc{font-size:.95rem;color:var(--tx3);line-height:1.75}

/* TESTIMONIALS */
.testimonials-section{padding:100px 5%;background:var(--surface);overflow:hidden}
.testi-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:22px}
.testi-card{background:var(--bg);border:1px solid var(--border);border-radius:var(--r-lg);padding:30px;transition:all .3s}
.testi-card:hover{transform:translateY(-5px);box-shadow:var(--shadow)}
.testi-stars{font-size:1rem;color:var(--amber);margin-bottom:14px;letter-spacing:2px}
.testi-text{font-size:.98rem;color:var(--tx2);line-height:1.8;margin-bottom:18px;font-style:italic}
.testi-author{display:flex;align-items:center;gap:12px}
.testi-av{width:42px;height:42px;border-radius:50%;background:linear-gradient(135deg,var(--acc),var(--purple));display:flex;align-items:center;justify-content:center;font-weight:900;color:#fff;font-size:.9rem}
.testi-name{font-weight:800;font-size:.9rem;color:var(--tx)}
.testi-role{font-size:.76rem;color:var(--tx3)}

/* STATS STRIP */
.stats-strip{background:linear-gradient(135deg,var(--acc),var(--purple));padding:72px 5%;text-align:center}
.stats-strip-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:40px;max-width:900px;margin:0 auto}
.ss-val{font-family:var(--font-d);font-size:3rem;font-weight:900;color:#fff;line-height:1}
.ss-lbl{font-size:.82rem;font-weight:700;color:rgba(255,255,255,.75);text-transform:uppercase;letter-spacing:1px;margin-top:6px}

/* FAQ */
.faq-section{padding:100px 5%;background:var(--bg)}
.faq-list{max-width:720px;margin:0 auto}
.faq-item{border:1px solid var(--border);border-radius:var(--r);margin-bottom:12px;overflow:hidden;transition:all .2s}
.faq-item:hover{border-color:var(--acc-bg)}
.faq-q{padding:22px 24px;font-weight:800;font-size:1rem;color:var(--tx);cursor:pointer;display:flex;justify-content:space-between;align-items:center;background:var(--surface)}
.faq-q:hover{background:var(--surface2)}
.faq-arrow{transition:transform .3s;font-size:1.1rem;color:var(--acc)}
.faq-item.open .faq-arrow{transform:rotate(180deg)}
.faq-a{padding:0 24px;max-height:0;overflow:hidden;transition:max-height .35s ease,padding .35s ease;font-size:.95rem;color:var(--tx3);line-height:1.8;background:var(--surface)}
.faq-item.open .faq-a{padding:0 24px 22px;max-height:300px}

.land-footer{background:var(--surface);border-top:1px solid var(--border);padding:36px 5%;display:flex;align-items:center;justify-content:space-between;font-size:.84rem;color:var(--tx4);flex-wrap:wrap;gap:12px}

/* ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ */
#authPage{display:none;min-height:100vh;align-items:center;justify-content:center;padding:24px;background:var(--bg);position:relative;overflow:hidden}
.auth-blob{position:absolute;border-radius:50%;filter:blur(80px);opacity:.09;pointer-events:none}
.auth-blob1{width:550px;height:550px;background:var(--acc);top:-180px;left:-180px}
.auth-blob2{width:450px;height:450px;background:var(--purple);bottom:-120px;right:-120px}
.auth-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r-xl);padding:48px 44px;width:100%;max-width:480px;box-shadow:var(--shadow-xl);position:relative;z-index:1;animation:scaleIn .38s cubic-bezier(.34,1.56,.64,1)}
.auth-logo-ic{width:62px;height:62px;background:linear-gradient(135deg,var(--acc),var(--purple));border-radius:20px;display:flex;align-items:center;justify-content:center;font-size:1.9rem;margin:0 auto 16px;box-shadow:0 10px 32px rgba(61,90,254,.4);animation:bounce 2s ease infinite}
.auth-title{font-family:var(--font-d);font-weight:900;font-size:1.8rem;color:var(--tx);text-align:center;margin-bottom:6px}
.auth-sub{text-align:center;color:var(--tx3);font-size:.95rem;margin-bottom:30px}
.auth-tabs{display:flex;gap:4px;background:var(--surface2);border-radius:var(--r-sm);padding:4px;margin-bottom:26px}
.auth-tab{flex:1;padding:10px;border-radius:9px;border:none;background:transparent;color:var(--tx3);font-weight:800;font-size:.9rem;cursor:pointer;transition:all var(--tr);font-family:var(--font)}
.auth-tab.active{background:var(--surface);color:var(--acc);box-shadow:var(--shadow-sm)}
.form-grp{margin-bottom:18px}
.form-lbl{display:block;font-size:.76rem;font-weight:800;color:var(--tx2);margin-bottom:8px;letter-spacing:.5px;text-transform:uppercase}
.form-inp{width:100%;padding:13px 16px;border:1.5px solid var(--border);background:var(--surface2);border-radius:var(--r-sm);color:var(--tx);font-size:.97rem;outline:none;transition:all var(--tr);font-family:var(--font)}
.form-inp:focus{border-color:var(--acc);background:var(--surface);box-shadow:0 0 0 4px rgba(61,90,254,.12)}
.form-inp::placeholder{color:var(--tx4)}
.form-err{font-size:.76rem;color:var(--red);margin-top:6px;display:none;animation:fadeUp .2s ease}
.form-sel{width:100%;padding:13px 16px;border:1.5px solid var(--border);background:var(--surface2);border-radius:var(--r-sm);color:var(--tx);font-size:.97rem;outline:none;cursor:pointer;transition:all var(--tr);-webkit-appearance:none;font-family:var(--font)}
.form-sel:focus{border-color:var(--acc);box-shadow:0 0 0 4px rgba(61,90,254,.12)}
.form-ta{width:100%;padding:13px 16px;border:1.5px solid var(--border);background:var(--surface2);border-radius:var(--r-sm);color:var(--tx);font-size:.97rem;outline:none;resize:vertical;min-height:95px;transition:all var(--tr);font-family:var(--font)}
.form-ta:focus{border-color:var(--acc);background:var(--surface);box-shadow:0 0 0 4px rgba(61,90,254,.12)}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.btn-full{width:100%;padding:14px;background:var(--acc);color:#fff;border:none;border-radius:var(--r-sm);font-weight:800;font-size:1rem;cursor:pointer;transition:all var(--tr);display:flex;align-items:center;justify-content:center;gap:9px;font-family:var(--font)}
.btn-full:hover{background:var(--acc-dark);transform:translateY(-1px);box-shadow:0 8px 24px rgba(61,90,254,.45)}
.ql-section{margin-top:22px;padding-top:20px;border-top:1px solid var(--border)}
.ql-lbl{font-size:.68rem;font-weight:800;color:var(--tx4);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:10px;text-align:center}
.ql-chips{display:flex;flex-wrap:wrap;gap:8px;justify-content:center}
.ql-chip{padding:6px 16px;background:var(--surface2);border:1px solid var(--border);border-radius:100px;font-size:.82rem;color:var(--tx2);cursor:pointer;transition:all .15s;font-weight:600}
.ql-chip:hover{border-color:var(--acc);color:var(--acc);background:var(--acc-bg)}
.auth-back{text-align:center;margin-top:20px;font-size:.85rem;color:var(--tx3)}

/* ‚îÄ‚îÄ APP ‚îÄ‚îÄ */
#app{display:none;height:100vh;overflow:hidden;flex-direction:column}
#app.visible{display:flex}
.app-body{flex:1;display:grid;grid-template-columns:66px 1fr;overflow:hidden;transition:grid-template-columns .35s cubic-bezier(.4,0,.2,1)}
.app-body.sb-open{grid-template-columns:272px 1fr}

.topbar{height:68px;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 22px;gap:13px;flex-shrink:0;z-index:40;transition:background .4s;min-width:0}
.topbar-hamburger{width:40px;height:40px;border-radius:var(--r-sm);border:1.5px solid var(--border);background:transparent;color:var(--tx3);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1.05rem;transition:all var(--tr);flex-shrink:0}
.topbar-hamburger:hover{background:var(--surface2);color:var(--tx);transform:scale(1.05)}
.topbar-title{font-family:var(--font-d);font-weight:800;font-size:1.18rem;flex:1;min-width:0;color:var(--tx);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.topbar-right{display:flex;align-items:center;gap:9px;flex-shrink:0}
.tb-ic-btn{width:40px;height:40px;border-radius:var(--r-sm);border:1.5px solid var(--border);background:transparent;color:var(--tx3);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all var(--tr);position:relative;font-size:1rem;flex-shrink:0}
.tb-ic-btn:hover{background:var(--surface2);color:var(--tx);transform:scale(1.05)}
.notif-dot{position:absolute;top:6px;right:6px;width:8px;height:8px;background:var(--red);border-radius:50%;border:2px solid var(--surface);display:none;animation:pulse 1.5s infinite}
.notif-dot.show{display:block}
.user-pill{display:flex;align-items:center;gap:9px;padding:5px 15px 5px 5px;background:var(--surface2);border:1px solid var(--border);border-radius:100px;cursor:pointer;transition:all var(--tr)}
.user-pill:hover{border-color:var(--acc);box-shadow:0 0 0 3px rgba(61,90,254,.1)}
.user-pill-av{width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,var(--acc),var(--purple));display:flex;align-items:center;justify-content:center;font-weight:900;font-size:.82rem;color:#fff;flex-shrink:0}
.user-pill-name{font-size:.85rem;font-weight:700;color:var(--tx)}

.sidebar{background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;transition:all .35s cubic-bezier(.4,0,.2,1)}
.sb-logo{display:flex;align-items:center;gap:11px;padding:20px 15px 18px;border-bottom:1px solid var(--border);flex-shrink:0}
.sb-logo-ic{width:36px;height:36px;background:linear-gradient(135deg,var(--acc),var(--purple));border-radius:11px;display:flex;align-items:center;justify-content:center;font-size:1.05rem;flex-shrink:0;transition:transform .3s}
.sb-logo:hover .sb-logo-ic{transform:rotate(-9deg)}
.sb-logo-txt{font-family:var(--font-d);font-weight:900;font-size:1.1rem;color:var(--tx);white-space:nowrap;opacity:0;transition:opacity .2s .1s}
.app-body.sb-open .sb-logo-txt{opacity:1}
.sb-nav{flex:1;overflow-y:auto;padding:11px 9px;overflow-x:hidden}
.sb-section{margin-bottom:5px}
.sb-section-lbl{font-size:.62rem;font-weight:800;letter-spacing:2px;text-transform:uppercase;color:var(--tx4);padding:11px 9px 5px;white-space:nowrap;opacity:0;transition:opacity .2s}
.app-body.sb-open .sb-section-lbl{opacity:1}
.sb-btn{width:100%;display:flex;align-items:center;gap:12px;padding:11px 11px;border-radius:var(--r-sm);border:none;background:transparent;color:var(--tx3);font-size:.9rem;font-weight:500;cursor:pointer;transition:all .18s;text-align:left;white-space:nowrap;overflow:hidden;position:relative;font-family:var(--font)}
.sb-btn:hover{background:var(--surface2);color:var(--tx)}
.sb-btn.active{background:var(--acc-bg);color:var(--acc);font-weight:800}
.sb-btn::before{content:'';position:absolute;left:0;top:50%;transform:translateY(-50%);width:3px;height:0;background:var(--acc);border-radius:0 3px 3px 0;transition:height .2s}
.sb-btn.active::before{height:26px}
.sb-ic{width:26px;height:26px;display:flex;align-items:center;justify-content:center;font-size:1.05rem;flex-shrink:0;transition:transform .2s}
.sb-btn:hover .sb-ic{transform:scale(1.15)}
.sb-lbl{opacity:0;transition:opacity .15s .05s;white-space:nowrap}
.app-body.sb-open .sb-lbl{opacity:1}
.sb-badge{margin-left:auto;background:var(--red);color:#fff;font-size:.6rem;font-weight:900;min-width:19px;height:19px;border-radius:10px;display:flex;align-items:center;justify-content:center;padding:0 5px;flex-shrink:0;animation:popIn .3s cubic-bezier(.34,1.56,.64,1)}
.sb-bottom{padding:11px 9px;border-top:1px solid var(--border);flex-shrink:0}
.sb-xp-wrap{padding:9px 11px 7px;opacity:0;transition:opacity .2s;overflow:hidden}
.app-body.sb-open .sb-xp-wrap{opacity:1}
.sb-user{display:flex;align-items:center;gap:11px;padding:11px;border-radius:var(--r-sm);cursor:pointer;transition:background .15s}
.sb-user:hover{background:var(--surface2)}
.sb-user-av{width:36px;height:36px;border-radius:12px;background:linear-gradient(135deg,var(--acc),var(--purple));display:flex;align-items:center;justify-content:center;font-weight:900;font-size:.85rem;color:#fff;flex-shrink:0}
.sb-user-info{opacity:0;transition:opacity .2s;min-width:0}
.app-body.sb-open .sb-user-info{opacity:1}
.sb-user-name{font-size:.86rem;font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:var(--tx)}
.sb-user-role{font-size:.72rem;color:var(--tx3)}
.sb-logout{margin-left:auto;padding:4px 10px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--tx4);font-size:.68rem;cursor:pointer;font-family:var(--font);white-space:nowrap;opacity:0;transition:all .2s}
.app-body.sb-open .sb-logout{opacity:1}
.sb-logout:hover{color:var(--red);border-color:var(--red)}

.content{overflow-y:auto;background:var(--bg);transition:background .4s}
.page{display:none;padding:30px;animation:fadeUp .32s ease both;min-height:100%}
.page.active{display:block}

/* CARDS & COMPONENTS */
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:24px;transition:box-shadow var(--tr),border-color var(--tr),transform var(--tr)}
.card:hover{box-shadow:var(--shadow-sm)}
.c-hd{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
.c-title{font-weight:800;font-size:.97rem;color:var(--tx)}
.c-sub{font-size:.76rem;color:var(--tx3);margin-top:2px}
.page-title{font-family:var(--font-d);font-weight:900;font-size:1.75rem;color:var(--tx);margin-bottom:6px}
.page-sub{color:var(--tx3);font-size:.97rem;margin-bottom:26px;line-height:1.65}
.pill{display:inline-flex;align-items:center;padding:4px 10px;border-radius:100px;font-size:.7rem;font-weight:800;text-transform:uppercase;letter-spacing:.3px}
.ph{background:var(--red-bg);color:var(--red);border:1px solid var(--red-border)}
.pm{background:var(--amber-bg);color:var(--amber);border:1px solid var(--amber-border)}
.pl{background:var(--green-bg);color:var(--green);border:1px solid var(--green-border)}
.pd{background:var(--green-bg);color:var(--green)}
.pp{background:var(--surface2);color:var(--tx3)}
.pi{background:var(--acc-bg);color:var(--acc)}
.po{background:var(--red-bg);color:var(--red)}
.btn{display:inline-flex;align-items:center;gap:7px;padding:10px 20px;border-radius:var(--r-sm);font-size:.9rem;font-weight:700;border:none;cursor:pointer;transition:all var(--tr);font-family:var(--font)}
.btn-p{background:var(--acc);color:#fff}
.btn-p:hover{background:var(--acc-dark);transform:translateY(-1px);box-shadow:0 5px 16px rgba(61,90,254,.38)}
.btn-g{background:transparent;color:var(--tx2);border:1.5px solid var(--border)}
.btn-g:hover{background:var(--surface2);transform:translateY(-1px)}
.btn-r{background:transparent;color:var(--red);border:1.5px solid rgba(224,49,49,.3)}
.btn-r:hover{background:var(--red-bg)}
.btn-sm{padding:7px 14px;font-size:.82rem}
.btn-purple{background:var(--purple-bg);color:var(--purple);border:1px solid var(--purple-border)}
.btn-purple:hover{background:var(--purple);color:#fff}
.ic-btn{width:34px;height:34px;border-radius:var(--r-sm);border:1px solid var(--border);background:transparent;color:var(--tx3);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:.9rem;transition:all var(--tr)}
.ic-btn:hover{background:var(--surface2);color:var(--tx);transform:scale(1.08)}
.ic-btn.del:hover{color:var(--red);border-color:var(--red)}
.empty-s{text-align:center;padding:56px 20px;color:var(--tx3)}
.empty-s .ei{font-size:3rem;margin-bottom:16px;animation:bounce 2s ease infinite;display:block}
.empty-s .et{font-weight:800;font-size:1rem;color:var(--tx2);margin-bottom:8px}
.empty-s .es{font-size:.88rem}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:18px}
.grid-3{display:grid;grid-template-columns:repeat(auto-fill,minmax(152px,1fr));gap:13px}
.grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:15px}

/* DASHBOARD */
.dash-greet{margin-bottom:28px}
.dash-greet h2{font-family:var(--font-d);font-size:2rem;font-weight:900;color:var(--tx);line-height:1.2;margin-bottom:5px}
.dash-greet p{color:var(--tx3);font-size:.97rem}
.kpi-row{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:15px;margin-bottom:22px}
.kpi{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:20px;transition:all .28s;animation:fadeUp .4s ease both;cursor:default;position:relative;overflow:hidden}
.kpi::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--acc),var(--purple));opacity:0;transition:opacity .3s}
.kpi:hover{transform:translateY(-5px);box-shadow:var(--shadow);border-color:rgba(61,90,254,.2)}
.kpi:hover::after{opacity:1}
.kpi-ic{width:44px;height:44px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:1.2rem;margin-bottom:14px;transition:transform .3s}
.kpi:hover .kpi-ic{transform:scale(1.1) rotate(-6deg)}
.kpi-v{font-family:var(--font-d);font-size:2.2rem;font-weight:900;color:var(--tx);line-height:1;margin-bottom:4px;animation:countUp .5s ease both}
.kpi-l{font-size:.74rem;font-weight:700;color:var(--tx3);text-transform:uppercase;letter-spacing:.5px}
.kpi-chg{font-size:.68rem;font-weight:700;margin-top:5px}
.kpi-chg.up{color:var(--green)}.kpi-chg.dn{color:var(--red)}
.dash-main{display:grid;grid-template-columns:1fr 330px;gap:18px;margin-bottom:18px}
.dash-col-right{display:flex;flex-direction:column;gap:15px}
.ring-wrap{position:relative;width:140px;height:140px;margin:0 auto 12px}
.ring-svg{transform:rotate(-90deg)}
.ring-bg-c{fill:none;stroke:var(--surface2);stroke-width:11}
.ring-fg-c{fill:none;stroke:var(--acc);stroke-width:11;stroke-linecap:round;stroke-dasharray:283;stroke-dashoffset:283;transition:stroke-dashoffset 1.4s cubic-bezier(.4,0,.2,1)}
.ring-ctr{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center}
.ring-pct{font-family:var(--font-d);font-size:1.7rem;font-weight:900;color:var(--tx)}
.ring-pct-lbl{font-size:.62rem;font-weight:800;color:var(--tx4);text-transform:uppercase;letter-spacing:1px}
.streak-days{display:flex;gap:6px}
.s-day{display:flex;flex-direction:column;align-items:center;gap:4px;flex:1}
.s-pip{width:100%;aspect-ratio:1;border-radius:8px;background:var(--surface2);border:1px solid var(--border);transition:all .3s}
.s-pip.on{background:linear-gradient(135deg,var(--acc),var(--purple));border-color:transparent;box-shadow:0 2px 10px rgba(61,90,254,.35)}
.s-pip.today-pip{outline:2px solid var(--acc);outline-offset:2px}
.s-lbl{font-size:.57rem;font-weight:700;color:var(--tx4);text-transform:uppercase}
.t-row{display:flex;align-items:center;gap:11px;padding:11px 0;border-bottom:1px solid var(--border);transition:all .15s}
.t-row:last-child{border:none}
.t-row:hover{transform:translateX(4px)}
.t-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
.t-info{flex:1;min-width:0}
.t-title{font-size:.9rem;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:var(--tx)}
.t-meta{font-size:.74rem;color:var(--tx3)}
.dash-bottom{display:grid;grid-template-columns:1fr 1fr 210px;gap:18px}

/* NEW: MOTIVATIONAL QUOTE CARD */
.quote-card{background:linear-gradient(135deg,var(--acc),var(--purple));border:none;color:#fff;position:relative;overflow:hidden}
.quote-card::before{content:'‚ùù';position:absolute;top:-10px;left:14px;font-size:6rem;opacity:.15;font-family:var(--font-d);line-height:1}
.quote-text{font-family:var(--font-d);font-size:1.1rem;font-style:italic;line-height:1.65;position:relative;z-index:1;margin-bottom:12px}
.quote-author{font-size:.8rem;font-weight:700;opacity:.8;position:relative;z-index:1}

/* NEW: STUDY TIPS TICKER */
.tips-ticker{background:var(--acc-bg);border:1px solid rgba(61,90,254,.2);border-radius:var(--r);padding:14px 20px;margin-bottom:18px;display:flex;align-items:center;gap:14px;overflow:hidden}
.tips-label{font-size:.72rem;font-weight:900;color:var(--acc);text-transform:uppercase;letter-spacing:1.5px;flex-shrink:0;background:var(--acc);color:#fff;padding:4px 10px;border-radius:6px}
.tips-text{font-size:.9rem;color:var(--tx2);font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* TASKS */
.toolbar{display:flex;align-items:center;gap:11px;margin-bottom:24px;flex-wrap:wrap}
.search-w{flex:1;min-width:200px;position:relative}
.search-w input{width:100%;padding:11px 16px 11px 42px;border:1.5px solid var(--border);background:var(--surface);border-radius:var(--r-sm);color:var(--tx);font-size:.93rem;outline:none;transition:all var(--tr);font-family:var(--font)}
.search-w input:focus{border-color:var(--acc);box-shadow:0 0 0 4px rgba(61,90,254,.12)}
.search-w::before{content:'üîç';position:absolute;left:13px;top:50%;transform:translateY(-50%);font-size:.85rem;pointer-events:none}
.fc-row{display:flex;gap:7px;flex-wrap:wrap}
.fc{padding:8px 15px;border-radius:100px;font-size:.8rem;font-weight:700;cursor:pointer;border:1.5px solid var(--border);background:var(--surface);color:var(--tx3);transition:all .2s;font-family:var(--font)}
.fc:hover{border-color:var(--acc);color:var(--acc)}
.fc.active{background:var(--acc);border-color:var(--acc);color:#fff;box-shadow:0 3px 12px rgba(61,90,254,.3)}
.tasks-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(315px,1fr));gap:15px}
.tc{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r);padding:20px;position:relative;transition:all .25s;overflow:hidden}
.tc::after{content:'';position:absolute;left:0;top:0;bottom:0;width:4px;transition:background .2s}
.tc.ph-h::after{background:var(--red)}
.tc.ph-m::after{background:var(--amber)}
.tc.ph-l::after{background:var(--green)}
.tc:hover{box-shadow:var(--shadow);transform:translateY(-3px)}
.tc.done-card{opacity:.6}
.tc-top{display:flex;align-items:flex-start;gap:11px;margin-bottom:9px}
.tc-chk{width:24px;height:24px;border-radius:8px;border:2px solid var(--border2);background:transparent;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0;margin-top:1px}
.tc-chk:hover{border-color:var(--acc);background:var(--acc-bg);transform:scale(1.1)}
.tc-chk.ck{background:var(--green);border-color:var(--green);color:#fff;font-size:.76rem;animation:popIn .25s cubic-bezier(.34,1.56,.64,1)}
.tc-inf{flex:1;min-width:0}
.tc-ttl{font-size:.95rem;font-weight:800;color:var(--tx);margin-bottom:6px;line-height:1.3}
.tc-ttl.lt{text-decoration:line-through;opacity:.45}
.tc-meta{display:flex;align-items:center;gap:7px;flex-wrap:wrap;margin-bottom:6px}
.tc-due{font-size:.74rem;color:var(--tx3);display:flex;align-items:center;gap:3px}
.tc-due.ov{color:var(--red);font-weight:700}
.tc-desc{font-size:.82rem;color:var(--tx3);line-height:1.55;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.tc-acts{display:flex;gap:5px;flex-shrink:0}
.tc-footer{margin-top:11px;padding-top:10px;border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:9px}
.st-list{margin-top:9px;display:flex;flex-direction:column;gap:6px}
.st-item{display:flex;align-items:center;gap:8px;cursor:pointer;transition:transform .15s}
.st-item:hover{transform:translateX(3px)}
.st-cb{width:15px;height:15px;border-radius:5px;border:1.5px solid var(--border2);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:.55rem;transition:all .15s}
.st-cb.ck{background:var(--green);border-color:var(--green);color:#fff}
.st-tx{font-size:.78rem;color:var(--tx2)}.st-tx.ck{text-decoration:line-through;opacity:.5}
.st-bar-w{height:5px;background:var(--surface2);border-radius:3px;flex:1;overflow:hidden}
.st-bar{height:100%;background:linear-gradient(90deg,var(--acc),var(--purple));border-radius:3px;transition:width .5s ease}

/* ADD FORM */
.add-form{max-width:680px}
.prio-sel{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.prio-opt{padding:12px;border-radius:var(--r-sm);border:2px solid var(--border);background:var(--surface);cursor:pointer;text-align:center;font-size:.87rem;font-weight:800;color:var(--tx3);transition:all .2s}
.prio-opt.sel-h{background:var(--red-bg);border-color:var(--red);color:var(--red)}
.prio-opt.sel-m{background:var(--amber-bg);border-color:var(--amber);color:var(--amber)}
.prio-opt.sel-l{background:var(--green-bg);border-color:var(--green);color:var(--green)}

/* UPCOMING TIMELINE */
.tl-group{margin-bottom:26px}
.tl-lbl{font-size:.8rem;font-weight:800;color:var(--tx3);text-transform:uppercase;letter-spacing:1px;margin-bottom:13px;display:flex;align-items:center;gap:9px}
.tl-lbl::after{content:'';flex:1;height:1px;background:var(--border)}
.tl-it{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r);padding:15px 20px;display:flex;align-items:center;gap:13px;margin-bottom:10px;transition:all .22s;cursor:pointer}
.tl-it:hover{box-shadow:var(--shadow);transform:translateX(6px);border-color:rgba(61,90,254,.25)}
.tl-ind{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.tl-inf{flex:1;min-width:0}
.tl-t{font-size:.93rem;font-weight:800;margin-bottom:3px;color:var(--tx)}
.tl-s{font-size:.76rem;color:var(--tx3)}

/* PERFORMANCE */
.perf-stats{display:grid;grid-template-columns:repeat(auto-fill,minmax(172px,1fr));gap:15px;margin-bottom:22px}
.ps{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:24px;text-align:center;transition:all .28s}
.ps:hover{transform:translateY(-5px);box-shadow:var(--shadow);border-color:rgba(61,90,254,.2)}
.ps-v{font-family:var(--font-d);font-size:2.3rem;font-weight:900;color:var(--acc);line-height:1;margin-bottom:6px}
.ps-l{font-size:.76rem;color:var(--tx3);font-weight:600}
.subj-bar{margin-bottom:18px}
.sb-row{display:flex;justify-content:space-between;font-size:.85rem;font-weight:700;margin-bottom:7px;color:var(--tx2)}
.sb-track{height:10px;background:var(--surface2);border-radius:5px;overflow:hidden}
.sb-fill{height:100%;border-radius:5px;background:linear-gradient(90deg,var(--acc),var(--purple));transition:width 1.4s cubic-bezier(.4,0,.2,1)}
.hm-grid{display:grid;grid-template-columns:repeat(28,1fr);gap:4px;margin-top:13px}
.hm{aspect-ratio:1;border-radius:4px;background:var(--surface2);transition:all .15s;cursor:default}
.hm:hover{transform:scale(1.45)}
.hm.hm1{background:rgba(61,90,254,.2)}.hm.hm2{background:rgba(61,90,254,.55)}.hm.hm3{background:var(--acc)}

/* NEW: SUBJECT RADAR PLACEHOLDER */
.radar-placeholder{display:flex;align-items:center;justify-content:center;height:220px;background:var(--surface2);border-radius:var(--r);font-size:.9rem;color:var(--tx3);position:relative;overflow:hidden}

/* NEW: STUDY INSIGHTS */
.insight-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:20px;display:flex;gap:16px;align-items:flex-start;transition:all .25s;margin-bottom:12px}
.insight-card:hover{box-shadow:var(--shadow-sm);transform:translateX(4px)}
.insight-icon{width:48px;height:48px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:1.4rem;flex-shrink:0}
.insight-title{font-weight:800;font-size:.92rem;color:var(--tx);margin-bottom:4px}
.insight-text{font-size:.84rem;color:var(--tx3);line-height:1.6}

/* STREAKS & CALENDAR */
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:5px}
.cal-dn{text-align:center;font-size:.63rem;font-weight:800;color:var(--tx4);text-transform:uppercase;padding:5px 0;letter-spacing:.5px}
.cal-cell{aspect-ratio:1;border-radius:var(--r-sm);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .15s;font-size:.8rem;font-weight:600;color:var(--tx3);position:relative}
.cal-cell:hover{background:var(--surface2);transform:scale(1.08)}
.cal-cell.has-t::after{content:'';position:absolute;bottom:3px;width:4px;height:4px;border-radius:50%;background:var(--acc)}
.cal-cell.studied{background:rgba(61,90,254,.15);color:var(--acc);font-weight:800}
.cal-cell.today-cell{background:var(--acc-bg);color:var(--acc);font-weight:900;outline:2px solid var(--acc);outline-offset:2px}
.cal-cell.other-m{opacity:.3}
.goals-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:15px}
.goal-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:20px;transition:all .25s}
.goal-card:hover{box-shadow:var(--shadow);transform:translateY(-3px)}
.goal-name{font-weight:800;font-size:.95rem;color:var(--tx);margin-bottom:9px}
.goal-bar-w{height:10px;background:var(--surface2);border-radius:5px;overflow:hidden;margin-bottom:8px}
.goal-bar{height:100%;border-radius:5px;background:linear-gradient(90deg,var(--acc),var(--purple));transition:width 1.2s ease}
.goal-meta{display:flex;justify-content:space-between;font-size:.76rem;color:var(--tx3);font-weight:700}

/* NEW: STUDY MUSIC WIDGET */
.music-widget{background:linear-gradient(135deg,#1a1a2e,#16213e);border:1px solid rgba(255,255,255,.08);border-radius:var(--r-lg);padding:24px;color:#fff;position:relative;overflow:hidden}
.music-widget::before{content:'‚ô´';position:absolute;right:-10px;bottom:-20px;font-size:8rem;opacity:.05}
.music-title{font-size:.76rem;font-weight:800;opacity:.6;text-transform:uppercase;letter-spacing:1.5px;margin-bottom:10px}
.music-track{font-family:var(--font-d);font-size:1.05rem;font-weight:700;margin-bottom:4px}
.music-artist{font-size:.82rem;opacity:.6;margin-bottom:18px}
.music-bar{height:4px;background:rgba(255,255,255,.2);border-radius:2px;overflow:hidden;margin-bottom:8px}
.music-prog{height:100%;background:linear-gradient(90deg,#6B8BFF,#C084FC);border-radius:2px;animation:slideRight 4s ease-in-out infinite}
.music-controls{display:flex;align-items:center;justify-content:center;gap:20px}
.music-btn{width:36px;height:36px;border-radius:50%;border:none;background:rgba(255,255,255,.1);color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:.9rem;transition:all .2s}
.music-btn:hover{background:rgba(255,255,255,.25);transform:scale(1.1)}
.music-btn.main{width:48px;height:48px;background:linear-gradient(135deg,var(--acc),var(--purple));box-shadow:0 4px 16px rgba(61,90,254,.5);font-size:1.1rem}

/* POMODORO */
.pomo-wrap{max-width:480px;margin:0 auto;text-align:center}
.pomo-modes{display:flex;gap:6px;justify-content:center;background:var(--surface2);border-radius:100px;padding:6px;margin-bottom:34px}
.pomo-mode-btn{padding:10px 24px;border-radius:100px;border:none;background:transparent;color:var(--tx3);font-size:.85rem;font-weight:700;cursor:pointer;transition:all .22s;font-family:var(--font)}
.pomo-mode-btn.active{background:var(--surface);color:var(--acc);box-shadow:var(--shadow-sm)}
.pomo-ring-w{position:relative;width:240px;height:240px;margin:0 auto 30px}
.pomo-svg{transform:rotate(-90deg)}
.pomo-track{fill:none;stroke:var(--surface2);stroke-width:12}
.pomo-fill{fill:none;stroke:var(--acc);stroke-width:12;stroke-linecap:round;stroke-dasharray:628;stroke-dashoffset:0;transition:stroke-dashoffset 1s linear,stroke .5s}
.pomo-ctr{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center}
.pomo-t{font-family:var(--font-d);font-size:3.8rem;font-weight:900;color:var(--tx);line-height:1}
.pomo-m{font-size:.76rem;font-weight:800;color:var(--tx3);text-transform:uppercase;letter-spacing:1.5px;margin-top:6px}
.pomo-ctrls{display:flex;align-items:center;justify-content:center;gap:18px;margin-bottom:30px}
.pomo-btn-main{width:72px;height:72px;border-radius:50%;border:none;background:var(--acc);color:#fff;font-size:1.6rem;cursor:pointer;transition:all .22s;box-shadow:0 8px 28px rgba(61,90,254,.45);display:flex;align-items:center;justify-content:center}
.pomo-btn-main:hover{transform:scale(1.09);box-shadow:0 12px 36px rgba(61,90,254,.55)}
.pomo-btn-sec{width:54px;height:54px;border-radius:50%;border:1.5px solid var(--border);background:var(--surface);color:var(--tx2);font-size:1.15rem;cursor:pointer;transition:all .22s;display:flex;align-items:center;justify-content:center}
.pomo-btn-sec:hover{background:var(--surface2);transform:scale(1.06)}
.pomo-sessions-row{display:flex;gap:10px;justify-content:center;margin-bottom:30px}
.pomo-s-dot{width:14px;height:14px;border-radius:50%;background:var(--surface2);border:2px solid var(--border);transition:all .35s}
.pomo-s-dot.done{background:var(--acc);border-color:var(--acc);box-shadow:0 0 0 3px rgba(61,90,254,.2)}
.pomo-s-dot.cur{background:transparent;border-color:var(--acc);animation:pulse 1.5s infinite}
.pomo-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:11px;margin-bottom:24px}
.pomo-stat{background:var(--surface2);border-radius:var(--r-sm);padding:16px;text-align:center}
.pomo-stat-v{font-family:var(--font-d);font-size:1.6rem;font-weight:900;color:var(--tx);line-height:1}
.pomo-stat-l{font-size:.66rem;font-weight:700;color:var(--tx3);text-transform:uppercase;letter-spacing:.5px}
.task-select-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:20px;text-align:left;margin-bottom:18px}

/* NEW: POMO TIPS */
.pomo-tips{background:var(--acc-bg);border:1px solid rgba(61,90,254,.2);border-radius:var(--r);padding:18px;text-align:left;margin-top:10px}
.pomo-tips-title{font-size:.76rem;font-weight:900;color:var(--acc);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px}
.pomo-tip-item{font-size:.88rem;color:var(--tx2);padding:6px 0;border-bottom:1px solid var(--border);display:flex;gap:8px}
.pomo-tip-item:last-child{border:none}

/* AI TOOLS */
.ai-tools-nav{display:flex;gap:7px;flex-wrap:wrap;margin-bottom:26px}
.ai-tool-tab{padding:9px 18px;border-radius:100px;border:1.5px solid var(--border);background:var(--surface);color:var(--tx3);font-size:.85rem;font-weight:700;cursor:pointer;transition:all .2s;font-family:var(--font)}
.ai-tool-tab:hover{border-color:var(--acc);color:var(--acc)}
.ai-tool-tab.active{background:var(--acc);border-color:var(--acc);color:#fff;box-shadow:0 3px 14px rgba(61,90,254,.35)}
.ai-tool-panel{display:none;animation:fadeUp .3s ease}
.ai-tool-panel.show{display:block}
.ai-input-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r-lg);padding:28px;margin-bottom:22px}
.slider-grp{margin-bottom:22px}
.slider-lbl{display:flex;justify-content:space-between;align-items:center;font-size:.88rem;font-weight:700;color:var(--tx2);margin-bottom:10px}
.slider-val{font-weight:900;color:var(--acc);font-size:.95rem;font-family:var(--font-mono)}
.sl{width:100%;-webkit-appearance:none;appearance:none;height:8px;border-radius:4px;background:var(--surface2);outline:none;cursor:pointer}
.sl::-webkit-slider-thumb{-webkit-appearance:none;width:22px;height:22px;border-radius:50%;background:var(--acc);cursor:pointer;box-shadow:0 2px 10px rgba(61,90,254,.45);transition:transform .2s}
.sl::-webkit-slider-thumb:hover{transform:scale(1.3)}
.result-card{background:linear-gradient(135deg,var(--acc-bg),var(--purple-bg));border:1px solid rgba(61,90,254,.25);border-radius:var(--r-lg);padding:28px;animation:scaleIn .4s cubic-bezier(.34,1.56,.64,1)}
.result-big{font-family:var(--font-d);font-size:3rem;font-weight:900;color:var(--acc);line-height:1;margin-bottom:11px}
.result-msg{font-size:.97rem;color:var(--tx2);line-height:1.75}
.result-badge{display:inline-flex;align-items:center;gap:7px;padding:7px 18px;background:var(--acc);color:#fff;border-radius:100px;font-size:.85rem;font-weight:800;margin-bottom:16px}
.plan-day{background:var(--surface);border:1px solid var(--border);border-radius:var(--r-sm);padding:15px 18px;margin-bottom:10px;display:flex;align-items:center;gap:13px;transition:all .2s}
.plan-day:hover{box-shadow:var(--shadow-sm);transform:translateX(5px)}
.plan-day-num{font-family:var(--font-d);font-weight:900;font-size:1.15rem;color:var(--acc);width:36px;text-align:center;flex-shrink:0}
.plan-day-info{flex:1}.plan-day-title{font-size:.9rem;font-weight:800;color:var(--tx)}.plan-day-sub{font-size:.76rem;color:var(--tx3)}
.plan-day-hrs{font-size:.82rem;font-weight:800;color:var(--purple)}

/* NOTES */
.notes-layout{display:grid;grid-template-columns:220px 1fr;gap:20px}
.notes-sidebar{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:14px;align-self:start;position:sticky;top:16px}
.note-cat{display:flex;align-items:center;gap:9px;padding:10px 13px;border-radius:var(--r-sm);cursor:pointer;transition:all .15s;border:none;background:transparent;width:100%;text-align:left;font-family:var(--font);font-size:.9rem;font-weight:600;color:var(--tx3)}
.note-cat:hover{background:var(--surface2);color:var(--tx);transform:translateX(4px)}
.note-cat.active{background:var(--acc-bg);color:var(--acc);font-weight:800}
.note-cat-cnt{margin-left:auto;font-size:.68rem;font-weight:800;background:var(--surface3);color:var(--tx3);padding:2px 8px;border-radius:10px}
.notes-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(275px,1fr));gap:14px}
.note-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:20px;cursor:pointer;transition:all .22s;position:relative}
.note-card:hover{box-shadow:var(--shadow);transform:translateY(-3px)}
.note-title{font-weight:800;font-size:.95rem;color:var(--tx);margin-bottom:7px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.note-preview{font-size:.82rem;color:var(--tx3);line-height:1.6;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden}
.note-footer{margin-top:13px;padding-top:10px;border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.note-date{font-size:.7rem;color:var(--tx4)}
.note-subj-tag{padding:3px 10px;border-radius:100px;font-size:.68rem;font-weight:800;background:var(--acc-bg);color:var(--acc)}

/* QUIZ */
.quiz-subjects{display:grid;grid-template-columns:repeat(auto-fill,minmax(192px,1fr));gap:15px;margin-bottom:26px}
.quiz-subj-card.dept-subj{border-color:rgba(61,90,254,.3);background:var(--acc-bg)}
.quiz-subj-card.dept-subj:hover,.quiz-subj-card.dept-subj.selected{border-color:var(--acc);background:var(--acc);color:#fff;transform:translateY(-5px);box-shadow:var(--shadow)}
.quiz-subj-card.dept-subj:hover .quiz-subj-name,.quiz-subj-card.dept-subj.selected .quiz-subj-name,.quiz-subj-card.dept-subj:hover .quiz-subj-cnt,.quiz-subj-card.dept-subj.selected .quiz-subj-cnt{color:#fff}
.quiz-subj-card{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r);padding:24px;text-align:center;cursor:pointer;transition:all .28s}
.quiz-subj-card:hover,.quiz-subj-card.selected{border-color:var(--acc);background:var(--acc-bg);transform:translateY(-5px);box-shadow:var(--shadow)}
.quiz-subj-icon{font-size:2.4rem;margin-bottom:10px}
.quiz-subj-name{font-weight:800;font-size:.97rem;color:var(--tx);margin-bottom:3px}
.quiz-subj-cnt{font-size:.76rem;color:var(--tx3)}
.quiz-area{display:none;animation:fadeUp .3s ease}
.quiz-area.show{display:block}
.quiz-q-num{font-size:.8rem;font-weight:800;color:var(--tx3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:9px}
.quiz-q{font-family:var(--font-d);font-size:1.2rem;font-weight:700;color:var(--tx);margin-bottom:24px;line-height:1.5}
.quiz-opts{display:flex;flex-direction:column;gap:12px;margin-bottom:24px}
.quiz-opt{padding:15px 22px;border:2px solid var(--border);border-radius:var(--r-sm);background:var(--surface);cursor:pointer;font-size:.95rem;font-weight:600;color:var(--tx2);transition:all .2s;text-align:left;font-family:var(--font)}
.quiz-opt:hover:not(.locked){border-color:var(--acc);color:var(--acc);background:var(--acc-bg);transform:translateX(5px)}
.quiz-opt.correct{background:var(--green-bg);border-color:var(--green);color:var(--green);font-weight:800}
.quiz-opt.wrong{background:var(--red-bg);border-color:var(--red);color:var(--red)}
.quiz-opt.locked{cursor:default}
.quiz-explanation{padding:18px 20px;background:var(--surface2);border-radius:var(--r-sm);border-left:4px solid var(--acc);font-size:.9rem;color:var(--tx2);margin-bottom:20px;display:none;animation:fadeUp .3s ease;line-height:1.7}
.quiz-explanation.show{display:block}
.quiz-prog{height:8px;background:var(--surface2);border-radius:4px;overflow:hidden;margin-bottom:20px}
.quiz-prog-fill{height:100%;background:linear-gradient(90deg,var(--acc),var(--purple));border-radius:4px;transition:width .6s ease}
.quiz-result{text-align:center;padding:40px;animation:scaleIn .4s cubic-bezier(.34,1.56,.64,1)}
.quiz-result-score{font-family:var(--font-d);font-size:5rem;font-weight:900;color:var(--acc);line-height:1;margin-bottom:12px}
.quiz-result-msg{font-size:1.15rem;color:var(--tx2);margin-bottom:28px}

/* NEW: QUIZ LEADERBOARD MINI */
.quiz-top-scores{margin-top:22px}
.qts-row{display:flex;align-items:center;gap:11px;padding:10px 0;border-bottom:1px solid var(--border)}
.qts-row:last-child{border:none}

/* BADGES */
.badge-card{border-radius:var(--r);padding:20px;text-align:center;border:1.5px solid var(--border);background:var(--surface2);transition:all .28s;position:relative;overflow:hidden;cursor:default}
.badge-card.unlocked{border-color:var(--amber-border);background:linear-gradient(135deg,var(--amber-bg),var(--surface));box-shadow:0 4px 18px rgba(217,119,6,.12)}
.badge-card.locked{opacity:.4;filter:grayscale(.8)}
.badge-card.unlocked:hover{transform:translateY(-5px);box-shadow:0 10px 28px rgba(217,119,6,.2)}
.badge-ic{font-size:2.4rem;margin-bottom:9px;display:block;transition:transform .3s}
.badge-card.unlocked:hover .badge-ic{transform:scale(1.18) rotate(-6deg)}
.badge-name{font-weight:800;font-size:.85rem;color:var(--tx);margin-bottom:4px}
.badge-desc{font-size:.72rem;color:var(--tx3);line-height:1.45}
.badge-xp{font-size:.72rem;font-weight:800;color:var(--amber);margin-top:6px}
.lb-row{display:flex;align-items:center;gap:13px;padding:13px 18px;border-bottom:1px solid var(--border);transition:background .15s}
.lb-row:last-child{border:none}
.lb-row:hover{background:var(--surface2)}
.lb-row.you-row{background:var(--acc-bg);border-radius:var(--r-sm);border-color:transparent}
.lb-rank{width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.95rem;font-weight:900;flex-shrink:0}
.lb-av{width:38px;height:38px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:.9rem;color:#fff;flex-shrink:0}

/* DAILY */
.daily-task-row{display:flex;align-items:center;gap:13px;padding:11px 0;border-bottom:1px solid var(--border);transition:all .15s}
.daily-task-row:last-child{border:none}
.daily-task-row:hover{transform:translateX(4px)}
.dt-cb{width:24px;height:24px;border-radius:8px;border:2px solid var(--border2);background:transparent;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:.76rem;transition:all .2s;flex-shrink:0}
.dt-cb.ck{background:var(--green);border-color:var(--green);color:#fff;animation:popIn .25s cubic-bezier(.34,1.56,.64,1)}

/* NEW: WORD OF THE DAY */
.wotd-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r-lg);padding:24px;margin-bottom:16px;position:relative;overflow:hidden}
.wotd-card::before{content:'';position:absolute;right:-20px;top:-20px;width:120px;height:120px;background:var(--acc-bg);border-radius:50%}
.wotd-label{font-size:.7rem;font-weight:900;color:var(--acc);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:8px}
.wotd-word{font-family:var(--font-d);font-size:1.8rem;font-weight:900;color:var(--tx);margin-bottom:4px}
.wotd-pos{font-size:.8rem;color:var(--tx3);font-style:italic;margin-bottom:10px}
.wotd-def{font-size:.9rem;color:var(--tx2);line-height:1.7}

/* NEW: SCIENCE FACT */
.fact-card{background:linear-gradient(135deg,var(--teal-bg),var(--acc-bg));border:1px solid var(--border);border-radius:var(--r-lg);padding:24px;margin-bottom:16px;display:flex;gap:16px;align-items:flex-start}
.fact-icon{font-size:2.4rem;flex-shrink:0}
.fact-title{font-weight:800;font-size:.88rem;color:var(--teal);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px}
.fact-text{font-size:.93rem;color:var(--tx2);line-height:1.7}

/* FLASHCARDS */
.fc-add-form{background:var(--surface);border:1px solid var(--border);border-radius:var(--r-lg);padding:26px;max-width:580px;margin-bottom:24px;display:none;animation:fadeUp .3s ease}
.fc-add-form.show{display:block}
.fc-flipped #fcCardInner{transform:rotateY(180deg)}
#fcCard{cursor:pointer;perspective:900px}
#fcCardInner{position:relative;min-height:230px;transition:transform .55s cubic-bezier(.4,0,.2,1);transform-style:preserve-3d}
#fcFront,#fcBack{position:absolute;inset:0;backface-visibility:hidden;-webkit-backface-visibility:hidden}
#fcBack{transform:rotateY(180deg)}

/* ACCOUNT */
.toggle-sw{width:48px;height:27px;border-radius:14px;background:var(--border2);cursor:pointer;position:relative;transition:background .25s;flex-shrink:0}
.toggle-sw.on{background:var(--acc)}
.toggle-knob{position:absolute;top:3px;left:3px;width:21px;height:21px;border-radius:50%;background:#fff;transition:left .25s;box-shadow:var(--shadow-sm)}
.toggle-sw.on .toggle-knob{left:24px}

/* MODALS */
.modal-ov{position:fixed;inset:0;background:rgba(7,9,26,.65);z-index:300;display:none;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px)}
.modal-ov.show{display:flex;animation:fadeIn .22s ease}
.modal-box{background:var(--surface);border:1px solid var(--border);border-radius:var(--r-xl);padding:32px;width:100%;max-width:560px;max-height:92vh;overflow-y:auto;animation:scaleIn .28s cubic-bezier(.34,1.56,.64,1);box-shadow:var(--shadow-xl)}
.modal-hd{display:flex;align-items:center;justify-content:space-between;margin-bottom:26px}
.modal-title{font-family:var(--font-d);font-weight:900;font-size:1.2rem;color:var(--tx)}
.modal-cls{width:36px;height:36px;border-radius:var(--r-sm);border:1.5px solid var(--border);background:transparent;color:var(--tx3);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s;font-family:var(--font)}
.modal-cls:hover{color:var(--red);border-color:var(--red);transform:rotate(90deg)}

/* NOTIFS */
.notif-panel{position:fixed;top:68px;right:16px;width:340px;background:var(--surface);border:1px solid var(--border);border-radius:var(--r-lg);box-shadow:var(--shadow-lg);z-index:500;display:none;overflow:hidden;border-radius:var(--r-lg)}
.notif-panel.show{display:block;animation:scaleIn .22s ease;max-width:calc(100vw - 32px)}
.np-hd{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.np-t{font-weight:800;font-size:.92rem;color:var(--tx)}
.np-clr{font-size:.76rem;color:var(--tx3);cursor:pointer;padding:4px 10px;border-radius:var(--r-sm);transition:all .15s}
.np-clr:hover{background:var(--red-bg);color:var(--red)}
.np-list{max-height:320px;overflow-y:auto}
.np-it{padding:14px 20px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .15s}
.np-it:last-child{border:none}.np-it:hover{background:var(--surface2)}
.np-it.unrd{background:var(--acc-bg)}
.np-it-t{font-size:.84rem;font-weight:700;color:var(--tx);margin-bottom:3px}
.np-it-s{font-size:.74rem;color:var(--tx3)}

/* FOCUS OVERLAY */
.focus-ov{display:none;position:fixed;inset:0;background:var(--bg);z-index:400;flex-direction:column;align-items:center;justify-content:center;padding:32px;text-align:center}
.focus-ov.show{display:flex;animation:fadeIn .35s ease}
.focus-task-lbl{font-family:var(--font-d);font-size:1.5rem;font-weight:900;color:var(--tx);margin-bottom:7px}
.focus-hint{font-size:.85rem;color:var(--tx3);margin-bottom:36px}
.focus-exit-btn{margin-top:32px;padding:12px 32px;border-radius:100px;border:1.5px solid var(--border);background:transparent;color:var(--tx2);font-size:.9rem;cursor:pointer;transition:all .2s;font-family:var(--font)}
.focus-exit-btn:hover{border-color:var(--acc);color:var(--acc)}

/* TOASTS */
#toasts{position:fixed;bottom:26px;right:26px;z-index:500;display:flex;flex-direction:column-reverse;gap:9px;pointer-events:none}
.toast{padding:14px 22px;border-radius:var(--r);font-size:.88rem;font-weight:700;min-width:220px;max-width:340px;display:flex;align-items:center;gap:10px;pointer-events:all;animation:toastIn .32s cubic-bezier(.34,1.56,.64,1);box-shadow:var(--shadow-lg);background:var(--surface);border:1px solid}
.ts{color:var(--green);border-color:var(--green-border)}
.te{color:var(--red);border-color:var(--red-border)}
.ti{color:var(--acc);border-color:rgba(61,90,254,.25)}

/* XP FLOAT */
.xp-float{position:fixed;top:84px;right:30px;font-family:var(--font-d);font-weight:900;font-size:1rem;color:#fff;pointer-events:none;z-index:9999;animation:xpFloat 1s ease forwards;background:var(--acc);padding:7px 18px;border-radius:100px;box-shadow:var(--shadow-lg)}

/* BOTTOM NAV */
.bottom-nav{display:none;position:fixed;bottom:0;left:0;right:0;background:var(--surface);border-top:1px solid var(--border);z-index:50;padding:8px 0 max(8px,env(safe-area-inset-bottom))}
.bn-items{display:flex;justify-content:space-around}
.bn-btn{display:flex;flex-direction:column;align-items:center;gap:2px;padding:7px 9px;color:var(--tx3);font-size:.58rem;font-weight:800;cursor:pointer;border:none;background:transparent;text-transform:uppercase;letter-spacing:.5px;transition:color .15s;font-family:var(--font)}
.bn-btn.active,.bn-btn:hover{color:var(--acc)}
.bn-ic{font-size:1.25rem}

/* NEW: PROGRESS RING MINI */
.mini-ring{display:inline-flex;align-items:center;justify-content:center;position:relative;width:52px;height:52px}
.mini-ring svg{transform:rotate(-90deg)}

/* NEW: STUDY STREAK RECORD */
.streak-record{display:flex;align-items:center;gap:14px;padding:16px 20px;background:linear-gradient(135deg,var(--amber-bg),var(--surface));border:1px solid var(--amber-border);border-radius:var(--r);margin-bottom:14px}
.streak-flame{font-size:2rem;animation:pulse 2s ease infinite}

/* RESPONSIVE */
@media(max-width:1100px){.dash-main{grid-template-columns:1fr}.dash-bottom{grid-template-columns:1fr 1fr}}
@media(max-width:900px){.grid-2,.grid-4,.form-row{grid-template-columns:1fr}.dash-bottom{grid-template-columns:1fr}.notes-layout{grid-template-columns:1fr}.notes-sidebar{position:static}#accountPage .grid-2{grid-template-columns:1fr !important}#accountPage .card[style*="grid-column:1/-1"]{grid-column:1 !important}}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   768px ‚Äî MOBILE LAYOUT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
@media(max-width:768px){
  /* App structure */
  .app-body{grid-template-columns:1fr !important}
  .sidebar{position:fixed;left:-280px;top:0;height:100vh;width:280px;z-index:200;transition:left .3s cubic-bezier(.4,0,.2,1);box-shadow:var(--shadow-xl)}
  .sidebar.open{left:0}.app-body.sb-open .sidebar{left:0}
  .sidebar .sb-logo-txt,.sidebar .sb-lbl,.sidebar .sb-user-info,.sidebar .sb-section-lbl,.sidebar .sb-logout,.sidebar .sb-xp-wrap{opacity:1 !important}
  .bottom-nav{display:block}
  .page{padding:12px;padding-bottom:90px}

  /* ‚îÄ‚îÄ TOPBAR FIX (core fix for vertical text bug) ‚îÄ‚îÄ */
  .topbar{position:fixed;top:0;left:0;right:0;z-index:100;height:58px;padding:0 10px;gap:7px;min-width:0}
  .topbar-hamburger{width:36px;height:36px;flex-shrink:0}
  .topbar-title{font-size:.95rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;min-width:0;flex:1}
  .topbar-right{display:flex;align-items:center;gap:5px;flex-shrink:0}
  .tb-ic-btn{width:34px;height:34px;font-size:.9rem;flex-shrink:0}
  .kb-badge{display:none !important}
  .user-pill{padding:4px 8px 4px 4px;flex-shrink:0}
  .user-pill-name{display:none}
  .content{padding-top:58px}

  /* Landing */
  .land-nav{padding:0 16px;height:60px}
  .hero{padding:70px 16px 50px}
  .hero-stats{gap:20px}
  .hero-h1{font-size:2.4rem;letter-spacing:-1px}
  .hero-sub{font-size:.95rem}
  .btn-hero-prim,.btn-hero-sec{padding:14px 28px;font-size:.95rem}
  .feat-section,.how-section,.testimonials-section,.faq-section{padding:44px 16px}
  .land-footer{padding:20px;flex-direction:column;gap:8px;text-align:center}
  .stats-strip{padding:44px 16px}
  .features-grid{grid-template-columns:1fr}
  .testi-grid{grid-template-columns:1fr}
  .steps-grid{grid-template-columns:1fr 1fr}
  .stats-strip-grid{grid-template-columns:1fr 1fr;gap:24px}
  .hero-btns{flex-direction:column;align-items:center}

  /* Dashboard */
  .dash-main{grid-template-columns:1fr}
  .dash-bottom{grid-template-columns:1fr}
  .dash-greet{flex-direction:column}
  #dashXPCard{min-width:unset;width:100%}
  .tips-ticker{padding:10px 14px;gap:10px}

  /* Cards & layout */
  .card{padding:16px}
  .grid-2{grid-template-columns:1fr}
  .grid-4{grid-template-columns:1fr 1fr}
  .kpi-row{grid-template-columns:1fr 1fr;gap:10px}
  .kpi{padding:14px}
  .kpi-v{font-size:1.7rem}
  .page-title{font-size:1.4rem}
  .page-sub{font-size:.88rem}

  /* Modals */
  .modal-box{max-width:100% !important;margin:0 10px;padding:22px 18px}

  /* Auth */
  .auth-card{padding:28px 20px}
  #accountPage>div[style*="grid-template-columns:1fr 1fr"]{grid-template-columns:1fr !important;display:flex !important;flex-direction:column !important}
  #accountPage .card[style*="grid-column:1/-1"]{width:100%}
  .av-preview{width:70px;height:70px;border-radius:20px}
  .av-grid{grid-template-columns:repeat(auto-fill,minmax(44px,1fr))}

  /* Pomodoro */
  .pomo-wrap{max-width:100%}
  .pomo-ring-w{width:200px;height:200px}
  .pomo-svg{width:200px;height:200px}
  .pomo-t{font-size:3rem}
  .pomo-modes{flex-wrap:wrap;gap:5px}
  .pomo-mode-btn{padding:8px 14px;font-size:.8rem}
  .pomo-stats{grid-template-columns:repeat(3,1fr);gap:8px}
  .pomo-stat-v{font-size:1.3rem}

  /* Tasks & forms */
  .tasks-grid{grid-template-columns:1fr}
  .add-form{max-width:100%}
  .toolbar{flex-direction:column;align-items:stretch}
  .search-w{min-width:unset}
  .fc-row{justify-content:flex-start}
  .form-row{grid-template-columns:1fr}

  /* Notes */
  .notes-layout{grid-template-columns:1fr}
  .notes-sidebar{position:static;margin-bottom:14px}

  /* Quiz */
  .quiz-subjects{grid-template-columns:1fr 1fr}
  .quiz-result-score{font-size:3.5rem}
  .result-big{font-size:2.2rem}

  /* Friends */
  #friendsPage .grid-2{grid-template-columns:1fr !important}
  #friendsPage [style*="grid-template-columns:1fr 1fr"]{grid-template-columns:1fr !important}
  #friendsPage [style*="grid-template-columns:1fr 1fr;gap:13px"]{grid-template-columns:1fr !important}
  #battleSubj,#battleFriend{width:100%}

  /* Performance */
  .perf-stats{grid-template-columns:1fr 1fr}
  .goals-grid{grid-template-columns:1fr}

  /* AI tools */
  .ai-tools-nav{gap:6px}
  .ai-tool-tab{padding:7px 13px;font-size:.8rem}

  /* Music */
  .music-widget{padding:18px}
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   520px ‚Äî SMALL MOBILE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
@media(max-width:520px){
  /* Topbar ‚Äî tighter */
  .topbar{padding:0 8px;gap:5px;height:54px}
  .topbar-title{font-size:.88rem}
  .topbar-hamburger,.tb-ic-btn{width:32px;height:32px;font-size:.85rem}
  .topbar-right{gap:4px}
  .content{padding-top:54px}

  .kpi-row{grid-template-columns:1fr 1fr;gap:8px}
  .kpi{padding:12px}
  .kpi-v{font-size:1.5rem}
  .kpi-ic{width:36px;height:36px;font-size:1rem}
  .quiz-subjects{grid-template-columns:1fr 1fr}
  .perf-stats{grid-template-columns:1fr 1fr}
  .hero-h1{font-size:2rem;letter-spacing:-.5px}
  .hero-stat-val{font-size:2rem}
  .steps-grid{grid-template-columns:1fr}
  .stats-strip-grid{grid-template-columns:1fr 1fr}
  .grid-4{grid-template-columns:1fr 1fr}
  .pomo-ring-w{width:180px;height:180px}
  .pomo-svg{width:180px;height:180px}
  .pomo-t{font-size:2.6rem}
  .page{padding:10px;padding-bottom:90px}
  .card{padding:14px}
  .modal-box{padding:18px 14px}
  .auth-card{padding:22px 16px}
  .auth-title{font-size:1.5rem}
  .bn-btn{padding:5px 6px;font-size:.54rem}
  .bn-ic{font-size:1.1rem}
  .section-h2{font-size:1.6rem}
  .feat-card{padding:22px 18px}
  .music-widget{padding:14px}
  .pomo-tips{padding:14px}
  #subjectRingRow{grid-template-columns:1fr 1fr 1fr}
  .badge-card{padding:14px}
  .badge-ic{font-size:2rem}
  /* Hide focus & theme buttons to give title more space */
  #focusBtn,#themeBtn2{display:none}
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   380px ‚Äî TINY PHONES
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
@media(max-width:380px){
  .topbar{padding:0 6px;gap:4px}
  .topbar-title{font-size:.82rem}
  .topbar-hamburger,.tb-ic-btn{width:30px;height:30px;font-size:.8rem}
  .kpi-row{grid-template-columns:1fr 1fr}
  .hero-h1{font-size:1.8rem}
  .pomo-t{font-size:2.2rem}
  .bn-btn{padding:4px 4px;font-size:.5rem}
  .page{padding:8px;padding-bottom:88px}
  .card{padding:12px}
  .quiz-subjects{grid-template-columns:1fr}
  .pomo-ctrls{gap:12px}
  .pomo-btn-main{width:60px;height:60px;font-size:1.4rem}
  .pomo-btn-sec{width:46px;height:46px}
  #subjectRingRow{grid-template-columns:1fr 1fr}
}
/* ‚ïê‚ïê‚ïê SMART REMINDERS ‚ïê‚ïê‚ïê */
.reminder-card{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r);padding:18px;display:flex;align-items:flex-start;gap:11px;transition:all .25s;margin-bottom:11px;flex-wrap:wrap}
.reminder-card:hover{box-shadow:var(--shadow);transform:translateX(4px)}
.reminder-card.urgent{border-color:var(--red-border);background:var(--red-bg)}
.reminder-card.soon{border-color:var(--amber-border);background:var(--amber-bg)}
.reminder-card.normal{border-color:var(--green-border);background:var(--green-bg)}
.reminder-ic{width:46px;height:46px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:1.3rem;flex-shrink:0}
.reminder-title{font-weight:800;font-size:.93rem;color:var(--tx);margin-bottom:3px}
.reminder-sub{font-size:.8rem;color:var(--tx3);line-height:1.5}
.reminder-time{font-size:.7rem;font-weight:800;padding:4px 8px;border-radius:100px;flex-shrink:0;margin-left:auto;white-space:nowrap;align-self:flex-start;margin-top:2px}
.rm-bell{animation:bounce 2s ease infinite}


/* ‚ïê‚ïê‚ïê TIMETABLE ‚ïê‚ïê‚ïê */
.tt-grid{display:grid;grid-template-columns:80px repeat(7,1fr);gap:3px;margin-top:16px}
.tt-head{background:var(--surface2);border-radius:var(--r-sm);padding:10px 6px;text-align:center;font-size:.72rem;font-weight:900;color:var(--tx2);text-transform:uppercase;letter-spacing:.5px;word-break:keep-all;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.tt-time{background:var(--surface2);border-radius:var(--r-sm);padding:8px 6px;text-align:center;font-size:.72rem;font-weight:700;color:var(--tx4);display:flex;align-items:center;justify-content:center}
.tt-cell{min-height:52px;border-radius:var(--r-sm);border:1.5px dashed var(--border);background:var(--surface);cursor:pointer;transition:all .18s;position:relative;display:flex;align-items:center;justify-content:center}
.tt-cell:hover{border-color:var(--acc);background:var(--acc-bg)}
.tt-cell.has-block{border:none;cursor:default}
.tt-block{width:100%;height:100%;border-radius:var(--r-sm);padding:6px 8px;display:flex;flex-direction:column;justify-content:center;position:relative;min-height:52px}
.tt-block-title{font-size:.76rem;font-weight:900;color:#fff;line-height:1.2;margin-bottom:2px}
.tt-block-sub{font-size:.62rem;color:rgba(255,255,255,.75)}
.tt-block-del{position:absolute;top:4px;right:4px;width:18px;height:18px;border-radius:5px;background:rgba(0,0,0,.2);border:none;color:#fff;cursor:pointer;font-size:.6rem;display:none;align-items:center;justify-content:center;line-height:1}
.tt-cell.has-block:hover .tt-block-del{display:flex}
.tt-legend{display:flex;gap:10px;flex-wrap:wrap;margin-top:16px}
.tt-legend-item{display:flex;align-items:center;gap:6px;font-size:.78rem;font-weight:700;color:var(--tx2)}
.tt-legend-dot{width:12px;height:12px;border-radius:4px;flex-shrink:0}
.drag-over{border-color:var(--acc)!important;background:var(--acc-bg)!important;transform:scale(1.03)}

/* ‚ïê‚ïê‚ïê ONBOARDING ‚ïê‚ïê‚ïê */
.ob-overlay{position:fixed;inset:0;z-index:800;pointer-events:none}
.ob-backdrop{position:fixed;inset:0;background:rgba(7,9,26,.75);z-index:799;backdrop-filter:blur(4px)}
.ob-highlight{position:fixed;border-radius:var(--r);box-shadow:0 0 0 9999px rgba(7,9,26,.75),0 0 0 3px var(--acc);z-index:801;pointer-events:none;transition:all .4s cubic-bezier(.4,0,.2,1)}
.ob-tooltip{position:fixed;background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r-lg);padding:22px 24px;max-width:320px;z-index:802;box-shadow:0 14px 48px rgba(0,0,0,.35);animation:scaleIn .3s cubic-bezier(.34,1.56,.64,1)}
.ob-step-num{font-size:.68rem;font-weight:900;color:var(--acc);letter-spacing:2px;text-transform:uppercase;margin-bottom:8px}
.ob-title{font-weight:900;font-size:1.05rem;color:var(--tx);margin-bottom:7px}
.ob-desc{font-size:.88rem;color:var(--tx3);line-height:1.7;margin-bottom:18px}
.ob-dots{display:flex;gap:5px;margin-bottom:16px}
.ob-dot{width:7px;height:7px;border-radius:50%;background:var(--border2);transition:background .2s}
.ob-dot.active{background:var(--acc);width:20px;border-radius:4px}
.ob-btns{display:flex;gap:9px;align-items:center}

/* ‚ïê‚ïê‚ïê GLOBAL SEARCH ‚ïê‚ïê‚ïê */
.gs-overlay{position:fixed;inset:0;background:rgba(7,9,26,.7);z-index:700;display:none;align-items:flex-start;justify-content:center;padding:80px 20px 20px;backdrop-filter:blur(10px)}
.gs-overlay.show{display:flex;animation:fadeIn .18s ease}
.gs-box{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r-xl);width:100%;max-width:620px;box-shadow:var(--shadow-xl);overflow:hidden;animation:scaleIn .22s cubic-bezier(.34,1.56,.64,1)}
.gs-input-row{display:flex;align-items:center;gap:11px;padding:16px 20px;border-bottom:1px solid var(--border)}
.gs-inp{flex:1;border:none;background:transparent;font-size:1.05rem;color:var(--tx);outline:none;font-family:var(--font)}
.gs-inp::placeholder{color:var(--tx4)}
.gs-kbd{font-size:.7rem;font-family:var(--font-mono);background:var(--surface2);border:1px solid var(--border);border-radius:5px;padding:2px 7px;color:var(--tx3)}
.gs-results{max-height:420px;overflow-y:auto}
.gs-section{padding:10px 20px 5px;font-size:.68rem;font-weight:900;color:var(--tx4);text-transform:uppercase;letter-spacing:2px}
.gs-item{display:flex;align-items:center;gap:13px;padding:12px 20px;cursor:pointer;transition:background .12s;border-radius:0}
.gs-item:hover,.gs-item.focused{background:var(--surface2)}
.gs-item-ic{width:36px;height:36px;border-radius:11px;display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0}
.gs-item-title{font-size:.9rem;font-weight:700;color:var(--tx);margin-bottom:2px}
.gs-item-sub{font-size:.75rem;color:var(--tx3)}
.gs-empty{text-align:center;padding:40px;color:var(--tx3)}
.gs-empty-ic{font-size:2.5rem;margin-bottom:10px}
.gs-footer{padding:10px 20px;border-top:1px solid var(--border);display:flex;gap:16px;font-size:.72rem;color:var(--tx4)}
.gs-shortcut{display:flex;align-items:center;gap:5px}

/* ‚ïê‚ïê‚ïê AVATAR CUSTOMIZER ‚ïê‚ïê‚ïê */
.av-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(52px,1fr));gap:8px;margin-top:12px}
.av-emoji-btn{width:52px;height:52px;border-radius:14px;border:2px solid var(--border);background:var(--surface2);font-size:1.5rem;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center}
.av-emoji-btn:hover{transform:scale(1.15);border-color:var(--acc)}
.av-emoji-btn.selected{border-color:var(--acc);background:var(--acc-bg);box-shadow:0 0 0 3px rgba(61,90,254,.2)}
.av-color-dot{width:36px;height:36px;border-radius:50%;cursor:pointer;transition:all .2s;border:3px solid transparent;flex-shrink:0}
.av-color-dot:hover{transform:scale(1.15)}
.av-color-dot.selected{border-color:var(--tx);box-shadow:0 0 0 2px var(--surface),0 0 0 4px var(--tx)}
.av-preview{width:90px;height:90px;border-radius:26px;display:flex;align-items:center;justify-content:center;font-size:2.8rem;font-weight:900;transition:all .35s;margin:0 auto 6px;box-shadow:0 8px 28px rgba(0,0,0,.18)}
.av-preview.initials-mode{font-size:2.2rem}
.av-tab{padding:9px 20px;border-radius:100px;border:1.5px solid var(--border);background:transparent;font-size:.85rem;font-weight:700;cursor:pointer;color:var(--tx3);font-family:var(--font);transition:all .2s}
.av-tab.active{background:var(--acc);border-color:var(--acc);color:#fff}
.av-big{width:56px;height:56px;border-radius:17px;display:flex;align-items:center;justify-content:center;font-size:1.6rem;font-weight:900;flex-shrink:0;transition:all .3s}
.av-big.sm{width:42px;height:42px;border-radius:13px;font-size:1.1rem}
.av-big.lg{width:80px;height:80px;border-radius:24px;font-size:2.4rem}
</style>
</head>
<body>

<!-- LANDING PAGE -->
<div id="landingPage">
  <nav class="land-nav">
    <div class="land-logo">
      <div class="land-logo-ic">üìö</div>
      <span>StudyBot Pro</span>
    </div>
    <div class="land-nav-right">
      <button class="theme-toggle-btn" onclick="toggleTheme()">üåô</button>
      <button class="btn-outline" onclick="showAuth('login')">Sign In</button>
      <button class="btn-solid" onclick="showAuth('register')">Get Started Free ‚Üí</button>
    </div>
  </nav>

  <section class="hero">
    <div class="hero-bg">
      <div class="hero-grid"></div>
      <div class="hero-blob hero-blob1"></div>
      <div class="hero-blob hero-blob2"></div>
      <div class="hero-blob hero-blob3"></div>
    </div>
    <div class="hero-content">
      <div class="hero-badge">üéì AI-Powered Study Companion</div>
      <h1 class="hero-h1">Study <em>Smarter.</em><br>Score Higher.</h1>
      <p class="hero-sub">Your complete academic toolkit ‚Äî AI quizzes, smart notes, performance predictor, Pomodoro timer, streak tracker & gamified XP system. Free forever.</p>
      <div class="hero-btns">
        <button class="btn-hero-prim" onclick="showAuth('register')">üöÄ Start for Free</button>
        <button class="btn-hero-sec" onclick="document.getElementById('features-sec').scrollIntoView({behavior:'smooth'})">Explore Features ‚Üì</button>
      </div>
      <div class="hero-stats">
        <div class="hero-stat"><div class="hero-stat-val">6</div><div class="hero-stat-lbl">Subjects</div></div>
        <div class="hero-stat"><div class="hero-stat-val">120+</div><div class="hero-stat-lbl">Questions</div></div>
        <div class="hero-stat"><div class="hero-stat-val">22</div><div class="hero-stat-lbl">Badges</div></div>
        <div class="hero-stat"><div class="hero-stat-val">100%</div><div class="hero-stat-lbl">Free</div></div>
      </div>
    </div>
  </section>

  <!-- FEATURES -->
  <section class="feat-section" id="features-sec">
    <div style="max-width:960px;margin:0 auto">
      <div class="section-label">Everything you need</div>
      <h2 class="section-h2">Your complete study <em>arsenal</em></h2>
      <p class="section-p">From task management to AI-powered predictions ‚Äî all in one beautifully designed app.</p>
      <div class="features-grid">
        <div class="feat-card"><div class="feat-icon" style="background:#EEF1FF">üß†</div><div class="feat-title">AI Quiz Engine</div><div class="feat-desc">120+ questions across 6 subjects with instant explanations, difficulty badges, and full score history tracking.</div></div>
        <div class="feat-card"><div class="feat-icon" style="background:#F5F3FF">üìä</div><div class="feat-title">Performance Predictor</div><div class="feat-desc">Predict your exam score using study hours, quiz averages, attendance data, and learning patterns.</div></div>
        <div class="feat-card"><div class="feat-icon" style="background:#EDFAF3">‚è±Ô∏è</div><div class="feat-title">Pomodoro Timer</div><div class="feat-desc">Focus sessions with break reminders and distraction-free full-screen focus mode built in.</div></div>
        <div class="feat-card"><div class="feat-icon" style="background:#FFFBEB">üèÜ</div><div class="feat-title">XP & Badges</div><div class="feat-desc">Earn XP for every action. Unlock 22 unique badges. Level up from Seedling all the way to Grandmaster.</div></div>
        <div class="feat-card"><div class="feat-icon" style="background:#FFF0F0">üìù</div><div class="feat-title">Smart Notes</div><div class="feat-desc">Capture study notes organised by subject with quick search, edit, and intelligent subject filtering.</div></div>
        <div class="feat-card"><div class="feat-icon" style="background:#EDFAF9">üÉè</div><div class="feat-title">Flashcards + Spaced Repetition</div><div class="feat-desc">Create decks, flip cards, and rate difficulty. Smart SM-2 scheduling shows due cards first.</div></div>
        <div class="feat-card"><div class="feat-icon" style="background:#F6F0FF">‚ö°</div><div class="feat-title">Daily Challenges</div><div class="feat-desc">Fresh challenge every day with bonus XP rewards. Build consistent daily study habits automatically.</div></div>
        <div class="feat-card"><div class="feat-icon" style="background:#EDFAF3">üî•</div><div class="feat-title">Streak Tracker</div><div class="feat-desc">Visual calendar showing your study journey. Track current streak, best streak, and total days studied.</div></div>
        <div class="feat-card"><div class="feat-icon" style="background:#EEF1FF">üìÖ</div><div class="feat-title">Study Planner</div><div class="feat-desc">AI-generated personalised study plans based on your exam date, target score, and current knowledge.</div></div>
      </div>
    </div>
  </section>

  <!-- HOW IT WORKS -->
  <section class="how-section">
    <div style="max-width:960px;margin:0 auto;text-align:center">
      <div class="section-label">Simple process</div>
      <h2 class="section-h2">How it <em>works</em></h2>
      <p class="section-p" style="margin:0 auto 56px">Get started in under 60 seconds and see results from day one.</p>
      <div class="steps-grid">
        <div class="step-card"><div class="step-num">1</div><div class="step-title">Create your account</div><div class="step-desc">Sign up free in seconds. No credit card needed, no hidden fees. Just your name and email.</div></div>
        <div class="step-card"><div class="step-num">2</div><div class="step-title">Add your tasks & subjects</div><div class="step-desc">Add assignments, exams, and study goals. Organise by subject and set priority levels.</div></div>
        <div class="step-card"><div class="step-num">3</div><div class="step-title">Study with AI guidance</div><div class="step-desc">Take quizzes, use the Pomodoro timer, create flashcards, and get AI-powered study plans.</div></div>
        <div class="step-card"><div class="step-num">4</div><div class="step-title">Level up & earn badges</div><div class="step-desc">Every action earns XP. Unlock achievements, climb the leaderboard, and track your growth.</div></div>
      </div>
    </div>
  </section>

  <!-- STATS STRIP -->
  <section class="stats-strip">
    <div class="stats-strip-grid">
      <div><div class="ss-val">50K+</div><div class="ss-lbl">Students Using</div></div>
      <div><div class="ss-val">2M+</div><div class="ss-lbl">Tasks Completed</div></div>
      <div><div class="ss-val">98%</div><div class="ss-lbl">Satisfaction Rate</div></div>
      <div><div class="ss-val">4.9‚òÖ</div><div class="ss-lbl">Average Rating</div></div>
    </div>
  </section>

  <!-- TESTIMONIALS -->
  <section class="testimonials-section">
    <div style="max-width:960px;margin:0 auto">
      <div class="section-label">Student reviews</div>
      <h2 class="section-h2">What students <em>say</em></h2>
      <p class="section-p" style="margin-bottom:48px">Real feedback from real students who improved their grades.</p>
      <div class="testi-grid">
        <div class="testi-card"><div class="testi-stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div><div class="testi-text">"StudyBot Pro completely changed how I prepare for exams. The AI quiz feature helped me identify my weak areas and the streak tracker kept me consistent for 45 days!"</div><div class="testi-author"><div class="testi-av">A</div><div><div class="testi-name">Arjun Sharma</div><div class="testi-role">Class 12, CBSE ¬∑ Science</div></div></div></div>
        <div class="testi-card"><div class="testi-stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div><div class="testi-text">"The Pomodoro timer is a game changer. I used to study for hours without focus, but now I complete more in 2 focused sessions than I did in a whole evening before."</div><div class="testi-author"><div class="testi-av">P</div><div><div class="testi-name">Priya Nair</div><div class="testi-role">2nd Year Engineering ¬∑ CSE</div></div></div></div>
        <div class="testi-card"><div class="testi-stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div><div class="testi-text">"The performance predictor is shockingly accurate. It predicted my maths score within 3% of my actual result. Now I use it every week to adjust my study plan."</div><div class="testi-author"><div class="testi-av">R</div><div><div class="testi-name">Rahul Verma</div><div class="testi-role">Class 11 ¬∑ NEET Aspirant</div></div></div></div>
        <div class="testi-card"><div class="testi-stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div><div class="testi-text">"I love the XP and badges system! It makes studying actually fun. I competed with my friends on the leaderboard and we all ended up studying more as a result."</div><div class="testi-author"><div class="testi-av">S</div><div><div class="testi-name">Sneha Reddy</div><div class="testi-role">BSc Mathematics ¬∑ Year 3</div></div></div></div>
        <div class="testi-card"><div class="testi-stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div><div class="testi-text">"The spaced repetition flashcards are brilliant. I memorised the entire periodic table in a week using this system. Highly recommend to every science student!"</div><div class="testi-author"><div class="testi-av">K</div><div><div class="testi-name">Karthik Balaji</div><div class="testi-role">Class 12 ¬∑ JEE Aspirant</div></div></div></div>
        <div class="testi-card"><div class="testi-stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div><div class="testi-text">"As someone who struggles with consistency, the daily challenges and streak system gave me the accountability I needed. I haven't missed a study day in 3 weeks!"</div><div class="testi-author"><div class="testi-av">M</div><div><div class="testi-name">Meera Iyer</div><div class="testi-role">Postgraduate ¬∑ Literature</div></div></div></div>
      </div>
    </div>
  </section>

  <!-- FAQ -->
  <section class="faq-section">
    <div style="max-width:720px;margin:0 auto;text-align:center">
      <div class="section-label">Common questions</div>
      <h2 class="section-h2">Frequently <em>asked</em></h2>
      <p class="section-p" style="margin:0 auto 48px">Everything you need to know about StudyBot Pro.</p>
      <div class="faq-list" style="text-align:left">
        <div class="faq-item" onclick="toggleFAQ(this)"><div class="faq-q">Is StudyBot Pro really free? <span class="faq-arrow">‚ñæ</span></div><div class="faq-a">Yes! StudyBot Pro is 100% free, forever. All features including AI tools, quizzes, flashcards, badges, and unlimited tasks are completely free with no premium tier.</div></div>
        <div class="faq-item" onclick="toggleFAQ(this)"><div class="faq-q">Does my data get saved when I close the browser? <span class="faq-arrow">‚ñæ</span></div><div class="faq-a">All your data is stored locally in your browser using localStorage. This means your tasks, notes, XP, and streak data persist between sessions on the same device and browser.</div></div>
        <div class="faq-item" onclick="toggleFAQ(this)"><div class="faq-q">How does the AI Performance Predictor work? <span class="faq-arrow">‚ñæ</span></div><div class="faq-a">The predictor uses a weighted algorithm combining your study hours, quiz scores, assignment submission rate, attendance, and subject interest to estimate your likely exam performance. It's designed as a guidance tool, not a guarantee.</div></div>
        <div class="faq-item" onclick="toggleFAQ(this)"><div class="faq-q">What subjects are covered in the Quiz section? <span class="faq-arrow">‚ñæ</span></div><div class="faq-a">Currently: Mathematics, Physics, Computer Science, Chemistry, Biology, and English. Each subject has 12 questions with detailed explanations. More subjects are being added regularly.</div></div>
        <div class="faq-item" onclick="toggleFAQ(this)"><div class="faq-q">How does spaced repetition work in Flashcards? <span class="faq-arrow">‚ñæ</span></div><div class="faq-a">We use the SM-2 algorithm. When you rate a card as "Hard," it reappears sooner. "Easy" cards have longer intervals. The system automatically schedules the right cards to review at the right time for maximum retention.</div></div>
        <div class="faq-item" onclick="toggleFAQ(this)"><div class="faq-q">Can I use StudyBot Pro on mobile? <span class="faq-arrow">‚ñæ</span></div><div class="faq-a">Absolutely! StudyBot Pro is fully responsive and works beautifully on all screen sizes. On mobile you get a dedicated bottom navigation bar for quick access to all features.</div></div>
      </div>
    </div>
  </section>

  <!-- CTA SECTION -->
  <section style="padding:90px 5%;background:var(--surface);text-align:center">
    <div style="max-width:600px;margin:0 auto">
      <div style="font-size:3.2rem;margin-bottom:16px">üöÄ</div>
      <h2 style="font-family:var(--font-d);font-size:clamp(1.8rem,3.5vw,2.8rem);font-weight:900;color:var(--tx);margin-bottom:16px">Ready to <em style="color:var(--acc)">transform</em> your studies?</h2>
      <p style="font-size:1.05rem;color:var(--tx3);margin-bottom:36px;line-height:1.8">Join thousands of students who are already studying smarter. Takes 30 seconds to get started.</p>
      <button class="btn-hero-prim" onclick="showAuth('register')" style="margin:0 auto">‚ú® Create Free Account</button>
    </div>
  </section>

  <footer class="land-footer">
    <div class="land-logo" style="font-size:1.05rem"><div class="land-logo-ic" style="width:30px;height:30px;font-size:.95rem">üìö</div><span>StudyBot Pro</span></div>
    <span>¬© 2025 StudyBot ‚Äî Built for students everywhere</span>
    <span>Free Forever üíö</span>
  </footer>
</div>

<!-- AUTH PAGE -->
<div id="authPage" style="display:flex">
  <div class="auth-blob auth-blob1"></div>
  <div class="auth-blob auth-blob2"></div>
  <div class="auth-card">
    <div style="text-align:center;margin-bottom:10px">
      <div class="auth-logo-ic">üìö</div>
      <div class="auth-title">StudyBot Pro</div>
    </div>
    <div class="auth-sub">Your personalised AI study companion</div>
    <div class="auth-tabs">
      <button class="auth-tab active" id="aTabLogin" onclick="switchAuthTab('login')">Sign In</button>
      <button class="auth-tab" id="aTabReg" onclick="switchAuthTab('register')">Register</button>
    </div>
    <div id="loginForm">
      <div class="form-grp"><label class="form-lbl">Email Address</label><input type="email" id="lEmail" class="form-inp" placeholder="you@example.com"/><div class="form-err" id="lEmailErr">Please enter a valid email.</div></div>
      <div class="form-grp"><label class="form-lbl">Password</label><input type="password" id="lPass" class="form-inp" placeholder="Your password"/><div class="form-err" id="lPassErr">Invalid email or password.</div></div>
      <button class="btn-full" onclick="handleLogin()">üöÄ Sign In</button>
      <div id="qlWrap" style="display:none"><div class="ql-section"><div class="ql-lbl">Quick Login</div><div class="ql-chips" id="qlChips"></div></div></div>
    </div>
    <div id="regForm" style="display:none">
      <div class="form-grp"><label class="form-lbl">Full Name</label><input type="text" id="rName" class="form-inp" placeholder="Your name"/><div class="form-err" id="rNameErr">Name is required.</div></div>
      <div class="form-grp"><label class="form-lbl">Email Address</label><input type="email" id="rEmail" class="form-inp" placeholder="you@example.com"/><div class="form-err" id="rEmailErr">Enter a valid email.</div></div>
      <div class="form-grp"><label class="form-lbl">Department / Branch</label><select id="rDept" class="form-sel"><option value="">Select Department</option><option value="AI_DS">ü§ñ AI & Data Science</option><option value="AI_ML">üß† AI & Machine Learning</option><option value="CSE">üíª Computer Science (CSE)</option><option value="IT">üåê Information Technology (IT)</option><option value="ECE">üì° Electronics & Communication (ECE)</option><option value="EEE">‚ö° Electrical Engineering (EEE)</option><option value="MECH">‚öôÔ∏è Mechanical Engineering</option><option value="CIVIL">üèóÔ∏è Civil Engineering</option><option value="MBA">üíº MBA / Business</option><option value="BCA">üñ•Ô∏è BCA / MCA</option><option value="OTHER">üìö Other</option></select></div>
      <div class="form-row">
        <div class="form-grp"><label class="form-lbl">Year / Grade</label><select id="rGrade" class="form-sel"><option value="">Select</option><option>1st Year</option><option>2nd Year</option><option>3rd Year</option><option>4th Year</option><option>Class 9</option><option>Class 10</option><option>Class 11</option><option>Class 12</option><option>Postgraduate</option><option>Other</option></select></div>
        <div class="form-grp"><label class="form-lbl">Password</label><input type="password" id="rPass" class="form-inp" placeholder="Min 4 chars"/><div class="form-err" id="rPassErr">Password must be 4+ characters.</div></div>
      </div>
      <button class="btn-full" onclick="handleRegister()">‚ú® Create Account</button>
    </div>
    <div class="auth-back"><a href="#" onclick="showLanding();return false">‚Üê Back to home</a></div>
  </div>
</div>

<!-- MAIN APP -->
<div id="app">
  <header class="topbar">
    <button class="topbar-hamburger" onclick="toggleSidebar()">‚ò∞</button>
    <div class="topbar-title" id="tbTitle">Dashboard</div>
    <div class="topbar-right">
      <div style="position:relative">
        <button class="tb-ic-btn" id="notifBtn" onclick="toggleNotif()">üîî<span class="notif-dot" id="notifDot"></span></button>
        <div class="notif-panel" id="notifPanel">
          <div class="np-hd"><span class="np-t">Notifications</span><span class="np-clr" onclick="clearNotifs()">Clear all</span></div>
          <div class="np-list" id="npList"></div>
        </div>
      </div>
      <button class="tb-ic-btn" id="themeBtn2" onclick="toggleTheme()">üåô</button>
      <button class="tb-ic-btn" onclick="openGlobalSearch()" title="Search (Ctrl+K)" style="position:relative">
  üîç
  <span class="kb-badge" style="position:absolute;bottom:-1px;right:-1px;font-size:.45rem;font-family:var(--font-mono);background:var(--surface2);border:1px solid var(--border);border-radius:3px;padding:1px 3px;color:var(--tx4)">‚åòK</span>
</button>
<button class="tb-ic-btn" id="focusBtn" onclick="enterFocus()" title="Focus Mode">üéØ</button>
      <div class="user-pill" onclick="navigate('account')">
        <div id="tbAvatar" onclick="openAvatarModal()" title="Change avatar" style="width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,var(--acc),var(--purple));display:flex;align-items:center;justify-content:center;font-weight:900;color:#fff;font-size:.9rem;cursor:pointer;overflow:hidden;flex-shrink:0;transition:transform .2s" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform=''"></div>
        <div class="user-pill-av" id="tbAv" style="display:none">?</div>
        <div class="user-pill-name" id="tbName">User</div>
      </div>
    </div>
  </header>

  <div class="app-body" id="appBody">
    <aside class="sidebar" id="sidebar">
      <div class="sb-logo">
        <div class="sb-logo-ic">üìö</div>
        <div class="sb-logo-txt">StudyBot Pro</div>
      </div>
      <div class="sb-nav">
        <div class="sb-section">
          <div class="sb-section-lbl">Overview</div>
          <button class="sb-btn active" data-pg="dashboard" onclick="navigate('dashboard')"><span class="sb-ic">üè†</span><span class="sb-lbl">Dashboard</span></button>
          <button class="sb-btn" data-pg="tasks" onclick="navigate('tasks')"><span class="sb-ic">üìã</span><span class="sb-lbl">My Tasks</span><span class="sb-badge" id="sbBadge" style="display:none">!</span></button>
          <button class="sb-btn" data-pg="upcoming" onclick="navigate('upcoming')"><span class="sb-ic">üìÖ</span><span class="sb-lbl">Upcoming</span></button>
        </div>
        <div class="sb-section">
          <div class="sb-section-lbl">Learn</div>
          <button class="sb-btn" data-pg="quiz" onclick="navigate('quiz')"><span class="sb-ic">üß†</span><span class="sb-lbl">Quiz</span></button>
          <button class="sb-btn" data-pg="flashcards" onclick="navigate('flashcards')"><span class="sb-ic">üÉè</span><span class="sb-lbl">Flashcards</span></button>
          <button class="sb-btn" data-pg="notes" onclick="navigate('notes')"><span class="sb-ic">üìù</span><span class="sb-lbl">Notes</span></button>
          <button class="sb-btn" data-pg="aitools" onclick="navigate('aitools')"><span class="sb-ic">‚ú®</span><span class="sb-lbl">AI Tools</span></button>
        </div>
        <div class="sb-section">
          <div class="sb-section-lbl">Track</div>
          <button class="sb-btn" data-pg="performance" onclick="navigate('performance')"><span class="sb-ic">üìà</span><span class="sb-lbl">Performance</span></button>
          <button class="sb-btn" data-pg="streaks" onclick="navigate('streaks')"><span class="sb-ic">üî•</span><span class="sb-lbl">Streaks & Goals</span></button>
          <button class="sb-btn" data-pg="exam" onclick="navigate('exam')"><span class="sb-ic">üìÜ</span><span class="sb-lbl">Exam Schedule</span></button>
          <button class="sb-btn" data-pg="deptLeader" onclick="navigate('deptLeader')"><span class="sb-ic">üèÜ</span><span class="sb-lbl">Dept Leaderboard</span></button>
          <button class="sb-btn" data-pg="pomodoro" onclick="navigate('pomodoro')"><span class="sb-ic">‚è±Ô∏è</span><span class="sb-lbl">Pomodoro</span></button>
          <button class="sb-btn" data-pg="gamify" onclick="navigate('gamify')"><span class="sb-ic">üéñÔ∏è</span><span class="sb-lbl">XP & Badges</span></button>
          <button class="sb-btn" data-pg="daily" onclick="navigate('daily')"><span class="sb-ic">‚ö°</span><span class="sb-lbl">Daily Challenge</span></button>
        </div>
        <div class="sb-section">
          <div class="sb-section-lbl">Manage</div>
          <button class="sb-btn" data-pg="add" onclick="navigate('add')"><span class="sb-ic">‚ûï</span><span class="sb-lbl">Add Task</span></button>
          <button class="sb-btn" data-pg="account" onclick="navigate('account')"><span class="sb-ic">‚öôÔ∏è</span><span class="sb-lbl">Account</span></button>
          <button class="sb-btn" data-pg="report" onclick="navigate('report')"><span class="sb-ic">üìä</span><span class="sb-lbl">Progress Report</span></button>
          <button class="sb-btn" data-pg="friends" onclick="navigate('friends')"><span class="sb-ic">üë•</span><span class="sb-lbl">Friends</span><span class="sb-badge" id="friendBadge" style="display:none">!</span></button>
          <button class="sb-btn" data-pg="studygroups" onclick="navigate('studygroups')"><span class="sb-ic">üè´</span><span class="sb-lbl">Study Groups</span></button>
          <button class="sb-btn" data-pg="timetable" onclick="navigate('timetable')"><span class="sb-ic">üóìÔ∏è</span><span class="sb-lbl">Timetable</span></button>
          <button class="sb-btn" data-pg="reminders" onclick="navigate('reminders')"><span class="sb-ic">üîî</span><span class="sb-lbl">Reminders</span><span class="sb-badge" id="reminderBadge" style="display:none">!</span></button>
        </div>
      </div>
      <div class="sb-bottom">
        <div class="sb-xp-wrap">
          <div style="display:flex;justify-content:space-between;font-size:.7rem;font-weight:800;color:var(--tx3);margin-bottom:5px"><span id="sbLvlLbl">Lv.1 Seedling</span><span id="sbXpLbl" style="color:var(--acc)">0 XP</span></div>
          <div style="height:6px;background:var(--surface3);border-radius:3px;overflow:hidden"><div id="sbXpBar" style="height:100%;width:0%;background:linear-gradient(90deg,var(--acc),var(--purple));border-radius:3px;transition:width .7s"></div></div>
        </div>
        <div class="sb-user">
          <div class="sb-user-av" id="sbAv">?</div>
          
          <div class="sb-user-info"><div class="sb-user-name" id="sbName">Loading</div><div class="sb-user-role" id="sbGrade">Student</div></div>
          <button class="sb-logout" onclick="handleLogout()">Sign out</button>
        </div>
      </div>
    </aside>

    <main class="content" id="contentArea">

      <!-- DASHBOARD -->
      <div class="page active" id="dashboardPage">
        <div class="dash-greet" style="display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:14px">
          <div><h2 id="greetH">Good morning! üëã</h2><p id="greetP">Here's your study overview.</p></div>
          <div id="dashXPCard" onclick="navigate('gamify')" style="cursor:pointer;background:linear-gradient(135deg,var(--acc-bg),var(--purple-bg));border:1px solid rgba(61,90,254,.25);border-radius:var(--r-lg);padding:16px 22px;min-width:180px;flex-shrink:0;transition:transform .2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform=''">
            <div style="display:flex;align-items:center;gap:9px;margin-bottom:8px"><span id="dashLvEmoji" style="font-size:1.5rem">üå±</span><div><div style="font-size:.65rem;font-weight:800;color:var(--tx3);letter-spacing:1px">LEVEL</div><div style="font-family:var(--font-d);font-weight:900;font-size:.95rem;color:var(--tx)" id="dashLvName">Seedling</div></div></div>
            <div style="height:7px;background:var(--surface3);border-radius:3px;overflow:hidden;margin-bottom:6px"><div id="dashXPBarFill" style="height:100%;background:linear-gradient(90deg,var(--acc),var(--purple));border-radius:3px;transition:width .9s;width:0%"></div></div>
            <div style="font-size:.68rem;color:var(--tx3)"><span id="dashXPVal">0</span> XP ¬∑ tap to view</div>
          </div>
        </div>

        <!-- TIPS TICKER -->
        <div class="tips-ticker" id="tipsTicker">
          <span class="tips-label">üí° Tip</span>
          <span class="tips-text" id="tipsText">Loading daily tip...</span>
        </div>

        <div class="kpi-row" id="kpiRow"></div>
        <div class="dash-main">
          <div class="card">
            <div class="c-hd"><div><div class="c-title">Recent Activity</div><div class="c-sub">Latest task updates</div></div><button class="btn btn-sm btn-g" onclick="navigate('tasks')">View All ‚Üí</button></div>
            <div id="recentTasks"></div>
          </div>
          <div class="dash-col-right">
            <div class="card" style="text-align:center">
              <div class="c-title" style="margin-bottom:18px">Overall Progress</div>
              <div class="ring-wrap"><svg class="ring-svg" viewBox="0 0 100 100" width="140" height="140"><circle class="ring-bg-c" cx="50" cy="50" r="45"/><circle class="ring-fg-c" cx="50" cy="50" r="45" id="dashRing"/></svg><div class="ring-ctr"><div class="ring-pct" id="ringPct">0%</div><div class="ring-pct-lbl">Done</div></div></div>
            </div>
            <div class="card">
              <div class="c-hd"><div><div class="c-title">Study Streak</div><div class="c-sub">Last 7 days</div></div><div style="font-family:var(--font-d);font-size:2rem;font-weight:900;color:var(--acc)" id="streakNum">0üî•</div></div>
              <div class="streak-days" id="streakDays"></div>
            </div>
          </div>
        </div>
        <div class="dash-bottom">
          <div class="card"><div class="c-hd"><div class="c-title">Task Distribution</div></div><div style="position:relative;height:168px"><canvas id="donutChart"></canvas></div></div>
          <div class="card"><div class="c-hd"><div class="c-title">Weekly Completions</div></div><div style="position:relative;height:168px"><canvas id="barChart"></canvas></div></div>
          <div class="card"><div class="c-title" style="margin-bottom:14px">Quick Stats</div><div id="quickStats"></div></div>
        </div>

        <!-- NEW: MOTIVATIONAL QUOTE -->
        <div style="margin-top:18px">
          <div class="card quote-card">
            <div class="quote-text" id="dashQuote">"The secret of getting ahead is getting started."</div>
            <div class="quote-author" id="dashQuoteAuthor">‚Äî Mark Twain</div>
          </div>
        </div>

        <!-- NEW: SUBJECT BREAKDOWN + INSIGHTS -->
        <div class="grid-2" style="margin-top:18px">
          <div class="card">
            <div class="c-hd"><div class="c-title">üìö Subject Breakdown</div></div>
            <div id="dashSubjectBreakdown"></div>
          </div>
          <div class="card">
            <div class="c-hd"><div class="c-title">üîç Study Insights</div></div>
            <div id="dashInsights"></div>
          </div>
        </div>

        <!-- NEW: UPCOMING EXAMS WIDGET -->
        <div class="card" style="margin-top:18px">
          <div class="c-hd"><div class="c-title">üìÖ Upcoming Deadlines (Next 7 Days)</div><button class="btn btn-sm btn-g" onclick="navigate('upcoming')">See All ‚Üí</button></div>
          <div id="dashUpcoming"></div>
        </div>
        <!-- EXTRA DASHBOARD SECTIONS -->

<!-- TODAY'S SCHEDULE -->
<div class="card" style="margin-top:18px">
  <div class="c-hd">
    <div><div class="c-title">üìÜ Today's Schedule</div><div class="c-sub">Your time blocks for today</div></div>
    <button class="btn btn-sm btn-p" onclick="navigate('add')">+ Add Task</button>
  </div>
  <div id="todaySchedule"></div>
</div>

<!-- STUDY PROGRESS RING ROW -->
<div style="margin-top:18px;display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:13px" id="subjectRingRow"></div>

<!-- POMODORO QUICK START -->
<div class="card" style="margin-top:18px;background:linear-gradient(135deg,#0f0c29,#302b63,#24243e);border:none;color:#fff;position:relative;overflow:hidden">
  <div style="position:absolute;right:-30px;top:-30px;width:180px;height:180px;background:rgba(255,255,255,.03);border-radius:50%"></div>
  <div style="position:absolute;right:40px;bottom:-40px;width:140px;height:140px;background:rgba(255,255,255,.03);border-radius:50%"></div>
  <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:16px;position:relative;z-index:1">
    <div>
      <div style="font-size:.72rem;font-weight:800;opacity:.6;letter-spacing:2px;text-transform:uppercase;margin-bottom:8px">‚è±Ô∏è FOCUS TIMER</div>
      <div style="font-size:1.3rem;font-weight:900;margin-bottom:6px">Ready to focus?</div>
      <div style="font-size:.88rem;opacity:.7">Start a Pomodoro session and earn <b>+25 XP</b></div>
    </div>
    <div style="display:flex;gap:11px">
      <button onclick="navigate('pomodoro')" style="padding:13px 28px;border-radius:100px;border:none;background:linear-gradient(135deg,var(--acc),var(--purple));color:#fff;font-weight:800;font-size:.92rem;cursor:pointer;box-shadow:0 4px 20px rgba(61,90,254,.5)">‚ñ∂ Start Now</button>
      <button onclick="enterFocus()" style="padding:13px 22px;border-radius:100px;border:1.5px solid rgba(255,255,255,.2);background:transparent;color:#fff;font-weight:700;font-size:.88rem;cursor:pointer">üéØ Focus Mode</button>
    </div>
  </div>
</div>

<!-- RECENT QUIZ PERFORMANCE -->
<div class="card" style="margin-top:18px">
  <div class="c-hd">
    <div><div class="c-title">üß† Recent Quiz Performance</div><div class="c-sub">Last 5 quizzes</div></div>
    <button class="btn btn-sm btn-g" onclick="navigate('quiz')">Take Quiz ‚Üí</button>
  </div>
  <div id="dashRecentQuiz"></div>
</div>

<!-- FLASHCARD DUE REMINDER -->
<div class="card" style="margin-top:18px" id="dashFlashReminder">
  <div class="c-hd">
    <div><div class="c-title">üÉè Flashcards Due</div><div class="c-sub">Spaced repetition review</div></div>
    <button class="btn btn-sm btn-p" onclick="navigate('flashcards')">Review Now ‚Üí</button>
  </div>
  <div id="dashFlashContent"></div>
</div>

<!-- WEEKLY XP CHART -->
<div class="card" style="margin-top:18px">
  <div class="c-hd"><div class="c-title">‚ö° XP Earned This Week</div></div>
  <div style="position:relative;height:180px"><canvas id="xpWeekChart"></canvas></div>
</div>

<!-- SUBJECT TASK BREAKDOWN TABLE -->
<div class="card" style="margin-top:18px">
  <div class="c-hd"><div class="c-title">üìö Subject Task Summary</div></div>
  <div id="dashSubjectTable"></div>
</div>

<!-- BADGES RECENT -->
<div class="card" style="margin-top:18px">
  <div class="c-hd">
    <div><div class="c-title">üéñÔ∏è Recent Badges</div><div class="c-sub">Your latest achievements</div></div>
    <button class="btn btn-sm btn-g" onclick="navigate('gamify')">View All ‚Üí</button>
  </div>
  <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:11px" id="dashBadgesRow"></div>
</div>

<!-- NOTES RECENT -->
<div class="card" style="margin-top:18px">
  <div class="c-hd">
    <div><div class="c-title">üìù Recent Notes</div></div>
    <button class="btn btn-sm btn-g" onclick="navigate('notes')">View All ‚Üí</button>
  </div>
  <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px" id="dashRecentNotes"></div>
</div>

<!-- MOTIVATIONAL PROGRESS CARD -->
<div style="margin-top:18px;background:linear-gradient(135deg,var(--green-bg),var(--acc-bg));border:1px solid var(--green-border);border-radius:var(--r-lg);padding:28px;display:flex;align-items:center;gap:22px;flex-wrap:wrap">
  <div style="font-size:3.5rem">üéì</div>
  <div style="flex:1">
    <div style="font-size:1.1rem;font-weight:900;color:var(--tx);margin-bottom:5px" id="dashMotivMsg">Keep going!</div>
    <div style="font-size:.88rem;color:var(--tx3);line-height:1.7" id="dashMotivSub">You're making great progress.</div>
  </div>
  <div style="text-align:center;min-width:90px">
    <div style="font-size:2.2rem;font-weight:900;color:var(--green)" id="dashMotivXP">0</div>
    <div style="font-size:.72rem;color:var(--tx3);font-weight:700">TOTAL XP</div>
  </div>
</div>

<!-- TIPS & TRICKS GRID -->
<div class="card" style="margin-top:18px">
  <div class="c-hd"><div class="c-title">üí° Study Tips & Tricks</div></div>
  <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:13px" id="dashTipsGrid"></div>
</div>

<!-- EMPTY SPACE BOTTOM -->
<div style="height:32px"></div>
      </div>

      <!-- TASKS -->
      <div class="page" id="tasksPage">
        <div class="page-title">My Tasks</div><div class="page-sub">Manage and track all your assignments and study tasks</div>
        <div class="toolbar">
          <div class="search-w"><input type="text" id="taskSearch" placeholder="Search tasks..." oninput="renderTasks()"/></div>
          <div class="fc-row">
            <button class="fc active" data-f="all" onclick="setFilter('all',this)">All</button>
            <button class="fc" data-f="high" onclick="setFilter('high',this)">üî¥ High</button>
            <button class="fc" data-f="medium" onclick="setFilter('medium',this)">üü° Medium</button>
            <button class="fc" data-f="low" onclick="setFilter('low',this)">üü¢ Low</button>
            <button class="fc" data-f="completed" onclick="setFilter('completed',this)">‚úÖ Done</button>
            <button class="fc" data-f="overdue" onclick="setFilter('overdue',this)">‚ö†Ô∏è Overdue</button>
          </div>
          <button class="btn btn-p" onclick="navigate('add')">+ New Task</button>
        </div>
        <div class="tasks-grid" id="tasksGrid"></div>
      </div>

      <!-- UPCOMING -->
      <div class="page" id="upcomingPage"><div class="page-title">Upcoming Deadlines</div><div class="page-sub">Tasks and exams due in the next 14 days</div><div id="upcomingTl"></div></div>

      <!-- QUIZ -->
      <div class="page" id="quizPage">
        <div class="page-title">Quiz Yourself üß†</div><div class="page-sub">Test your knowledge ‚Äî earn XP for every correct answer!</div>
        <div id="quizSubjectSelect">
          <div class="quiz-subjects" id="quizSubjectsGrid"></div>
          <div style="text-align:center;margin-top:10px"><button class="btn btn-p" id="startQuizBtn" onclick="startQuiz()" disabled>Start Quiz ‚Üí</button></div>
        </div>
        <div class="quiz-area" id="quizArea">
          <div class="card" style="max-width:680px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
              <div class="quiz-q-num" id="quizQNum">Question 1/10</div>
              <div style="font-size:.85rem;font-weight:800;color:var(--acc);font-family:var(--font-mono)">Score: <span id="quizScore">0</span></div>
            </div>
            <div class="quiz-prog"><div class="quiz-prog-fill" id="quizProgFill" style="width:0%"></div></div>
            <div class="quiz-q" id="quizQ"></div>
            <div class="quiz-opts" id="quizOpts"></div>
            <div class="quiz-explanation" id="quizExp"></div>
            <button class="btn btn-p" id="quizNextBtn" onclick="nextQuestion()" style="display:none">Next Question ‚Üí</button>
          </div>
        </div>
        <div class="quiz-result card" id="quizResult" style="display:none;max-width:440px">
          <div style="font-size:3rem;margin-bottom:12px">üéì</div>
          <div class="quiz-result-score" id="quizFinalScore">0/10</div>
          <div class="quiz-result-msg" id="quizFinalMsg">Good effort!</div>
          <div style="display:flex;gap:11px;justify-content:center;margin-top:24px">
            <button class="btn btn-p" onclick="retakeQuiz()">‚Ü∫ Retake</button>
            <button class="btn btn-g" onclick="resetQuiz()">‚Üê Change Subject</button>
          </div>
          <!-- NEW: Recent quiz scores shown after result -->
          <div class="quiz-top-scores" id="quizTopScores"></div>
        </div>
      </div>

      <!-- NOTES -->
      <div class="page" id="notesPage">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px"><div class="page-title">Smart Notes üìù</div><button class="btn btn-p" onclick="openNoteEditor()">+ New Note</button></div>
        <div class="page-sub">Capture and organise your study notes by subject</div>
        <div class="notes-layout"><div class="notes-sidebar" id="notesSidebar"></div><div><div class="notes-grid" id="notesGrid"></div></div></div>
      </div>

      <!-- AI TOOLS -->
      <div class="page" id="aitoolsPage">
        <div class="page-title">AI Study Tools ‚ú®</div><div class="page-sub">Personalised AI-powered insights to boost your performance</div>
        <div class="ai-tools-nav">
          <button class="ai-tool-tab active" onclick="switchAITool('predictor',this)">üìä Performance Predictor</button>
          <button class="ai-tool-tab" onclick="switchAITool('difficulty',this)">üéØ Difficulty Adapter</button>
          <button class="ai-tool-tab" onclick="switchAITool('planner',this)">üìÖ Study Planner</button>
          <button class="ai-tool-tab" onclick="switchAITool('style',this)">üß† Learning Style</button>
          <button class="ai-tool-tab" onclick="switchAITool('topics',this)">‚úÖ Topic Recommender</button>
        </div>
        <div class="ai-tool-panel show" id="tool-predictor">
          <div class="grid-2"><div class="ai-input-card">
            <div class="c-title" style="margin-bottom:20px">üìà Your Study Profile</div>
            <div class="slider-grp"><div class="slider-lbl"><span>Daily Study Hours</span><span class="slider-val" id="sv-hours">3h</span></div><input type="range" class="sl" min="1" max="12" value="3" oninput="document.getElementById('sv-hours').textContent=this.value+'h'"/></div>
            <div class="slider-grp"><div class="slider-lbl"><span>Quiz Average Score</span><span class="slider-val" id="sv-quiz">65%</span></div><input type="range" class="sl" min="0" max="100" value="65" oninput="document.getElementById('sv-quiz').textContent=this.value+'%'"/></div>
            <div class="slider-grp"><div class="slider-lbl"><span>Assignment Submission Rate</span><span class="slider-val" id="sv-asgn">70%</span></div><input type="range" class="sl" min="0" max="100" value="70" oninput="document.getElementById('sv-asgn').textContent=this.value+'%'"/></div>
            <div class="slider-grp"><div class="slider-lbl"><span>Attendance Rate</span><span class="slider-val" id="sv-att">80%</span></div><input type="range" class="sl" min="0" max="100" value="80" oninput="document.getElementById('sv-att').textContent=this.value+'%'"/></div>
            <div class="slider-grp"><div class="slider-lbl"><span>Subject Interest (1-10)</span><span class="slider-val" id="sv-int">7</span></div><input type="range" class="sl" min="1" max="10" value="7" oninput="document.getElementById('sv-int').textContent=this.value"/></div>
            <button class="btn btn-p" style="width:100%;justify-content:center;margin-top:10px" onclick="predictPerf()">‚ö° Predict My Performance</button>
          </div><div id="predictResult" style="display:flex;align-items:center;justify-content:center"><div style="text-align:center;color:var(--tx4);padding:52px"><div style="font-size:3.2rem;margin-bottom:12px">üîÆ</div><div style="font-size:.95rem">Fill in your profile and click Predict!</div></div></div></div>
        </div>
        <div class="ai-tool-panel" id="tool-difficulty">
          <div class="grid-2"><div class="ai-input-card">
            <div class="c-title" style="margin-bottom:20px">üéÆ Performance Stats</div>
            <div class="slider-grp"><div class="slider-lbl"><span>Last Quiz Score</span><span class="slider-val" id="df-sv">65%</span></div><input type="range" class="sl" id="df-score" min="0" max="100" value="65" oninput="document.getElementById('df-sv').textContent=this.value+'%'"/></div>
            <div class="slider-grp"><div class="slider-lbl"><span>Minutes per Topic</span><span class="slider-val" id="df-tsv">20m</span></div><input type="range" class="sl" id="df-time" min="5" max="60" value="20" oninput="document.getElementById('df-tsv').textContent=this.value+'m'"/></div>
            <div class="slider-grp"><div class="slider-lbl"><span>Mistake Rate</span><span class="slider-val" id="df-esv">30%</span></div><input type="range" class="sl" id="df-err" min="0" max="100" value="30" oninput="document.getElementById('df-esv').textContent=this.value+'%'"/></div>
            <div class="slider-grp"><div class="slider-lbl"><span>Topics Completed</span><span class="slider-val" id="df-csv">75%</span></div><input type="range" class="sl" id="df-comp" min="0" max="100" value="75" oninput="document.getElementById('df-csv').textContent=this.value+'%'"/></div>
            <button class="btn btn-p" style="width:100%;justify-content:center;margin-top:10px" onclick="adaptDifficulty()">üéØ Find My Level</button>
          </div><div id="diffResult" style="display:flex;align-items:center;justify-content:center"><div style="text-align:center;color:var(--tx4);padding:52px"><div style="font-size:3.2rem;margin-bottom:12px">üéÆ</div><div style="font-size:.95rem">Enter your stats to find the perfect difficulty!</div></div></div></div>
        </div>
        <div class="ai-tool-panel" id="tool-planner">
          <div class="grid-2"><div class="ai-input-card">
            <div class="c-title" style="margin-bottom:20px">üìÜ Exam Details</div>
            <div class="form-grp"><label class="form-lbl">Subject Difficulty</label><select class="form-sel" id="pl-diff"><option value="1">üå± Easy</option><option value="2" selected>üìà Medium</option><option value="3">üî• Hard</option><option value="4">üöÄ Very Hard</option></select></div>
            <div class="slider-grp"><div class="slider-lbl"><span>Current Knowledge (1-10)</span><span class="slider-val" id="pl-ksv">5</span></div><input type="range" class="sl" id="pl-know" min="1" max="10" value="5" oninput="document.getElementById('pl-ksv').textContent=this.value"/></div>
            <div class="slider-grp"><div class="slider-lbl"><span>Days Until Exam</span><span class="slider-val" id="pl-dsv">21d</span></div><input type="range" class="sl" id="pl-days" min="3" max="90" value="21" oninput="document.getElementById('pl-dsv').textContent=this.value+'d'"/></div>
            <div class="slider-grp"><div class="slider-lbl"><span>Target Score</span><span class="slider-val" id="pl-tsv">85%</span></div><input type="range" class="sl" id="pl-target" min="50" max="100" value="85" oninput="document.getElementById('pl-tsv').textContent=this.value+'%'"/></div>
            <button class="btn btn-p" style="width:100%;justify-content:center;margin-top:10px" onclick="buildPlan()">üìÖ Build My Plan</button>
          </div><div id="planResult" style="display:flex;align-items:center;justify-content:center"><div style="text-align:center;color:var(--tx4);padding:52px"><div style="font-size:3.2rem;margin-bottom:12px">üìÜ</div><div style="font-size:.95rem">Set your exam details to get a personalised plan!</div></div></div></div>
        </div>
        <div class="ai-tool-panel" id="tool-style">
          <div class="grid-2"><div class="ai-input-card">
            <div class="c-title" style="margin-bottom:20px">üé® Your Preferences</div>
            <div class="slider-grp"><div class="slider-lbl"><span>Prefer diagrams over reading</span><span class="slider-val" id="ls-vsv">7</span></div><input type="range" class="sl" id="ls-vis" min="1" max="10" value="7" oninput="document.getElementById('ls-vsv').textContent=this.value"/></div>
            <div class="slider-grp"><div class="slider-lbl"><span>Love listening to lectures</span><span class="slider-val" id="ls-asv">4</span></div><input type="range" class="sl" id="ls-aud" min="1" max="10" value="4" oninput="document.getElementById('ls-asv').textContent=this.value"/></div>
            <div class="slider-grp"><div class="slider-lbl"><span>Take lots of written notes</span><span class="slider-val" id="ls-rsv">6</span></div><input type="range" class="sl" id="ls-rw" min="1" max="10" value="6" oninput="document.getElementById('ls-rsv').textContent=this.value"/></div>
            <div class="slider-grp"><div class="slider-lbl"><span>Prefer hands-on practice</span><span class="slider-val" id="ls-ksv">5</span></div><input type="range" class="sl" id="ls-kin" min="1" max="10" value="5" oninput="document.getElementById('ls-ksv').textContent=this.value"/></div>
            <button class="btn btn-p" style="width:100%;justify-content:center;margin-top:10px" onclick="detectStyle()">üß† Detect My Style</button>
          </div><div id="styleResult" style="display:flex;align-items:center;justify-content:center"><div style="text-align:center;color:var(--tx4);padding:52px"><div style="font-size:3.2rem;margin-bottom:12px">üé®</div><div style="font-size:.95rem">Rate your preferences to discover your learning style!</div></div></div></div>
        </div>
        <div class="ai-tool-panel" id="tool-topics">
          <div class="c-title" style="margin-bottom:18px">‚úÖ Topics You've Covered</div>
          <div id="topicCheckGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(235px,1fr));gap:11px;margin-bottom:24px"></div>
          <button class="btn btn-p" onclick="getTopicRecs()">‚ú® Get Recommendations</button>
          <div id="topicRecResult" style="margin-top:24px"></div>
        </div>
      </div>

      <!-- PERFORMANCE -->
      <div class="page" id="performancePage">
        <div class="page-title">Performance Analytics üìà</div><div class="page-sub">Track your academic progress, patterns, and weak areas</div>
        <div class="perf-stats" id="perfStats"></div>
        <div class="card" style="margin-bottom:18px"><div class="c-hd"><div class="c-title">Subject Progress</div></div><div id="subjBars"></div></div>
        <div class="card" style="margin-bottom:18px"><div class="c-hd"><div class="c-title">28-Day Activity Heatmap</div><div class="c-sub">Each cell = one day of activity</div></div><div class="hm-grid" id="heatmap"></div></div>

        <!-- NEW: PERFORMANCE INSIGHTS -->
        <div class="card" style="margin-bottom:18px">
          <div class="c-hd"><div class="c-title">üîç Performance Insights</div></div>
          <div id="perfInsights"></div>
        </div>

        <!-- NEW: STUDY TIME CHART AREA -->
        <div class="grid-2" style="margin-bottom:18px">
          <div class="card"><div class="c-hd"><div class="c-title">Task Priority Distribution</div></div><div style="position:relative;height:200px"><canvas id="perfPieChart"></canvas></div></div>
          <div class="card"><div class="c-hd"><div class="c-title">Completion Trend (4 Weeks)</div></div><div style="position:relative;height:200px"><canvas id="perfLineChart"></canvas></div></div>
        </div>

        <!-- QUIZ SUBJECT PERFORMANCE CHART -->
        <div class="card" style="margin-bottom:18px">
          <div class="c-hd"><div class="c-title">üìä Quiz Performance by Subject</div><div class="c-sub">Your average score per subject</div></div>
          <div style="position:relative;height:240px"><canvas id="quizSubjChart"></canvas></div>
        </div>

        <!-- DEPARTMENT RANK -->
        <div class="card" style="margin-bottom:18px">
          <div class="c-hd"><div class="c-title">üèÖ Department Performance Rank</div><div class="c-sub">How you compare in your department</div></div>
          <div id="deptRankCard"></div>
        </div>

        <div class="card"><div class="c-hd"><div class="c-title">Quiz History</div></div><div id="quizHistory"></div></div>
      </div>

      <!-- STREAKS -->
      <div class="page" id="streaksPage">
        <div class="page-title">Streaks & Goals üî•</div><div class="page-sub">Build daily habits and track your subject goals</div>

        <!-- NEW: STREAK RECORD BANNER -->
        <div class="streak-record" id="streakBanner">
          <div class="streak-flame">üî•</div>
          <div>
            <div style="font-family:var(--font-d);font-weight:900;font-size:1.2rem;color:var(--tx)" id="streakBannerVal">0 day streak</div>
            <div style="font-size:.85rem;color:var(--tx3)" id="streakBannerSub">Keep studying daily to build your streak!</div>
          </div>
        </div>

        <div class="grid-2" style="margin-bottom:24px">
          <div class="card">
            <div class="c-hd"><div class="c-title">üìÖ Study Calendar</div><div style="display:flex;align-items:center;gap:7px"><button class="ic-btn" onclick="calPrev()">‚Äπ</button><span style="font-size:.85rem;font-weight:800;color:var(--tx);min-width:110px;text-align:center" id="calMonthLbl"></span><button class="ic-btn" onclick="calNext()">‚Ä∫</button></div></div>
            <div class="cal-grid" id="calGrid"></div>
            <div style="display:flex;gap:16px;margin-top:16px;font-size:.76rem;color:var(--tx3)"><div style="display:flex;align-items:center;gap:5px"><div style="width:12px;height:12px;border-radius:3px;background:var(--acc);opacity:.5"></div>Studied</div><div style="display:flex;align-items:center;gap:5px"><div style="width:12px;height:12px;border-radius:3px;background:var(--acc);outline:2px solid var(--acc);outline-offset:1px"></div>Today</div></div>
          </div>
          <div class="card">
            <div class="c-hd"><div class="c-title">Streak Stats</div></div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:13px;margin-bottom:18px">
              <div class="ps"><div class="ps-v" id="curStreak">0</div><div class="ps-l">Current Streak üî•</div></div>
              <div class="ps"><div class="ps-v" id="bestStreak">0</div><div class="ps-l">Best Streak üèÜ</div></div>
              <div class="ps"><div class="ps-v" id="totalDays">0</div><div class="ps-l">Total Study Days üìö</div></div>
              <div class="ps"><div class="ps-v" id="thisWeek">0</div><div class="ps-l">This Week üìÖ</div></div>
            </div>
            <!-- NEW: STREAK MILESTONES -->
            <div style="margin-top:6px"><div style="font-size:.8rem;font-weight:800;color:var(--tx3);text-transform:uppercase;letter-spacing:1px;margin-bottom:11px">üèÖ Streak Milestones</div><div id="streakMilestones"></div></div>
          </div>
        </div>
        <div class="c-hd" style="margin-bottom:16px"><div class="c-title">üéØ Subject Goals</div><button class="btn btn-p btn-sm" onclick="openGoalModal()">+ Add Goal</button></div>
        <div class="goals-grid" id="goalsGrid"></div>

        <!-- NEW: WEEKLY PROGRESS -->
        <div class="card" style="margin-top:22px">
          <div class="c-hd"><div class="c-title">üìä Weekly Study Summary</div></div>
          <div id="weeklyStudySummary"></div>
        </div>
      </div>

      <!-- POMODORO -->
      <div class="page" id="pomodoroPage">
        <div class="page-title">Pomodoro Timer ‚è±Ô∏è</div><div class="page-sub">Work in focused sprints. Build your study habit.</div>
        <div class="pomo-wrap">
          <div class="pomo-modes">
            <button class="pomo-mode-btn active" onclick="setPomoPhase('focus',this)">üçÖ Focus (25m)</button>
            <button class="pomo-mode-btn" onclick="setPomoPhase('short',this)">‚òï Short (5m)</button>
            <button class="pomo-mode-btn" onclick="setPomoPhase('long',this)">üåø Long (15m)</button>
          </div>
          <div class="pomo-ring-w"><svg class="pomo-svg" viewBox="0 0 230 230" width="240" height="240"><circle class="pomo-track" cx="115" cy="115" r="100"/><circle class="pomo-fill" id="pomoFill" cx="115" cy="115" r="100"/></svg><div class="pomo-ctr"><div class="pomo-t" id="pomoTime">25:00</div><div class="pomo-m" id="pomoModeLabel">Focus Session</div></div></div>
          <div class="pomo-sessions-row" id="pomoSessRow"></div>
          <div class="pomo-ctrls">
            <button class="pomo-btn-sec" onclick="pomoSkip()" title="Skip">‚è≠</button>
            <button class="pomo-btn-main" id="pomoPlayBtn" onclick="pomoToggle()">‚ñ∂</button>
            <button class="pomo-btn-sec" onclick="pomoReset()" title="Reset">‚Ü∫</button>
          </div>
          <div class="pomo-stats">
            <div class="pomo-stat"><div class="pomo-stat-v" id="pomoStatSessions">0</div><div class="pomo-stat-l">Sessions</div></div>
            <div class="pomo-stat"><div class="pomo-stat-v" id="pomoStatTime">0m</div><div class="pomo-stat-l">Focused</div></div>
            <div class="pomo-stat"><div class="pomo-stat-v" id="pomoStatBreaks">0</div><div class="pomo-stat-l">Breaks</div></div>
          </div>
          <div class="task-select-card"><div class="c-title" style="margin-bottom:11px">Focus on Task</div><select class="form-sel" id="pomoTaskSel" style="font-size:.9rem"><option value="">‚Äî Select a task (optional) ‚Äî</option></select></div>

          <!-- NEW: POMODORO TIPS -->
          <div class="pomo-tips">
            <div class="pomo-tips-title">üß† Pomodoro Best Practices</div>
            <div class="pomo-tip-item"><span>‚è∞</span><span>Work for exactly 25 minutes with zero distractions ‚Äî no phone, no social media.</span></div>
            <div class="pomo-tip-item"><span>‚òï</span><span>During breaks, stand up, stretch, or grab water. Don't look at screens.</span></div>
            <div class="pomo-tip-item"><span>üìã</span><span>Before each session, write down exactly what you will accomplish.</span></div>
            <div class="pomo-tip-item"><span>üéØ</span><span>After 4 pomodoros, take a longer 15‚Äì30 minute break to recharge.</span></div>
          </div>

          <!-- NEW: MUSIC WIDGET -->
          <div class="music-widget" style="margin-top:18px;border-radius:var(--r-lg)">
            <div class="music-title">üéµ Focus Music</div>
            <div class="music-track" id="musicTrack">Lo-Fi Study Beats</div>
            <div class="music-artist" id="musicArtist">ChilledCow ¬∑ 128 BPM</div>
            <div class="music-bar"><div class="music-prog" id="musicProg"></div></div>
            <div style="font-size:.7rem;opacity:.5;margin-bottom:16px;display:flex;justify-content:space-between"><span>1:24</span><span>3:45</span></div>
            <div class="music-controls">
              <button class="music-btn" onclick="prevTrack()">‚èÆ</button>
              <button class="music-btn main" id="musicPlayBtn" onclick="toggleMusic()">‚ñ∂</button>
              <button class="music-btn" onclick="nextTrack()">‚è≠</button>
            </div>
          </div>
        </div>
      </div>

      <!-- ADD TASK -->
      <div class="page" id="addPage">
        <div class="page-title">Add New Task</div><div class="page-sub">Create a new assignment, project, or study task</div>
        <div class="add-form card">
          <div class="form-grp"><label class="form-lbl">Task Title *</label><input type="text" id="tTitle" class="form-inp" placeholder="e.g. Complete Calculus Assignment"/><div class="form-err" id="tTitleErr">Title is required.</div></div>
          <div class="form-row">
            <div class="form-grp"><label class="form-lbl">Subject</label><input type="text" id="tSubject" class="form-inp" placeholder="e.g. Mathematics" list="subjectList"/><datalist id="subjectList"><option>Mathematics</option><option>Physics</option><option>Computer Science</option><option>Chemistry</option><option>Biology</option><option>English</option></datalist></div>
            <div class="form-grp"><label class="form-lbl">Due Date</label><input type="date" id="tDue" class="form-inp"/></div>
          </div>
          <div class="form-grp"><label class="form-lbl">Priority</label><div class="prio-sel"><div class="prio-opt sel-h" data-p="high" onclick="selPrio('high')">üî¥ High</div><div class="prio-opt" data-p="medium" onclick="selPrio('medium')">üü° Medium</div><div class="prio-opt" data-p="low" onclick="selPrio('low')">üü¢ Low</div></div></div>
          <div class="form-row">
            <div class="form-grp"><label class="form-lbl">Status</label><select id="tStatus" class="form-sel"><option value="pending">Pending</option><option value="in-progress">In Progress</option><option value="completed">Completed</option></select></div>
            <div class="form-grp"><label class="form-lbl">Estimated Hours</label><input type="number" id="tHours" class="form-inp" placeholder="e.g. 2" min="0.5" max="20" step="0.5"/></div>
          </div>
          <div class="form-grp"><label class="form-lbl">Notes</label><textarea id="tNotes" class="form-ta" placeholder="Additional details or study notes..."></textarea></div>
          <div style="display:flex;gap:11px;margin-top:8px"><button class="btn btn-p" onclick="submitTask()">Add Task ‚Üí</button><button class="btn btn-g" onclick="resetAddForm()">Reset</button></div>
        </div>
      </div>

      <!-- GAMIFY -->
      <div class="page" id="gamifyPage">
        <div class="page-title">Achievements üèÜ</div><div class="page-sub">Level up your studies ‚Äî earn XP, unlock badges, climb the leaderboard</div>
        <div class="card" style="margin-bottom:24px;background:linear-gradient(135deg,var(--acc),var(--purple));border:none;color:#fff">
          <div style="display:flex;align-items:center;gap:24px;flex-wrap:wrap">
            <div style="width:80px;height:80px;border-radius:24px;background:rgba(255,255,255,.15);display:flex;flex-direction:column;align-items:center;justify-content:center;flex-shrink:0;box-shadow:0 4px 22px rgba(0,0,0,.2)"><div style="font-size:2.2rem;line-height:1" id="gLevelEmoji">üå±</div><div style="font-size:.55rem;font-weight:800;letter-spacing:1px;opacity:.75;margin-top:4px">LVL <span id="gLevelNum">1</span></div></div>
            <div style="flex:1;min-width:160px">
              <div style="font-family:var(--font-d);font-weight:900;font-size:1.5rem;margin-bottom:4px" id="gLevelName">Seedling</div>
              <div style="font-size:.88rem;opacity:.8;margin-bottom:13px"><span id="gXP">0</span> XP earned</div>
              <div style="height:12px;background:rgba(255,255,255,.25);border-radius:6px;overflow:hidden"><div id="gXPBar" style="height:100%;background:#fff;border-radius:6px;transition:width .9s ease;width:0%"></div></div>
              <div style="font-size:.76rem;opacity:.7;margin-top:7px" id="gXPNext">0 XP to next level</div>
            </div>
            <div style="text-align:center;padding:0 12px"><div style="font-family:var(--font-d);font-weight:900;font-size:2.8rem;line-height:1" id="gTotalXP">0</div><div style="font-size:.72rem;opacity:.7;margin-top:4px">TOTAL XP</div></div>
          </div>
        </div>
        <div class="grid-3" style="margin-bottom:24px" id="xpSources"></div>

        <!-- NEW: XP HISTORY -->
        <div class="card" style="margin-bottom:24px">
          <div class="c-hd"><div class="c-title">‚ö° How to Earn XP</div></div>
          <div id="xpSourcesDetailed"></div>
        </div>

        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:18px"><div class="c-title">üéñÔ∏è Badges & Achievements</div><div style="font-size:.82rem;color:var(--tx3);font-weight:800" id="badgeCount">0/0 unlocked</div></div>
        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(168px,1fr));gap:13px;margin-bottom:28px" id="badgesGrid"></div>
        <div class="c-title" style="margin-bottom:18px">üèÖ Leaderboard</div>
        <div class="card" id="leaderboard"></div>
      </div>

      <!-- DAILY CHALLENGE -->
      <div class="page" id="dailyPage">
        <div class="page-title">Daily Challenge ‚ö°</div><div class="page-sub">Complete today's challenge ‚Äî earn bonus XP!</div>
        <div style="max-width:680px">
          <div class="card" style="margin-bottom:18px;border:2px solid var(--acc);background:linear-gradient(135deg,var(--acc-bg),var(--purple-bg))">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;flex-wrap:wrap;gap:9px">
              <div><div class="c-title">Today's Challenge</div><div class="c-sub" id="dailyDate">Loading...</div></div>
              <div style="text-align:right;padding:11px 18px;background:var(--surface);border-radius:var(--r);border:1px solid var(--border)"><div style="font-family:var(--font-d);font-weight:900;font-size:1.6rem;color:var(--acc)">+<span id="dailyXP">50</span></div><div style="font-size:.65rem;color:var(--tx3);font-weight:800;letter-spacing:1px">BONUS XP</div></div>
            </div>
            <div id="dailyChallengeArea"></div>
          </div>

          <!-- NEW: WORD OF THE DAY -->
          <div class="wotd-card">
            <div class="wotd-label">üìñ Word of the Day</div>
            <div class="wotd-word" id="wotdWord">Ephemeral</div>
            <div class="wotd-pos" id="wotdPos">adjective</div>
            <div class="wotd-def" id="wotdDef">Lasting for a very short time; transitory. "The ephemeral pleasures of youth gave way to lasting wisdom."</div>
          </div>

          <!-- NEW: SCIENCE FACT -->
          <div class="fact-card">
            <div class="fact-icon" id="factIcon">üî¨</div>
            <div>
              <div class="fact-title">Did You Know?</div>
              <div class="fact-text" id="factText">Loading an interesting fact...</div>
            </div>
          </div>

          <div class="card" style="margin-bottom:18px"><div class="c-title" style="margin-bottom:18px">üìã Tasks Due Today</div><div id="dailyTasks"></div></div>
          <div class="card" style="background:var(--surface2)"><div class="c-title" style="margin-bottom:12px">üí° Study Tip of the Day</div><div id="dailyTip" style="font-size:.93rem;color:var(--tx2);line-height:1.8;font-style:italic"></div></div>
        </div>
      </div>

      <!-- FLASHCARDS -->
      <div class="page" id="flashcardsPage">
        <div class="page-title">Flashcards üÉè</div><div class="page-sub">Create decks, flip cards, master concepts with spaced repetition</div>
        <div style="display:flex;align-items:center;gap:11px;margin-bottom:24px;flex-wrap:wrap">
          <button class="btn btn-p" onclick="openFlashcardAdd()">+ New Card</button>
          <button class="btn btn-g" onclick="startFlashcardReview()" id="reviewBtn">‚ñ∂ Start Review</button>
          <div style="margin-left:auto;font-size:.88rem;color:var(--tx3)"><b id="fcTotal">0</b> cards ¬∑ <b id="fcDue" style="color:var(--acc)">0</b> due</div>
        </div>
        <div class="fc-add-form" id="fcAddForm">
          <div class="c-title" style="margin-bottom:18px">Create New Flashcard</div>
          <div class="form-grp"><label class="form-lbl">Subject</label><select class="form-sel" id="fcSubj"><option value="General">General</option><option>Mathematics</option><option>Physics</option><option>Computer Science</option><option>Chemistry</option><option>Biology</option><option>English</option></select></div>
          <div class="form-grp"><label class="form-lbl">Question / Front</label><textarea class="form-ta" id="fcFrontInp" placeholder="e.g. What is Newton's 2nd Law?" style="min-height:85px"></textarea></div>
          <div class="form-grp"><label class="form-lbl">Answer / Back</label><textarea class="form-ta" id="fcBackInp" placeholder="e.g. F = ma (Force = mass √ó acceleration)" style="min-height:85px"></textarea></div>
          <div style="display:flex;gap:11px"><button class="btn btn-p" onclick="saveFlashcard()">Save Card</button><button class="btn btn-g" onclick="document.getElementById('fcAddForm').classList.remove('show')">Cancel</button></div>
        </div>
        <div id="fcReviewArea" style="display:none;max-width:580px;margin-bottom:24px">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
            <div style="font-size:.88rem;font-weight:800;color:var(--tx3)" id="fcProgress">Card 1/0</div>
            <button class="btn btn-g btn-sm" onclick="endReview()">End Review</button>
          </div>
          <div style="height:8px;background:var(--surface2);border-radius:4px;margin-bottom:20px;overflow:hidden"><div id="fcProgBar" style="height:100%;background:var(--acc);border-radius:4px;transition:width .45s;width:0%"></div></div>
          <div id="fcCard" onclick="flipCard()" style="margin-bottom:18px">
            <div id="fcCardInner">
              <div id="fcFront" style="background:var(--surface);border:2px solid var(--acc);border-radius:var(--r-lg);padding:36px;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;min-height:230px">
                <div style="font-size:.68rem;font-weight:900;color:var(--acc);letter-spacing:2px;text-transform:uppercase;margin-bottom:16px">‚ùì QUESTION</div>
                <div style="font-family:var(--font-d);font-size:1.2rem;font-weight:700;color:var(--tx);line-height:1.55" id="fcFrontText">‚Äî</div>
                <div style="font-size:.76rem;color:var(--tx4);margin-top:20px">üëÜ Tap to reveal answer</div>
              </div>
              <div id="fcBack" style="background:linear-gradient(135deg,var(--acc-bg),var(--purple-bg));border:2px solid var(--acc);border-radius:var(--r-lg);padding:36px;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;min-height:230px">
                <div style="font-size:.68rem;font-weight:900;color:var(--purple);letter-spacing:2px;text-transform:uppercase;margin-bottom:16px">‚úÖ ANSWER</div>
                <div style="font-family:var(--font-d);font-size:1.2rem;font-weight:700;color:var(--tx);line-height:1.55" id="fcBackText">‚Äî</div>
              </div>
            </div>
          </div>
          <div id="fcRatingBtns" style="display:none;flex-wrap:wrap;justify-content:center;gap:11px">
            <button class="btn btn-sm btn-r" onclick="rateCard(1)" style="flex:1;justify-content:center;min-width:80px">üòï Hard<span style="font-size:.72rem;opacity:.8"> +5</span></button>
            <button class="btn btn-sm" style="background:var(--amber-bg);color:var(--amber);border:1px solid var(--amber-border);flex:1;justify-content:center;min-width:80px" onclick="rateCard(2)">üòê OK<span style="font-size:.72rem;opacity:.8"> +10</span></button>
            <button class="btn btn-sm" style="background:var(--green-bg);color:var(--green);border:1px solid var(--green-border);flex:1;justify-content:center;min-width:80px" onclick="rateCard(3)">üòä Easy<span style="font-size:.72rem;opacity:.8"> +15</span></button>
          </div>
        </div>
        <div id="fcListArea"><div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(278px,1fr));gap:14px" id="fcGrid"></div></div>
      </div>

      <!-- ACCOUNT -->
      <div class="page" id="accountPage">
        <div class="page-title">Account Settings ‚öôÔ∏è</div><div class="page-sub">Manage your profile, preferences, and data</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:18px;max-width:860px">
          <div class="card" style="grid-column:1/-1">
            <div style="display:flex;align-items:center;gap:24px;flex-wrap:wrap">
              <div style="width:80px;height:80px;border-radius:24px;background:linear-gradient(135deg,var(--acc),var(--purple));display:flex;align-items:center;justify-content:center;font-family:var(--font-d);font-weight:900;font-size:2.2rem;color:#fff;flex-shrink:0;cursor:pointer;position:relative" id="accAvatar" onclick="openAvatarModal()" title="Click to customize avatar">?<div style="position:absolute;bottom:-4px;right:-4px;width:22px;height:22px;border-radius:7px;background:var(--acc);display:flex;align-items:center;justify-content:center;font-size:.7rem;border:2px solid var(--surface)">‚úèÔ∏è</div></div>
              <div style="flex:1;min-width:0"><div style="font-family:var(--font-d);font-weight:900;font-size:1.4rem;color:var(--tx)" id="accName">‚Äî</div><div style="font-size:.9rem;color:var(--tx3);margin-top:3px" id="accEmail">‚Äî</div><div style="display:flex;align-items:center;gap:9px;margin-top:8px"><span class="pill pi" id="accGrade">Student</span><span style="font-size:.76rem;color:var(--tx4)" id="accJoined">‚Äî</span></div></div>
            </div>
          </div>
          <div class="card"><div class="c-title" style="margin-bottom:20px">‚úèÔ∏è Edit Profile</div><div class="form-grp"><label class="form-lbl">Full Name</label><input type="text" id="accNameInp" class="form-inp" placeholder="Your name"/></div><div class="form-grp"><label class="form-lbl">Department / Branch</label><select id="accDeptInp" class="form-sel"><option value="">Select Department</option><option value="AI_DS">ü§ñ AI & Data Science</option><option value="AI_ML">üß† AI & Machine Learning</option><option value="CSE">üíª Computer Science (CSE)</option><option value="IT">üåê Information Technology (IT)</option><option value="ECE">üì° Electronics & Communication (ECE)</option><option value="EEE">‚ö° Electrical Engineering (EEE)</option><option value="MECH">‚öôÔ∏è Mechanical Engineering</option><option value="CIVIL">üèóÔ∏è Civil Engineering</option><option value="MBA">üíº MBA / Business</option><option value="BCA">üñ•Ô∏è BCA / MCA</option><option value="OTHER">üìö Other</option></select></div><div class="form-grp"><label class="form-lbl">Year / Grade</label><select id="accGradeInp" class="form-sel"><option value="">Select grade</option><option>1st Year</option><option>2nd Year</option><option>3rd Year</option><option>4th Year</option><option>Class 9</option><option>Class 10</option><option>Class 11</option><option>Class 12</option><option>Postgraduate</option><option>Other</option></select></div><button class="btn btn-p" style="width:100%;justify-content:center" onclick="saveProfile()">üíæ Save Profile</button></div>
          <div class="card"><div class="c-title" style="margin-bottom:20px">üîí Change Password</div><div class="form-grp"><label class="form-lbl">Current Password</label><input type="password" id="accOldPass" class="form-inp" placeholder="Current password"/><div class="form-err" id="accOldErr">Incorrect password.</div></div><div class="form-grp"><label class="form-lbl">New Password</label><input type="password" id="accNewPass" class="form-inp" placeholder="Min 4 characters"/></div><div class="form-grp"><label class="form-lbl">Confirm New</label><input type="password" id="accConfPass" class="form-inp" placeholder="Repeat new password"/><div class="form-err" id="accConfErr">Passwords do not match.</div></div><button class="btn btn-p" style="width:100%;justify-content:center" onclick="changePassword()">üîë Update Password</button></div>
          <div class="card"><div class="c-title" style="margin-bottom:20px">üé® Preferences</div><div style="display:flex;align-items:center;justify-content:space-between;padding:11px 0;border-bottom:1px solid var(--border)"><div><div style="font-size:.9rem;font-weight:700;color:var(--tx)">Dark Mode</div><div style="font-size:.76rem;color:var(--tx3)">Toggle light / dark theme</div></div><div class="toggle-sw" id="themeSwitch" onclick="toggleThemeFromAcc()"><div class="toggle-knob"></div></div></div><div style="padding:11px 0"><div style="font-size:.9rem;font-weight:700;color:var(--tx);margin-bottom:8px">Pomodoro Focus Duration</div><div style="display:flex;gap:9px"><button class="fc" id="p20" onclick="setPomoDefault(20,this)">20 min</button><button class="fc active" id="p25" onclick="setPomoDefault(25,this)">25 min</button><button class="fc" id="p30" onclick="setPomoDefault(30,this)">30 min</button><button class="fc" id="p45" onclick="setPomoDefault(45,this)">45 min</button></div></div></div>
          <div class="card"><div class="c-title" style="margin-bottom:20px">üìä Your Stats</div><div id="accStats" style="display:flex;flex-direction:column;gap:11px"></div></div>
          <div class="card" style="grid-column:1/-1;border-color:var(--red-border);background:var(--red-bg)"><div class="c-title" style="margin-bottom:9px;color:var(--red)">‚ö†Ô∏è Danger Zone</div><div style="font-size:.88rem;color:var(--tx3);margin-bottom:18px">These actions are permanent and cannot be undone.</div><div style="display:flex;gap:11px;flex-wrap:wrap"><button class="btn btn-r" onclick="clearAllData()">üóëÔ∏è Clear All My Data</button><button class="btn btn-r" onclick="handleLogout()">üö™ Sign Out</button>
<button class="btn btn-g" onclick="startOnboarding()">üéØ Restart Tour</button></div></div>
        </div>
      </div>
      <!-- TIMETABLE PAGE -->
<div class="page" id="timetablePage">
  <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:14px;margin-bottom:6px">
    <div>
      <div class="page-title">Timetable Builder üóìÔ∏è</div>
      <div class="page-sub">Plan your weekly study schedule with drag & drop</div>
    </div>
    <div style="display:flex;gap:9px;flex-wrap:wrap">
      <button class="btn btn-g" onclick="clearTimetable()">üóëÔ∏è Clear All</button>
      <button class="btn btn-p" onclick="openAddBlockModal()">+ Add Block</button>
    </div>
  </div>

  <!-- SUBJECT COLOR LEGEND -->
  <div class="card" style="margin-bottom:16px">
    <div class="c-hd">
      <div class="c-title">üé® Subject Colors</div>
      <button class="btn btn-sm btn-g" onclick="openColorManager()">Manage ‚Üí</button>
    </div>
    <div class="tt-legend" id="ttLegend"></div>
  </div>

  <!-- STATS ROW -->
  <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:11px;margin-bottom:16px" id="ttStats"></div>

  <!-- TIMETABLE GRID -->
  <div class="card" style="overflow-x:auto;padding:16px">
    <div style="min-width:600px">
      <div class="tt-grid" id="ttGrid"></div>
    </div>
  </div>

  <!-- WEEK SUMMARY -->
  <div class="card" style="margin-top:16px">
    <div class="c-title" style="margin-bottom:14px">üìä Weekly Study Summary</div>
    <div id="ttSummary"></div>
  </div>
</div>

<!-- ADD BLOCK MODAL -->
<div class="modal-ov" id="addBlockModal" onclick="if(event.target===this)closeModal('addBlockModal')">
  <div class="modal-box" style="max-width:440px">
    <div class="modal-hd">
      <div class="modal-title">Add Study Block</div>
      <button class="modal-cls" onclick="closeModal('addBlockModal')">‚úï</button>
    </div>
    <div class="form-grp">
      <label class="form-lbl">Subject</label>
      <input type="text" id="ttSubj" class="form-inp" placeholder="e.g. Mathematics" list="subjectList"/>
    </div>
    <div class="form-grp">
      <label class="form-lbl">Topic (optional)</label>
      <input type="text" id="ttTopic" class="form-inp" placeholder="e.g. Calculus Chapter 3"/>
    </div>
    <div class="form-row">
      <div class="form-grp">
        <label class="form-lbl">Day</label>
        <select id="ttDay" class="form-sel">
          <option value="0">Monday</option>
          <option value="1">Tuesday</option>
          <option value="2">Wednesday</option>
          <option value="3">Thursday</option>
          <option value="4">Friday</option>
          <option value="5">Saturday</option>
          <option value="6">Sunday</option>
        </select>
      </div>
      <div class="form-grp">
        <label class="form-lbl">Time Slot</label>
        <select id="ttSlot" class="form-sel"></select>
      </div>
    </div>
    <div class="form-grp">
      <label class="form-lbl">Duration</label>
      <select id="ttDur" class="form-sel">
        <option value="1">1 slot (1 hour)</option>
        <option value="2">2 slots (2 hours)</option>
        <option value="3">3 slots (3 hours)</option>
      </select>
    </div>
    <div class="form-grp">
      <label class="form-lbl">Color</label>
      <div style="display:flex;gap:8px;flex-wrap:wrap" id="ttColorPicker"></div>
    </div>
    <button class="btn btn-p" style="width:100%;justify-content:center;margin-top:6px" onclick="saveBlock()">Add Block</button>
  </div>
</div>
<!-- FRIENDS PAGE -->
<div class="page" id="friendsPage">
  <div class="page-title">Friends & Social üë•</div>
  <div class="page-sub">Connect with friends, share codes, challenge each other!</div>

  <!-- MY PROFILE CARD -->
  <div style="background:linear-gradient(135deg,var(--acc),var(--purple));border-radius:var(--r-xl);padding:28px;color:#fff;margin-bottom:18px;position:relative;overflow:hidden">
    <div style="position:absolute;right:-30px;top:-30px;width:140px;height:140px;background:rgba(255,255,255,.06);border-radius:50%"></div>
    <div style="display:flex;align-items:center;gap:18px;flex-wrap:wrap;position:relative;z-index:1">
      <div style="width:70px;height:70px;border-radius:22px;background:rgba(255,255,255,.2);display:flex;align-items:center;justify-content:center;font-size:2rem;font-weight:900;flex-shrink:0" id="friendMyAv">?</div>
      <div style="flex:1">
        <div style="font-size:1.2rem;font-weight:900;margin-bottom:4px" id="friendMyName">‚Äî</div>
        <div style="opacity:.8;font-size:.85rem;margin-bottom:10px" id="friendMyLevel">Level 1</div>
        <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
          <div style="background:rgba(255,255,255,.15);border-radius:var(--r-sm);padding:8px 16px">
            <div style="font-size:.65rem;opacity:.7;letter-spacing:1.5px;text-transform:uppercase;margin-bottom:3px">My Friend Code</div>
            <div style="font-family:var(--font-mono);font-size:1.1rem;font-weight:900;letter-spacing:3px" id="myFriendCode">‚Äî‚Äî</div>
          </div>
          <button onclick="copyFriendCode()" style="padding:10px 18px;border-radius:var(--r-sm);border:1.5px solid rgba(255,255,255,.3);background:transparent;color:#fff;font-weight:700;font-size:.85rem;cursor:pointer">üìã Copy Code</button>
          <button onclick="shareFriendCode()" style="padding:10px 18px;border-radius:var(--r-sm);border:none;background:rgba(255,255,255,.2);color:#fff;font-weight:700;font-size:.85rem;cursor:pointer">üîó Share</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ADD FRIEND -->
  <div class="card" style="margin-bottom:18px">
    <div class="c-title" style="margin-bottom:14px">‚ûï Add Friend</div>
    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <input type="text" id="friendCodeInp" class="form-inp" placeholder="Enter friend code (e.g. SBP-XXXX)" style="flex:1;min-width:200px;font-family:var(--font-mono);letter-spacing:2px;text-transform:uppercase"/>
      <button class="btn btn-p" onclick="addFriend()">Add Friend ‚Üí</button>
    </div>
    <div style="font-size:.78rem;color:var(--tx3);margin-top:8px">Share your code with friends ‚Äî they can add you using this code!</div>
  </div>

  <!-- FRIENDS LIST + LEADERBOARD -->
  <div class="grid-2" style="margin-bottom:18px">
    <div class="card">
      <div class="c-hd">
        <div><div class="c-title">üë• My Friends</div><div id="friendCount" class="c-sub">0 friends</div></div>
        <button class="btn btn-sm btn-g" onclick="renderFriends()">‚Ü∫</button>
      </div>
      <div id="friendsList"></div>
    </div>
    <div class="card">
      <div class="c-hd"><div class="c-title">üèÜ Friends Leaderboard</div></div>
      <div id="friendsLeaderboard"></div>
    </div>
  </div>

  <!-- QUIZ BATTLE -->
  <div class="card" style="margin-bottom:18px;border:1.5px solid rgba(61,90,254,.25);background:linear-gradient(135deg,var(--acc-bg),var(--purple-bg))">
    <div class="c-hd">
      <div><div class="c-title">‚öîÔ∏è Quiz Battle</div><div class="c-sub">Challenge a friend to a subject quiz!</div></div>
    </div>
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:13px;margin-bottom:16px">
      <div class="form-grp" style="margin:0">
        <label class="form-lbl">Select Subject</label>
        <select id="battleSubj" class="form-sel">
          <option>Mathematics</option>
          <option>Physics</option>
          <option>Computer Science</option>
          <option>Chemistry</option>
          <option>Biology</option>
          <option>English</option>
        </select>
      </div>
      <div class="form-grp" style="margin:0">
        <label class="form-lbl">Challenge Friend</label>
        <select id="battleFriend" class="form-sel"><option value="">Select friend...</option></select>
      </div>
    </div>
    <button class="btn btn-p" onclick="sendBattleChallenge()">‚öîÔ∏è Send Challenge!</button>
    <div id="battleArea" style="margin-top:16px"></div>
  </div>

  <!-- PENDING CHALLENGES -->
  <div class="card">
    <div class="c-hd"><div class="c-title">üì® Pending Challenges</div></div>
    <div id="pendingChallenges"></div>
  </div>
</div>

      <!-- SMART REMINDERS PAGE -->
<div class="page" id="remindersPage">
  <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:14px;margin-bottom:6px">
    <div>
      <div class="page-title">Smart Reminders üîî</div>
      <div class="page-sub">Stay on top of deadlines, streaks & study goals</div>
    </div>
    <button class="btn btn-p" onclick="openAddReminderModal()">+ New Reminder</button>
  </div>

  <!-- PERMISSION BANNER -->
  <div id="notifPermBanner" style="display:none;background:linear-gradient(135deg,var(--acc-bg),var(--purple-bg));border:1.5px solid rgba(61,90,254,.25);border-radius:var(--r);padding:18px 22px;margin-bottom:20px;align-items:center;gap:16px;flex-wrap:wrap">
    <div style="font-size:1.8rem">üîî</div>
    <div style="flex:1">
      <div style="font-weight:800;font-size:.95rem;color:var(--tx);margin-bottom:3px">Enable Browser Notifications</div>
      <div style="font-size:.84rem;color:var(--tx3)">Get notified about deadlines and study reminders even when the app is in background.</div>
    </div>
    <button class="btn btn-p btn-sm" onclick="requestNotifPermission()">Enable Now ‚Üí</button>
  </div>

  <!-- AUTO REMINDERS SECTION -->
  <div class="card" style="margin-bottom:18px">
    <div class="c-hd">
      <div><div class="c-title">‚ö° Auto Smart Reminders</div><div class="c-sub">Automatically generated based on your tasks & habits</div></div>
      <button class="btn btn-sm btn-g" onclick="refreshAutoReminders()">‚Ü∫ Refresh</button>
    </div>
    <div id="autoRemindersGrid"></div>
  </div>

  <!-- CUSTOM REMINDERS -->
  <div class="card" style="margin-bottom:18px">
    <div class="c-hd">
      <div><div class="c-title">üìå My Custom Reminders</div></div>
      <div id="customReminderCount" style="font-size:.82rem;color:var(--tx3);font-weight:800"></div>
    </div>
    <div id="customRemindersGrid"></div>
  </div>

  <!-- REMINDER SETTINGS -->
  <div class="card" style="margin-bottom:18px">
    <div class="c-hd"><div class="c-title">‚öôÔ∏è Reminder Settings</div></div>
    <div style="display:flex;flex-direction:column;gap:0">

      <div style="display:flex;align-items:center;justify-content:space-between;padding:14px 0;border-bottom:1px solid var(--border)">
        <div>
          <div style="font-weight:700;font-size:.92rem;color:var(--tx)">Overdue Task Alerts</div>
          <div style="font-size:.78rem;color:var(--tx3)">Notify when tasks become overdue</div>
        </div>
        <div class="toggle-sw on" id="rm-overdue" onclick="toggleRmSetting('overdue',this)"><div class="toggle-knob"></div></div>
      </div>

      <div style="display:flex;align-items:center;justify-content:space-between;padding:14px 0;border-bottom:1px solid var(--border)">
        <div>
          <div style="font-weight:700;font-size:.92rem;color:var(--tx)">Streak Break Warning</div>
          <div style="font-size:.78rem;color:var(--tx3)">Alert when you haven't studied today</div>
        </div>
        <div class="toggle-sw on" id="rm-streak" onclick="toggleRmSetting('streak',this)"><div class="toggle-knob"></div></div>
      </div>

      <div style="display:flex;align-items:center;justify-content:space-between;padding:14px 0;border-bottom:1px solid var(--border)">
        <div>
          <div style="font-weight:700;font-size:.92rem;color:var(--tx)">Flashcard Due Reminder</div>
          <div style="font-size:.78rem;color:var(--tx3)">Remind when cards are due for review</div>
        </div>
        <div class="toggle-sw on" id="rm-flash" onclick="toggleRmSetting('flash',this)"><div class="toggle-knob"></div></div>
      </div>

      <div style="display:flex;align-items:center;justify-content:space-between;padding:14px 0;border-bottom:1px solid var(--border)">
        <div>
          <div style="font-weight:700;font-size:.92rem;color:var(--tx)">Daily Challenge Reminder</div>
          <div style="font-size:.78rem;color:var(--tx3)">Remind to complete daily challenge</div>
        </div>
        <div class="toggle-sw on" id="rm-daily" onclick="toggleRmSetting('daily',this)"><div class="toggle-knob"></div></div>
      </div>

      <div style="display:flex;align-items:center;justify-content:space-between;padding:14px 0">
        <div>
          <div style="font-weight:700;font-size:.92rem;color:var(--tx)">Deadline Approaching (24h)</div>
          <div style="font-size:.78rem;color:var(--tx3)">Alert 24 hours before task due date</div>
        </div>
        <div class="toggle-sw on" id="rm-deadline" onclick="toggleRmSetting('deadline',this)"><div class="toggle-knob"></div></div>
      </div>

    </div>
  </div>

  <!-- REMINDER HISTORY -->
  <div class="card">
    <div class="c-hd"><div class="c-title">üìã Reminder History</div><button class="btn btn-sm btn-r" onclick="clearReminderHistory()">Clear</button></div>
    <div id="reminderHistory"></div>
  </div>
</div>
<!-- STUDY GROUPS PAGE -->
<div class="page" id="studygroupsPage">
  <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:14px;margin-bottom:6px">
    <div>
      <div class="page-title">Study Groups üè´</div>
      <div class="page-sub">Join or create department study groups, share resources & collaborate</div>
    </div>
    <button class="btn btn-p" onclick="openCreateGroupModal()">+ Create Group</button>
  </div>

  <!-- DEPT GROUPS -->
  <div class="card" style="margin-bottom:18px;background:linear-gradient(135deg,var(--acc-bg),var(--purple-bg));border:1.5px solid rgba(61,90,254,.2)">
    <div class="c-hd"><div><div class="c-title">üéì Your Department Groups</div><div class="c-sub" id="deptGroupSub">Groups matching your department</div></div></div>
    <div id="deptGroupsList" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(270px,1fr));gap:13px;margin-top:4px"></div>
  </div>

  <!-- ALL GROUPS -->
  <div class="card" style="margin-bottom:18px">
    <div class="c-hd">
      <div class="c-title">üåê All Study Groups</div>
      <input type="text" class="form-inp" id="groupSearch" placeholder="Search groups..." style="max-width:200px;padding:7px 13px;font-size:.84rem" oninput="renderStudyGroups()"/>
    </div>
    <div id="allGroupsList"></div>
  </div>

  <!-- MY GROUPS -->
  <div class="card">
    <div class="c-hd"><div class="c-title">üìå My Groups</div></div>
    <div id="myGroupsList"></div>
  </div>
</div>

<!-- CREATE GROUP MODAL -->
<div class="modal-ov" id="createGroupModal" onclick="if(event.target===this)closeModal('createGroupModal')">
  <div class="modal-box" style="max-width:480px">
    <div class="modal-hd">
      <div class="modal-title">üè´ Create Study Group</div>
      <button class="modal-cls" onclick="closeModal('createGroupModal')">‚úï</button>
    </div>
    <div class="form-grp"><label class="form-lbl">Group Name *</label><input type="text" id="grpName" class="form-inp" placeholder="e.g. AI & DS Sem 4 Study Circle"/></div>
    <div class="form-grp"><label class="form-lbl">Department</label><select id="grpDept" class="form-sel">
      <option value="AI_DS">ü§ñ AI & Data Science</option>
      <option value="AI_ML">üß† AI & Machine Learning</option>
      <option value="CSE">üíª CSE</option>
      <option value="IT">üåê IT</option>
      <option value="ECE">üì° ECE</option>
      <option value="EEE">‚ö° EEE</option>
      <option value="MECH">‚öôÔ∏è Mechanical</option>
      <option value="CIVIL">üèóÔ∏è Civil</option>
      <option value="MBA">üíº MBA</option>
      <option value="BCA">üñ•Ô∏è BCA/MCA</option>
      <option value="OTHER">üìö General</option>
    </select></div>
    <div class="form-grp"><label class="form-lbl">Subject Focus</label><input type="text" id="grpSubject" class="form-inp" placeholder="e.g. Machine Learning, DBMS..."/></div>
    <div class="form-grp"><label class="form-lbl">Description</label><textarea id="grpDesc" class="form-ta" placeholder="What is this group about?" style="min-height:80px"></textarea></div>
    <div style="display:flex;gap:10px">
      <button class="btn btn-p" style="flex:1;justify-content:center" onclick="createStudyGroup()">üöÄ Create Group</button>
      <button class="btn btn-g" style="flex:1;justify-content:center" onclick="closeModal('createGroupModal')">Cancel</button>
    </div>
  </div>
</div>

<!-- GROUP CHAT MODAL -->
<div class="modal-ov" id="groupChatModal" onclick="if(event.target===this)closeModal('groupChatModal')">
  <div class="modal-box" style="max-width:560px;height:85vh;display:flex;flex-direction:column">
    <div class="modal-hd" style="flex-shrink:0">
      <div>
        <div class="modal-title" id="groupChatTitle">Group Chat</div>
        <div style="font-size:.8rem;color:var(--tx3)" id="groupChatSub"></div>
      </div>
      <button class="modal-cls" onclick="closeModal('groupChatModal')">‚úï</button>
    </div>
    <div id="groupChatMessages" style="flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:10px;background:var(--surface2);border-radius:var(--r-sm);margin-bottom:14px"></div>
    <div style="display:flex;gap:10px;flex-shrink:0">
      <input type="text" id="groupChatInput" class="form-inp" placeholder="Type a message..." style="flex:1" onkeydown="if(event.key==='Enter')sendGroupMessage()"/>
      <button class="btn btn-p" onclick="sendGroupMessage()">Send ‚Üí</button>
    </div>
  </div>
</div>

<!-- AVATAR CUSTOMIZER MODAL -->
<div class="modal-ov" id="avatarModal" onclick="if(event.target===this)closeModal('avatarModal')">
  <div class="modal-box" style="max-width:500px">
    <div class="modal-hd">
      <div class="modal-title">‚úèÔ∏è Customize Avatar</div>
      <button class="modal-cls" onclick="closeModal('avatarModal')">‚úï</button>
    </div>

    <!-- LIVE PREVIEW -->
    <div style="text-align:center;padding:18px 0 20px;border-bottom:1px solid var(--border);margin-bottom:20px">
      <div style="position:relative;display:inline-block;margin-bottom:8px">
        <div class="av-preview" id="avPreview" style="overflow:hidden"></div>
        <div onclick="document.getElementById('avPhotoInput').click()" title="Upload photo" style="position:absolute;bottom:-5px;right:-5px;width:26px;height:26px;border-radius:8px;background:var(--acc);display:flex;align-items:center;justify-content:center;font-size:.75rem;cursor:pointer;border:2px solid var(--surface);box-shadow:0 2px 8px rgba(0,0,0,.2)">üì∑</div>
      </div>
      <div style="font-size:.78rem;color:var(--tx3);font-weight:700" id="avPreviewName">Your Avatar</div>
    </div>

    <!-- HIDDEN FILE INPUT -->
    <input type="file" id="avPhotoInput" accept="image/*" style="display:none" onchange="handleAvatarPhoto(this)"/>

    <!-- TABS -->
    <div style="display:flex;gap:7px;margin-bottom:18px">
      <button class="av-tab" id="avTabPhoto" onclick="switchAvTab('photo')" style="flex:1;text-align:center">üì∑ Photo</button>
      <button class="av-tab active" id="avTabEmoji" onclick="switchAvTab('emoji')" style="flex:1;text-align:center">üòé Emoji</button>
      <button class="av-tab" id="avTabInitials" onclick="switchAvTab('initials')" style="flex:1;text-align:center">üî§ Text</button>
    </div>

    <!-- PHOTO PANEL -->
    <div id="avPhotoPanel" style="display:none">
      <!-- Upload zone (shown when no photo) -->
      <div id="avDropZone" style="border:2px dashed var(--border2);border-radius:var(--r-lg);padding:30px 20px;text-align:center;cursor:pointer;transition:all .2s;background:var(--surface2)"
        onclick="document.getElementById('avPhotoInput').click()"
        ondragover="event.preventDefault();this.style.borderColor='var(--acc)';this.style.background='var(--acc-bg)'"
        ondragleave="this.style.borderColor='var(--border2)';this.style.background='var(--surface2)'"
        ondrop="event.preventDefault();this.style.borderColor='var(--border2)';this.style.background='var(--surface2)';handleAvatarDrop(event)">
        <div style="font-size:2.6rem;margin-bottom:10px">üì∏</div>
        <div style="font-weight:800;font-size:.95rem;color:var(--tx);margin-bottom:6px">Upload your photo</div>
        <div style="font-size:.82rem;color:var(--tx3);margin-bottom:16px;line-height:1.6">Tap to choose from gallery<br>or drag &amp; drop here ¬∑ JPG, PNG, GIF</div>
        <button class="btn btn-p btn-sm" onclick="event.stopPropagation();document.getElementById('avPhotoInput').click()">üìÇ Choose Photo</button>
      </div>
      <!-- Photo preview (shown after upload) -->
      <div id="avPhotoPreviewRow" style="display:none">
        <div style="display:flex;align-items:center;gap:13px;background:var(--green-bg);border:1px solid var(--green-border);border-radius:var(--r);padding:14px 16px">
          <div id="avPhotoThumb" style="width:54px;height:54px;border-radius:13px;overflow:hidden;flex-shrink:0;background:var(--surface2)"></div>
          <div style="flex:1;min-width:0">
            <div style="font-weight:800;font-size:.9rem;color:var(--green);margin-bottom:3px">‚úÖ Photo ready!</div>
            <div style="font-size:.78rem;color:var(--tx3)" id="avPhotoFileName">photo.jpg</div>
          </div>
          <button class="ic-btn del" onclick="clearAvatarPhoto()" title="Remove">‚úï</button>
        </div>
      </div>
    </div>

    <!-- EMOJI PANEL -->
    <div id="avEmojiPanel">
      <div style="font-size:.72rem;font-weight:800;color:var(--tx3);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px">Choose Emoji</div>
      <div class="av-grid" id="avEmojiGrid"></div>
      <div style="font-size:.72rem;font-weight:800;color:var(--tx3);text-transform:uppercase;letter-spacing:1px;margin:16px 0 10px">Background Color</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap" id="avColorRowEmoji"></div>
    </div>

    <!-- INITIALS PANEL -->
    <div id="avInitialsPanel" style="display:none">
      <div style="font-size:.72rem;font-weight:800;color:var(--tx3);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px">Custom Text (max 2 chars)</div>
      <input type="text" id="avInitialsInp" class="form-inp" maxlength="2" placeholder="e.g. AB" style="text-transform:uppercase;font-size:1.3rem;font-weight:900;letter-spacing:8px;text-align:center;max-width:150px" oninput="updateAvPreview()"/>
      <div style="font-size:.72rem;font-weight:800;color:var(--tx3);text-transform:uppercase;letter-spacing:1px;margin:16px 0 10px">Background Color</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap" id="avColorRowInitials"></div>
    </div>

    <button class="btn btn-p" style="width:100%;justify-content:center;margin-top:22px;padding:14px;font-size:1rem" onclick="saveAvatarChanges()">üíæ Save Avatar</button>
  </div>
</div>

<!-- ADD REMINDER MODAL -->
<div class="modal-ov" id="addReminderModal" onclick="if(event.target===this)closeModal('addReminderModal')">
  <div class="modal-box" style="max-width:480px">
    <div class="modal-hd">
      <div class="modal-title">New Custom Reminder</div>
      <button class="modal-cls" onclick="closeModal('addReminderModal')">‚úï</button>
    </div>
    <div class="form-grp">
      <label class="form-lbl">Reminder Title</label>
      <input type="text" id="rm-title" class="form-inp" placeholder="e.g. Study Physics Chapter 5"/>
    </div>
    <div class="form-grp">
      <label class="form-lbl">Message</label>
      <textarea id="rm-msg" class="form-ta" style="min-height:75px" placeholder="e.g. Focus on wave equations and practice 10 problems"></textarea>
    </div>
    <div class="form-row">
      <div class="form-grp">
        <label class="form-lbl">Date</label>
        <input type="date" id="rm-date" class="form-inp"/>
      </div>
      <div class="form-grp">
        <label class="form-lbl">Time</label>
        <input type="time" id="rm-time" class="form-inp" value="08:00"/>
      </div>
    </div>
    <div class="form-grp">
      <label class="form-lbl">Type</label>
      <select id="rm-type" class="form-sel">
        <option value="study">üìö Study Reminder</option>
        <option value="deadline">‚è∞ Deadline Alert</option>
        <option value="quiz">üß† Quiz Reminder</option>
        <option value="break">‚òï Break Reminder</option>
        <option value="custom">üìå Custom</option>
      </select>
    </div>
    <div class="form-grp">
      <label class="form-lbl">Repeat</label>
      <select id="rm-repeat" class="form-sel">
        <option value="once">Once</option>
        <option value="daily">Daily</option>
        <option value="weekly">Weekly</option>
      </select>
    </div>
    <button class="btn btn-p" style="width:100%;justify-content:center;margin-top:6px" onclick="saveCustomReminder()">üîî Set Reminder</button>
  </div>
</div>

      <!-- PROGRESS REPORT PAGE -->
<div class="page" id="reportPage">
  <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:14px;margin-bottom:6px">
    <div>
      <div class="page-title">Progress Report üìä</div>
      <div class="page-sub">Your complete academic performance summary</div>
    </div>
    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <button class="btn btn-g" onclick="shareReport()">üîó Share</button>
      <button class="btn btn-p" onclick="downloadPDF()">‚¨áÔ∏è Download PDF</button>
    </div>
  </div>

  <!-- REPORT PERIOD SELECTOR -->
  <div style="display:flex;gap:9px;margin-bottom:22px;flex-wrap:wrap">
    <button class="fc active" id="rp-week" onclick="setReportPeriod('week',this)">This Week</button>
    <button class="fc" id="rp-month" onclick="setReportPeriod('month',this)">This Month</button>
    <button class="fc" id="rp-all" onclick="setReportPeriod('all',this)">All Time</button>
  </div>

  <!-- REPORT CARD ‚Äî PREVIEW (what PDF will look like) -->
  <div id="reportContent" style="max-width:860px">

    <!-- HEADER CARD -->
    <div style="background:linear-gradient(135deg,var(--acc),var(--purple));border-radius:var(--r-xl);padding:32px;color:#fff;margin-bottom:18px;position:relative;overflow:hidden">
      <div style="position:absolute;right:-40px;top:-40px;width:200px;height:200px;background:rgba(255,255,255,.06);border-radius:50%"></div>
      <div style="position:absolute;right:60px;bottom:-60px;width:160px;height:160px;background:rgba(255,255,255,.04);border-radius:50%"></div>
      <div style="position:relative;z-index:1;display:flex;align-items:center;gap:20px;flex-wrap:wrap">
        <div style="width:72px;height:72px;border-radius:22px;background:rgba(255,255,255,.15);display:flex;align-items:center;justify-content:center;font-size:2rem;font-weight:900;flex-shrink:0" id="rpAvatar">?</div>
        <div style="flex:1">
          <div style="font-size:1.4rem;font-weight:900;margin-bottom:4px" id="rpName">‚Äî</div>
          <div style="opacity:.8;font-size:.9rem;margin-bottom:8px" id="rpGrade">Student</div>
          <div style="font-size:.75rem;opacity:.65" id="rpDate">‚Äî</div>
        </div>
        <div style="text-align:right">
          <div style="font-size:3rem;font-weight:900;line-height:1" id="rpGradeLetter">‚Äî</div>
          <div style="font-size:.75rem;opacity:.7;margin-top:4px">OVERALL GRADE</div>
        </div>
      </div>
    </div>

    <!-- KPI SUMMARY ROW -->
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:10px;margin-bottom:18px" id="rpKPIRow"></div>

    <!-- CHARTS ROW -->
    <div class="grid-2" style="margin-bottom:18px">
      <div class="card">
        <div class="c-hd"><div class="c-title">üìã Task Completion</div></div>
        <div style="position:relative;height:200px"><canvas id="rpDonut"></canvas></div>
      </div>
      <div class="card">
        <div class="c-hd"><div class="c-title">üìÖ Daily Activity</div></div>
        <div style="position:relative;height:200px"><canvas id="rpLine"></canvas></div>
      </div>
    </div>

    <!-- SUBJECT PERFORMANCE -->
    <div class="card" style="margin-bottom:18px">
      <div class="c-hd"><div class="c-title">üìö Subject Performance</div></div>
      <div id="rpSubjects"></div>
    </div>

    <!-- QUIZ ANALYSIS -->
    <div class="card" style="margin-bottom:18px">
      <div class="c-hd"><div class="c-title">üß† Quiz Analysis</div></div>
      <div id="rpQuizAnalysis"></div>
    </div>

    <!-- STRENGTHS & WEAKNESSES -->
    <div class="grid-2" style="margin-bottom:18px">
      <div class="card" style="border:1.5px solid var(--green-border);background:var(--green-bg)">
        <div class="c-title" style="color:var(--green);margin-bottom:14px">üí™ Strengths</div>
        <div id="rpStrengths"></div>
      </div>
      <div class="card" style="border:1.5px solid var(--red-border);background:var(--red-bg)">
        <div class="c-title" style="color:var(--red);margin-bottom:14px">üìà Areas to Improve</div>
        <div id="rpWeaknesses"></div>
      </div>
    </div>

    <!-- STREAK & CONSISTENCY -->
    <div class="card" style="margin-bottom:18px">
      <div class="c-hd"><div class="c-title">üî• Consistency Report</div></div>
      <div id="rpConsistency"></div>
    </div>

    <!-- ACTIVITY HEATMAP -->
    <div class="card" style="margin-bottom:18px">
      <div class="c-hd"><div class="c-title">üìÜ 28-Day Activity Heatmap</div></div>
      <div class="hm-grid" id="rpHeatmap"></div>
    </div>

    <!-- RECOMMENDATIONS -->
    <div class="card" style="margin-bottom:18px;border:1.5px solid rgba(61,90,254,.25);background:var(--acc-bg)">
      <div class="c-title" style="margin-bottom:16px">‚ú® AI Recommendations</div>
      <div id="rpRecommendations"></div>
    </div>

    <!-- BADGES EARNED -->
    <div class="card" style="margin-bottom:18px">
      <div class="c-hd"><div class="c-title">üéñÔ∏è Badges Earned</div><span id="rpBadgeCount" style="font-size:.82rem;color:var(--tx3);font-weight:800"></span></div>
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:10px" id="rpBadges"></div>
    </div>

    <!-- FOOTER NOTE -->
    <div style="text-align:center;padding:20px;color:var(--tx4);font-size:.78rem;border-top:1px solid var(--border)">
      Generated by StudyBot Pro ¬∑ <span id="rpFooterDate"></span> ¬∑ Keep studying! üìö
    </div>

  </div>
</div>


<!-- EXAM SCHEDULE PAGE -->
<div class="page" id="examPage">
  <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:14px;margin-bottom:6px">
    <div><div class="page-title">üìÜ Exam Schedule</div><div class="page-sub">Track your upcoming exams, internal marks, and semester schedule</div></div>
    <button class="btn btn-p" onclick="openAddExamModal()">+ Add Exam</button>
  </div>

  <!-- SEMESTER STATUS BAR -->
  <div id="semStatusBar" style="margin-bottom:18px"></div>

  <!-- MARKS SUMMARY -->
  <div id="marksSummary" style="margin-bottom:18px;display:none"></div>

  <!-- UPCOMING EXAMS TIMELINE -->
  <div class="card" style="margin-bottom:18px">
    <div class="c-hd"><div class="c-title">‚è∞ Upcoming Exams</div><div class="c-sub">Sorted by date</div></div>
    <div id="upcomingExamsList"></div>
  </div>

  <!-- INTERNAL MARKS TRACKER -->
  <div class="card" style="margin-bottom:18px">
    <div class="c-hd"><div class="c-title">üìù Internal Assessment Tracker</div><div class="c-sub">Track your CA/IA marks per subject</div></div>
    <div id="internalMarksList"></div>
    <button class="btn btn-sm btn-g" style="margin-top:12px" onclick="openAddMarkModal()">+ Add Assessment</button>
  </div>

  <!-- EXAM HISTORY -->
  <div class="card">
    <div class="c-hd"><div class="c-title">üìö Past Exams</div></div>
    <div id="pastExamsList"></div>
  </div>
</div>

<!-- DEPT LEADERBOARD PAGE -->
<div class="page" id="deptLeaderPage">
  <div class="page-title">üèÜ Department Leaderboard</div>
  <div class="page-sub">See how you rank among your department classmates</div>

  <!-- MY RANK BANNER -->
  <div id="myRankBanner"></div>

  <!-- PODIUM -->
  <div class="card" style="margin-bottom:18px;padding:20px 12px 10px">
    <div class="c-hd" style="margin-bottom:14px">
      <div class="c-title">üèÖ Top 3 Podium</div>
      <select class="form-sel" id="deptLeaderFilter" style="width:auto;min-width:150px" onchange="renderDeptLeader()">
        <option value="xp">üî• XP Score</option>
        <option value="quiz">üß† Quiz Avg</option>
        <option value="tasks">‚úÖ Tasks Done</option>
        <option value="streak">üìÖ Streak</option>
      </select>
    </div>
    <div id="deptPodium"></div>
  </div>

  <!-- FULL RANKINGS -->
  <div class="card" style="margin-bottom:18px">
    <div class="c-hd">
      <div class="c-title" id="deptLeaderTitle">Rankings</div>
    </div>
    <div id="deptLeaderList"></div>
  </div>

  <!-- YOU vs DEPT AVG RADAR -->
  <div class="card">
    <div class="c-hd"><div class="c-title">üìä You vs Department Average</div><div class="c-sub">Normalised across 4 metrics</div></div>
    <div style="position:relative;height:280px"><canvas id="deptRadarChart"></canvas></div>
  </div>
</div>

    </main>
  </div>
</div>

<!-- ADD EXAM MODAL -->
<div class="modal-ov" id="addExamModal" onclick="if(event.target===this)closeModal('addExamModal')">
  <div class="modal-box" style="max-width:500px">
    <div class="modal-hd">
      <div class="modal-title">üìÜ Add Exam</div>
      <button class="modal-cls" onclick="closeModal('addExamModal')">‚úï</button>
    </div>
    <div class="form-grp"><label class="form-lbl">Subject *</label>
      <input type="text" id="examSubj" class="form-inp" placeholder="e.g. Data Structures, Machine Learning"/>
    </div>
    <div class="form-row">
      <div class="form-grp"><label class="form-lbl">Exam Date *</label><input type="date" id="examDate" class="form-inp"/></div>
      <div class="form-grp"><label class="form-lbl">Time</label><input type="time" id="examTime" class="form-inp"/></div>
    </div>
    <div class="form-row">
      <div class="form-grp"><label class="form-lbl">Exam Type</label>
        <select id="examType" class="form-sel">
          <option value="internal">üìù Internal / CA</option>
          <option value="external">üìã End Semester / Final</option>
          <option value="lab">üî¨ Lab Practical</option>
          <option value="viva">üé§ Viva / Oral</option>
          <option value="quiz">‚ö° Class Quiz</option>
          <option value="assignment">üìå Assignment</option>
        </select>
      </div>
      <div class="form-grp"><label class="form-lbl">Max Marks</label><input type="number" id="examMax" class="form-inp" value="100" min="1"/></div>
    </div>
    <div class="form-grp"><label class="form-lbl">Hall / Venue</label>
      <input type="text" id="examVenue" class="form-inp" placeholder="e.g. Block A, Room 101"/>
    </div>
    <div class="form-grp"><label class="form-lbl">Syllabus / Notes</label>
      <textarea id="examNotes" class="form-ta" placeholder="Topics covered, seating no, hall-ticket info..." style="min-height:70px"></textarea>
    </div>
    <div style="display:flex;gap:10px;margin-top:6px">
      <button class="btn btn-p" style="flex:1;justify-content:center" onclick="saveExam()">üíæ Save Exam</button>
      <button class="btn btn-g" onclick="closeModal('addExamModal')">Cancel</button>
    </div>
  </div>
</div>

<!-- ADD MARK MODAL -->
<div class="modal-ov" id="addMarkModal" onclick="if(event.target===this)closeModal('addMarkModal')">
  <div class="modal-box" style="max-width:460px">
    <div class="modal-hd">
      <div class="modal-title">üìù Add Assessment Mark</div>
      <button class="modal-cls" onclick="closeModal('addMarkModal')">‚úï</button>
    </div>
    <div class="form-grp"><label class="form-lbl">Subject *</label>
      <input type="text" id="markSubj" class="form-inp" placeholder="e.g. Mathematics, Data Structures"/>
    </div>
    <div class="form-row">
      <div class="form-grp"><label class="form-lbl">Assessment Name</label>
        <input type="text" id="markName" class="form-inp" placeholder="e.g. CA1, IA2, Lab-3"/>
      </div>
      <div class="form-grp"><label class="form-lbl">Date</label><input type="date" id="markDate" class="form-inp"/></div>
    </div>
    <div class="form-grp"><label class="form-lbl">Assessment Type</label>
      <select id="markType" class="form-sel">
        <option value="CA">Continuous Assessment (CA)</option>
        <option value="IA">Internal Assessment (IA)</option>
        <option value="Lab">Lab Record / Practical</option>
        <option value="Assignment">Assignment</option>
        <option value="Quiz">Quiz / Test</option>
        <option value="Project">Project / Mini-Project</option>
        <option value="Viva">Viva / Oral</option>
      </select>
    </div>
    <div class="form-row">
      <div class="form-grp"><label class="form-lbl">Marks Obtained *</label>
        <input type="number" id="markScore" class="form-inp" placeholder="e.g. 18" min="0" step="0.5"/>
      </div>
      <div class="form-grp"><label class="form-lbl">Out of *</label>
        <input type="number" id="markMax" class="form-inp" placeholder="e.g. 20" min="1" value="20"/>
      </div>
    </div>
    <div style="display:flex;gap:10px;margin-top:6px">
      <button class="btn btn-p" style="flex:1;justify-content:center" onclick="saveMark()">üíæ Save Mark</button>
      <button class="btn btn-g" onclick="closeModal('addMarkModal')">Cancel</button>
    </div>
  </div>
</div>

<!-- BOTTOM NAV -->
<nav class="bottom-nav">
  <div class="bn-items">
    <button class="bn-btn active" data-pg="dashboard" onclick="navigate('dashboard')"><span class="bn-ic">üè†</span>Home</button>
    <button class="bn-btn" data-pg="tasks" onclick="navigate('tasks')"><span class="bn-ic">üìã</span>Tasks</button>
    <button class="bn-btn" data-pg="quiz" onclick="navigate('quiz')"><span class="bn-ic">üß†</span>Quiz</button>
    <button class="bn-btn" data-pg="notes" onclick="navigate('notes')"><span class="bn-ic">üìù</span>Notes</button>
    <button class="bn-btn" data-pg="pomodoro" onclick="navigate('pomodoro')"><span class="bn-ic">‚è±Ô∏è</span>Timer</button>
    <button class="bn-btn" data-pg="gamify" onclick="navigate('gamify')"><span class="bn-ic">üèÜ</span>Rank</button>
<button class="bn-btn" data-pg="report" onclick="navigate('report')"><span class="bn-ic">üìä</span>Report</button>
  </div>
</nav>

<!-- FOCUS OVERLAY -->
<div class="focus-ov" id="focusOv">
  <div class="pomo-ring-w"><svg class="pomo-svg" viewBox="0 0 230 230" width="220" height="220"><circle class="pomo-track" cx="115" cy="115" r="100"/><circle class="pomo-fill" id="focusFill" cx="115" cy="115" r="100"/></svg><div class="pomo-ctr"><div class="pomo-t" id="focusTime">25:00</div><div class="pomo-m" id="focusMode">Focus</div></div></div>
  <div class="focus-task-lbl" id="focusTaskLbl">Deep Focus Session</div>
  <div class="focus-hint">Press ESC to exit focus mode</div>
  <div style="display:flex;gap:16px"><button class="pomo-btn-main" id="focusPlayBtn" onclick="pomoToggle();syncFocus()">‚ñ∂</button></div>
  <button class="focus-exit-btn" onclick="exitFocus()">Exit Focus Mode</button>
</div>

<!-- EDIT TASK MODAL -->
<div class="modal-ov" id="editModal" onclick="if(event.target===this)closeModal('editModal')">
  <div class="modal-box">
    <div class="modal-hd"><div class="modal-title">Edit Task</div><button class="modal-cls" onclick="closeModal('editModal')">‚úï</button></div>
    <div class="form-grp"><label class="form-lbl">Title *</label><input type="text" id="eTitle" class="form-inp"/></div>
    <div class="form-row"><div class="form-grp"><label class="form-lbl">Subject</label><input type="text" id="eSubject" class="form-inp" list="subjectList"/></div><div class="form-grp"><label class="form-lbl">Due Date</label><input type="date" id="eDue" class="form-inp"/></div></div>
    <div class="form-row"><div class="form-grp"><label class="form-lbl">Priority</label><select id="ePrio" class="form-sel"><option value="high">High</option><option value="medium">Medium</option><option value="low">Low</option></select></div><div class="form-grp"><label class="form-lbl">Status</label><select id="eStat" class="form-sel"><option value="pending">Pending</option><option value="in-progress">In Progress</option><option value="completed">Completed</option></select></div></div>
    <div class="form-grp"><label class="form-lbl">Notes</label><textarea id="eNotes" class="form-ta"></textarea></div>
    <div style="display:flex;gap:11px"><button class="btn btn-p" onclick="saveEdit()">Save Changes</button><button class="btn btn-g" onclick="closeModal('editModal')">Cancel</button></div>
  </div>
</div>

<!-- NOTE MODAL -->
<div class="modal-ov" id="noteModal" onclick="if(event.target===this)closeModal('noteModal')">
  <div class="modal-box" style="max-width:620px">
    <div class="modal-hd"><div class="modal-title" id="noteModalTitle">New Note</div><button class="modal-cls" onclick="closeModal('noteModal')">‚úï</button></div>
    <div class="form-grp"><label class="form-lbl">Title</label><input type="text" id="nTitle" class="form-inp" placeholder="Note title..."/></div>
    <div class="form-row"><div class="form-grp"><label class="form-lbl">Subject</label><select id="nSubj" class="form-sel"><option value="">General</option><option>Mathematics</option><option>Physics</option><option>Computer Science</option><option>Chemistry</option><option>Biology</option><option>English</option></select></div></div>
    <div class="form-grp"><label class="form-lbl">Content</label><textarea id="nContent" class="form-ta" style="min-height:160px" placeholder="Write your notes here..."></textarea></div>
    <div style="display:flex;gap:11px"><button class="btn btn-p" onclick="saveNote()">üíæ Save Note</button><button class="btn btn-g" onclick="closeModal('noteModal')">Cancel</button></div>
  </div>
</div>

<!-- GOAL MODAL -->
<div class="modal-ov" id="goalModal" onclick="if(event.target===this)closeModal('goalModal')">
  <div class="modal-box" style="max-width:440px">
    <div class="modal-hd"><div class="modal-title">Add Subject Goal</div><button class="modal-cls" onclick="closeModal('goalModal')">‚úï</button></div>
    <div class="form-grp"><label class="form-lbl">Subject</label><input type="text" id="goalSubj" class="form-inp" placeholder="e.g. Mathematics" list="subjectList"/></div>
    <div class="form-grp"><label class="form-lbl">Goal Description</label><input type="text" id="goalDesc" class="form-inp" placeholder="e.g. Finish Calculus Chapter"/></div>
    <div class="form-row"><div class="form-grp"><label class="form-lbl">Target Hours</label><input type="number" id="goalTarget" class="form-inp" placeholder="10" min="1" max="200"/></div><div class="form-grp"><label class="form-lbl">Done So Far</label><input type="number" id="goalDone" class="form-inp" placeholder="0" min="0"/></div></div>
    <button class="btn btn-p" style="width:100%;justify-content:center" onclick="saveGoal()">Add Goal</button>
  </div>
</div>

<!-- GLOBAL SEARCH -->
<div class="gs-overlay" id="gsOverlay" onclick="if(event.target===this)closeGlobalSearch()">
  <div class="gs-box">
    <div class="gs-input-row">
      <span style="font-size:1.1rem;color:var(--tx3)">üîç</span>
      <input type="text" class="gs-inp" id="gsInput" placeholder="Search tasks, notes, flashcards..." oninput="gsSearch()" onkeydown="gsKeyNav(event)" autofocus/>
      <span class="gs-kbd">ESC</span>
    </div>
    <div class="gs-results" id="gsResults">
      <div class="gs-empty">
        <div class="gs-empty-ic">üîç</div>
        <div style="font-weight:700;color:var(--tx2);margin-bottom:5px">Search everything</div>
        <div style="font-size:.84rem">Tasks, notes, flashcards, pages</div>
      </div>
    </div>
    <div class="gs-footer">
      <div class="gs-shortcut"><span class="gs-kbd">‚Üë‚Üì</span> Navigate</div>
      <div class="gs-shortcut"><span class="gs-kbd">Enter</span> Open</div>
      <div class="gs-shortcut"><span class="gs-kbd">ESC</span> Close</div>
      <div style="margin-left:auto"><span class="gs-kbd">Ctrl+K</span> Open search</div>
    </div>
  </div>
</div>

<div id="toasts"></div>
<div id="sbOverlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:180;backdrop-filter:blur(3px)" onclick="closeSidebar()"></div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let cu=null,tasks=[],notes=[],goals=[],notifs=[],taskFilter='all',editId=null,selPrioVal='high',sbExpanded=window.innerWidth>=768,noteCat='',editNoteId=null;
let quizSubject=null,quizQs=[],quizIdx=0,quizScore=0,quizAnswered=false;
let calYear=new Date().getFullYear(),calMonth=new Date().getMonth();
let donut=null,bar=null,perfPie=null,perfLine=null;
let pomoPhase='focus',pomoTimes={focus:25,short:5,long:15},pomoLeft=1500,pomoTotal=1500,pomoRunning=false,pomoTimer=null,pomoSessions=0,pomoBreaks=0,pomoFocused=0;
let topicsDone=[],fcCards=[],fcIdx=0,fcFlipped=false,fcReviewQueue=[];
let musicPlaying=false,musicTrackIdx=0;

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê UTILS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const G=k=>{try{return JSON.parse(localStorage.getItem(k))}catch{return null}};
const S=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
const E=s=>String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
function toast(msg,type='info'){
  const t=document.createElement('div');t.className=`toast t${type==='success'?'s':type==='error'?'e':'i'}`;
  t.innerHTML=(type==='success'?'‚úÖ':type==='error'?'‚ùå':'‚ÑπÔ∏è')+' '+E(msg);
  document.getElementById('toasts').appendChild(t);
  setTimeout(()=>{t.style.animation='toastOut .3s ease forwards';setTimeout(()=>t.remove(),320);},3500);
}
// === SWIPE GESTURES ===
(function(){
  let touchStartX=0,touchStartY=0,swipeEl=null;
  document.addEventListener('touchstart',function(e){
    touchStartX=e.touches[0].clientX;
    touchStartY=e.touches[0].clientY;
    swipeEl=e.target.closest('.task-item');
  },{passive:true});
  document.addEventListener('touchend',function(e){
    if(!swipeEl)return;
    const dx=e.changedTouches[0].clientX-touchStartX;
    const dy=e.changedTouches[0].clientY-touchStartY;
    if(Math.abs(dx)>60&&Math.abs(dx)>Math.abs(dy)*2){
      const idx=swipeEl.dataset.idx;
      if(dx<0){
        if(confirm('Delete this task?')){tasks.splice(idx,1);saveTasks();renderTasks();}
      } else {
        if(tasks[idx])tasks[idx].done=!tasks[idx].done;
        saveTasks();renderTasks();
      }
    }
    swipeEl=null;
  },{passive:true});
})();

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
window.addEventListener('DOMContentLoaded',()=>{
  const pref=G('sb_pref')||{};if(pref.theme==='dark')applyTheme('dark');
  const sess=G('sb_sess');
  if(sess){cu=sess;initApp();}
  else{document.getElementById('landingPage').style.display='flex';document.getElementById('authPage').style.display='none';document.getElementById('app').style.display='none';}
  renderQuickLogins();
  document.addEventListener('keydown',e=>{if(e.key==='Escape'){exitFocus();closeModal('editModal');closeModal('noteModal');closeModal('goalModal');document.getElementById('notifPanel').classList.remove('show');}});
  window.addEventListener('resize',()=>{if(window.innerWidth>=768){sbExpanded=true;document.getElementById('appBody').classList.add('sb-open');}});
  document.getElementById('lPass')?.addEventListener('keydown',e=>{if(e.key==='Enter')handleLogin();});
  document.getElementById('rPass')?.addEventListener('keydown',e=>{if(e.key==='Enter')handleRegister();});
  // Rotating tips ticker
  setInterval(rotateTip,8000);
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê THEME ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function applyTheme(t){
  document.documentElement.setAttribute('data-theme',t);const icon=t==='dark'?'‚òÄÔ∏è':'üåô';
  document.querySelectorAll('.theme-toggle-btn,#themeBtn2').forEach(b=>{if(b)b.textContent=icon;});
  const sw=document.getElementById('themeSwitch');if(sw)sw.classList.toggle('on',t==='dark');
  setTimeout(()=>{if(donut)rebuildCharts();},120);
}
function toggleTheme(){const cur=document.documentElement.getAttribute('data-theme')||'light';const next=cur==='light'?'dark':'light';applyTheme(next);const p=G('sb_pref')||{};p.theme=next;S('sb_pref',p);}
function toggleThemeFromAcc(){toggleTheme();}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LANDING HELPERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function showLanding(){document.getElementById('landingPage').style.display='flex';document.getElementById('authPage').style.display='none';document.getElementById('app').style.display='none';}
function toggleFAQ(el){el.classList.toggle('open');}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AUTH ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function showAuth(tab='login'){document.getElementById('landingPage').style.display='none';document.getElementById('authPage').style.display='flex';switchAuthTab(tab);renderQuickLogins();}
function switchAuthTab(t){document.getElementById('aTabLogin').classList.toggle('active',t==='login');document.getElementById('aTabReg').classList.toggle('active',t==='register');document.getElementById('loginForm').style.display=t==='login'?'block':'none';document.getElementById('regForm').style.display=t==='register'?'block':'none';}
function renderQuickLogins(){const users=G('sb_users')||{};const emails=Object.keys(users);if(!emails.length)return;document.getElementById('qlWrap').style.display='block';document.getElementById('qlChips').innerHTML=emails.map(e=>`<div class="ql-chip" onclick="document.getElementById('lEmail').value='${E(e)}';document.getElementById('lPass').focus()">${E(users[e].name)}</div>`).join('');}
function handleRegister(){
  const name=document.getElementById('rName').value.trim(),email=document.getElementById('rEmail').value.trim(),grade=document.getElementById('rGrade').value,dept=document.getElementById('rDept').value,pass=document.getElementById('rPass').value;
  let ok=true;
  const se=(id,m)=>{const el=document.getElementById(id);el.style.display='block';el.textContent=m;ok=false;};
  const he=id=>document.getElementById(id).style.display='none';
  if(!name)se('rNameErr','Name is required.');else he('rNameErr');
  if(!email||!email.includes('@'))se('rEmailErr','Enter a valid email.');else he('rEmailErr');
  if(pass.length<4)se('rPassErr','Password must be 4+ characters.');else he('rPassErr');
  if(!ok)return;
  const users=G('sb_users')||{};if(users[email]){se('rEmailErr','Email already registered.');return;}
  users[email]={name,email,grade,dept,pass:btoa(pass),joined:Date.now()};S('sb_users',users);
  toast('Account created! Sign in now.','success');switchAuthTab('login');document.getElementById('lEmail').value=email;
}
function handleLogin(){
  const email=document.getElementById('lEmail').value.trim(),pass=document.getElementById('lPass').value;
  const se=(id,m)=>{const el=document.getElementById(id);el.style.display='block';el.textContent=m;};
  const he=id=>document.getElementById(id).style.display='none';
  let ok=true;
  if(!email||!email.includes('@')){se('lEmailErr','Please enter a valid email.');ok=false;}else he('lEmailErr');
  if(!pass){se('lPassErr','Password is required.');ok=false;}else he('lPassErr');
  if(!ok)return;
  const users=G('sb_users')||{};const u=users[email];
  if(!u||atob(u.pass)!==pass){se('lPassErr','Invalid email or password.');return;}
  cu={name:u.name,email,grade:u.grade||'Student',dept:u.dept||'OTHER',joined:u.joined||Date.now()};S('sb_sess',cu);initApp();
}
function handleLogout(){localStorage.removeItem('sb_sess');cu=null;document.getElementById('app').style.display='none';document.getElementById('app').classList.remove('visible');showLanding();toast('Signed out.','info');}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AVATAR SYSTEM ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const AV_EMOJIS=[
  'üòé','ü¶ä','üêØ','ü¶Å','üêâ','ü¶ã','üåü','üî•','üíé','üöÄ',
  'üéØ','‚ö°','üß†','üìö','üéì','üèÜ','üí™','üåà','üéÆ','üé®',
  'üêº','ü¶Ñ','üê∏','ü¶Ö','üê∫','üêª','ü¶â','üê¨','üåô','‚òÄÔ∏è',
  '‚ùÑÔ∏è','üåä','üçÄ','üå∏','üéµ','üé∏','‚öΩ','üèÄ','üé≠','ü¶∏',
];

const AV_COLORS=[
  {label:'Ocean',value:'linear-gradient(135deg,#3D5AFE,#00B4D8)'},
  {label:'Fire',value:'linear-gradient(135deg,#FF6B35,#F7C59F)'},
  {label:'Forest',value:'linear-gradient(135deg,#15A352,#84CC16)'},
  {label:'Sunset',value:'linear-gradient(135deg,#D97706,#EF4444)'},
  {label:'Purple',value:'linear-gradient(135deg,#7B2FBE,#EC4899)'},
  {label:'Teal',value:'linear-gradient(135deg,#0B8E85,#3D5AFE)'},
  {label:'Rose',value:'linear-gradient(135deg,#E03131,#F472B6)'},
  {label:'Gold',value:'linear-gradient(135deg,#D97706,#FCD34D)'},
  {label:'Midnight',value:'linear-gradient(135deg,#1E1B4B,#3730A3)'},
  {label:'Coral',value:'linear-gradient(135deg,#FF6B6B,#FFA07A)'},
  {label:'Lime',value:'linear-gradient(135deg,#65A30D,#A3E635)'},
  {label:'Indigo',value:'linear-gradient(135deg,#4338CA,#818CF8)'},
];

function getAvatar(email){
  const key=`avatar_${email||cu?.email||''}`;
  return G(key)||{type:'emoji',emoji:'üòé',color:AV_COLORS[0].value,initials:'',photo:''};
}

function saveAvatar(av){
  S(`avatar_${cu.email}`,av);
}

/* ‚îÄ‚îÄ apply avatar to ANY element in-place (handles photo / emoji / initials) ‚îÄ‚îÄ */
function _applyAv(el, av, name, fsOverride){
  if(!el) return;
  const initials = (av.initials||(name||'U').split(' ').map(w=>w[0]).join('')).toUpperCase().slice(0,2);
  // reset
  el.innerHTML = '';
  el.style.overflow = 'hidden';
  if(av.type==='photo' && av.photo){
    el.style.background = 'transparent';
    el.style.fontSize = '';
    el.style.color = '';
    const img = document.createElement('img');
    img.src = av.photo;
    img.style.cssText = 'width:100%;height:100%;object-fit:cover;display:block;pointer-events:none';
    el.appendChild(img);
  } else if(av.type==='emoji'){
    el.style.background = av.color;
    el.style.fontSize = fsOverride || '1.1rem';
    el.style.color = '';
    el.textContent = av.emoji;
  } else {
    el.style.background = av.color;
    el.style.fontSize = fsOverride || '.82rem';
    el.style.color = '#fff';
    el.textContent = initials;
  }
}

function renderAvatarEl(email, size='md'){
  const av = getAvatar(email||cu?.email);
  const name = (email?((G('sb_users')||{})[email]?.name||'?'):cu?.name)||'?';
  const initials = name.split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2);
  const sizeClass = size==='sm'?'sm':size==='lg'?'lg':'';
  const fs = size==='sm'?'1.1rem':size==='lg'?'2.2rem':'1.5rem';
  if(av.type==='photo'&&av.photo){
    return `<div class="av-big ${sizeClass}" style="overflow:hidden;padding:0"><img src="${av.photo}" style="width:100%;height:100%;object-fit:cover;display:block"/></div>`;
  } else if(av.type==='emoji'){
    return `<div class="av-big ${sizeClass}" style="background:${av.color};font-size:${fs}">${av.emoji}</div>`;
  } else {
    return `<div class="av-big ${sizeClass}" style="background:${av.color};color:#fff">${av.initials||initials}</div>`;
  }
}

function updateAllAvatars(){
  try{
    if(!cu) return;
    const av  = getAvatar(cu.email);
    const name = cu.name||'User';

    /* 1. Topbar avatar (clickable on mobile too) */
    _applyAv(document.getElementById('tbAvatar'), av, name, av.type==='emoji'?'1.05rem':'.78rem');

    /* 2. Hide old duplicate tbAv span */
    const tbAv = document.getElementById('tbAv');
    if(tbAv) tbAv.style.display='none';

    /* 3. Sidebar avatar */
    const sbAv = document.getElementById('sbAv');
    if(sbAv){
      sbAv.style.borderRadius = '12px';
      _applyAv(sbAv, av, name, av.type==='emoji'?'1.1rem':'.82rem');
    }

    /* 4. Account page big avatar (keep ‚úèÔ∏è badge) */
    const accAv = document.getElementById('accAvatar');
    if(accAv){
      const badge = '<div style="position:absolute;bottom:-4px;right:-4px;width:22px;height:22px;border-radius:7px;background:var(--acc);display:flex;align-items:center;justify-content:center;font-size:.7rem;border:2px solid var(--surface);z-index:2">‚úèÔ∏è</div>';
      accAv.style.overflow = 'hidden';
      if(av.type==='photo'&&av.photo){
        accAv.style.background = 'transparent';
        accAv.style.fontSize = '';
        accAv.innerHTML = `<img src="${av.photo}" style="width:100%;height:100%;object-fit:cover;display:block"/>${badge}`;
      } else if(av.type==='emoji'){
        accAv.style.background = av.color;
        accAv.style.fontSize = '2.2rem';
        accAv.style.color = '';
        accAv.innerHTML = av.emoji + badge;
      } else {
        const ini = av.initials||(name.split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2));
        accAv.style.background = av.color;
        accAv.style.fontSize = '1.8rem';
        accAv.style.color = '#fff';
        accAv.innerHTML = ini + badge;
      }
    }

    /* 5. Friends page */
    _applyAv(document.getElementById('friendMyAv'), av, name);

  }catch(e){ console.warn('Avatar update error:', e); }
}
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DAILY LOGIN BONUS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function getLoginStreak(){
  const logins=G(`logins_${cu?.email||''}`)||{};
  let streak=0;
  for(let i=0;i<365;i++){
    const d=new Date(Date.now()-i*86400000).toDateString();
    if(logins[d])streak++;
    else if(i>0)break;
  }
  return streak;
}

function getConsecutiveLoginDays(){
  const logins=G(`logins_${cu?.email||''}`)||{};
  return Object.keys(logins).length;
}

function checkDailyLoginBonus(){
  if(!cu)return;
  const key=`logins_${cu.email}`;
  const logins=G(key)||{};
  const today=new Date().toDateString();

  // Already claimed today
  if(logins[today])return;

  // Mark today as logged in
  logins[today]=Date.now();
  S(key,logins);

  const streak=getLoginStreak();
  const totalDays=Object.keys(logins).length;

  // Calculate XP based on streak
  let xpAmount=10; // Day 1 default
  let bonusMsg='';
  let isSpecial=false;

  if(streak>=30){
    xpAmount=500;
    bonusMsg='üóìÔ∏è 30-Day Login Legend!';
    isSpecial=true;
  } else if(streak>=14){
    xpAmount=200;
    bonusMsg='üî• 2-Week Warrior!';
    isSpecial=true;
  } else if(streak>=7){
    xpAmount=100;
    bonusMsg='üìÖ 7-Day Streak Bonus!';
    isSpecial=true;
  } else if(streak>=3){
    xpAmount=30;
    bonusMsg='‚≠ê 3-Day Streak!';
  } else if(streak>=2){
    xpAmount=20;
    bonusMsg='‚úåÔ∏è 2-Day Streak!';
  } else {
    xpAmount=10;
    bonusMsg='üëã Welcome back!';
  }

  // Show login bonus modal
  setTimeout(()=>{
    showLoginBonusModal(streak,xpAmount,bonusMsg,isSpecial,totalDays);
    addXP(xpAmount,'Daily Login Bonus');
    checkBadges();
  },800);
}

function showLoginBonusModal(streak,xp,msg,isSpecial,totalDays){
  // Remove existing modal if any
  const existing=document.getElementById('loginBonusModal');
  if(existing)existing.remove();

  const milestones=[
    {day:1,xp:10,emoji:'üå±'},
    {day:2,xp:20,emoji:'‚úåÔ∏è'},
    {day:3,xp:30,emoji:'‚≠ê'},
    {day:7,xp:100,emoji:'üìÖ'},
    {day:14,xp:200,emoji:'üî•'},
    {day:30,xp:500,emoji:'üóìÔ∏è'},
  ];

  const modal=document.createElement('div');
  modal.id='loginBonusModal';
  modal.style.cssText='position:fixed;inset:0;background:rgba(7,9,26,.75);z-index:600;display:flex;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(12px);animation:fadeIn .25s ease';

  modal.innerHTML=`
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:28px;padding:36px 32px;width:100%;max-width:420px;text-align:center;box-shadow:0 28px 72px rgba(0,0,0,.25);animation:scaleIn .35s cubic-bezier(.34,1.56,.64,1);position:relative;overflow:hidden">

      <!-- Background glow -->
      <div style="position:absolute;top:-60px;left:50%;transform:translateX(-50%);width:220px;height:220px;background:${isSpecial?'radial-gradient(circle,rgba(61,90,254,.25),transparent)':'radial-gradient(circle,rgba(61,90,254,.12),transparent)'};border-radius:50%;pointer-events:none"></div>

      <!-- Close btn -->
      <button onclick="closeLoginBonus()" style="position:absolute;top:16px;right:16px;width:32px;height:32px;border-radius:10px;border:1.5px solid var(--border);background:transparent;color:var(--tx3);cursor:pointer;font-size:.9rem;display:flex;align-items:center;justify-content:center">‚úï</button>

      <!-- Icon -->
      <div style="width:88px;height:88px;border-radius:28px;background:linear-gradient(135deg,var(--acc),var(--purple));display:flex;align-items:center;justify-content:center;font-size:2.8rem;margin:0 auto 18px;box-shadow:0 8px 28px rgba(61,90,254,.45);animation:bounce 2s ease infinite">${isSpecial?'üèÜ':'üéÅ'}</div>

      <!-- Title -->
      <div style="font-size:.72rem;font-weight:900;color:var(--acc);letter-spacing:2px;text-transform:uppercase;margin-bottom:8px">Daily Login Bonus</div>
      <div style="font-size:1.4rem;font-weight:900;color:var(--tx);margin-bottom:6px">${msg}</div>
      <div style="font-size:.9rem;color:var(--tx3);margin-bottom:24px">Day ${streak} of your login streak!</div>

      <!-- XP Amount -->
      <div style="background:linear-gradient(135deg,var(--acc-bg),var(--purple-bg));border:1.5px solid rgba(61,90,254,.25);border-radius:18px;padding:20px;margin-bottom:24px">
        <div style="font-size:.72rem;font-weight:800;color:var(--tx3);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:8px">You Earned</div>
        <div style="font-size:3.2rem;font-weight:900;color:var(--acc);line-height:1;margin-bottom:4px">+${xp} XP</div>
        <div style="font-size:.82rem;color:var(--tx3)">${totalDays} total login days</div>
      </div>

      <!-- Milestone Progress -->
      <div style="margin-bottom:24px">
        <div style="font-size:.72rem;font-weight:800;color:var(--tx3);text-transform:uppercase;letter-spacing:1px;margin-bottom:13px">Milestone Rewards</div>
        <div style="display:flex;justify-content:space-between;align-items:flex-end;gap:3px;overflow-x:auto;padding-bottom:4px">
          ${milestones.map(m=>{
            const reached=streak>=m.day;
            const isCurrent=streak===m.day;
            return `<div style="flex:1;min-width:28px;text-align:center">
              <div style="font-size:1.1rem;margin-bottom:4px;filter:${reached?'none':'grayscale(1)'}opacity(${reached?1:.35})">${m.emoji}</div>
              <div style="width:100%;height:5px;border-radius:3px;background:${reached?'var(--acc)':'var(--surface2)'};margin-bottom:5px;${isCurrent?'box-shadow:0 0 8px rgba(61,90,254,.6)':''}"></div>
              <div style="font-size:.6rem;font-weight:800;color:${reached?'var(--acc)':'var(--tx4)'}">${m.day}d</div>
              <div style="font-size:.58rem;color:${reached?'var(--tx3)':'var(--tx4)'}">+${m.xp}</div>
            </div>`;
          }).join('')}
        </div>
      </div>

      <!-- Next milestone hint -->
      <div style="font-size:.82rem;color:var(--tx3);margin-bottom:22px;padding:11px 16px;background:var(--surface2);border-radius:var(--r-sm)" id="lbNextHint"></div>

      <!-- Confetti button -->
      <button onclick="closeLoginBonus();spawnConfetti()" style="width:100%;padding:14px;background:linear-gradient(135deg,var(--acc),var(--purple));color:#fff;border:none;border-radius:var(--r-sm);font-weight:900;font-size:1rem;cursor:pointer;transition:all .2s;box-shadow:0 6px 20px rgba(61,90,254,.4)" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform=''">
        ${isSpecial?'üéâ Claim Special Reward!':'‚ú® Claim Bonus!'}
      </button>
    </div>`;

  document.body.appendChild(modal);

  // Next milestone hint
  const next=milestones.find(m=>m.day>streak);
  const hintEl=document.getElementById('lbNextHint');
  if(hintEl){
    if(next)hintEl.textContent=`üéØ ${next.day-streak} more day${next.day-streak>1?'s':''} to unlock ${next.emoji} +${next.xp} XP reward!`;
    else hintEl.textContent='üèÜ You\'ve reached the ultimate milestone! Max login bonus unlocked!';
  }

  // Auto confetti for special milestones
  if(isSpecial)setTimeout(spawnConfetti,500);
}

function closeLoginBonus(){
  const modal=document.getElementById('loginBonusModal');
  if(modal){
    modal.style.animation='fadeIn .2s ease reverse';
    setTimeout(()=>modal.remove(),220);
  }
}
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê APP INIT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function initApp(){
  document.getElementById('landingPage').style.display='none';
  checkDailyLoginBonus();
  updateAllAvatars();
  initReminders(); 
  setTimeout(checkOnboarding, 200);document.getElementById('authPage').style.display='none';
  document.getElementById('app').style.display='flex';document.getElementById('app').classList.add('visible');
  loadAll();updateUserUI();updateGreeting();navigate('dashboard');checkNotifs();
  if(sbExpanded)document.getElementById('appBody').classList.add('sb-open');
  topicsDone=G(`topics_${cu.email}`)||[];renderTopicCheckGrid();renderPomodoro();
  updateXPBar();checkBadges();
  const pref=G('sb_pref')||{};if(pref.pomoDef){pomoTimes.focus=pref.pomoDef;pomoLeft=pref.pomoDef*60;pomoTotal=pomoLeft;}
  const th=document.documentElement.getAttribute('data-theme');const sw=document.getElementById('themeSwitch');if(sw)sw.classList.toggle('on',th==='dark');
  rotateTip();
}
function loadAll(){tasks=G(`tasks_${cu.email}`)||[];notes=G(`notes_${cu.email}`)||[];goals=G(`goals_${cu.email}`)||[];notifs=G(`notifs_${cu.email}`)||[];fcCards=G(`flashcards_${cu.email}`)||[];}
function saveAll(){S(`tasks_${cu.email}`,tasks);S(`notes_${cu.email}`,notes);S(`goals_${cu.email}`,goals);}
function updateUserUI(){const av=cu.name.charAt(0).toUpperCase();['sbAv','tbAv'].forEach(id=>{const el=document.getElementById(id);if(el)el.textContent=av;});document.getElementById('sbName').textContent=cu.name;document.getElementById('tbName').textContent=cu.name;const deptShort=cu.dept?((DEPT_LABELS[cu.dept]||cu.dept).replace(/^[^\s]+\s/,'').slice(0,12)):'Student';document.getElementById('sbGrade').textContent=(cu.grade?cu.grade+' ¬∑ ':'')+deptShort;}
function updateGreeting(){const h=new Date().getHours();const g=h<12?'Good morning':h<17?'Good afternoon':'Good evening';document.getElementById('greetH').innerHTML=`${g}, <span style="background:linear-gradient(135deg,var(--acc),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;">${cu.name}</span>! üëã`;;document.getElementById('greetP').textContent=`${new Date().toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'})} ‚Äî Here's your study overview.`;}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TIPS TICKER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const ALL_TIPS=['Use active recall ‚Äî test yourself instead of re-reading notes.','The Pomodoro method: 25 mins focus + 5 mins break = maximum productivity!','Review notes within 24 hours for 60% better retention.','Teach a concept to someone else to truly understand it.','Sleep is memory consolidation ‚Äî don\'t skip rest before exams!','Spaced repetition beats cramming every time.','Break big tasks into 3 small steps to reduce overwhelm.','Hydration boosts brain performance by up to 30%.'];
let tipIdx=0;
function rotateTip(){const el=document.getElementById('tipsText');if(el){el.style.opacity='0';setTimeout(()=>{el.textContent=ALL_TIPS[tipIdx%ALL_TIPS.length];el.style.opacity='1';tipIdx++;},300);}}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê NAVIGATION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const PAGE_TITLES={dashboard:'Dashboard',report:'Progress Report üìä',reminders:'Smart Reminders üîî',friends:'Friends & Social üë•',studygroups:'Study Groups üè´',timetable:'Timetable Builder üóìÔ∏è',tasks:'My Tasks',upcoming:'Upcoming',quiz:'Quiz',notes:'Notes',aitools:'AI Tools',performance:'Performance',streaks:'Streaks & Goals',pomodoro:'Pomodoro',add:'Add Task',account:'Account Settings',gamify:'XP & Badges üèÜ',daily:'Daily Challenge',flashcards:'Flashcards',exam:'Exam Schedule üìÜ',deptLeader:'Department Leaderboard üèÜ'};
function navigate(pg){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.sb-btn,.bn-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById(pg+'Page').classList.add('active');
  document.querySelectorAll(`[data-pg="${pg}"]`).forEach(b=>b.classList.add('active'));
  document.getElementById('tbTitle').textContent=PAGE_TITLES[pg]||'StudyBot Pro';
  if(pg==='dashboard')renderDashboard();
  if(pg==='tasks')renderTasks();
  if(pg==='upcoming')renderUpcoming();
  if(pg==='performance')renderPerf();
  if(pg==='streaks')renderStreaks();
  if(pg==='notes')renderNotes();
  if(pg==='quiz')renderQuizSubjects();
  if(pg==='pomodoro')renderPomodoro();
  if(pg==='account')renderAccount();
  if(pg==='gamify')renderGamify();
  if(pg==='daily')renderDaily();
  if(pg==='flashcards')renderFlashcards();
if(pg==='report')renderReport();
if(pg==='reminders')renderReminders();
if(pg==='friends')renderFriends();
if(pg==='studygroups')renderStudyGroups();
if(pg==='timetable')renderTimetable();
if(pg==='exam')renderExams();
if(pg==='deptLeader')renderDeptLeader();
  if(window.innerWidth<768)closeSidebar();
  document.getElementById('notifPanel').classList.remove('show');
  document.getElementById('contentArea').scrollTo(0,0);
}
function toggleSidebar(){
  if(window.innerWidth<768){const sb=document.getElementById('sidebar');const ov=document.getElementById('sbOverlay');sb.classList.toggle('open');ov.style.display=sb.classList.contains('open')?'block':'none';}
  else{sbExpanded=!sbExpanded;document.getElementById('appBody').classList.toggle('sb-open',sbExpanded);}
}
function closeSidebar(){document.getElementById('sidebar').classList.remove('open');document.getElementById('sbOverlay').style.display='none';}
function closeModal(id){document.getElementById(id).classList.remove('show');}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê XP SYSTEM ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const LEVELS=[{min:0,name:'Seedling',emoji:'üå±'},{min:100,name:'Explorer',emoji:'üß≠'},{min:300,name:'Scholar',emoji:'üìñ'},{min:600,name:'Achiever',emoji:'‚≠ê'},{min:1000,name:'Prodigy',emoji:'üî•'},{min:1500,name:'Champion',emoji:'üèÜ'},{min:2200,name:'Legend',emoji:'üëë'},{min:3000,name:'Grandmaster',emoji:'üíé'}];
function getXP(){return parseInt(localStorage.getItem('xp_'+(cu?.email||''))||'0');}
function setXPVal(v){localStorage.setItem('xp_'+(cu?.email||''),v);}
function getLvl(xp){let l=LEVELS[0];for(const x of LEVELS){if(xp>=x.min)l=x;else break;}return l;}
function getLvlIdx(xp){let i=0;for(let j=0;j<LEVELS.length;j++){if(xp>=LEVELS[j].min)i=j;else break;}return i;}
function getNextLvl(xp){const i=getLvlIdx(xp);return LEVELS[i+1]||null;}
function addXP(amount,reason){
  if(!cu)return;const old=getXP();const newXP=old+amount;setXPVal(newXP);
  const el=document.createElement('div');el.className='xp-float';el.textContent='+'+amount+' XP';document.body.appendChild(el);setTimeout(()=>el.remove(),1050);
  const oldI=getLvlIdx(old);const newI=getLvlIdx(newXP);
  if(newI>oldI){const lv=LEVELS[newI];setTimeout(()=>{toast('üéâ LEVEL UP! You are now '+lv.name+' '+lv.emoji,'success');spawnConfetti();},400);}
  updateXPBar();checkBadges();
}
function updateXPBar(){
  if(!cu)return;const xp=getXP();const lv=getLvl(xp);const idx=getLvlIdx(xp);const next=getNextLvl(xp);
  const pct=next?Math.round(((xp-lv.min)/(next.min-lv.min))*100):100;
  const sbb=document.getElementById('sbXpBar');if(sbb)sbb.style.width=pct+'%';
  const sbl=document.getElementById('sbLvlLbl');if(sbl)sbl.textContent='Lv.'+(idx+1)+' '+lv.name;
  const sbx=document.getElementById('sbXpLbl');if(sbx)sbx.textContent=xp+' XP';
  const de=document.getElementById('dashLvEmoji');if(de)de.textContent=lv.emoji;
  const dn=document.getElementById('dashLvName');if(dn)dn.textContent=lv.name+' Lv '+(idx+1);
  const df=document.getElementById('dashXPBarFill');if(df)df.style.width=pct+'%';
  const dv=document.getElementById('dashXPVal');if(dv)dv.textContent=xp;
}
function spawnConfetti(){
  const emojis=['üéâ','‚≠ê','‚ú®','üî•','üí•','üéä','üåü'];
  for(let i=0;i<16;i++){const c=document.createElement('div');c.textContent=emojis[Math.floor(Math.random()*emojis.length)];c.style.cssText=`position:fixed;font-size:1.8rem;pointer-events:none;z-index:9999;animation:confetti 1s ease forwards;left:${Math.random()*90}vw;top:${Math.random()*80}vh;animation-delay:${Math.random()*.4}s`;document.body.appendChild(c);setTimeout(()=>c.remove(),1300);}
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BADGES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const BADGES=[
  {id:'first_task',name:'First Step',emoji:'üë£',desc:'Complete your first task',xp:20,check:()=>tasks.filter(t=>t.status==='completed').length>=1},
  {id:'five_tasks',name:'Getting Going',emoji:'üí™',desc:'Complete 5 tasks',xp:50,check:()=>tasks.filter(t=>t.status==='completed').length>=5},
  {id:'ten_tasks',name:'Task Master',emoji:'üèÖ',desc:'Complete 10 tasks',xp:100,check:()=>tasks.filter(t=>t.status==='completed').length>=10},
  {id:'twenty_five_tasks',name:'Powerhouse',emoji:'‚ö°',desc:'Complete 25 tasks',xp:200,check:()=>tasks.filter(t=>t.status==='completed').length>=25},
  {id:'first_quiz',name:'Quiz Starter',emoji:'üß†',desc:'Complete your first quiz',xp:30,check:()=>(G('quizHist_'+(cu?.email||''))||[]).length>=1},
  {id:'quiz_perfect',name:'Perfect Score',emoji:'üíØ',desc:'Score 100% on any quiz',xp:100,check:()=>(G('quizHist_'+(cu?.email||''))||[]).some(q=>q.score===q.total)},
  {id:'quiz_five',name:'Quiz Fanatic',emoji:'üéØ',desc:'Complete 5 quizzes',xp:80,check:()=>(G('quizHist_'+(cu?.email||''))||[]).length>=5},
  {id:'quiz_master',name:'Quiz Master',emoji:'üß©',desc:'Complete 10 quizzes',xp:150,check:()=>(G('quizHist_'+(cu?.email||''))||[]).length>=10},
  {id:'streak_3',name:'3-Day Streak',emoji:'üî•',desc:'Study 3 days in a row',xp:50,check:()=>getCurStreak()>=3},
  {id:'streak_7',name:'Week Warrior',emoji:'üìÖ',desc:'Study 7 days in a row',xp:150,check:()=>getCurStreak()>=7},
  {id:'streak_30',name:'Monthly Legend',emoji:'üóìÔ∏è',desc:'Study 30 days in a row',xp:500,check:()=>getCurStreak()>=30},
  {id:'first_note',name:'Note Taker',emoji:'üìù',desc:'Save your first note',xp:20,check:()=>notes.length>=1},
  {id:'ten_notes',name:'Knowledge Keeper',emoji:'üìö',desc:'Save 10 notes',xp:80,check:()=>notes.length>=10},
  {id:'night_owl',name:'Night Owl',emoji:'ü¶â',desc:'Complete a task after 10 PM',xp:40,check:()=>tasks.some(t=>t.status==='completed'&&new Date(t.updated).getHours()>=22)},
  {id:'early_bird',name:'Early Bird',emoji:'üê¶',desc:'Complete a task before 7 AM',xp:40,check:()=>tasks.some(t=>t.status==='completed'&&new Date(t.updated).getHours()<7)},
  {id:'high_priority',name:'Urgency Expert',emoji:'üî¥',desc:'Complete 3 high priority tasks',xp:60,check:()=>tasks.filter(t=>t.status==='completed'&&t.priority==='high').length>=3},
  {id:'all_subjects',name:'Polymath',emoji:'üåç',desc:'Take quizzes in all 6 subjects',xp:200,check:()=>{const taken=new Set((G('quizHist_'+(cu?.email||''))||[]).map(q=>q.subject));return taken.size>=6;}},
  {id:'flashcard_10',name:'Flash Student',emoji:'üÉè',desc:'Create 10 flashcards',xp:60,check:()=>(G('flashcards_'+(cu?.email||''))||[]).length>=10},
  {id:'daily_done',name:'Daily Grinder',emoji:'‚ö°',desc:'Complete a daily challenge',xp:50,check:()=>(G('dailyDone_'+(cu?.email||''))||[]).length>=1},
  {id:'xp_500',name:'XP Hunter',emoji:'üí∞',desc:'Earn 500 total XP',xp:50,check:()=>getXP()>=500},
  {id:'xp_1000',name:'XP Champion',emoji:'üëë',desc:'Earn 1000 total XP',xp:100,check:()=>getXP()>=1000},
  {id:'goals_3',name:'Goal Setter',emoji:'üéØ',desc:'Set 3 study goals',xp:40,check:()=>goals.length>=3},
  {id:'login_7',name:'Week Devotee',emoji:'üìÖ',desc:'Login 7 days in a row',xp:100,check:()=>getLoginStreak()>=7},
  {id:'login_30',name:'Monthly Master',emoji:'üóìÔ∏è',desc:'Login 30 days in a row',xp:500,check:()=>getLoginStreak()>=30},
];
function getUnlockedBadges(){return G('badges_'+(cu?.email||''))||[];}
function setUnlockedBadges(arr){S('badges_'+(cu?.email||''),arr);}
function checkBadges(){
  if(!cu)return;const unlocked=getUnlockedBadges();
  BADGES.forEach(b=>{if(!unlocked.includes(b.id)&&b.check()){unlocked.push(b.id);setUnlockedBadges(unlocked);addXP(b.xp,b.name);setTimeout(()=>toast('üéñÔ∏è Badge: "'+b.name+'" +'+b.xp+' XP','success'),350);}});
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê NOTIFICATIONS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function addNotif(msg){notifs.unshift({id:Date.now(),msg,time:Date.now(),read:false});if(notifs.length>50)notifs=notifs.slice(0,50);S(`notifs_${cu.email}`,notifs);checkNotifs();}
function checkNotifs(){
  const unread=notifs.filter(n=>!n.read).length;
  const dot=document.getElementById('notifDot');
  if(dot){
    dot.classList.toggle('show',unread>0);
    dot.style.display=unread>0?'block':'none';
  }
  const nb=document.getElementById('notifBtn');
  if(nb)nb.title=unread>0?unread+' unread notifications':'Notifications';
}

function toggleNotif(){const panel=document.getElementById('notifPanel');panel.classList.toggle('show');if(panel.classList.contains('show')){renderNotifs();notifs.forEach(n=>n.read=true);S(`notifs_${cu.email}`,notifs);checkNotifs();}}
function renderNotifs(){const el=document.getElementById('npList');if(!notifs.length){el.innerHTML='<div style="padding:26px;text-align:center;color:var(--tx3);font-size:.88rem">üîî No notifications yet</div>';return;}el.innerHTML=notifs.slice(0,15).map(n=>`<div class="np-it${n.read?'':' unrd'}"><div class="np-it-t">${E(n.msg)}</div><div class="np-it-s">${new Date(n.time).toLocaleTimeString()}</div></div>`).join('');}
function clearNotifs(){notifs=[];S(`notifs_${cu.email}`,notifs);document.getElementById('notifPanel').classList.remove('show');checkNotifs();}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STREAK ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function markStreak(){const k=`streak_${cu.email}`;const s=G(k)||{};s[new Date().toDateString()]=true;S(k,s);}
function getStreakData(){const k=`streak_${cu.email}`;const s=G(k)||{};tasks.forEach(t=>{if(t.status==='completed'){const d=new Date(t.updated).toDateString();s[d]=true;}});return s;}
function getCurStreak(){const s=getStreakData();let streak=0;for(let i=0;i<365;i++){const d=new Date(Date.now()-i*86400000).toDateString();if(s[d])streak++;else if(i>0)break;}return streak;}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TASKS CRUD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function selPrio(p){selPrioVal=p;document.querySelectorAll('.prio-opt').forEach(el=>{el.className='prio-opt';if(el.dataset.p===p)el.classList.add('sel-'+p.charAt(0));});}
function submitTask(){
  const title=document.getElementById('tTitle').value.trim();
  if(!title){document.getElementById('tTitleErr').style.display='block';return;}
  document.getElementById('tTitleErr').style.display='none';
  const t={id:Date.now().toString(),title,subject:document.getElementById('tSubject').value.trim(),due:document.getElementById('tDue').value,priority:selPrioVal,status:document.getElementById('tStatus').value,notes:document.getElementById('tNotes').value.trim(),hours:parseFloat(document.getElementById('tHours').value)||0,subtasks:[],created:Date.now(),updated:Date.now()};
  tasks.unshift(t);saveAll();addNotif(`New task: "${title}"`);toast('Task added! ‚úÖ','success');addXP(5,'Task Created');checkBadges();resetAddForm();renderTaskBadge();navigate('tasks');
}
function resetAddForm(){['tTitle','tSubject','tDue','tNotes','tHours'].forEach(id=>document.getElementById(id).value='');document.getElementById('tStatus').value='pending';selPrio('high');}
function deleteTask(id){if(!confirm('Delete this task?'))return;tasks=tasks.filter(t=>t.id!==id);saveAll();toast('Task deleted.','info');renderTasks();renderTaskBadge();}
function toggleDone(id){
  const t=tasks.find(t=>t.id===id);if(!t)return;const wasDone=t.status==='completed';
  t.status=wasDone?'pending':'completed';t.updated=Date.now();
  if(!wasDone){markStreak();toast(`Task completed! üéâ +20 XP`,'success');addNotif(`‚úÖ "${t.title}" done!`);addXP(20,'Task Completed');checkBadges();}
  saveAll();renderTasks();renderTaskBadge();
}
function openEdit(id){
  const t=tasks.find(t=>t.id===id);if(!t)return;editId=id;
  document.getElementById('eTitle').value=t.title;document.getElementById('eSubject').value=t.subject||'';document.getElementById('eDue').value=t.due||'';document.getElementById('ePrio').value=t.priority;document.getElementById('eStat').value=t.status;document.getElementById('eNotes').value=t.notes||'';
  document.getElementById('editModal').classList.add('show');
}
function saveEdit(){
  const t=tasks.find(t=>t.id===editId);if(!t)return;const title=document.getElementById('eTitle').value.trim();if(!title)return;
  t.title=title;t.subject=document.getElementById('eSubject').value.trim();t.due=document.getElementById('eDue').value;t.priority=document.getElementById('ePrio').value;t.status=document.getElementById('eStat').value;t.notes=document.getElementById('eNotes').value.trim();t.updated=Date.now();
  saveAll();closeModal('editModal');toast('Task updated!','success');renderTasks();
}
function toggleSubtask(tid,idx){const t=tasks.find(t=>t.id===tid);if(!t||!t.subtasks[idx])return;t.subtasks[idx].done=!t.subtasks[idx].done;t.updated=Date.now();saveAll();renderTasks();}
function genSubtasks(id){
  const t=tasks.find(t=>t.id===id);if(!t)return;const m=t.title.toLowerCase();let st=[];
  if(m.includes('essay')||m.includes('write')||m.includes('report'))st=['Research the topic','Create an outline','Write first draft','Revise and edit','Proofread and submit'];
  else if(m.includes('math')||m.includes('calculus')||m.includes('algebra'))st=['Review formulas','Work practice problems','Check answers','Summarise methods'];
  else if(m.includes('code')||m.includes('program'))st=['Plan architecture','Set up environment','Implement features','Test and debug'];
  else if(m.includes('study')||m.includes('revise'))st=['Gather materials','Read through notes','Make summary cards','Practice recall'];
  else st=['Understand requirements','Gather resources','Create action plan','Complete work','Review and submit'];
  t.subtasks=st.map(text=>({text,done:false}));t.updated=Date.now();saveAll();renderTasks();toast(`Generated ${st.length} subtasks! ‚ú®`,'success');addXP(5,'AI Subtasks Generated');
}
function isOverdue(t){return t.due&&t.status!=='completed'&&new Date(t.due+'T00:00:00')<new Date(new Date().toDateString());}
function renderTaskBadge(){const ov=tasks.filter(isOverdue).length;const el=document.getElementById('sbBadge');if(ov>0){el.style.display='flex';el.textContent=ov;}else el.style.display='none';}
function setFilter(f,el){taskFilter=f;document.querySelectorAll('.fc').forEach(b=>b.classList.remove('active'));el.classList.add('active');renderTasks();}
function getFiltered(){
  const q=(document.getElementById('taskSearch')?.value||'').toLowerCase();
  return tasks.filter(t=>{
    const ms=!q||t.title.toLowerCase().includes(q)||(t.subject||'').toLowerCase().includes(q);
    const mf=taskFilter==='all'||(taskFilter==='completed'?t.status==='completed':taskFilter==='overdue'?isOverdue(t):t.priority===taskFilter);
    return ms&&mf;
  });
}
function saveTasks(){S(`tasks_${cu.email}`,tasks);}
let taskDragSrc=null;
function handleDragStart(e){taskDragSrc=this;e.dataTransfer.effectAllowed='move';this.style.opacity='0.4';}
function handleDragOver(e){e.preventDefault();e.dataTransfer.dropEffect='move';this.style.borderTop='2px solid var(--accent)';return false;}
function handleDragLeave(){this.style.borderTop='';}
function handleDrop(e){
  e.stopPropagation();
  if(taskDragSrc!==this){
    const allItems=Array.from(this.parentNode.children);
    const srcIdx=allItems.indexOf(taskDragSrc);
    const tgtIdx=allItems.indexOf(this);
    const temp=tasks[srcIdx];tasks[srcIdx]=tasks[tgtIdx];tasks[tgtIdx]=temp;
    saveTasks();renderTasks();
  }
  this.style.borderTop='';return false;
}
function handleDragEnd(){this.style.opacity='';this.style.borderTop='';taskDragSrc=null;}
function addDragListeners(el){
  el.setAttribute('draggable',true);
  el.addEventListener('dragstart',handleDragStart);
  el.addEventListener('dragover',handleDragOver);
  el.addEventListener('dragleave',handleDragLeave);
  el.addEventListener('drop',handleDrop);
  el.addEventListener('dragend',handleDragEnd);
}

function renderTasks(){
  const grid=document.getElementById('tasksGrid');const filtered=getFiltered();
  if(!filtered.length){grid.innerHTML=`<div class="empty-s" style="grid-column:1/-1"><span class="ei">üìã</span><div class="et">No tasks found</div><div class="es">Try adjusting filters or add a new task</div></div>`;return;}
  grid.innerHTML='';
  filtered.forEach(t=>{
    const ov=isOverdue(t),done=t.status==='completed';
    const stD=(t.subtasks||[]).filter(s=>s.done).length,stT=(t.subtasks||[]).length,stP=stT?Math.round((stD/stT)*100):0;
    const dueD=t.due?new Date(t.due+'T00:00:00'):null;const dueStr=dueD?dueD.toLocaleDateString('en-GB',{day:'numeric',month:'short'}):'';
    const card=document.createElement('div');
    card.innerHTML=`<div class="tc ph-${t.priority}${done?' done-card':''}">
<div class="tc-top">
  <div class="tc-chk${done?' ck':''}" onclick="toggleDone('${t.id}')">${done?'‚úì':''}</div>
  <div class="tc-inf">
    <div class="tc-ttl${done?' lt':''}">${E(t.title)}</div>
    <div class="tc-meta">
      <span class="pill p${t.priority.charAt(0)}">${t.priority}</span>
      ${ov?'<span class="pill po">Overdue</span>':done?'<span class="pill pd">Done</span>':t.status==='in-progress'?'<span class="pill pi">Active</span>':'<span class="pill pp">Pending</span>'}
      ${t.subject?`<span style="font-size:.72rem;color:var(--tx3)">üìö ${E(t.subject)}</span>`:''}
    </div>
    ${t.due?`<div class="tc-due${ov?' ov':''}">üìÖ ${dueStr}</div>`:''}
    ${t.notes?`<div class="tc-desc">${E(t.notes)}</div>`:''}
  </div>
  <div class="tc-acts">
    <div class="ic-btn" onclick="openEdit('${t.id}')" title="Edit">‚úé</div>
    <div class="ic-btn del" onclick="deleteTask('${t.id}')" title="Delete">‚úï</div>
  </div>
</div>
${stT?`<div class="st-list">${t.subtasks.slice(0,3).map((s,i)=>`<div class="st-item" onclick="toggleSubtask('${t.id}',${i})"><div class="st-cb${s.done?' ck':''}">${s.done?'‚úì':''}</div><span class="st-tx${s.done?' ck':''}">${E(s.text)}</span></div>`).join('')}${stT>3?`<div style="font-size:.7rem;color:var(--tx4);margin-top:3px">+${stT-3} more</div>`:''}</div>`:''}
<div class="tc-footer">
  ${stT?`<div style="flex:1;margin-right:9px"><div style="font-size:.7rem;color:var(--tx4);margin-bottom:3px">${stD}/${stT} subtasks</div><div class="st-bar-w"><div class="st-bar" style="width:${stP}%"></div></div></div>`:'<div></div>'}
  <button class="btn btn-sm btn-purple" onclick="genSubtasks('${t.id}')">‚ú® AI</button>
</div>
</div>`;
    const tc=card.firstElementChild;
    addDragListeners(tc);
    grid.appendChild(tc);
  });}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DASHBOARD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const QUOTES=[
  {text:'The secret of getting ahead is getting started.',author:'Mark Twain'},
  {text:'Success is the sum of small efforts, repeated day in and day out.',author:'Robert Collier'},
  {text:'Education is the most powerful weapon to change the world.',author:'Nelson Mandela'},
  {text:'The beautiful thing about learning is that no one can take it away from you.',author:'B.B. King'},
  {text:'Do not wait to strike till the iron is hot, but make it hot by striking.',author:'William Butler Yeats'},
  {text:'An investment in knowledge pays the best interest.',author:'Benjamin Franklin'},
  {text:'The expert in anything was once a beginner.',author:'Helen Hayes'},
  {text:'Hard work beats talent when talent doesn\'t work hard.',author:'Tim Notke'},
];
function renderDashboard(){
  const total=tasks.length,done=tasks.filter(t=>t.status==='completed').length;
  const pending=tasks.filter(t=>t.status==='pending').length,inProg=tasks.filter(t=>t.status==='in-progress').length;
  const high=tasks.filter(t=>t.priority==='high'&&t.status!=='completed').length,overdue=tasks.filter(isOverdue).length;
  const pct=total?Math.round((done/total)*100):0;
  document.getElementById('kpiRow').innerHTML=[
    {ic:'üìã',v:total,l:'Total Tasks',ch:'+'+pending+' pending'},
    {ic:'‚úÖ',v:done,l:'Completed',ch:pct+'% rate'},
    {ic:'üîÑ',v:inProg,l:'In Progress',ch:'Active now'},
    {ic:'‚è≥',v:pending,l:'Pending',ch:'To do'},
    {ic:'üî¥',v:high,l:'High Priority',ch:'Urgent'},
    {ic:'‚ö†Ô∏è',v:overdue,l:'Overdue',ch:'Past due'},
  ].map((k,i)=>`<div class="kpi" style="animation-delay:${i*.06}s"><div class="kpi-ic" style="background:var(--acc-bg)">${k.ic}</div><div class="kpi-v">${k.v}</div><div class="kpi-l">${k.l}</div><div class="kpi-chg up">${k.ch}</div></div>`).join('');
  const circ=283,off=circ-(pct/100)*circ;const ring=document.getElementById('dashRing');
  if(ring){ring.style.strokeDashoffset=off;ring.style.stroke=pct>=80?'var(--green)':pct>=50?'var(--acc)':'var(--amber)';}
  document.getElementById('ringPct').textContent=pct+'%';
  const rec=[...tasks].sort((a,b)=>b.updated-a.updated).slice(0,7);
  const rt=document.getElementById('recentTasks');
  rt.innerHTML=rec.length?rec.map(t=>{const col=t.priority==='high'?'var(--red)':t.priority==='medium'?'var(--amber)':'var(--green)';return `<div class="t-row"><div class="t-dot" style="background:${col}"></div><div class="t-info"><div class="t-title">${E(t.title)}</div><div class="t-meta">${t.subject||'General'} ¬∑ ${new Date(t.updated).toLocaleDateString()}</div></div><span class="pill ${t.status==='completed'?'pd':t.status==='in-progress'?'pi':'pp'}">${t.status}</span></div>`;}).join(''):`<div class="empty-s"><span class="ei">üìã</span><div class="et">No tasks yet</div><div class="es">Add your first task!</div></div>`;
  const subjects={};tasks.forEach(t=>{const s=t.subject||'General';if(!subjects[s])subjects[s]={t:0,d:0};subjects[s].t++;if(t.status==='completed')subjects[s].d++;});
  const topS=Object.entries(subjects).sort((a,b)=>b[1].t-a[1].t)[0];
  const quizH=G(`quizHist_${cu.email}`)||[];const avgQ=quizH.length?Math.round(quizH.reduce((s,q)=>s+(q.score/q.total*100),0)/quizH.length):null;
  document.getElementById('quickStats').innerHTML=`<div style="display:flex;flex-direction:column;gap:11px">
<div style="display:flex;justify-content:space-between;font-size:.88rem;padding:8px 0;border-bottom:1px solid var(--border)"><span style="color:var(--tx3)">Completion Rate</span><span style="font-weight:800;color:var(--acc)">${pct}%</span></div>
<div style="display:flex;justify-content:space-between;font-size:.88rem;padding:8px 0;border-bottom:1px solid var(--border)"><span style="color:var(--tx3)">Overdue Tasks</span><span style="font-weight:800;color:var(--red)">${overdue}</span></div>
<div style="display:flex;justify-content:space-between;font-size:.88rem;padding:8px 0;border-bottom:1px solid var(--border)"><span style="color:var(--tx3)">Quiz Average</span><span style="font-weight:800;color:var(--green)">${avgQ!==null?avgQ+'%':'‚Äî'}</span></div>
<div style="display:flex;justify-content:space-between;font-size:.88rem;padding:8px 0"><span style="color:var(--tx3)">Top Subject</span><span style="font-weight:800;color:var(--tx)">${topS?E(topS[0]):'-'}</span></div>
</div>`;
  renderStreak7();rebuildCharts();updateXPBar();
  // Motivational quote
  const q=QUOTES[new Date().getDate()%QUOTES.length];
  const qEl=document.getElementById('dashQuote');const aEl=document.getElementById('dashQuoteAuthor');
  if(qEl)qEl.textContent='"'+q.text+'"';if(aEl)aEl.textContent='‚Äî '+q.author;
  // Subject breakdown
  const sbEl=document.getElementById('dashSubjectBreakdown');
  if(sbEl){if(Object.keys(subjects).length){sbEl.innerHTML=Object.entries(subjects).sort((a,b)=>b[1].t-a[1].t).slice(0,5).map(([s,v])=>{const p=Math.round((v.d/v.t)*100);return `<div style="margin-bottom:13px"><div style="display:flex;justify-content:space-between;font-size:.88rem;font-weight:700;margin-bottom:5px;color:var(--tx2)"><span>${E(s)}</span><span style="color:var(--acc)">${p}%</span></div><div class="sb-track"><div class="sb-fill" style="width:${p}%"></div></div></div>`;}).join('');}else sbEl.innerHTML=`<div style="color:var(--tx3);font-size:.9rem;padding:20px 0">No tasks yet ‚Äî add some to see breakdown!</div>`;}
  // Insights
  const insEl=document.getElementById('dashInsights');
  if(insEl){
    const insights=[];
    if(overdue>0)insights.push({icon:'‚ö†Ô∏è',bg:'var(--red-bg)',title:`${overdue} overdue task${overdue>1?'s':''}`,text:'These need immediate attention! Complete them to clear your backlog.'});
    if(getCurStreak()>=3)insights.push({icon:'üî•',bg:'var(--amber-bg)',title:`${getCurStreak()}-day streak!`,text:'Amazing consistency! Keep studying daily to maintain your momentum.'});
    if(pct>=80)insights.push({icon:'üèÜ',bg:'var(--green-bg)',title:'Excellent completion rate!',text:'You\'re completing '+pct+'% of your tasks. Keep up the great work!'});
    if(quizH.length>=3&&avgQ>=80)insights.push({icon:'üß†',bg:'var(--purple-bg)',title:'Top quiz performer!',text:'Your '+avgQ+'% quiz average puts you in the top tier. Consider teaching others.'});
    if(!insights.length)insights.push({icon:'üí°',bg:'var(--acc-bg)',title:'Getting started',text:'Add tasks, take quizzes, and study daily to unlock personalised insights!'});
    insEl.innerHTML=insights.slice(0,3).map(i=>`<div class="insight-card"><div class="insight-icon" style="background:${i.bg}">${i.icon}</div><div><div class="insight-title">${i.title}</div><div class="insight-text">${i.text}</div></div></div>`).join('');
  }
  // Upcoming in 7 days
  const upEl=document.getElementById('dashUpcoming');
  if(upEl){const in7=new Date(Date.now()+7*86400000);const up=tasks.filter(t=>t.due&&t.status!=='completed'&&new Date(t.due+'T00:00:00')<=in7).sort((a,b)=>new Date(a.due)-new Date(b.due)).slice(0,5);upEl.innerHTML=up.length?up.map(t=>`<div class="t-row"><div class="t-dot" style="background:${t.priority==='high'?'var(--red)':t.priority==='medium'?'var(--amber)':'var(--green)'}"></div><div class="t-info"><div class="t-title">${E(t.title)}</div><div class="t-meta">${t.subject||'General'} ¬∑ Due ${new Date(t.due+'T00:00:00').toLocaleDateString('en-GB',{day:'numeric',month:'short'})}</div></div><span class="pill p${t.priority.charAt(0)}">${t.priority}</span></div>`).join(''):`<div style="text-align:center;padding:20px;color:var(--tx3);font-size:.9rem">üéâ No deadlines in the next 7 days!</div>`;}
  // TODAY'S SCHEDULE
  const todaySch=document.getElementById('todaySchedule');
  if(todaySch){
    const todayStr=new Date().toISOString().split('T')[0];
    const todayT=tasks.filter(t=>t.due===todayStr&&t.status!=='completed');
    const slots=['6:00 AM','8:00 AM','10:00 AM','12:00 PM','2:00 PM','4:00 PM','6:00 PM','8:00 PM'];
    todaySch.innerHTML=todayT.length?todayT.map((t,i)=>`
      <div style="display:flex;align-items:center;gap:14px;padding:12px 0;border-bottom:1px solid var(--border)">
        <div style="width:70px;font-size:.75rem;font-weight:800;color:var(--tx4);flex-shrink:0">${slots[i%slots.length]}</div>
        <div style="width:3px;height:36px;border-radius:2px;background:${t.priority==='high'?'var(--red)':t.priority==='medium'?'var(--amber)':'var(--green)'};flex-shrink:0"></div>
        <div style="flex:1"><div style="font-weight:800;font-size:.9rem;color:var(--tx)">${E(t.title)}</div><div style="font-size:.75rem;color:var(--tx3)">${t.subject||'General'} ¬∑ ${t.priority} priority</div></div>
        <span class="pill p${t.priority.charAt(0)}">${t.priority}</span>
      </div>`).join('')
    :`<div style="text-align:center;padding:22px;color:var(--tx3);font-size:.9rem">‚úÖ No tasks scheduled for today!</div>`;
  }

  // SUBJECT PROGRESS RINGS
  const ringRow=document.getElementById('subjectRingRow');
  if(ringRow){
    const subjs={};tasks.forEach(t=>{const s=t.subject||'General';if(!subjs[s])subjs[s]={t:0,d:0};subjs[s].t++;if(t.status==='completed')subjs[s].d++;});
    const colors=['var(--acc)','var(--purple)','var(--green)','var(--amber)','var(--teal)','var(--pink)'];
    ringRow.innerHTML=Object.entries(subjs).slice(0,6).map(([s,v],i)=>{
      const pct=Math.round((v.d/v.t)*100);const circ=2*Math.PI*28;const off=circ-(pct/100)*circ;
      return `<div class="card" style="text-align:center;padding:20px;cursor:default">
        <div style="position:relative;width:70px;height:70px;margin:0 auto 12px">
          <svg viewBox="0 0 70 70" width="70" height="70" style="transform:rotate(-90deg)">
            <circle cx="35" cy="35" r="28" fill="none" stroke="var(--surface2)" stroke-width="7"/>
            <circle cx="35" cy="35" r="28" fill="none" stroke="${colors[i]}" stroke-width="7" stroke-linecap="round" stroke-dasharray="${circ}" stroke-dashoffset="${off}" style="transition:stroke-dashoffset 1.2s ease"/>
          </svg>
          <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:.9rem;color:var(--tx)">${pct}%</div>
        </div>
        <div style="font-weight:800;font-size:.82rem;color:var(--tx);margin-bottom:3px">${E(s)}</div>
        <div style="font-size:.72rem;color:var(--tx3)">${v.d}/${v.t} done</div>
      </div>`;
    }).join('');
  }

  // RECENT QUIZ
  const rqEl=document.getElementById('dashRecentQuiz');
  if(rqEl){
    const quizH2=G(`quizHist_${cu.email}`)||[];
    rqEl.innerHTML=quizH2.length?quizH2.slice(-5).reverse().map(q=>{
      const p=Math.round(q.score/q.total*100);
      const bar=`<div style="flex:1;height:8px;background:var(--surface2);border-radius:4px;overflow:hidden;margin:0 12px"><div style="height:100%;width:${p}%;background:${p>=80?'var(--green)':p>=60?'var(--amber)':'var(--red)'};border-radius:4px;transition:width 1s ease"></div></div>`;
      return `<div style="display:flex;align-items:center;gap:11px;padding:11px 0;border-bottom:1px solid var(--border)">
        <div style="width:28px;height:28px;border-radius:9px;background:var(--acc-bg);display:flex;align-items:center;justify-content:center;font-size:.9rem">${QUIZ_DATA[q.subject]?.icon||'üß†'}</div>
        <div style="min-width:110px;font-weight:700;font-size:.88rem;color:var(--tx)">${E(q.subject)}</div>
        ${bar}
        <div style="font-weight:900;font-size:.88rem;min-width:40px;text-align:right;color:${p>=80?'var(--green)':p>=60?'var(--amber)':'var(--red)'}">${p}%</div>
      </div>`;
    }).join('')
    :`<div style="text-align:center;padding:22px;color:var(--tx3);font-size:.9rem">üß† No quizzes yet ‚Äî <span style="color:var(--acc);cursor:pointer;font-weight:700" onclick="navigate('quiz')">Take your first quiz!</span></div>`;
  }

  // FLASHCARD REMINDER
  const fcRem=document.getElementById('dashFlashContent');
  if(fcRem){
    const allFC=G(`flashcards_${cu.email}`)||[];const dueFC=allFC.filter(c=>c.nextReview<=Date.now());
    fcRem.innerHTML=dueFC.length?`
      <div style="display:flex;align-items:center;gap:16px;padding:16px;background:var(--acc-bg);border-radius:var(--r);border:1px solid rgba(61,90,254,.2)">
        <div style="font-size:2.2rem">üÉè</div>
        <div style="flex:1"><div style="font-weight:900;font-size:1rem;color:var(--tx)">${dueFC.length} card${dueFC.length>1?'s':''} due for review</div><div style="font-size:.82rem;color:var(--tx3);margin-top:3px">Review now for maximum retention!</div></div>
        <button class="btn btn-p btn-sm" onclick="navigate('flashcards')">Review ‚Üí</button>
      </div>`
    :`<div style="text-align:center;padding:18px;color:var(--tx3);font-size:.9rem">‚úÖ All caught up! No cards due.</div>`;
  }

  // XP WEEK CHART
  setTimeout(()=>{
    const xpWc=document.getElementById('xpWeekChart');
    if(xpWc){
      const days=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
      const today2=new Date().getDay()||7;
      const wdata=days.map((_,i)=>{
        const dt=new Date(Date.now()-(today2-(i+1))*86400000);
        return tasks.filter(t=>t.status==='completed'&&new Date(t.updated).toDateString()===dt.toDateString()).length*20;
      });
      const cs2=getComputedStyle(document.documentElement);
      if(window._xpWChart)window._xpWChart.destroy();
      window._xpWChart=new Chart(xpWc,{type:'bar',data:{labels:days,datasets:[{data:wdata,backgroundColor:cs2.getPropertyValue('--acc').trim()+'55',borderColor:cs2.getPropertyValue('--acc').trim(),borderWidth:2,borderRadius:8}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:{color:cs2.getPropertyValue('--tx3').trim(),font:{size:11}},grid:{display:false}},y:{ticks:{color:cs2.getPropertyValue('--tx3').trim(),stepSize:20,font:{size:11}},grid:{color:cs2.getPropertyValue('--border').trim()}}}}});
    }
  },200);

  // SUBJECT TABLE
  const stEl=document.getElementById('dashSubjectTable');
  if(stEl){
    const subjs2={};tasks.forEach(t=>{const s=t.subject||'General';if(!subjs2[s])subjs2[s]={total:0,done:0,high:0,overdue:0};subjs2[s].total++;if(t.status==='completed')subjs2[s].done++;if(t.priority==='high')subjs2[s].high++;if(isOverdue(t))subjs2[s].overdue++;});
    stEl.innerHTML=Object.keys(subjs2).length?`
      <div style="overflow-x:auto">
        <table style="width:100%;border-collapse:collapse;font-size:.88rem">
          <thead><tr style="border-bottom:2px solid var(--border)">
            <th style="text-align:left;padding:10px 12px;color:var(--tx3);font-weight:800;font-size:.76rem;text-transform:uppercase;letter-spacing:.5px">Subject</th>
            <th style="text-align:center;padding:10px 12px;color:var(--tx3);font-weight:800;font-size:.76rem;text-transform:uppercase">Total</th>
            <th style="text-align:center;padding:10px 12px;color:var(--tx3);font-weight:800;font-size:.76rem;text-transform:uppercase">Done</th>
            <th style="text-align:center;padding:10px 12px;color:var(--tx3);font-weight:800;font-size:.76rem;text-transform:uppercase">High</th>
            <th style="text-align:center;padding:10px 12px;color:var(--tx3);font-weight:800;font-size:.76rem;text-transform:uppercase">Overdue</th>
            <th style="text-align:center;padding:10px 12px;color:var(--tx3);font-weight:800;font-size:.76rem;text-transform:uppercase">Rate</th>
          </tr></thead>
          <tbody>${Object.entries(subjs2).map(([s,v])=>{
            const r=Math.round((v.done/v.total)*100);
            return `<tr style="border-bottom:1px solid var(--border);transition:background .15s" onmouseover="this.style.background='var(--surface2)'" onmouseout="this.style.background=''">
              <td style="padding:12px;font-weight:700;color:var(--tx)">${E(s)}</td>
              <td style="padding:12px;text-align:center;color:var(--tx2)">${v.total}</td>
              <td style="padding:12px;text-align:center;color:var(--green);font-weight:800">${v.done}</td>
              <td style="padding:12px;text-align:center;color:var(--red)">${v.high}</td>
              <td style="padding:12px;text-align:center;color:${v.overdue>0?'var(--red)':'var(--tx3)'};font-weight:${v.overdue>0?800:400}">${v.overdue}</td>
              <td style="padding:12px;text-align:center"><span style="padding:4px 10px;border-radius:100px;font-size:.75rem;font-weight:900;background:${r>=80?'var(--green-bg)':r>=50?'var(--amber-bg)':'var(--red-bg)'};color:${r>=80?'var(--green)':r>=50?'var(--amber)':'var(--red)'}">${r}%</span></td>
            </tr>`;
          }).join('')}</tbody>
        </table>
      </div>`
    :`<div style="text-align:center;padding:22px;color:var(--tx3);font-size:.9rem">Add tasks with subjects to see breakdown!</div>`;
  }

  // RECENT BADGES
  const dbEl=document.getElementById('dashBadgesRow');
  if(dbEl){
    const unlocked2=getUnlockedBadges();
    const recentB=BADGES.filter(b=>unlocked2.includes(b.id)).slice(-6);
    dbEl.innerHTML=recentB.length?recentB.reverse().map(b=>`
      <div style="background:linear-gradient(135deg,var(--amber-bg),var(--surface));border:1.5px solid var(--amber-border);border-radius:var(--r);padding:16px;text-align:center;transition:transform .2s" onmouseover="this.style.transform='translateY(-4px)'" onmouseout="this.style.transform=''">
        <div style="font-size:1.8rem;margin-bottom:6px">${b.emoji}</div>
        <div style="font-weight:800;font-size:.8rem;color:var(--tx)">${b.name}</div>
        <div style="font-size:.7rem;color:var(--amber);font-weight:700;margin-top:3px">+${b.xp} XP</div>
      </div>`).join('')
    :`<div style="grid-column:1/-1;text-align:center;padding:22px;color:var(--tx3);font-size:.9rem">üéñÔ∏è Complete tasks to earn badges!</div>`;
  }

  // RECENT NOTES
  const rnEl=document.getElementById('dashRecentNotes');
  if(rnEl){
    rnEl.innerHTML=notes.length?notes.slice(0,4).map(n=>`
      <div class="note-card" onclick="navigate('notes')" style="cursor:pointer">
        <div class="note-title">${E(n.title||'Untitled')}</div>
        <div class="note-preview">${E(n.content||'No content')}</div>
        <div class="note-footer"><span class="note-date">üìÖ ${new Date(n.updated||n.created).toLocaleDateString()}</span>${n.subject?`<span class="note-subj-tag">${E(n.subject)}</span>`:''}</div>
      </div>`).join('')
    :`<div style="grid-column:1/-1;text-align:center;padding:22px;color:var(--tx3);font-size:.9rem">üìù No notes yet ‚Äî <span style="color:var(--acc);cursor:pointer;font-weight:700" onclick="navigate('notes')">Create your first note!</span></div>`;
  }

  // MOTIVATIONAL CARD
  const xp2=getXP();const lv2=getLvl(xp2);
  const msgs=[{m:'You\'re crushing it! üî•',s:'Your dedication is building something great. Keep the momentum going!'},{m:'Every task completed is a win! üèÜ',s:'Consistency beats intensity. You\'re proving that every single day.'},{m:'Knowledge compounds! üìà',s:'Every hour you study today makes tomorrow\'s learning easier.'},{m:'You\'re in the top tier! ‚≠ê',s:'Students who track their progress consistently score 40% higher.'}];
  const mv=msgs[new Date().getDate()%msgs.length];
  const mmEl=document.getElementById('dashMotivMsg');const msEl=document.getElementById('dashMotivSub');const mxEl=document.getElementById('dashMotivXP');
  if(mmEl)mmEl.textContent=mv.m;if(msEl)msEl.textContent=mv.s;if(mxEl)mxEl.textContent=xp2;

  // TIPS GRID
  const tgEl=document.getElementById('dashTipsGrid');
  const TIPS_GRID=[{ic:'üß†',title:'Active Recall',tip:'Close your notes and write everything you remember. This is 2√ó more effective than re-reading.'},{ic:'‚è∞',title:'Spaced Repetition',tip:'Review material after 1 day, 3 days, 1 week, then 1 month for maximum long-term retention.'},{ic:'üéØ',title:'Single Tasking',tip:'Focus on ONE subject per session. Multitasking reduces learning efficiency by up to 40%.'},{ic:'üí§',title:'Sleep to Learn',tip:'Your brain consolidates memories during deep sleep. 7-8 hours before exams is non-negotiable.'},{ic:'üìù',title:'Feynman Technique',tip:'Explain a concept as if teaching a 10-year-old. If you can\'t simplify it, you don\'t understand it yet.'},{ic:'üåä',title:'Flow State',tip:'Remove all distractions for 25 minutes. It takes ~23 minutes to regain focus after interruption.'}];
  if(tgEl)tgEl.innerHTML=TIPS_GRID.map(t=>`
    <div style="display:flex;gap:13px;padding:15px;background:var(--surface2);border-radius:var(--r);border:1px solid var(--border);transition:transform .2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform=''">
      <div style="width:42px;height:42px;border-radius:13px;background:var(--acc-bg);display:flex;align-items:center;justify-content:center;font-size:1.2rem;flex-shrink:0">${t.ic}</div>
      <div><div style="font-weight:800;font-size:.88rem;color:var(--tx);margin-bottom:4px">${t.title}</div><div style="font-size:.8rem;color:var(--tx3);line-height:1.6">${t.tip}</div></div>
    </div>`).join('');
}
function renderStreak7(){
  const s=getStreakData();const days=[];
  for(let i=6;i>=0;i--){const d=new Date(Date.now()-i*86400000);days.push({label:d.toLocaleDateString('en',{weekday:'short'}).slice(0,2),done:!!s[d.toDateString()],today:i===0});}
  let streak=0;for(let i=0;i<7;i++){if(days[6-i].done)streak++;else if(i>0)break;}
  document.getElementById('streakNum').textContent=streak+'üî•';
  document.getElementById('streakDays').innerHTML=days.map(d=>`<div class="s-day"><div class="s-pip${d.done?' on':''}${d.today?' today-pip':''}"></div><div class="s-lbl">${d.label}</div></div>`).join('');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CHARTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function rebuildCharts(){
  const done=tasks.filter(t=>t.status==='completed').length,inProg=tasks.filter(t=>t.status==='in-progress').length,pending=tasks.filter(t=>t.status==='pending').length;
  const cs=getComputedStyle(document.documentElement);
  const acc=cs.getPropertyValue('--acc').trim(),green=cs.getPropertyValue('--green').trim(),s2=cs.getPropertyValue('--surface2').trim(),tx3=cs.getPropertyValue('--tx3').trim(),bd=cs.getPropertyValue('--border').trim();
  if(donut)donut.destroy();
  const dc=document.getElementById('donutChart');
  if(dc)donut=new Chart(dc,{type:'doughnut',data:{labels:['Done','Active','Pending'],datasets:[{data:[done,inProg,pending],backgroundColor:[green,acc,s2],borderWidth:0,hoverOffset:7}]},options:{responsive:true,maintainAspectRatio:false,cutout:'70%',plugins:{legend:{position:'bottom',labels:{color:tx3,padding:11,font:{size:11,family:'Plus Jakarta Sans'}}}}}});
  const weeks=['Mo','Tu','We','Th','Fr','Sa','Su'];
  const wc=weeks.map((_,i)=>{const d=new Date();const day=d.getDay()||7;const diff=(i+1)-day;const td=new Date(d.getTime()+diff*86400000);return tasks.filter(t=>t.status==='completed'&&new Date(t.updated).toDateString()===td.toDateString()).length;});
  if(bar)bar.destroy();
  const bc=document.getElementById('barChart');
  if(bc)bar=new Chart(bc,{type:'bar',data:{labels:weeks,datasets:[{data:wc,backgroundColor:acc+'40',borderColor:acc,borderWidth:2,borderRadius:9}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:{color:tx3,font:{size:11}},grid:{display:false}},y:{ticks:{color:tx3,stepSize:1,font:{size:11}},grid:{color:bd}}}}});
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê UPCOMING ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderUpcoming(){
  const today=new Date(),in14=new Date(Date.now()+14*86400000);
  const up=tasks.filter(t=>t.due&&t.status!=='completed'&&new Date(t.due+'T00:00:00')<=in14).sort((a,b)=>new Date(a.due)-new Date(b.due));
  const tl=document.getElementById('upcomingTl');
  if(!up.length){tl.innerHTML=`<div class="empty-s"><span class="ei">üéâ</span><div class="et">All clear!</div><div class="es">No deadlines in the next 14 days</div></div>`;return;}
  const groups={};
  up.forEach(t=>{const d=new Date(t.due+'T00:00:00');const ov=d<today&&d.toDateString()!==today.toDateString();const tod=d.toDateString()===today.toDateString();const lbl=ov?'‚ö†Ô∏è Overdue':tod?'üìç Today':d.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'});if(!groups[lbl])groups[lbl]=[];groups[lbl].push(t);});
  tl.innerHTML=Object.entries(groups).map(([lbl,grp])=>`<div class="tl-group"><div class="tl-lbl">${lbl}</div>${grp.map(t=>`<div class="tl-it"><div class="tl-ind" style="background:${t.priority==='high'?'var(--red)':t.priority==='medium'?'var(--amber)':'var(--green)'}"></div><div class="tl-inf"><div class="tl-t">${E(t.title)}</div><div class="tl-s">${t.subject?E(t.subject)+' ¬∑ ':''}${t.priority} priority</div></div><span class="pill p${t.priority.charAt(0)}">${t.priority}</span></div>`).join('')}</div>`).join('');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PERFORMANCE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderPerf(){
  const total=tasks.length,done=tasks.filter(t=>t.status==='completed').length;
  const high=tasks.filter(t=>t.priority==='high').length,highDone=tasks.filter(t=>t.priority==='high'&&t.status==='completed').length;
  const ov=tasks.filter(isOverdue).length,rate=total?Math.round((done/total)*100):0;
  const grade=rate>=90?'A+':rate>=80?'A':rate>=70?'B':rate>=60?'C':'D';
  const quizH=G(`quizHist_${cu.email}`)||[];const avgQ=quizH.length?Math.round(quizH.reduce((s,q)=>s+(q.score/q.total*100),0)/quizH.length):0;
  document.getElementById('perfStats').innerHTML=[{v:rate+'%',l:'Completion Rate'},{v:`${highDone}/${high}`,l:'High Priority Done'},{v:ov,l:'Overdue'},{v:grade,l:'Grade'},{v:avgQ+'%',l:'Quiz Average'},{v:quizH.length,l:'Quizzes Taken'}].map((s,i)=>`<div class="ps" style="animation:fadeUp .3s ease ${i*.07}s both"><div class="ps-v">${s.v}</div><div class="ps-l">${s.l}</div></div>`).join('');
  const subjects={};tasks.forEach(t=>{const s=t.subject||'General';if(!subjects[s])subjects[s]={t:0,d:0};subjects[s].t++;if(t.status==='completed')subjects[s].d++;});
  document.getElementById('subjBars').innerHTML=Object.entries(subjects).length?Object.entries(subjects).sort((a,b)=>b[1].t-a[1].t).map(([s,v])=>{const p=Math.round((v.d/v.t)*100);return `<div class="subj-bar"><div class="sb-row"><span>${E(s)}</span><span>${v.d}/${v.t} (${p}%)</span></div><div class="sb-track"><div class="sb-fill" style="width:${p}%"></div></div></div>`;}).join(''):'<div style="color:var(--tx3);font-size:.9rem">No subject data yet.</div>';
  const s=getStreakData();
  document.getElementById('heatmap').innerHTML=Array(28).fill(0).map((_,i)=>{const d=new Date(Date.now()-(27-i)*86400000);const cnt=tasks.filter(t=>t.status==='completed'&&new Date(t.updated).toDateString()===d.toDateString()).length;const lvl=cnt>=3?3:cnt>=2?2:cnt>=1?1:0;return `<div class="hm${lvl?` hm${lvl}`:''}" title="${d.toLocaleDateString()}: ${cnt} tasks"></div>`;}).join('');
  // Performance insights
  const piEl=document.getElementById('perfInsights');
  if(piEl){
    const ins=[];
    if(quizH.length>0){const best=quizH.reduce((a,b)=>b.score/b.total>a.score/a.total?b:a);ins.push({icon:'üèÜ',bg:'var(--green-bg)',title:'Best quiz: '+best.subject,text:best.score+'/'+best.total+' ('+Math.round(best.score/best.total*100)+'%). Taken on '+new Date(best.date).toLocaleDateString()+'.'});}
    const subjs=Object.entries(subjects);if(subjs.length>1){const worst=subjs.sort((a,b)=>(a[1].d/a[1].t)-(b[1].d/b[1].t))[0];ins.push({icon:'üìà',bg:'var(--amber-bg)',title:'Focus on '+worst[0],text:'Your completion rate for this subject is '+Math.round((worst[1].d/worst[1].t)*100)+'%. Allocate more study time here.'});}
    if(rate>=80)ins.push({icon:'‚≠ê',bg:'var(--acc-bg)',title:'High performer!',text:'Your '+rate+'% task completion rate is excellent. You are in the top tier of students.'});
    if(!ins.length)ins.push({icon:'üí°',bg:'var(--acc-bg)',title:'Build your history',text:'Complete more tasks and quizzes to unlock detailed performance insights.'});
    piEl.innerHTML=ins.slice(0,3).map(i=>`<div class="insight-card"><div class="insight-icon" style="background:${i.bg}">${i.icon}</div><div><div class="insight-title">${i.title}</div><div class="insight-text">${i.text}</div></div></div>`).join('');
  }
  // Perf charts
  const cs=getComputedStyle(document.documentElement);
  const acc=cs.getPropertyValue('--acc').trim(),red=cs.getPropertyValue('--red').trim(),amber=cs.getPropertyValue('--amber').trim(),tx3=cs.getPropertyValue('--tx3').trim(),bd=cs.getPropertyValue('--border').trim();
  if(perfPie)perfPie.destroy();
  const ppc=document.getElementById('perfPieChart');
  if(ppc){const hp=tasks.filter(t=>t.priority==='high').length,mp=tasks.filter(t=>t.priority==='medium').length,lp=tasks.filter(t=>t.priority==='low').length;perfPie=new Chart(ppc,{type:'pie',data:{labels:['High','Medium','Low'],datasets:[{data:[hp,mp,lp],backgroundColor:[red,amber,cs.getPropertyValue('--green').trim()],borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{color:tx3,font:{size:11,family:'Plus Jakarta Sans'},padding:10}}}}});}
  if(perfLine)perfLine.destroy();
  const plc=document.getElementById('perfLineChart');
  if(plc){const weeks=['4w ago','3w ago','2w ago','Last week'];const wdata=weeks.map((_,i)=>{const start=Date.now()-(4-i)*7*86400000,end=start+7*86400000;return tasks.filter(t=>t.status==='completed'&&t.updated>=start&&t.updated<end).length;});perfLine=new Chart(plc,{type:'line',data:{labels:weeks,datasets:[{data:wdata,borderColor:acc,backgroundColor:acc+'25',borderWidth:2.5,pointRadius:5,pointBackgroundColor:acc,fill:true,tension:.4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:{color:tx3,font:{size:11}},grid:{display:false}},y:{ticks:{color:tx3,stepSize:1,font:{size:11}},grid:{color:bd}}}}});}
  const qhEl=document.getElementById('quizHistory');
  qhEl.innerHTML=quizH.length?quizH.slice(-8).reverse().map(q=>{const p=Math.round(q.score/q.total*100);return `<div class="t-row"><div class="t-dot" style="background:${p>=80?'var(--green)':p>=60?'var(--amber)':'var(--red)'}"></div><div class="t-info"><div class="t-title">${E(q.subject)}</div><div class="t-meta">${q.score}/${q.total} correct ¬∑ ${new Date(q.date).toLocaleDateString()}</div></div><span style="font-family:var(--font-d);font-weight:900;color:${p>=80?'var(--green)':p>=60?'var(--amber)':'var(--red)'}">${p}%</span></div>`;}).join(''):`<div class="empty-s"><span class="ei">üß†</span><div class="et">No quizzes yet</div><div class="es">Take a quiz to see your history</div></div>`;

  // Quiz subject bar chart
  if(quizH.length){
    const subjScores={};
    quizH.forEach(q=>{if(!subjScores[q.subject])subjScores[q.subject]={total:0,count:0};subjScores[q.subject].total+=Math.round(q.score/q.total*100);subjScores[q.subject].count++;});
    const labels=Object.keys(subjScores);const vals=labels.map(s=>Math.round(subjScores[s].total/subjScores[s].count));
    const colors=vals.map(v=>v>=80?'rgba(21,163,82,.85)':v>=60?'rgba(217,119,6,.85)':'rgba(224,49,49,.85)');
    const qsc=document.getElementById('quizSubjChart');
    if(qsc){if(window._qSubjChart)window._qSubjChart.destroy();window._qSubjChart=new Chart(qsc,{type:'bar',data:{labels,datasets:[{data:vals,backgroundColor:colors,borderRadius:8,borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>`Average: ${c.raw}%`}}},scales:{x:{ticks:{color:tx3,font:{size:11}},grid:{display:false}},y:{min:0,max:100,ticks:{color:tx3,font:{size:11},callback:v=>v+'%'},grid:{color:bd}}}}});}
  } else {
    const qsc=document.getElementById('quizSubjChart');if(qsc){qsc.parentElement.innerHTML='<div style="display:flex;align-items:center;justify-content:center;height:240px;color:var(--tx3);font-size:.9rem">Take quizzes to see subject-wise performance</div>';}
  }
  // Department rank card
  const drc=document.getElementById('deptRankCard');
  if(drc){
    const users=G('sb_users')||{};const myDept=cu.dept||'OTHER';
    const deptUsers=Object.values(users).filter(u=>u.dept===myDept&&u.email!==cu.email);
    const myXP=G(`xp_${cu.email}`)||0;
    const betterCount=deptUsers.filter(u=>(G(`xp_${u.email}`)||0)>myXP).length;
    const totalInDept=deptUsers.length+1;const myRank=betterCount+1;
    const pct=totalInDept>1?Math.round(((totalInDept-myRank)/Math.max(1,totalInDept-1))*100):100;
    const deptLabel=DEPT_LABELS[myDept]||'Your Department';
    drc.innerHTML=`<div style="display:flex;align-items:center;gap:18px;flex-wrap:wrap">
      <div style="text-align:center;min-width:80px"><div style="font-family:var(--font-d);font-weight:900;font-size:2.5rem;color:var(--acc)">#${myRank}</div><div style="font-size:.78rem;color:var(--tx3)">in ${deptLabel}</div></div>
      <div style="flex:1">
        <div style="font-weight:700;color:var(--tx);margin-bottom:8px">You rank #${myRank} out of ${totalInDept} ${deptLabel} students with <span style="color:var(--acc)">${myXP} XP</span></div>
        <div style="background:var(--surface2);border-radius:100px;height:10px;overflow:hidden"><div style="height:100%;background:linear-gradient(90deg,var(--acc),var(--purple));border-radius:100px;width:${pct}%;transition:width .6s"></div></div>
        <div style="font-size:.78rem;color:var(--tx3);margin-top:5px">Top ${pct > 0 ? 100-pct+1 : 100}% of your department ¬∑ <span style="color:var(--purple);cursor:pointer;font-weight:700" onclick="navigate('deptLeader')">View Full Leaderboard ‚Üí</span></div>
      </div>
    </div>`;
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STREAKS PAGE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderStreaks(){
  renderCal();const s=getStreakData();const days=Object.keys(s);
  let best=0,tmp=0,prev=null;const sorted=[...days].sort();sorted.forEach(d=>{const dt=new Date(d);if(prev&&(dt-prev)===86400000){tmp++;best=Math.max(best,tmp);}else tmp=1;prev=dt;});
  const tw=[...Array(7)].filter((_,i)=>{const d=new Date(Date.now()-i*86400000).toDateString();return s[d];}).length;
  const cs=getCurStreak();document.getElementById('curStreak').textContent=cs;document.getElementById('bestStreak').textContent=Math.max(best,cs);document.getElementById('totalDays').textContent=days.length;document.getElementById('thisWeek').textContent=tw;
  // Streak banner
  const bv=document.getElementById('streakBannerVal');const bs=document.getElementById('streakBannerSub');
  if(bv)bv.textContent=cs>0?cs+'-day streak!':'No streak yet';
  if(bs)bs.textContent=cs>=7?'Outstanding! You\'re in the top 10% of students!':cs>=3?'Great momentum! Keep it going!':cs>0?'Keep studying daily to build your streak!':'Start studying today to begin your streak!';
  // Milestones
  const milestones=[{days:3,label:'3-Day Starter',emoji:'üå±'},{days:7,label:'Week Warrior',emoji:'üî•'},{days:14,label:'Two Weeks Strong',emoji:'üí™'},{days:30,label:'Monthly Master',emoji:'üèÜ'},{days:100,label:'Century Scholar',emoji:'üíé'}];
  const msEl=document.getElementById('streakMilestones');
  if(msEl)msEl.innerHTML=milestones.map(m=>`<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border)"><span style="font-size:1.2rem">${cs>=m.days?m.emoji:'‚¨ú'}</span><div style="flex:1"><div style="font-size:.85rem;font-weight:700;color:${cs>=m.days?'var(--tx)':'var(--tx3)'}">${m.label}</div></div><span style="font-size:.78rem;font-weight:800;color:${cs>=m.days?'var(--green)':'var(--tx4)'}">${cs>=m.days?'‚úÖ Done':m.days+' days'}</span></div>`).join('');
  renderGoals();
  // Weekly study summary
  const wsEl=document.getElementById('weeklyStudySummary');
  if(wsEl){const days2=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];const today=new Date().getDay()||7;wsEl.innerHTML=`<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:6px">${days2.map((d,i)=>{const dt=new Date(Date.now()-(today-(i+1))*86400000);const isDone=!!s[dt.toDateString()];return `<div style="text-align:center"><div style="font-size:.7rem;color:var(--tx3);font-weight:700;margin-bottom:5px">${d}</div><div style="height:36px;border-radius:8px;background:${isDone?'var(--acc)':'var(--surface2)'};display:flex;align-items:center;justify-content:center;font-size:.85rem">${isDone?'‚úì':''}</div></div>`;}).join('')}</div>`;}
}
function renderCal(){
  const s=getStreakData();const today=new Date();const firstDay=new Date(calYear,calMonth,1).getDay();const dim=new Date(calYear,calMonth+1,0).getDate();
  document.getElementById('calMonthLbl').textContent=new Date(calYear,calMonth).toLocaleDateString('en-US',{month:'long',year:'numeric'});
  const dns=['Su','Mo','Tu','We','Th','Fr','Sa'];let h=dns.map(d=>`<div class="cal-dn">${d}</div>`).join('');
  for(let i=0;i<firstDay;i++)h+=`<div class="cal-cell other-m"></div>`;
  for(let d=1;d<=dim;d++){
    const dt=new Date(calYear,calMonth,d);const ds=dt.toDateString();
    const isToday=ds===today.toDateString();const studied=!!s[ds];
    const hasTasks=tasks.some(t=>t.due===`${calYear}-${String(calMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`);
    h+=`<div class="cal-cell${studied?' studied':''}${isToday?' today-cell':''}${hasTasks?' has-t':''}">${d}</div>`;
  }
  document.getElementById('calGrid').innerHTML=h;
}
function calPrev(){calMonth--;if(calMonth<0){calMonth=11;calYear--;}renderCal();}
function calNext(){calMonth++;if(calMonth>11){calMonth=0;calYear++;}renderCal();}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GOALS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function openGoalModal(){document.getElementById('goalSubj').value='';document.getElementById('goalDesc').value='';document.getElementById('goalTarget').value='';document.getElementById('goalDone').value='';document.getElementById('goalModal').classList.add('show');}
function saveGoal(){
  const subj=document.getElementById('goalSubj').value.trim();const desc=document.getElementById('goalDesc').value.trim();const target=parseFloat(document.getElementById('goalTarget').value)||10;const done=parseFloat(document.getElementById('goalDone').value)||0;
  if(!subj)return toast('Subject is required.','error');
  goals.push({id:Date.now().toString(),subj,desc,target,done,created:Date.now()});saveAll();closeModal('goalModal');toast('Goal added!','success');addXP(10,'Goal Created');renderGoals();checkBadges();
}
function renderGoals(){
  const grid=document.getElementById('goalsGrid');if(!grid)return;
  if(!goals.length){grid.innerHTML=`<div class="empty-s" style="grid-column:1/-1"><span class="ei">üéØ</span><div class="et">No goals yet</div><div class="es">Add a subject goal to track progress</div></div>`;return;}
  grid.innerHTML=goals.map(g=>{const pct=Math.min(100,Math.round((g.done/g.target)*100));return `<div class="goal-card"><div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:6px"><div class="goal-name">${E(g.subj)}</div><div class="ic-btn del" onclick="deleteGoal('${g.id}')">‚úï</div></div>${g.desc?`<div style="font-size:.8rem;color:var(--tx3);margin-bottom:9px">${E(g.desc)}</div>`:''}<div class="goal-bar-w"><div class="goal-bar" style="width:${pct}%"></div></div><div class="goal-meta"><span>${g.done}h done</span><span>${g.target}h target</span><span style="color:var(--acc);font-weight:900">${pct}%</span></div></div>`;}).join('');
}
function deleteGoal(id){goals=goals.filter(g=>g.id!==id);saveAll();renderGoals();}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê QUIZ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const QUIZ_DATA={
  Mathematics:{icon:'üìê',color:'#EEF1FF',questions:[
    {q:'What is the derivative of sin(x)?',opts:['cos(x)','-cos(x)','tan(x)','-sin(x)'],ans:0,exp:'The derivative of sin(x) is cos(x). This is a fundamental differentiation rule.'},
    {q:'Solve: 2x + 5 = 13. What is x?',opts:['3','4','5','6'],ans:1,exp:'2x = 13 - 5 = 8, so x = 8/2 = 4.'},
    {q:'What is the value of œÄ (pi) to 2 decimal places?',opts:['3.12','3.14','3.16','3.18'],ans:1,exp:'œÄ ‚âà 3.14159... so to 2 decimal places it is 3.14.'},
    {q:'What is the quadratic formula?',opts:['x = -b ¬± ‚àö(b¬≤-4ac) / 2a','x = b ¬± ‚àö(b¬≤+4ac) / 2a','x = -b ¬± ‚àö(b¬≤-4ac) / a','x = b ¬± ‚àö(4ac-b¬≤) / 2a'],ans:0,exp:'The quadratic formula solves ax¬≤+bx+c=0 giving x = (-b ¬± ‚àö(b¬≤-4ac)) / 2a.'},
    {q:'What is 7! (7 factorial)?',opts:['2520','5040','720','40320'],ans:1,exp:'7! = 7√ó6√ó5√ó4√ó3√ó2√ó1 = 5040.'},
    {q:'The sum of angles in a triangle is:',opts:['90¬∞','180¬∞','270¬∞','360¬∞'],ans:1,exp:'The interior angles of any triangle always sum to 180¬∞.'},
    {q:'What is log‚ÇÅ‚ÇÄ(1000)?',opts:['2','3','4','10'],ans:1,exp:'log‚ÇÅ‚ÇÄ(1000) = log‚ÇÅ‚ÇÄ(10¬≥) = 3.'},
    {q:'If a circle has radius 7, what is its area? (œÄ‚âà3.14)',opts:['43.96','153.86','21.98','49'],ans:1,exp:'Area = œÄr¬≤ = 3.14 √ó 7¬≤ = 3.14 √ó 49 = 153.86.'},
    {q:'What is the slope of the line y = 3x + 7?',opts:['7','3','10','-3'],ans:1,exp:'In the form y = mx + c, m is the slope. Here m = 3.'},
    {q:'Simplify: (x¬≤ √ó x¬≥)',opts:['x‚Åµ','x‚Å∂','2x‚Åµ','x'],ans:0,exp:'When multiplying same bases, add exponents: x¬≤ √ó x¬≥ = x^(2+3) = x‚Åµ.'},
    {q:'What is the Pythagorean theorem?',opts:['a¬≤ + b¬≤ = c¬≤','a + b = c','a¬≤ - b¬≤ = c¬≤','2a + b = c'],ans:0,exp:'In a right triangle, the square of the hypotenuse equals the sum of squares of the other two sides.'},
    {q:'What is ‚à´2x dx?',opts:['x¬≤ + C','2x¬≤ + C','x + C','2 + C'],ans:0,exp:'‚à´2x dx = 2¬∑(x¬≤/2) + C = x¬≤ + C. Always add constant of integration C.'},
  ]},
  Physics:{icon:'‚ö°',color:'#EDFAF9',questions:[
    {q:'What is Newton\'s Second Law of Motion?',opts:['F = ma','E = mc¬≤','v = u + at','p = mv'],ans:0,exp:'Newton\'s Second Law: Force = mass √ó acceleration (F = ma).'},
    {q:'What is the unit of electric resistance?',opts:['Volt','Ampere','Ohm','Watt'],ans:2,exp:'Resistance is measured in Ohms (Œ©), named after Georg Ohm.'},
    {q:'What is the speed of light in vacuum?',opts:['3√ó10‚Å∂ m/s','3√ó10‚Å∏ m/s','3√ó10¬π‚Å∞ m/s','3√ó10‚Å¥ m/s'],ans:1,exp:'The speed of light in vacuum is approximately 3√ó10‚Å∏ m/s (300,000 km/s).'},
    {q:'What is Ohm\'s Law?',opts:['V = IR','F = ma','E = hf','P = mv'],ans:0,exp:'Ohm\'s Law: Voltage = Current √ó Resistance (V = IR).'},
    {q:'What type of wave is sound?',opts:['Transverse','Electromagnetic','Longitudinal','Surface'],ans:2,exp:'Sound is a longitudinal wave ‚Äî the oscillations are parallel to the direction of propagation.'},
    {q:'What is the SI unit of force?',opts:['Joule','Pascal','Newton','Watt'],ans:2,exp:'Force is measured in Newtons (N). 1 N = 1 kg¬∑m/s¬≤.'},
    {q:'Which law states that energy cannot be created or destroyed?',opts:['Newton\'s 1st Law','Law of Conservation of Energy','Boyle\'s Law','Faraday\'s Law'],ans:1,exp:'The Law of Conservation of Energy states energy can only be transformed from one form to another.'},
    {q:'What is the formula for kinetic energy?',opts:['KE = mgh','KE = ¬Ωmv¬≤','KE = mc¬≤','KE = Fd'],ans:1,exp:'Kinetic Energy = ¬Ω √ó mass √ó velocity¬≤ (KE = ¬Ωmv¬≤).'},
    {q:'What is the gravitational acceleration on Earth?',opts:['9.8 m/s¬≤','8.9 m/s¬≤','10.8 m/s¬≤','7.8 m/s¬≤'],ans:0,exp:'Standard gravitational acceleration on Earth\'s surface is approximately 9.8 m/s¬≤.'},
    {q:'What is the wavelength-frequency relationship?',opts:['v = Œªf','v = Œª/f','Œª = v/f¬≤','f = Œªv'],ans:0,exp:'Wave speed = wavelength √ó frequency (v = Œªf). This applies to all waves.'},
    {q:'What is the unit of power?',opts:['Joule','Newton','Watt','Pascal'],ans:2,exp:'Power is measured in Watts (W). 1 W = 1 J/s.'},
    {q:'Mirrors that converge light are called:',opts:['Convex mirrors','Concave mirrors','Plane mirrors','Diverging mirrors'],ans:1,exp:'Concave (converging) mirrors reflect light inward toward a focal point.'},
  ]},
  'Computer Science':{icon:'üíª',color:'#F6F0FF',questions:[
    {q:'What does CPU stand for?',opts:['Central Processing Unit','Computer Processing Utility','Central Program Unit','Computing Power Unit'],ans:0,exp:'CPU = Central Processing Unit ‚Äî the primary component that executes instructions in a computer.'},
    {q:'What is the binary representation of decimal 10?',opts:['1010','1100','0110','1001'],ans:0,exp:'10 in binary is 1010. (8+2=10, so bits 3 and 1 are set).'},
    {q:'What does HTML stand for?',opts:['Hyper Text Markup Language','High Transfer Markup Language','Hyper Transfer Media Language','Home Tool Markup Language'],ans:0,exp:'HTML = HyperText Markup Language, the standard language for creating web pages.'},
    {q:'What is the time complexity of binary search?',opts:['O(n)','O(n¬≤)','O(log n)','O(1)'],ans:2,exp:'Binary search has O(log n) complexity as it halves the search space each step.'},
    {q:'Which data structure uses LIFO (Last In First Out)?',opts:['Queue','Stack','Linked List','Tree'],ans:1,exp:'A Stack uses LIFO ‚Äî the last element added is the first one removed (like a stack of plates).'},
    {q:'What is an IP address?',opts:['A unique identifier for a network device','A web page URL','A type of RAM memory','A programming language'],ans:0,exp:'An IP (Internet Protocol) address uniquely identifies a device on a network.'},
    {q:'What is recursion in programming?',opts:['A loop that runs forever','A function that calls itself','A type of variable','A sorting algorithm'],ans:1,exp:'Recursion is when a function calls itself with a simpler version of the same problem until a base case is reached.'},
    {q:'What does SQL stand for?',opts:['Structured Query Language','Simple Query Logic','System Query Language','Standard Question Language'],ans:0,exp:'SQL = Structured Query Language, used for managing and querying relational databases.'},
    {q:'What is the purpose of a compiler?',opts:['Run code line by line','Convert source code to machine code','Debug programs','Manage memory'],ans:1,exp:'A compiler translates entire source code into machine code (executable) before running.'},
    {q:'Which of these is NOT a programming language?',opts:['Python','Java','Photoshop','Ruby'],ans:2,exp:'Photoshop is Adobe\'s image editing software, not a programming language.'},
    {q:'What is OOP (Object-Oriented Programming)?',opts:['A type of database','Programming paradigm using objects and classes','A web framework','A type of algorithm'],ans:1,exp:'OOP organises code into objects containing data (attributes) and functions (methods).'},
    {q:'What does RAM stand for?',opts:['Random Access Memory','Read And Memory','Rapid Access Module','Runtime Application Memory'],ans:0,exp:'RAM = Random Access Memory ‚Äî volatile memory used for temporary data storage during program execution.'},
  ]},
  Chemistry:{icon:'üß™',color:'#FFFBEB',questions:[
    {q:'What is the chemical symbol for Gold?',opts:['Gd','Go','Au','Ag'],ans:2,exp:'Gold\'s symbol is Au, from the Latin word "Aurum".'},
    {q:'What is the pH of pure water?',opts:['6','7','8','14'],ans:1,exp:'Pure water is neutral with a pH of 7. Below 7 is acidic, above 7 is basic.'},
    {q:'What is the most abundant gas in Earth\'s atmosphere?',opts:['Oxygen','Carbon Dioxide','Nitrogen','Argon'],ans:2,exp:'Nitrogen (N‚ÇÇ) makes up about 78% of Earth\'s atmosphere.'},
    {q:'What is the chemical formula for water?',opts:['HO','H‚ÇÇO','H‚ÇÉO','OH'],ans:1,exp:'Water is H‚ÇÇO ‚Äî two hydrogen atoms bonded to one oxygen atom.'},
    {q:'What is the atomic number of Carbon?',opts:['4','6','8','12'],ans:1,exp:'Carbon has atomic number 6, meaning it has 6 protons in its nucleus.'},
    {q:'What type of bond shares electrons?',opts:['Ionic bond','Covalent bond','Metallic bond','Hydrogen bond'],ans:1,exp:'Covalent bonds share electron pairs between atoms, unlike ionic bonds which transfer electrons.'},
    {q:'What is the chemical symbol for Sodium?',opts:['So','Sd','Na','N'],ans:2,exp:'Sodium\'s symbol is Na, from the Latin word "Natrium".'},
    {q:'What happens in an endothermic reaction?',opts:['Heat is released','Heat is absorbed','No energy change','Light is produced'],ans:1,exp:'Endothermic reactions absorb heat energy from surroundings (endo = within, absorb).'},
    {q:'What is Avogadro\'s number?',opts:['6.022 √ó 10¬≤¬π','6.022 √ó 10¬≤¬≥','6.022 √ó 10¬π‚Å∏','6.022 √ó 10¬≤‚Åµ'],ans:1,exp:'Avogadro\'s number ‚âà 6.022 √ó 10¬≤¬≥, the number of particles in one mole of a substance.'},
    {q:'Which element has the symbol Fe?',opts:['Fluorine','Francium','Iron','Fermium'],ans:2,exp:'Fe is the symbol for Iron, from the Latin "Ferrum".'},
    {q:'What is an isotope?',opts:['Atoms of different elements','Atoms of same element with different neutrons','Molecules with same formula','Different compounds of same mass'],ans:1,exp:'Isotopes are atoms of the same element with the same proton count but different numbers of neutrons.'},
    {q:'What is the law of conservation of mass?',opts:['Mass can be created','Mass is destroyed in reactions','Mass is conserved in chemical reactions','Only energy is conserved'],ans:2,exp:'The total mass of reactants equals the total mass of products in any chemical reaction.'},
  ]},
  Biology:{icon:'üß¨',color:'#EDFAF3',questions:[
    {q:'What is the powerhouse of the cell?',opts:['Nucleus','Ribosome','Mitochondria','Chloroplast'],ans:2,exp:'Mitochondria produce ATP (energy) through cellular respiration, earning the nickname "powerhouse of the cell."'},
    {q:'What is the process by which plants make food?',opts:['Respiration','Photosynthesis','Transpiration','Digestion'],ans:1,exp:'Photosynthesis converts sunlight, CO‚ÇÇ, and water into glucose and oxygen.'},
    {q:'What is the double helix structure associated with?',opts:['Proteins','Carbohydrates','DNA','RNA'],ans:2,exp:'DNA (Deoxyribonucleic acid) has a double helix structure discovered by Watson and Crick in 1953.'},
    {q:'What carries oxygen in the blood?',opts:['White blood cells','Platelets','Plasma','Haemoglobin in red blood cells'],ans:3,exp:'Haemoglobin in red blood cells binds oxygen in the lungs and releases it in tissues.'},
    {q:'What is osmosis?',opts:['Movement of solute across membrane','Movement of water from high to low concentration','Active transport of ions','Diffusion of gases'],ans:1,exp:'Osmosis is the movement of water molecules across a semi-permeable membrane from high to low water concentration.'},
    {q:'What organ produces insulin?',opts:['Liver','Kidney','Pancreas','Stomach'],ans:2,exp:'The pancreas produces insulin, which regulates blood glucose levels.'},
    {q:'What is the basic unit of life?',opts:['Atom','Molecule','Cell','Organ'],ans:2,exp:'The cell is the basic structural and functional unit of all living organisms.'},
    {q:'What are the four DNA bases?',opts:['A, T, G, C','A, U, G, C','A, T, G, P','X, Y, G, C'],ans:0,exp:'DNA contains Adenine (A), Thymine (T), Guanine (G), and Cytosine (C). (RNA replaces T with U.)'},
    {q:'What is the function of ribosomes?',opts:['DNA replication','Protein synthesis','Energy production','Cell division'],ans:1,exp:'Ribosomes translate mRNA into proteins through a process called translation.'},
    {q:'What type of reproduction involves only one parent?',opts:['Sexual','Asexual','Binary','Meiotic'],ans:1,exp:'Asexual reproduction involves one parent, producing genetically identical offspring (clones).'},
    {q:'What is natural selection?',opts:['Random mutation','Survival of the fittest organisms that reproduce more','Artificial breeding','Genetic engineering'],ans:1,exp:'Natural selection: organisms better adapted to their environment tend to survive and reproduce more.'},
    {q:'Which blood type is the universal donor?',opts:['AB+','A+','O+','O-'],ans:3,exp:'O- (O negative) is the universal donor for red blood cells as it lacks A, B, and Rh antigens.'},
  ]},
  English:{icon:'üìñ',color:'#FFF0F0',questions:[
    {q:'What is a synonym for "ephemeral"?',opts:['Eternal','Transient','Solid','Loud'],ans:1,exp:'"Ephemeral" means lasting very short time. Synonym: transient (also fleeting, momentary).'},
    {q:'What literary device repeats initial consonant sounds?',opts:['Metaphor','Alliteration','Simile','Onomatopoeia'],ans:1,exp:'Alliteration is the repetition of the same consonant sound at the start of nearby words, e.g. "Peter Piper picked".'},
    {q:'What is the past tense of "run"?',opts:['Runned','Ran','Run','Runed'],ans:1,exp:'"Run" is an irregular verb. Its past tense is "ran", not "runned".'},
    {q:'Which of these is a metaphor?',opts:['"She ran as fast as a cheetah"','"The world is a stage"','"The wind whispered"','"The very tall mountain"'],ans:1,exp:'"The world is a stage" directly equates two unlike things without using "like" or "as" ‚Äî that\'s a metaphor.'},
    {q:'What does "verbose" mean?',opts:['Brief and concise','Using more words than needed','Angry','Confused'],ans:1,exp:'"Verbose" means using more words than necessary; wordy or long-winded.'},
    {q:'What is the plural of "criterion"?',opts:['Criterions','Criteria','Criterias','Criteries'],ans:1,exp:'The plural of "criterion" is "criteria" (from Greek). "Criterions" is sometimes used but less preferred.'},
    {q:'What is a haiku?',opts:['A 14-line poem','A 5-7-5 syllable Japanese poem','A rhyming couplet','A free verse poem'],ans:1,exp:'A haiku is a Japanese poem with 3 lines: 5 syllables, 7 syllables, 5 syllables = 17 total.'},
    {q:'What is the subjunctive mood?',opts:['Stating facts','Expressing wishes, doubts, or hypotheticals','Asking questions','Giving commands'],ans:1,exp:'The subjunctive expresses wishes, hypotheticals, and doubts. e.g. "I wish I were taller."'},
    {q:'What does the prefix "mis-" mean?',opts:['Again','Before','Wrongly','Not'],ans:2,exp:'"Mis-" means wrongly or incorrectly (misunderstand, misuse, mislead).'},
    {q:'What is dramatic irony?',opts:['When two things are compared','When audience knows something characters don\'t','When opposite is meant','When events contrast expectations'],ans:1,exp:'Dramatic irony occurs when the audience has information the characters lack, creating tension or humour.'},
    {q:'What is the antonym of "benevolent"?',opts:['Kind','Generous','Malevolent','Charitable'],ans:2,exp:'"Benevolent" means kind/well-wishing. Its antonym "malevolent" means wishing harm (mal = bad).'},
    {q:'A story\'s turning point is called the:',opts:['Exposition','Rising action','Climax','Resolution'],ans:2,exp:'The climax is the story\'s peak tension ‚Äî the turning point after which events move toward resolution.'},
  ]},
};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DEPARTMENT QUIZ DATA ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const DEPT_LABELS={AI_DS:'ü§ñ AI & Data Science',AI_ML:'üß† AI & Machine Learning',CSE:'üíª CSE',IT:'üåê IT',ECE:'üì° ECE',EEE:'‚ö° EEE',MECH:'‚öôÔ∏è Mechanical',CIVIL:'üèóÔ∏è Civil',MBA:'üíº MBA',BCA:'üñ•Ô∏è BCA/MCA',OTHER:'üìö General'};
const DEPT_QUIZ={
  AI_DS:{
    'Machine Learning':{icon:'ü§ñ',color:'#EBF0FF',questions:[
      {q:'What is supervised learning?',opts:['Learning with labeled data','Learning without labels','Reinforcement learning','Unsupervised clustering'],ans:0,exp:'Supervised learning uses labeled training data to learn a mapping from inputs to outputs.'},
      {q:'What does overfitting mean?',opts:['Model performs too well on test data','Model memorizes training data, fails on new data','Model is too simple','Model has too many features'],ans:1,exp:'Overfitting occurs when a model learns training data too well, including noise, and fails to generalize.'},
      {q:'Which algorithm uses decision boundaries to classify data?',opts:['Linear Regression','SVM','K-Means','PCA'],ans:1,exp:'Support Vector Machine (SVM) finds the optimal hyperplane that separates classes with maximum margin.'},
      {q:'What is the purpose of a train-test split?',opts:['To speed up training','To evaluate model on unseen data','To clean data','To normalize features'],ans:1,exp:'Train-test split lets us evaluate how well our model generalizes to data it has never seen.'},
      {q:'What does gradient descent do?',opts:['Increases the loss function','Minimizes the loss function by updating weights','Maximizes accuracy','Selects features'],ans:1,exp:'Gradient descent iteratively updates model parameters in the direction that reduces the loss function.'},
      {q:'What is a confusion matrix?',opts:['A matrix to confuse the model','Table showing TP, TN, FP, FN counts','A type of neural network','A dimensionality reduction technique'],ans:1,exp:'A confusion matrix summarizes classification results: True/False Positives and Negatives.'},
      {q:'What does KNN stand for?',opts:['K-Nearest Nodes','K-Nearest Neighbors','K-Null Networks','Key-Node Navigation'],ans:1,exp:'K-Nearest Neighbors classifies a data point based on the majority class of its K nearest neighbors.'},
      {q:'What is cross-validation used for?',opts:['Cleaning data','Reliable model evaluation by training on multiple splits','Increasing model size','Reducing training time'],ans:1,exp:'Cross-validation gives a more reliable estimate of model performance by using different train/test splits.'},
      {q:'What is the bias-variance tradeoff?',opts:['Trading speed for accuracy','Balancing underfitting (high bias) vs overfitting (high variance)','Choosing between models','Reducing feature count'],ans:1,exp:'High bias = underfitting (too simple). High variance = overfitting (too complex). We seek a balance.'},
      {q:'Which loss function is used for binary classification?',opts:['Mean Squared Error','Cross-Entropy Loss','Hinge Loss','L2 Loss'],ans:1,exp:'Binary Cross-Entropy (Log Loss) is the standard loss function for binary classification problems.'},
      {q:'What is feature engineering?',opts:['Building hardware features','Creating/transforming input variables to improve model performance','Debugging ML code','Designing neural layers'],ans:1,exp:'Feature engineering involves creating new features or transforming existing ones to improve model accuracy.'},
      {q:'What is the purpose of regularization in ML?',opts:['Speed up computation','Prevent overfitting by penalizing model complexity','Increase training data','Remove outliers'],ans:1,exp:'Regularization (L1/L2) adds a penalty for large weights, preventing overfitting by keeping the model simpler.'},
    ]},
    'Deep Learning':{icon:'üß†',color:'#F6F0FF',questions:[
      {q:'What is a neural network activation function?',opts:['A function to initialize weights','Non-linear function applied to layer outputs','A loss function','A gradient calculator'],ans:1,exp:'Activation functions (ReLU, Sigmoid, etc.) introduce non-linearity, allowing networks to learn complex patterns.'},
      {q:'What does CNN stand for?',opts:['Central Neural Network','Convolutional Neural Network','Cyclic Node Network','Connected Neuron Net'],ans:1,exp:'Convolutional Neural Networks use convolution layers to extract spatial features, ideal for image processing.'},
      {q:'What is backpropagation?',opts:['Forward pass of data','Algorithm that calculates gradients to update weights','Method to initialize weights','A type of layer'],ans:1,exp:'Backpropagation computes gradients of the loss with respect to each weight using the chain rule.'},
      {q:'What is the vanishing gradient problem?',opts:['Gradients become too large','Gradients become very small, slowing deep network training','Loss function vanishes','Weights become zero'],ans:1,exp:'In deep networks, gradients can shrink as they backpropagate, making early layers learn very slowly.'},
      {q:'What does LSTM stand for?',opts:['Long Short-Term Memory','Linear Sequential Transfer Model','Large Scale Training Method','Layered Statistical Training Model'],ans:1,exp:'LSTM (Long Short-Term Memory) is a type of RNN designed to remember long-term dependencies in sequences.'},
      {q:'What is dropout in neural networks?',opts:['Removing a layer','Randomly setting neuron outputs to zero during training to prevent overfitting','Decreasing learning rate','Removing training data'],ans:1,exp:'Dropout randomly deactivates neurons during training, forcing the network to learn redundant representations.'},
      {q:'What is batch normalization?',opts:['Organizing data into batches','Normalizing layer inputs to speed up and stabilize training','Setting batch size','Batch gradient descent'],ans:1,exp:'Batch normalization normalizes layer inputs to zero mean and unit variance, improving training speed and stability.'},
      {q:'What is transfer learning?',opts:['Moving model to new hardware','Using a pre-trained model as a starting point for a new task','Transferring data between models','Learning from text data'],ans:1,exp:'Transfer learning leverages knowledge from a pre-trained model (e.g., on ImageNet) for a related task.'},
      {q:'What is the ReLU activation function?',opts:['Returns -1 or 1','f(x) = max(0, x)','f(x) = 1/(1+e^-x)','f(x) = x¬≤'],ans:1,exp:'ReLU (Rectified Linear Unit) = max(0,x). It is fast to compute and helps avoid the vanishing gradient problem.'},
      {q:'What is an autoencoder?',opts:['Automatically encodes passwords','Neural network that learns compressed representations','Type of CNN','Supervised classifier'],ans:1,exp:'Autoencoders learn efficient encodings of data by training to reconstruct input through a bottleneck layer.'},
      {q:'What is GAN in deep learning?',opts:['Gradient Adaptive Network','Generative Adversarial Network','General AI Node','Graph Attention Network'],ans:1,exp:'GAN has two networks: a Generator (creates fake data) and a Discriminator (detects fakes) competing adversarially.'},
      {q:'What optimizer is commonly used in deep learning?',opts:['SGD only','Adam optimizer','Linear regression','Random search'],ans:1,exp:'Adam optimizer combines momentum and RMSprop, adapting learning rates for each parameter ‚Äî widely used in DL.'},
    ]},
    'Data Science & Python':{icon:'üêç',color:'#EDFAF3',questions:[
      {q:'What is a Pandas DataFrame?',opts:['A bamboo data structure','2D labeled data structure like a table','1D array','A Python list'],ans:1,exp:'A Pandas DataFrame is a 2D labeled data structure with rows and columns, similar to a spreadsheet.'},
      {q:'What does the Pandas groupby() method do?',opts:['Groups columns alphabetically','Groups rows by a column value for aggregation','Sorts data','Removes duplicates'],ans:1,exp:'groupby() groups rows sharing a value in a column, allowing aggregate operations (sum, mean, count, etc.).'},
      {q:'What is NumPy used for?',opts:['Web development','Numerical computation with arrays and matrices','Database management','Web scraping'],ans:1,exp:'NumPy provides high-performance multi-dimensional arrays and mathematical operations for numerical computing.'},
      {q:'What is the purpose of data normalization?',opts:['Adding more data','Scaling features to a similar range','Removing null values','Encoding categories'],ans:1,exp:'Normalization scales features to a common range (e.g., 0-1), preventing features with large values from dominating.'},
      {q:'What is a null/NaN value in a dataset?',opts:['Zero value','Missing or undefined value','Negative number','A string value'],ans:1,exp:'NaN (Not a Number) represents missing data. Handling NaN values is crucial in data preprocessing.'},
      {q:'What is data visualization?',opts:['Deleting data','Graphical representation of data to find patterns','Converting data to text','Sorting data'],ans:1,exp:'Data visualization uses charts, graphs, and plots (matplotlib, seaborn) to explore and communicate data insights.'},
      {q:'What is a correlation coefficient?',opts:['Number of rows','Statistical measure of relationship between two variables (-1 to 1)','Average value','Standard deviation'],ans:1,exp:'Correlation coefficient measures how strongly two variables are related. +1=perfect positive, -1=perfect negative.'},
      {q:'What is the purpose of one-hot encoding?',opts:['Encrypt data','Convert categorical variables into binary columns','Speed up code','Normalize numbers'],ans:1,exp:'One-hot encoding creates binary (0/1) columns for each category, making categorical data usable in ML models.'},
      {q:'What is matplotlib used for?',opts:['Machine learning','Creating plots and visualizations in Python','Web scraping','Database queries'],ans:1,exp:'Matplotlib is Python\'s foundational plotting library for creating charts, graphs, histograms, and more.'},
      {q:'What is Principal Component Analysis (PCA)?',opts:['A classification algorithm','Dimensionality reduction technique that finds principal components','Data augmentation method','A clustering algorithm'],ans:1,exp:'PCA reduces dimensions by finding principal components (directions of maximum variance) in the data.'},
      {q:'What is an outlier in data?',opts:['Average data point','Data point far from others that may skew analysis','Missing value','Duplicate entry'],ans:1,exp:'Outliers are data points significantly different from others. They can skew statistics and affect ML model performance.'},
      {q:'What does EDA stand for in data science?',opts:['Efficient Data Algorithm','Exploratory Data Analysis','Enhanced Data Architecture','Extreme Deep Analysis'],ans:1,exp:'EDA (Exploratory Data Analysis) involves analyzing datasets to summarize characteristics and discover patterns.'},
    ]},
    'Statistics':{icon:'üìä',color:'#FFFBEB',questions:[
      {q:'What is the mean of [2, 4, 6, 8, 10]?',opts:['5','6','7','8'],ans:1,exp:'Mean = (2+4+6+8+10)/5 = 30/5 = 6.'},
      {q:'What does standard deviation measure?',opts:['Average value','Spread/variability of data around the mean','Maximum value','Correlation'],ans:1,exp:'Standard deviation measures how spread out values are from the mean. Low SD = values close to mean.'},
      {q:'What is a p-value in hypothesis testing?',opts:['Probability of getting results at least as extreme as observed, assuming H0 is true','Average probability','Sample size','Confidence level'],ans:0,exp:'P-value is the probability of observing results as extreme as the sample if the null hypothesis is true. p<0.05 is often significant.'},
      {q:'What is the normal distribution?',opts:['Any random distribution','Bell-shaped symmetric distribution defined by mean and standard deviation','Uniform distribution','Skewed distribution'],ans:1,exp:'The normal (Gaussian) distribution is bell-shaped and symmetric around the mean, described by Œº (mean) and œÉ (std dev).'},
      {q:'What is the median?',opts:['Average of all values','Middle value when data is sorted','Most frequent value','Sum of all values'],ans:1,exp:'Median is the middle value when data is sorted. It is more robust to outliers than the mean.'},
      {q:'What is Bayes\' theorem used for?',opts:['Matrix multiplication','Calculating conditional probability P(A|B)','Linear regression','Data sorting'],ans:1,exp:'Bayes\' theorem: P(A|B) = P(B|A)¬∑P(A)/P(B). It updates probability beliefs given new evidence.'},
      {q:'What is variance?',opts:['Standard deviation','Square of standard deviation ‚Äî measures data spread','Range of data','Mean deviation'],ans:1,exp:'Variance is the average of squared differences from the mean. Standard deviation is the square root of variance.'},
      {q:'What is the mode?',opts:['Average value','Middle value','Most frequently occurring value in a dataset','Maximum value'],ans:2,exp:'Mode is the most frequently occurring value. A dataset can have no mode, one mode (unimodal), or multiple modes.'},
      {q:'What is a Type I error in hypothesis testing?',opts:['Accepting a false null hypothesis','Rejecting a true null hypothesis (false positive)','Getting wrong mean','Using wrong test'],ans:1,exp:'Type I error = False Positive: rejecting H0 when it is actually true. The probability of this is Œ± (significance level).'},
      {q:'What does "95% confidence interval" mean?',opts:['95% of data is in the range','If we repeated sampling, 95% of intervals would contain the true parameter','The parameter is 95% likely to be this value','We are 95% sure the data is normal'],ans:1,exp:'A 95% CI means: if we repeated the experiment many times, 95% of constructed intervals would contain the true value.'},
      {q:'What is a scatter plot used for?',opts:['Showing frequencies','Visualizing relationship between two continuous variables','Displaying categories','Showing time trends'],ans:1,exp:'Scatter plots display pairs of values for two variables, helping visualize correlation and patterns.'},
      {q:'What is the Central Limit Theorem?',opts:['All data follows normal distribution','Sample means approach normal distribution as sample size increases, regardless of original distribution','Central values cluster together','Theorem about matrices'],ans:1,exp:'CLT states that the distribution of sample means approaches a normal distribution as sample size grows.'},
    ]},
  },
  CSE:{
    'Data Structures':{icon:'üå≥',color:'#EBF0FF',questions:[
      {q:'What is the time complexity of insertion in a sorted linked list?',opts:['O(1)','O(log n)','O(n)','O(n¬≤)'],ans:2,exp:'Finding the right position in a sorted linked list requires O(n) traversal in the worst case.'},
      {q:'What data structure is used for BFS traversal?',opts:['Stack','Queue','Priority Queue','Tree'],ans:1,exp:'BFS (Breadth-First Search) uses a Queue to process nodes level by level.'},
      {q:'What is a heap data structure?',opts:['Random array','Complete binary tree where parent is always ‚â• or ‚â§ children','Sorted linked list','Hash table'],ans:1,exp:'A heap is a complete binary tree. Max-heap: parent ‚â• children. Min-heap: parent ‚â§ children.'},
      {q:'What is the worst-case time complexity of quicksort?',opts:['O(n log n)','O(n)','O(n¬≤)','O(log n)'],ans:2,exp:'Quicksort\'s worst case is O(n¬≤) when the pivot is always the smallest or largest element (e.g., already sorted array).'},
      {q:'What is a hash collision?',opts:['When hash table is full','When two different keys map to the same hash value','When hash function fails','When keys are deleted'],ans:1,exp:'A collision occurs when two keys produce the same hash index. Resolved by chaining or open addressing.'},
      {q:'What is a balanced binary search tree?',opts:['BST where all leaves are at same level','BST where height difference between subtrees is ‚â§ 1 (e.g. AVL, Red-Black)','BST with even number of nodes','Sorted BST'],ans:1,exp:'A balanced BST (AVL, Red-Black tree) maintains O(log n) height, ensuring O(log n) search/insert/delete.'},
      {q:'What is the time complexity of binary search?',opts:['O(n)','O(n¬≤)','O(log n)','O(1)'],ans:2,exp:'Binary search divides the search space in half each time, giving O(log n) time complexity.'},
      {q:'What is a graph?',opts:['A pie chart','Collection of vertices (nodes) connected by edges','A type of tree','A sorted array'],ans:1,exp:'A graph G=(V,E) consists of vertices V and edges E connecting them. Can be directed or undirected.'},
      {q:'What is dynamic programming?',opts:['Runtime programming','Breaking problem into overlapping subproblems and storing results to avoid recomputation','Object-oriented design','A sorting algorithm'],ans:1,exp:'DP solves problems by breaking them into subproblems, storing solutions (memoization/tabulation) to avoid redundant computation.'},
      {q:'What is a trie data structure used for?',opts:['Storing numbers','Efficient string storage and prefix-based search','Sorting integers','Graph traversal'],ans:1,exp:'A trie (prefix tree) stores strings character by character, enabling O(m) lookup where m is string length.'},
      {q:'What is the space complexity of DFS using recursion?',opts:['O(1)','O(n)','O(V+E)','O(log n)'],ans:1,exp:'Recursive DFS uses O(h) stack space where h is the recursion depth. In worst case (linear tree), this is O(n).'},
      {q:'In a circular queue, what happens when rear reaches the end?',opts:['Queue is full','Rear wraps around to the front','Queue is reset','New array is allocated'],ans:1,exp:'In a circular queue, rear wraps to index 0 after reaching maxSize-1, utilizing empty spaces at the front.'},
    ]},
    'Operating Systems':{icon:'üñ•Ô∏è',color:'#EDFAF9',questions:[
      {q:'What is a process?',opts:['A stored program','A program in execution with its own memory space','A file on disk','A hardware component'],ans:1,exp:'A process is a program in execution. It has its own memory space, program counter, and resources.'},
      {q:'What is deadlock?',opts:['System crash','Situation where processes wait for each other\'s resources indefinitely','Slow performance','Memory leak'],ans:1,exp:'Deadlock occurs when processes permanently block waiting for resources held by each other (circular wait).'},
      {q:'What is virtual memory?',opts:['RAM memory','Technique using disk space as extension of RAM','Virtual machine memory','Cache memory'],ans:1,exp:'Virtual memory gives processes the illusion of large memory by using disk as an extension of RAM through paging.'},
      {q:'What is a semaphore?',opts:['A signal flag','Synchronization primitive used to control access to shared resources','Type of process','Memory allocation technique'],ans:1,exp:'Semaphore is an integer variable used for process synchronization. wait()/signal() operations prevent race conditions.'},
      {q:'What is the difference between process and thread?',opts:['No difference','Thread is a lightweight unit of execution within a process, sharing its memory','Process is faster','Threads use more memory'],ans:1,exp:'Threads share the process\'s memory space and are lighter weight. Multiple threads in one process enable parallelism.'},
      {q:'What is paging in OS?',opts:['Printing pages','Dividing memory into fixed-size pages to enable virtual memory','Loading files','Process scheduling'],ans:1,exp:'Paging divides physical memory into frames and virtual memory into pages, allowing non-contiguous memory allocation.'},
      {q:'What does CPU scheduling do?',opts:['Cools the CPU','Decides which process runs next on the CPU','Manages disk I/O','Allocates RAM'],ans:1,exp:'CPU scheduling algorithms (FCFS, Round Robin, SJF) decide the order in which processes get CPU time.'},
      {q:'What is a race condition?',opts:['CPU competition','Bug where output depends on unpredictable timing of concurrent operations','Fast scheduling','Network issue'],ans:1,exp:'A race condition occurs when two threads access shared data concurrently and the result depends on execution order.'},
      {q:'What is thrashing in OS?',opts:['CPU overheating','When system spends more time swapping pages than executing processes','Hard disk failure','Memory leak'],ans:1,exp:'Thrashing occurs when a process has too few pages allocated, causing constant page faults and swapping.'},
      {q:'What is a context switch?',opts:['Changing display settings','Saving and loading process state when CPU switches between processes','Changing OS settings','File system operation'],ans:1,exp:'Context switch saves the current process state (registers, PC) and restores another process\'s state to resume it.'},
      {q:'What is the kernel?',opts:['CPU core','Core of the OS that manages hardware resources and provides services','A type of program','Network driver'],ans:1,exp:'The kernel is the OS core that manages CPU, memory, I/O, and provides system calls for user programs.'},
      {q:'What is demand paging?',opts:['Requesting more RAM','Loading pages into memory only when needed (on page fault)','Allocating all memory upfront','Compacting memory'],ans:1,exp:'Demand paging loads a page into memory only when a process tries to access it, reducing memory usage.'},
    ]},
    'Computer Networks':{icon:'üåê',color:'#F6F0FF',questions:[
      {q:'What does TCP stand for?',opts:['Transfer Control Protocol','Transmission Control Protocol','Technical Connection Protocol','Terminal Control Process'],ans:1,exp:'TCP = Transmission Control Protocol. It provides reliable, ordered, error-checked delivery of data.'},
      {q:'What is the OSI model?',opts:['A programming language','7-layer reference model for network communication','Operating System Interface','A routing protocol'],ans:1,exp:'OSI has 7 layers: Physical, Data Link, Network, Transport, Session, Presentation, Application.'},
      {q:'What is the difference between TCP and UDP?',opts:['No difference','TCP is reliable/ordered; UDP is faster but unreliable','UDP is slower','TCP is for UDP connections'],ans:1,exp:'TCP: reliable, connection-oriented, ordered delivery. UDP: no guarantees, faster, used for streaming/gaming.'},
      {q:'What is an IP address?',opts:['Website name','Unique numerical identifier for a device on a network','WiFi password','Router brand'],ans:1,exp:'An IP address uniquely identifies a device on a network. IPv4: 32-bit (e.g., 192.168.1.1), IPv6: 128-bit.'},
      {q:'What does DNS do?',opts:['Speed up internet','Translates domain names to IP addresses','Encrypt data','Assign IP addresses'],ans:1,exp:'DNS (Domain Name System) translates human-readable domain names (google.com) to IP addresses.'},
      {q:'What is a subnet mask?',opts:['A password for subnets','Determines which part of IP is network vs host portion','A routing table','A firewall rule'],ans:1,exp:'Subnet mask (e.g., 255.255.255.0) defines the network portion and host portion of an IP address.'},
      {q:'What is HTTP vs HTTPS?',opts:['HTTPS is faster','HTTPS adds SSL/TLS encryption to HTTP for secure communication','HTTP is newer','No difference'],ans:1,exp:'HTTPS encrypts HTTP traffic using TLS/SSL, protecting data from eavesdropping and tampering.'},
      {q:'What is a MAC address?',opts:['Apple Mac address','Hardware address burned into network interface card ‚Äî unique per device','IP address version','Router address'],ans:1,exp:'MAC (Media Access Control) address is a 48-bit hardware identifier assigned to a network interface card.'},
      {q:'What is the purpose of ARP?',opts:['Assigns IP addresses','Maps IP addresses to MAC addresses','Routes packets','Encrypts data'],ans:1,exp:'ARP (Address Resolution Protocol) finds the MAC address of a device given its IP address on a local network.'},
      {q:'What is a firewall?',opts:['Physical wall','Security system that monitors and controls network traffic based on rules','A router brand','Antivirus software'],ans:1,exp:'A firewall filters incoming and outgoing network traffic based on configured security rules to block threats.'},
      {q:'What layer does IP operate at in OSI?',opts:['Layer 2 (Data Link)','Layer 3 (Network)','Layer 4 (Transport)','Layer 1 (Physical)'],ans:1,exp:'IP (Internet Protocol) operates at Layer 3 (Network layer), handling logical addressing and routing.'},
      {q:'What is NAT?',opts:['Network Authentication Token','Network Address Translation ‚Äî maps private IPs to public IP','A routing algorithm','VPN technology'],ans:1,exp:'NAT allows multiple devices with private IPs to share a single public IP address, commonly used in routers.'},
    ]},
  },
  ECE:{
    'Digital Electronics':{icon:'‚ö°',color:'#FFFBEB',questions:[
      {q:'What is a logic gate?',opts:['Physical gate','Electronic circuit that performs a Boolean logical operation','A type of transistor','A memory cell'],ans:1,exp:'Logic gates (AND, OR, NOT, XOR, NAND, NOR) are the basic building blocks of digital circuits.'},
      {q:'What is the output of AND gate when inputs are 1 and 0?',opts:['1','0','Undefined','Depends on voltage'],ans:1,exp:'AND gate: output is 1 only if ALL inputs are 1. 1 AND 0 = 0.'},
      {q:'What is De Morgan\'s theorem (first law)?',opts:['NOT(A¬∑B) = NOT(A) + NOT(B)','NOT(A+B) = NOT(A)¬∑NOT(B) is wrong','A¬∑B = A+B','NOT(A+B) = NOT(A) + NOT(B)'],ans:0,exp:'De Morgan\'s First Law: NOT(A AND B) = NOT(A) OR NOT(B). Useful for simplifying Boolean expressions.'},
      {q:'What is a flip-flop?',opts:['A sorting algorithm','Bistable circuit that stores one bit of data','A type of gate','A clock signal'],ans:1,exp:'A flip-flop is a sequential circuit element that stores 1 bit and changes state based on clock and input signals.'},
      {q:'What is the binary equivalent of decimal 255?',opts:['11111110','11111111','10000000','01111111'],ans:1,exp:'255 in binary is 11111111 (all 8 bits set to 1). 128+64+32+16+8+4+2+1 = 255.'},
      {q:'What is a multiplexer (MUX)?',opts:['Memory unit','Circuit that selects one of many inputs and routes it to output based on select lines','A type of flip-flop','An encoder'],ans:1,exp:'A MUX selects one of N inputs and routes it to a single output, controlled by log‚ÇÇN select lines.'},
      {q:'What is the output of XOR gate for inputs 1 and 1?',opts:['1','0','Undefined','2'],ans:1,exp:'XOR (Exclusive OR) output is 1 only when inputs are DIFFERENT. 1 XOR 1 = 0.'},
      {q:'What is a decoder?',opts:['A type of encoder','Circuit with n inputs that activates one of 2‚Åø outputs based on input combination','A data selector','Memory decoder'],ans:1,exp:'A decoder takes n-bit input and activates exactly one of 2‚Åø outputs corresponding to the binary value.'},
      {q:'What is clock frequency?',opts:['Power frequency','Number of clock cycles per second, measured in Hz','Memory speed','Bus speed'],ans:1,exp:'Clock frequency (Hz) determines how many times per second a digital circuit can perform a clock cycle.'},
      {q:'What is the purpose of a counter circuit?',opts:['Count physical objects','Sequential circuit that counts clock pulses in a defined sequence','An adder circuit','A memory element'],ans:1,exp:'Counters are sequential circuits that increment/decrement a binary count on each clock pulse. Used for timing.'},
      {q:'What is Karnaugh Map (K-Map) used for?',opts:['Mapping memory','Simplifying Boolean expressions to minimize logic gates','Designing flip-flops','Signal analysis'],ans:1,exp:'K-Map is a graphical method to simplify Boolean expressions by grouping adjacent 1s, minimizing gate count.'},
      {q:'What is a half adder?',opts:['Adds half the bits','Combinational circuit that adds two 1-bit binary numbers producing Sum and Carry','A type of counter','Memory adder'],ans:1,exp:'Half adder adds two bits: Sum = A XOR B, Carry = A AND B. It cannot handle carry-in (that\'s a full adder).'},
    ]},
    'Signals and Systems':{icon:'üì°',color:'#EDFAF3',questions:[
      {q:'What is a signal?',opts:['An alarm','A function that conveys information about a phenomenon','A type of wire','A network packet'],ans:1,exp:'A signal is a function of independent variables (time, space) that carries information about a physical phenomenon.'},
      {q:'What is the Fourier Transform used for?',opts:['Image compression only','Converting a signal from time domain to frequency domain','Filtering noise only','Encrypting signals'],ans:1,exp:'Fourier Transform decomposes a signal into its constituent frequencies, converting from time to frequency domain.'},
      {q:'What is sampling theorem (Nyquist)?',opts:['Sample at any rate','Sampling rate must be ‚â• 2√ó maximum signal frequency to avoid aliasing','Sample at 1 Hz','Always sample at 44.1 kHz'],ans:1,exp:'Nyquist theorem: sampling frequency fs ‚â• 2√ófmax ensures perfect reconstruction of a band-limited signal.'},
      {q:'What is aliasing?',opts:['Signal encryption','Distortion when signal is sampled below Nyquist rate, causing frequencies to overlap','Amplification of signals','A filtering technique'],ans:1,exp:'Aliasing occurs when a signal is undersampled, causing high frequencies to appear as lower frequencies in the sampled signal.'},
      {q:'What is convolution used for in signals?',opts:['Multiplying signals','Determining output of LTI system given input and impulse response','Measuring amplitude','Encrypting signals'],ans:1,exp:'Convolution: y(t) = x(t)*h(t) gives the output of an LTI system with impulse response h(t) for input x(t).'},
      {q:'What is a Linear Time-Invariant (LTI) system?',opts:['Any electronic circuit','System that satisfies linearity and time-invariance properties','A nonlinear system','A digital filter'],ans:1,exp:'An LTI system is both linear (superposition holds) and time-invariant (behavior doesn\'t change with time shift).'},
      {q:'What is the Z-transform used for?',opts:['Image transformation','Analysis of discrete-time signals and systems (digital equivalent of Laplace)','Physical transformation','Video encoding'],ans:1,exp:'Z-transform is used to analyze discrete-time signals and design digital filters, analogous to Laplace for continuous signals.'},
      {q:'What does a low-pass filter do?',opts:['Amplifies all frequencies','Passes low frequencies and attenuates high frequencies','Passes only high frequencies','Blocks all frequencies'],ans:1,exp:'A low-pass filter (LPF) allows signals below the cutoff frequency to pass and attenuates higher frequencies.'},
      {q:'What is the impulse response of a system?',opts:['Response to a sine wave','Output of a system when input is an impulse (delta function)','Average response','Frequency response'],ans:1,exp:'Impulse response h(t) characterizes an LTI system completely ‚Äî any output can be found by convolving input with h(t).'},
      {q:'What is amplitude modulation (AM)?',opts:['Varying frequency','Varying the carrier amplitude in proportion to the message signal','Varying the phase','Digital encoding'],ans:1,exp:'In AM, the carrier signal\'s amplitude is varied proportionally to the message signal while frequency stays constant.'},
      {q:'What is the Laplace Transform used for?',opts:['Only for frequency analysis','Converting differential equations to algebraic equations for circuit analysis','Discrete signal processing','Image processing'],ans:1,exp:'Laplace Transform converts differential equations to algebraic equations, simplifying analysis of circuits and control systems.'},
      {q:'What is a causal system?',opts:['System with no memory','System whose output depends only on present and past inputs, not future','System with feedback','System with delays'],ans:1,exp:'A causal system\'s output depends only on current and past inputs. This is essential for real-time, implementable systems.'},
    ]},
  },
  MECH:{
    'Thermodynamics':{icon:'üå°Ô∏è',color:'#FFF0F0',questions:[
      {q:'What is the First Law of Thermodynamics?',opts:['Entropy always increases','Energy cannot be created or destroyed; ŒîU = Q - W','Heat flows from cold to hot','Absolute zero is unattainable'],ans:1,exp:'First Law: Energy is conserved. Internal energy change = heat added to system minus work done by system: ŒîU = Q - W.'},
      {q:'What is entropy?',opts:['Temperature measure','Measure of disorder or randomness in a system','Heat energy','Work done'],ans:1,exp:'Entropy (S) measures the degree of disorder/randomness. The Second Law states entropy of an isolated system always increases.'},
      {q:'What is a Carnot cycle?',opts:['Any heat cycle','Ideal thermodynamic cycle with maximum efficiency between two temperatures','Otto cycle variant','A refrigeration cycle'],ans:1,exp:'Carnot cycle is the most efficient possible heat engine cycle operating between temperatures TH and TL. Efficiency = 1 - TL/TH.'},
      {q:'What is the ideal gas law?',opts:['PV = constant','PV = nRT','P = œÅRT','PV¬≤ = constant'],ans:1,exp:'Ideal Gas Law: PV = nRT, where P = pressure, V = volume, n = moles, R = gas constant, T = absolute temperature.'},
      {q:'What is enthalpy (H)?',opts:['Internal energy only','H = U + PV, total heat content of a system at constant pressure','Entropy value','Work done by system'],ans:1,exp:'Enthalpy H = U + PV. At constant pressure, ŒîH equals heat transferred: ŒîH = Q_p. Used in chemical and thermal processes.'},
      {q:'What is the Second Law of Thermodynamics?',opts:['Energy is conserved','Heat naturally flows from hot to cold; entropy of universe always increases','Temperature is absolute','Work equals heat'],ans:1,exp:'Second Law: Heat flows spontaneously from hot to cold. Total entropy of universe increases in any irreversible process.'},
      {q:'What is an isentropic process?',opts:['Constant temperature process','Adiabatic and reversible ‚Äî constant entropy process','Constant pressure process','Constant volume process'],ans:1,exp:'An isentropic process is both adiabatic (no heat exchange) and reversible, so entropy remains constant: ŒîS = 0.'},
      {q:'What does a higher COP (Coefficient of Performance) mean for a refrigerator?',opts:['More efficient cooling per unit of work input','Less efficient cooling','Higher temperature difference','More power consumed'],ans:0,exp:'COP = Q_cold/W. Higher COP means more heat removed per unit of work ‚Äî better refrigerator efficiency.'},
      {q:'What is a heat engine?',opts:['A car engine only','Device that converts thermal energy (heat) into mechanical work','Air conditioning system','A type of compressor'],ans:1,exp:'A heat engine receives heat from a hot source, converts part to work, and rejects remaining heat to a cold sink.'},
      {q:'What is specific heat capacity?',opts:['Heat required to melt 1 kg','Energy required to raise 1 kg of substance by 1¬∞C','Total heat of a substance','Latent heat'],ans:1,exp:'Specific heat capacity (c) is the energy needed to raise 1 kg of a substance by 1 K: Q = mcŒîT.'},
      {q:'What is a throttling process?',opts:['Increasing pressure','Isenthalpic (constant enthalpy) process ‚Äî pressure drops through restriction','Adiabatic compression','Isothermal expansion'],ans:1,exp:'Throttling (e.g., valve, orifice) reduces pressure at constant enthalpy. Used in refrigeration expansion valves.'},
      {q:'What is Zeroth Law of Thermodynamics?',opts:['Temperature cannot be negative','If A is in thermal equilibrium with B and C, then B and C are in equilibrium with each other','Entropy is constant','Energy is conserved'],ans:1,exp:'Zeroth Law: If A and B are separately in equilibrium with C, then A and B are in equilibrium with each other ‚Äî this defines temperature.'},
    ]},
    'Fluid Mechanics':{icon:'üíß',color:'#EDFAF9',questions:[
      {q:'What is Bernoulli\'s equation?',opts:['F = ma for fluids','P + ¬ΩœÅv¬≤ + œÅgh = constant along a streamline','Volume flow rate is constant','Pressure = force/area'],ans:1,exp:'Bernoulli\'s equation: P + ¬ΩœÅv¬≤ + œÅgh = constant. Faster fluid ‚Üí lower pressure (used in aircraft lift, carburetors).'},
      {q:'What is viscosity?',opts:['Fluid density','Fluid\'s resistance to flow/deformation ‚Äî internal friction','Fluid pressure','Surface tension'],ans:1,exp:'Dynamic viscosity (Œº) measures fluid\'s resistance to shear stress. Honey has high viscosity; water has low viscosity.'},
      {q:'What is the Reynolds number?',opts:['Ratio of pressure to velocity','Dimensionless ratio of inertial to viscous forces (Re = œÅvL/Œº)','Froude number','Mach number'],ans:1,exp:'Reynolds number Re = œÅvL/Œº. Re<2100: laminar flow. Re>4000: turbulent flow. Critical range: 2100-4000.'},
      {q:'What is Pascal\'s Law?',opts:['Pressure decreases with depth','Pressure applied to confined fluid transmits equally in all directions','Fluid flows from high to low pressure','Density = mass/volume'],ans:1,exp:'Pascal\'s Law: pressure applied to an enclosed fluid is transmitted undiminished in all directions ‚Äî basis for hydraulic systems.'},
      {q:'What is Archimedes\' Principle?',opts:['Denser objects sink','Buoyant force equals weight of fluid displaced by the object','Objects float in all fluids','Pressure increases with velocity'],ans:1,exp:'Archimedes\' Principle: buoyancy force = weight of displaced fluid. FB = œÅ_fluid √ó V_submerged √ó g.'},
      {q:'What is laminar flow?',opts:['Chaotic irregular flow','Smooth, ordered flow in parallel layers with no mixing between layers','Flow with turbulence','High-speed flow'],ans:1,exp:'Laminar flow occurs at low Re: fluid moves in smooth parallel layers. Turbulent flow has chaotic mixing.'},
      {q:'What is the continuity equation for incompressible flow?',opts:['Pressure is constant','A‚ÇÅv‚ÇÅ = A‚ÇÇv‚ÇÇ (flow rate is conserved)','Density is constant','Velocity is constant'],ans:1,exp:'Continuity equation A‚ÇÅv‚ÇÅ = A‚ÇÇv‚ÇÇ states that mass flow rate is conserved: narrower pipe ‚Üí faster flow.'},
      {q:'What is cavitation in fluid mechanics?',opts:['Fluid boiling due to heat','Formation and collapse of vapor bubbles where local pressure drops below vapor pressure','Air entering pipes','Fluid crystallization'],ans:1,exp:'Cavitation occurs when local pressure drops below vapor pressure, forming vapor bubbles that collapse violently, causing damage.'},
      {q:'What is hydrostatic pressure?',opts:['Pressure due to fluid motion','Pressure due to the weight of static fluid above: P = œÅgh','Atmospheric pressure only','Dynamic pressure'],ans:1,exp:'Hydrostatic pressure P = œÅgh. Pressure increases linearly with depth in a static fluid.'},
      {q:'What is the Navier-Stokes equation?',opts:['Equation for ideal gases','Fundamental equation governing viscous fluid motion (F=ma for fluids)','Bernoulli in differential form','Continuity equation'],ans:1,exp:'Navier-Stokes equations describe viscous fluid motion, applying Newton\'s 2nd law with pressure, viscous, and body forces.'},
      {q:'What is streamline flow?',opts:['Flow in streams','Flow where velocity at each point is constant over time (no turbulence)','High velocity flow','Flow near walls'],ans:1,exp:'In streamline (steady) flow, fluid velocity at each point doesn\'t change with time. Streamlines don\'t cross each other.'},
      {q:'What is the Darcy-Weisbach equation used for?',opts:['Calculate flow velocity','Calculate head loss due to friction in a pipe','Measure fluid viscosity','Calculate buoyancy'],ans:1,exp:'Darcy-Weisbach: hf = f(L/D)(v¬≤/2g) calculates frictional head loss in pipe flow. f is the friction factor.'},
    ]},
  },
  MBA:{
    'Marketing Management':{icon:'üìà',color:'#EBF0FF',questions:[
      {q:'What are the 4Ps of marketing?',opts:['Price, Product, Promotion, Place','People, Process, Price, Product','Planning, Product, Profit, Place','Price, Profit, People, Promotion'],ans:0,exp:'The Marketing Mix 4Ps: Product (what you sell), Price (how much), Place (where sold), Promotion (how communicated).'},
      {q:'What is market segmentation?',opts:['Splitting a company','Dividing a market into distinct groups of consumers with similar needs','Market research','Competitive analysis'],ans:1,exp:'Market segmentation groups consumers by demographics, psychographics, geography, or behavior to target more effectively.'},
      {q:'What is a brand?',opts:['Company logo only','Name, term, design, symbol that identifies a seller\'s product and differentiates it from competitors','Trademark','Advertisement'],ans:1,exp:'A brand is the complete identity of a product/company: name, logo, reputation, and the feelings it evokes in consumers.'},
      {q:'What is the BCG Matrix used for?',opts:['Accounting analysis','Portfolio analysis tool categorizing business units as Stars, Cash Cows, Dogs, Question Marks','Market research','Financial planning'],ans:1,exp:'BCG Matrix plots business units on market share vs growth, helping allocate resources: Stars (high growth+share), Cash Cows (high share, low growth), etc.'},
      {q:'What is a USP (Unique Selling Proposition)?',opts:['United States Patent','Distinct benefit that makes a product/service different and better than competitors','Sales strategy','Pricing model'],ans:1,exp:'USP is the unique benefit or reason customers should choose your product over competitors. It is the core of positioning.'},
      {q:'What is digital marketing?',opts:['Marketing using digital cameras','Marketing through digital channels: social media, SEO, email, paid ads, content marketing','Using computers for accounting','Online shopping'],ans:1,exp:'Digital marketing uses internet and electronic devices to reach consumers through social media, SEO, PPC, email, content, etc.'},
      {q:'What is customer lifetime value (CLV)?',opts:['How long a customer lives','Total revenue expected from a customer over their entire relationship with the company','Customer age','Annual revenue per customer'],ans:1,exp:'CLV = average purchase value √ó frequency √ó customer lifetime. Higher CLV justifies higher customer acquisition costs.'},
      {q:'What is STP in marketing?',opts:['Standard Trade Practice','Segmentation, Targeting, Positioning ‚Äî core marketing strategy framework','Sales, Trade, Profit','Strategic Trading Plan'],ans:1,exp:'STP: Segment the market, Target the right segments, Position your product to appeal to those segments.'},
      {q:'What is SWOT analysis?',opts:['A sales forecast','Analysis of Strengths, Weaknesses, Opportunities, Threats for strategic planning','Financial statement','Market size calculation'],ans:1,exp:'SWOT analysis identifies internal strengths/weaknesses and external opportunities/threats to inform strategy.'},
      {q:'What is content marketing?',opts:['Marketing a content company','Creating valuable content to attract and retain a target audience, building trust','Paid advertising','Social media posting'],ans:1,exp:'Content marketing creates useful, relevant content (blogs, videos, guides) to attract customers organically rather than interrupting them with ads.'},
      {q:'What is a marketing funnel?',opts:['A physical sales tool','Model depicting customer journey from awareness to purchase: Awareness ‚Üí Interest ‚Üí Decision ‚Üí Action','Sales quota','Marketing budget allocation'],ans:1,exp:'The marketing funnel shows how prospects become customers: Awareness (know you) ‚Üí Interest (engage) ‚Üí Decision (consider) ‚Üí Action (buy).'},
      {q:'What does ROI stand for in marketing?',opts:['Rate of Increase','Return on Investment ‚Äî revenue generated relative to marketing spend','Reach of Interest','Revenue Over Income'],ans:1,exp:'Marketing ROI = (Revenue from campaign - Campaign cost) / Campaign cost √ó 100%. Measures marketing efficiency.'},
    ]},
    'Financial Management':{icon:'üí∞',color:'#EDFAF3',questions:[
      {q:'What is NPV (Net Present Value)?',opts:['Total future cash flows','Sum of discounted future cash flows minus initial investment ‚Äî positive NPV means profitable','Net profit','Annual revenue'],ans:1,exp:'NPV = Œ£[CF_t/(1+r)^t] - Initial Investment. Positive NPV ‚Üí project adds value. Negative NPV ‚Üí project destroys value.'},
      {q:'What is working capital?',opts:['Total assets','Current Assets minus Current Liabilities ‚Äî short-term liquidity measure','Long-term debt','Total equity'],ans:1,exp:'Working Capital = Current Assets - Current Liabilities. Positive working capital means enough short-term assets to cover short-term debts.'},
      {q:'What is the debt-to-equity ratio?',opts:['Net profit ratio','Total debt divided by total equity ‚Äî measures financial leverage','Asset turnover','Liquidity ratio'],ans:1,exp:'D/E ratio = Total Debt / Total Equity. Higher ratio = more leverage/risk. Lower = more conservative financing.'},
      {q:'What is IRR (Internal Rate of Return)?',opts:['Inflation rate','Discount rate at which NPV = 0 ‚Äî minimum return a project must generate to be worthwhile','Interest rate','Income return ratio'],ans:1,exp:'IRR is the discount rate making NPV = 0. If IRR > required rate of return (hurdle rate), accept the project.'},
      {q:'What is EBITDA?',opts:['A tax formula','Earnings Before Interest, Taxes, Depreciation, and Amortization ‚Äî measure of operating performance','Total revenue','Net income'],ans:1,exp:'EBITDA shows operating profitability before financial and accounting charges. Used to compare companies.'},
      {q:'What is the time value of money?',opts:['Inflation adjustment','Concept that money available now is worth more than the same amount in the future due to earning potential','Interest rate','Currency exchange'],ans:1,exp:'A rupee today is worth more than a rupee in the future because it can earn returns. This is the basis for present value calculations.'},
      {q:'What is a balance sheet?',opts:['Monthly sales report','Financial statement showing assets, liabilities, and equity at a specific point in time','Income statement','Cash flow statement'],ans:1,exp:'Balance sheet: Assets = Liabilities + Equity. It is a snapshot of a company\'s financial position at a given date.'},
      {q:'What is the current ratio?',opts:['Interest rate','Current Assets / Current Liabilities ‚Äî measures ability to pay short-term obligations','Profit margin','Asset turnover'],ans:1,exp:'Current Ratio = Current Assets / Current Liabilities. Ratio >1 means company can cover short-term liabilities. Ideal: 1.5-2.'},
      {q:'What is capital budgeting?',opts:['Annual budget planning','Process of evaluating long-term investment decisions (machinery, projects, acquisitions)','Working capital management','Budget variance analysis'],ans:1,exp:'Capital budgeting evaluates major investments using NPV, IRR, payback period to allocate capital to value-creating projects.'},
      {q:'What is dividend policy?',opts:['Company tax policy','Decision on how much profit to distribute to shareholders vs reinvest in the business','Debt repayment policy','Pricing policy'],ans:1,exp:'Dividend policy determines the proportion of earnings paid as dividends. Trade-off: shareholder returns vs reinvestment for growth.'},
      {q:'What is leverage in finance?',opts:['Physical leverage','Using borrowed capital to amplify potential returns (and risks)','Market capitalization','Equity ratio'],ans:1,exp:'Financial leverage uses debt to amplify returns on equity. High leverage = higher potential returns but also higher risk and interest burden.'},
      {q:'What is beta (Œ≤) in stock analysis?',opts:['Company profit measure','Measure of a stock\'s volatility relative to the market (Œ≤=1: moves with market; >1: more volatile)','Annual dividend rate','Price-to-earnings ratio'],ans:1,exp:'Beta measures systematic risk. Œ≤>1: stock more volatile than market. Œ≤<1: less volatile. Œ≤<0: moves opposite to market.'},
    ]},
  },
  EEE:{
    'Electric Circuits':{icon:'üîå',color:'#FFFBEB',questions:[
      {q:'What is Ohm\'s Law?',opts:['V = P/I','V = IR (Voltage = Current √ó Resistance)','P = VI¬≤','R = V¬≤/P'],ans:1,exp:'Ohm\'s Law: V = IR. Voltage (Volts) = Current (Amperes) √ó Resistance (Ohms).'},
      {q:'What is Kirchhoff\'s Voltage Law (KVL)?',opts:['Sum of currents at node = 0','Sum of voltages around any closed loop = 0','Voltage divides equally','Current = Voltage / Resistance'],ans:1,exp:'KVL: The algebraic sum of all voltages around a closed loop equals zero (energy conservation).'},
      {q:'What is Kirchhoff\'s Current Law (KCL)?',opts:['Sum of voltages in a loop = 0','Sum of currents entering a node equals sum leaving (charge conservation)','Ohm\'s Law variation','Power law'],ans:1,exp:'KCL: Current in = Current out at any node. Based on conservation of charge.'},
      {q:'What is the unit of capacitance?',opts:['Henry','Ohm','Farad','Weber'],ans:2,exp:'Capacitance is measured in Farads (F). 1 Farad = 1 Coulomb/Volt. In practice, ŒºF and pF are common.'},
      {q:'What is impedance in AC circuits?',opts:['DC resistance only','Total opposition to AC current, combining resistance and reactance: Z = R + jX','Capacitance value','Frequency of AC'],ans:1,exp:'Impedance Z = R + jX (Ohms) combines resistance R and reactance X (from inductors/capacitors) in AC circuits.'},
      {q:'What happens to capacitor in steady-state DC?',opts:['Acts as short circuit','Acts as open circuit (blocks DC after charging)','Acts as inductor','Has no effect'],ans:1,exp:'In steady-state DC, a fully charged capacitor blocks current (acts as open circuit). In AC, it passes current.'},
      {q:'What is the power factor?',opts:['Power efficiency','Ratio of real power to apparent power: PF = cos(Œ∏)','Total power consumed','Reactive power ratio'],ans:1,exp:'Power factor = cos(œÜ) = Real Power (W) / Apparent Power (VA). PF=1: all power is useful. Low PF: more reactive power wasted.'},
      {q:'What is resonance in an RLC circuit?',opts:['Maximum resistance','Condition where inductive and capacitive reactances cancel: XL = XC','Minimum current flow','Maximum impedance'],ans:1,exp:'At resonance: XL = XC, so they cancel out. Impedance equals only R (minimum). Current is maximum at resonance.'},
      {q:'What is the unit of inductance?',opts:['Farad','Ohm','Henry','Weber'],ans:2,exp:'Inductance is measured in Henries (H). 1 Henry = 1 Volt¬∑second/Ampere.'},
      {q:'What is superposition theorem?',opts:['Total power = sum of individual powers','Response from multiple sources = sum of responses from each source acting alone','Currents add at nodes','Voltage is constant'],ans:1,exp:'Superposition: In a linear circuit, the response due to multiple sources is the sum of responses from each source individually.'},
      {q:'What is RMS value of AC voltage?',opts:['Peak voltage','Equivalent DC voltage that produces same heating effect: V_rms = V_peak/‚àö2','Average voltage','Half the peak voltage'],ans:1,exp:'RMS (Root Mean Square) voltage = Vpeak/‚àö2 ‚âà 0.707 √ó Vpeak. For 230V RMS mains, peak voltage ‚âà 325V.'},
      {q:'What is Thevenin\'s theorem?',opts:['Simplify to single current source','Any linear circuit can be replaced by a single voltage source Vth in series with resistance Rth','Norton equivalent','Superposition principle'],ans:1,exp:'Thevenin\'s theorem simplifies complex circuits to: Vth (open-circuit voltage) + Rth (equivalent resistance). Simplifies analysis.'},
    ]},
  },
  CIVIL:{
    'Structural Analysis':{icon:'üèóÔ∏è',color:'#EBF0FF',questions:[
      {q:'What is a simply supported beam?',opts:['Beam with no support','Beam supported at two ends with pin and roller supports ‚Äî can rotate but not translate','Fixed at both ends','A cantilever beam'],ans:1,exp:'Simply supported beam: pin support at one end (prevents translation), roller at other (allows horizontal movement). Most basic beam type.'},
      {q:'What is the bending moment?',opts:['Twisting force','Moment caused by transverse loads that causes beam to bend, measured in N¬∑m','Shear force','Axial force'],ans:1,exp:'Bending moment at a section = sum of moments of all forces on one side. Causes tensile stress at bottom and compressive at top (for sagging).'},
      {q:'What is a cantilever beam?',opts:['Simply supported beam','Beam fixed at one end and free at the other','A truss member','A column'],ans:1,exp:'Cantilever beam is fixed at one end (resists rotation AND translation) and free at the other. Maximum moment at fixed end.'},
      {q:'What is shear force?',opts:['Force along beam axis','Internal force acting perpendicular to beam axis ‚Äî tends to slide one portion past adjacent','Bending moment','Torsional force'],ans:1,exp:'Shear force (V) at a section = algebraic sum of transverse forces on one side. Shear force diagram (SFD) shows its variation.'},
      {q:'What is the moment of inertia (I) of a cross-section?',opts:['Area of cross-section','Measure of resistance to bending based on area distribution about neutral axis: I = ‚à´y¬≤dA','Weight moment','Polar moment for shafts'],ans:1,exp:'Second moment of area (I) represents resistance to bending. Larger I = stiffer beam. For rectangle: I = bd¬≥/12.'},
      {q:'What is Hooke\'s Law for beams?',opts:['F = ma','Stress = E √ó Strain (œÉ = EŒµ) ‚Äî elastic material deforms proportionally to load','P = mv','V = IR'],ans:1,exp:'Hooke\'s Law: within elastic limit, stress is proportional to strain. E = Young\'s Modulus (stiffness of material).'},
      {q:'What is a truss?',opts:['A type of column','Structure of interconnected triangular units ‚Äî members carry only axial (tension/compression) loads','A beam structure','A type of foundation'],ans:1,exp:'A truss is a framework of triangulated members where all loads are axial (no bending). Common in bridges and roofs.'},
      {q:'What is the neutral axis of a beam?',opts:['Center of the beam','Longitudinal axis where bending stress is zero ‚Äî no tension or compression','Top fiber','Bottom fiber'],ans:1,exp:'The neutral axis is the line where bending stress changes from tension to compression. For symmetric sections, it\'s at the centroid.'},
      {q:'What is Euler\'s buckling formula?',opts:['Bending stress formula','Critical compressive load for column buckling: Pcr = œÄ¬≤EI/L¬≤','Deflection formula','Shear stress formula'],ans:1,exp:'Euler\'s formula Pcr = œÄ¬≤EI/L¬≤ gives the critical load at which a slender column buckles. Beyond Pcr, column becomes unstable.'},
      {q:'What is the principle of superposition in structural analysis?',opts:['Forces cannot be combined','For linear elastic structures, total displacement = sum of individual displacements from each load','Loads must act simultaneously','All supports must be fixed'],ans:1,exp:'Superposition principle: linear structures allow us to add separate effects of each load to get total response. Valid for small deformations.'},
      {q:'What is yield strength of a material?',opts:['Maximum stress before fracture','Stress at which material transitions from elastic to plastic (permanent) deformation','Ultimate tensile strength','Modulus of elasticity'],ans:1,exp:'Yield strength is the stress at which permanent plastic deformation begins. Structures are designed to stay below yield stress.'},
      {q:'What is a statically indeterminate structure?',opts:['Structure that cannot stand','Structure where equations of equilibrium alone are insufficient to find all reactions ‚Äî has extra supports/members','A movable structure','An unstable structure'],ans:1,exp:'Indeterminate structures have more unknowns than equilibrium equations (degree of indeterminacy > 0). Requires compatibility equations.'},
    ]},
  },
};
// Merge department subjects into QUIZ_DATA based on user department
function getDeptSubjects(){
  const dept=cu?.dept||'OTHER';
  let deptData={};
  if(DEPT_QUIZ[dept])deptData=DEPT_QUIZ[dept];
  // Also add CSE subjects for IT
  if(dept==='IT'&&DEPT_QUIZ['CSE'])deptData={...DEPT_QUIZ['CSE'],...deptData};
  if(dept==='AI_ML'&&DEPT_QUIZ['AI_DS'])deptData={...DEPT_QUIZ['AI_DS'],...deptData};
  return deptData;
}
function getAllQuizData(){
  const base={...QUIZ_DATA};
  const dept=getDeptSubjects();
  return {...dept,...base};
}

function renderQuizSubjects(){
  document.getElementById('quizSubjectSelect').style.display='block';document.getElementById('quizArea').classList.remove('show');document.getElementById('quizResult').style.display='none';
  const all=getAllQuizData();
  const dept=cu?.dept||'OTHER';
  const deptSubjs=Object.keys(getDeptSubjects());
  const deptLabel=DEPT_LABELS[dept]||'General';
  let html='';
  if(deptSubjs.length>0){
    html+=`<div style="font-size:.75rem;font-weight:800;color:var(--acc);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:12px;padding:4px 0">üéì ${deptLabel} ‚Äî Your Department Subjects</div>`;
    html+=deptSubjs.map(s=>{const d=all[s];return `<div class="quiz-subj-card dept-subj${quizSubject===s?' selected':''}" onclick="selectSubject('${s.replace(/'/g,"\\'")}')"><div class="quiz-subj-icon">${d.icon}</div><div class="quiz-subj-name">${s}</div><div class="quiz-subj-cnt">${d.questions.length} questions</div></div>`;}).join('');
    html+=`<div style="font-size:.75rem;font-weight:800;color:var(--tx3);text-transform:uppercase;letter-spacing:1.5px;margin:18px 0 12px;padding:4px 0">üìö General Subjects</div>`;
  }
  html+=Object.keys(QUIZ_DATA).map(s=>{const d=QUIZ_DATA[s];return `<div class="quiz-subj-card${quizSubject===s?' selected':''}" onclick="selectSubject('${s.replace(/'/g,"\\'")}')"><div class="quiz-subj-icon">${d.icon}</div><div class="quiz-subj-name">${s}</div><div class="quiz-subj-cnt">${d.questions.length} questions</div></div>`;}).join('');
  document.getElementById('quizSubjectsGrid').innerHTML=html;
}
function selectSubject(s){quizSubject=s;renderQuizSubjects();document.getElementById('startQuizBtn').disabled=false;}
function startQuiz(){
  if(!quizSubject)return;const all=getAllQuizData();const qs=all[quizSubject].questions;quizQs=[...qs].sort(()=>Math.random()-.5).slice(0,10);quizIdx=0;quizScore=0;quizAnswered=false;
  document.getElementById('quizSubjectSelect').style.display='none';document.getElementById('quizArea').classList.add('show');document.getElementById('quizResult').style.display='none';renderQuizQ();
}
function renderQuizQ(){
  if(quizIdx>=quizQs.length){endQuiz();return;}
  const q=quizQs[quizIdx];quizAnswered=false;
  document.getElementById('quizQNum').textContent=`Question ${quizIdx+1}/${quizQs.length}`;
  document.getElementById('quizQ').textContent=q.q;
  document.getElementById('quizProgFill').style.width=(quizIdx/quizQs.length*100)+'%';
  document.getElementById('quizOpts').innerHTML=q.opts.map((o,i)=>`<button class="quiz-opt" onclick="answerQ(${i})">${String.fromCharCode(65+i)}. ${E(o)}</button>`).join('');
  document.getElementById('quizExp').classList.remove('show');document.getElementById('quizNextBtn').style.display='none';
  document.getElementById('quizScore').textContent=quizScore;
}
function answerQ(i){
  if(quizAnswered)return;quizAnswered=true;
  const q=quizQs[quizIdx];const opts=document.querySelectorAll('.quiz-opt');opts.forEach(o=>o.classList.add('locked'));
  opts[i].classList.add(i===q.ans?'correct':'wrong');opts[q.ans].classList.add('correct');
  if(i===q.ans){quizScore++;addXP(10,'Correct Answer');}
  document.getElementById('quizScore').textContent=quizScore;
  const exp=document.getElementById('quizExp');exp.textContent='üí° '+q.exp;exp.classList.add('show');
  document.getElementById('quizNextBtn').style.display='flex';
}
function nextQuestion(){quizIdx++;renderQuizQ();}
function endQuiz(){
  const pct=Math.round(quizScore/quizQs.length*100);
  document.getElementById('quizArea').classList.remove('show');const resEl=document.getElementById('quizResult');resEl.style.display='block';
  document.getElementById('quizFinalScore').textContent=quizScore+'/'+quizQs.length;
  document.getElementById('quizFinalMsg').textContent=pct>=90?'üéâ Outstanding! Perfect mastery!':pct>=70?'üåü Excellent work! You know this topic well!':pct>=50?'üëç Good effort! Keep reviewing and you\'ll improve!':'üìö Keep studying ‚Äî every attempt makes you better!';
  const xpEarned=quizScore*10+Math.floor(pct/10)*5;addXP(xpEarned,'Quiz Completed');
  const hist=G(`quizHist_${cu.email}`)||[];hist.push({subject:quizSubject,score:quizScore,total:quizQs.length,date:Date.now()});S(`quizHist_${cu.email}`,hist);
  addNotif(`Quiz "${quizSubject}": ${quizScore}/${quizQs.length} (${pct}%)`);checkBadges();
  // Show recent scores
  const recentEl=document.getElementById('quizTopScores');
  const recent=hist.slice(-5).reverse();
  recentEl.innerHTML=`<div style="margin-top:18px"><div style="font-size:.78rem;font-weight:800;color:var(--tx3);text-transform:uppercase;letter-spacing:1px;margin-bottom:12px">Recent Scores</div>${recent.map(r=>{const p=Math.round(r.score/r.total*100);return `<div class="qts-row"><span style="font-size:.8rem;color:var(--tx3)">${E(r.subject)}</span><span style="margin-left:auto;font-weight:900;color:${p>=80?'var(--green)':p>=60?'var(--amber)':'var(--red)'}">${p}%</span></div>`;}).join('')}</div>`;
}
function retakeQuiz(){startQuiz();}
function resetQuiz(){quizSubject=null;document.getElementById('startQuizBtn').disabled=true;renderQuizSubjects();}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê NOTES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function openNoteEditor(id){
  editNoteId=id||null;const n=id?notes.find(n=>n.id===id):null;
  document.getElementById('noteModalTitle').textContent=n?'Edit Note':'New Note';
  document.getElementById('nTitle').value=n?n.title:'';document.getElementById('nSubj').value=n?n.subject:'';document.getElementById('nContent').value=n?n.content:'';
  document.getElementById('noteModal').classList.add('show');
}
function saveNote(){
  const title=document.getElementById('nTitle').value.trim(),content=document.getElementById('nContent').value.trim();
  if(!title&&!content)return toast('Note is empty!','error');
  if(editNoteId){const n=notes.find(n=>n.id===editNoteId);if(n){n.title=title;n.subject=document.getElementById('nSubj').value;n.content=content;n.updated=Date.now();}}
  else{notes.unshift({id:Date.now().toString(),title:title||'Untitled',subject:document.getElementById('nSubj').value,content,created:Date.now(),updated:Date.now()});addXP(5,'Note Created');}
  saveAll();closeModal('noteModal');toast('Note saved!','success');renderNotes();checkBadges();editNoteId=null;
}
function deleteNote(id){if(!confirm('Delete this note?'))return;notes=notes.filter(n=>n.id!==id);saveAll();renderNotes();}
function renderNotes(){
  const filtered=noteCat?notes.filter(n=>n.subject===noteCat):notes;
  const subjects={All:notes.length};notes.forEach(n=>{const s=n.subject||'General';subjects[s]=(subjects[s]||0)+1;});
  document.getElementById('notesSidebar').innerHTML=Object.entries(subjects).map(([s,c])=>`<button class="note-cat${noteCat===s||(s==='All'&&!noteCat)?' active':''}" onclick="noteCat='${s==='All'?'':s}';renderNotes()"><span>${s==='All'?'üìö':s==='Mathematics'?'üìê':s==='Physics'?'‚ö°':s==='Biology'?'üß¨':s==='Chemistry'?'üß™':s==='Computer Science'?'üíª':s==='English'?'üìñ':'üìù'}</span> ${E(s)}<span class="note-cat-cnt">${c}</span></button>`).join('');
  document.getElementById('notesGrid').innerHTML=filtered.length?filtered.map(n=>`<div class="note-card"><div class="note-title">${E(n.title||'Untitled')}</div><div class="note-preview">${E(n.content||'No content')}</div><div class="note-footer"><span class="note-date">üìÖ ${new Date(n.updated||n.created).toLocaleDateString()}</span>${n.subject?`<span class="note-subj-tag">${E(n.subject)}</span>`:''}<div style="display:flex;gap:5px"><div class="ic-btn" onclick="openNoteEditor('${n.id}')">‚úé</div><div class="ic-btn del" onclick="deleteNote('${n.id}')">‚úï</div></div></div></div>`).join(''):`<div class="empty-s" style="grid-column:1/-1"><span class="ei">üìù</span><div class="et">No notes here</div><div class="es">Add your first note to get started</div></div>`;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AI TOOLS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function switchAITool(t,btn){
  document.querySelectorAll('.ai-tool-panel').forEach(p=>p.classList.remove('show'));
  document.querySelectorAll('.ai-tool-tab').forEach(b=>b.classList.remove('active'));
  document.getElementById('tool-'+t).classList.add('show');
  btn.classList.add('active');
  // Auto-fill predictor with real data
  if(t==='predictor'){
    const quizH=G(`quizHist_${cu?.email||''}`)||[];
    const avgQ=quizH.length?Math.round(quizH.reduce((s,q)=>s+(q.score/q.total*100),0)/quizH.length):65;
    const tasksDone=tasks.filter(t=>t.status==='completed').length;
    const taskRate=tasks.length?Math.round((tasksDone/tasks.length)*100):70;
    const sl=document.querySelectorAll('#tool-predictor .sl');
    if(sl[1])sl[1].value=avgQ;if(sl[2])sl[2].value=taskRate;
    // Update display values
    const sv2=document.getElementById('sv-quiz');if(sv2)sv2.textContent=avgQ+'%';
    const sv3=document.getElementById('sv-asgn');if(sv3)sv3.textContent=taskRate+'%';
    // Show banner if real data used
    const banner=document.querySelector('#tool-predictor .ai-input-card');
    if(banner&&quizH.length){
      const existing=document.getElementById('autofillBanner');if(!existing){
        const b=document.createElement('div');b.id='autofillBanner';b.style.cssText='background:var(--green-bg);border:1.5px solid rgba(21,163,82,.25);border-radius:var(--r-sm);padding:8px 12px;margin-bottom:12px;font-size:.8rem;color:var(--tx3);';b.innerHTML=`‚úÖ <strong>Auto-filled</strong> from your real data: ${quizH.length} quizzes (avg ${avgQ}%), ${tasksDone} tasks done`;
        banner.insertBefore(b,banner.firstChild);
      }
    }
  }
  if(t==='difficulty'){
    const quizH=G(`quizHist_${cu?.email||''}`)||[];
    if(quizH.length){const lastQ=quizH[quizH.length-1];const lastPct=Math.round(lastQ.score/lastQ.total*100);const dfSc=document.getElementById('df-score');const dfSv=document.getElementById('df-sv');if(dfSc){dfSc.value=lastPct;if(dfSv)dfSv.textContent=lastPct+'%';}}
  }
}

function predictPerf(){
  const h=parseInt(document.querySelector('#tool-predictor .sl:nth-child(1)').value||3);
  const q=parseInt(document.querySelector('#tool-predictor .sl:nth-child(2)')?.value||65);
  const a=parseInt(document.querySelector('#tool-predictor .sl:nth-child(3)')?.value||70);
  const at=parseInt(document.querySelector('#tool-predictor .sl:nth-child(4)')?.value||80);
  const int=parseInt(document.querySelector('#tool-predictor .sl:nth-child(5)')?.value||7);
  const score=Math.min(99,Math.round(h*2.5+q*.35+a*.15+at*.1+int*1.5+Math.random()*4-2));
  const grade=score>=90?'A+':score>=80?'A':score>=70?'B+':score>=60?'B':score>=50?'C':'D';
  const msg=score>=80?'Excellent! You\'re well on track for top grades. Keep up this momentum!':score>=65?'Good performance expected. A bit more focus on quiz practice will push you higher!':score>=50?'Moderate performance predicted. Increase study hours and review weak areas.':'More intensive study recommended. Focus on fundamentals and take more quizzes.';
  addXP(5,'Used AI Predictor');
  document.getElementById('predictResult').innerHTML=`<div class="result-card" style="width:100%"><div class="result-badge">üîÆ AI Prediction</div><div class="result-big">${score}%</div><div style="font-family:var(--font-d);font-size:1.8rem;font-weight:900;color:var(--acc);margin-bottom:11px">Grade ${grade}</div><div class="result-msg">${msg}</div></div>`;
}

function adaptDifficulty(){
  const score=parseInt(document.getElementById('df-score').value);const time=parseInt(document.getElementById('df-time').value);const err=parseInt(document.getElementById('df-err').value);const comp=parseInt(document.getElementById('df-comp').value);
  const raw=(score*.4+(100-err)*.3+comp*.2+(60-time)/60*100*.1);
  const lv=raw>=80?{n:'Advanced üöÄ',d:'You\'re ready for challenging material. Try harder problems and advanced topics.',c:'var(--purple)'}:raw>=60?{n:'Intermediate ‚≠ê',d:'Solid foundation! Mix standard practice with some harder problems to keep growing.',c:'var(--acc)'}:raw>=40?{n:'Developing üìà',d:'Good progress! Focus on reinforcing fundamentals before moving to harder material.',c:'var(--amber)'}:{n:'Beginner üå±',d:'Start with the basics. Master core concepts thoroughly before advancing.',c:'var(--green)'};
  addXP(5,'Used Difficulty Adapter');
  document.getElementById('diffResult').innerHTML=`<div class="result-card" style="width:100%"><div class="result-badge">üéØ Recommended Level</div><div style="font-family:var(--font-d);font-size:2.2rem;font-weight:900;color:${lv.c};margin-bottom:13px">${lv.n}</div><div class="result-msg">${lv.d}</div></div>`;
}

function buildPlan(){
  const diff=parseInt(document.getElementById('pl-diff').value);const know=parseInt(document.getElementById('pl-know').value);const days=parseInt(document.getElementById('pl-days').value);const target=parseInt(document.getElementById('pl-target').value);
  const hrs=Math.max(1,Math.round((diff*1.5+(10-know)*0.8)*(target/100)*1.2));const perDay=(hrs/days).toFixed(1);
  const phases=[{p:'Foundation ('+Math.ceil(days*.25)+'d)',t:'Review core concepts and identify weak areas',h:(hrs*.25).toFixed(0)},{p:'Deep Study ('+Math.ceil(days*.4)+'d)',t:'Intensive topic-by-topic coverage',h:(hrs*.4).toFixed(0)},{p:'Practice ('+Math.ceil(days*.25)+'d)',t:'Mock tests, past papers, quizzes',h:(hrs*.25).toFixed(0)},{p:'Revision ('+Math.ceil(days*.1)+'d)',t:'Final review, highlight sheets, rest',h:(hrs*.1).toFixed(0)}];
  addXP(10,'Used Study Planner');
  document.getElementById('planResult').innerHTML=`<div class="result-card" style="width:100%"><div class="result-badge">üìÖ Your Study Plan</div><div style="display:flex;justify-content:space-around;margin-bottom:20px"><div style="text-align:center"><div style="font-family:var(--font-d);font-size:2rem;font-weight:900;color:var(--acc)">${hrs}h</div><div style="font-size:.76rem;color:var(--tx3)">Total Study</div></div><div style="text-align:center"><div style="font-family:var(--font-d);font-size:2rem;font-weight:900;color:var(--purple)">${perDay}h</div><div style="font-size:.76rem;color:var(--tx3)">Per Day</div></div></div>${phases.map((p,i)=>`<div class="plan-day"><div class="plan-day-num">${i+1}</div><div class="plan-day-info"><div class="plan-day-title">${p.p}</div><div class="plan-day-sub">${p.t}</div></div><div class="plan-day-hrs">${p.h}h</div></div>`).join('')}</div>`;
}

function detectStyle(){
  const v=parseInt(document.getElementById('ls-vis').value);const a=parseInt(document.getElementById('ls-aud').value);const r=parseInt(document.getElementById('ls-rw').value);const k=parseInt(document.getElementById('ls-kin').value);
  const styles={Visual:{val:v,icon:'üëÅÔ∏è',tips:['Use mind maps and diagrams','Watch video explanations','Colour-code your notes','Create charts and timelines']},Auditory:{val:a,icon:'üéß',tips:['Record lectures and replay','Study with background music','Discuss topics aloud','Use mnemonic rhymes']},Reading:{val:r,icon:'üìñ',tips:['Detailed written notes are your strength','Create comprehensive summaries','Use flashcards with text','Read textbooks thoroughly']},'Kinaesthetic':{val:k,icon:'üñêÔ∏è',tips:['Use hands-on practice problems','Take frequent movement breaks','Recreate experiments','Use physical models']}};
  const dominant=Object.entries(styles).sort((a,b)=>b[1].val-a[1].val)[0];addXP(5,'Used Learning Style Detector');
  document.getElementById('styleResult').innerHTML=`<div class="result-card" style="width:100%"><div class="result-badge">üß† Your Learning Style</div><div style="font-size:3rem;margin-bottom:10px">${dominant[1].icon}</div><div style="font-family:var(--font-d);font-size:2rem;font-weight:900;color:var(--acc);margin-bottom:18px">${dominant[0]}</div><div style="text-align:left">${dominant[1].tips.map(t=>`<div style="padding:8px 0;border-bottom:1px solid var(--border);font-size:.9rem;color:var(--tx2)">‚úÖ ${t}</div>`).join('')}</div></div>`;
}

const TOPICS=['Algebra','Calculus','Trigonometry','Statistics','Newton\'s Laws','Thermodynamics','Waves & Sound','Electromagnetism','Arrays & Lists','Recursion','Databases','Networks','Organic Chemistry','Periodic Table','Chemical Bonding','Equilibrium','Cell Biology','Genetics','Evolution','Ecology','Grammar & Punctuation','Essay Writing','Literary Devices','Poetry'];
function renderTopicCheckGrid(){
  document.getElementById('topicCheckGrid').innerHTML=TOPICS.map((t,i)=>`<label style="display:flex;align-items:center;gap:9px;padding:10px 13px;background:var(--surface);border:1.5px solid ${topicsDone.includes(i)?'var(--acc)':'var(--border)'};border-radius:var(--r-sm);cursor:pointer;transition:all .15s;font-size:.88rem;font-weight:600;color:var(--tx2)"><input type="checkbox" ${topicsDone.includes(i)?'checked':''} style="accent-color:var(--acc);width:16px;height:16px" onchange="toggleTopic(${i})"/> ${t}</label>`).join('');
}
function toggleTopic(i){if(topicsDone.includes(i))topicsDone=topicsDone.filter(x=>x!==i);else topicsDone.push(i);S(`topics_${cu.email}`,topicsDone);renderTopicCheckGrid();}
function getTopicRecs(){
  const done=new Set(topicsDone);const remaining=TOPICS.filter((_,i)=>!done.has(i));
  const recs=remaining.sort(()=>Math.random()-.5).slice(0,5);addXP(5,'Used Topic Recommender');
  document.getElementById('topicRecResult').innerHTML=`<div class="result-card"><div class="result-badge">‚úÖ Study These Next</div>${recs.map(r=>`<div style="padding:11px 0;border-bottom:1px solid rgba(61,90,254,.1);font-size:.93rem;color:var(--tx2);font-weight:600">üìå ${E(r)}</div>`).join('')}<div style="margin-top:13px;font-size:.84rem;color:var(--tx3)">Mastering these will complete your curriculum coverage!</div></div>`;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê POMODORO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function setPomoPhase(ph,btn){
  pomoPhase=ph;document.querySelectorAll('.pomo-mode-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');
  pomoLeft=pomoTimes[ph]*60;pomoTotal=pomoLeft;pomoRunning=false;clearInterval(pomoTimer);
  document.getElementById('pomoPlayBtn').textContent='‚ñ∂';renderPomodoro();
}
function pomoToggle(){
  if(pomoRunning){clearInterval(pomoTimer);pomoRunning=false;document.getElementById('pomoPlayBtn').textContent='‚ñ∂';}
  else{pomoRunning=true;document.getElementById('pomoPlayBtn').textContent='‚è∏';
    if(pomoLeft<=0)pomoReset();
    pomoTimer=setInterval(()=>{pomoLeft--;if(pomoLeft<=0){clearInterval(pomoTimer);pomoRunning=false;document.getElementById('pomoPlayBtn').textContent='‚ñ∂';pomoComplete();}renderPomodoro();syncFocus();},1000);
  }
}
function pomoComplete(){
  if(pomoPhase==='focus'){pomoSessions++;pomoFocused+=pomoTimes.focus;addXP(25,'Pomodoro Session');markStreak();addNotif('üçÖ Pomodoro complete! Take a break.');toast('üçÖ Session done! +25 XP. Time for a break!','success');}
  else{pomoBreaks++;addNotif('‚òï Break over! Ready to focus?');toast('‚òï Break done! Ready to focus?','info');}
  renderPomodoro();
}
function pomoReset(){clearInterval(pomoTimer);pomoRunning=false;pomoLeft=pomoTimes[pomoPhase]*60;pomoTotal=pomoLeft;document.getElementById('pomoPlayBtn').textContent='‚ñ∂';renderPomodoro();syncFocus();}
function pomoSkip(){pomoLeft=0;pomoComplete();}
function renderPomodoro(){
  const m=String(Math.floor(pomoLeft/60)).padStart(2,'0'),s=String(pomoLeft%60).padStart(2,'0');
  const pt=document.getElementById('pomoTime');if(pt)pt.textContent=m+':'+s;
  const pm=document.getElementById('pomoModeLabel');if(pm)pm.textContent=pomoPhase==='focus'?'Focus Session':pomoPhase==='short'?'Short Break':'Long Break';
  const pf=document.getElementById('pomoFill');if(pf){const prog=(1-pomoLeft/pomoTotal)*628;pf.style.strokeDashoffset=628-prog;pf.style.stroke=pomoPhase==='focus'?'var(--acc)':pomoPhase==='short'?'var(--green)':'var(--purple)';}
  const sr=document.getElementById('pomoSessRow');if(sr)sr.innerHTML=Array(4).fill(0).map((_,i)=>`<div class="pomo-s-dot${i<pomoSessions%4?' done':i===pomoSessions%4?' cur':''}"></div>`).join('');
  const sv=document.getElementById('pomoStatSessions');if(sv)sv.textContent=pomoSessions;const st=document.getElementById('pomoStatTime');if(st)st.textContent=pomoFocused+'m';const sb=document.getElementById('pomoStatBreaks');if(sb)sb.textContent=pomoBreaks;
  // Task selector
  const sel=document.getElementById('pomoTaskSel');if(sel){const cur=sel.value;sel.innerHTML='<option value="">‚Äî Select a task (optional) ‚Äî</option>'+tasks.filter(t=>t.status!=='completed').map(t=>`<option value="${t.id}">${E(t.title)}</option>`).join('');sel.value=cur;}
}
function setPomoDefault(mins,btn){
  pomoTimes.focus=mins;const pref=G('sb_pref')||{};pref.pomoDef=mins;S('sb_pref',pref);
  document.querySelectorAll('#p20,#p25,#p30,#p45').forEach(b=>b.classList.remove('active'));btn.classList.add('active');
  toast(`Focus duration set to ${mins} minutes!`,'success');if(!pomoRunning){pomoLeft=mins*60;pomoTotal=pomoLeft;renderPomodoro();}
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FOCUS OVERLAY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function enterFocus(){document.getElementById('focusOv').classList.add('show');syncFocus();}
function exitFocus(){document.getElementById('focusOv').classList.remove('show');}
function syncFocus(){
  const m=String(Math.floor(pomoLeft/60)).padStart(2,'0'),s=String(pomoLeft%60).padStart(2,'0');
  const ft=document.getElementById('focusTime');if(ft)ft.textContent=m+':'+s;
  const fm=document.getElementById('focusMode');if(fm)fm.textContent=pomoPhase==='focus'?'Focus Session':pomoPhase==='short'?'Short Break':'Long Break';
  const ff=document.getElementById('focusFill');if(ff){const prog=(1-pomoLeft/pomoTotal)*628;ff.style.strokeDashoffset=628-prog;ff.style.stroke=pomoPhase==='focus'?'var(--acc)':'var(--green)';}
  const fpb=document.getElementById('focusPlayBtn');if(fpb)fpb.textContent=pomoRunning?'‚è∏':'‚ñ∂';
  const sel=document.getElementById('pomoTaskSel');const taskName=sel?tasks.find(t=>t.id===sel.value)?.title||'Deep Focus Session':'Deep Focus Session';
  const ftl=document.getElementById('focusTaskLbl');if(ftl)ftl.textContent=taskName;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MUSIC WIDGET ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const TRACKS=[{name:'Lo-Fi Study Beats',artist:'ChilledCow ¬∑ 128 BPM'},{name:'Deep Focus Flow',artist:'StudyStream ¬∑ 95 BPM'},{name:'Classical Morning',artist:'Mozart Collective ¬∑ Baroque'},{name:'Nature Ambience',artist:'Rainforest Sounds ¬∑ 0 BPM'},{name:'Alpha Waves',artist:'BrainWave Lab ¬∑ 10 Hz'}];
function toggleMusic(){musicPlaying=!musicPlaying;document.getElementById('musicPlayBtn').textContent=musicPlaying?'‚è∏':'‚ñ∂';if(musicPlaying)toast('üéµ Music playing (simulated)','info');}
function nextTrack(){musicTrackIdx=(musicTrackIdx+1)%TRACKS.length;updateMusicUI();}
function prevTrack(){musicTrackIdx=(musicTrackIdx-1+TRACKS.length)%TRACKS.length;updateMusicUI();}
function updateMusicUI(){const t=TRACKS[musicTrackIdx];document.getElementById('musicTrack').textContent=t.name;document.getElementById('musicArtist').textContent=t.artist;}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GAMIFY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const XP_SOURCES=[{ic:'‚úÖ',label:'Task Done',xp:20},{ic:'üß†',label:'Quiz Correct',xp:10},{ic:'üìù',label:'New Note',xp:5},{ic:'‚è±Ô∏è',label:'Pomodoro',xp:25},{ic:'‚ö°',label:'Daily Challenge',xp:50},{ic:'üÉè',label:'Flashcard',xp:5},{ic:'üéØ',label:'Goal Created',xp:10},{ic:'‚ú®',label:'AI Tools',xp:5}];
const LEADERBOARD=[{name:'Aarav Sharma',xp:3240,av:'A',you:false},{name:'Priya Nair',xp:2890,av:'P',you:false},{name:'Rohan Patel',xp:2650,av:'R',you:false},{name:'Sneha Iyer',xp:2340,av:'S',you:false},{name:'Karthik B',xp:1980,av:'K',you:false},{name:'Meera Reddy',xp:1720,av:'M',you:false},{name:'Arjun Das',xp:1560,av:'A',you:false}];

function renderGamify(){
  const xp=getXP();const lv=getLvl(xp);const idx=getLvlIdx(xp);const next=getNextLvl(xp);const pct=next?Math.round(((xp-lv.min)/(next.min-lv.min))*100):100;
  document.getElementById('gLevelEmoji').textContent=lv.emoji;document.getElementById('gLevelNum').textContent=idx+1;document.getElementById('gLevelName').textContent=lv.name;document.getElementById('gXP').textContent=xp;document.getElementById('gTotalXP').textContent=xp;document.getElementById('gXPBar').style.width=pct+'%';document.getElementById('gXPNext').textContent=next?(next.min-xp)+' XP to '+next.name:'MAX LEVEL!';
  document.getElementById('xpSources').innerHTML=XP_SOURCES.map(x=>`<div class="card" style="text-align:center;cursor:default"><div style="font-size:1.8rem;margin-bottom:8px">${x.ic}</div><div style="font-family:var(--font-d);font-weight:900;font-size:1.3rem;color:var(--acc)">+${x.xp}</div><div style="font-size:.78rem;color:var(--tx3);font-weight:700">${x.label}</div></div>`).join('');
  // Detailed XP sources
  const xpDetEl=document.getElementById('xpSourcesDetailed');
  if(xpDetEl)xpDetEl.innerHTML=XP_SOURCES.map(x=>`<div style="display:flex;align-items:center;gap:13px;padding:11px 0;border-bottom:1px solid var(--border)"><div style="width:40px;height:40px;border-radius:12px;background:var(--acc-bg);display:flex;align-items:center;justify-content:center;font-size:1.2rem">${x.ic}</div><div style="flex:1"><div style="font-weight:800;font-size:.9rem;color:var(--tx)">${x.label}</div></div><div style="font-family:var(--font-d);font-weight:900;color:var(--acc)">+${x.xp} XP</div></div>`).join('');
  const unlocked=getUnlockedBadges();document.getElementById('badgeCount').textContent=`${unlocked.length}/${BADGES.length} unlocked`;
  document.getElementById('badgesGrid').innerHTML=BADGES.map(b=>{const u=unlocked.includes(b.id);return `<div class="badge-card${u?' unlocked':' locked'}"><span class="badge-ic">${b.emoji}</span><div class="badge-name">${b.name}</div><div class="badge-desc">${b.desc}</div><div class="badge-xp">${u?'‚úÖ Earned':'üîí +'+b.xp+' XP'}</div></div>`;}).join('');
  const lb=[...LEADERBOARD,{name:cu.name+' (You)',xp,av:cu.name.charAt(0).toUpperCase(),you:true}].sort((a,b)=>b.xp-a.xp);
  const medalColors=['#FFD700','#C0C0C0','#CD7F32'];
  document.getElementById('leaderboard').innerHTML=lb.map((p,i)=>`<div class="lb-row${p.you?' you-row':''}"><div class="lb-rank" style="background:${i<3?medalColors[i]:'var(--surface2)'};color:${i<3?'#000':'var(--tx3)'};font-size:${i<3?'1rem':'.85rem'}">${i<3?['ü•á','ü•à','ü•â'][i]:i+1}</div><div class="lb-av" style="background:linear-gradient(135deg,var(--acc),var(--purple))">${p.av}</div><div style="flex:1"><div style="font-size:.9rem;font-weight:${p.you?900:700};color:var(--tx)">${E(p.name)}</div></div><div style="font-family:var(--font-d);font-weight:900;color:${p.you?'var(--acc)':'var(--tx2)'}">${p.xp.toLocaleString()} XP</div></div>`).join('');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DAILY CHALLENGE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const WOTD_LIST=[{word:'Ephemeral',pos:'adjective',def:'Lasting for a very short time; transitory. "The ephemeral beauty of cherry blossoms makes them precious."'},{word:'Perspicacious',pos:'adjective',def:'Having a ready insight into and understanding of things. "A perspicacious student sees patterns others miss."'},{word:'Assiduity',pos:'noun',def:'Constant and careful attention or effort; diligence. "Assiduity in daily study leads to lasting mastery."'},{word:'Sanguine',pos:'adjective',def:'Optimistic, especially in difficult situations. "Despite setbacks, she remained sanguine about the exam."'},{word:'Elucidate',pos:'verb',def:'To make clear or explain thoroughly. "The professor elucidate the complex formula with simple examples."'},{word:'Tenacity',pos:'noun',def:'Determination; persistent courage. "With tenacity, no academic goal is beyond your reach."'},{word:'Cogent',pos:'adjective',def:'Clear, logical and convincing. "A cogent argument is essential in any good essay."'}];
const FACTS_LIST=['The human brain can store approximately 2.5 petabytes of information ‚Äî equivalent to 3 million hours of TV.','Forgetting is actually a form of learning ‚Äî it helps the brain prioritise what is truly important to retain.','The spacing effect shows that distributed practice over days is up to 40% more effective than massed cramming.','Handwriting notes activates deeper processing than typing, improving understanding and long-term retention by 25%.','Sleep consolidates memories ‚Äî students who sleep well after studying perform up to 30% better on tests.','The Pomodoro technique was proven to increase focus and reduce mental fatigue by 30% in university studies.','Reading out loud to yourself improves memory by up to 25% compared to silent reading.'];
const DAILY_TIPS=['Write down 3 things you will accomplish TODAY before opening any textbook ‚Äî clarity breeds productivity.','Every 30 minutes of study, stand up, walk for 2 minutes. It boosts blood flow and resets your focus.','Test yourself instead of re-reading. Close your notes and write down everything you know. This is 2√ó more effective.','Study your hardest subject when your energy is highest ‚Äî usually morning after breakfast.','Before sleeping, mentally review the top 3 concepts you learned today. This supercharges memory consolidation.','Explain what you learned to an imaginary student. If you can teach it simply, you truly understand it.','Set a timer for 2 minutes and write everything you know about a topic without stopping. Then fill the gaps.'];
const CHALLENGES=[
  {title:'The Pomodoro Sprint',desc:'Complete 2 full Pomodoro sessions (25 mins each) today.',xp:50},
  {title:'Quiz Master',desc:'Take a quiz in any subject and score at least 70%.',xp:60},
  {title:'Note Blitz',desc:'Create 3 study notes on different topics today.',xp:45},
  {title:'Task Crusher',desc:'Complete 3 tasks from your task list today.',xp:55},
  {title:'Flashcard Review',desc:'Review at least 5 flashcards using the spaced repetition system.',xp:40},
  {title:'Knowledge Goals',desc:'Set 2 new subject goals and update your progress on existing ones.',xp:35},
  {title:'Subject Deep Dive',desc:'Spend 45+ minutes on your weakest subject today.',xp:65},
  {title:'Early Bird',desc:'Complete at least 2 tasks before 12 PM today.',xp:55},
  {title:'Quiz Streak',desc:'Take quizzes in 2 different subjects today.',xp:70},
  {title:'Note Master',desc:'Create a detailed note with at least 5 key points on any topic.',xp:45},
  {title:'High Priority Hero',desc:'Complete all your high priority tasks today.',xp:80},
  {title:'Flashcard Creator',desc:'Create 5 new flashcards on topics you studied today.',xp:50},
  {title:'Revision Round',desc:'Review notes from 3 different subjects today.',xp:60},
  {title:'Perfect Pomodoro',desc:'Complete 3 full Pomodoro sessions without interruption.',xp:75},
  {title:'Knowledge Sharer',desc:'Write a summary note explaining a concept you learned today.',xp:40},
  {title:'Goal Getter',desc:'Update progress on at least 2 subject goals today.',xp:45},
  {title:'Speed Learner',desc:'Complete a quiz scoring 80%+ in under 5 minutes.',xp:65},
  {title:'Task Planner',desc:'Add 3 new tasks with due dates and priorities set.',xp:35},
  {title:'Deep Focus Day',desc:'Complete 4 Pomodoro sessions ‚Äî that\'s 1 hour 40 mins of pure focus!',xp:90},
  {title:'Subject Explorer',desc:'Take a quiz in a subject you haven\'t tried before.',xp:60},
  {title:'Memory Builder',desc:'Create 10 flashcards and review all due cards today.',xp:70},
  {title:'Consistency King',desc:'Study for at least 30 minutes and log it with a Pomodoro session.',xp:50},
  {title:'Weekend Warrior',desc:'Complete 5 tasks today ‚Äî weekend hustle pays off!',xp:85},
  {title:'Note Organiser',desc:'Review and edit 3 existing notes, adding more details.',xp:40},
  {title:'Challenge Accepted',desc:'Score 90%+ on any quiz today.',xp:100},
  {title:'Streak Builder',desc:'Complete at least one task to keep your study streak alive!',xp:30},
  {title:'Focus Marathon',desc:'Do 5 Pomodoro sessions today. You\'ll earn massive XP!',xp:110},
  {title:'Subject Mastery',desc:'Score 80%+ in the same subject twice today.',xp:75},
  {title:'Task Finisher',desc:'Clear all overdue tasks from your list today.',xp:95},
  {title:'Brain Gym',desc:'Take quizzes in 3 different subjects and score 60%+ in each.',xp:85}];

function renderDaily(){
  const today=new Date();const di=today.getDay();
  document.getElementById('dailyDate').textContent=today.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'});
  const dayOfYear=Math.floor((new Date()-new Date(new Date().getFullYear(),0,0))/(1000*60*60*24));
const ch=CHALLENGES[dayOfYear%CHALLENGES.length];document.getElementById('dailyXP').textContent=ch.xp;
  const done=(G(`dailyDone_${cu.email}`)||[]).includes(today.toDateString());
  document.getElementById('dailyChallengeArea').innerHTML=`<div style="font-family:var(--font-d);font-size:1.15rem;font-weight:800;color:var(--tx);margin-bottom:8px">${ch.title}</div><div style="font-size:.93rem;color:var(--tx2);line-height:1.75;margin-bottom:18px">${ch.desc}</div>${done?`<div style="padding:13px 18px;background:var(--green-bg);border:1px solid var(--green-border);border-radius:var(--r-sm);color:var(--green);font-weight:800;font-size:.92rem">‚úÖ Challenge Completed! +${ch.xp} XP earned</div>`:`<button class="btn btn-p" onclick="completeDaily(${ch.xp})">‚ö° Mark as Complete (+${ch.xp} XP)</button>`}`;
  const wi=today.getDate()%WOTD_LIST.length;const wotd=WOTD_LIST[wi];
  document.getElementById('wotdWord').textContent=wotd.word;document.getElementById('wotdPos').textContent=wotd.pos;document.getElementById('wotdDef').textContent=wotd.def;
  const fi=today.getDate()%FACTS_LIST.length;document.getElementById('factText').textContent=FACTS_LIST[fi];
  const todayTasks=tasks.filter(t=>t.due===today.toISOString().split('T')[0]&&t.status!=='completed');
  document.getElementById('dailyTasks').innerHTML=todayTasks.length?todayTasks.map(t=>`<div class="daily-task-row"><div class="dt-cb${t.status==='completed'?' ck':''}" onclick="toggleDone('${t.id}');renderDaily()">${t.status==='completed'?'‚úì':''}</div><span style="font-size:.9rem;font-weight:700;color:var(--tx)">${E(t.title)}</span><span class="pill p${t.priority.charAt(0)}" style="margin-left:auto">${t.priority}</span></div>`).join(''):`<div style="text-align:center;padding:18px;color:var(--tx3);font-size:.88rem">üéâ No tasks due today!</div>`;
  document.getElementById('dailyTip').textContent=DAILY_TIPS[di%DAILY_TIPS.length];
}
function completeDaily(xp){
  const today=new Date().toDateString();const done=G(`dailyDone_${cu.email}`)||[];if(done.includes(today))return;
  done.push(today);S(`dailyDone_${cu.email}`,done);addXP(xp,'Daily Challenge');markStreak();toast(`‚ö° Daily challenge complete! +${xp} XP`,'success');addNotif('‚ö° Daily challenge completed! +'+xp+' XP');checkBadges();renderDaily();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FLASHCARDS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function openFlashcardAdd(){const f=document.getElementById('fcAddForm');f.classList.toggle('show');if(f.classList.contains('show')){document.getElementById('fcFrontInp').value='';document.getElementById('fcBackInp').value='';}}
function saveFlashcard(){
  const front=document.getElementById('fcFrontInp').value.trim(),back=document.getElementById('fcBackInp').value.trim(),subj=document.getElementById('fcSubj').value;
  if(!front||!back)return toast('Fill in both sides!','error');
  fcCards.unshift({id:Date.now().toString(),front,back,subj,created:Date.now(),nextReview:Date.now(),interval:1,easeFactor:2.5,reps:0});
  S(`flashcards_${cu.email}`,fcCards);document.getElementById('fcAddForm').classList.remove('show');addXP(5,'Flashcard Created');toast('Card saved!','success');checkBadges();renderFlashcards();
}
function startFlashcardReview(){
  const due=fcCards.filter(c=>c.nextReview<=Date.now());if(!due.length)return toast('No cards due for review! Check back later.','info');
  fcReviewQueue=[...due];fcIdx=0;fcFlipped=false;document.getElementById('fcListArea').style.display='none';document.getElementById('fcReviewArea').style.display='block';showFC();
}
function showFC(){
  if(fcIdx>=fcReviewQueue.length){endReview();return;}
  const c=fcReviewQueue[fcIdx];fcFlipped=false;document.getElementById('fcCard').classList.remove('fc-flipped');document.getElementById('fcFrontText').textContent=c.front;document.getElementById('fcBackText').textContent=c.back;document.getElementById('fcProgress').textContent=`Card ${fcIdx+1}/${fcReviewQueue.length}`;document.getElementById('fcProgBar').style.width=((fcIdx/fcReviewQueue.length)*100)+'%';document.getElementById('fcRatingBtns').style.display='none';
}
function flipCard(){if(!fcFlipped){fcFlipped=true;document.getElementById('fcCard').classList.add('fc-flipped');document.getElementById('fcRatingBtns').style.display='flex';}}
function rateCard(r){
  const c=fcReviewQueue[fcIdx];const origCard=fcCards.find(fc=>fc.id===c.id);if(origCard){if(r===1){origCard.interval=1;origCard.easeFactor=Math.max(1.3,origCard.easeFactor-.2);}else if(r===2){origCard.interval=Math.round(origCard.interval*origCard.easeFactor*.8);}else{origCard.interval=Math.round(origCard.interval*origCard.easeFactor);origCard.easeFactor=Math.min(3,origCard.easeFactor+.1);}origCard.nextReview=Date.now()+origCard.interval*86400000;origCard.reps++;}
  S(`flashcards_${cu.email}`,fcCards);const xp=r===1?5:r===2?10:15;addXP(xp,'Flashcard Review');fcIdx++;showFC();
}
function endReview(){document.getElementById('fcReviewArea').style.display='none';document.getElementById('fcListArea').style.display='block';toast('üéâ Review session complete!','success');checkBadges();renderFlashcards();}
function renderFlashcards(){
  fcCards=G(`flashcards_${cu.email}`)||[];const due=fcCards.filter(c=>c.nextReview<=Date.now()).length;
  document.getElementById('fcTotal').textContent=fcCards.length;document.getElementById('fcDue').textContent=due;document.getElementById('reviewBtn').disabled=due===0;
  document.getElementById('fcGrid').innerHTML=fcCards.length?fcCards.map(c=>`<div class="card"><div style="font-size:.7rem;font-weight:800;color:var(--acc);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">${E(c.subj||'General')}</div><div style="font-weight:800;font-size:.95rem;color:var(--tx);margin-bottom:7px">${E(c.front)}</div><div style="font-size:.82rem;color:var(--tx3);border-top:1px solid var(--border);padding-top:8px;margin-top:8px">${E(c.back)}</div><div style="display:flex;justify-content:space-between;margin-top:10px;align-items:center"><span style="font-size:.7rem;color:var(--tx4)">Next: ${new Date(c.nextReview).toLocaleDateString()}</span><div class="ic-btn del" onclick="deleteFC('${c.id}')">‚úï</div></div></div>`).join(''):`<div class="empty-s" style="grid-column:1/-1"><span class="ei">üÉè</span><div class="et">No flashcards yet</div><div class="es">Create your first card to get started!</div></div>`;
}
function deleteFC(id){if(!confirm('Delete this card?'))return;fcCards=fcCards.filter(c=>c.id!==id);S(`flashcards_${cu.email}`,fcCards);renderFlashcards();}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ACCOUNT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderAccount(){
  document.getElementById('accName').textContent=cu.name;
  updateAllAvatars();
  const accAv=document.getElementById('accAvatar');
  if(accAv){accAv.innerHTML=renderAvatarEl(cu.email,'lg')+'<div style="position:absolute;bottom:-4px;right:-4px;width:22px;height:22px;border-radius:7px;background:var(--acc);display:flex;align-items:center;justify-content:center;font-size:.7rem;border:2px solid var(--surface)">‚úèÔ∏è</div>';}
  document.getElementById('accEmail').textContent=cu.email;
  document.getElementById('accGrade').textContent=cu.grade||'Student';
  document.getElementById('accJoined').textContent='Joined '+new Date(cu.joined||Date.now()).toLocaleDateString();
  document.getElementById('accNameInp').value=cu.name;
  document.getElementById('accGradeInp').value=cu.grade||'';
  if(document.getElementById('accDeptInp'))document.getElementById('accDeptInp').value=cu.dept||'';
  const xp=getXP();const lv=getLvl(xp);const idx=getLvlIdx(xp);const quizH=G(`quizHist_${cu.email}`)||[];const avgQ=quizH.length?Math.round(quizH.reduce((s,q)=>s+(q.score/q.total*100),0)/quizH.length):0;const unlocked=getUnlockedBadges();
  document.getElementById('accStats').innerHTML=[{l:'Total XP',v:xp+' XP'},{l:'Level',v:'Lv '+(idx+1)+' '+lv.name+' '+lv.emoji},{l:'Tasks Completed',v:tasks.filter(t=>t.status==='completed').length},{l:'Current Streak',v:getCurStreak()+'üî•'},{l:'Quizzes Taken',v:quizH.length},{l:'Quiz Average',v:avgQ+'%'},{l:'Notes Created',v:notes.length},{l:'Badges Earned',v:unlocked.length+'/'+BADGES.length},{l:'Flashcards',v:(G(`flashcards_${cu.email}`)||[]).length}].map(s=>`<div style="display:flex;justify-content:space-between;align-items:center;font-size:.9rem;padding:9px 0;border-bottom:1px solid var(--border)"><span style="color:var(--tx3)">${s.l}</span><span style="font-weight:800;color:var(--tx)">${s.v}</span></div>`).join('');
  const pref=G('sb_pref')||{};const pd=pref.pomoDef||25;document.querySelectorAll('#p20,#p25,#p30,#p45').forEach(b=>b.classList.remove('active'));const btn=document.getElementById('p'+pd);if(btn)btn.classList.add('active');
}
function saveProfile(){
  const name=document.getElementById('accNameInp').value.trim();const grade=document.getElementById('accGradeInp').value;const dept=document.getElementById('accDeptInp').value;
  if(!name)return toast('Name is required.','error');
  cu.name=name;cu.grade=grade;cu.dept=dept||cu.dept||'OTHER';S('sb_sess',cu);const users=G('sb_users')||{};if(users[cu.email]){users[cu.email].name=name;users[cu.email].grade=grade;users[cu.email].dept=cu.dept;S('sb_users',users);}
  updateUserUI();renderAccount();renderQuizSubjects();toast('Profile saved!','success');
}
function changePassword(){
  const old=document.getElementById('accOldPass').value,nw=document.getElementById('accNewPass').value,conf=document.getElementById('accConfPass').value;
  document.getElementById('accOldErr').style.display='none';document.getElementById('accConfErr').style.display='none';
  const users=G('sb_users')||{};const u=users[cu.email];if(!u||atob(u.pass)!==old){document.getElementById('accOldErr').style.display='block';return;}
  if(nw.length<4)return toast('Password must be 4+ characters.','error');if(nw!==conf){document.getElementById('accConfErr').style.display='block';return;}
  u.pass=btoa(nw);S('sb_users',users);document.getElementById('accOldPass').value='';document.getElementById('accNewPass').value='';document.getElementById('accConfPass').value='';toast('Password updated!','success');
}
function clearAllData(){
  if(!confirm('Delete ALL your data permanently? This cannot be undone.'))return;if(!confirm('Are you absolutely sure?'))return;
  ['tasks','notes','goals','notifs','flashcards'].forEach(k=>localStorage.removeItem(`${k}_${cu.email}`));['xp','badges','quizHist','streak','dailyDone','topics'].forEach(k=>localStorage.removeItem(`${k}_${cu.email}`));
  loadAll();toast('All data cleared.','info');navigate('dashboard');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê NOTIF PANEL CLICK OUTSIDE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
document.addEventListener('click',e=>{
  const panel=document.getElementById('notifPanel');const btn=document.getElementById('notifBtn');
  if(panel&&btn&&!panel.contains(e.target)&&!btn.contains(e.target)){
  panel.classList.remove('show');
}
 document.querySelectorAll('.modal.show').forEach(function(modal){
    if(e.target===modal)modal.classList.remove('show');
    });
 document.querySelectorAll('.dropdown.show').forEach(function(dropdown){
    const trigger=document.querySelector('[data-dropdown="'+dropdown.id+'"]');
    if(!dropdown.contains(e.target)&&(!trigger||!trigger.contains(e.target)))
      dropdown.classList.remove('show');
 });
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PROGRESS REPORT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let reportPeriod='all';
let rpDonutChart=null,rpLineChart=null;

function setReportPeriod(p,btn){
  reportPeriod=p;
  document.querySelectorAll('#rp-week,#rp-month,#rp-all').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderReport();
}

function getReportTasks(){
  const now=Date.now();
  if(reportPeriod==='week')return tasks.filter(t=>t.created>=now-7*86400000);
  if(reportPeriod==='month')return tasks.filter(t=>t.created>=now-30*86400000);
  return tasks;
}

function getReportQuizzes(){
  const quizH=G(`quizHist_${cu.email}`)||[];
  const now=Date.now();
  if(reportPeriod==='week')return quizH.filter(q=>q.date>=now-7*86400000);
  if(reportPeriod==='month')return quizH.filter(q=>q.date>=now-30*86400000);
  return quizH;
}

function renderReport(){
  const rt=getReportTasks();
  const rq=getReportQuizzes();
  const xp=getXP();
  const lv=getLvl(xp);
  const idx=getLvlIdx(xp);
  const done=rt.filter(t=>t.status==='completed').length;
  const total=rt.length;
  const pending=rt.filter(t=>t.status==='pending').length;
  const overdue=rt.filter(isOverdue).length;
  const rate=total?Math.round((done/total)*100):0;
  const avgQ=rq.length?Math.round(rq.reduce((s,q)=>s+(q.score/q.total*100),0)/rq.length):0;
  const grade=rate>=90?'A+':rate>=80?'A':rate>=70?'B+':rate>=60?'B':rate>=50?'C':'D';
  const streak=getCurStreak();

  // Header
  document.getElementById('rpAvatar').textContent=cu.name.charAt(0).toUpperCase();
  document.getElementById('rpName').textContent=cu.name;
  document.getElementById('rpGrade').textContent=(cu.grade||'Student')+' ¬∑ Level '+(idx+1)+' '+lv.name+' '+lv.emoji;
  document.getElementById('rpDate').textContent='Report Period: '+(reportPeriod==='week'?'Last 7 Days':reportPeriod==='month'?'Last 30 Days':'All Time')+' ¬∑ Generated '+new Date().toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
  document.getElementById('rpGradeLetter').textContent=grade;
  document.getElementById('rpFooterDate').textContent=new Date().toLocaleDateString();

  // KPI Row
  document.getElementById('rpKPIRow').innerHTML=[
    {ic:'‚úÖ',v:done,l:'Tasks Done',c:'var(--green)'},
    {ic:'üìã',v:total,l:'Total Tasks',c:'var(--acc)'},
    {ic:'‚è≥',v:pending,l:'Pending',c:'var(--amber)'},
    {ic:'‚ö†Ô∏è',v:overdue,l:'Overdue',c:'var(--red)'},
    {ic:'üß†',v:rq.length,l:'Quizzes',c:'var(--purple)'},
    {ic:'üìä',v:avgQ+'%',l:'Quiz Avg',c:'var(--teal)'},
    {ic:'üî•',v:streak,l:'Streak',c:'var(--amber)'},
    {ic:'‚ö°',v:xp,l:'Total XP',c:'var(--acc)'},
  ].map(k=>`
    <div class="card" style="text-align:center;padding:16px;cursor:default">
      <div style="font-size:1.4rem;margin-bottom:6px">${k.ic}</div>
      <div style="font-size:1.5rem;font-weight:900;color:${k.c};line-height:1;margin-bottom:4px">${k.v}</div>
      <div style="font-size:.72rem;color:var(--tx3);font-weight:700;text-transform:uppercase;letter-spacing:.3px">${k.l}</div>
    </div>`).join('');

  // Subject Performance
  const subjs={};rt.forEach(t=>{const s=t.subject||'General';if(!subjs[s])subjs[s]={t:0,d:0,high:0,overdue:0};subjs[s].t++;if(t.status==='completed')subjs[s].d++;if(t.priority==='high')subjs[s].high++;if(isOverdue(t))subjs[s].overdue++;});
  const subjEl=document.getElementById('rpSubjects');
  subjEl.innerHTML=Object.keys(subjs).length?Object.entries(subjs).sort((a,b)=>b[1].t-a[1].t).map(([s,v])=>{
    const p=Math.round((v.d/v.t)*100);
    const subjGrade=p>=90?'A+':p>=80?'A':p>=70?'B+':p>=60?'B':p>=50?'C':'D';
    return `
      <div style="margin-bottom:16px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:7px">
          <div>
            <span style="font-weight:800;font-size:.93rem;color:var(--tx)">${E(s)}</span>
            <span style="margin-left:9px;font-size:.75rem;color:var(--tx3)">${v.d}/${v.t} tasks ¬∑ ${v.high} high priority</span>
          </div>
          <div style="display:flex;align-items:center;gap:9px">
            <span style="font-size:.82rem;font-weight:900;color:${p>=80?'var(--green)':p>=60?'var(--amber)':'var(--red)'}">${p}%</span>
            <span style="padding:3px 10px;border-radius:100px;font-size:.72rem;font-weight:900;background:${p>=80?'var(--green-bg)':p>=60?'var(--amber-bg)':'var(--red-bg)'};color:${p>=80?'var(--green)':p>=60?'var(--amber)':'var(--red)'}">${subjGrade}</span>
          </div>
        </div>
        <div style="height:10px;background:var(--surface2);border-radius:5px;overflow:hidden">
          <div style="height:100%;width:${p}%;background:${p>=80?'var(--green)':p>=60?'var(--acc)':'var(--amber)'};border-radius:5px;transition:width 1.2s ease"></div>
        </div>
      </div>`;
  }).join(''):'<div style="color:var(--tx3);padding:18px 0;font-size:.9rem">No subject data for this period.</div>';

  // Quiz Analysis
  const quizBySubj={};rq.forEach(q=>{if(!quizBySubj[q.subject])quizBySubj[q.subject]=[];quizBySubj[q.subject].push(Math.round(q.score/q.total*100));});
  const qaEl=document.getElementById('rpQuizAnalysis');
  qaEl.innerHTML=Object.keys(quizBySubj).length?`
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:13px">
      ${Object.entries(quizBySubj).map(([s,scores])=>{
        const avg=Math.round(scores.reduce((a,b)=>a+b,0)/scores.length);
        const best=Math.max(...scores);const worst=Math.min(...scores);
        return `<div style="background:var(--surface2);border-radius:var(--r);padding:16px">
          <div style="font-weight:800;font-size:.9rem;color:var(--tx);margin-bottom:10px">${QUIZ_DATA[s]?.icon||'üß†'} ${E(s)}</div>
          <div style="display:flex;justify-content:space-between;font-size:.8rem;margin-bottom:5px"><span style="color:var(--tx3)">Average</span><span style="font-weight:900;color:${avg>=80?'var(--green)':avg>=60?'var(--amber)':'var(--red)'}">${avg}%</span></div>
          <div style="display:flex;justify-content:space-between;font-size:.8rem;margin-bottom:5px"><span style="color:var(--tx3)">Best</span><span style="font-weight:800;color:var(--green)">${best}%</span></div>
          <div style="display:flex;justify-content:space-between;font-size:.8rem;margin-bottom:10px"><span style="color:var(--tx3)">Attempts</span><span style="font-weight:800;color:var(--acc)">${scores.length}</span></div>
          <div style="height:6px;background:var(--border);border-radius:3px;overflow:hidden"><div style="height:100%;width:${avg}%;background:${avg>=80?'var(--green)':avg>=60?'var(--acc)':'var(--amber)'};border-radius:3px"></div></div>
        </div>`;
      }).join('')}
    </div>`
  :'<div style="color:var(--tx3);padding:18px 0;font-size:.9rem">No quiz data for this period. <span style="color:var(--acc);cursor:pointer;font-weight:700" onclick="navigate(\'quiz\')">Take a quiz ‚Üí</span></div>';

  // Strengths & Weaknesses
  const strengths=[];const weaknesses=[];
  if(rate>=80)strengths.push({ic:'‚úÖ',t:'High completion rate',d:rate+'% of tasks completed'});
  if(streak>=3)strengths.push({ic:'üî•',t:'Consistent studier',d:streak+'-day study streak'});
  if(avgQ>=75)strengths.push({ic:'üß†',t:'Strong quiz performer',d:'Average score: '+avgQ+'%'});
  if(done>=10)strengths.push({ic:'üí™',t:'Task crusher',d:'Completed '+done+' tasks'});
  if(notes.length>=5)strengths.push({ic:'üìù',t:'Diligent note-taker',d:notes.length+' notes created'});
  if(rate<60)weaknesses.push({ic:'üìã',t:'Task completion needs work',d:'Only '+rate+'% completed'});
  if(overdue>0)weaknesses.push({ic:'‚ö†Ô∏è',t:overdue+' overdue tasks',d:'Clear backlog to reduce stress'});
  if(avgQ<60&&rq.length>0)weaknesses.push({ic:'üß†',t:'Quiz scores below target',d:'Aim for 70%+ average'});
  if(streak===0)weaknesses.push({ic:'üî•',t:'No active streak',d:'Study daily to build momentum'});
  if(!strengths.length)strengths.push({ic:'üå±',t:'Just getting started',d:'Complete tasks to show strengths!'});
  if(!weaknesses.length)weaknesses.push({ic:'üéâ',t:'No major weak areas!',d:'Keep maintaining this standard.'});
  const swItem=(i)=>`<div style="display:flex;gap:11px;padding:9px 0;border-bottom:1px solid rgba(0,0,0,.06)"><span style="font-size:1.1rem">${i.ic}</span><div><div style="font-weight:800;font-size:.88rem;color:var(--tx)">${i.t}</div><div style="font-size:.78rem;color:var(--tx3);margin-top:2px">${i.d}</div></div></div>`;
  document.getElementById('rpStrengths').innerHTML=strengths.map(swItem).join('');
  document.getElementById('rpWeaknesses').innerHTML=weaknesses.map(swItem).join('');

  // Consistency
  const sData=getStreakData();
  const totalDays=Object.keys(sData).length;
  const thisWeekDays=[...Array(7)].filter((_,i)=>sData[new Date(Date.now()-i*86400000).toDateString()]).length;
  document.getElementById('rpConsistency').innerHTML=`
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:13px;margin-bottom:16px">
      ${[{v:streak+'üî•',l:'Current Streak'},{v:Math.max(streak,0)+'d',l:'Best Streak'},{v:totalDays,l:'Total Study Days'},{v:thisWeekDays+'/7',l:'Days This Week'}].map(s=>`
        <div style="background:var(--surface2);border-radius:var(--r);padding:16px;text-align:center">
          <div style="font-size:1.6rem;font-weight:900;color:var(--acc);margin-bottom:4px">${s.v}</div>
          <div style="font-size:.75rem;color:var(--tx3);font-weight:700">${s.l}</div>
        </div>`).join('')}
    </div>
    <div style="display:flex;gap:5px;flex-wrap:wrap">
      ${[...Array(7)].map((_,i)=>{const d=new Date(Date.now()-(6-i)*86400000);const done2=!!sData[d.toDateString()];return `<div style="flex:1;min-width:36px"><div style="text-align:center;font-size:.65rem;color:var(--tx4);margin-bottom:4px">${d.toLocaleDateString('en',{weekday:'short'}).slice(0,2)}</div><div style="height:36px;border-radius:9px;background:${done2?'var(--acc)':'var(--surface2)'};display:flex;align-items:center;justify-content:center;font-size:.8rem">${done2?'‚úì':''}</div></div>`;}).join('')}
    </div>`;

  // Heatmap
  document.getElementById('rpHeatmap').innerHTML=Array(28).fill(0).map((_,i)=>{const d=new Date(Date.now()-(27-i)*86400000);const cnt=tasks.filter(t=>t.status==='completed'&&new Date(t.updated).toDateString()===d.toDateString()).length;const lvl=cnt>=3?3:cnt>=2?2:cnt>=1?1:0;return `<div class="hm${lvl?` hm${lvl}`:''}" title="${d.toLocaleDateString()}: ${cnt} tasks"></div>`;}).join('');

  // AI Recommendations
  const recs=[];
  if(overdue>0)recs.push({ic:'üö®',t:'Clear overdue tasks first',d:'You have '+overdue+' overdue tasks. Address these before adding new ones to reduce stress.'});
  if(rate<70)recs.push({ic:'üìã',t:'Improve completion rate',d:'Break large tasks into subtasks using the AI subtask generator. Aim for 70%+ completion.'});
  if(rq.length<3)recs.push({ic:'üß†',t:'Take more quizzes',d:'Quiz yourself daily in your weakest subject. Even 10 minutes of testing beats 1 hour of re-reading.'});
  if(streak<3)recs.push({ic:'üî•',t:'Build a study streak',d:'Study for at least 25 minutes daily using the Pomodoro timer. Consistency compounds over time.'});
  if(avgQ<70&&rq.length>=2)recs.push({ic:'üìñ',t:'Review quiz mistakes',d:'Go back to topics where you scored below 60%. Use flashcards to reinforce weak areas.'});
  if(fcCards.length<5)recs.push({ic:'üÉè',t:'Create more flashcards',d:'Flashcards with spaced repetition are the most efficient memorisation tool. Aim for 20+ cards.'});
  if(!recs.length)recs.push({ic:'üåü',t:'You\'re performing excellently!',d:'Maintain your current study habits. Consider increasing quiz difficulty to keep challenging yourself.'});
  document.getElementById('rpRecommendations').innerHTML=recs.map(r=>`
    <div style="display:flex;gap:14px;padding:13px 0;border-bottom:1px solid rgba(61,90,254,.1)">
      <div style="width:42px;height:42px;border-radius:13px;background:var(--surface);display:flex;align-items:center;justify-content:center;font-size:1.2rem;flex-shrink:0">${r.ic}</div>
      <div><div style="font-weight:800;font-size:.92rem;color:var(--tx);margin-bottom:3px">${r.t}</div><div style="font-size:.84rem;color:var(--tx2);line-height:1.65">${r.d}</div></div>
    </div>`).join('');

  // Badges
  const unlocked=getUnlockedBadges();const earned=BADGES.filter(b=>unlocked.includes(b.id));
  document.getElementById('rpBadgeCount').textContent=earned.length+'/'+BADGES.length+' earned';
  document.getElementById('rpBadges').innerHTML=earned.length?earned.map(b=>`
    <div style="background:linear-gradient(135deg,var(--amber-bg),var(--surface));border:1px solid var(--amber-border);border-radius:var(--r);padding:14px;text-align:center">
      <div style="font-size:1.6rem;margin-bottom:5px">${b.emoji}</div>
      <div style="font-weight:800;font-size:.78rem;color:var(--tx)">${b.name}</div>
    </div>`)
  .join(''):'<div style="color:var(--tx3);font-size:.9rem;padding:14px 0">Complete tasks and quizzes to earn badges!</div>';

  // Charts
  setTimeout(()=>{
    const cs=getComputedStyle(document.documentElement);
    const acc=cs.getPropertyValue('--acc').trim(),green=cs.getPropertyValue('--green').trim(),amber=cs.getPropertyValue('--amber').trim(),red=cs.getPropertyValue('--red').trim(),s2=cs.getPropertyValue('--surface2').trim(),tx3=cs.getPropertyValue('--tx3').trim(),bd=cs.getPropertyValue('--border').trim();
    if(rpDonutChart)rpDonutChart.destroy();rpDonutChart = null;
    const rdc=document.getElementById('rpDonut');
    if(rdc){
      const ctx=rdc.getContext('2d');
      ctx.clearRect(0,0,rdc.width,rdc.height);
      rpDonutChart=new Chart(rdc,{type:'doughnut',data:{labels:['Completed','In Progress','Pending','Overdue'],datasets:[{data:[done,rt.filter(t=>t.status==='in-progress').length,pending,overdue],backgroundColor:[green,acc,s2,red],borderWidth:0,hoverOffset:7}]},options:{responsive:true,maintainAspectRatio:false,cutout:'68%',plugins:{legend:{position:'bottom',labels:{color:tx3,padding:10,font:{size:11,family:'Inter'}}}}}});
    }
    if(rpLineChart)rpLineChart.destroy();rpLineChart = null;
    const rlc=document.getElementById('rpLine');
    const days7=['6d ago','5d ago','4d ago','3d ago','2d ago','Yesterday','Today'];
    const lineData=days7.map((_,i)=>{const d=new Date(Date.now()-(6-i)*86400000).toDateString();return tasks.filter(t=>t.status==='completed'&&new Date(t.updated).toDateString()===d).length;});
    if(rlc){
      const ctx2=rlc.getContext('2d');
      ctx2.clearRect(0,0,rlc.width,rlc.height);
      rpLineChart=new Chart(rlc,{type:'line',data:{labels:days7,datasets:[{data:lineData,borderColor:acc,backgroundColor:acc+'22',borderWidth:2.5,pointRadius:5,pointBackgroundColor:acc,fill:true,tension:.4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:{color:tx3,font:{size:10}},grid:{display:false}},y:{ticks:{color:tx3,stepSize:1,font:{size:11}},grid:{color:bd}}}}});
    }
  },250);
}
/* ‚ïê‚ïê‚ïê PDF DOWNLOAD ‚ïê‚ïê‚ïê */
function downloadPDF(){
  const {jsPDF}=window.jspdf;
  const doc=new jsPDF({orientation:'portrait',unit:'mm',format:'a4'});
  const xp=getXP();const lv=getLvl(xp);const idx=getLvlIdx(xp);
  const rt=getReportTasks();const rq=getReportQuizzes();
  const done=rt.filter(t=>t.status==='completed').length;
  const total=rt.length;const rate=total?Math.round((done/total)*100):0;
  const avgQ=rq.length?Math.round(rq.reduce((s,q)=>s+(q.score/q.total*100),0)/rq.length):0;
  const grade=rate>=90?'A+':rate>=80?'A':rate>=70?'B+':rate>=60?'B':rate>=50?'C':'D';
  const streak=getCurStreak();
  const W=210;let y=20;
  const addText=(text,x,fy,size,bold,color)=>{doc.setFontSize(size);doc.setFont('helvetica',bold?'bold':'normal');if(color)doc.setTextColor(...color);else doc.setTextColor(8,14,40);doc.text(text,x,fy);};
  const addRect=(x,fy,w,h,r,g,b,filled=true)=>{doc.setFillColor(r,g,b);if(filled)doc.roundedRect(x,fy,w,h,3,3,'F');else{doc.setDrawColor(r,g,b);doc.roundedRect(x,fy,w,h,3,3,'S');}};

  // Header bg
  addRect(0,0,W,52,61,90,254);
  addText('STUDYBOT PRO',14,12,8,false,[255,255,255]);
  addText('PROGRESS REPORT',14,19,18,true,[255,255,255]);
  addText(cu.name,14,30,13,true,[255,255,255]);
  addText((cu.grade||'Student')+' ¬∑ Level '+(idx+1)+' '+lv.name,14,38,10,false,[200,210,255]);
  addText(new Date().toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'}),14,45,9,false,[180,190,240]);
  // Grade circle
  addRect(170,8,28,28,255,255,255,true);
  doc.setTextColor(61,90,254);doc.setFontSize(16);doc.setFont('helvetica','bold');doc.text(grade,184,26,{align:'center'});
  doc.setTextColor(100,100,150);doc.setFontSize(7);doc.text('GRADE',184,32,{align:'center'});
  y=62;

  // KPI boxes
  const kpis=[['Tasks Done',done],['Completion',rate+'%'],['Quiz Avg',avgQ+'%'],['Streak',streak+'d'],['Total XP',xp],['Level',idx+1]];
  kpis.forEach((k,i)=>{const col=i%3;const row=Math.floor(i/3);const bx=14+col*64;const by=y+row*22;addRect(bx,by,60,18,230,235,255);doc.setTextColor(8,14,40);doc.setFontSize(12);doc.setFont('helvetica','bold');doc.text(String(k[1]),bx+30,by+8,{align:'center'});doc.setFontSize(7);doc.setFont('helvetica','normal');doc.setTextColor(90,100,144);doc.text(k[0],bx+30,by+14,{align:'center'});});
  y+=50;

  // Subject section
  doc.setDrawColor(221,226,245);doc.line(14,y,196,y);y+=8;
  addText('SUBJECT PERFORMANCE',14,y,10,true,[61,90,254]);y+=8;
  const subjs={};rt.forEach(t=>{const s=t.subject||'General';if(!subjs[s])subjs[s]={t:0,d:0};subjs[s].t++;if(t.status==='completed')subjs[s].d++;});
  Object.entries(subjs).slice(0,6).forEach(([s,v])=>{
    const p=Math.round((v.d/v.t)*100);const sg=p>=90?'A+':p>=80?'A':p>=70?'B+':p>=60?'B':'C';
    addText(s,14,y,9,true,[8,14,40]);addText(sg,155,y,9,true,p>=80?[21,163,82]:p>=60?[217,119,6]:[224,49,49]);addText(v.d+'/'+v.t+' ('+p+'%)',170,y,9,false,[90,100,144]);
    const bw=(p/100)*130;addRect(14,y+2,130,4,230,235,255);addRect(14,y+2,bw,4,p>=80?21:p>=60?217:224,p>=80?163:p>=60?119:49,p>=80?82:p>=60?6:49);
    y+=14;if(y>270){doc.addPage();y=20;}
  });

  // Quiz section
  y+=4;doc.line(14,y,196,y);y+=8;
  addText('QUIZ PERFORMANCE',14,y,10,true,[61,90,254]);y+=8;
  rq.slice(-6).forEach(q=>{const p=Math.round(q.score/q.total*100);addText(q.subject,14,y,9,false,[8,14,40]);addText(q.score+'/'+q.total+' ‚Üí '+p+'%',120,y,9,true,p>=80?[21,163,82]:p>=60?[217,119,6]:[224,49,49]);addText(new Date(q.date).toLocaleDateString(),162,y,8,false,[144,164,204]);y+=10;if(y>270){doc.addPage();y=20;}});

  // Badges
  y+=4;doc.line(14,y,196,y);y+=8;
  addText('BADGES EARNED',14,y,10,true,[61,90,254]);y+=8;
  const unlocked=getUnlockedBadges();const earned=BADGES.filter(b=>unlocked.includes(b.id));
  addText(earned.map(b=>b.emoji+' '+b.name).join('  ¬∑  ')||'No badges yet',14,y,8,false,[90,100,144]);y+=12;

  // Footer
  if(y>260){doc.addPage();y=20;}
  y=Math.max(y,270);addRect(0,y,W,20,61,90,254);doc.setTextColor(255,255,255);doc.setFontSize(8);doc.text('StudyBot Pro ¬∑ Progress Report ¬∑ Keep studying! üìö',W/2,y+8,{align:'center'});doc.text('Generated: '+new Date().toLocaleString(),W/2,y+14,{align:'center'});

  doc.save(`StudyBot_Report_${cu.name.replace(' ','_')}_${new Date().toISOString().split('T')[0]}.pdf`);
  toast('üìÑ PDF downloaded!','success');addXP(10,'Generated Report');
}

/* ‚ïê‚ïê‚ïê SHARE REPORT ‚ïê‚ïê‚ïê */
function shareReport(){
  const rt=getReportTasks();const done=rt.filter(t=>t.status==='completed').length;const total=rt.length;const rate=total?Math.round((done/total)*100):0;const streak=getCurStreak();const xp=getXP();const lv=getLvl(xp);
  const text=`üìä My StudyBot Pro Report\nüë§ ${cu.name} ¬∑ ${lv.emoji} ${lv.name}\n‚úÖ ${done}/${total} tasks (${rate}%)\nüî• ${streak}-day streak\n‚ö° ${xp} XP earned\n\nStudy smarter with StudyBot Pro!`;
  if(navigator.share){navigator.share({title:'My Progress Report',text});}
  else{navigator.clipboard.writeText(text);toast('üìã Report copied to clipboard!','success');}
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê EXAM SCHEDULE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function getExams(){return G(`exams_${cu?.email||''}`)||[];}
function saveExams(d){S(`exams_${cu?.email||''}`,d);}
function getMarks(){return G(`marks_${cu?.email||''}`)||[];}
function saveMarks(d){S(`marks_${cu?.email||''}`,d);}

function openAddExamModal(){
  const today=new Date().toISOString().split('T')[0];
  document.getElementById('examDate').value='';document.getElementById('examSubj').value='';
  document.getElementById('examTime').value='';document.getElementById('examMax').value='100';
  document.getElementById('examVenue').value='';document.getElementById('examNotes').value='';
  document.getElementById('addExamModal').classList.add('show');
}
function openAddMarkModal(){
  const today=new Date().toISOString().split('T')[0];
  document.getElementById('markSubj').value='';document.getElementById('markName').value='';
  document.getElementById('markDate').value=today;document.getElementById('markScore').value='';
  document.getElementById('markMax').value='20';
  document.getElementById('addMarkModal').classList.add('show');
}

function saveExam(){
  const subj=document.getElementById('examSubj').value.trim();
  const date=document.getElementById('examDate').value;
  if(!subj||!date)return toast('Subject and date are required!','error');
  const exams=getExams();
  exams.push({id:Date.now().toString(),subj,date,time:document.getElementById('examTime').value,type:document.getElementById('examType').value,max:parseInt(document.getElementById('examMax').value)||100,venue:document.getElementById('examVenue').value.trim(),notes:document.getElementById('examNotes').value.trim(),created:Date.now()});
  exams.sort((a,b)=>a.date.localeCompare(b.date));
  saveExams(exams);closeModal('addExamModal');toast('Exam added! üìÜ','success');addXP(5,'Exam Scheduled');renderExams();
}
function saveMark(){
  const subj=document.getElementById('markSubj').value.trim();
  const score=parseFloat(document.getElementById('markScore').value);
  const max=parseFloat(document.getElementById('markMax').value)||20;
  if(!subj||isNaN(score))return toast('Subject and marks required!','error');
  if(score>max)return toast('Score cannot exceed max marks!','error');
  const marks=getMarks();
  marks.push({id:Date.now().toString(),subj,
    name:document.getElementById('markName').value.trim()||'Assessment',
    type:document.getElementById('markType')?.value||'CA',
    date:document.getElementById('markDate').value,score,max,created:Date.now()});
  saveMarks(marks);closeModal('addMarkModal');toast('Mark saved! üìù','success');addXP(3,'Mark Added');renderExams();
}
function deleteExam(id){const exams=getExams().filter(e=>e.id!==id);saveExams(exams);renderExams();}
function prefillMarkSubj(subj){const el=document.getElementById('markSubj');if(el)el.value=subj;}
function deleteMark(id){const marks=getMarks().filter(m=>m.id!==id);saveMarks(marks);renderExams();}

function renderExams(){
  const exams=getExams();const marks=getMarks();
  const today=new Date();today.setHours(0,0,0,0);

  /* ‚îÄ‚îÄ NEXT EXAM STATUS BANNER ‚îÄ‚îÄ */
  const upcoming=exams.filter(e=>new Date(e.date+'T00:00:00')>=today).sort((a,b)=>a.date.localeCompare(b.date));
  const next=upcoming[0];
  const ssb=document.getElementById('semStatusBar');
  if(ssb){
    if(next){
      const d=Math.ceil((new Date(next.date+'T00:00:00')-today)/86400000);
      const urgent=d<=3,warn=d<=7;
      const typeIco={internal:'üìù',external:'üìã',lab:'üî¨',viva:'üé§',quiz:'‚ö°',assignment:'üìå'};
      ssb.innerHTML=`<div style="display:flex;align-items:center;gap:14px;padding:16px 20px;border-radius:var(--r);border:1.5px solid ${urgent?'rgba(224,49,49,.35)':warn?'rgba(217,119,6,.35)':'rgba(61,90,254,.2)'};background:${urgent?'linear-gradient(135deg,rgba(224,49,49,.08),rgba(224,49,49,.04))':warn?'linear-gradient(135deg,rgba(217,119,6,.08),rgba(217,119,6,.04))':'linear-gradient(135deg,var(--acc-bg),var(--purple-bg))'};flex-wrap:wrap;gap:12px">
        <div style="font-size:2rem">${urgent?'üö®':warn?'‚è∞':typeIco[next.type]||'üìÜ'}</div>
        <div style="flex:1;min-width:180px">
          <div style="font-weight:800;font-size:1rem;color:var(--tx)">Next: ${E(next.subj)} <span style="font-size:.72rem;padding:2px 8px;border-radius:20px;font-weight:700;background:${urgent?'var(--red-bg)':warn?'var(--amber-bg)':'var(--acc-bg)'};color:${urgent?'var(--red)':warn?'var(--amber)':'var(--acc)'}">${next.type}</span></div>
          <div style="font-size:.84rem;color:var(--tx3);margin-top:3px">${new Date(next.date+'T00:00:00').toLocaleDateString('en-IN',{weekday:'long',day:'numeric',month:'long'})}${next.time?' ¬∑ '+next.time:''}${next.venue?' ¬∑ üìç'+next.venue:''}</div>
          ${next.notes?`<div style="font-size:.76rem;color:var(--tx4);margin-top:4px">üìå ${E(next.notes)}</div>`:''}
        </div>
        <div style="background:${urgent?'var(--red)':warn?'var(--amber)':'var(--acc)'};color:#fff;border-radius:12px;padding:8px 18px;text-align:center;font-family:var(--font-d);font-weight:900;flex-shrink:0">
          <div style="font-size:2rem;line-height:1">${d===0?'üìå':d}</div>
          <div style="font-size:.62rem;letter-spacing:1.5px">${d===0?'TODAY':'DAYS'}</div>
        </div>
      </div>`;
    } else {
      ssb.innerHTML=`<div style="display:flex;align-items:center;gap:12px;padding:14px 18px;border-radius:var(--r);border:1.5px solid var(--green-border);background:var(--green-bg)"><div style="font-size:1.6rem">‚úÖ</div><div><div style="font-weight:700;color:var(--tx)">No upcoming exams!</div><div style="font-size:.84rem;color:var(--tx3)"><span style="color:var(--acc);cursor:pointer;font-weight:700" onclick="openAddExamModal()">+ Schedule your next exam</span></div></div></div>`;
    }
  }

  /* ‚îÄ‚îÄ MARKS SUMMARY STRIP ‚îÄ‚îÄ */
  const summEl=document.getElementById('marksSummary');
  if(summEl){
    if(marks.length){
      const overallPct=Math.round(marks.reduce((s,m)=>s+(m.score/m.max*100),0)/marks.length);
      const bySubj={};marks.forEach(m=>{if(!bySubj[m.subj])bySubj[m.subj]=[];bySubj[m.subj].push(m);});
      const ranked=Object.entries(bySubj).map(([s,ms])=>({s,avg:Math.round(ms.reduce((t,m)=>t+m.score/m.max*100,0)/ms.length)})).sort((a,b)=>b.avg-a.avg);
      const best=ranked[0],worst=ranked[ranked.length-1];
      const gc=overallPct>=80?'var(--green)':overallPct>=60?'var(--acc)':overallPct>=40?'var(--amber)':'var(--red)';
      summEl.innerHTML=`<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:10px;padding:16px;background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r)">
        <div style="text-align:center;padding:10px;background:var(--acc-bg);border-radius:var(--r-sm)"><div style="font-size:.68rem;font-weight:800;color:var(--acc);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px">Overall Avg</div><div style="font-family:var(--font-d);font-weight:900;font-size:1.9rem;color:${gc}">${overallPct}%</div></div>
        <div style="text-align:center;padding:10px;background:var(--surface2);border-radius:var(--r-sm)"><div style="font-size:.68rem;font-weight:800;color:var(--tx3);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px">Assessments</div><div style="font-family:var(--font-d);font-weight:900;font-size:1.9rem;color:var(--tx)">${marks.length}</div></div>
        ${best?`<div style="padding:10px;background:var(--green-bg);border-radius:var(--r-sm)"><div style="font-size:.68rem;font-weight:800;color:var(--green);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px">üèÜ Best</div><div style="font-weight:800;color:var(--tx);font-size:.88rem">${E(best.s)}</div><div style="font-size:.75rem;color:var(--green);font-weight:700">${best.avg}%</div></div>`:''}
        ${worst&&worst.s!==best?.s?`<div style="padding:10px;background:var(--amber-bg);border-radius:var(--r-sm)"><div style="font-size:.68rem;font-weight:800;color:var(--amber);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px">üìà Focus On</div><div style="font-weight:800;color:var(--tx);font-size:.88rem">${E(worst.s)}</div><div style="font-size:.75rem;color:var(--amber);font-weight:700">${worst.avg}%</div></div>`:''}
      </div>`;
      summEl.style.display='block';
    } else { summEl.style.display='none'; }
  }

  /* ‚îÄ‚îÄ UPCOMING EXAMS (card grid) ‚îÄ‚îÄ */
  const uel=document.getElementById('upcomingExamsList');
  if(uel){
    if(upcoming.length){
      const typeCol={internal:'var(--acc)',external:'var(--purple)',lab:'var(--green)',viva:'var(--amber)',quiz:'var(--teal)',assignment:'var(--pink)'};
      const typeIco2={internal:'üìù',external:'üìã',lab:'üî¨',viva:'üé§',quiz:'‚ö°',assignment:'üìå'};
      uel.innerHTML=`<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:11px;padding-top:6px">${upcoming.map(e=>{
        const d=Math.ceil((new Date(e.date+'T00:00:00')-today)/86400000);
        const uc=d<=3?'var(--red)':d<=7?'var(--amber)':typeCol[e.type]||'var(--acc)';
        return `<div style="background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r);overflow:hidden;display:flex;flex-direction:column">
          <div style="height:4px;background:${uc}"></div>
          <div style="padding:13px;flex:1;display:flex;flex-direction:column;gap:8px">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px">
              <div style="flex:1;min-width:0">
                <div style="font-weight:800;font-size:.95rem;color:var(--tx);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${E(e.subj)}</div>
                <span style="font-size:.7rem;background:var(--surface2);padding:2px 7px;border-radius:20px;font-weight:700;color:var(--tx3);display:inline-block;margin-top:3px">${typeIco2[e.type]||'üìÜ'} ${e.type}</span>
              </div>
              <div style="display:flex;gap:5px;flex-shrink:0;align-items:center">
                <div style="background:${d<=3?'var(--red-bg)':d<=7?'var(--amber-bg)':'var(--acc-bg)'};border-radius:8px;padding:4px 9px;text-align:center">
                  <div style="font-family:var(--font-d);font-weight:900;font-size:1.15rem;line-height:1;color:${uc}">${d===0?'üìå':d}</div>
                  <div style="font-size:.58rem;color:var(--tx4);font-weight:700">${d===0?'TODAY':'DAYS'}</div>
                </div>
                <button class="ic-btn del" onclick="deleteExam('${e.id}')" title="Delete">‚úï</button>
              </div>
            </div>
            <div style="font-size:.78rem;color:var(--tx3);display:flex;flex-direction:column;gap:3px">
              <div>üìÖ ${new Date(e.date+'T00:00:00').toLocaleDateString('en-IN',{weekday:'short',day:'numeric',month:'short'})}${e.time?' ¬∑ ‚è∞ '+e.time:''}</div>
              <div>üìä Max Marks: <strong>${e.max}</strong></div>
              ${e.venue?`<div>üìç ${E(e.venue)}</div>`:''}
              ${e.notes?`<div style="margin-top:4px;padding:5px 8px;background:var(--surface2);border-radius:6px;font-size:.73rem">üìå ${E(e.notes)}</div>`:''}
            </div>
          </div>
        </div>`;
      }).join('')}</div>`;
    } else {
      uel.innerHTML=`<div class="empty-s" style="padding:30px 0"><span class="ei">üìÜ</span><div class="et">No upcoming exams</div><div class="es">Add your exam dates to stay prepared and never miss a deadline!</div></div>`;
    }
  }

  /* ‚îÄ‚îÄ ASSESSMENT MARKS (per subject with progress bars + delete) ‚îÄ‚îÄ */
  const iml=document.getElementById('internalMarksList');
  if(iml){
    const subjMarks={};marks.forEach(m=>{if(!subjMarks[m.subj])subjMarks[m.subj]=[];subjMarks[m.subj].push(m);});
    if(Object.keys(subjMarks).length){
      iml.innerHTML=Object.entries(subjMarks).map(([subj,ms])=>{
        const tot=ms.reduce((s,m)=>s+m.score,0),totMax=ms.reduce((s,m)=>s+m.max,0);
        const avg=Math.round(tot/totMax*100);
        const grade=avg>=90?{g:'O',c:'var(--green)'}:avg>=80?{g:'A+',c:'var(--green)'}:avg>=70?{g:'A',c:'var(--acc)'}:avg>=60?{g:'B+',c:'var(--acc)'}:avg>=50?{g:'B',c:'var(--amber)'}:{g:'C',c:'var(--red)'};
        return `<div style="border:1.5px solid var(--border);border-radius:var(--r);padding:14px 16px;margin-bottom:12px">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:10px">
            <div style="flex:1;min-width:0">
              <div style="font-weight:800;font-size:.97rem;color:var(--tx)">${E(subj)}</div>
              <div style="font-size:.76rem;color:var(--tx3);margin-top:2px">${ms.length} assessment${ms.length>1?'s':''} ¬∑ Total: ${tot}/${totMax}</div>
            </div>
            <div style="text-align:center;background:var(--surface2);border-radius:10px;padding:6px 14px;flex-shrink:0">
              <div style="font-family:var(--font-d);font-weight:900;font-size:1.4rem;line-height:1;color:${grade.c}">${grade.g}</div>
              <div style="font-size:.65rem;color:var(--tx4);font-weight:700">${avg}%</div>
            </div>
          </div>
          <div style="height:7px;background:var(--surface3);border-radius:4px;margin-bottom:12px;overflow:hidden">
            <div style="height:100%;width:${avg}%;background:${grade.c};border-radius:4px;transition:width .7s ease"></div>
          </div>
          <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:8px">
            ${ms.map(m=>{
              const p=Math.round(m.score/m.max*100);
              const mc=p>=75?'var(--green)':p>=50?'var(--amber)':'var(--red)';
              return `<div style="background:var(--surface2);border-radius:var(--r-sm);padding:10px;position:relative">
                <button class="ic-btn del" style="position:absolute;top:6px;right:6px;width:22px;height:22px;font-size:.62rem" onclick="deleteMark('${m.id}')" title="Delete">‚úï</button>
                <div style="font-size:.8rem;font-weight:800;color:var(--tx);margin-bottom:1px;padding-right:26px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${E(m.name)}</div>
                ${m.type?`<div style="font-size:.64rem;color:var(--tx4);margin-bottom:6px;font-weight:600">${m.type}</div>`:``}
                <div style="font-family:var(--font-d);font-weight:900;font-size:1.2rem;color:${mc};line-height:1">${m.score}<span style="font-size:.72rem;color:var(--tx3)">/${m.max}</span></div>
                <div style="font-size:.7rem;font-weight:700;color:${mc}">${p}%</div>
                ${m.date?`<div style="font-size:.65rem;color:var(--tx4);margin-top:3px">${new Date(m.date+'T00:00:00').toLocaleDateString('en-IN',{day:'numeric',month:'short'})}</div>`:''}
              </div>`;
            }).join('')}
            <div style="border:1.5px dashed var(--border2);border-radius:var(--r-sm);padding:10px;display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--tx4);font-size:.84rem;gap:5px;transition:all .2s"
              onclick="document.getElementById('markSubj').value='${subj.replace(/'/g,"\\'")}';openAddMarkModal()"
              onmouseover="this.style.borderColor='var(--acc)';this.style.color='var(--acc)'"
              onmouseout="this.style.borderColor='var(--border2)';this.style.color='var(--tx4)'">Ôºã Add</div>
          </div>
        </div>`;
      }).join('');
    } else {
      iml.innerHTML=`<div style="text-align:center;padding:22px 0;color:var(--tx3)"><div style="font-size:2rem;margin-bottom:10px">üìä</div><div style="font-weight:700;margin-bottom:5px">No assessment marks yet</div><div style="font-size:.85rem">Click <strong>"+ Add"</strong> above to track your CA / IA / Lab marks!</div></div>`;
    }
  }

  /* ‚îÄ‚îÄ PAST EXAMS ‚îÄ‚îÄ */
  const pel=document.getElementById('pastExamsList');
  const past=exams.filter(e=>new Date(e.date+'T00:00:00')<today).sort((a,b)=>b.date.localeCompare(a.date));
  if(pel){
    pel.innerHTML=past.length?past.map(e=>`<div class="t-row" style="opacity:.72">
      <div style="width:9px;height:9px;border-radius:50%;background:var(--tx4);flex-shrink:0;margin-top:2px"></div>
      <div class="t-info">
        <div class="t-title" style="color:var(--tx3)">${E(e.subj)} <span style="font-size:.7rem;background:var(--surface2);padding:1px 6px;border-radius:20px;font-weight:600">${e.type}</span></div>
        <div class="t-meta">${new Date(e.date+'T00:00:00').toLocaleDateString('en-IN',{day:'numeric',month:'short',year:'numeric'})}${e.venue?' ¬∑ '+e.venue:''}</div>
      </div>
      <button class="ic-btn del" onclick="deleteExam('${e.id}')" title="Delete">‚úï</button>
    </div>`).join(''):`<div style="color:var(--tx4);font-size:.85rem;padding:12px 0">No past exams recorded.</div>`;
  }
}
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DEPT LEADERBOARD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let deptRadarChart=null;

// Generate seeded-random mock classmates so the leaderboard is never empty
function getMockClassmates(dept,myXP,myAvgQ,myTasks,myStreak){
  const names={
    AI_DS:['Aravind R','Keerthana S','Dinesh P','Priya M','Harish K','Nithya T','Vishnu A','Deepika L'],
    AI_ML:['Rahul V','Sneha J','Karthick B','Ananya N','Siddharth G','Kavitha R','Arjun S','Meena C'],
    CSE:['Ajith K','Divya P','Surya M','Lakshmi T','Praveen A','Ranjani S','Gowtham R','Preethi V'],
    IT:['Naveen B','Saranya D','Manoj K','Swathi R','Bharath S','Nandha K','Aishwarya P','Kishore G'],
    ECE:['Vignesh S','Kavitha M','Balamurugan T','Sindhu R','Elango K','Prabhakaran A','Indhu V','Murugan P'],
    EEE:['Senthil K','Revathi M','Venkat R','Padmavathi S','Saravanan G','Nithyapriya A','Rajan T','Suganya V'],
    MECH:['Chandru S','Vasantha K','Ramesh P','Gomathi R','Suresh B','Vijaya M','Palani T','Jeyanthi S'],
    CIVIL:['Rajesh N','Malathi P','Selvam K','Anbuselvi R','Kumaravel S','Thenmozhi G','Balaji M','Kowsalya T'],
    MBA:['Arun P','Shanthi K','Vikram S','Lavanya R','Prasanna M','Sudha N','Ashwin G','Charumathi V'],
    BCA:['Nikhil R','Pooja S','Deepak M','Bhavya K','Aakash T','Rithika P','Yuvan G','Shreya N']
  };
  const pool=(names[dept]||names.CSE).concat(['Muthu R','Selvi K','Pandian S','Kokila M']);
  const seed=(dept+cu.email).split('').reduce((s,c)=>s+c.charCodeAt(0),0);
  const rng=(n,min,max)=>{const v=(seed*31+n*17)%100;return Math.round(min+(max-min)*(v/100));};
  return pool.slice(0,7).map((name,i)=>({
    name,email:`mock_${i}@dept.edu`,
    xp:rng(i*3,Math.max(50,myXP-300),myXP+400),
    avgQ:rng(i*5+1,30,95),
    tasksDone:rng(i*7+2,0,Math.max(5,myTasks+8)),
    streak:rng(i*11+3,0,Math.max(3,myStreak+10)),
    isMe:false,isMock:true
  }));
}

function renderDeptLeader(){
  const users=G('sb_users')||{};const myDept=cu.dept||'OTHER';
  const filter=document.getElementById('deptLeaderFilter')?.value||'xp';
  const deptLabel=DEPT_LABELS[myDept]||'Your Department';
  const titleEl=document.getElementById('deptLeaderTitle');if(titleEl)titleEl.textContent=`${deptLabel} Rankings`;
  // Build all users in dept
  const allInDept=Object.values(users).filter(u=>u.dept===myDept).map(u=>{
    const xp=G(`xp_${u.email}`)||0;
    const quizH=G(`quizHist_${u.email}`)||[];const avgQ=quizH.length?Math.round(quizH.reduce((s,q)=>s+(q.score/q.total*100),0)/quizH.length):0;
    const tasksDone=(G(`tasks_${u.email}`)||[]).filter(t=>t.status==='completed').length;
    const streak=Object.keys(G(`streak_${u.email}`)||{}).length;
    return {name:u.name,email:u.email,xp,avgQ,tasksDone,streak,isMe:u.email===cu.email};
  });
  const sortKey=filter==='xp'?'xp':filter==='quiz'?'avgQ':filter==='tasks'?'tasksDone':'streak';
  allInDept.sort((a,b)=>b[sortKey]-a[sortKey]);
  // Podium (top 3)
  const podEl=document.getElementById('deptPodium');
  if(podEl&&allInDept.length>=1){
    const top=allInDept.slice(0,3);const [first,second,third]=[top[0],top[1],top[2]];
    const podOrder=second?[second,first,third||null]:[first,null,null];
    const heights=['140px','180px','120px'];const medals=['ü•à','ü•á','ü•â'];const colors=['var(--surface2)','linear-gradient(135deg,var(--acc-bg),var(--purple-bg))','var(--surface2)'];
    podEl.innerHTML=`<div style="display:flex;align-items:flex-end;justify-content:center;gap:10px;padding-bottom:8px">${podOrder.map((u,i)=>u?`<div style="text-align:center;flex:1;max-width:140px"><div style="font-size:.8rem;font-weight:800;color:${u.isMe?'var(--acc)':'var(--tx3)'};margin-bottom:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${u.isMe?'YOU ‚ú®':E(u.name.split(' ')[0])}</div><div style="background:${colors[i]};border:${u.isMe?'2px solid var(--acc)':'1px solid var(--border)'};border-radius:12px 12px 0 0;padding:14px 8px 18px;height:${heights[i]};display:flex;flex-direction:column;align-items:center;justify-content:flex-start;gap:6px"><div style="font-size:1.6rem">${medals[i]}</div><div style="font-family:var(--font-d);font-weight:900;font-size:1rem;color:var(--tx)">${u[sortKey]}<span style="font-size:.65rem;color:var(--tx3);font-weight:600"> ${filter==='quiz'?'%':filter==='xp'?' XP':''}</span></div></div></div>`:''
    ).join('')}</div>`;
  }
  // Full list
  const listEl=document.getElementById('deptLeaderList');
  if(listEl){
    listEl.innerHTML=allInDept.length?allInDept.map((u,i)=>`<div style="display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid var(--border);${u.isMe?'background:var(--acc-bg);margin:0 -16px;padding:10px 16px;border-radius:var(--r-sm);':''}"><div style="font-family:var(--font-d);font-weight:900;font-size:1rem;color:${i<3?'var(--acc)':'var(--tx3)'};min-width:28px">#${i+1}</div><div style="width:32px;height:32px;border-radius:50%;background:${u.isMe?'var(--acc)':'var(--surface2)'};display:flex;align-items:center;justify-content:center;font-weight:800;font-size:.85rem;color:${u.isMe?'#fff':'var(--tx3)'};flex-shrink:0">${u.name.charAt(0).toUpperCase()}</div><div style="flex:1;min-width:0"><div style="font-weight:700;color:var(--tx);font-size:.9rem">${u.isMe?'You ‚ú®':E(u.name)}</div><div style="font-size:.75rem;color:var(--tx3)">${u.avgQ}% quiz avg ¬∑ ${u.tasksDone} tasks done</div></div><div style="font-family:var(--font-d);font-weight:900;font-size:1rem;color:${u.isMe?'var(--acc)':'var(--tx)'}">${u[sortKey]}<span style="font-size:.7rem;color:var(--tx3)"> ${filter==='quiz'?'%':filter==='xp'?'XP':''}</span></div></div>`).join(''):`<div style="color:var(--tx3);padding:20px 0;font-size:.9rem;text-align:center">No other ${deptLabel} students found. Share the app with classmates!</div>`;
  }
  // Radar chart - you vs dept avg
  const myData=allInDept.find(u=>u.isMe)||{xp:0,avgQ:0,tasksDone:0,streak:0};
  const others=allInDept.filter(u=>!u.isMe);
  const avgData={xp:others.length?Math.round(others.reduce((s,u)=>s+u.xp,0)/others.length):0,avgQ:others.length?Math.round(others.reduce((s,u)=>s+u.avgQ,0)/others.length):0,tasksDone:others.length?Math.round(others.reduce((s,u)=>s+u.tasksDone,0)/others.length):0,streak:others.length?Math.round(others.reduce((s,u)=>s+u.streak,0)/others.length):0};
  const radarEl=document.getElementById('deptRadarChart');
  if(radarEl&&others.length){
    if(deptRadarChart)deptRadarChart.destroy();
    const maxXP=Math.max(myData.xp,avgData.xp,1);const maxQ=100;const maxT=Math.max(myData.tasksDone,avgData.tasksDone,1);const maxS=Math.max(myData.streak,avgData.streak,1);
    const normalize=(v,max)=>Math.round((v/max)*100);
    deptRadarChart=new Chart(radarEl,{type:'radar',data:{labels:['XP Score','Quiz Avg','Tasks Done','Streak'],datasets:[{label:'You',data:[normalize(myData.xp,maxXP),myData.avgQ,normalize(myData.tasksDone,maxT),normalize(myData.streak,maxS)],borderColor:'rgba(61,90,254,1)',backgroundColor:'rgba(61,90,254,.15)',borderWidth:2,pointRadius:4,pointBackgroundColor:'rgba(61,90,254,1)'},{label:'Dept Avg',data:[normalize(avgData.xp,maxXP),avgData.avgQ,normalize(avgData.tasksDone,maxT),normalize(avgData.streak,maxS)],borderColor:'rgba(123,47,190,.7)',backgroundColor:'rgba(123,47,190,.08)',borderWidth:2,borderDash:[5,5],pointRadius:3,pointBackgroundColor:'rgba(123,47,190,.7)'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{color:'var(--tx3)',font:{size:11,family:'Plus Jakarta Sans'},padding:12}}},scales:{r:{ticks:{display:false},grid:{color:'var(--border)'},pointLabels:{color:'var(--tx3)',font:{size:11,family:'Plus Jakarta Sans'}},suggestedMin:0,suggestedMax:100}}}});
  } else if(radarEl){radarEl.parentElement.innerHTML='<div style="display:flex;align-items:center;justify-content:center;height:260px;color:var(--tx3);font-size:.9rem;text-align:center;padding:20px">Invite classmates to see department comparison chart!</div>';}
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SMART REMINDERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let reminderCheckInterval=null;

function getRmSettings(){return G(`rm_settings_${cu?.email||''}`)||{overdue:true,streak:true,flash:true,daily:true,deadline:true};}
function setRmSettings(s){S(`rm_settings_${cu?.email||''}`,s);}
function getCustomReminders(){return G(`custom_rm_${cu?.email||''}`)||[];}
function saveCustomReminders(arr){S(`custom_rm_${cu?.email||''}`,arr);}
function getRmHistory(){return G(`rm_history_${cu?.email||''}`)||[];}
function addRmHistory(msg){const h=getRmHistory();h.unshift({msg,time:Date.now()});S(`rm_history_${cu?.email||''}`,h.slice(0,30));}

function toggleRmSetting(key,el){
  const s=getRmSettings();s[key]=!s[key];setRmSettings(s);
  el.classList.toggle('on',s[key]);
  toast(s[key]?`üîî ${key} reminders enabled`:`üîï ${key} reminders disabled`,'info');
}

function requestNotifPermission(){
  if(!('Notification' in window)){toast('Browser notifications not supported.','error');return;}
  Notification.requestPermission().then(p=>{
    if(p==='granted'){toast('‚úÖ Notifications enabled!','success');document.getElementById('notifPermBanner').style.display='none';}
    else toast('Notifications blocked. Enable in browser settings.','error');
  });
}

function sendBrowserNotif(title,body,icon='üìö'){
  if(!('Notification' in window)||Notification.permission!=='granted')return;
  try{new Notification(title,{body,icon:'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>'+icon+'</text></svg>'});}catch(e){}
}

function generateAutoReminders(){
  if(!cu)return[];
  const reminders=[];const now=new Date();const settings=getRmSettings();
  const today=now.toISOString().split('T')[0];
  const hour=now.getHours();

  // 1. OVERDUE TASKS
  if(settings.overdue){
    const overdueTasks=tasks.filter(isOverdue);
    if(overdueTasks.length>0){
      reminders.push({
        id:'auto_overdue',type:'urgent',icon:'‚ö†Ô∏è',
        title:overdueTasks.length+' Overdue Task'+(overdueTasks.length>1?'s':'')+'!',
        msg:'Complete these immediately: '+overdueTasks.slice(0,3).map(t=>t.title).join(', ')+(overdueTasks.length>3?' + '+(overdueTasks.length-3)+' more':''),
        timeLabel:'Overdue now',
        action:()=>navigate('tasks'),
        actionLabel:'View Tasks ‚Üí'
      });
    }
  }

  // 2. DUE TODAY
  if(settings.deadline){
    const dueToday=tasks.filter(t=>t.due===today&&t.status!=='completed');
    if(dueToday.length>0){
      reminders.push({
        id:'auto_today',type:'soon',icon:'üìÖ',
        title:dueToday.length+' Task'+(dueToday.length>1?'s':'')+' Due Today',
        msg:dueToday.map(t=>t.title).slice(0,3).join(', ')+(dueToday.length>3?' and more...':''),
        timeLabel:'Due today',
        action:()=>navigate('tasks'),
        actionLabel:'View Tasks ‚Üí'
      });
    }
  }

  // 3. DUE TOMORROW
  if(settings.deadline){
    const tomorrow=new Date(Date.now()+86400000).toISOString().split('T')[0];
    const dueTomorrow=tasks.filter(t=>t.due===tomorrow&&t.status!=='completed');
    if(dueTomorrow.length>0){
      reminders.push({
        id:'auto_tomorrow',type:'soon',icon:'‚è∞',
        title:'Due Tomorrow: '+dueTomorrow.length+' Task'+(dueTomorrow.length>1?'s':''),
        msg:dueTomorrow.map(t=>t.title).slice(0,2).join(', ')+(dueTomorrow.length>2?' and more':''),
        timeLabel:'In 24 hours',
        action:()=>navigate('upcoming'),
        actionLabel:'See Upcoming ‚Üí'
      });
    }
  }

  // 4. STREAK WARNING
  if(settings.streak){
    const streakData=getStreakData();
    const studiedToday=!!streakData[now.toDateString()];
    const currentStreak=getCurStreak();
    if(!studiedToday&&hour>=17){
      reminders.push({
        id:'auto_streak',type:currentStreak>0?'urgent':'normal',icon:'üî•',
        title:currentStreak>0?`Don't break your ${currentStreak}-day streak!`:'Start your study streak today!',
        msg:currentStreak>0?'You haven\'t studied yet today. Complete a task or Pomodoro session to keep your streak alive!':'Study for at least 25 minutes to start building a consistent habit.',
        timeLabel:'Study today',
        action:()=>navigate('pomodoro'),
        actionLabel:'Start Timer ‚Üí'
      });
    }
  }

  // 5. FLASHCARDS DUE
  if(settings.flash){
    const dueCards=(G(`flashcards_${cu.email}`)||[]).filter(c=>c.nextReview<=Date.now());
    if(dueCards.length>0){
      reminders.push({
        id:'auto_flash',type:'normal',icon:'üÉè',
        title:dueCards.length+' Flashcard'+(dueCards.length>1?'s':'')+' Due for Review',
        msg:'Spaced repetition works best when reviewed on time. Takes only '+(Math.ceil(dueCards.length*0.5))+' minutes.',
        timeLabel:'Review now',
        action:()=>navigate('flashcards'),
        actionLabel:'Review Cards ‚Üí'
      });
    }
  }

  // 6. DAILY CHALLENGE
  if(settings.daily){
    const dailyDone=G(`dailyDone_${cu.email}`)||[];
    if(!dailyDone.includes(now.toDateString())&&hour>=9){
      reminders.push({
        id:'auto_daily',type:'normal',icon:'‚ö°',
        title:"Today's Daily Challenge Awaits!",
        msg:'Complete today\'s challenge and earn bonus XP. Only takes a few minutes!',
        timeLabel:'Complete today',
        action:()=>navigate('daily'),
        actionLabel:'View Challenge ‚Üí'
      });
    }
  }

  // 7. HIGH PRIORITY TASKS
  const highPending=tasks.filter(t=>t.priority==='high'&&t.status==='pending'&&!isOverdue(t));
  if(highPending.length>=3){
    reminders.push({
      id:'auto_high',type:'soon',icon:'üî¥',
      title:highPending.length+' High Priority Tasks Pending',
      msg:'Focus on: '+highPending.slice(0,2).map(t=>t.title).join(', ')+(highPending.length>2?' and '+(highPending.length-2)+' more':''),
      timeLabel:'High priority',
      action:()=>{setFilter('high',document.querySelector('[data-f="high"]'));navigate('tasks');},
      actionLabel:'View High Priority ‚Üí'
    });
  }

  // 8. NO STUDY TODAY (evening)
  if(hour>=20){
    const completedToday=tasks.filter(t=>t.status==='completed'&&new Date(t.updated).toDateString()===now.toDateString()).length;
    if(completedToday===0){
      reminders.push({
        id:'auto_evening',type:'normal',icon:'üåô',
        title:'Evening Study Reminder',
        msg:'You haven\'t completed any tasks today. Even 25 minutes of focused study makes a difference!',
        timeLabel:'Evening',
        action:()=>navigate('pomodoro'),
        actionLabel:'Start Pomodoro ‚Üí'
      });
    }
  }

  // 9. QUIZ SUGGESTION
  const quizH=G(`quizHist_${cu.email}`)||[];
  const lastQuiz=quizH.length?quizH[quizH.length-1]:null;
  const daysSinceQuiz=lastQuiz?Math.floor((Date.now()-lastQuiz.date)/86400000):999;
  if(daysSinceQuiz>=3){
    reminders.push({
      id:'auto_quiz',type:'normal',icon:'üß†',
      title:daysSinceQuiz===999?'Take your first quiz!':'Quiz yourself ‚Äî '+daysSinceQuiz+' days since last quiz',
      msg:'Regular self-testing is the most effective study technique. Earn XP for every correct answer!',
      timeLabel:daysSinceQuiz===999?'Never quizzed':''+daysSinceQuiz+'d ago',
      action:()=>navigate('quiz'),
      actionLabel:'Take Quiz ‚Üí'
    });
  }

  return reminders;
}

function renderReminders(){
  // Check notification permission
  if('Notification' in window&&Notification.permission==='default'){
    document.getElementById('notifPermBanner').style.display='flex';
  } else {
    document.getElementById('notifPermBanner').style.display='none';
  }

  // Load settings toggles
  const s=getRmSettings();
  ['overdue','streak','flash','daily','deadline'].forEach(k=>{
    const el=document.getElementById('rm-'+k);
    if(el)el.classList.toggle('on',!!s[k]);
  });

  refreshAutoReminders();
  renderCustomReminders();
  renderReminderHistory();
  updateReminderBadge();

  // Set default date to today
  const di=document.getElementById('rm-date');
  if(di)di.value=new Date().toISOString().split('T')[0];

  // Start checking reminders every minute
  if(reminderCheckInterval)clearInterval(reminderCheckInterval);
  reminderCheckInterval=setInterval(checkScheduledReminders,60000);
}

function refreshAutoReminders(){
  const reminders=generateAutoReminders();
  const grid=document.getElementById('autoRemindersGrid');
  if(!grid)return;

  if(!reminders.length){
    grid.innerHTML=`<div class="empty-s"><span class="ei">‚úÖ</span><div class="et">All clear!</div><div class="es">No urgent reminders right now. Keep up the great work!</div></div>`;
    return;
  }

  grid.innerHTML=reminders.map(r=>`
    <div class="reminder-card ${r.type}" style="cursor:pointer" onclick="${r.action.toString().includes('navigate')?'navigate(\''+r.action.toString().match(/navigate\('(\w+)'\)/)?.[1]+'\')'  :''}">
      <div class="reminder-ic" style="background:${r.type==='urgent'?'var(--red-bg)':r.type==='soon'?'var(--amber-bg)':'var(--green-bg)'}">
        <span class="rm-bell">${r.icon}</span>
      </div>
      <div style="flex:1;min-width:0">
        <div class="reminder-title">${E(r.title)}</div>
        <div class="reminder-sub">${E(r.msg)}</div>
        <button class="btn btn-sm" style="margin-top:9px;background:${r.type==='urgent'?'var(--red-bg)':r.type==='soon'?'var(--amber-bg)':'var(--acc-bg)'};color:${r.type==='urgent'?'var(--red)':r.type==='soon'?'var(--amber)':'var(--acc)'};border:none;padding:6px 14px;font-size:.78rem" onclick="event.stopPropagation();handleReminderAction('${r.id}')">${r.actionLabel}</button>
      </div>
      <span class="reminder-time" style="background:${r.type==='urgent'?'var(--red-bg)':r.type==='soon'?'var(--amber-bg)':'var(--green-bg)'};color:${r.type==='urgent'?'var(--red)':r.type==='soon'?'var(--amber)':'var(--green)'}">${r.timeLabel}</span>
    </div>`).join('');

  updateReminderBadge(reminders.filter(r=>r.type==='urgent').length);
}
function handleReminderAction(id){
  const actionMap={
    'auto_overdue':()=>navigate('tasks'),
    'auto_today':()=>navigate('tasks'),
    'auto_tomorrow':()=>navigate('upcoming'),
    'auto_streak':()=>navigate('pomodoro'),
    'auto_flash':()=>navigate('flashcards'),
    'auto_daily':()=>navigate('daily'),
    'auto_high':()=>navigate('tasks'),
    'auto_evening':()=>navigate('pomodoro'),
    'auto_quiz':()=>navigate('quiz'),
  };
  const action=actionMap[id];
  if(action)action();
}

function openAddReminderModal(){
  document.getElementById('rm-title').value='';
  document.getElementById('rm-msg').value='';
  document.getElementById('rm-date').value=new Date().toISOString().split('T')[0];
  document.getElementById('rm-time').value='08:00';
  document.getElementById('addReminderModal').classList.add('show');
}

function saveCustomReminder(){
  const title=document.getElementById('rm-title').value.trim();
  const msg=document.getElementById('rm-msg').value.trim();
  const date=document.getElementById('rm-date').value;
  const time=document.getElementById('rm-time').value;
  const type=document.getElementById('rm-type').value;
  const repeat=document.getElementById('rm-repeat').value;

  if(!title)return toast('Title is required!','error');
  if(!date)return toast('Please select a date!','error');

  const reminder={
    id:Date.now().toString(),
    title,msg,date,time,type,repeat,
    created:Date.now(),
    active:true,
    triggered:false
  };

  const reminders=getCustomReminders();
  reminders.unshift(reminder);
  saveCustomReminders(reminders);
  closeModal('addReminderModal');
  toast('üîî Reminder set!','success');
  addXP(5,'Reminder Created');
  renderCustomReminders();
  scheduleNotification(reminder);
}

function scheduleNotification(rm){
  if(!rm.date||!rm.time)return;
  const scheduledTime=new Date(rm.date+'T'+rm.time).getTime();
  const delay=scheduledTime-Date.now();
  if(delay<=0||delay>7*24*60*60*1000)return; // Only schedule within 7 days
  setTimeout(()=>{
    sendBrowserNotif('üìö '+rm.title,rm.msg||'Time to study!','üìö');
    addRmHistory(rm.title);
    toast('üîî Reminder: '+rm.title,'info');
    addNotif('üîî '+rm.title);
    // Handle repeat
    if(rm.repeat==='daily'){
      const next={...rm,id:Date.now().toString(),date:new Date(scheduledTime+86400000).toISOString().split('T')[0]};
      const all=getCustomReminders();all.push(next);saveCustomReminders(all);scheduleNotification(next);
    } else if(rm.repeat==='weekly'){
      const next={...rm,id:Date.now().toString(),date:new Date(scheduledTime+7*86400000).toISOString().split('T')[0]};
      const all=getCustomReminders();all.push(next);saveCustomReminders(all);scheduleNotification(next);
    }
  },delay);
}

function checkScheduledReminders(){
  if(!cu)return;
  const reminders=getCustomReminders();const now=Date.now();
  reminders.forEach(rm=>{
    if(!rm.active||rm.triggered)return;
    const t=new Date(rm.date+'T'+(rm.time||'00:00')).getTime();
    if(now>=t&&now-t<120000){ // Within 2 min window
      rm.triggered=true;
      sendBrowserNotif('üìö '+rm.title,rm.msg||'StudyBot reminder!');
      addRmHistory(rm.title);
      toast('üîî '+rm.title,'info');
      addNotif('üîî '+rm.title);
    }
  });
  saveCustomReminders(reminders);
}

function deleteCustomReminder(id){
  const reminders=getCustomReminders().filter(r=>r.id!==id);
  saveCustomReminders(reminders);
  renderCustomReminders();
  toast('Reminder deleted.','info');
}

function toggleReminderActive(id){
  const reminders=getCustomReminders();
  const rm=reminders.find(r=>r.id===id);
  if(rm){rm.active=!rm.active;saveCustomReminders(reminders);renderCustomReminders();toast(rm.active?'üîî Reminder enabled':'üîï Reminder paused','info');}
}

function renderCustomReminders(){
  const reminders=getCustomReminders();
  const grid=document.getElementById('customRemindersGrid');
  const cnt=document.getElementById('customReminderCount');
  if(cnt)cnt.textContent=reminders.length+' reminder'+(reminders.length!==1?'s':'');
  if(!grid)return;

  const typeIcons={study:'üìö',deadline:'‚è∞',quiz:'üß†',break:'‚òï',custom:'üìå'};
  if(!reminders.length){
    grid.innerHTML=`<div class="empty-s"><span class="ei">üìå</span><div class="et">No custom reminders</div><div class="es">Add reminders for specific tasks or events</div></div>`;
    return;
  }

  grid.innerHTML=reminders.map(r=>{
    const dt=r.date?new Date(r.date+'T'+(r.time||'00:00')):null;
    const isPast=dt&&dt<new Date();
    return `
      <div class="reminder-card ${isPast?'':'normal'}" style="${!r.active?'opacity:.5':''}">
        <div class="reminder-ic" style="background:var(--acc-bg)">${typeIcons[r.type]||'üìå'}</div>
        <div style="flex:1;min-width:0">
          <div class="reminder-title">${E(r.title)}</div>
          ${r.msg?`<div class="reminder-sub">${E(r.msg)}</div>`:''}
          <div style="display:flex;gap:8px;margin-top:7px;flex-wrap:wrap">
            ${dt?`<span style="font-size:.72rem;font-weight:700;color:var(--tx3)">üìÖ ${dt.toLocaleDateString('en-GB',{day:'numeric',month:'short'})} ${r.time||''}</span>`:''}
            <span style="font-size:.72rem;font-weight:700;color:var(--acc)">‚Ü∫ ${r.repeat}</span>
            <span style="font-size:.72rem;font-weight:700;color:${r.active?'var(--green)':'var(--tx4)'}">${r.active?'‚óè Active':'‚óè Paused'}</span>
          </div>
        </div>
        <div style="display:flex;flex-direction:column;gap:6px;flex-shrink:0">
          <div class="ic-btn" onclick="toggleReminderActive('${r.id}')" title="${r.active?'Pause':'Enable'}">${r.active?'‚è∏':'‚ñ∂'}</div>
          <div class="ic-btn del" onclick="deleteCustomReminder('${r.id}')" title="Delete">‚úï</div>
        </div>
      </div>`;
  }).join('');
}

function renderReminderHistory(){
  const hist=getRmHistory();
  const el=document.getElementById('reminderHistory');
  if(!el)return;
  el.innerHTML=hist.length?hist.slice(0,10).map(h=>`
    <div style="display:flex;align-items:center;gap:11px;padding:10px 0;border-bottom:1px solid var(--border)">
      <span style="font-size:1rem">üîî</span>
      <div style="flex:1"><div style="font-size:.88rem;font-weight:700;color:var(--tx)">${E(h.msg)}</div></div>
      <span style="font-size:.72rem;color:var(--tx4)">${new Date(h.time).toLocaleString('en-GB',{day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'})}</span>
    </div>`).join('')
  :`<div style="text-align:center;padding:22px;color:var(--tx3);font-size:.9rem">No reminder history yet.</div>`;
}

function clearReminderHistory(){
  S(`rm_history_${cu.email}`,[]);
  renderReminderHistory();
  toast('History cleared.','info');
}

function updateReminderBadge(count){
  const auto=count!==undefined?count:generateAutoReminders().filter(r=>r.type==='urgent').length;
  const badge=document.getElementById('reminderBadge');
  if(badge){badge.style.display=auto>0?'flex':'none';badge.textContent=auto;}
}

// Init reminders on app start
function initReminders(){
  if(!cu)return;
  // Reschedule all active custom reminders
  getCustomReminders().filter(r=>r.active&&!r.triggered).forEach(scheduleNotification);
  // Check auto reminders every 5 mins
  setInterval(()=>{
    const urgent=generateAutoReminders().filter(r=>r.type==='urgent');
    urgent.forEach(r=>{
      const lastShown=parseInt(localStorage.getItem('rm_shown_'+r.id)||'0');
      if(Date.now()-lastShown>3600000){ // Show max once per hour
        sendBrowserNotif('‚ö†Ô∏è '+r.title,r.msg);
        localStorage.setItem('rm_shown_'+r.id,Date.now());
      }
    });
    updateReminderBadge();
  },300000);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TIMETABLE BUILDER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const TT_DAYS=['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
const TT_HOURS=['6 AM','7 AM','8 AM','9 AM','10 AM','11 AM','12 PM','1 PM','2 PM','3 PM','4 PM','5 PM','6 PM','7 PM','8 PM','9 PM','10 PM'];
const TT_COLORS=['#3D5AFE','#7B2FBE','#15A352','#D97706','#E03131','#0B8E85','#D63384','#0284C7','#7C3AED','#059669'];
let ttSelectedColor=TT_COLORS[0];
let dragSrc=null;

function getTT(){return G(`tt_${cu?.email||''}`)||{};}
function saveTT(d){S(`tt_${cu?.email||''}`,d);}
function getTTColors(){return G(`tt_colors_${cu?.email||''}`)||{};}
function saveTTColors(d){S(`tt_colors_${cu?.email||''}`,d);}

function renderTimetable(){
  const tt=getTT();
  const colorMap=getTTColors();

  // Legend
  const subjects=new Set(Object.values(tt).map(b=>b.subject));
  const legEl=document.getElementById('ttLegend');
  if(legEl){
    legEl.innerHTML=subjects.size?[...subjects].map(s=>`
      <div class="tt-legend-item">
        <div class="tt-legend-dot" style="background:${colorMap[s]||TT_COLORS[0]}"></div>
        ${E(s)}
      </div>`).join('')
    :'<div style="font-size:.84rem;color:var(--tx3)">No subjects yet ‚Äî add your first block!</div>';
  }

  // Stats
  const blocks=Object.values(tt);
  const statEl=document.getElementById('ttStats');
  if(statEl){
    const totalHours=blocks.length;
    const subjCount=new Set(blocks.map(b=>b.subject)).size;
    const todayIdx=(new Date().getDay()+6)%7;
    const todayBlocks=blocks.filter(b=>parseInt(b.day)===todayIdx).length;
    statEl.innerHTML=[
      {ic:'‚è∞',v:totalHours+'h',l:'Total Hours/Week'},
      {ic:'üìö',v:subjCount,l:'Subjects'},
      {ic:'üìÖ',v:todayBlocks+'h',l:'Today\'s Study'},
      {ic:'üóìÔ∏è',v:Math.round(totalHours/7*10)/10+'h',l:'Avg per Day'},
    ].map(s=>`
      <div class="card" style="text-align:center;padding:16px">
        <div style="font-size:1.3rem;margin-bottom:6px">${s.ic}</div>
        <div style="font-size:1.4rem;font-weight:900;color:var(--acc)">${s.v}</div>
        <div style="font-size:.72rem;color:var(--tx3);font-weight:700">${s.l}</div>
      </div>`).join('');
  }

  // Build grid
  const grid=document.getElementById('ttGrid');
  if(!grid)return;
  let html='';

  // Header row
  html+='<div class="tt-head" style="background:transparent"></div>';
  TT_DAYS.forEach((d,i)=>{
    const isToday=(new Date().getDay()+6)%7===i;
    html+=`<div class="tt-head" style="${isToday?'background:var(--acc);color:#fff;':''}">${d.slice(0,3)}${isToday?'<div style="font-size:.6rem;opacity:.8">Today</div>':''}</div>`;
  });

  // Time rows
  TT_HOURS.forEach((h,hi)=>{
    html+=`<div class="tt-time">${h}</div>`;
    TT_DAYS.forEach((_,di)=>{
      const key=`${di}_${hi}`;
      const block=tt[key];
      if(block){
        const color=colorMap[block.subject]||TT_COLORS[0];
        html+=`<div class="tt-cell has-block" draggable="true" 
          ondragstart="ttDragStart(event,'${key}')" 
          ondragover="event.preventDefault();this.classList.add('drag-over')" ondragleave="this.classList.remove('drag-over')"
          ondrop="ttDrop(event,'${key}')">
          <div class="tt-block" style="background:${color}">
            <button class="tt-block-del" onclick="deleteBlock('${key}')">‚úï</button>
            <div class="tt-block-title">${E(block.subject)}</div>
            ${block.topic?`<div class="tt-block-sub">${E(block.topic)}</div>`:''}
          </div>
        </div>`;
      } else {
        html+=`<div class="tt-cell" 
          ondragover="event.preventDefault();this.classList.add('drag-over')"
          ondragleave="this.classList.remove('drag-over')"
          ondrop="ttDrop(event,'${key}')"
          onclick="quickAddBlock(${di},${hi})"
          title="Click to add study block">
          <span style="font-size:.9rem;color:var(--border2);transition:all .2s">+</span>
        </div>`;
      }
    });
  });

  grid.innerHTML=html;

  // Summary
  const summaryEl=document.getElementById('ttSummary');
  if(summaryEl){
    const byDay=TT_DAYS.map((d,i)=>({
      day:d,
      hours:blocks.filter(b=>parseInt(b.day)===i).length,
      subjects:[...new Set(blocks.filter(b=>parseInt(b.day)===i).map(b=>b.subject))]
    }));
    summaryEl.innerHTML=`<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px">
      ${byDay.map(d=>{
        const isToday=TT_DAYS.indexOf(d.day)===(new Date().getDay()+6)%7;
        return `<div style="background:${isToday?'var(--acc-bg)':'var(--surface2)'};border:1.5px solid ${isToday?'rgba(61,90,254,.3)':'var(--border)'};border-radius:var(--r);padding:14px;text-align:center">
          <div style="font-size:.75rem;font-weight:900;color:${isToday?'var(--acc)':'var(--tx3)'};margin-bottom:6px">${d.day.slice(0,3).toUpperCase()}</div>
          <div style="font-size:1.4rem;font-weight:900;color:var(--tx)">${d.hours}h</div>
          <div style="font-size:.65rem;color:var(--tx3);margin-top:4px">${d.subjects.slice(0,2).join(', ')||'Free'}</div>
        </div>`;
      }).join('')}
    </div>`;
  }
}

function openAddBlockModal(day,slot){
  // Populate slot select
  const slotSel=document.getElementById('ttSlot');
  slotSel.innerHTML=TT_HOURS.map((h,i)=>`<option value="${i}">${h}</option>`).join('');
  if(day!==undefined)document.getElementById('ttDay').value=day;
  if(slot!==undefined)slotSel.value=slot;
  document.getElementById('ttSubj').value='';
  document.getElementById('ttTopic').value='';

  // Color picker
  const cp=document.getElementById('ttColorPicker');
  cp.innerHTML=TT_COLORS.map(c=>`
    <div onclick="ttSelectedColor='${c}';document.querySelectorAll('.tt-cp-dot').forEach(d=>d.style.outline='none');this.style.outline='3px solid var(--tx)'"
      class="tt-cp-dot"
      style="width:28px;height:28px;border-radius:9px;background:${c};cursor:pointer;transition:transform .15s;outline:${c===ttSelectedColor?'3px solid var(--tx)':'none'}"
      onmouseover="this.style.transform='scale(1.2)'" onmouseout="this.style.transform=''">
    </div>`).join('');

  document.getElementById('addBlockModal').classList.add('show');
}

function quickAddBlock(day,slot){
  openAddBlockModal(day,slot);
}

function saveBlock(){
  const subj=document.getElementById('ttSubj').value.trim();
  if(!subj)return toast('Subject is required!','error');
  const day=document.getElementById('ttDay').value;
  const slot=parseInt(document.getElementById('ttSlot').value);
  const dur=parseInt(document.getElementById('ttDur').value);
  const topic=document.getElementById('ttTopic').value.trim();

  const tt=getTT();
  const colors=getTTColors();
  colors[subj]=ttSelectedColor;
  saveTTColors(colors);

  for(let i=0;i<dur;i++){
    const key=`${day}_${slot+i}`;
    tt[key]={subject:subj,topic:i===0?topic:'',day,slot:slot+i};
  }
  saveTT(tt);
  closeModal('addBlockModal');
  toast('Block added!','success');
  addXP(3,'Timetable Updated');
  renderTimetable();
}

function deleteBlock(key){
  const tt=getTT();delete tt[key];saveTT(tt);renderTimetable();toast('Block removed.','info');
}

function clearTimetable(){
  if(!confirm('Clear entire timetable?'))return;
  saveTT({});renderTimetable();toast('Timetable cleared.','info');
}

function ttDragStart(e,key){
  dragSrc=key;e.dataTransfer.effectAllowed='move';e.dataTransfer.setData('text/plain',key);
}

// ‚úÖ Fix - ttDrop-‡Æ≤ cleanup add ‡Æ™‡Æ£‡Øç‡Æ£‡ØÅ
function ttDrop(e, targetKey){
  e.preventDefault();
  // ‚úÖ This line already fix ‡Æ™‡Æ£‡Øç‡Æ±‡Æ§‡ØÅ ‚Äî ‡Æá‡Æ®‡Øç‡Æ§ line ‡Æá‡Æ∞‡ØÅ‡Æï‡Øç‡Æï‡Ææ confirm ‡Æ™‡Æ£‡Øç‡Æ£‡ØÅ:
  document.querySelectorAll('.tt-cell').forEach(c => c.classList.remove('drag-over'));
  
  if(!dragSrc || dragSrc === targetKey) return;
  const tt=getTT();
  const srcBlock=tt[dragSrc];
  if(!srcBlock)return;
  if(tt[targetKey])return toast('Cell already has a block!','error');
  const [td,ts]=targetKey.split('_');
  tt[targetKey]={...srcBlock,day:td,slot:parseInt(ts)};
  delete tt[dragSrc];
  dragSrc=null;
  saveTT(tt);
  renderTimetable();
  toast('Block moved!','success');
}

function openColorManager(){
  const colors=getTTColors();
  const subjects=[...new Set(Object.values(getTT()).map(b=>b.subject))];
  if(!subjects.length)return toast('Add some blocks first!','info');
  toast('Click a block to change its color coming soon!','info');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FRIENDS & SOCIAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function genFriendCode(email){
  let hash=0;for(let i=0;i<email.length;i++)hash=(hash<<5)-hash+email.charCodeAt(i);
  const chars='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let code='SBP-';for(let i=0;i<4;i++)code+=chars[Math.abs(hash>>>(i*4))%chars.length];
  return code;
}

function getFriends(){return G(`friends_${cu?.email||''}`)||[];}
function saveFriends(f){S(`friends_${cu?.email||''}`,f);}
function getChallenges(){return G(`challenges_${cu?.email||''}`)||[];}
function saveChallenges(c){S(`challenges_${cu?.email||''}`,c);}

function renderFriends(){
  const myCode=genFriendCode(cu.email);
  const xp=getXP();const lv=getLvl(xp);const idx=getLvlIdx(xp);
  document.getElementById('friendMyAv').textContent=cu.name.charAt(0).toUpperCase();
  document.getElementById('friendMyName').textContent=cu.name;
  document.getElementById('friendMyLevel').textContent='Level '+(idx+1)+' '+lv.name+' '+lv.emoji+' ¬∑ '+xp+' XP';
  document.getElementById('myFriendCode').textContent=myCode;

  const friends=getFriends();
  document.getElementById('friendCount').textContent=friends.length+' friend'+(friends.length!==1?'s':'');

  // Friends list
  const fl=document.getElementById('friendsList');
  fl.innerHTML=friends.length?friends.map(f=>`
    <div style="display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid var(--border)">
      <div style="width:42px;height:42px;border-radius:13px;background:linear-gradient(135deg,var(--acc),var(--purple));display:flex;align-items:center;justify-content:center;font-weight:900;color:#fff;font-size:1rem;flex-shrink:0">${f.name.charAt(0).toUpperCase()}</div>
      <div style="flex:1">
        <div style="font-weight:800;font-size:.9rem;color:var(--tx)">${E(f.name)}</div>
        <div style="font-size:.74rem;color:var(--tx3)">${f.grade||'Student'} ¬∑ Code: ${f.code}</div>
      </div>
      <div class="ic-btn del" onclick="removeFriend('${f.code}')">‚úï</div>
    </div>`).join('')
  :`<div class="empty-s"><span class="ei">üë•</span><div class="et">No friends yet</div><div class="es">Share your code to connect!</div></div>`;

  // Leaderboard with friends + self
  const myEntry={name:cu.name+'(You)',xp:getXP(),av:cu.name.charAt(0).toUpperCase(),you:true};
  const mockFriendXP=friends.map(f=>({name:f.name,xp:f.xp||Math.floor(Math.random()*2000+100),av:f.name.charAt(0).toUpperCase(),you:false}));
  const lb=[myEntry,...mockFriendXP].sort((a,b)=>b.xp-a.xp);
  const medals=['ü•á','ü•à','ü•â'];
  document.getElementById('friendsLeaderboard').innerHTML=lb.length>1?lb.map((p,i)=>`
    <div class="lb-row${p.you?' you-row':''}">
      <div class="lb-rank" style="background:${i<3?['#FFD700','#C0C0C0','#CD7F32'][i]:'var(--surface2)'};color:${i<3?'#000':'var(--tx3)'}">${i<3?medals[i]:i+1}</div>
      <div class="lb-av" style="background:linear-gradient(135deg,var(--acc),var(--purple))">${p.av}</div>
      <div style="flex:1"><div style="font-weight:${p.you?900:700};font-size:.88rem;color:var(--tx)">${E(p.name)}</div></div>
      <div style="font-weight:900;color:${p.you?'var(--acc)':'var(--tx2)'};font-size:.88rem">${p.xp.toLocaleString()} XP</div>
    </div>`).join('')
  :`<div style="text-align:center;padding:22px;color:var(--tx3);font-size:.88rem">Add friends to see leaderboard!</div>`;

  // Battle friend selector
  const bfs=document.getElementById('battleFriend');
  if(bfs){bfs.innerHTML='<option value="">Select friend...</option>'+friends.map(f=>`<option value="${f.code}">${E(f.name)}</option>`).join('');}

  renderPendingChallenges();
}

function copyFriendCode(){
  const code=genFriendCode(cu.email);
  navigator.clipboard.writeText(code).then(()=>toast('üìã Code copied: '+code,'success')).catch(()=>toast('Your code: '+code,'info'));
}

function shareFriendCode(){
  const code=genFriendCode(cu.email);
  const text=`Hey! Join me on StudyBot Pro üìö\nMy friend code: ${code}\nLet's study and compete together!`;
  if(navigator.share)navigator.share({title:'StudyBot Pro',text});
  else{navigator.clipboard.writeText(text);toast('üìã Share text copied!','success');}
}

function addFriend(){
  const inp=document.getElementById('friendCodeInp');
  const code=inp.value.trim().toUpperCase();
  if(!code.startsWith('SBP-')||code.length!==8)return toast('Invalid friend code! Format: SBP-XXXX','error');
  if(code===genFriendCode(cu.email))return toast('That\'s your own code!','error');
  const friends=getFriends();
  if(friends.find(f=>f.code===code))return toast('Already added!','error');

  // Find user with this code
  const users=G('sb_users')||{};
  const found=Object.values(users).find(u=>genFriendCode(u.email)===code);

  if(found){
    friends.push({name:found.name,code,grade:found.grade||'Student',xp:0,added:Date.now()});
    saveFriends(friends);inp.value='';
    toast('üéâ '+found.name+' added as friend!','success');
    addXP(15,'Added Friend');
    document.getElementById('friendBadge').style.display='flex';
  } else {
    // Add as unknown friend (they might not be on same device)
    friends.push({name:'Friend '+code.slice(-4),code,grade:'Student',xp:Math.floor(Math.random()*1500+200),added:Date.now()});
    saveFriends(friends);inp.value='';
    toast('Friend added! They\'ll appear when they join.','success');
    addXP(15,'Added Friend');
  }
  renderFriends();
}

function removeFriend(code){
  if(!confirm('Remove this friend?'))return;
  saveFriends(getFriends().filter(f=>f.code!==code));
  renderFriends();toast('Friend removed.','info');
}

function sendBattleChallenge(){
  const subj=document.getElementById('battleSubj').value;
  const friendCode=document.getElementById('battleFriend').value;
  if(!friendCode)return toast('Select a friend to challenge!','error');

  const friend=getFriends().find(f=>f.code===friendCode);
  if(!friend)return toast('Friend not found!','error');

  // Simulate a battle ‚Äî take quiz and compare
  toast(`‚öîÔ∏è Challenge sent to ${friend.name}! Take the quiz to set your score.`,'success');
  addXP(10,'Quiz Battle Started');

  // Store challenge
  const challenges=getChallenges();
  const ch={id:Date.now().toString(),subject:subj,challenger:cu.name,challengerXP:null,opponent:friend.name,opponentCode:friendCode,opponentXP:null,status:'pending',created:Date.now()};
  challenges.unshift(ch);saveChallenges(challenges);

  // Auto-start quiz
  setTimeout(()=>{
    quizSubject=subj;
    const qa=QUIZ_DATA[subj].questions;
    quizQs=[...qa].sort(()=>Math.random()-.5).slice(0,10);
    quizIdx=0;quizScore=0;quizAnswered=false;
    navigate('quiz');
    document.getElementById('quizSubjectSelect').style.display='none';
    document.getElementById('quizArea').classList.add('show');
    renderQuizQ();
  },1000);
}

function renderPendingChallenges(){
  const challenges=getChallenges();
  const el=document.getElementById('pendingChallenges');
  if(!el)return;
  el.innerHTML=challenges.length?challenges.slice(0,5).map(c=>`
    <div style="display:flex;align-items:center;gap:13px;padding:12px 0;border-bottom:1px solid var(--border)">
      <div style="font-size:1.3rem">‚öîÔ∏è</div>
      <div style="flex:1">
        <div style="font-weight:800;font-size:.88rem;color:var(--tx)">${E(c.subject)} Battle</div>
        <div style="font-size:.75rem;color:var(--tx3)">vs ${E(c.opponent)} ¬∑ ${new Date(c.created).toLocaleDateString()}</div>
      </div>
      <span style="padding:4px 12px;border-radius:100px;font-size:.72rem;font-weight:800;background:var(--amber-bg);color:var(--amber)">${c.status}</span>
    </div>`).join('')
  :`<div style="text-align:center;padding:22px;color:var(--tx3);font-size:.9rem">No active challenges. Challenge a friend!</div>`;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GLOBAL SEARCH ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let gsFocusIdx=-1;
let gsItems=[];

function openGlobalSearch(){
  document.getElementById('gsOverlay').classList.add('show');
  setTimeout(()=>document.getElementById('gsInput').focus(),50);
  gsSearch();
}

function closeGlobalSearch(){
  document.getElementById('gsOverlay').classList.remove('show');
  document.getElementById('gsInput').value='';
  gsFocusIdx=-1;
}

function gsSearch(){
  const q=document.getElementById('gsInput').value.trim().toLowerCase();
  const res=document.getElementById('gsResults');
  gsFocusIdx=-1;gsItems=[];

  if(!q){
    // Show quick nav when empty
    const pages=[
      {ic:'üè†',title:'Dashboard',sub:'Overview & stats',pg:'dashboard'},
      {ic:'üìã',title:'My Tasks',sub:tasks.length+' tasks',pg:'tasks'},
      {ic:'üß†',title:'Quiz',sub:'120+ questions',pg:'quiz'},
      {ic:'üìù',title:'Notes',sub:notes.length+' notes',pg:'notes'},
      {ic:'‚è±Ô∏è',title:'Pomodoro',sub:'Focus timer',pg:'pomodoro'},
      {ic:'üèÜ',title:'XP & Badges',sub:getXP()+' XP earned',pg:'gamify'},
      {ic:'‚ö°',title:'Daily Challenge',sub:'Bonus XP today',pg:'daily'},
      {ic:'üÉè',title:'Flashcards',sub:fcCards.length+' cards',pg:'flashcards'},
    ];
    res.innerHTML=`<div class="gs-section">Quick Navigation</div>`+
      pages.map((p,i)=>`<div class="gs-item" onclick="closeGlobalSearch();navigate('${p.pg}')" data-idx="${i}"><div class="gs-item-ic" style="background:var(--acc-bg)">${p.ic}</div><div><div class="gs-item-title">${p.title}</div><div class="gs-item-sub">${p.sub}</div></div></div>`).join('');
    gsItems=pages;return;
  }

  const results=[];

  // Search tasks
  tasks.filter(t=>t.title.toLowerCase().includes(q)||(t.subject||'').toLowerCase().includes(q)||(t.notes||'').toLowerCase().includes(q)).slice(0,5).forEach(t=>{
    results.push({type:'task',ic:'üìã',bg:'var(--acc-bg)',title:t.title,sub:(t.subject||'General')+' ¬∑ '+t.priority+' ¬∑ '+t.status,action:()=>{navigate('tasks');setTimeout(()=>{const el=document.querySelector(`[onclick*="${t.id}"]`);if(el)el.scrollIntoView({behavior:'smooth'});},300);}});
  });

  // Search notes
  notes.filter(n=>n.title.toLowerCase().includes(q)||n.content.toLowerCase().includes(q)||(n.subject||'').toLowerCase().includes(q)).slice(0,4).forEach(n=>{
    results.push({type:'note',ic:'üìù',bg:'var(--green-bg)',title:n.title||'Untitled',sub:(n.subject||'General')+' ¬∑ '+new Date(n.updated||n.created).toLocaleDateString(),action:()=>{navigate('notes');setTimeout(()=>openNoteEditor(n.id),300);}});
  });

  // Search flashcards
  fcCards.filter(c=>c.front.toLowerCase().includes(q)||c.back.toLowerCase().includes(q)||(c.subj||'').toLowerCase().includes(q)).slice(0,4).forEach(c=>{
    results.push({type:'card',ic:'üÉè',bg:'var(--purple-bg)',title:c.front.slice(0,60)+(c.front.length>60?'...':''),sub:'Answer: '+c.back.slice(0,40)+'...',action:()=>navigate('flashcards')});
  });

  // Search pages
  const pageMap=[
    {title:'Dashboard',sub:'Overview',pg:'dashboard',ic:'üè†'},
    {title:'My Tasks',sub:'Task manager',pg:'tasks',ic:'üìã'},
    {title:'Quiz',sub:'Test knowledge',pg:'quiz',ic:'üß†'},
    {title:'Notes',sub:'Study notes',pg:'notes',ic:'üìù'},
    {title:'Pomodoro Timer',sub:'Focus sessions',pg:'pomodoro',ic:'‚è±Ô∏è'},
    {title:'Performance Analytics',sub:'Charts & stats',pg:'performance',ic:'üìà'},
    {title:'Streaks & Goals',sub:'Habit tracking',pg:'streaks',ic:'üî•'},
    {title:'XP & Badges',sub:'Achievements',pg:'gamify',ic:'üèÜ'},
    {title:'Daily Challenge',sub:'Bonus XP',pg:'daily',ic:'‚ö°'},
    {title:'Flashcards',sub:'Spaced repetition',pg:'flashcards',ic:'üÉè'},
    {title:'AI Tools',sub:'Predictor & planner',pg:'aitools',ic:'‚ú®'},
    {title:'Timetable',sub:'Weekly schedule',pg:'timetable',ic:'üóìÔ∏è'},
    {title:'Friends',sub:'Social & challenges',pg:'friends',ic:'üë•'},
    {title:'Reminders',sub:'Smart alerts',pg:'reminders',ic:'üîî'},
    {title:'Progress Report',sub:'PDF export',pg:'report',ic:'üìä'},
    {title:'Account Settings',sub:'Profile & preferences',pg:'account',ic:'‚öôÔ∏è'},
  ].filter(p=>p.title.toLowerCase().includes(q));
  pageMap.forEach(p=>results.push({type:'page',ic:p.ic,bg:'var(--surface2)',title:p.title,sub:p.sub,action:()=>navigate(p.pg)}));

  gsItems=results;

  if(!results.length){
    res.innerHTML=`<div class="gs-empty"><div class="gs-empty-ic">üòï</div><div style="font-weight:700;color:var(--tx2);margin-bottom:5px">No results for "${E(q)}"</div><div style="font-size:.84rem">Try searching for tasks, notes, or page names</div></div>`;
    return;
  }

  // Group by type
  const groups={task:[],note:[],card:[],page:[]};
  results.forEach(r=>groups[r.type].push(r));
  const typeLabels={task:'üìã Tasks',note:'üìù Notes',card:'üÉè Flashcards',page:'üß≠ Pages'};
  let html='';
  // gsItems-‡Æê grouped order-‡Æ≤‡Øç rebuild ‡Æ™‡Æ£‡Øç‡Æ£‡ØÅ‡Æµ‡Øã‡ÆÆ‡Øç ‚Äî idx match ‡ÆÜ‡Æï
  gsItems=[];
  Object.entries(groups).forEach(([type,items])=>{
    if(!items.length)return;
    html+=`<div class="gs-section">${typeLabels[type]}</div>`;
    items.forEach(item=>{
      const idx=gsItems.length;
      gsItems.push(item);
      html+=`<div class="gs-item" data-idx="${idx}" onclick="gsSelectItem(${idx})"><div class="gs-item-ic" style="background:${item.bg}">${item.ic}</div><div><div class="gs-item-title">${E(item.title)}</div><div class="gs-item-sub">${E(item.sub)}</div></div></div>`;
    });
  });
  res.innerHTML=html;
}

function gsSelectItem(idx){
  const item=gsItems[idx];
  if(!item)return;
  closeGlobalSearch();
  if(item.action)item.action();
  else if(item.pg)navigate(item.pg);
}

function gsKeyNav(e){
  const items=document.querySelectorAll('.gs-item');
  if(e.key==='ArrowDown'){e.preventDefault();gsFocusIdx=Math.min(gsFocusIdx+1,items.length-1);updateGSFocus(items);}
  else if(e.key==='ArrowUp'){e.preventDefault();gsFocusIdx=Math.max(gsFocusIdx-1,0);updateGSFocus(items);}
  else if(e.key==='Enter'){e.preventDefault();if(gsFocusIdx>=0)gsSelectItem(parseInt(items[gsFocusIdx].dataset.idx));else if(gsItems.length>0)gsSelectItem(0);}
  else if(e.key==='Escape')closeGlobalSearch();
}

function updateGSFocus(items){
  items.forEach(i=>i.classList.remove('focused'));
  if(items[gsFocusIdx]){items[gsFocusIdx].classList.add('focused');items[gsFocusIdx].scrollIntoView({block:'nearest'});}
}

// Keyboard shortcut
document.addEventListener('keydown',e=>{
  if((e.ctrlKey||e.metaKey)&&e.key==='k'){e.preventDefault();if(document.getElementById('gsOverlay').classList.contains('show'))closeGlobalSearch();else openGlobalSearch();}

  if(e.key==='Escape'){
    document.querySelectorAll('.modal.show').forEach(m=>m.classList.remove('show'));
    document.querySelectorAll('.notif-panel.show').forEach(p=>p.classList.remove('show'));
  }
  if(e.key==='Enter'&&e.ctrlKey){
    const activeBtn=document.querySelector('.modal.show .btn-primary');
    if(activeBtn)activeBtn.click();
  }
  if(e.key==='n'&&!e.ctrlKey&&document.activeElement.tagName!=='INPUT'&&document.activeElement.tagName!=='TEXTAREA'){
    const addTaskBtn=document.getElementById('addTaskBtn');
    if(addTaskBtn)addTaskBtn.click();
  }
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ONBOARDING TOUR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const OB_STEPS=[
  {title:'Welcome to StudyBot Pro! üéì',desc:'Let\'s take a quick tour to help you get started. This will only take 2 minutes!',target:null,pos:'center'},
  {title:'Your Dashboard üè†',desc:'This is your command centre! See task progress, streaks, XP level, and quick stats at a glance.',target:'[data-pg="dashboard"]',pos:'right'},
  {title:'Add Your First Task ‚ûï',desc:'Click here to add assignments, projects, and study tasks. Set priority, due date, and let AI generate subtasks!',target:'[data-pg="add"]',pos:'right'},
  {title:'Quiz Yourself üß†',desc:'Test your knowledge in 6 subjects. Earn +10 XP per correct answer. Explanations included!',target:'[data-pg="quiz"]',pos:'right'},
  {title:'Pomodoro Timer ‚è±Ô∏è',desc:'Study in focused 25-min sprints. Complete sessions to earn XP and build your streak. Focus mode included!',target:'[data-pg="pomodoro"]',pos:'right'},
  {title:'XP & Badges üèÜ',desc:'Every action earns XP. Level up from Seedling to Grandmaster. Unlock 22+ unique badges!',target:'[data-pg="gamify"]',pos:'right'},
  {title:'Daily Challenge ‚ö°',desc:'Fresh challenge every day for bonus XP. Complete it daily to build an unstoppable habit!',target:'[data-pg="daily"]',pos:'right'},
  {title:'Flashcards üÉè',desc:'Create flashcard decks and review with spaced repetition (SM-2 algorithm). Most effective memorisation method!',target:'[data-pg="flashcards"]',pos:'right'},
  {title:'Smart Reminders üîî',desc:'Set custom reminders and get auto-generated alerts for deadlines, streaks, and study goals.',target:'[data-pg="reminders"]',pos:'right'},
  {title:'You\'re all set! üöÄ',desc:'Start by adding your first task or taking a quiz. Your study journey begins now. Good luck! üí™',target:null,pos:'center'},
];

let obStep=0;
let obElements=[];

function startOnboarding(){
  obStep=0;
  showOBStep();
}

function showOBStep(){
  clearOBElements();
  if(obStep>=OB_STEPS.length){endOnboarding();return;}
  const step=OB_STEPS[obStep];

  // Backdrop
  const bd=document.createElement('div');bd.className='ob-backdrop';bd.id='obBackdrop';document.body.appendChild(bd);obElements.push(bd);

  // Highlight target
  let targetRect=null;
  if(step.target){
    const el=document.querySelector(step.target);
    if(el){
      targetRect=el.getBoundingClientRect();
      const hl=document.createElement('div');
      hl.className='ob-highlight';
      hl.style.cssText=`top:${targetRect.top-6}px;left:${targetRect.left-6}px;width:${targetRect.width+12}px;height:${targetRect.height+12}px`;
      document.body.appendChild(hl);obElements.push(hl);
    }
  }

  // Tooltip
  const tt=document.createElement('div');tt.className='ob-tooltip';

  // Dots
  const dots=OB_STEPS.map((_,i)=>`<div class="ob-dot${i===obStep?' active':''}"></div>`).join('');

  tt.innerHTML=`
    <div class="ob-step-num">Step ${obStep+1} of ${OB_STEPS.length}</div>
    <div class="ob-title">${step.title}</div>
    <div class="ob-desc">${step.desc}</div>
    <div class="ob-dots">${dots}</div>
    <div class="ob-btns">
      <button onclick="skipOnboarding()" style="flex:1;padding:9px;border-radius:var(--r-sm);border:1.5px solid var(--border);background:transparent;color:var(--tx3);font-size:.82rem;cursor:pointer;font-family:var(--font)">Skip Tour</button>
      ${obStep>0?`<button onclick="prevOBStep()" style="padding:9px 16px;border-radius:var(--r-sm);border:1.5px solid var(--border);background:transparent;color:var(--tx2);font-size:.85rem;cursor:pointer;font-family:var(--font)">‚Üê Back</button>`:''}
      <button onclick="nextOBStep()" style="flex:2;padding:10px;border-radius:var(--r-sm);border:none;background:var(--acc);color:#fff;font-size:.9rem;font-weight:800;cursor:pointer;font-family:var(--font)">${obStep===OB_STEPS.length-1?'üöÄ Get Started!':'Next ‚Üí'}</button>
    </div>`;

  // Position tooltip
  if(step.pos==='center'||!targetRect){
    tt.style.cssText='top:50%;left:50%;transform:translate(-50%,-50%)';
  } else if(targetRect){
    const top=Math.max(10,Math.min(targetRect.top,window.innerHeight-300));
    const left=targetRect.right+18;
    tt.style.cssText=`top:${top}px;left:${Math.min(left,window.innerWidth-340)}px`;
  }

  document.body.appendChild(tt);obElements.push(tt);
}

function nextOBStep(){obStep++;showOBStep();}
function prevOBStep(){obStep--;showOBStep();}

function clearOBElements(){
  obElements.forEach(el=>el.remove());
  obElements=[];
}

function endOnboarding(){
  clearOBElements();
  S('ob_done_'+(cu?.email||''),'true');
  spawnConfetti();
  toast('üéâ Tour complete! You\'re ready to study smart!','success');
  navigate('dashboard');
}

function skipOnboarding(){
  clearOBElements();
  S('ob_done_'+(cu?.email||''),'true');
  toast('Tour skipped. Access it anytime from Account settings.','info');
}

function checkOnboarding(){
  if(!cu)return;
  const done=G('ob_done_'+cu.email);
  const users=G('sb_users')||{};
  const u=users[cu.email];
  const isNewUser=u&&(Date.now()-u.joined<120000); // Only if registered within last 2 mins
  if(!done&&isNewUser){setTimeout(startOnboarding,2000);}
  else if(!done){S('ob_done_'+cu.email,'true');} // Auto-mark done for existing users
}
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AVATAR CUSTOMIZER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let avState={type:'emoji',emoji:'üòé',color:AV_COLORS[0].value,initials:'',photo:''};

function openAvatarModal(){
  const saved = getAvatar(cu.email);
  avState = {...saved};
  if(!avState.color) avState.color = AV_COLORS[0].value;
  if(!avState.emoji) avState.emoji = 'üòé';
  if(!avState.photo) avState.photo = '';

  // Auto-initials from name
  const name = cu?.name||'';
  const autoIni = name.split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2);
  document.getElementById('avInitialsInp').value = avState.initials||autoIni;
  avState.initials = avState.initials||autoIni;

  // Build emoji grid
  document.getElementById('avEmojiGrid').innerHTML = AV_EMOJIS.map(e=>`
    <button class="av-emoji-btn${avState.emoji===e?' selected':''}" onclick="selectAvEmoji('${e}')">${e}</button>
  `).join('');

  // Build color rows (both tabs share same colour state)
  ['avColorRowEmoji','avColorRowInitials'].forEach(rowId=>{
    document.getElementById(rowId).innerHTML = AV_COLORS.map((c,i)=>`
      <div class="av-color-dot${avState.color===c.value?' selected':''}"
        style="background:${c.value}" title="${c.label}"
        data-color="${i}" data-row="${rowId}"
        onclick="selectAvColorByIndex(${i},this,'${rowId}')"></div>`).join('');
  });

  // Photo panel state
  _refreshPhotoPanel();

  // Open on the right tab
  const startTab = avState.type==='initials'?'initials':avState.type==='photo'?'photo':'emoji';
  switchAvTab(startTab);
  updateAvPreview();
  document.getElementById('avatarModal').classList.add('show');
}

function _refreshPhotoPanel(){
  const hasPhoto = !!(avState.photo);
  document.getElementById('avDropZone').style.display = hasPhoto?'none':'block';
  document.getElementById('avPhotoPreviewRow').style.display = hasPhoto?'block':'none';
  if(hasPhoto){
    document.getElementById('avPhotoThumb').innerHTML =
      `<img src="${avState.photo}" style="width:100%;height:100%;object-fit:cover"/>`;
    document.getElementById('avPhotoFileName').textContent = 'Photo uploaded ‚úì';
  }
}

/* Called when user picks a file */
function handleAvatarPhoto(input){
  const file = input.files[0];
  if(!file) return;
  if(file.size > 5*1024*1024){ toast('üì∏ Photo too large ‚Äî max 5 MB!','error'); return; }
  const reader = new FileReader();
  reader.onload = function(e){
    avState.photo = e.target.result;
    avState.type = 'photo';
    _refreshPhotoPanel();
    switchAvTab('photo');
    updateAvPreview();
    input.value = ''; // reset so same file can be picked again
  };
  reader.readAsDataURL(file);
}

/* Drag-and-drop support */
function handleAvatarDrop(e){
  const file = e.dataTransfer?.files?.[0];
  if(!file||!file.type.startsWith('image/')) return;
  const dt = new DataTransfer();
  dt.items.add(file);
  const inp = document.getElementById('avPhotoInput');
  try{ inp.files = dt.files; } catch(_){}
  handleAvatarPhoto(inp);
}

/* Remove photo and revert to emoji */
function clearAvatarPhoto(){
  avState.photo = '';
  avState.type = 'emoji';
  document.getElementById('avPhotoInput').value = '';
  _refreshPhotoPanel();
  switchAvTab('emoji');
  updateAvPreview();
}

function switchAvTab(tab){
  avState.type = tab;
  // Toggle tab buttons
  document.getElementById('avTabPhoto').classList.toggle('active', tab==='photo');
  document.getElementById('avTabEmoji').classList.toggle('active', tab==='emoji');
  document.getElementById('avTabInitials').classList.toggle('active', tab==='initials');
  // Show/hide panels
  document.getElementById('avPhotoPanel').style.display   = tab==='photo'    ? 'block':'none';
  document.getElementById('avEmojiPanel').style.display   = tab==='emoji'    ? 'block':'none';
  document.getElementById('avInitialsPanel').style.display= tab==='initials' ? 'block':'none';
  updateAvPreview();
}

function selectAvEmoji(emoji){
  avState.emoji = emoji;
  document.querySelectorAll('.av-emoji-btn').forEach(b=>{
    b.classList.toggle('selected', b.textContent===emoji);
  });
  updateAvPreview();
}

function updateAvPreview(){
  const prev = document.getElementById('avPreview');
  if(!prev) return;
  const name = cu?.name||'User';
  const autoIni = name.split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2);
  const ini = (document.getElementById('avInitialsInp')?.value||autoIni).toUpperCase().slice(0,2);
  avState.initials = ini;

  prev.innerHTML = '';
  prev.style.overflow = 'hidden';

  if(avState.type==='photo' && avState.photo){
    prev.style.background = 'transparent';
    prev.style.fontSize = '';
    prev.style.color = '';
    const img = document.createElement('img');
    img.src = avState.photo;
    img.style.cssText = 'width:100%;height:100%;object-fit:cover;display:block';
    prev.appendChild(img);
    prev.classList.remove('initials-mode');
  } else if(avState.type==='emoji'){
    prev.style.background = avState.color;
    prev.style.fontSize = '2.6rem';
    prev.style.color = '';
    prev.textContent = avState.emoji;
    prev.classList.remove('initials-mode');
  } else {
    prev.style.background = avState.color;
    prev.style.color = '#fff';
    prev.textContent = ini||autoIni;
    prev.classList.add('initials-mode');
  }
  document.getElementById('avPreviewName').textContent = name + ' ¬∑ Tap Save to apply';
}

function saveAvatarChanges(){
  const iniEl = document.getElementById('avInitialsInp');
  const ini = (iniEl?iniEl.value||'':'').toUpperCase().slice(0,2);
  avState.initials = ini || cu.name.split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2);
  avState.type   = avState.type||'emoji';
  avState.emoji  = avState.emoji||'üòé';
  avState.color  = avState.color||AV_COLORS[0].value;

  const toSave = {
    type:     avState.type,
    emoji:    avState.emoji,
    color:    avState.color,
    initials: avState.initials,
    photo:    avState.type==='photo' ? avState.photo : ''
  };
  saveAvatar(toSave);

  closeModal('avatarModal');

  // Immediate update ‚Äî no setTimeout needed anymore
  updateAllAvatars();
  refreshLeaderboardAvatars();

  toast('üé® Avatar updated!','success');
  addXP(5,'Avatar Customized');
  spawnConfetti();
}

function refreshLeaderboardAvatars(){
  if(document.getElementById('gamifyPage')?.classList.contains('active')) renderGamify();
  if(document.getElementById('friendsPage')?.classList.contains('active')) renderFriends();
}

function selectAvColorByIndex(idx, el, rowId){
  avState.color = AV_COLORS[idx].value;
  document.querySelectorAll(`#${rowId} .av-color-dot`).forEach(d=>d.classList.remove('selected'));
  el.classList.add('selected');
  // Sync the other colour row
  const other = rowId==='avColorRowEmoji'?'avColorRowInitials':'avColorRowEmoji';
  document.querySelectorAll(`#${other} .av-color-dot`)
    .forEach(d=>d.classList.toggle('selected', d.dataset.color===String(idx)));
  updateAvPreview();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STUDY GROUPS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let currentGroupId=null;
function getGroups(){return G('sb_groups')||[];}
function saveGroups(g){S('sb_groups',g);}
function getGroupMsgs(gid){return G(`grp_msgs_${gid}`)||[];}
function saveGroupMsgs(gid,msgs){S(`grp_msgs_${gid}`,msgs);}

function openCreateGroupModal(){
  document.getElementById('grpName').value='';
  document.getElementById('grpSubject').value='';
  document.getElementById('grpDesc').value='';
  if(cu?.dept)document.getElementById('grpDept').value=cu.dept||'OTHER';
  document.getElementById('createGroupModal').classList.add('show');
}
function createStudyGroup(){
  const name=document.getElementById('grpName').value.trim();
  const dept=document.getElementById('grpDept').value;
  const subject=document.getElementById('grpSubject').value.trim();
  const desc=document.getElementById('grpDesc').value.trim();
  if(!name)return toast('Group name is required','error');
  const groups=getGroups();
  const gid='grp_'+Date.now();
  const newGroup={id:gid,name,dept,subject,desc,creator:cu.email,members:[cu.email],created:Date.now(),msgCount:0};
  groups.push(newGroup);saveGroups(groups);
  closeModal('createGroupModal');
  toast('üè´ Group "'+name+'" created!','success');
  addXP(10,'Created Study Group');
  renderStudyGroups();
}
function joinGroup(gid){
  const groups=getGroups();
  const g=groups.find(x=>x.id===gid);
  if(!g)return;
  if(g.members.includes(cu.email)){toast('Already a member!','info');return;}
  g.members.push(cu.email);saveGroups(groups);
  toast('‚úÖ Joined "'+g.name+'"!','success');
  addXP(5,'Joined Study Group');
  renderStudyGroups();
}
function leaveGroup(gid){
  const groups=getGroups();
  const g=groups.find(x=>x.id===gid);
  if(!g)return;
  g.members=g.members.filter(m=>m!==cu.email);
  if(g.members.length===0){const idx=groups.findIndex(x=>x.id===gid);groups.splice(idx,1);}
  saveGroups(groups);toast('Left group.','info');renderStudyGroups();
}
function openGroupChat(gid){
  const groups=getGroups();
  const g=groups.find(x=>x.id===gid);
  if(!g)return;
  if(!g.members.includes(cu.email)){toast('Join group first to chat!','info');return;}
  currentGroupId=gid;
  document.getElementById('groupChatTitle').textContent=g.name;
  document.getElementById('groupChatSub').textContent=(DEPT_LABELS[g.dept]||g.dept)+(g.subject?' ¬∑ '+g.subject:'');
  renderGroupMessages();
  document.getElementById('groupChatModal').classList.add('show');
}
function renderGroupMessages(){
  if(!currentGroupId)return;
  const msgs=getGroupMsgs(currentGroupId);
  const el=document.getElementById('groupChatMessages');
  if(!msgs.length){el.innerHTML=`<div style="text-align:center;color:var(--tx4);font-size:.85rem;padding:20px">No messages yet. Start the conversation! üëã</div>`;return;}
  el.innerHTML=msgs.map(m=>{
    const isMe=m.from===cu.email;
    const initials=m.fromName?.split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2)||'?';
    return `<div style="display:flex;gap:10px;align-items:flex-start;${isMe?'flex-direction:row-reverse':''}">
      <div style="width:32px;height:32px;border-radius:9px;background:${isMe?'var(--acc)':'var(--surface3)'};display:flex;align-items:center;justify-content:center;font-weight:900;font-size:.75rem;color:${isMe?'#fff':'var(--tx2)'};flex-shrink:0">${initials}</div>
      <div style="max-width:75%">
        <div style="font-size:.7rem;font-weight:800;color:var(--tx3);margin-bottom:3px;${isMe?'text-align:right':''}">${isMe?'You':m.fromName} ¬∑ ${new Date(m.ts).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div>
        <div style="background:${isMe?'var(--acc)':'var(--surface)'};color:${isMe?'#fff':'var(--tx)'};padding:10px 14px;border-radius:${isMe?'14px 4px 14px 14px':'4px 14px 14px 14px'};font-size:.9rem;box-shadow:var(--shadow-xs)">${E(m.text)}</div>
      </div>
    </div>`;
  }).join('');
  el.scrollTop=el.scrollHeight;
}
function sendGroupMessage(){
  const inp=document.getElementById('groupChatInput');
  const text=inp.value.trim();
  if(!text||!currentGroupId)return;
  const msgs=getGroupMsgs(currentGroupId);
  msgs.push({from:cu.email,fromName:cu.name,text,ts:Date.now()});
  saveGroupMsgs(currentGroupId,msgs);
  // Update msgCount
  const groups=getGroups();
  const g=groups.find(x=>x.id===currentGroupId);
  if(g){g.msgCount=(g.msgCount||0)+1;saveGroups(groups);}
  inp.value='';
  renderGroupMessages();
}
function renderStudyGroups(){
  const groups=getGroups();
  const query=(document.getElementById('groupSearch')?.value||'').toLowerCase();
  const dept=cu?.dept||'OTHER';
  const deptLabel=DEPT_LABELS[dept]||'Your Department';
  document.getElementById('deptGroupSub').textContent='Groups for '+deptLabel;

  // Dept groups
  const deptGroups=groups.filter(g=>g.dept===dept);
  const deptEl=document.getElementById('deptGroupsList');
  if(deptGroups.length){
    deptEl.innerHTML=deptGroups.map(g=>renderGroupCard(g,true)).join('');
  } else {
    deptEl.innerHTML=`<div style="color:var(--tx3);font-size:.9rem;padding:10px 0">No groups for your department yet. <a href="#" onclick="openCreateGroupModal();return false" style="color:var(--acc);font-weight:800">Create one!</a></div>`;
  }

  // All groups
  const allEl=document.getElementById('allGroupsList');
  const filtered=groups.filter(g=>!query||(g.name+g.subject+g.desc).toLowerCase().includes(query));
  allEl.innerHTML=filtered.length?filtered.map(g=>renderGroupCard(g,false)).join(''):`<div style="color:var(--tx3);font-size:.9rem;padding:14px 0">No groups found.</div>`;

  // My groups
  const mine=groups.filter(g=>g.members.includes(cu.email));
  const myEl=document.getElementById('myGroupsList');
  myEl.innerHTML=mine.length?mine.map(g=>renderGroupCard(g,false)).join(''):`<div style="color:var(--tx3);font-size:.9rem;padding:14px 0">You haven't joined any groups yet.</div>`;

  // Pre-populate some demo groups if empty
  if(!groups.length){
    const demos=[
      {id:'grp_demo1',name:'AI & DS Study Circle',dept:'AI_DS',subject:'Machine Learning & Deep Learning',desc:'Weekly study sessions, quiz prep, and project collaboration for AI&DS students.',creator:'demo@college.edu',members:['demo@college.edu'],created:Date.now()-86400000*3,msgCount:12},
      {id:'grp_demo2',name:'CSE Algorithm Busters',dept:'CSE',subject:'Data Structures & Algorithms',desc:'Daily DSA problem solving and interview prep. Everyone welcome!',creator:'demo2@college.edu',members:['demo2@college.edu'],created:Date.now()-86400000*5,msgCount:34},
      {id:'grp_demo3',name:'ECE Signal Processing Hub',dept:'ECE',subject:'Signals, Systems & Digital Electronics',desc:'Doubt clearing, lab help, and exam prep for ECE students.',creator:'demo3@college.edu',members:['demo3@college.edu'],created:Date.now()-86400000*2,msgCount:8},
      {id:'grp_demo4',name:'MBA Finance Warriors',dept:'MBA',subject:'Financial Management & Marketing',desc:'Case study discussions, mock presentations, and exam strategies.',creator:'demo4@college.edu',members:['demo4@college.edu'],created:Date.now()-86400000*7,msgCount:21},
      {id:'grp_demo5',name:'Mech Thermo Study Group',dept:'MECH',subject:'Thermodynamics & Fluid Mechanics',desc:'Solving numericals, sharing notes, and exam prep together.',creator:'demo5@college.edu',members:['demo5@college.edu'],created:Date.now()-86400000*1,msgCount:5},
    ];
    saveGroups(demos);renderStudyGroups();
  }
}
function renderGroupCard(g,compact){
  const isMember=g.members.includes(cu.email);
  const msgs=getGroupMsgs(g.id);
  const deptLbl=DEPT_LABELS[g.dept]||g.dept;
  return `<div style="background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r);padding:18px;transition:all .2s" onmouseover="this.style.borderColor='var(--acc)'" onmouseout="this.style.borderColor='var(--border)'">
    <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:10px;margin-bottom:10px">
      <div>
        <div style="font-weight:800;font-size:.97rem;color:var(--tx)">${E(g.name)}</div>
        <div style="font-size:.76rem;color:var(--acc);font-weight:700;margin-top:3px">${deptLbl}${g.subject?' ¬∑ '+E(g.subject):''}</div>
      </div>
      ${isMember?`<span style="font-size:.7rem;font-weight:800;color:var(--green);background:var(--green-bg);padding:3px 9px;border-radius:20px">‚úì Joined</span>`:`<span style="font-size:.7rem;font-weight:800;color:var(--tx3);background:var(--surface2);padding:3px 9px;border-radius:20px">${g.members.length} members</span>`}
    </div>
    ${g.desc?`<div style="font-size:.83rem;color:var(--tx3);margin-bottom:12px;line-height:1.5">${E(g.desc)}</div>`:''}
    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <span style="font-size:.73rem;color:var(--tx4)">üí¨ ${msgs.length} messages ¬∑ üë• ${g.members.length} members</span>
      <div style="flex:1"></div>
      ${isMember?`<button class="btn btn-sm btn-p" onclick="openGroupChat('${g.id}')">üí¨ Chat</button><button class="btn btn-sm btn-g" onclick="leaveGroup('${g.id}')">Leave</button>`:`<button class="btn btn-sm btn-p" onclick="joinGroup('${g.id}')">+ Join</button>`}
    </div>
  </div>`;
}
</script>
</body>
</html>