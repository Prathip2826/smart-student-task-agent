<!DOCTYPE html>
<html lang="en" data-theme="midnight" data-font="grotesk">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>StudyBot | AI-Powered Study Task Manager</title>
<meta name="description" content="StudyBot - AI-powered smart study task management system for students"/>
<meta name="theme-color" content="#5b6ef5"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="apple-mobile-web-app-title" content="StudyBot"/>
<link rel="manifest" href="#" id="manifestLink"/>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cabinet+Grotesk:wght@300;400;500;700;800;900&family=Syne:wght@400;600;700;800&family=DM+Mono:wght@400;500&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Unbounded:wght@300;400;600;700&family=Inter:wght@300;400;600;700&family=Poppins:wght@300;400;600;700&family=Outfit:wght@300;400;600;700;800&family=Plus+Jakarta+Sans:wght@300;400;600;700;800&family=Lexend:wght@300;400;600;700&family=Nunito:wght@300;400;700;800&family=Raleway:wght@300;400;700;800&family=Quicksand:wght@300;400;600;700&family=Fredoka:wght@300;400;600;700&family=Comfortaa:wght@300;400;700&family=Orbitron:wght@400;600;700&family=Bebas+Neue&family=Montserrat:wght@300;400;700;800&family=Josefin+Sans:wght@300;400;700&family=Lora:ital,wght@0,400;0,700;1,400&family=Cinzel:wght@400;600;700&family=Russo+One&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
/* â”€â”€â”€ RESET â”€â”€â”€ */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth;font-size:16px}

/* â”€â”€â”€ THEME SYSTEM â”€â”€â”€ */
:root,[data-theme="midnight"]{
  --bg:#0d0f14;--bg2:#141720;--bg3:#1c2030;--bg4:#252a3a;
  --tx:#f0f2f8;--tx2:#b8bdd4;--tx3:#6b7298;--tx4:#3d4366;
  --acc:#5b6ef5;--acc2:#7b8ef7;--acc3:#a5b0fb;
  --acc-r:#f55b5b;--acc-g:#5bf5a0;--acc-y:#f5c45b;--acc-p:#c45bf5;
  --card:#1c2030;--border:#252a3a;--shadow:0 4px 24px rgba(0,0,0,.5);
  --font:'Cabinet Grotesk',sans-serif;--font-head:'Syne',sans-serif;--font-mono:'DM Mono',monospace;
  --radius:12px;--radius-sm:8px;--radius-lg:18px;
}
[data-theme="light"]{--bg:#f6f8fc;--bg2:#eef1f8;--bg3:#fff;--bg4:#e6eaf5;--tx:#1a1f36;--tx2:#3a4060;--tx3:#6b7298;--tx4:#9aa1c6;--acc:#4f63ff;--acc2:#6c7cff;--acc3:#aab4ff;--acc-r:#ff5b5b;--acc-g:#22c55e;--acc-y:#f59e0b;--acc-p:#a855f7;--card:#fff;--border:#e2e6f2;--shadow:0 8px 30px rgba(60,72,100,.08)}
[data-theme="aurora"]{--bg:#080e1a;--bg2:#0d1525;--bg3:#111d32;--bg4:#1a2a45;--tx:#e8f4ff;--tx2:#9ec8f0;--tx3:#4d7aaa;--tx4:#2d4d70;--acc:#00d4ff;--acc2:#33deff;--acc3:#80ebff;--acc-r:#ff6b6b;--acc-g:#51fa8a;--acc-y:#ffd166;--acc-p:#c77dff;--card:#0d1525;--border:#1a2a45;--shadow:0 4px 24px rgba(0,10,40,.6)}
[data-theme="solar"]{--bg:#0f0a00;--bg2:#1a1200;--bg3:#241a00;--bg4:#302400;--tx:#fff8e8;--tx2:#d4b86a;--tx3:#8a6a20;--tx4:#4a3a10;--acc:#f5a623;--acc2:#f7b84a;--acc3:#f9ce80;--acc-r:#f55b5b;--acc-g:#5bf5a0;--acc-y:#f5e45b;--acc-p:#c45bf5;--card:#1a1200;--border:#302400;--shadow:0 4px 24px rgba(30,15,0,.6)}
[data-theme="paper"]{--bg:#f5f0e8;--bg2:#ede7db;--bg3:#e4ddd1;--bg4:#d8d0c2;--tx:#1a1610;--tx2:#3d3628;--tx3:#7a6f58;--tx4:#b0a890;--acc:#2d5016;--acc2:#4a7a28;--acc3:#6fa040;--acc-r:#b52020;--acc-g:#206020;--acc-y:#b08020;--acc-p:#602080;--card:#ede7db;--border:#d8d0c2;--shadow:0 4px 24px rgba(0,0,0,.12)}
[data-theme="rose"]{--bg:#0f080e;--bg2:#1a0f18;--bg3:#251524;--bg4:#321c30;--tx:#ffe8f8;--tx2:#d4a8c8;--tx3:#8a5878;--tx4:#4a2840;--acc:#f56ab0;--acc2:#f78ec0;--acc3:#fab8d8;--acc-r:#f55b5b;--acc-g:#5bf5a0;--acc-y:#f5c45b;--acc-p:#c45bf5;--card:#1a0f18;--border:#321c30;--shadow:0 4px 24px rgba(30,5,25,.6)}
[data-theme="slate"]{--bg:#0a0c10;--bg2:#10131a;--bg3:#161b26;--bg4:#1d2336;--tx:#dde8f8;--tx2:#8a9dc0;--tx3:#455880;--tx4:#243048;--acc:#42a5f5;--acc2:#64b5f6;--acc3:#90caf9;--acc-r:#ef5350;--acc-g:#66bb6a;--acc-y:#ffa726;--acc-p:#ab47bc;--card:#10131a;--border:#1d2336;--shadow:0 4px 24px rgba(0,0,0,.5)}
[data-theme="copper"]{--bg:#0f0800;--bg2:#1a1000;--bg3:#241800;--bg4:#302200;--tx:#ffe8cc;--tx2:#d4924a;--tx3:#8a5a20;--tx4:#4a3010;--acc:#b87333;--acc2:#d4924a;--acc3:#e8b878;--acc-r:#e84030;--acc-g:#40c060;--acc-y:#d4a020;--acc-p:#9040d0;--card:#1a1000;--border:#3a2810;--shadow:0 8px 32px rgba(80,40,0,.5)}
[data-theme="sky"]{--bg:#f0f7ff;--bg2:#e0efff;--bg3:#fff;--bg4:#cce3ff;--tx:#0a2540;--tx2:#1e4080;--tx3:#4a7ab5;--tx4:#90b8e0;--acc:#0066ff;--acc2:#3388ff;--acc3:#99c4ff;--acc-r:#ff3b3b;--acc-g:#00c96e;--acc-y:#ffaa00;--acc-p:#8855ff;--card:#fff;--border:#bcd8f8;--shadow:0 8px 32px rgba(0,80,200,.1)}
[data-theme="mint"]{--bg:#f0fff8;--bg2:#e0fff2;--bg3:#fff;--bg4:#b8f5dc;--tx:#042a18;--tx2:#0f5c38;--tx3:#3a9e6a;--tx4:#80cfaa;--acc:#00b86e;--acc2:#00d47e;--acc3:#80e8be;--acc-r:#f53b3b;--acc-g:#00b86e;--acc-y:#e8a800;--acc-p:#9055f5;--card:#fff;--border:#a8eece;--shadow:0 8px 32px rgba(0,140,80,.1)}
[data-theme="peach"]{--bg:#fff8f0;--bg2:#fff0e0;--bg3:#fff;--bg4:#ffd8b0;--tx:#2a1200;--tx2:#6b3010;--tx3:#b06030;--tx4:#d8a078;--acc:#ff7020;--acc2:#ff8c40;--acc3:#ffbe90;--acc-r:#e83030;--acc-g:#28b84a;--acc-y:#f5a800;--acc-p:#9030d0;--card:#fff;--border:#f5c898;--shadow:0 8px 32px rgba(200,80,0,.1)}
[data-theme="lavender"]{--bg:#f8f0ff;--bg2:#f0e4ff;--bg3:#fff;--bg4:#ddc4ff;--tx:#1a0835;--tx2:#4a1880;--tx3:#8850c0;--tx4:#bb98e8;--acc:#8020ff;--acc2:#a040ff;--acc3:#cc90ff;--acc-r:#f53b5a;--acc-g:#20c070;--acc-y:#f0a800;--acc-p:#8020ff;--card:#fff;--border:#ccaaff;--shadow:0 8px 32px rgba(100,0,220,.1)}
[data-theme="lemon"]{--bg:#fffef0;--bg2:#fffce0;--bg3:#fff;--bg4:#fff5a8;--tx:#1a1800;--tx2:#4a4400;--tx3:#8a8020;--tx4:#c0b840;--acc:#c8a800;--acc2:#e8c800;--acc3:#f8e860;--acc-r:#e83030;--acc-g:#28b050;--acc-y:#c8a800;--acc-p:#8030c8;--card:#fff;--border:#f0e060;--shadow:0 8px 32px rgba(160,130,0,.1)}
[data-theme="blush"]{--bg:#fff0f5;--bg2:#ffe4ef;--bg3:#fff;--bg4:#ffc0d8;--tx:#2a0818;--tx2:#7a1840;--tx3:#c04878;--tx4:#e090b0;--acc:#e8006a;--acc2:#ff2080;--acc3:#ff80b8;--acc-r:#e8003a;--acc-g:#20b860;--acc-y:#f5a800;--acc-p:#9020e8;--card:#fff;--border:#f5a0c8;--shadow:0 8px 32px rgba(220,0,100,.1)}
[data-theme="cloud"]{--bg:#f5f7fa;--bg2:#ebeef5;--bg3:#fff;--bg4:#d8ddf0;--tx:#10152a;--tx2:#303868;--tx3:#6068a8;--tx4:#a0a8d8;--acc:#4455ee;--acc2:#6670f8;--acc3:#a8b0ff;--acc-r:#ee3344;--acc-g:#20c068;--acc-y:#f8a820;--acc-p:#9930ee;--card:#fff;--border:#c8ccee;--shadow:0 8px 32px rgba(40,60,180,.08)}
/* â”€â”€ VIVID NEW THEMES â”€â”€ */
[data-theme="crimson"]{--bg:#0a0000;--bg2:#160000;--bg3:#220000;--bg4:#300505;--tx:#ffe8e8;--tx2:#ff9999;--tx3:#cc4444;--tx4:#882222;--acc:#ff2020;--acc2:#ff4444;--acc3:#ff8888;--acc-r:#ff2020;--acc-g:#20ff88;--acc-y:#ffcc00;--acc-p:#ff20cc;--card:#160000;--border:#400808;--shadow:0 8px 32px rgba(200,0,0,.5)}
[data-theme="emerald"]{--bg:#000f08;--bg2:#001a0f;--bg3:#002515;--bg4:#003520;--tx:#e8fff4;--tx2:#88ffbb;--tx3:#20cc66;--tx4:#108840;--acc:#00e866;--acc2:#00ff77;--acc3:#66ffaa;--acc-r:#ff3355;--acc-g:#00e866;--acc-y:#ffee00;--acc-p:#cc00ff;--card:#001a0f;--border:#004020;--shadow:0 8px 32px rgba(0,180,80,.4)}
[data-theme="ocean"]{--bg:#000a14;--bg2:#001525;--bg3:#002035;--bg4:#003050;--tx:#e8f8ff;--tx2:#80ccff;--tx3:#2088cc;--tx4:#105588;--acc:#0099ff;--acc2:#33aaff;--acc3:#88ccff;--acc-r:#ff4433;--acc-g:#00ffaa;--acc-y:#ffcc00;--acc-p:#aa44ff;--card:#001525;--border:#004070;--shadow:0 8px 32px rgba(0,100,200,.5)}
[data-theme="violet"]{--bg:#080010;--bg2:#100020;--bg3:#180030;--bg4:#250050;--tx:#f0e8ff;--tx2:#cc99ff;--tx3:#8844cc;--tx4:#552288;--acc:#9933ff;--acc2:#aa55ff;--acc3:#cc88ff;--acc-r:#ff3366;--acc-g:#33ff99;--acc-y:#ffcc33;--acc-p:#9933ff;--card:#100020;--border:#380068;--shadow:0 8px 32px rgba(120,0,220,.5)}
[data-theme="amber"]{--bg:#0f0800;--bg2:#1c1000;--bg3:#2a1800;--bg4:#3a2200;--tx:#fff8e0;--tx2:#ffd060;--tx3:#cc8800;--tx4:#885500;--acc:#ffaa00;--acc2:#ffbb22;--acc3:#ffdd88;--acc-r:#ff3322;--acc-g:#44dd88;--acc-y:#ffaa00;--acc-p:#cc44ff;--card:#1c1000;--border:#4a3000;--shadow:0 8px 32px rgba(200,120,0,.4)}
[data-theme="neon"]{--bg:#000000;--bg2:#050505;--bg3:#0a0a0a;--bg4:#111111;--tx:#ffffff;--tx2:#ccffee;--tx3:#44ffaa;--tx4:#228866;--acc:#00ffaa;--acc2:#33ffbb;--acc3:#88ffdd;--acc-r:#ff0055;--acc-g:#00ffaa;--acc-y:#ffff00;--acc-p:#ff00ff;--card:#080808;--border:#1a1a1a;--shadow:0 0 20px rgba(0,255,170,.2)}
[data-theme="fire"]{--bg:#0a0300;--bg2:#150500;--bg3:#220800;--bg4:#300a00;--tx:#fff5e8;--tx2:#ffaa55;--tx3:#cc5500;--tx4:#882200;--acc:#ff6600;--acc2:#ff8822;--acc3:#ffbb66;--acc-r:#ff2200;--acc-g:#88ff44;--acc-y:#ffdd00;--acc-p:#ff44cc;--card:#150500;--border:#401000;--shadow:0 8px 32px rgba(200,60,0,.5)}

/* â”€â”€â”€ FONT THEMES â”€â”€â”€ */
[data-font="grotesk"]{--font:'Cabinet Grotesk',sans-serif;--font-head:'Syne',sans-serif}
[data-font="playfair"]{--font:'Playfair Display',serif;--font-head:'Playfair Display',serif}
[data-font="unbounded"]{--font:'Unbounded',sans-serif;--font-head:'Unbounded',sans-serif;font-size:13px}
[data-font="mono"]{--font:'DM Mono',monospace;--font-head:'DM Mono',monospace}
[data-font="inter"]{--font:'Inter',sans-serif;--font-head:'Inter',sans-serif}
[data-font="poppins"]{--font:'Poppins',sans-serif;--font-head:'Poppins',sans-serif}
[data-font="outfit"]{--font:'Outfit',sans-serif;--font-head:'Outfit',sans-serif}
[data-font="jakarta"]{--font:'Plus Jakarta Sans',sans-serif;--font-head:'Plus Jakarta Sans',sans-serif}
[data-font="lexend"]{--font:'Lexend',sans-serif;--font-head:'Lexend',sans-serif}
[data-font="nunito"]{--font:'Nunito',sans-serif;--font-head:'Nunito',sans-serif}
[data-font="raleway"]{--font:'Raleway',sans-serif;--font-head:'Raleway',sans-serif}
[data-font="quicksand"]{--font:'Quicksand',sans-serif;--font-head:'Quicksand',sans-serif}
[data-font="fredoka"]{--font:'Fredoka',sans-serif;--font-head:'Fredoka',sans-serif}
[data-font="comfortaa"]{--font:'Comfortaa',sans-serif;--font-head:'Comfortaa',sans-serif}
[data-font="orbitron"]{--font:'Orbitron',sans-serif;--font-head:'Orbitron',sans-serif}
[data-font="bebas"]{--font:'Bebas Neue',sans-serif;--font-head:'Bebas Neue',sans-serif}
[data-font="montserrat"]{--font:'Montserrat',sans-serif;--font-head:'Montserrat',sans-serif}
[data-font="josefin"]{--font:'Josefin Sans',sans-serif;--font-head:'Josefin Sans',sans-serif}
[data-font="lora"]{--font:'Lora',serif;--font-head:'Lora',serif}
[data-font="cinzel"]{--font:'Cinzel',serif;--font-head:'Cinzel',serif}
[data-font="russo"]{--font:'Russo One',sans-serif;--font-head:'Russo One',sans-serif}

/* â”€â”€â”€ BASE â”€â”€â”€ */
body{background:var(--bg);color:var(--tx);font-family:var(--font);line-height:1.6;-webkit-font-smoothing:antialiased;min-height:100vh;overflow-x:hidden}
button{cursor:pointer;font-family:var(--font)}
input,textarea,select{font-family:var(--font)}
a{color:var(--acc);text-decoration:none}
code{font-family:var(--font-mono);font-size:.85em;background:var(--bg4);padding:2px 6px;border-radius:4px}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

/* â”€â”€â”€ ANIMATIONS â”€â”€â”€ */
@keyframes fadeIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
@keyframes pageIn{from{opacity:0;transform:translateX(-8px)}to{opacity:1;transform:translateX(0)}}
@keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-5px)}}
@keyframes toastIn{from{transform:translateX(120%);opacity:0}to{transform:translateX(0);opacity:1}}
@keyframes toastOut{from{opacity:1}to{transform:translateX(120%);opacity:0}}
@keyframes dot{0%,80%,100%{transform:scale(.6);opacity:.4}40%{transform:scale(1);opacity:1}}
@keyframes heatIn{from{opacity:0;transform:scale(.8)}to{opacity:1;transform:scale(1)}}
@keyframes popIn{from{opacity:0;transform:scale(.88)}to{opacity:1;transform:scale(1)}}
@keyframes pomoPulse{0%,100%{box-shadow:0 0 0 0 rgba(91,110,245,.4)}70%{box-shadow:0 0 0 16px rgba(91,110,245,0)}}
@keyframes pomoBreak{0%,100%{box-shadow:0 0 0 0 rgba(91,245,160,.4)}70%{box-shadow:0 0 0 16px rgba(91,245,160,0)}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes calPulse{0%{transform:scale(1)}50%{transform:scale(1.05)}100%{transform:scale(1)}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LANDING PAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#landingPage{animation:fadeIn .5s ease}
.landing-header{display:flex;align-items:center;justify-content:space-between;padding:20px 48px;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:50;background:rgba(13,15,20,.85);backdrop-filter:blur(12px)}
.landing-logo{font-family:var(--font-head);font-size:1.4rem;font-weight:800;color:var(--tx);display:flex;align-items:center;gap:8px}
.logo-dot{width:10px;height:10px;border-radius:50%;background:var(--acc);display:inline-block;animation:bounce 2s infinite}
.landing-nav{display:flex;align-items:center;gap:28px}
.landing-nav a{font-size:.875rem;font-weight:500;color:var(--tx2);transition:color .2s}
.landing-nav a:hover{color:var(--tx)}
.landing-nav .btn-cta{background:var(--acc);color:#fff;padding:9px 22px;border-radius:100px;font-weight:700;font-size:.875rem;transition:all .2s;border:none}
.landing-nav .btn-cta:hover{opacity:.88;transform:translateY(-1px)}
.hero{padding:100px 48px 80px;text-align:center;position:relative;overflow:hidden}
.hero::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse 60% 50% at 50% 0%,rgba(91,110,245,.15) 0%,transparent 70%);pointer-events:none}
.hero-badge{display:inline-flex;align-items:center;gap:6px;padding:6px 16px;border-radius:100px;border:1px solid var(--border);font-size:.75rem;font-weight:600;color:var(--tx3);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:28px;background:var(--bg2)}
.hero-title{font-family:var(--font-head);font-size:clamp(2.8rem,6vw,5rem);font-weight:800;line-height:1.05;letter-spacing:-2px;margin-bottom:24px;color:var(--tx)}
.hero-title span{color:var(--acc)}
.hero-sub{font-size:1.1rem;color:var(--tx2);max-width:560px;margin:0 auto 44px;line-height:1.7}
.hero-btns{display:flex;gap:14px;justify-content:center;flex-wrap:wrap}
.btn-hero{padding:14px 32px;border-radius:100px;font-size:1rem;font-weight:700;border:none;transition:all .2s;cursor:pointer;font-family:var(--font)}
.btn-hero.primary{background:var(--acc);color:#fff}
.btn-hero.primary:hover{opacity:.88;transform:translateY(-2px);box-shadow:0 8px 24px rgba(91,110,245,.35)}
.btn-hero.secondary{background:var(--bg3);color:var(--tx);border:1px solid var(--border)}
.btn-hero.secondary:hover{background:var(--bg4)}
.features{padding:80px 48px;display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:20px;max-width:1100px;margin:0 auto}
.feature-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius-lg);padding:28px;transition:all .25s}
.feature-card:hover{border-color:var(--acc);transform:translateY(-3px);box-shadow:var(--shadow)}
.feature-icon{font-size:2rem;margin-bottom:14px}
.feature-title{font-family:var(--font-head);font-size:1.1rem;font-weight:700;margin-bottom:8px}
.feature-desc{font-size:.875rem;color:var(--tx2);line-height:1.6}
.landing-cta-sec{text-align:center;padding:60px 48px 80px}
.landing-cta-sec h2{font-family:var(--font-head);font-size:2.2rem;font-weight:800;margin-bottom:16px}
.landing-cta-sec p{color:var(--tx2);margin-bottom:32px;font-size:1rem}
.landing-footer{border-top:1px solid var(--border);padding:24px 48px;display:flex;align-items:center;justify-content:space-between;font-size:.8rem;color:var(--tx3)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUTH PAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#authPage{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px;background:var(--bg);animation:fadeIn .4s ease}
.auth-box{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius-lg);padding:44px 40px;width:100%;max-width:420px;box-shadow:var(--shadow)}
.auth-logo{font-family:var(--font-head);font-size:1.5rem;font-weight:800;text-align:center;margin-bottom:8px}
.auth-sub{text-align:center;color:var(--tx3);font-size:.875rem;margin-bottom:28px}
.auth-tabs{display:flex;gap:4px;background:var(--bg3);border-radius:var(--radius-sm);padding:4px;margin-bottom:28px}
.auth-tab{flex:1;padding:9px;border-radius:6px;border:none;background:transparent;color:var(--tx3);font-weight:600;font-size:.875rem;cursor:pointer;transition:all .2s;font-family:var(--font)}
.auth-tab.active{background:var(--acc);color:#fff}
.form-group{margin-bottom:16px}
.form-group label{display:block;font-size:.8rem;font-weight:600;color:var(--tx2);margin-bottom:6px;letter-spacing:.3px}
.form-input{width:100%;padding:11px 14px;background:var(--bg3);border:1.5px solid var(--border);border-radius:var(--radius-sm);color:var(--tx);font-size:.9rem;transition:all .2s;outline:none;font-family:var(--font)}
.form-input:focus{border-color:var(--acc);background:var(--bg4);box-shadow:0 0 0 3px rgba(91,110,245,.12)}
.form-input::placeholder{color:var(--tx4)}
.form-error{font-size:.75rem;color:var(--acc-r);margin-top:4px;display:none}
.btn-submit{width:100%;padding:12px;background:var(--acc);color:#fff;border:none;border-radius:var(--radius-sm);font-weight:700;font-size:.95rem;cursor:pointer;transition:all .2s;margin-top:4px;font-family:var(--font)}
.btn-submit:hover{opacity:.88}
.quick-logins{margin-top:20px}
.ql-label{font-size:.72rem;color:var(--tx3);text-align:center;margin-bottom:8px;text-transform:uppercase;letter-spacing:1px}
.ql-chips{display:flex;flex-wrap:wrap;gap:6px;justify-content:center}
.ql-chip{padding:5px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:100px;font-size:.78rem;color:var(--tx2);cursor:pointer;transition:all .2s}
.ql-chip:hover{border-color:var(--acc);color:var(--acc)}
.back-to-landing{text-align:center;margin-top:20px;font-size:.8rem;color:var(--tx3)}
.back-to-landing a{color:var(--acc2)}
.secure-badge{display:flex;align-items:center;justify-content:center;gap:6px;margin-top:12px;font-size:.72rem;color:var(--tx4)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   APP SHELL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#mainApp{display:none;grid-template-columns:248px 1fr 0px;height:100vh;overflow:hidden}
#mainApp.app-visible{display:grid}
#mainApp.ai-open{grid-template-columns:248px 1fr 340px}

/* â”€â”€â”€ SIDEBAR â”€â”€â”€ */
.sidebar{background:var(--bg2);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;transition:all .3s;z-index:30}
.sidebar-top{padding:20px 16px 12px;border-bottom:1px solid var(--border);flex-shrink:0}
.sidebar-logo{font-family:var(--font-head);font-size:1.25rem;font-weight:800;display:flex;align-items:center;gap:8px;padding:4px 0 12px}
.nav-section{padding:10px 0}
.nav-label{font-size:.65rem;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--tx4);padding:0 12px 6px}
.nav-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:var(--radius-sm);color:var(--tx2);font-size:.875rem;font-weight:500;cursor:pointer;transition:all .15s;border:none;background:transparent;width:100%;text-align:left;font-family:var(--font)}
.nav-item:hover{background:var(--bg3);color:var(--tx)}
.nav-item.active{background:linear-gradient(135deg,rgba(91,110,245,.2),rgba(91,110,245,.08));color:var(--acc);font-weight:700;border-left:2px solid var(--acc)}
.nav-item .nav-icon{font-size:1.05rem;width:20px;text-align:center;flex-shrink:0}
.sidebar-bottom{padding:12px 16px;border-top:1px solid var(--border);margin-top:auto;flex-shrink:0}
.user-chip{display:flex;align-items:center;gap:10px;padding:10px;border-radius:var(--radius-sm);background:var(--bg3);cursor:pointer;transition:all .2s}
.user-chip:hover{background:var(--bg4)}
.user-av{width:34px;height:34px;border-radius:50%;background:var(--acc);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:.85rem;color:#fff;flex-shrink:0}
.user-info{flex:1;min-width:0}
.user-name{font-weight:700;font-size:.85rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.user-email{font-size:.72rem;color:var(--tx3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.logout-btn{padding:3px 8px;border-radius:5px;background:transparent;border:1px solid var(--border);color:var(--tx3);font-size:.72rem;cursor:pointer;font-family:var(--font)}
.logout-btn:hover{border-color:var(--acc-r);color:var(--acc-r)}

/* â”€â”€â”€ HEADER â”€â”€â”€ */
.app-header{background:var(--bg2);border-bottom:1px solid var(--border);padding:0 24px;display:flex;align-items:center;gap:12px;height:60px;flex-shrink:0}
.header-hamburger{width:36px;height:36px;border-radius:var(--radius-sm);background:transparent;border:1px solid var(--border);color:var(--tx2);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:1.1rem;transition:all .2s}
.header-hamburger:hover{background:var(--bg3);color:var(--tx)}
.header-title{font-family:var(--font-head);font-weight:800;font-size:1.15rem;flex:1}
.header-actions{display:flex;align-items:center;gap:8px}
.h-btn{width:36px;height:36px;border-radius:var(--radius-sm);background:transparent;border:1px solid var(--border);color:var(--tx2);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:1rem;transition:all .2s;position:relative;font-family:var(--font)}
.h-btn:hover{background:var(--bg3);color:var(--tx)}
.notif-badge{position:absolute;top:-3px;right:-3px;width:16px;height:16px;background:var(--acc-r);border-radius:50%;font-size:.6rem;font-weight:700;display:none;align-items:center;justify-content:center;color:#fff}
.notif-badge.show{display:flex}
.ai-toggle-btn{padding:0 16px;height:36px;border-radius:100px;background:linear-gradient(135deg,var(--acc),var(--acc-p));color:#fff;border:none;font-weight:700;font-size:.8rem;cursor:pointer;display:flex;align-items:center;gap:6px;font-family:var(--font);transition:all .2s}
.ai-toggle-btn:hover{opacity:.88}

/* â”€â”€â”€ MAIN CONTENT â”€â”€â”€ */
.app-main{display:flex;flex-direction:column;overflow:hidden;min-width:0}
.content-area{flex:1;overflow-y:auto;padding:28px;animation:pageIn .25s ease}
.page{display:none}
.page.active{display:block;animation:pageIn .25s ease}

/* â”€â”€â”€ UTILITIES â”€â”€â”€ */
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:20px;transition:all .2s}
.card:hover{border-color:var(--bg4)}
.section-title{font-family:var(--font-head);font-size:1.4rem;font-weight:800;margin-bottom:6px}
.section-sub{color:var(--tx3);font-size:.875rem;margin-bottom:24px}
.pill{padding:3px 10px;border-radius:100px;font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px}
.pill-high{background:rgba(245,91,91,.12);color:var(--acc-r);border:1px solid rgba(245,91,91,.2)}
.pill-medium{background:rgba(245,196,91,.12);color:var(--acc-y);border:1px solid rgba(245,196,91,.2)}
.pill-low{background:rgba(91,245,160,.12);color:var(--acc-g);border:1px solid rgba(91,245,160,.2)}
.pill-pending{background:rgba(107,114,152,.15);color:var(--tx3);border:1px solid var(--border)}
.pill-in-progress{background:rgba(91,110,245,.15);color:var(--acc);border:1px solid rgba(91,110,245,.2)}
.pill-completed{background:rgba(91,245,160,.12);color:var(--acc-g);border:1px solid rgba(91,245,160,.2)}
.pill-overdue{background:rgba(245,91,91,.12);color:var(--acc-r);border:1px solid rgba(245,91,91,.2)}
.btn{padding:8px 18px;border-radius:var(--radius-sm);font-weight:600;font-size:.85rem;border:none;cursor:pointer;transition:all .2s;font-family:var(--font);display:inline-flex;align-items:center;gap:6px}
.btn-primary{background:var(--acc);color:#fff}
.btn-primary:hover{opacity:.88;transform:translateY(-1px)}
.btn-ghost{background:transparent;color:var(--tx2);border:1px solid var(--border)}
.btn-ghost:hover{background:var(--bg3);color:var(--tx)}
.btn-danger{background:transparent;color:var(--acc-r);border:1px solid rgba(245,91,91,.3)}
.btn-danger:hover{background:rgba(245,91,91,.1)}
.btn-success{background:var(--acc-g);color:#000}
.empty-state{text-align:center;padding:60px 20px;color:var(--tx3)}
.empty-state .es-icon{font-size:3rem;margin-bottom:14px}
.empty-state .es-title{font-weight:700;font-size:1rem;margin-bottom:6px;color:var(--tx2)}
.empty-state .es-sub{font-size:.875rem}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DASHBOARD PAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.greeting{margin-bottom:24px;display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:12px}
.greeting-left h2{font-family:var(--font-head);font-size:1.8rem;font-weight:800;margin-bottom:4px}
.greeting-left .greeting-sub{color:var(--tx3);font-size:.9rem}
.greeting-right{display:flex;gap:8px;align-items:center}
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(145px,1fr));gap:12px;margin-bottom:20px}
.kpi-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;position:relative;overflow:hidden;transition:all .2s;cursor:default}
.kpi-card:hover{border-color:var(--acc);transform:translateY(-2px);box-shadow:var(--shadow)}
.kpi-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
.kpi-card.k-total::before{background:var(--acc)}
.kpi-card.k-done::before{background:var(--acc-g)}
.kpi-card.k-pending::before{background:var(--acc-y)}
.kpi-card.k-progress::before{background:var(--acc-p)}
.kpi-card.k-high::before,.kpi-card.k-overdue::before{background:var(--acc-r)}
.kpi-icon{font-size:1.3rem;margin-bottom:6px}
.kpi-val{font-family:var(--font-head);font-size:1.9rem;font-weight:800;line-height:1}
.kpi-label{font-size:.72rem;color:var(--tx3);margin-top:4px;font-weight:600}
.dash-grid{display:grid;grid-template-columns:1fr 300px;gap:20px;margin-bottom:20px}
.ring-section{display:flex;flex-direction:column;align-items:center;padding:24px;background:var(--card);border:1px solid var(--border);border-radius:var(--radius)}
.ring-title{font-weight:700;font-size:.875rem;margin-bottom:16px;color:var(--tx2)}
.ring-wrap{position:relative;width:160px;height:160px}
.ring-svg{transform:rotate(-90deg)}
.ring-bg{fill:none;stroke:var(--bg4);stroke-width:14}
.ring-fg{fill:none;stroke:var(--acc-g);stroke-width:14;stroke-linecap:round;stroke-dasharray:251;stroke-dashoffset:251;transition:stroke-dashoffset 1.2s ease}
.ring-pct{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center}
.ring-pct span{font-family:var(--font-head);font-size:2rem;font-weight:800;color:var(--tx)}
.ring-pct small{font-size:.72rem;color:var(--tx3)}
.streak-section{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:20px}
.streak-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
.streak-count{font-family:var(--font-head);font-size:1.8rem;font-weight:800;color:var(--acc-y)}
.streak-label{font-size:.75rem;color:var(--tx3)}
.streak-dots{display:flex;gap:5px;flex-wrap:wrap}
.s-dot{width:30px;height:30px;border-radius:var(--radius-sm);background:var(--bg3);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:.6rem;color:var(--tx4);flex-direction:column;font-weight:700}
.s-dot.active{background:rgba(245,196,91,.15);border-color:var(--acc-y);color:var(--acc-y)}
.s-dot.today{background:rgba(245,196,91,.25);border-color:var(--acc-y);box-shadow:0 0 8px rgba(245,196,91,.3);color:var(--acc-y)}
.chart-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:20px}
.chart-title{font-weight:700;font-size:.9rem;margin-bottom:14px;color:var(--tx2)}
.chart-wrap{position:relative;height:200px}
.recent-list{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:20px}
.recent-item{display:flex;align-items:center;gap:12px;padding:9px 0;border-bottom:1px solid var(--border)}
.recent-item:last-child{border-bottom:none}
.ri-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.ri-info{flex:1;min-width:0}
.ri-title{font-size:.875rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ri-sub{font-size:.72rem;color:var(--tx3)}

/* â”€â”€â”€ LEADERBOARD â”€â”€â”€ */
.lb-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin-bottom:20px}
.lb-item{display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid var(--border)}
.lb-item:last-child{border-bottom:none}
.lb-rank{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:.8rem;flex-shrink:0}
.lb-rank.gold{background:rgba(245,196,91,.2);color:var(--acc-y);border:2px solid var(--acc-y)}
.lb-rank.silver{background:rgba(184,189,212,.2);color:var(--tx2);border:2px solid var(--tx3)}
.lb-rank.bronze{background:rgba(184,115,51,.2);color:#b87333;border:2px solid #b87333}
.lb-rank.other{background:var(--bg3);color:var(--tx3);border:1px solid var(--border)}
.lb-av{width:32px;height:32px;border-radius:50%;background:var(--acc);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:.8rem;color:#fff;flex-shrink:0}
.lb-info{flex:1;min-width:0}
.lb-name{font-weight:700;font-size:.875rem}
.lb-score{font-size:.72rem;color:var(--tx3)}
.lb-pts{font-family:var(--font-head);font-weight:800;color:var(--acc);font-size:1rem}
.lb-you{border-left:3px solid var(--acc);padding-left:8px;margin-left:-8px;background:rgba(91,110,245,.05);border-radius:0 var(--radius-sm) var(--radius-sm) 0}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TASKS PAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tasks-toolbar{display:flex;align-items:center;gap:10px;margin-bottom:20px;flex-wrap:wrap}
.search-box{flex:1;min-width:180px;position:relative}
.search-box input{width:100%;padding:10px 14px 10px 38px;background:var(--bg3);border:1.5px solid var(--border);border-radius:var(--radius-sm);color:var(--tx);font-size:.875rem;outline:none;font-family:var(--font);transition:all .2s}
.search-box input:focus{border-color:var(--acc)}
.search-box::before{content:'ğŸ”';position:absolute;left:12px;top:50%;transform:translateY(-50%);font-size:.85rem;pointer-events:none}
.filter-chips{display:flex;gap:6px;flex-wrap:wrap}
.fc{padding:7px 14px;border-radius:100px;font-size:.78rem;font-weight:600;cursor:pointer;border:1.5px solid var(--border);background:var(--bg3);color:var(--tx3);transition:all .2s;font-family:var(--font)}
.fc.active,.fc:hover{border-color:var(--acc);color:var(--acc);background:rgba(91,110,245,.1)}
.sort-select{padding:7px 14px;border-radius:var(--radius-sm);font-size:.78rem;background:var(--bg3);border:1.5px solid var(--border);color:var(--tx);outline:none;cursor:pointer;font-family:var(--font)}
.sort-select:focus{border-color:var(--acc)}
.tasks-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px}
.task-card{background:var(--card);border:1.5px solid var(--border);border-radius:var(--radius);padding:18px;position:relative;transition:all .2s;border-top:3px solid var(--border)}
.task-card:hover{box-shadow:var(--shadow);transform:translateY(-2px)}
.task-card.tc-high{border-top-color:var(--acc-r)}
.task-card.tc-medium{border-top-color:var(--acc-y)}
.task-card.tc-low{border-top-color:var(--acc-g)}
.task-card.tc-overdue{box-shadow:0 0 0 1px rgba(245,91,91,.2)}
.tc-header{display:flex;align-items:flex-start;justify-content:space-between;gap:8px;margin-bottom:8px}
.tc-title{font-weight:700;font-size:.95rem;line-height:1.3;flex:1}
.tc-title.completed-title{text-decoration:line-through;opacity:.5}
.tc-actions{display:flex;gap:4px;flex-shrink:0}
.icon-btn{width:28px;height:28px;border-radius:6px;background:transparent;border:1px solid var(--border);color:var(--tx3);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:.85rem;transition:all .2s}
.icon-btn:hover{background:var(--bg3);color:var(--tx)}
.icon-btn.complete-btn:hover{color:var(--acc-g);border-color:var(--acc-g)}
.icon-btn.delete-btn:hover{color:var(--acc-r);border-color:var(--acc-r)}
.tc-meta{display:flex;align-items:center;gap:6px;flex-wrap:wrap;margin:8px 0}
.tc-subject,.tc-due{font-size:.78rem;color:var(--tx3)}
.tc-due.overdue{color:var(--acc-r);font-weight:600}
.tc-desc{font-size:.8rem;color:var(--tx3);margin-top:5px;line-height:1.6;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.subtasks-wrap{margin-top:12px;border-top:1px solid var(--border);padding-top:10px}
.subtask-item{display:flex;align-items:center;gap:8px;padding:4px 0;cursor:pointer}
.subtask-cb{width:14px;height:14px;border-radius:3px;border:1.5px solid var(--border);background:transparent;flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:all .2s}
.subtask-cb.checked{background:var(--acc-g);border-color:var(--acc-g);color:#000;font-size:.6rem}
.subtask-txt{font-size:.78rem;color:var(--tx2)}
.subtask-txt.checked{text-decoration:line-through;opacity:.5}
.tc-footer{margin-top:12px;padding-top:10px;border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:4px;flex-wrap:wrap}
.ai-subtask-btn{padding:4px 10px;border-radius:100px;background:rgba(196,91,245,.1);border:1px solid rgba(196,91,245,.2);color:var(--acc-p);font-size:.72rem;font-weight:700;cursor:pointer;font-family:var(--font);transition:all .2s}
.ai-subtask-btn:hover{background:rgba(196,91,245,.2)}
.pomo-btn{padding:4px 10px;border-radius:100px;background:rgba(245,196,91,.1);border:1px solid rgba(245,196,91,.2);color:var(--acc-y);font-size:.72rem;font-weight:700;cursor:pointer;font-family:var(--font);transition:all .2s}
.pomo-btn:hover{background:rgba(245,196,91,.2)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ADD TASK PAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.add-form{max-width:640px}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.form-select{width:100%;padding:11px 14px;background:var(--bg3);border:1.5px solid var(--border);border-radius:var(--radius-sm);color:var(--tx);font-size:.9rem;outline:none;cursor:pointer;font-family:var(--font);transition:all .2s;-webkit-appearance:none}
.form-select:focus{border-color:var(--acc)}
.form-select option{background:var(--bg3);color:var(--tx)}
.form-textarea{width:100%;padding:11px 14px;background:var(--bg3);border:1.5px solid var(--border);border-radius:var(--radius-sm);color:var(--tx);font-size:.9rem;outline:none;resize:vertical;min-height:90px;font-family:var(--font);transition:all .2s}
.form-textarea:focus{border-color:var(--acc)}
.ai-priority-row{display:flex;align-items:center;gap:10px;margin-top:6px}
.ai-prio-btn{padding:7px 14px;border-radius:100px;background:rgba(196,91,245,.1);border:1px solid rgba(196,91,245,.25);color:var(--acc-p);font-size:.78rem;font-weight:700;cursor:pointer;font-family:var(--font);transition:all .2s}
.ai-prio-btn:hover{background:rgba(196,91,245,.2)}
.ai-prio-result{font-size:.78rem;color:var(--acc-p);display:none}
.export-row{display:flex;gap:10px;flex-wrap:wrap;margin-top:20px;padding-top:20px;border-top:1px solid var(--border)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UPCOMING / CALENDAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.upcoming-tabs{display:flex;gap:6px;margin-bottom:20px}
.up-tab{padding:8px 18px;border-radius:100px;font-size:.82rem;font-weight:600;cursor:pointer;border:1.5px solid var(--border);background:var(--bg3);color:var(--tx3);transition:all .2s;font-family:var(--font)}
.up-tab.active{border-color:var(--acc);color:var(--acc);background:rgba(91,110,245,.1)}
.timeline{position:relative;padding-left:28px}
.timeline::before{content:'';position:absolute;left:8px;top:0;bottom:0;width:2px;background:var(--border)}
.tl-item{position:relative;margin-bottom:16px;animation:fadeIn .3s ease}
.tl-dot{position:absolute;left:-24px;top:4px;width:16px;height:16px;border-radius:50%;background:var(--card);border:3px solid var(--acc)}
.tl-dot.overdue{border-color:var(--acc-r)}
.tl-dot.today{border-color:var(--acc-g);box-shadow:0 0 8px rgba(91,245,160,.4)}
.tl-content{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:14px 16px}
.tl-date{font-size:.72rem;font-weight:700;color:var(--tx3);letter-spacing:.5px;text-transform:uppercase;margin-bottom:6px}
.tl-title{font-weight:700;margin-bottom:4px}
.tl-meta{display:flex;gap:8px;align-items:center}

/* â”€â”€â”€ CALENDAR VIEW â”€â”€â”€ */
.cal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.cal-month{font-family:var(--font-head);font-size:1.1rem;font-weight:800}
.cal-nav{display:flex;gap:6px}
.cal-nav-btn{width:32px;height:32px;border-radius:var(--radius-sm);background:var(--bg3);border:1px solid var(--border);color:var(--tx2);cursor:pointer;font-size:1rem;display:flex;align-items:center;justify-content:center;transition:all .2s}
.cal-nav-btn:hover{background:var(--bg4);color:var(--tx)}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px}
.cal-day-head{text-align:center;font-size:.7rem;font-weight:700;color:var(--tx3);padding:8px 0;letter-spacing:.5px}
.cal-day{min-height:72px;background:var(--card);border:1px solid var(--border);border-radius:var(--radius-sm);padding:6px;cursor:pointer;transition:all .2s;position:relative}
.cal-day:hover{border-color:var(--acc);background:var(--bg3)}
.cal-day.today{border-color:var(--acc);background:rgba(91,110,245,.08)}
.cal-day.other-month{opacity:.4}
.cal-day.has-tasks{background:rgba(91,110,245,.05)}
.cal-day-num{font-size:.78rem;font-weight:700;margin-bottom:3px;color:var(--tx2)}
.cal-day.today .cal-day-num{color:var(--acc);font-weight:900}
.cal-task-dot{height:4px;width:4px;border-radius:50%;background:var(--acc);display:inline-block;margin-right:2px}
.cal-task-dot.high{background:var(--acc-r)}
.cal-task-dot.medium{background:var(--acc-y)}
.cal-task-dot.low{background:var(--acc-g)}
.cal-task-mini{font-size:.62rem;color:var(--tx3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:flex;align-items:center;gap:3px;margin-bottom:1px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PERFORMANCE PAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.perf-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:14px;margin-bottom:24px}
.perf-stat{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:20px;text-align:center}
.perf-val{font-family:var(--font-head);font-size:2.2rem;font-weight:800;color:var(--acc)}
.perf-label{font-size:.78rem;color:var(--tx3);margin-top:4px}
.subject-bars{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin-bottom:20px}
.subject-bar-item{margin-bottom:14px}
.sb-header{display:flex;justify-content:space-between;font-size:.8rem;font-weight:600;margin-bottom:5px}
.sb-track{height:8px;background:var(--bg4);border-radius:4px;overflow:hidden}
.sb-fill{height:100%;border-radius:4px;background:var(--acc);transition:width 1s ease}
.heatmap-section{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin-bottom:20px}
.heatmap-grid{display:grid;grid-template-columns:repeat(28,1fr);gap:3px;margin-top:14px}
.hm-cell{aspect-ratio:1;border-radius:3px;background:var(--bg4);transition:all .15s;animation:heatIn .3s ease both}
.hm-cell:hover{transform:scale(1.2)}
.hm-0{background:var(--bg4);opacity:.4}
.hm-1{background:rgba(91,110,245,.25)}
.hm-2{background:rgba(91,110,245,.5)}
.hm-3{background:var(--acc)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   POMODORO TIMER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#pomodoroPage .pomo-container{max-width:520px;margin:0 auto;text-align:center}
.pomo-ring-wrap{position:relative;width:240px;height:240px;margin:32px auto}
.pomo-svg{transform:rotate(-90deg)}
.pomo-bg{fill:none;stroke:var(--bg4);stroke-width:12}
.pomo-fg{fill:none;stroke:var(--acc);stroke-width:12;stroke-linecap:round;stroke-dasharray:695;stroke-dashoffset:0;transition:stroke-dashoffset .5s linear,stroke .5s}
.pomo-center{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px}
.pomo-time{font-family:var(--font-head);font-size:3rem;font-weight:800;color:var(--tx);line-height:1;letter-spacing:-2px}
.pomo-mode-label{font-size:.75rem;color:var(--tx3);font-weight:600;letter-spacing:1px;text-transform:uppercase}
.pomo-controls{display:flex;gap:12px;justify-content:center;margin-bottom:28px}
.pomo-btn{width:52px;height:52px;border-radius:50%;border:2px solid var(--border);background:var(--bg3);color:var(--tx);font-size:1.3rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s}
.pomo-btn.primary{background:var(--acc);border-color:var(--acc);color:#fff;width:64px;height:64px;font-size:1.5rem}
.pomo-btn:hover{transform:scale(1.08)}
.pomo-modes{display:flex;gap:8px;justify-content:center;margin-bottom:24px}
.pomo-mode-btn{padding:7px 18px;border-radius:100px;font-size:.8rem;font-weight:700;cursor:pointer;border:1.5px solid var(--border);background:var(--bg3);color:var(--tx3);transition:all .2s;font-family:var(--font)}
.pomo-mode-btn.active{border-color:var(--acc);color:var(--acc);background:rgba(91,110,245,.12)}
.pomo-session-count{display:flex;gap:6px;justify-content:center;margin-bottom:20px}
.pomo-tomato{font-size:1.2rem;opacity:.3;transition:opacity .3s}
.pomo-tomato.done{opacity:1}
.pomo-task-picker{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;text-align:left;margin-bottom:20px}
.pomo-task-label{font-size:.75rem;font-weight:700;color:var(--tx3);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px}
.pomo-task-select{width:100%;padding:10px 14px;background:var(--bg3);border:1.5px solid var(--border);border-radius:var(--radius-sm);color:var(--tx);font-size:.9rem;outline:none;font-family:var(--font)}
.pomo-task-select:focus{border-color:var(--acc)}
.pomo-stats-row{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:20px}
.pomo-stat{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:14px;text-align:center}
.pomo-stat-val{font-family:var(--font-head);font-size:1.6rem;font-weight:800;color:var(--acc)}
.pomo-stat-label{font-size:.72rem;color:var(--tx3);margin-top:2px}
.pomo-running{animation:pomoPulse 2s infinite}
.pomo-break-running{animation:pomoBreak 2s infinite}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AI PANEL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.ai-panel{background:var(--bg2);border-left:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;transition:all .3s}
.ai-header{padding:16px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;flex-shrink:0}
.ai-avatar{width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,var(--acc),var(--acc-p));display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0}
.ai-info{flex:1}
.ai-name{font-weight:800;font-size:.875rem}
.ai-status{font-size:.72rem;color:var(--acc-g);display:flex;align-items:center;gap:4px}
.ai-status::before{content:'';width:6px;height:6px;border-radius:50%;background:var(--acc-g);animation:bounce 2s infinite}
.ai-close-btn{width:28px;height:28px;border-radius:6px;background:transparent;border:1px solid var(--border);color:var(--tx3);cursor:pointer;display:flex;align-items:center;justify-content:center}
.ai-close-btn:hover{color:var(--acc-r);border-color:var(--acc-r)}
.ai-messages{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:12px}
.msg{display:flex;flex-direction:column;max-width:88%;animation:fadeIn .25s ease}
.msg.user{align-self:flex-end;align-items:flex-end}
.msg.bot{align-self:flex-start;align-items:flex-start}
.msg-bubble{padding:10px 14px;border-radius:14px;font-size:.85rem;line-height:1.55}
.msg.user .msg-bubble{background:var(--acc);color:#fff;border-radius:14px 14px 4px 14px}
.msg.bot .msg-bubble{background:var(--bg3);color:var(--tx);border-radius:14px 14px 14px 4px}
.msg-time{font-size:.65rem;color:var(--tx4);margin-top:3px;padding:0 4px}
.typing-indicator{display:none;gap:5px;align-items:center;padding:12px 14px;background:var(--bg3);border-radius:14px 14px 14px 4px}
.typing-dot{width:7px;height:7px;border-radius:50%;background:var(--tx3);animation:dot 1.2s infinite}
.typing-dot:nth-child(2){animation-delay:.2s}
.typing-dot:nth-child(3){animation-delay:.4s}
.ai-chips{padding:10px 16px;display:flex;gap:6px;flex-wrap:wrap;border-top:1px solid var(--border);flex-shrink:0}
.ai-chip{padding:5px 10px;border-radius:100px;background:var(--bg3);border:1px solid var(--border);font-size:.75rem;color:var(--tx2);cursor:pointer;transition:all .2s;font-family:var(--font)}
.ai-chip:hover{border-color:var(--acc);color:var(--acc)}
.ai-input-row{padding:12px 16px;border-top:1px solid var(--border);display:flex;gap:8px;flex-shrink:0}
.ai-input{flex:1;padding:10px 14px;background:var(--bg3);border:1.5px solid var(--border);border-radius:100px;color:var(--tx);font-size:.85rem;outline:none;font-family:var(--font);transition:all .2s}
.ai-input:focus{border-color:var(--acc)}
.ai-key-row{padding:8px 16px 0;flex-shrink:0}
.ai-key-input{width:100%;padding:8px 12px;background:var(--bg3);border:1.5px solid var(--border);border-radius:var(--radius-sm);color:var(--tx);font-size:.78rem;outline:none;font-family:var(--font-mono)}
.ai-key-input:focus{border-color:var(--acc)}
.ai-send-btn{width:38px;height:38px;border-radius:50%;background:var(--acc);border:none;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:.9rem;flex-shrink:0;transition:all .2s}
.ai-send-btn:hover{opacity:.88;transform:scale(1.05)}

/* â”€â”€â”€ NOTIFICATIONS â”€â”€â”€ */
.notif-panel{position:absolute;top:56px;right:16px;width:320px;background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);z-index:100;display:none;animation:fadeIn .2s ease}
.notif-panel.show{display:block}
.np-header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.np-title{font-weight:700;font-size:.9rem}
.np-clear{font-size:.75rem;color:var(--tx3);cursor:pointer;transition:color .2s}
.np-clear:hover{color:var(--acc-r)}
.np-list{max-height:300px;overflow-y:auto}
.np-item{padding:12px 16px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .15s}
.np-item:hover{background:var(--bg3)}
.np-item:last-child{border-bottom:none}
.np-item-title{font-size:.83rem;font-weight:600;margin-bottom:2px}
.np-item-sub{font-size:.75rem;color:var(--tx3)}
.np-item.unread{background:rgba(91,110,245,.05)}
.np-empty{padding:28px;text-align:center;color:var(--tx3);font-size:.85rem}

/* â”€â”€â”€ MODALS â”€â”€â”€ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:200;display:none;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(4px)}
.modal-overlay.show{display:flex}
.modal{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius-lg);padding:28px;width:100%;max-width:540px;max-height:90vh;overflow-y:auto;animation:popIn .25s ease}
.modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px}
.modal-title{font-family:var(--font-head);font-size:1.2rem;font-weight:800}
.modal-close{width:32px;height:32px;border-radius:var(--radius-sm);background:var(--bg3);border:1px solid var(--border);color:var(--tx3);cursor:pointer;font-size:1rem;display:flex;align-items:center;justify-content:center;transition:all .2s;font-family:var(--font)}
.modal-close:hover{color:var(--acc-r);border-color:var(--acc-r)}

/* â”€â”€â”€ THEME PANEL â”€â”€â”€ */
.theme-panel{position:absolute;top:56px;right:56px;width:300px;background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);z-index:100;display:none;padding:16px;animation:fadeIn .2s ease;max-height:85vh;overflow-y:auto}
.theme-panel.show{display:block}
.tp-label{font-size:.65rem;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--tx4);margin-bottom:8px;margin-top:14px}
.tp-label:first-child{margin-top:0}
.tp-colors{display:grid;grid-template-columns:repeat(5,1fr);gap:6px;margin-bottom:6px}
.tp-color{width:34px;height:34px;border-radius:50%;cursor:pointer;border:3px solid transparent;transition:all .2s}
.tp-color.active{border-color:var(--tx)}
.tp-color:hover{transform:scale(1.15)}
.tp-fonts{display:flex;flex-direction:column;gap:4px;max-height:300px;overflow-y:auto}
.tp-font-btn{padding:7px 10px;border-radius:var(--radius-sm);background:var(--bg3);border:1px solid var(--border);color:var(--tx2);font-size:.8rem;cursor:pointer;text-align:left;transition:all .2s}
.tp-font-btn.active{border-color:var(--acc);color:var(--acc);background:rgba(91,110,245,.08)}

/* â”€â”€â”€ TOAST â”€â”€â”€ */
#toastContainer{position:fixed;bottom:24px;right:24px;z-index:500;display:flex;flex-direction:column;gap:8px;pointer-events:none}
.toast{padding:12px 18px;border-radius:var(--radius-sm);font-size:.85rem;font-weight:600;min-width:200px;max-width:340px;animation:toastIn .3s ease;box-shadow:var(--shadow);pointer-events:all;display:flex;align-items:center;gap:8px;border:1px solid rgba(255,255,255,.1)}
.toast.success{background:rgba(91,245,160,.15);color:var(--acc-g);border-color:rgba(91,245,160,.2)}
.toast.error{background:rgba(245,91,91,.15);color:var(--acc-r);border-color:rgba(245,91,91,.2)}
.toast.info{background:rgba(91,110,245,.15);color:var(--acc2);border-color:rgba(91,110,245,.2)}

/* â”€â”€â”€ BOTTOM NAV â”€â”€â”€ */
.bottom-nav{display:none;position:fixed;bottom:0;left:0;right:0;background:var(--bg2);border-top:1px solid var(--border);z-index:50;padding:8px 0 env(safe-area-inset-bottom,8px)}
.bn-items{display:flex;justify-content:space-around}
.bn-item{display:flex;flex-direction:column;align-items:center;gap:3px;padding:6px 8px;color:var(--tx3);font-size:.6rem;font-weight:600;cursor:pointer;border-radius:var(--radius-sm);transition:color .2s;border:none;background:transparent;font-family:var(--font)}
.bn-item.active,.bn-item:hover{color:var(--acc)}
.bn-icon{font-size:1.1rem}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NOTES PAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.notes-layout{display:grid;grid-template-columns:220px 1fr;gap:16px;height:calc(100vh - 140px)}
.notes-sidebar{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);overflow-y:auto;display:flex;flex-direction:column}
.notes-sidebar-header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.notes-sidebar-title{font-weight:700;font-size:.85rem;color:var(--tx2)}
.note-item{padding:12px 16px;cursor:pointer;border-bottom:1px solid var(--border);transition:background .15s}
.note-item:hover{background:var(--bg3)}
.note-item.active{background:rgba(91,110,245,.08);border-left:3px solid var(--acc)}
.note-item-title{font-weight:600;font-size:.83rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.note-item-date{font-size:.68rem;color:var(--tx4);margin-top:2px}
.note-item-preview{font-size:.72rem;color:var(--tx3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:2px}
.notes-editor{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);display:flex;flex-direction:column;overflow:hidden}
.notes-editor-header{padding:14px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;flex-shrink:0}
.note-title-input{flex:1;background:transparent;border:none;outline:none;font-family:var(--font-head);font-size:1.15rem;font-weight:800;color:var(--tx)}
.note-title-input::placeholder{color:var(--tx4)}
.notes-toolbar{display:flex;gap:4px;padding:8px 16px;border-bottom:1px solid var(--border);flex-shrink:0;flex-wrap:wrap}
.note-fmt-btn{padding:4px 10px;border-radius:5px;background:transparent;border:1px solid var(--border);color:var(--tx3);font-size:.78rem;cursor:pointer;font-family:var(--font);transition:all .15s}
.note-fmt-btn:hover{background:var(--bg3);color:var(--tx)}
.note-body{flex:1;padding:18px;font-size:.9rem;line-height:1.8;color:var(--tx);background:transparent;border:none;outline:none;resize:none;font-family:var(--font);overflow-y:auto}
.note-body::placeholder{color:var(--tx4)}
.notes-footer{padding:10px 18px;border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.note-word-count{font-size:.72rem;color:var(--tx4)}
.note-subject-tag{padding:3px 10px;border-radius:100px;background:rgba(91,110,245,.1);border:1px solid rgba(91,110,245,.2);color:var(--acc);font-size:.72rem;font-weight:700}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TIMETABLE PAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.timetable-grid{display:grid;grid-template-columns:60px repeat(7,1fr);gap:1px;background:var(--border);border-radius:var(--radius);overflow:hidden;margin-bottom:20px}
.tt-header{background:var(--bg2);padding:10px 6px;text-align:center;font-size:.75rem;font-weight:700;color:var(--tx3);letter-spacing:.5px;text-transform:uppercase}
.tt-header.today{background:rgba(91,110,245,.12);color:var(--acc)}
.tt-time{background:var(--bg2);padding:8px 6px;text-align:center;font-size:.68rem;color:var(--tx4);display:flex;align-items:center;justify-content:center}
.tt-cell{background:var(--card);min-height:52px;padding:4px;cursor:pointer;position:relative;transition:background .15s}
.tt-cell:hover{background:var(--bg3)}
.tt-cell.has-class{background:transparent;cursor:default}
.tt-class{border-radius:6px;padding:5px 8px;font-size:.72rem;font-weight:700;line-height:1.3;height:100%;display:flex;flex-direction:column;justify-content:center;cursor:pointer;position:relative}
.tt-class .tt-class-name{font-weight:800;margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.tt-class .tt-class-teacher{opacity:.75;font-size:.65rem}
.tt-class .tt-delete-cls{position:absolute;top:3px;right:3px;width:16px;height:16px;border-radius:50%;background:rgba(0,0,0,.25);color:#fff;font-size:.6rem;display:none;align-items:center;justify-content:center;cursor:pointer;border:none}
.tt-class:hover .tt-delete-cls{display:flex}
.timetable-legend{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:16px}
.tt-legend-item{display:flex;align-items:center;gap:6px;font-size:.78rem;color:var(--tx2)}
.tt-legend-dot{width:12px;height:12px;border-radius:3px;flex-shrink:0}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GOALS PAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.goals-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px;margin-bottom:24px}
.goal-card{background:var(--card);border:1.5px solid var(--border);border-radius:var(--radius);padding:20px;position:relative;transition:all .2s}
.goal-card:hover{box-shadow:var(--shadow);transform:translateY(-2px)}
.goal-card.gc-completed{opacity:.7;border-style:dashed}
.goal-header{display:flex;align-items:flex-start;justify-content:space-between;gap:8px;margin-bottom:10px}
.goal-title{font-weight:800;font-size:1rem;font-family:var(--font-head);flex:1}
.goal-emoji{font-size:1.6rem;flex-shrink:0}
.goal-deadline{font-size:.75rem;color:var(--tx3);margin-bottom:10px;display:flex;align-items:center;gap:4px}
.goal-progress-wrap{margin-bottom:12px}
.goal-progress-header{display:flex;justify-content:space-between;font-size:.78rem;font-weight:600;margin-bottom:5px}
.goal-track{height:10px;background:var(--bg4);border-radius:5px;overflow:hidden}
.goal-fill{height:100%;border-radius:5px;background:linear-gradient(90deg,var(--acc),var(--acc-p));transition:width .8s ease}
.goal-milestones{margin-top:12px;border-top:1px solid var(--border);padding-top:10px}
.milestone-item{display:flex;align-items:center;gap:8px;padding:5px 0;cursor:pointer}
.milestone-cb{width:16px;height:16px;border-radius:4px;border:2px solid var(--border);background:transparent;flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:all .2s;font-size:.7rem}
.milestone-cb.checked{background:var(--acc-g);border-color:var(--acc-g);color:#000}
.milestone-txt{font-size:.8rem;color:var(--tx2)}
.milestone-txt.checked{text-decoration:line-through;opacity:.5}
.goal-footer{display:flex;align-items:center;justify-content:space-between;margin-top:12px;padding-top:10px;border-top:1px solid var(--border)}
.goal-badge{padding:3px 10px;border-radius:100px;font-size:.68rem;font-weight:700;text-transform:uppercase}
.goal-badge.on-track{background:rgba(91,245,160,.12);color:var(--acc-g);border:1px solid rgba(91,245,160,.2)}
.goal-badge.at-risk{background:rgba(245,196,91,.12);color:var(--acc-y);border:1px solid rgba(245,196,91,.2)}
.goal-badge.overdue{background:rgba(245,91,91,.12);color:var(--acc-r);border:1px solid rgba(245,91,91,.2)}
.goal-badge.done{background:rgba(91,245,160,.2);color:var(--acc-g);border:1px solid rgba(91,245,160,.3)}
.goals-stats{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px;margin-bottom:20px}
.goal-stat{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;text-align:center}
.goal-stat-val{font-family:var(--font-head);font-size:1.8rem;font-weight:800;color:var(--acc)}
.goal-stat-label{font-size:.72rem;color:var(--tx3);margin-top:3px}

/* â”€â”€â”€ SUBTASK MODAL â”€â”€â”€ */
.subtask-modal-list{display:flex;flex-direction:column;gap:8px;margin-top:8px}
.subtask-modal-item{display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--bg3);border-radius:var(--radius-sm);cursor:pointer;transition:all .15s}
.subtask-modal-item:hover{background:var(--bg4)}
.subtask-modal-cb{width:18px;height:18px;border-radius:4px;border:2px solid var(--border);display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .2s;font-size:.8rem}
.subtask-modal-cb.checked{background:var(--acc-g);border-color:var(--acc-g);color:#000}
.subtask-modal-txt{font-size:.875rem;font-weight:500;flex:1}
.subtask-modal-txt.checked{text-decoration:line-through;opacity:.5}
.subtask-add-row{display:flex;gap:8px;margin-top:12px}
.subtask-add-input{flex:1;padding:9px 12px;background:var(--bg3);border:1.5px solid var(--border);border-radius:var(--radius-sm);color:var(--tx);font-size:.875rem;outline:none;font-family:var(--font)}
.subtask-add-input:focus{border-color:var(--acc)}

/* â”€â”€â”€ FRIEND CODE â”€â”€â”€ */
.friend-section{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin-bottom:20px}
.friend-code-display{display:flex;align-items:center;gap:10px;margin:12px 0}
.friend-code-box{flex:1;padding:12px 16px;background:var(--bg3);border:2px dashed var(--acc);border-radius:var(--radius-sm);font-family:var(--font-mono);font-size:1.1rem;font-weight:700;color:var(--acc);letter-spacing:4px;text-align:center}
.friend-join-row{display:flex;gap:8px;margin-top:8px}
.friend-input{flex:1;padding:10px 14px;background:var(--bg3);border:1.5px solid var(--border);border-radius:var(--radius-sm);color:var(--tx);font-size:.9rem;outline:none;font-family:var(--font-mono);letter-spacing:2px}
.friend-input:focus{border-color:var(--acc)}

/* â”€â”€â”€ DARK/LIGHT QUICK TOGGLE â”€â”€â”€ */
.theme-quick-toggle{width:36px;height:36px;border-radius:var(--radius-sm);background:transparent;border:1px solid var(--border);color:var(--tx2);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:1rem;transition:all .2s}
.theme-quick-toggle:hover{background:var(--bg3);color:var(--tx)}

/* â”€â”€â”€ SOUND TOGGLE â”€â”€â”€ */
.sound-toggle{display:flex;align-items:center;gap:8px;padding:8px 14px;background:var(--bg3);border:1px solid var(--border);border-radius:100px;cursor:pointer;font-size:.78rem;font-weight:600;color:var(--tx2);transition:all .2s}
.sound-toggle:hover{border-color:var(--acc);color:var(--acc)}
.sound-toggle.muted{opacity:.5}

/* â”€â”€â”€ DASHBOARD IMPROVEMENTS â”€â”€â”€ */
.dash-quick-actions{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px;margin-bottom:20px}
.quick-action-btn{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:14px 10px;text-align:center;cursor:pointer;transition:all .2s;display:flex;flex-direction:column;align-items:center;gap:6px}
.quick-action-btn:hover{border-color:var(--acc);transform:translateY(-2px);box-shadow:var(--shadow)}
.qa-icon{font-size:1.5rem}
.qa-label{font-size:.72rem;font-weight:700;color:var(--tx2)}
.motivation-card{background:linear-gradient(135deg,rgba(91,110,245,.15),rgba(196,91,245,.1));border:1px solid rgba(91,110,245,.25);border-radius:var(--radius);padding:18px;margin-bottom:16px;position:relative;overflow:hidden}
.motivation-card::before{content:'';position:absolute;top:-30px;right:-30px;width:100px;height:100px;border-radius:50%;background:radial-gradient(circle,rgba(91,110,245,.2),transparent)}
.motivation-quote{font-size:.95rem;font-weight:600;color:var(--tx);line-height:1.5;font-style:italic}
.motivation-author{font-size:.72rem;color:var(--tx3);margin-top:6px}
/* â”€â”€â”€ RESPONSIVE â”€â”€â”€ */
@media(max-width:1199px){
  #mainApp{grid-template-columns:230px 1fr!important}
  .ai-panel{position:fixed;right:-100%;top:0;bottom:0;width:340px;z-index:150;transition:right .3s;box-shadow:var(--shadow)}
  #mainApp.ai-open .ai-panel{right:0}
}
@media(max-width:900px){
  .notes-layout{grid-template-columns:1fr;height:auto}
  .notes-sidebar{max-height:200px}
  .timetable-grid{grid-template-columns:44px repeat(7,1fr);font-size:.65rem}
  .perf-charts-grid{grid-template-columns:1fr!important}
}

@media(max-width:767px){
  #mainApp{grid-template-columns:1fr!important}
  .sidebar{position:fixed;left:-100%;top:0;bottom:0;z-index:150;transition:left .3s;width:248px;box-shadow:var(--shadow)}
  .sidebar.open{left:0}
  .bottom-nav{display:block}
  .content-area{padding:16px;padding-bottom:80px}
  .landing-header{padding:16px 20px}
  .hero{padding:60px 20px 48px}
  .hero-title{font-size:2.2rem}
  .landing-nav a:not(.btn-cta){display:none}
  .features{padding:48px 20px;grid-template-columns:1fr}
  .landing-cta-sec{padding:40px 20px}
  .landing-footer{padding:16px 20px;flex-direction:column;gap:8px;text-align:center}
  .kpi-grid{grid-template-columns:repeat(2,1fr)}
  .auth-box{padding:28px 20px}
  .tasks-toolbar{flex-direction:column;align-items:stretch}
  .pomo-time{font-size:2.4rem}
  .pomo-ring-wrap{width:200px;height:200px}
  .cal-task-mini{display:none}
  .theme-panel{right:8px;width:280px}
}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â• LANDING â•â•â•â•â•â•â•â•â•â• -->
<div id="landingPage">
  <header class="landing-header">
    <div class="landing-logo"><span class="logo-dot"></span>StudyBot</div>
    <nav class="landing-nav">
      <a href="#features">Features</a>
      <a href="#how">How it works</a>
      <button class="btn-cta" onclick="showAuth()">Get Started â†’</button>
    </nav>
  </header>
  <section class="hero">
    <div class="hero-badge">ğŸ¤– AI-Powered Study Assistant v3</div>
    <h1 class="hero-title">Study smarter,<br>not <span>harder</span></h1>
    <p class="hero-sub">StudyBot uses AI to help you manage assignments, track performance, run Pomodoro sessions, and compete with friends â€” all in one beautiful place.</p>
    <div class="hero-btns">
      <button class="btn-hero primary" onclick="showAuth()">Start for free â†’</button>
      <button class="btn-hero secondary" onclick="document.getElementById('features').scrollIntoView({behavior:'smooth'})">See features</button>
    </div>
  </section>
  <section class="features" id="features">
    <div class="feature-card"><div class="feature-icon">ğŸ“‹</div><div class="feature-title">Smart Task Management</div><div class="feature-desc">Create, sort, filter tasks by priority, subject, or deadline. Export as PDF or JSON instantly.</div></div>
    <div class="feature-card"><div class="feature-icon">ğŸ¤–</div><div class="feature-title">Real AI Assistant</div><div class="feature-desc">Connect your OpenRouter API key for real GPT-4 responses. Falls back to smart local AI.</div></div>
    <div class="feature-card"><div class="feature-icon">ğŸ…</div><div class="feature-title">Pomodoro Timer</div><div class="feature-desc">25/5 focus sessions with break tracking, session counts, and task linking for deep focus.</div></div>
    <div class="feature-card"><div class="feature-icon">ğŸ†</div><div class="feature-title">Leaderboard</div><div class="feature-desc">Compete with all users on the same device. Score points for completing tasks and streaks.</div></div>
    <div class="feature-card"><div class="feature-icon">ğŸ“…</div><div class="feature-title">Calendar View</div><div class="feature-desc">Visualise all your deadlines in a beautiful monthly calendar with colour-coded priority dots.</div></div>
    <div class="feature-card"><div class="feature-icon">ğŸ¨</div><div class="feature-title">15 Themes + 21 Fonts</div><div class="feature-desc">Personalise with beautiful themes and fonts. Saved instantly per account.</div></div>
    <div class="feature-card"><div class="feature-icon">ğŸ”’</div><div class="feature-title">Secure Auth</div><div class="feature-desc">SHA-256 password hashing for secure local storage. Your data stays private on your device.</div></div>
    <div class="feature-card"><div class="feature-icon">ğŸ“Š</div><div class="feature-title">Performance Analytics</div><div class="feature-desc">Heatmaps, streaks, subject bars, weekly charts and overall grades â€” see your growth.</div></div>
  </section>
  <section class="landing-cta-sec" id="how">
    <h2>Ready to ace your studies?</h2>
    <p>Join students using StudyBot to stay on top of assignments and reach their academic goals.</p>
    <button class="btn-hero primary" onclick="showAuth()">Create free account â†’</button>
  </section>
  <footer class="landing-footer">
    <span>Â© 2026 StudyBot v3 â€” Built for students, by students</span>
    <span>HTML5 Â· CSS3 Â· Vanilla JS Â· SHA-256 Â· PWA Ready</span>
  </footer>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• AUTH â•â•â•â•â•â•â•â•â•â• -->
<div id="authPage" style="display:none">
  <div class="auth-box">
    <div class="auth-logo">ğŸ¤– StudyBot</div>
    <div class="auth-sub">Your AI-powered study companion</div>
    <div class="auth-tabs">
      <button class="auth-tab active" id="loginTab" onclick="switchAuthTab('login')">Sign In</button>
      <button class="auth-tab" id="registerTab" onclick="switchAuthTab('register')">Register</button>
    </div>
    <div id="loginForm">
      <div class="form-group"><label>Email address</label><input type="email" id="loginEmail" class="form-input" placeholder="you@example.com" autocomplete="email"/><div class="form-error" id="loginEmailErr">Please enter a valid email.</div></div>
      <div class="form-group"><label>Password</label><input type="password" id="loginPass" class="form-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password" onkeydown="if(event.key==='Enter')handleLogin()"/><div class="form-error" id="loginPassErr">Invalid email or password.</div></div>
      <button class="btn-submit" onclick="handleLogin()">Sign In â†’</button>
      <div id="quickLogins" style="display:none"><div class="quick-logins"><div class="ql-label">Quick login</div><div class="ql-chips" id="qlChips"></div></div></div>
    </div>
    <div id="registerForm" style="display:none">
      <div class="form-group"><label>Full name</label><input type="text" id="regName" class="form-input" placeholder="Your name"/><div class="form-error" id="regNameErr">Name is required.</div></div>
      <div class="form-group"><label>Email address</label><input type="email" id="regEmail" class="form-input" placeholder="you@example.com" autocomplete="email"/><div class="form-error" id="regEmailErr">Please enter a valid email.</div></div>
      <div class="form-group"><label>Password</label><input type="password" id="regPass" class="form-input" placeholder="Min 6 characters" autocomplete="new-password" onkeydown="if(event.key==='Enter')handleRegister()"/><div class="form-error" id="regPassErr">Password must be at least 6 characters.</div></div>
      <button class="btn-submit" onclick="handleRegister()">Create Account â†’</button>
    </div>
    <div class="secure-badge">ğŸ”’ Passwords hashed with SHA-256</div>
    <div class="back-to-landing"><a href="#" onclick="showLanding()">â† Back to home</a></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• MAIN APP â•â•â•â•â•â•â•â•â•â• -->
<div id="mainApp">
  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-top">
      <div class="sidebar-logo"><span class="logo-dot"></span>StudyBot</div>
      <div class="nav-section">
        <div class="nav-label">Menu</div>
        <button class="nav-item active" data-page="dashboard" onclick="navigate('dashboard')"><span class="nav-icon">ğŸ“Š</span>Dashboard</button>
        <button class="nav-item" data-page="tasks" onclick="navigate('tasks')"><span class="nav-icon">ğŸ“‹</span>My Tasks</button>
        <button class="nav-item" data-page="upcoming" onclick="navigate('upcoming')"><span class="nav-icon">ğŸ“…</span>Upcoming</button>
        <button class="nav-item" data-page="pomodoro" onclick="navigate('pomodoro')"><span class="nav-icon">ğŸ…</span>Pomodoro</button>
        <button class="nav-item" data-page="performance" onclick="navigate('performance')"><span class="nav-icon">ğŸ“ˆ</span>Performance</button>
        <button class="nav-item" data-page="goals" onclick="navigate('goals')"><span class="nav-icon">ğŸ¯</span>Goals</button>
        <button class="nav-item" data-page="notes" onclick="navigate('notes')"><span class="nav-icon">ğŸ“</span>Notes</button>
        <button class="nav-item" data-page="timetable" onclick="navigate('timetable')"><span class="nav-icon">ğŸ—“ï¸</span>Timetable</button>
        <button class="nav-item" data-page="add" onclick="navigate('add')"><span class="nav-icon">â•</span>Add Task</button>
      </div>
    </div>
    <div class="sidebar-bottom">
      <div class="user-chip">
        <div class="user-av" id="sidebarAv">?</div>
        <div class="user-info"><div class="user-name" id="sidebarName">Loading...</div><div class="user-email" id="sidebarEmail">...</div></div>
        <button class="logout-btn" onclick="handleLogout()">Out</button>
      </div>
    </div>
  </aside>

  <!-- MAIN COLUMN -->
  <div class="app-main">
    <header class="app-header">
      <button class="header-hamburger" onclick="toggleSidebar()">â˜°</button>
      <div class="header-title" id="headerTitle">Dashboard</div>
      <div class="header-actions">
        <div style="position:relative">
          <button class="h-btn" onclick="toggleNotifPanel()" id="notifBtn">ğŸ””<span class="notif-badge" id="notifBadge"></span></button>
          <div class="notif-panel" id="notifPanel">
            <div class="np-header"><span class="np-title">Notifications</span><span class="np-clear" onclick="clearNotifs()">Clear all</span></div>
            <div class="np-list" id="npList"></div>
          </div>
        </div>
        <div style="position:relative">
          <button class="h-btn" onclick="toggleThemePanel()" title="Themes & Fonts">ğŸ¨</button>
          <div class="theme-panel" id="themePanel">
            <div class="tp-label">Colour Theme</div>
            <div class="tp-colors">
              <div class="tp-color active" style="background:linear-gradient(135deg,#5b6ef5,#c45bf5)" data-theme="midnight" onclick="setTheme('midnight')" title="Midnight"></div>
              <div class="tp-color" style="background:linear-gradient(135deg,#00d4ff,#51fa8a)" data-theme="aurora" onclick="setTheme('aurora')" title="Aurora"></div>
              <div class="tp-color" style="background:linear-gradient(135deg,#f5a623,#f55b5b)" data-theme="solar" onclick="setTheme('solar')" title="Solar"></div>
              <div class="tp-color" style="background:linear-gradient(135deg,#2d5016,#6fa040)" data-theme="paper" onclick="setTheme('paper')" title="Paper"></div>
              <div class="tp-color" style="background:linear-gradient(135deg,#f56ab0,#c45bf5)" data-theme="rose" onclick="setTheme('rose')" title="Rose"></div>
              <div class="tp-color" style="background:linear-gradient(135deg,#42a5f5,#90caf9)" data-theme="slate" onclick="setTheme('slate')" title="Slate"></div>
              <div class="tp-color" style="background:linear-gradient(135deg,#1a1000,#b87333)" data-theme="copper" onclick="setTheme('copper')" title="Copper"></div>
              <div class="tp-color" style="background:linear-gradient(135deg,#f6f8fc,#4f63ff)" data-theme="light" onclick="setTheme('light')" title="Light"></div>
              <div class="tp-color" style="background:linear-gradient(135deg,#f0f7ff,#0066ff)" data-theme="sky" onclick="setTheme('sky')" title="Sky"></div>
              <div class="tp-color" style="background:linear-gradient(135deg,#f0fff8,#00b86e)" data-theme="mint" onclick="setTheme('mint')" title="Mint"></div>
              <div class="tp-color" style="background:linear-gradient(135deg,#fff8f0,#ff7020)" data-theme="peach" onclick="setTheme('peach')" title="Peach"></div>
              <div class="tp-color" style="background:linear-gradient(135deg,#f8f0ff,#8020ff)" data-theme="lavender" onclick="setTheme('lavender')" title="Lavender"></div>
              <div class="tp-color" style="background:linear-gradient(135deg,#fffef0,#c8a800)" data-theme="lemon" onclick="setTheme('lemon')" title="Lemon"></div>
              <div class="tp-color" style="background:linear-gradient(135deg,#fff0f5,#e8006a)" data-theme="blush" onclick="setTheme('blush')" title="Blush"></div>
              <div class="tp-color" style="background:linear-gradient(135deg,#f5f7fa,#4455ee)" data-theme="cloud" onclick="setTheme('cloud')" title="Cloud"></div>
              <div style="grid-column:1/-1;border-top:1px solid var(--border);margin:4px 0;font-size:.6rem;color:var(--tx4);letter-spacing:1px;text-transform:uppercase;padding-top:6px">Vivid</div>
              <div class="tp-color" style="background:linear-gradient(135deg,#160000,#ff2020)" data-theme="crimson" onclick="setTheme('crimson')" title="Crimson Red"></div>
              <div class="tp-color" style="background:linear-gradient(135deg,#001a0f,#00e866)" data-theme="emerald" onclick="setTheme('emerald')" title="Emerald Green"></div>
              <div class="tp-color" style="background:linear-gradient(135deg,#001525,#0099ff)" data-theme="ocean" onclick="setTheme('ocean')" title="Ocean Blue"></div>
              <div class="tp-color" style="background:linear-gradient(135deg,#100020,#9933ff)" data-theme="violet" onclick="setTheme('violet')" title="Deep Violet"></div>
              <div class="tp-color" style="background:linear-gradient(135deg,#1c1000,#ffaa00)" data-theme="amber" onclick="setTheme('amber')" title="Amber Gold"></div>
              <div class="tp-color" style="background:linear-gradient(135deg,#000,#00ffaa)" data-theme="neon" onclick="setTheme('neon')" title="Neon Green"></div>
              <div class="tp-color" style="background:linear-gradient(135deg,#150500,#ff6600)" data-theme="fire" onclick="setTheme('fire')" title="Fire Orange"></div>
            </div>
            <div class="tp-label">Font Family</div>
            <div class="tp-fonts" id="fontList"></div>
          </div>
        </div>
        <button class="theme-quick-toggle" onclick="quickThemeToggle()" id="themeQuickBtn" title="Toggle dark/light">ğŸŒ™</button>
        <button class="theme-quick-toggle sound-toggle" id="soundToggleBtn" onclick="toggleSound()" title="Toggle sounds">ğŸ”Š</button>
        <button class="ai-toggle-btn" onclick="toggleAI()">ğŸ¤– StudyBot AI</button>
      </div>
    </header>

    <div class="content-area">

      <!-- DASHBOARD -->
      <div class="page active" id="dashboardPage">
        <div class="greeting">
          <div class="greeting-left">
            <h2 id="greetingText">Good morning! ğŸ‘‹</h2>
            <div class="greeting-sub" id="greetingName">Welcome back â€” let's crush today's goals.</div>
          </div>
          <div class="greeting-right">
            <button class="btn btn-ghost" onclick="exportJSON()" title="Export all tasks as JSON">ğŸ“¦ Export JSON</button>
            <button class="btn btn-ghost" onclick="exportPDF()" title="Export tasks as PDF">ğŸ“„ Export PDF</button>
          </div>
        </div>
        <div class="motivation-card" id="motivationCard">
          <div class="motivation-quote" id="motivationQuote">Loading...</div>
          <div class="motivation-author" id="motivationAuthor"></div>
        </div>
        <div class="dash-quick-actions">
          <div class="quick-action-btn" onclick="navigate('add')"><div class="qa-icon">â•</div><div class="qa-label">Add Task</div></div>
          <div class="quick-action-btn" onclick="navigate('pomodoro')"><div class="qa-icon">ğŸ…</div><div class="qa-label">Pomodoro</div></div>
          <div class="quick-action-btn" onclick="navigate('notes')"><div class="qa-icon">ğŸ“</div><div class="qa-label">Notes</div></div>
          <div class="quick-action-btn" onclick="navigate('goals')"><div class="qa-icon">ğŸ¯</div><div class="qa-label">Goals</div></div>
          <div class="quick-action-btn" onclick="navigate('timetable')"><div class="qa-icon">ğŸ—“ï¸</div><div class="qa-label">Timetable</div></div>
        </div>
        <div class="kpi-grid" id="kpiGrid"></div>
        <div class="dash-grid">
          <div>
            <div class="card chart-card" style="margin-bottom:16px">
              <div class="chart-title">Task Distribution</div>
              <div class="chart-wrap"><canvas id="donutChart"></canvas></div>
            </div>
            <div class="recent-list card" id="recentList">
              <div style="font-weight:700;font-size:.9rem;margin-bottom:12px;color:var(--tx2)">Recent Activity</div>
            </div>
          </div>
          <div style="display:flex;flex-direction:column;gap:16px">
            <div class="ring-section">
              <div class="ring-title">Overall Progress</div>
              <div class="ring-wrap">
                <svg class="ring-svg" viewBox="0 0 90 90" width="160" height="160">
                  <circle class="ring-bg" cx="45" cy="45" r="40"/>
                  <circle class="ring-fg" cx="45" cy="45" r="40" id="ringFg"/>
                </svg>
                <div class="ring-pct"><span id="ringPct">0%</span><small>Complete</small></div>
              </div>
            </div>
            <div class="streak-section">
              <div class="streak-header">
                <div><div class="streak-count" id="streakCount">0</div><div class="streak-label">day streak ğŸ”¥</div></div>
              </div>
              <div class="streak-dots" id="streakDots"></div>
            </div>
            <!-- LEADERBOARD MINI -->
            <div class="lb-card">
              <div style="font-weight:700;font-size:.9rem;margin-bottom:12px;color:var(--tx2)">ğŸ† Leaderboard</div>
              <div id="lbMini"></div>
              <button class="btn btn-ghost" style="width:100%;margin-top:10px;font-size:.78rem" onclick="navigate('performance')">View full stats â†’</button>
            </div>
          </div>
        </div>
      </div>

      <!-- TASKS -->
      <div class="page" id="tasksPage">
        <div class="section-title">My Tasks</div>
        <div class="section-sub">Manage all your assignments and work items</div>
        <div class="tasks-toolbar">
          <div class="search-box"><input type="text" id="taskSearch" placeholder="Search tasks..." oninput="renderTasks()"/></div>
          <div class="filter-chips">
            <button class="fc active" data-filter="all" onclick="setFilter('all',this)">All</button>
            <button class="fc" data-filter="high" onclick="setFilter('high',this)">ğŸ”´ High</button>
            <button class="fc" data-filter="medium" onclick="setFilter('medium',this)">ğŸŸ¡ Medium</button>
            <button class="fc" data-filter="low" onclick="setFilter('low',this)">ğŸŸ¢ Low</button>
            <button class="fc" data-filter="completed" onclick="setFilter('completed',this)">âœ… Done</button>
            <button class="fc" data-filter="overdue" onclick="setFilter('overdue',this)">âš ï¸ Overdue</button>
          </div>
          <select class="sort-select" id="sortSelect" onchange="renderTasks()">
            <option value="newest">Newest first</option>
            <option value="oldest">Oldest first</option>
            <option value="due">By due date</option>
            <option value="priority">By priority</option>
            <option value="subject">By subject</option>
            <option value="az">A â†’ Z</option>
          </select>
          <button class="btn btn-primary" onclick="navigate('add')">+ New Task</button>
        </div>
        <div class="tasks-grid" id="tasksGrid"></div>
      </div>

      <!-- UPCOMING / CALENDAR -->
      <div class="page" id="upcomingPage">
        <div class="section-title">Upcoming Deadlines</div>
        <div class="section-sub">Tasks due in the next 14 days Â· Calendar view of all deadlines</div>
        <div class="upcoming-tabs">
          <button class="up-tab active" id="tabTimeline" onclick="switchUpcomingTab('timeline')">ğŸ“‹ Timeline</button>
          <button class="up-tab" id="tabCalendar" onclick="switchUpcomingTab('calendar')">ğŸ“… Calendar</button>
        </div>
        <div id="timelineView"><div class="timeline" id="upcomingTimeline"></div></div>
        <div id="calendarView" style="display:none">
          <div class="card">
            <div class="cal-header">
              <button class="cal-nav-btn" onclick="calNav(-1)">â€¹</button>
              <div class="cal-month" id="calMonth">Month</div>
              <button class="cal-nav-btn" onclick="calNav(1)">â€º</button>
            </div>
            <div class="cal-grid">
              <div class="cal-day-head">Sun</div><div class="cal-day-head">Mon</div><div class="cal-day-head">Tue</div>
              <div class="cal-day-head">Wed</div><div class="cal-day-head">Thu</div><div class="cal-day-head">Fri</div><div class="cal-day-head">Sat</div>
            </div>
            <div class="cal-grid" id="calDays"></div>
          </div>
        </div>
      </div>

      <!-- POMODORO -->
      <div class="page" id="pomodoroPage">
        <div class="section-title">ğŸ… Pomodoro Timer</div>
        <div class="section-sub">Focus sessions with built-in breaks. Stay in the zone.</div>
        <div class="pomo-container">
          <div class="pomo-modes">
            <button class="pomo-mode-btn active" id="pmFocus" onclick="setPomoMode('focus')">Focus (25m)</button>
            <button class="pomo-mode-btn" id="pmShort" onclick="setPomoMode('short')">Short Break (5m)</button>
            <button class="pomo-mode-btn" id="pmLong" onclick="setPomoMode('long')">Long Break (15m)</button>
          </div>
          <div class="pomo-ring-wrap" id="pomoRingWrap">
            <svg class="pomo-svg" viewBox="0 0 240 240" width="240" height="240">
              <circle class="pomo-bg" cx="120" cy="120" r="110"/>
              <circle class="pomo-fg" id="pomoFg" cx="120" cy="120" r="110"/>
            </svg>
            <div class="pomo-center">
              <div class="pomo-time" id="pomoTime">25:00</div>
              <div class="pomo-mode-label" id="pomoModeLabel">FOCUS</div>
            </div>
          </div>
          <div class="pomo-session-count" id="pomoTomatoes"></div>
          <div class="pomo-controls">
            <button class="pomo-btn" onclick="resetPomo()" title="Reset">â†º</button>
            <button class="pomo-btn primary" id="pomoPlayBtn" onclick="togglePomo()">â–¶</button>
            <button class="pomo-btn" onclick="skipPomo()" title="Skip">â­</button>
          </div>
          <div class="pomo-task-picker">
            <div class="pomo-task-label">Studying Task</div>
            <select class="pomo-task-select" id="pomoTaskSelect"><option value="">â€” Select a task â€”</option></select>
          </div>
          <div class="pomo-stats-row">
            <div class="pomo-stat"><div class="pomo-stat-val" id="pomoTotalSessions">0</div><div class="pomo-stat-label">Sessions Today</div></div>
            <div class="pomo-stat"><div class="pomo-stat-val" id="pomoTotalMins">0</div><div class="pomo-stat-label">Min Focused</div></div>
            <div class="pomo-stat"><div class="pomo-stat-val" id="pomoLongestStreak">0</div><div class="pomo-stat-label">Session Streak</div></div>
          </div>
        </div>
      </div>

      <!-- PERFORMANCE -->
      <div class="page" id="performancePage">
        <div class="section-title">Performance Analytics</div>
        <div class="section-sub">Track your study progress, patterns and subject performance</div>
        <div class="perf-grid" id="perfGrid"></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px" id="perfChartsGrid">
          <div class="card chart-card">
            <div class="chart-title">Weekly Completions</div>
            <div class="chart-wrap"><canvas id="barChart"></canvas></div>
          </div>
          <div class="card chart-card">
            <div class="chart-title">Priority Breakdown</div>
            <div class="chart-wrap"><canvas id="perfDonut"></canvas></div>
          </div>
        </div>
        <div class="card subject-bars" id="subjectBars">
          <div class="chart-title" style="margin-bottom:12px">Subject Progress</div>
        </div>
        <div class="card heatmap-section">
          <div class="chart-title">28-Day Activity Heatmap</div>
          <div style="font-size:.75rem;color:var(--tx3);margin-top:4px">Days you completed tasks</div>
          <div class="heatmap-grid" id="heatmap"></div>
        </div>
        <!-- FULL LEADERBOARD -->
        <div class="lb-card card" style="margin-top:20px">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px">
            <div class="chart-title" style="margin:0">ğŸ† Full Leaderboard</div>
            <div style="font-size:.72rem;color:var(--tx3)">Points for tasks + streaks</div>
          </div>
          <div id="lbFull"></div>
        </div>
        <!-- FRIEND CODES -->
        <div class="friend-section card" style="margin-top:16px">
          <div class="chart-title" style="margin-bottom:4px">ğŸ‘¥ Friend Codes</div>
          <div style="font-size:.8rem;color:var(--tx3);margin-bottom:12px">Share your code so friends on this device can see you on the leaderboard</div>
          <div style="font-size:.78rem;color:var(--tx2);font-weight:600;margin-bottom:4px">Your Code</div>
          <div class="friend-code-display">
            <div class="friend-code-box" id="myFriendCode">------</div>
            <button class="btn btn-ghost" onclick="copyFriendCode()">ğŸ“‹ Copy</button>
          </div>
          <div style="font-size:.78rem;color:var(--tx2);font-weight:600;margin-bottom:6px;margin-top:12px">Join Friend (Enter their code)</div>
          <div class="friend-join-row">
            <input class="friend-input" id="friendCodeInput" placeholder="e.g. SB-A1B2C3" maxlength="9"/>
            <button class="btn btn-primary" onclick="joinFriend()">Join</button>
          </div>
          <div id="friendsList" style="margin-top:12px"></div>
        </div>
      </div>

      <!-- ADD TASK -->
      <div class="page" id="addPage">
        <div class="section-title">Add New Task</div>
        <div class="section-sub">Fill in the details for your new assignment</div>
        <div class="add-form">
          <div class="form-group"><label>Task Title *</label><input type="text" id="taskTitle" class="form-input" placeholder="e.g. Complete Math Assignment"/><div class="form-error" id="taskTitleErr">Title is required.</div></div>
          <div class="form-row">
            <div class="form-group"><label>Subject</label><input type="text" id="taskSubject" class="form-input" placeholder="e.g. Mathematics"/></div>
            <div class="form-group"><label>Due Date</label><input type="date" id="taskDue" class="form-input"/></div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Priority</label>
              <select id="taskPriority" class="form-select"><option value="medium">Medium</option><option value="high">High</option><option value="low">Low</option></select>
              <div class="ai-priority-row"><button class="ai-prio-btn" onclick="aiSuggestPriority()">âœ¨ AI Suggest</button><span class="ai-prio-result" id="aiPrioResult"></span></div>
            </div>
            <div class="form-group"><label>Status</label><select id="taskStatus" class="form-select"><option value="pending">Pending</option><option value="in-progress">In Progress</option><option value="completed">Completed</option></select></div>
          </div>
          <div class="form-group"><label>Notes</label><textarea id="taskNotes" class="form-textarea" placeholder="Additional details, references, or notes..."></textarea></div>
          <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:8px">
            <button class="btn btn-primary" onclick="submitTask()">Add Task â†’</button>
            <button class="btn btn-ghost" onclick="resetTaskForm()">Reset</button>
          </div>
          <div class="export-row">
            <button class="btn btn-ghost" onclick="exportJSON()">ğŸ“¦ Export JSON</button>
            <button class="btn btn-ghost" onclick="exportPDF()">ğŸ“„ Export PDF</button>
            <button class="btn btn-ghost" onclick="importJSON()">ğŸ“¥ Import JSON</button>
            <input type="file" id="importInput" accept=".json" style="display:none" onchange="handleImport(event)"/>
          </div>
        </div>
      </div>

      <!-- GOALS PAGE -->
      <div class="page" id="goalsPage">
        <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:6px">
          <div class="section-title" style="margin:0">ğŸ¯ Study Goals</div>
          <button class="btn btn-primary" onclick="openGoalModal()">+ New Goal</button>
        </div>
        <div class="section-sub">Set milestones and track your academic targets</div>
        <div class="goals-stats" id="goalsStats"></div>
        <div class="goals-grid" id="goalsGrid"></div>
      </div>

      <!-- NOTES PAGE -->
      <div class="page" id="notesPage">
        <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:16px">
          <div>
            <div class="section-title" style="margin-bottom:2px">ğŸ“ My Notes</div>
            <div class="section-sub" style="margin:0">Quick-capture ideas, summaries & revision notes</div>
          </div>
        </div>
        <div class="notes-layout">
          <div class="notes-sidebar">
            <div class="notes-sidebar-header">
              <span class="notes-sidebar-title">Notes</span>
              <button class="btn btn-primary" style="padding:4px 12px;font-size:.75rem" onclick="newNote()">+ New</button>
            </div>
            <div id="notesList"></div>
          </div>
          <div class="notes-editor" id="notesEditor">
            <div class="notes-editor-header">
              <input class="note-title-input" id="noteTitleInput" placeholder="Note title..." oninput="saveCurrentNote()"/>
              <select id="noteSubjectSelect" class="form-select" style="width:140px;padding:6px 10px;font-size:.78rem" onchange="saveCurrentNote()">
                <option value="">No subject</option>
              </select>
              <button class="icon-btn delete-btn" onclick="deleteCurrentNote()" title="Delete note">âœ•</button>
            </div>
            <div class="notes-toolbar">
              <button class="note-fmt-btn" onclick="insertFmt('**','**')"><b>B</b></button>
              <button class="note-fmt-btn" onclick="insertFmt('_','_')"><i>I</i></button>
              <button class="note-fmt-btn" onclick="insertFmt('# ','')">H1</button>
              <button class="note-fmt-btn" onclick="insertFmt('## ','')">H2</button>
              <button class="note-fmt-btn" onclick="insertFmt('- ','')">List</button>
              <button class="note-fmt-btn" onclick="insertFmt('> ','')">Quote</button>
              <button class="note-fmt-btn" onclick="insertFmt('```\n','\n```')">Code</button>
              <button class="note-fmt-btn" onclick="insertFmt('---\n','')">Divider</button>
              <button class="note-fmt-btn" onclick="insertFmt('[ ] ','')">â˜ Todo</button>
              <button class="note-fmt-btn" onclick="copyNoteText()">ğŸ“‹ Copy</button>
            </div>
            <textarea class="note-body" id="noteBody" placeholder="Start writing your note... Use the toolbar above for formatting." oninput="saveCurrentNote();updateWordCount()"></textarea>
            <div class="notes-footer">
              <span class="note-word-count" id="wordCount">0 words</span>
              <div style="display:flex;gap:8px">
                <button class="btn btn-ghost" style="font-size:.75rem;padding:5px 12px" onclick="exportNoteAsTxt()">ğŸ“„ Export .txt</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- TIMETABLE PAGE -->
      <div class="page" id="timetablePage">
        <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:6px">
          <div class="section-title" style="margin:0">ğŸ—“ï¸ Weekly Timetable</div>
          <div style="display:flex;gap:8px">
            <button class="btn btn-ghost" onclick="clearTimetable()">ğŸ—‘ Clear All</button>
            <button class="btn btn-primary" onclick="openAddClassModal()">+ Add Class</button>
          </div>
        </div>
        <div class="section-sub">Build your weekly class schedule</div>
        <div class="timetable-legend" id="ttLegend"></div>
        <div style="overflow-x:auto">
          <div class="timetable-grid" id="timetableGrid" style="min-width:600px"></div>
        </div>
        <div style="margin-top:16px;padding:14px;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);font-size:.8rem;color:var(--tx3)">
          ğŸ’¡ Click any empty slot to quickly add a class, or use the button above.
        </div>
      </div>

    </div><!-- /content-area -->
  </div><!-- /app-main -->

  <!-- AI PANEL -->
  <aside class="ai-panel" id="aiPanel">
    <div class="ai-header">
      <div class="ai-avatar">ğŸ¤–</div>
      <div class="ai-info"><div class="ai-name">StudyBot AI</div><div class="ai-status">Online</div></div>
      <button class="ai-close-btn" onclick="toggleAI()">âœ•</button>
    </div>
    <div class="ai-key-row">
      <input class="ai-key-input" id="aiKeyInput" type="password" placeholder="OpenRouter API key (optional â€” sk-or-...)" oninput="saveAIKey()"/>
    </div>
    <div class="ai-messages" id="aiMessages">
      <div class="msg bot"><div class="msg-bubble">ğŸ‘‹ Hi! I'm StudyBot AI. Add your OpenRouter key above for real AI, or I'll use smart local responses. What do you need?</div><div class="msg-time">Now</div></div>
      <div class="typing-indicator" id="typingIndicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>
    </div>
    <div class="ai-chips">
      <button class="ai-chip" onclick="sendChip('What should I focus on today?')">ğŸ¯ Focus today</button>
      <button class="ai-chip" onclick="sendChip('Am I overloaded this week?')">ğŸ“Š Workload</button>
      <button class="ai-chip" onclick="sendChip('Make me a study plan')">ğŸ“… Study plan</button>
      <button class="ai-chip" onclick="sendChip('Show high priority tasks')">ğŸ”´ High priority</button>
    </div>
    <div class="ai-input-row">
      <input class="ai-input" id="aiInput" type="text" placeholder="Ask StudyBot..." onkeydown="if(event.key==='Enter')sendAIMessage()"/>
      <button class="ai-send-btn" onclick="sendAIMessage()">â¤</button>
    </div>
  </aside>
</div><!-- /mainApp -->

<nav class="bottom-nav">
  <div class="bn-items">
    <button class="bn-item active" data-page="dashboard" onclick="navigate('dashboard')"><span class="bn-icon">ğŸ“Š</span>Dash</button>
    <button class="bn-item" data-page="tasks" onclick="navigate('tasks')"><span class="bn-icon">ğŸ“‹</span>Tasks</button>
    <button class="bn-item" data-page="pomodoro" onclick="navigate('pomodoro')"><span class="bn-icon">ğŸ…</span>Pomo</button>
    <button class="bn-item" data-page="goals" onclick="navigate('goals')"><span class="bn-icon">ğŸ¯</span>Goals</button>
    <button class="bn-item" data-page="notes" onclick="navigate('notes')"><span class="bn-icon">ğŸ“</span>Notes</button>
    <button class="bn-item" data-page="timetable" onclick="navigate('timetable')"><span class="bn-icon">ğŸ—“ï¸</span>Time</button>
    <button class="bn-item" onclick="toggleAI()"><span class="bn-icon">ğŸ¤–</span>AI</button>
  </div>
</nav>

<!-- EDIT MODAL -->
<div class="modal-overlay" id="editModal">
  <div class="modal">
    <div class="modal-header"><div class="modal-title">Edit Task</div><button class="modal-close" onclick="closeModal('editModal')">âœ•</button></div>
    <div class="form-group"><label>Title *</label><input type="text" id="editTitle" class="form-input"/></div>
    <div class="form-row">
      <div class="form-group"><label>Subject</label><input type="text" id="editSubject" class="form-input"/></div>
      <div class="form-group"><label>Due Date</label><input type="date" id="editDue" class="form-input"/></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Priority</label><select id="editPriority" class="form-select"><option value="high">High</option><option value="medium">Medium</option><option value="low">Low</option></select></div>
      <div class="form-group"><label>Status</label><select id="editStatus" class="form-select"><option value="pending">Pending</option><option value="in-progress">In Progress</option><option value="completed">Completed</option></select></div>
    </div>
    <div class="form-group"><label>Notes</label><textarea id="editNotes" class="form-textarea"></textarea></div>
    <div style="display:flex;gap:10px;margin-top:8px">
      <button class="btn btn-primary" onclick="saveEdit()">Save Changes</button>
      <button class="btn btn-ghost" onclick="closeModal('editModal')">Cancel</button>
    </div>
  </div>
</div>

<!-- CALENDAR DAY MODAL -->
<div class="modal-overlay" id="calDayModal">
  <div class="modal" style="max-width:420px">
    <div class="modal-header"><div class="modal-title" id="calDayTitle">Tasks on date</div><button class="modal-close" onclick="closeModal('calDayModal')">âœ•</button></div>
    <div id="calDayList"></div>
  </div>
</div>

<!-- SUBTASK MODAL -->
<div class="modal-overlay" id="subtaskModal">
  <div class="modal" style="max-width:480px">
    <div class="modal-header"><div class="modal-title" id="subtaskModalTitle">Task Subtasks</div><button class="modal-close" onclick="closeModal('subtaskModal')">âœ•</button></div>
    <div id="subtaskModalList" class="subtask-modal-list"></div>
    <div class="subtask-add-row">
      <input class="subtask-add-input" id="subtaskAddInput" placeholder="Add new subtask..." onkeydown="if(event.key==='Enter')addSubtaskFromModal()"/>
      <button class="btn btn-primary" onclick="addSubtaskFromModal()">Add</button>
    </div>
    <div style="display:flex;gap:8px;margin-top:12px">
      <button class="btn btn-ghost" style="flex:1" onclick="closeModal('subtaskModal')">Done</button>
      <button class="btn" style="background:rgba(196,91,245,.15);color:var(--acc-p);border:1px solid rgba(196,91,245,.3)" onclick="generateSubtasksInModal()">âœ¨ AI Generate</button>
    </div>
  </div>
</div>

<!-- GOAL MODAL -->
<div class="modal-overlay" id="goalModal">
  <div class="modal">
    <div class="modal-header"><div class="modal-title" id="goalModalTitle">New Goal</div><button class="modal-close" onclick="closeModal('goalModal')">âœ•</button></div>
    <div class="form-group"><label>Goal Title *</label><input type="text" id="goalTitle" class="form-input" placeholder="e.g. Score 90% in Math finals"/></div>
    <div class="form-row">
      <div class="form-group"><label>Target Date</label><input type="date" id="goalDeadline" class="form-input"/></div>
      <div class="form-group"><label>Subject / Category</label><input type="text" id="goalSubject" class="form-input" placeholder="e.g. Mathematics"/></div>
    </div>
    <div class="form-group"><label>Goal Emoji</label>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px" id="goalEmojiPicker">
        <span style="font-size:1.4rem;cursor:pointer;padding:4px" onclick="selectGoalEmoji(this,'ğŸ¯')">ğŸ¯</span>
        <span style="font-size:1.4rem;cursor:pointer;padding:4px" onclick="selectGoalEmoji(this,'ğŸ†')">ğŸ†</span>
        <span style="font-size:1.4rem;cursor:pointer;padding:4px" onclick="selectGoalEmoji(this,'ğŸ“š')">ğŸ“š</span>
        <span style="font-size:1.4rem;cursor:pointer;padding:4px" onclick="selectGoalEmoji(this,'ğŸ§ª')">ğŸ§ª</span>
        <span style="font-size:1.4rem;cursor:pointer;padding:4px" onclick="selectGoalEmoji(this,'ğŸ’»')">ğŸ’»</span>
        <span style="font-size:1.4rem;cursor:pointer;padding:4px" onclick="selectGoalEmoji(this,'âœï¸')">âœï¸</span>
        <span style="font-size:1.4rem;cursor:pointer;padding:4px" onclick="selectGoalEmoji(this,'ğŸŒŸ')">ğŸŒŸ</span>
        <span style="font-size:1.4rem;cursor:pointer;padding:4px" onclick="selectGoalEmoji(this,'ğŸš€')">ğŸš€</span>
        <span style="font-size:1.4rem;cursor:pointer;padding:4px" onclick="selectGoalEmoji(this,'ğŸ’ª')">ğŸ’ª</span>
        <span style="font-size:1.4rem;cursor:pointer;padding:4px" onclick="selectGoalEmoji(this,'ğŸ“')">ğŸ“</span>
      </div>
      <input type="hidden" id="goalEmoji" value="ğŸ¯"/>
    </div>
    <div class="form-group"><label>Milestones (one per line)</label><textarea id="goalMilestones" class="form-textarea" placeholder="Read Chapter 1&#10;Complete practice set&#10;Take mock exam"></textarea></div>
    <div style="display:flex;gap:10px;margin-top:8px">
      <button class="btn btn-primary" onclick="saveGoal()">Save Goal</button>
      <button class="btn btn-ghost" onclick="closeModal('goalModal')">Cancel</button>
    </div>
  </div>
</div>

<!-- ADD CLASS MODAL -->
<div class="modal-overlay" id="addClassModal">
  <div class="modal" style="max-width:420px">
    <div class="modal-header"><div class="modal-title">Add Class to Timetable</div><button class="modal-close" onclick="closeModal('addClassModal')">âœ•</button></div>
    <div class="form-group"><label>Subject Name *</label><input type="text" id="clsName" class="form-input" placeholder="e.g. Mathematics"/></div>
    <div class="form-group"><label>Teacher (optional)</label><input type="text" id="clsTeacher" class="form-input" placeholder="e.g. Mr. Kumar"/></div>
    <div class="form-row">
      <div class="form-group"><label>Day</label>
        <select id="clsDay" class="form-select"><option value="0">Sunday</option><option value="1">Monday</option><option value="2">Tuesday</option><option value="3">Wednesday</option><option value="4">Thursday</option><option value="5">Friday</option><option value="6">Saturday</option></select>
      </div>
      <div class="form-group"><label>Time Slot</label>
        <select id="clsTime" class="form-select"></select>
      </div>
    </div>
    <div class="form-group"><label>Color</label>
      <div style="display:flex;gap:8px;margin-top:6px" id="clsColorPicker"></div>
      <input type="hidden" id="clsColor" value="#5b6ef5"/>
    </div>
    <div style="display:flex;gap:10px;margin-top:8px">
      <button class="btn btn-primary" onclick="saveClass()">Add to Timetable</button>
      <button class="btn btn-ghost" onclick="closeModal('addClassModal')">Cancel</button>
    </div>
  </div>
</div>

<div id="toastContainer"></div>
<div id="sidebarOverlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:140" onclick="closeSidebar()"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â• JAVASCRIPT â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
/* â”€â”€â”€ SHA-256 â”€â”€â”€ */
async function sha256(msg){
  const buf=await crypto.subtle.digest('SHA-256',new TextEncoder().encode(msg));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

/* â”€â”€â”€ STATE â”€â”€â”€ */
let currentUser=null,tasks=[],notifications=[],chatHistory=[],currentFilter='all',editingTaskId=null;
let donutChart=null,barChart=null,perfDonutChart=null,aiOpen=false,sidebarOpen=true;
let calDate=new Date(),upcomingTab='timeline';

/* â”€â”€â”€ POMODORO STATE â”€â”€â”€ */
let pomoMode='focus',pomoRunning=false,pomoTimer=null,pomoSeconds=25*60,pomoTotalSeconds=25*60;
let pomoSessions=0,pomoTodaySessions=0,pomoTodayMins=0;
const POMO_DURATIONS={focus:25*60,short:5*60,long:15*60};

/* â”€â”€â”€ STORAGE â”€â”€â”€ */
const get=k=>{try{return JSON.parse(localStorage.getItem(k))}catch{return null}};
const set=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
const escHtml=s=>String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');

/* â”€â”€â”€ FONTS LIST â”€â”€â”€ */
const FONTS=[
  {id:'grotesk',label:'Cabinet Grotesk',css:"'Cabinet Grotesk',sans-serif"},
  {id:'poppins',label:'Poppins',css:"'Poppins',sans-serif"},
  {id:'montserrat',label:'Montserrat',css:"'Montserrat',sans-serif"},
  {id:'outfit',label:'Outfit',css:"'Outfit',sans-serif"},
  {id:'jakarta',label:'Plus Jakarta Sans',css:"'Plus Jakarta Sans',sans-serif"},
  {id:'lexend',label:'Lexend',css:"'Lexend',sans-serif"},
  {id:'nunito',label:'Nunito',css:"'Nunito',sans-serif"},
  {id:'raleway',label:'Raleway',css:"'Raleway',sans-serif"},
  {id:'quicksand',label:'Quicksand',css:"'Quicksand',sans-serif"},
  {id:'fredoka',label:'Fredoka',css:"'Fredoka',sans-serif"},
  {id:'comfortaa',label:'Comfortaa',css:"'Comfortaa',sans-serif"},
  {id:'josefin',label:'Josefin Sans',css:"'Josefin Sans',sans-serif"},
  {id:'inter',label:'Inter',css:"'Inter',sans-serif"},
  {id:'playfair',label:'Playfair Display',css:"'Playfair Display',serif"},
  {id:'lora',label:'Lora',css:"'Lora',serif"},
  {id:'cinzel',label:'Cinzel',css:"'Cinzel',serif"},
  {id:'orbitron',label:'Orbitron',css:"'Orbitron',sans-serif"},
  {id:'bebas',label:'Bebas Neue',css:"'Bebas Neue',sans-serif"},
  {id:'russo',label:'Russo One',css:"'Russo One',sans-serif"},
  {id:'unbounded',label:'Unbounded',css:"'Unbounded',sans-serif"},
  {id:'mono',label:'DM Mono',css:"'DM Mono',monospace"},
];

/* â”€â”€â”€ INIT â”€â”€â”€ */
window.addEventListener('DOMContentLoaded',()=>{
  buildFontList();
  const pref=get('studybot_prefs')||{};
  if(pref.theme)document.documentElement.setAttribute('data-theme',pref.theme);
  if(pref.font)document.documentElement.setAttribute('data-font',pref.font);
  updateThemeUI();
  // PWA Manifest inject
  injectManifest();
  const session=get('studybot_session');
  if(session){currentUser=session;initApp();}
  // Load pomo stats
  loadPomoStats();
});

function injectManifest(){
  const manifest={name:'StudyBot',short_name:'StudyBot',start_url:'.',display:'standalone',background_color:'#0d0f14',theme_color:'#5b6ef5',icons:[{src:'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">ğŸ¤–</text></svg>',sizes:'any',type:'image/svg+xml'}]};
  const blob=new Blob([JSON.stringify(manifest)],{type:'application/json'});
  document.getElementById('manifestLink').href=URL.createObjectURL(blob);
}

function buildFontList(){
  const fl=document.getElementById('fontList');
  if(!fl)return;
  const cur=document.documentElement.getAttribute('data-font')||'grotesk';
  fl.innerHTML=FONTS.map(f=>`<button class="tp-font-btn${f.id===cur?' active':''}" data-font="${f.id}" onclick="setFont('${f.id}')" style="font-family:${f.css}">${f.label}</button>`).join('');
}

/* â”€â”€â”€ THEME â”€â”€â”€ */
function setTheme(t){
  document.documentElement.setAttribute('data-theme',t);
  const p=get('studybot_prefs')||{};p.theme=t;set('studybot_prefs',p);
  updateThemeUI();if(donutChart)rebuildCharts();
}
function setFont(f){
  document.documentElement.setAttribute('data-font',f);
  const p=get('studybot_prefs')||{};p.font=f;set('studybot_prefs',p);
  document.querySelectorAll('.tp-font-btn').forEach(b=>b.classList.toggle('active',b.dataset.font===f));
}
function updateThemeUI(){
  const t=document.documentElement.getAttribute('data-theme')||'midnight';
  const f=document.documentElement.getAttribute('data-font')||'grotesk';
  document.querySelectorAll('.tp-color').forEach(c=>c.classList.toggle('active',c.dataset.theme===t));
  document.querySelectorAll('.tp-font-btn').forEach(b=>b.classList.toggle('active',b.dataset.font===f));
}
function toggleThemePanel(){
  document.getElementById('themePanel').classList.toggle('show');
  document.getElementById('notifPanel').classList.remove('show');
}

/* â”€â”€â”€ AUTH â”€â”€â”€ */
function showLanding(){document.getElementById('landingPage').style.display='block';document.getElementById('authPage').style.display='none';}
function showAuth(){document.getElementById('landingPage').style.display='none';document.getElementById('authPage').style.display='flex';renderQuickLogins();}
function switchAuthTab(tab){
  document.getElementById('loginTab').classList.toggle('active',tab==='login');
  document.getElementById('registerTab').classList.toggle('active',tab==='register');
  document.getElementById('loginForm').style.display=tab==='login'?'block':'none';
  document.getElementById('registerForm').style.display=tab==='register'?'block':'none';
}
function renderQuickLogins(){
  const users=get('studybot_users')||{};const emails=Object.keys(users);
  const ql=document.getElementById('quickLogins');const chips=document.getElementById('qlChips');
  if(emails.length){ql.style.display='block';chips.innerHTML=emails.map(e=>`<div class="ql-chip" onclick="quickLogin('${escHtml(e)}')">${escHtml(users[e].name)}</div>`).join('');}
}
function quickLogin(email){document.getElementById('loginEmail').value=email;document.getElementById('loginPass').focus();}

async function handleRegister(){
  const name=document.getElementById('regName').value.trim();
  const email=document.getElementById('regEmail').value.trim();
  const pass=document.getElementById('regPass').value;
  let valid=true;
  if(!name){showErr('regNameErr');valid=false;}else hideErr('regNameErr');
  if(!email||!email.includes('@')){showErr('regEmailErr');valid=false;}else hideErr('regEmailErr');
  if(pass.length<6){showErr('regPassErr');document.getElementById('regPassErr').textContent='Password must be at least 6 characters.';valid=false;}else hideErr('regPassErr');
  if(!valid)return;
  const users=get('studybot_users')||{};
  if(users[email]){showErr('regEmailErr');document.getElementById('regEmailErr').textContent='Email already registered.';return;}
  const hash=await sha256(pass);
  users[email]={name,email,passHash:hash,created:Date.now()};
  set('studybot_users',users);
  toast('Account created! Sign in below.','success');
  switchAuthTab('login');
  document.getElementById('loginEmail').value=email;
}

async function handleLogin(){
  const email=document.getElementById('loginEmail').value.trim();
  const pass=document.getElementById('loginPass').value;
  let valid=true;
  if(!email||!email.includes('@')){showErr('loginEmailErr');valid=false;}else hideErr('loginEmailErr');
  if(!pass){showErr('loginPassErr');document.getElementById('loginPassErr').textContent='Password is required.';valid=false;}else hideErr('loginPassErr');
  if(!valid)return;
  const users=get('studybot_users')||{};const user=users[email];
  if(!user){showErr('loginPassErr');document.getElementById('loginPassErr').textContent='Account not found.';return;}
  // Support both old btoa and new SHA-256
  let ok=false;
  if(user.passHash){const hash=await sha256(pass);ok=hash===user.passHash;}
  else if(user.pass){ok=atob(user.pass)===pass;if(ok){const hash=await sha256(pass);user.passHash=hash;delete user.pass;users[email]=user;set('studybot_users',users);}}
  if(!ok){showErr('loginPassErr');document.getElementById('loginPassErr').textContent='Invalid email or password.';return;}
  currentUser={name:user.name,email,loginTime:Date.now()};
  set('studybot_session',currentUser);
  initApp();
}

function handleLogout(){
  localStorage.removeItem('studybot_session');
  currentUser=null;
  document.getElementById('mainApp').classList.remove('app-visible');
  showLanding();toast('Signed out.','info');
}
function showErr(id){const el=document.getElementById(id);if(el)el.style.display='block';}
function hideErr(id){const el=document.getElementById(id);if(el)el.style.display='none';}

/* â”€â”€â”€ APP INIT â”€â”€â”€ */
function initApp(){
  document.getElementById('authPage').style.display='none';
  document.getElementById('landingPage').style.display='none';
  document.getElementById('mainApp').classList.add('app-visible');
  loadUserData();updateUserUI();updateGreeting();navigate('dashboard');checkNotifications();loadChatHistory();loadPomoStats();
  const savedKey=get('studybot_aikey')||'';document.getElementById('aiKeyInput').value=savedKey;
}
function loadUserData(){tasks=get(`tasks_${currentUser.email}`)||[];}
function saveUserData(){set(`tasks_${currentUser.email}`,tasks);}
function loadChatHistory(){
  chatHistory=get(`chat_${currentUser.email}`)||[];
  const msgs=document.getElementById('aiMessages');
  msgs.innerHTML=`<div class="msg bot"><div class="msg-bubble">ğŸ‘‹ Hi ${escHtml(currentUser.name)}! I'm StudyBot AI. Add your OpenRouter API key above for real AI. What do you need help with today?</div><div class="msg-time">Now</div></div><div class="typing-indicator" id="typingIndicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>`;
  chatHistory.forEach(m=>appendMessage(m.role,m.content,false));
}
function saveAIKey(){const k=document.getElementById('aiKeyInput').value.trim();set('studybot_aikey',k);}
function updateUserUI(){
  const init=currentUser.name.charAt(0).toUpperCase();
  document.getElementById('sidebarAv').textContent=init;
  document.getElementById('sidebarName').textContent=currentUser.name;
  document.getElementById('sidebarEmail').textContent=currentUser.email;
}
function updateGreeting(){
  const h=new Date().getHours();
  const g=h<12?'Good morning':h<17?'Good afternoon':'Good evening';
  document.getElementById('greetingText').textContent=`${g}, ${currentUser.name}! ğŸ‘‹`;
}

/* â”€â”€â”€ NAVIGATION â”€â”€â”€ */
function navigate(page){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-item,.bn-item').forEach(n=>n.classList.remove('active'));
  document.getElementById(page+'Page').classList.add('active');
  document.querySelectorAll(`[data-page="${page}"]`).forEach(el=>el.classList.add('active'));
  const titles={dashboard:'Dashboard',tasks:'My Tasks',upcoming:'Upcoming & Calendar',pomodoro:'Pomodoro Timer',performance:'Performance',add:'Add Task'};
  document.getElementById('headerTitle').textContent=titles[page]||'StudyBot';
  if(page==='dashboard')renderDashboard();
  if(page==='tasks')renderTasks();
  if(page==='upcoming'){renderUpcoming();renderCalendar();}
  if(page==='performance')renderPerformance();
  if(page==='pomodoro')renderPomoTaskList();
  if(window.innerWidth<768)closeSidebar();
}

/* â”€â”€â”€ SIDEBAR â”€â”€â”€ */
function toggleSidebar(){
  const s=document.getElementById('sidebar');const o=document.getElementById('sidebarOverlay');
  if(window.innerWidth<768){s.classList.toggle('open');o.style.display=s.classList.contains('open')?'block':'none';}
  else{sidebarOpen=!sidebarOpen;s.style.width=sidebarOpen?'248px':'0';s.style.overflow=sidebarOpen?'visible':'hidden';}
}
function closeSidebar(){document.getElementById('sidebar').classList.remove('open');document.getElementById('sidebarOverlay').style.display='none';}

/* â”€â”€â”€ AI PANEL â”€â”€â”€ */
function toggleAI(){aiOpen=!aiOpen;document.getElementById('mainApp').classList.toggle('ai-open',aiOpen);}

/* â”€â”€â”€ LEADERBOARD â”€â”€â”€ */
function calcScore(email){
  const t=get(`tasks_${email}`)||[];
  const done=t.filter(x=>x.status==='completed').length;
  const highDone=t.filter(x=>x.priority==='high'&&x.status==='completed').length;
  const streak=Object.keys(get(`streak_${email}`)||{}).length;
  return done*10+highDone*5+streak*3;
}
function renderLeaderboard(containerId,limit=5){
  const users=get('studybot_users')||{};
  const entries=Object.entries(users).map(([email,u])=>({name:u.name,email,score:calcScore(email)})).sort((a,b)=>b.score-a.score);
  const el=document.getElementById(containerId);if(!el)return;
  if(!entries.length){el.innerHTML='<div style="color:var(--tx3);font-size:.85rem;text-align:center;padding:12px">No users yet.</div>';return;}
  const shown=limit?entries.slice(0,limit):entries;
  el.innerHTML=shown.map((e,i)=>{
    const isYou=e.email===currentUser.email;
    const rankCls=i===0?'gold':i===1?'silver':i===2?'bronze':'other';
    const medal=i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':i+1;
    return`<div class="lb-item${isYou?' lb-you':''}">
      <div class="lb-rank ${rankCls}">${medal}</div>
      <div class="lb-av" style="background:hsl(${(e.email.charCodeAt(0)*37)%360},60%,55%)">${e.name.charAt(0).toUpperCase()}</div>
      <div class="lb-info"><div class="lb-name">${escHtml(e.name)}${isYou?' <span style="font-size:.65rem;color:var(--acc)">(you)</span>':''}</div><div class="lb-score">Tasks done: ${(get(`tasks_${e.email}`)||[]).filter(x=>x.status==='completed').length}</div></div>
      <div class="lb-pts">${e.score}pts</div>
    </div>`;
  }).join('');
}

/* â”€â”€â”€ TASKS CRUD â”€â”€â”€ */
function submitTask(){
  const title=document.getElementById('taskTitle').value.trim();
  if(!title){showErr('taskTitleErr');return;}hideErr('taskTitleErr');
  const task={id:Date.now().toString(),title,subject:document.getElementById('taskSubject').value.trim(),due:document.getElementById('taskDue').value,priority:document.getElementById('taskPriority').value,status:document.getElementById('taskStatus').value,notes:document.getElementById('taskNotes').value.trim(),subtasks:[],created_at:Date.now(),updated_at:Date.now()};
  tasks.unshift(task);saveUserData();
  toast('Task added! ğŸ‰','success');addNotification(`New task: "${title}"`,'info');resetTaskForm();navigate('tasks');
  // confetti small
  if(typeof confetti!=='undefined')confetti({particleCount:40,spread:60,origin:{y:.8}});
}
function resetTaskForm(){
  ['taskTitle','taskSubject','taskDue','taskNotes'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  document.getElementById('taskPriority').value='medium';document.getElementById('taskStatus').value='pending';
  const r=document.getElementById('aiPrioResult');if(r)r.style.display='none';
}
function deleteTask(id){
  if(!confirm('Delete this task?'))return;
  tasks=tasks.filter(t=>t.id!==id);saveUserData();toast('Task deleted.','info');renderTasks();
}
function toggleComplete(id){
  const t=tasks.find(t=>t.id===id);if(!t)return;
  t.status=t.status==='completed'?'pending':'completed';t.updated_at=Date.now();
  if(t.status==='completed'){
    markStreakToday();addNotification(`âœ… Completed: "${t.title}"`,'success');toast('Task completed! ğŸ‰','success');
    if(typeof confetti!=='undefined')confetti({particleCount:80,spread:70,origin:{y:.7}});
  }
  saveUserData();renderTasks();
}
function openEditModal(id){
  const t=tasks.find(t=>t.id===id);if(!t)return;
  editingTaskId=id;
  document.getElementById('editTitle').value=t.title;document.getElementById('editSubject').value=t.subject||'';
  document.getElementById('editDue').value=t.due||'';document.getElementById('editPriority').value=t.priority;
  document.getElementById('editStatus').value=t.status;document.getElementById('editNotes').value=t.notes||'';
  document.getElementById('editModal').classList.add('show');
}
function saveEdit(){
  const t=tasks.find(t=>t.id===editingTaskId);if(!t)return;
  const title=document.getElementById('editTitle').value.trim();if(!title)return;
  t.title=title;t.subject=document.getElementById('editSubject').value.trim();t.due=document.getElementById('editDue').value;
  t.priority=document.getElementById('editPriority').value;t.status=document.getElementById('editStatus').value;
  t.notes=document.getElementById('editNotes').value.trim();t.updated_at=Date.now();
  saveUserData();closeModal('editModal');toast('Task updated!','success');renderTasks();
}
function closeModal(id){document.getElementById(id).classList.remove('show');}
document.getElementById('editModal').addEventListener('click',e=>{if(e.target.id==='editModal')closeModal('editModal');});
document.getElementById('calDayModal').addEventListener('click',e=>{if(e.target.id==='calDayModal')closeModal('calDayModal');});
document.addEventListener('keydown',e=>{if(e.key==='Escape'){closeModal('editModal');closeModal('calDayModal');document.getElementById('themePanel').classList.remove('show');document.getElementById('notifPanel').classList.remove('show');}});

/* â”€â”€â”€ FILTER & SORT â”€â”€â”€ */
function setFilter(f,el){currentFilter=f;document.querySelectorAll('.fc').forEach(b=>b.classList.remove('active'));el.classList.add('active');renderTasks();}
function getFilteredTasks(){
  const search=(document.getElementById('taskSearch')?.value||'').toLowerCase();
  const sort=document.getElementById('sortSelect')?.value||'newest';
  let filtered=tasks.filter(t=>{
    const matchSearch=!search||t.title.toLowerCase().includes(search)||(t.subject||'').toLowerCase().includes(search)||(t.notes||'').toLowerCase().includes(search);
    let matchFilter=true;
    if(currentFilter==='completed')matchFilter=t.status==='completed';
    else if(currentFilter==='overdue')matchFilter=isOverdue(t);
    else if(currentFilter!=='all')matchFilter=t.priority===currentFilter;
    return matchSearch&&matchFilter;
  });
  const pOrder={high:0,medium:1,low:2};
  switch(sort){
    case'oldest':filtered.sort((a,b)=>a.created_at-b.created_at);break;
    case'due':filtered.sort((a,b)=>{if(!a.due&&!b.due)return 0;if(!a.due)return 1;if(!b.due)return-1;return new Date(a.due)-new Date(b.due);});break;
    case'priority':filtered.sort((a,b)=>(pOrder[a.priority]||1)-(pOrder[b.priority]||1));break;
    case'subject':filtered.sort((a,b)=>(a.subject||'').localeCompare(b.subject||''));break;
    case'az':filtered.sort((a,b)=>a.title.localeCompare(b.title));break;
    default:filtered.sort((a,b)=>b.created_at-a.created_at);
  }
  return filtered;
}
function isOverdue(t){if(!t.due||t.status==='completed')return false;return new Date(t.due)<new Date(new Date().toDateString());}

/* â”€â”€â”€ RENDER TASKS â”€â”€â”€ */
function renderTasks(){
  const grid=document.getElementById('tasksGrid');const filtered=getFilteredTasks();
  if(!filtered.length){grid.innerHTML=`<div class="empty-state" style="grid-column:1/-1"><div class="es-icon">ğŸ“‹</div><div class="es-title">No tasks found</div><div class="es-sub">Adjust filters or add a new task.</div></div>`;return;}
  grid.innerHTML=filtered.map(t=>{
    const overdue=isOverdue(t);
    const pCls=`pill pill-${t.priority}`;const sCls=`pill pill-${overdue?'overdue':t.status}`;
    const sLabel=overdue?'âš  Overdue':t.status==='in-progress'?'In Progress':t.status==='completed'?'Completed':'Pending';
    const dueStr=t.due?`ğŸ“… ${new Date(t.due+'T00:00:00').toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'})}`:'';
    const subtasksHtml=t.subtasks?.length?`<div class="subtasks-wrap">${t.subtasks.map((st,i)=>`<div class="subtask-item" onclick="toggleSubtask('${t.id}',${i})"><div class="subtask-cb${st.done?' checked':''}">${st.done?'âœ“':''}</div><span class="subtask-txt${st.done?' checked':''}">${escHtml(st.text)}</span></div>`).join('')}</div>`:'';
    return`<div class="task-card tc-${t.priority}${overdue?' tc-overdue':''}">
      <div class="tc-header">
        <div class="tc-title${t.status==='completed'?' completed-title':''}">${escHtml(t.title)}</div>
        <div class="tc-actions">
          <button class="icon-btn complete-btn" onclick="toggleComplete('${t.id}')" title="${t.status==='completed'?'Mark pending':'Mark complete'}">${t.status==='completed'?'â†©':'âœ“'}</button>
          <button class="icon-btn" onclick="openEditModal('${t.id}')" title="Edit">âœ</button>
          <button class="icon-btn delete-btn" onclick="deleteTask('${t.id}')" title="Delete">âœ•</button>
        </div>
      </div>
      <div class="tc-meta">
        <span class="${pCls}">${t.priority}</span>
        <span class="${sCls}">${sLabel}</span>
        ${t.subject?`<span class="tc-subject">ğŸ“š ${escHtml(t.subject)}</span>`:''}
      </div>
      ${t.due?`<div class="tc-due${overdue?' overdue':''}">${dueStr}</div>`:''}
      ${t.notes?`<div class="tc-desc">${escHtml(t.notes)}</div>`:''}
      ${subtasksHtml}
      <div class="tc-footer">
        <span style="font-size:.72rem;color:var(--tx4)">${new Date(t.updated_at).toLocaleDateString()}</span>
        <div style="display:flex;gap:4px">
          <button class="pomo-btn" onclick="startPomoForTask('${t.id}')">ğŸ…</button>
          <button class="ai-subtask-btn" onclick="openSubtaskModal('${t.id}')">âœ¨ Subtasks</button>
        </div>
      </div>
    </div>`;
  }).join('');
}
function toggleSubtask(taskId,idx){
  const t=tasks.find(t=>t.id===taskId);if(!t||!t.subtasks[idx])return;
  t.subtasks[idx].done=!t.subtasks[idx].done;t.updated_at=Date.now();saveUserData();renderTasks();
}

/* â”€â”€â”€ DASHBOARD â”€â”€â”€ */
function renderDashboard(){
  const total=tasks.length,done=tasks.filter(t=>t.status==='completed').length;
  const pending=tasks.filter(t=>t.status==='pending').length,inProg=tasks.filter(t=>t.status==='in-progress').length;
  const high=tasks.filter(t=>t.priority==='high'&&t.status!=='completed').length,overdue=tasks.filter(isOverdue).length;
  const pct=total?Math.round((done/total)*100):0;
  document.getElementById('kpiGrid').innerHTML=[
    {cls:'k-total',icon:'ğŸ“‹',val:total,label:'Total Tasks'},
    {cls:'k-done',icon:'âœ…',val:done,label:'Completed'},
    {cls:'k-pending',icon:'â³',val:pending,label:'Pending'},
    {cls:'k-progress',icon:'ğŸ”„',val:inProg,label:'In Progress'},
    {cls:'k-high',icon:'ğŸ”´',val:high,label:'High Priority'},
    {cls:'k-overdue',icon:'âš ï¸',val:overdue,label:'Overdue'},
  ].map(k=>`<div class="kpi-card ${k.cls}"><div class="kpi-icon">${k.icon}</div><div class="kpi-val">${k.val}</div><div class="kpi-label">${k.label}</div></div>`).join('');
  const ring=document.getElementById('ringFg');
  ring.style.strokeDashoffset=251-(pct/100)*251;
  document.getElementById('ringPct').textContent=pct+'%';
  const recent=[...tasks].sort((a,b)=>b.updated_at-a.updated_at).slice(0,6);
  const rl=document.getElementById('recentList');
  const recentHtml=recent.map(t=>{
    const col=t.priority==='high'?'var(--acc-r)':t.priority==='medium'?'var(--acc-y)':'var(--acc-g)';
    return`<div class="recent-item"><div class="ri-dot" style="background:${col}"></div><div class="ri-info"><div class="ri-title">${escHtml(t.title)}</div><div class="ri-sub">${t.subject||'No subject'} Â· ${new Date(t.updated_at).toLocaleDateString()}</div></div><span class="pill pill-${t.status==='completed'?'completed':t.status==='in-progress'?'in-progress':'pending'}">${t.status}</span></div>`;
  }).join('')||'<div style="color:var(--tx3);font-size:.875rem;padding:12px 0">No tasks yet. Add your first task!</div>';
  rl.innerHTML=`<div style="font-weight:700;font-size:.9rem;margin-bottom:12px;color:var(--tx2)">Recent Activity</div>${recentHtml}`;
  rebuildCharts();renderStreak();renderLeaderboard('lbMini',5);
}

function rebuildCharts(){
  const done=tasks.filter(t=>t.status==='completed').length;
  const inProg=tasks.filter(t=>t.status==='in-progress').length;
  const pending=tasks.filter(t=>t.status==='pending').length;
  const cs=getComputedStyle(document.documentElement);
  const acc=cs.getPropertyValue('--acc').trim(),accG=cs.getPropertyValue('--acc-g').trim(),accY=cs.getPropertyValue('--acc-y').trim(),bg4=cs.getPropertyValue('--bg4').trim(),tx2=cs.getPropertyValue('--tx2').trim();
  if(donutChart)donutChart.destroy();
  const dc=document.getElementById('donutChart');
  if(dc)donutChart=new Chart(dc,{type:'doughnut',data:{labels:['Completed','In Progress','Pending'],datasets:[{data:[done,inProg,pending],backgroundColor:[accG,acc,bg4],borderWidth:0,hoverOffset:6}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{color:tx2,padding:14,font:{size:12}}}}}});
}

/* â”€â”€â”€ STREAK â”€â”€â”€ */
function markStreakToday(){
  const key=`streak_${currentUser.email}`;const streak=get(key)||{};streak[new Date().toDateString()]=true;set(key,streak);
}
function renderStreak(){
  const streak=get(`streak_${currentUser.email}`)||{};
  const days=[];
  for(let i=6;i>=0;i--){
    const d=new Date();d.setDate(d.getDate()-i);
    const key=d.toDateString();const active=!!streak[key];const today=i===0;
    days.push({key,active,today,label:d.toLocaleDateString('en',{weekday:'short'}).slice(0,2),day:d.getDate()});
  }
  document.getElementById('streakCount').textContent=Object.keys(streak).length;
  document.getElementById('streakDots').innerHTML=days.map(d=>`<div class="s-dot${d.active?' active':''}${d.today?' today':''}"><span style="font-size:.6rem">${d.label}</span><span>${d.day}</span></div>`).join('');
}

/* â”€â”€â”€ UPCOMING â”€â”€â”€ */
function switchUpcomingTab(tab){
  upcomingTab=tab;
  document.getElementById('tabTimeline').classList.toggle('active',tab==='timeline');
  document.getElementById('tabCalendar').classList.toggle('active',tab==='calendar');
  document.getElementById('timelineView').style.display=tab==='timeline'?'block':'none';
  document.getElementById('calendarView').style.display=tab==='calendar'?'block':'none';
  if(tab==='calendar')renderCalendar();
}
function renderUpcoming(){
  const today=new Date();const in14=new Date(Date.now()+14*86400000);
  const upcoming=tasks.filter(t=>{
    if(!t.due||t.status==='completed')return false;
    const d=new Date(t.due+'T00:00:00');return d<=in14;
  }).sort((a,b)=>new Date(a.due)-new Date(b.due));
  const tl=document.getElementById('upcomingTimeline');
  if(!upcoming.length){tl.innerHTML=`<div class="empty-state"><div class="es-icon">ğŸ“…</div><div class="es-title">All clear!</div><div class="es-sub">No upcoming deadlines in the next 14 days.</div></div>`;return;}
  tl.innerHTML=upcoming.map(t=>{
    const d=new Date(t.due+'T00:00:00');const ov=d<today;const tod=d.toDateString()===today.toDateString();
    const dotCls=ov?'overdue':tod?'today':'';
    const dateLabel=ov?'âš  Overdue':tod?'ğŸ“ Today':d.toLocaleDateString('en-GB',{weekday:'long',day:'numeric',month:'long'});
    return`<div class="tl-item"><div class="tl-dot ${dotCls}"></div><div class="tl-content"><div class="tl-date">${dateLabel}</div><div class="tl-title">${escHtml(t.title)}</div><div class="tl-meta"><span class="pill pill-${t.priority}">${t.priority}</span>${t.subject?`<span style="font-size:.78rem;color:var(--tx3)">ğŸ“š ${escHtml(t.subject)}</span>`:''}</div></div></div>`;
  }).join('');
}

/* â”€â”€â”€ CALENDAR â”€â”€â”€ */
function renderCalendar(){
  const y=calDate.getFullYear(),m=calDate.getMonth();
  document.getElementById('calMonth').textContent=calDate.toLocaleDateString('en-GB',{month:'long',year:'numeric'});
  const first=new Date(y,m,1);const last=new Date(y,m+1,0);
  const today=new Date();const todayStr=today.toDateString();
  let html='';
  // Leading blank days
  for(let i=0;i<first.getDay();i++)html+=`<div class="cal-day other-month"></div>`;
  // Actual days
  for(let d=1;d<=last.getDate();d++){
    const date=new Date(y,m,d);const dateStr=date.toISOString().split('T')[0];
    const dayTasks=tasks.filter(t=>t.due===dateStr&&t.status!=='completed');
    const isToday=date.toDateString()===todayStr;
    const hasTasks=dayTasks.length>0;
    const dots=dayTasks.slice(0,3).map(t=>`<div class="cal-task-mini"><span class="cal-task-dot ${t.priority}"></span>${escHtml(t.title)}</div>`).join('');
    html+=`<div class="cal-day${isToday?' today':''}${hasTasks?' has-tasks':''}" onclick="showCalDay('${dateStr}','${escHtml(date.toLocaleDateString('en-GB',{weekday:'long',day:'numeric',month:'long',year:'numeric'}))}')">
      <div class="cal-day-num">${d}</div>${dots}
    </div>`;
  }
  document.getElementById('calDays').innerHTML=html;
}
function calNav(dir){calDate=new Date(calDate.getFullYear(),calDate.getMonth()+dir,1);renderCalendar();}
function showCalDay(dateStr,label){
  const dayTasks=tasks.filter(t=>t.due===dateStr);
  document.getElementById('calDayTitle').textContent=label;
  const list=document.getElementById('calDayList');
  if(!dayTasks.length){list.innerHTML='<div class="empty-state" style="padding:28px"><div class="es-icon">ğŸ“…</div><div class="es-title">No tasks</div></div>';document.getElementById('calDayModal').classList.add('show');return;}
  list.innerHTML=dayTasks.map(t=>`<div style="display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border)">
    <span class="pill pill-${t.priority}">${t.priority}</span>
    <span style="flex:1;font-weight:600;font-size:.875rem">${escHtml(t.title)}</span>
    <span class="pill pill-${t.status==='completed'?'completed':t.status==='in-progress'?'in-progress':'pending'}">${t.status}</span>
  </div>`).join('');
  document.getElementById('calDayModal').classList.add('show');
}

/* â”€â”€â”€ PERFORMANCE â”€â”€â”€ */
function renderPerformance(){
  const total=tasks.length,done=tasks.filter(t=>t.status==='completed').length;
  const highDone=tasks.filter(t=>t.priority==='high'&&t.status==='completed').length;
  const highTotal=tasks.filter(t=>t.priority==='high').length;
  const completionRate=total?Math.round((done/total)*100):0;
  const grade=completionRate>=90?'A+':completionRate>=80?'A':completionRate>=70?'B':completionRate>=60?'C':'D';
  const pomoStats=get(`pomo_${currentUser.email}`)||{};
  const totalPomoMins=pomoStats.totalMins||0;
  document.getElementById('perfGrid').innerHTML=[
    {val:`${completionRate}%`,label:'Completion Rate'},
    {val:`${highDone}/${highTotal}`,label:'High Priority Done'},
    {val:grade,label:'Overall Grade'},
    {val:`${totalPomoMins}m`,label:'Pomodoro Mins'},
  ].map(s=>`<div class="perf-stat card"><div class="perf-val">${s.val}</div><div class="perf-label">${s.label}</div></div>`).join('');

  // Subject bars
  const subjects={};tasks.forEach(t=>{const s=t.subject||'General';if(!subjects[s])subjects[s]={total:0,done:0};subjects[s].total++;if(t.status==='completed')subjects[s].done++;});
  const sb=document.getElementById('subjectBars');
  sb.innerHTML=`<div class="chart-title" style="margin-bottom:12px">Subject Progress</div>`+(Object.keys(subjects).length?Object.entries(subjects).map(([s,v])=>{const pct=Math.round((v.done/v.total)*100);return`<div class="subject-bar-item"><div class="sb-header"><span>${escHtml(s)}</span><span>${v.done}/${v.total} (${pct}%)</span></div><div class="sb-track"><div class="sb-fill" style="width:${pct}%"></div></div></div>`;}).join(''):'<div style="color:var(--tx3);font-size:.875rem">No subjects yet.</div>');

  // Heatmap
  const streak=get(`streak_${currentUser.email}`)||{};
  const hm=document.getElementById('heatmap');
  const cells=[];
  for(let i=27;i>=0;i--){const d=new Date(Date.now()-i*86400000);const key=d.toDateString();const hasDone=tasks.some(t=>t.status==='completed'&&new Date(t.updated_at).toDateString()===key);const lvl=streak[key]||hasDone?(hasDone?3:1):0;cells.push(`<div class="hm-cell hm-${lvl}" title="${d.toLocaleDateString()}" style="animation-delay:${(27-i)*.02}s"></div>`);}
  hm.innerHTML=cells.join('');

  // Charts
  const cs=getComputedStyle(document.documentElement);
  const acc=cs.getPropertyValue('--acc').trim(),accG=cs.getPropertyValue('--acc-g').trim(),accY=cs.getPropertyValue('--acc-y').trim(),accR=cs.getPropertyValue('--acc-r').trim(),tx3=cs.getPropertyValue('--tx3').trim(),bg4=cs.getPropertyValue('--bg4').trim();
  const weeks=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  const weekCounts=weeks.map((_,i)=>{const d=new Date();const diff=((i+1)-d.getDay()+7)%7;const td=new Date(d.getTime()-((6-diff)*86400000));return tasks.filter(t=>t.status==='completed'&&new Date(t.updated_at).toDateString()===td.toDateString()).length;});
  if(barChart)barChart.destroy();
  const bc=document.getElementById('barChart');
  if(bc)barChart=new Chart(bc,{type:'bar',data:{labels:weeks,datasets:[{label:'Completed',data:weekCounts,backgroundColor:acc+'80',borderColor:acc,borderWidth:2,borderRadius:6}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:{color:tx3},grid:{color:'transparent'}},y:{ticks:{color:tx3,stepSize:1},grid:{color:bg4+'80'}}}}});

  // Priority donut
  const h=tasks.filter(t=>t.priority==='high').length,med=tasks.filter(t=>t.priority==='medium').length,lo=tasks.filter(t=>t.priority==='low').length;
  if(perfDonutChart)perfDonutChart.destroy();
  const pd=document.getElementById('perfDonut');
  if(pd)perfDonutChart=new Chart(pd,{type:'doughnut',data:{labels:['High','Medium','Low'],datasets:[{data:[h,med,lo],backgroundColor:[accR,accY,accG],borderWidth:0,hoverOffset:6}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{color:cs.getPropertyValue('--tx2').trim(),padding:10,font:{size:11}}}}}});

  renderLeaderboard('lbFull',0);
}

/* â”€â”€â”€ POMODORO â”€â”€â”€ */
function setPomoMode(mode){
  if(pomoRunning)return;
  pomoMode=mode;pomoSeconds=POMO_DURATIONS[mode];pomoTotalSeconds=POMO_DURATIONS[mode];
  document.querySelectorAll('.pomo-mode-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById(`pm${mode.charAt(0).toUpperCase()+mode.slice(1)}`).classList.add('active');
  updatePomoDisplay();
  const wrap=document.getElementById('pomoRingWrap');
  wrap.classList.remove('pomo-running','pomo-break-running');
  const fg=document.getElementById('pomoFg');fg.style.stroke=mode==='focus'?'var(--acc)':'var(--acc-g)';
}
function togglePomo(){
  if(pomoRunning){clearInterval(pomoTimer);pomoRunning=false;document.getElementById('pomoPlayBtn').textContent='â–¶';document.getElementById('pomoRingWrap').classList.remove('pomo-running','pomo-break-running');}
  else{pomoRunning=true;document.getElementById('pomoPlayBtn').textContent='â¸';const wrap=document.getElementById('pomoRingWrap');wrap.classList.add(pomoMode==='focus'?'pomo-running':'pomo-break-running');pomoTimer=setInterval(tickPomo,1000);}
}
function tickPomo(){
  if(pomoSeconds<=0){clearInterval(pomoTimer);pomoRunning=false;pomoComplete();return;}
  pomoSeconds--;updatePomoDisplay();
}
function pomoComplete(){
  document.getElementById('pomoPlayBtn').textContent='â–¶';
  document.getElementById('pomoRingWrap').classList.remove('pomo-running','pomo-break-running');
  if(pomoMode==='focus'){
    pomoSessions++;
    const today=new Date().toDateString();const stats=get(`pomo_${currentUser.email}`)||{};
    if(stats.lastDay!==today){stats.todaySessions=0;stats.todayMins=0;stats.lastDay=today;}
    stats.todaySessions=(stats.todaySessions||0)+1;
    stats.todayMins=(stats.todayMins||0)+25;
    stats.totalMins=(stats.totalMins||0)+25;
    stats.totalSessions=(stats.totalSessions||0)+1;
    set(`pomo_${currentUser.email}`,stats);
    toast('ğŸ… Focus session done! Time for a break.','success');
    if(typeof confetti!=='undefined')confetti({particleCount:60,spread:50,origin:{y:.7}});
    markStreakToday();loadPomoStats();
    setPomoMode(pomoSessions%4===0?'long':'short');
  }else{
    toast('â˜€ï¸ Break over! Ready to focus?','info');setPomoMode('focus');
  }
  renderTomatoes();
}
function resetPomo(){clearInterval(pomoTimer);pomoRunning=false;document.getElementById('pomoPlayBtn').textContent='â–¶';document.getElementById('pomoRingWrap').classList.remove('pomo-running','pomo-break-running');pomoSeconds=POMO_DURATIONS[pomoMode];pomoTotalSeconds=POMO_DURATIONS[pomoMode];updatePomoDisplay();}
function skipPomo(){resetPomo();pomoComplete();}
function updatePomoDisplay(){
  const m=Math.floor(pomoSeconds/60).toString().padStart(2,'0');const s=(pomoSeconds%60).toString().padStart(2,'0');
  document.getElementById('pomoTime').textContent=`${m}:${s}`;
  const progress=(pomoTotalSeconds-pomoSeconds)/pomoTotalSeconds;const circumference=2*Math.PI*110;
  document.getElementById('pomoFg').style.strokeDashoffset=circumference*(1-progress);
  document.getElementById('pomoModeLabel').textContent=pomoMode==='focus'?'FOCUS':pomoMode==='short'?'SHORT BREAK':'LONG BREAK';
}
function renderTomatoes(){
  const count=pomoSessions%4||4;
  document.getElementById('pomoTomatoes').innerHTML=Array.from({length:4},(_,i)=>`<div class="pomo-tomato${i<count?' done':''}">ğŸ…</div>`).join('');
}
function loadPomoStats(){
  const stats=get(`pomo_${currentUser.email}`)||{};const today=new Date().toDateString();
  const todayMins=stats.lastDay===today?(stats.todayMins||0):0;
  const todaySessions=stats.lastDay===today?(stats.todaySessions||0):0;
  const el1=document.getElementById('pomoTotalSessions');const el2=document.getElementById('pomoTotalMins');const el3=document.getElementById('pomoLongestStreak');
  if(el1)el1.textContent=todaySessions;if(el2)el2.textContent=todayMins;if(el3)el3.textContent=stats.totalSessions||0;
  renderTomatoes();
}
function renderPomoTaskList(){
  const sel=document.getElementById('pomoTaskSelect');if(!sel)return;
  const pending=tasks.filter(t=>t.status!=='completed');
  sel.innerHTML='<option value="">â€” Select a task â€”</option>'+pending.map(t=>`<option value="${t.id}">${escHtml(t.title)}</option>`).join('');
  loadPomoStats();
}
function startPomoForTask(taskId){
  navigate('pomodoro');
  setTimeout(()=>{const sel=document.getElementById('pomoTaskSelect');if(sel)sel.value=taskId;},100);
}

/* â”€â”€â”€ NOTIFICATIONS â”€â”€â”€ */
function loadNotifications(){notifications=get(`notifs_${currentUser.email}`)||[];}
function saveNotifications(){if(notifications.length>30)notifications=notifications.slice(-30);set(`notifs_${currentUser.email}`,notifications);}
function addNotification(title,type='info'){if(!currentUser)return;loadNotifications();notifications.unshift({id:Date.now().toString(),title,type,time:Date.now(),read:false});saveNotifications();updateNotifBadge();}
function checkNotifications(){
  if(!currentUser)return;loadNotifications();const today=new Date().toDateString();const tomorrow=new Date(Date.now()+86400000).toDateString();
  tasks.forEach(t=>{if(!t.due||t.status==='completed')return;const due=new Date(t.due+'T00:00:00').toDateString();const existing=notifications.find(n=>n.title.includes(t.title)&&n.time>Date.now()-86400000);
  if(!existing){if(due===today)addNotification(`ğŸ“ Due today: "${t.title}"`,'warn');else if(due===tomorrow)addNotification(`â° Due tomorrow: "${t.title}"`,'warn');else if(isOverdue(t))addNotification(`âš ï¸ Overdue: "${t.title}"`,'error');}});
  updateNotifBadge();renderNotifPanel();
}
function updateNotifBadge(){
  loadNotifications();const unread=notifications.filter(n=>!n.read).length;
  const badge=document.getElementById('notifBadge');badge.textContent=unread>9?'9+':unread;badge.classList.toggle('show',unread>0);
}
function renderNotifPanel(){
  const list=document.getElementById('npList');
  if(!notifications.length){list.innerHTML='<div class="np-empty">No notifications</div>';return;}
  list.innerHTML=notifications.slice(0,15).map(n=>`<div class="np-item${n.read?'':' unread'}"><div class="np-item-title">${escHtml(n.title)}</div><div class="np-item-sub">${new Date(n.time).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div></div>`).join('');
}
function toggleNotifPanel(){
  loadNotifications();notifications.forEach(n=>n.read=true);saveNotifications();updateNotifBadge();renderNotifPanel();
  document.getElementById('notifPanel').classList.toggle('show');document.getElementById('themePanel').classList.remove('show');
}
function clearNotifs(){notifications=[];saveNotifications();updateNotifBadge();renderNotifPanel();document.getElementById('notifPanel').classList.remove('show');}

/* â”€â”€â”€ TOAST â”€â”€â”€ */
function toast(msg,type='info'){
  const t=document.createElement('div');t.className=`toast ${type}`;
  t.innerHTML=`<span>${type==='success'?'âœ…':type==='error'?'âŒ':'â„¹ï¸'}</span><span>${escHtml(msg)}</span>`;
  document.getElementById('toastContainer').appendChild(t);
  setTimeout(()=>{t.style.animation='toastOut .3s ease forwards';setTimeout(()=>t.remove(),300);},3000);
}

/* â”€â”€â”€ AI CHAT â”€â”€â”€ */
function sendChip(msg){document.getElementById('aiInput').value=msg;sendAIMessage();}
async function sendAIMessage(){
  const input=document.getElementById('aiInput');const msg=input.value.trim();if(!msg)return;
  input.value='';appendMessage('user',msg,true);chatHistory.push({role:'user',content:msg});showTyping(true);
  try{
    const taskSummary=tasks.map(t=>`- "${t.title}" [${t.priority}/${t.status}]${t.due?' due '+t.due:''}`).join('\n')||'No tasks yet.';
    const systemPrompt=`You are StudyBot AI, a smart, motivating study assistant. User: ${currentUser.name}. Tasks:\n${taskSummary}\nGive concise helpful answers under 120 words. Be encouraging.`;
    let replyText='';
    const apiKey=get('studybot_aikey')||'';
    if(apiKey&&apiKey.startsWith('sk-or-')){
      try{
        const res=await fetch('https://openrouter.ai/api/v1/chat/completions',{method:'POST',headers:{'Authorization':'Bearer '+apiKey,'Content-Type':'application/json','HTTP-Referer':'https://studybot.app','X-Title':'StudyBot'},body:JSON.stringify({model:'mistralai/mistral-7b-instruct:free',messages:[{role:'system',content:systemPrompt},...chatHistory.slice(-8).map(m=>({role:m.role==='bot'?'assistant':m.role,content:m.content}))],max_tokens:200})});
        if(res.ok){const d=await res.json();replyText=d.choices?.[0]?.message?.content||'';}
      }catch(e){}
    }
    if(!replyText){
      try{
        const res=await fetch('/api/ai/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:msg,history:chatHistory.slice(-6),system:systemPrompt})});
        if(res.ok){const data=await res.json();replyText=data.reply||data.content||'';}
      }catch(e){}
    }
    if(!replyText)replyText=localAIReply(msg);
    showTyping(false);appendMessage('bot',replyText,true);chatHistory.push({role:'bot',content:replyText});
    if(chatHistory.length>20)chatHistory=chatHistory.slice(-20);
    set(`chat_${currentUser.email}`,chatHistory);
  }catch(e){showTyping(false);appendMessage('bot','âš ï¸ Error. '+localAIReply(msg),true);}
}
function localAIReply(msg){
  const m=msg.toLowerCase();const high=tasks.filter(t=>t.priority==='high'&&t.status!=='completed');
  const overdue=tasks.filter(isOverdue);const done=tasks.filter(t=>t.status==='completed').length;const total=tasks.length;
  if(m.includes('focus')||m.includes('today')){if(overdue.length)return`âš ï¸ You have ${overdue.length} overdue task(s)! Start with: "${overdue[0].title}".`;if(high.length)return`ğŸ¯ Focus on "${high[0].title}" â€” it's high priority. You've got this!`;return`âœ… No urgent tasks! Keep your momentum going.`;}
  if(m.includes('overload')||m.includes('stress')){const pending=tasks.filter(t=>t.status!=='completed').length;return pending>10?`You have ${pending} open tasks â€” heavy load! Break it into 3-4 tasks per day sessions.`:`${pending} open tasks â€” manageable! Prioritise high items first.`;}
  if(m.includes('plan')||m.includes('schedule'))return`ğŸ“… Study plan: Morning â†’ hardest task. Afternoon â†’ medium work. Evening â†’ review & plan tomorrow. Aim for 3-4 tasks/day with Pomodoro sessions!`;
  if(m.includes('high priority')||m.includes('urgent'))return high.length?`ğŸ”´ High priority: ${high.map(t=>`"${t.title}"`).join(', ')}. Start with the first one!`:'âœ… Great â€” no high priority tasks pending!';
  if(m.includes('progress')||m.includes('how am i'))return total?`ğŸ“Š You've completed ${done}/${total} tasks (${Math.round(done/total*100)}%). ${done>=total*.7?'Excellent work! ğŸŒŸ':'Keep pushing! ğŸ’ª'}`:'Add your first task to start tracking!';
  if(m.includes('pomo')||m.includes('timer'))return`ğŸ… Use the Pomodoro timer! 25 minutes focus â†’ 5 min break. After 4 sessions, take a 15-min long break. Find it in the sidebar!`;
  return`I'm here to help! Ask about your tasks, study plans, focus tips, or workload. Add your OpenRouter key above for real AI responses! ğŸ¤–`;
}
function appendMessage(role,content,save){
  const msgs=document.getElementById('aiMessages');const typing=document.getElementById('typingIndicator');
  const div=document.createElement('div');div.className=`msg ${role}`;
  div.innerHTML=`<div class="msg-bubble">${escHtml(content)}</div><div class="msg-time">${new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div>`;
  msgs.insertBefore(div,typing);msgs.scrollTop=msgs.scrollHeight;
}
function showTyping(show){document.getElementById('typingIndicator').style.display=show?'flex':'none';}

/* â”€â”€â”€ AI PRIORITY & SUBTASKS â”€â”€â”€ */
async function aiSuggestPriority(){
  const title=document.getElementById('taskTitle').value.trim();if(!title){toast('Enter a title first!','error');return;}
  const btn=document.querySelector('.ai-prio-btn');btn.textContent='â³...';btn.disabled=true;
  await new Promise(r=>setTimeout(r,500));
  const m=title.toLowerCase();
  const prio=(m.includes('exam')||m.includes('deadline')||m.includes('urgent')||m.includes('submit')||m.includes('final')||m.includes('due'))?'high':(m.includes('review')||m.includes('read')||m.includes('practice')||m.includes('prepare')||m.includes('study'))?'medium':'low';
  document.getElementById('taskPriority').value=prio;
  const result=document.getElementById('aiPrioResult');result.style.display='inline';result.textContent=`â†’ ${prio}`;
  btn.textContent='âœ¨ AI Suggest';btn.disabled=false;toast(`AI suggested: ${prio} priority!`,'success');
}
async function generateSubtasks(taskId){
  const t=tasks.find(t=>t.id===taskId);if(!t)return;toast('Generating subtasks...','info');
  await new Promise(r=>setTimeout(r,500));
  const m=t.title.toLowerCase();let subtasks=[];
  if(m.includes('essay')||m.includes('report')||m.includes('write'))subtasks=['Research the topic','Create an outline','Write the first draft','Proofread and edit','Submit final version'];
  else if(m.includes('math')||m.includes('calculus')||m.includes('algebra'))subtasks=['Review relevant formulas','Solve practice problems','Check answers','Summarise key methods'];
  else if(m.includes('code')||m.includes('program')||m.includes('project'))subtasks=['Plan architecture','Set up environment','Implement core features','Write tests','Review & debug'];
  else if(m.includes('study')||m.includes('revise')||m.includes('review'))subtasks=['Gather notes','Read through material','Make summary notes','Test yourself'];
  else subtasks=['Understand requirements','Research resources','Create action plan','Complete the work','Review before submitting'];
  t.subtasks=subtasks.map(text=>({text,done:false}));t.updated_at=Date.now();saveUserData();renderTasks();toast(`Generated ${subtasks.length} subtasks! ğŸ‰`,'success');
}

/* â”€â”€â”€ EXPORT / IMPORT â”€â”€â”€ */
function exportJSON(){
  const data={exported:new Date().toISOString(),user:currentUser.name,tasks};
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`studybot_tasks_${currentUser.name.replace(/\s/g,'_')}_${new Date().toISOString().split('T')[0]}.json`;a.click();URL.revokeObjectURL(a.href);
  toast('Tasks exported as JSON! ğŸ“¦','success');
}
async function exportPDF(){
  if(typeof window.jspdf==='undefined'){toast('PDF library loading...','info');return;}
  const{jsPDF}=window.jspdf;const doc=new jsPDF();
  doc.setFontSize(20);doc.setFont('helvetica','bold');doc.text('StudyBot â€” Task Export',20,20);
  doc.setFontSize(10);doc.setFont('helvetica','normal');doc.text(`User: ${currentUser.name} | Exported: ${new Date().toLocaleDateString()}`,20,30);
  doc.setDrawColor(91,110,245);doc.line(20,35,190,35);
  let y=45;const pageH=280;
  tasks.forEach((t,i)=>{
    if(y>pageH-30){doc.addPage();y=20;}
    doc.setFontSize(11);doc.setFont('helvetica','bold');doc.text(`${i+1}. ${t.title}`,20,y);y+=6;
    doc.setFontSize(9);doc.setFont('helvetica','normal');
    doc.text(`Priority: ${t.priority} | Status: ${t.status}${t.due?' | Due: '+t.due:''}${t.subject?' | Subject: '+t.subject:''}`,24,y);y+=5;
    if(t.notes){const lines=doc.splitTextToSize(t.notes,160);doc.text(lines,24,y);y+=lines.length*4;}
    y+=4;
  });
  doc.save(`studybot_tasks_${currentUser.name.replace(/\s/g,'_')}.pdf`);
  toast('Tasks exported as PDF! ğŸ“„','success');
}
function importJSON(){document.getElementById('importInput').click();}
function handleImport(event){
  const file=event.target.files[0];if(!file)return;
  const reader=new FileReader();reader.onload=e=>{
    try{
      const data=JSON.parse(e.target.result);
      if(data.tasks&&Array.isArray(data.tasks)){
        const confirmed=confirm(`Import ${data.tasks.length} tasks? Existing tasks will be kept.`);
        if(confirmed){
          const existingIds=new Set(tasks.map(t=>t.id));
          const newTasks=data.tasks.filter(t=>!existingIds.has(t.id));
          tasks=[...newTasks,...tasks];saveUserData();renderTasks();
          toast(`Imported ${newTasks.length} new tasks!`,'success');
        }
      }else{toast('Invalid file format.','error');}
    }catch{toast('Could not read file.','error');}
    event.target.value='';
  };reader.readAsText(file);
}

/* â”€â”€â”€ MOTIVATION QUOTES â”€â”€â”€ */
const QUOTES=[
  {q:"The secret of getting ahead is getting started.",a:"Mark Twain"},
  {q:"Don't watch the clock; do what it does. Keep going.",a:"Sam Levenson"},
  {q:"Education is the most powerful weapon you can use to change the world.",a:"Nelson Mandela"},
  {q:"The beautiful thing about learning is that no one can take it away from you.",a:"B.B. King"},
  {q:"Push yourself, because no one else is going to do it for you.",a:"Anonymous"},
  {q:"Success is the sum of small efforts, repeated day in and day out.",a:"Robert Collier"},
  {q:"Hard work beats talent when talent doesn't work hard.",a:"Tim Notke"},
  {q:"Study hard, for the well is deep, and our brains are shallow.",a:"Richard Baxter"},
  {q:"Genius is one percent inspiration and ninety-nine percent perspiration.",a:"Thomas Edison"},
  {q:"The more that you read, the more things you will know.",a:"Dr. Seuss"},
  {q:"Your future is created by what you do today, not tomorrow.",a:"Robert Kiyosaki"},
  {q:"It always seems impossible until it's done.",a:"Nelson Mandela"},
];
function loadMotivation(){
  const q=QUOTES[Math.floor(Math.random()*QUOTES.length)];
  const qEl=document.getElementById('motivationQuote');const aEl=document.getElementById('motivationAuthor');
  if(qEl)qEl.textContent=`"${q.q}"`;if(aEl)aEl.textContent=`â€” ${q.a}`;
}

/* â”€â”€â”€ DARK/LIGHT QUICK TOGGLE â”€â”€â”€ */
const DARK_THEMES=['midnight','aurora','solar','rose','slate','copper','crimson','emerald','ocean','violet','amber','neon','fire'];
const LIGHT_THEMES=['light','paper','sky','mint','peach','lavender','lemon','blush','cloud'];
function quickThemeToggle(){
  const cur=document.documentElement.getAttribute('data-theme')||'midnight';
  const isDark=DARK_THEMES.includes(cur);
  const newTheme=isDark?'light':'midnight';
  setTheme(newTheme);
  document.getElementById('themeQuickBtn').textContent=isDark?'ğŸŒ™':'â˜€ï¸';
}

/* â”€â”€â”€ SOUND SYSTEM â”€â”€â”€ */
let soundEnabled=true;
function toggleSound(){
  soundEnabled=!soundEnabled;const btn=document.getElementById('soundToggleBtn');
  btn.textContent=soundEnabled?'ğŸ”Š':'ğŸ”‡';btn.classList.toggle('muted',!soundEnabled);
  toast(soundEnabled?'Sound on ğŸ”Š':'Sound off ğŸ”‡','info');
}
function playSound(type){
  if(!soundEnabled)return;
  try{
    const ctx=new(window.AudioContext||window.webkitAudioContext)();
    const osc=ctx.createOscillator();const gain=ctx.createGain();
    osc.connect(gain);gain.connect(ctx.destination);
    if(type==='complete'){osc.frequency.setValueAtTime(523,ctx.currentTime);osc.frequency.setValueAtTime(659,ctx.currentTime+.1);osc.frequency.setValueAtTime(784,ctx.currentTime+.2);gain.gain.setValueAtTime(.3,ctx.currentTime);gain.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+.6);}
    else if(type==='pomo'){osc.frequency.setValueAtTime(880,ctx.currentTime);osc.frequency.setValueAtTime(1100,ctx.currentTime+.15);osc.frequency.setValueAtTime(880,ctx.currentTime+.3);gain.gain.setValueAtTime(.25,ctx.currentTime);gain.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+.8);}
    else if(type==='tick'){osc.frequency.setValueAtTime(800,ctx.currentTime);gain.gain.setValueAtTime(.05,ctx.currentTime);gain.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+.05);}
    else if(type==='add'){osc.frequency.setValueAtTime(440,ctx.currentTime);osc.frequency.setValueAtTime(554,ctx.currentTime+.08);gain.gain.setValueAtTime(.2,ctx.currentTime);gain.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+.3);}
    osc.start(ctx.currentTime);osc.stop(ctx.currentTime+1);
  }catch(e){}
}

/* â”€â”€â”€ SUBTASK MODAL â”€â”€â”€ */
let subtaskModalTaskId=null;
function openSubtaskModal(taskId){
  subtaskModalTaskId=taskId;const t=tasks.find(x=>x.id===taskId);if(!t)return;
  document.getElementById('subtaskModalTitle').textContent=t.title.length>40?t.title.slice(0,40)+'â€¦':t.title;
  renderSubtaskModal();document.getElementById('subtaskModal').classList.add('show');
}
function renderSubtaskModal(){
  const t=tasks.find(x=>x.id===subtaskModalTaskId);if(!t)return;
  const list=document.getElementById('subtaskModalList');
  if(!t.subtasks||!t.subtasks.length){list.innerHTML='<div style="color:var(--tx3);font-size:.85rem;text-align:center;padding:16px">No subtasks yet. Add one below or use âœ¨ AI Generate!</div>';return;}
  list.innerHTML=t.subtasks.map((st,i)=>`<div class="subtask-modal-item" onclick="toggleSubtaskModal(${i})">
    <div class="subtask-modal-cb${st.done?' checked':''}">${st.done?'âœ“':''}</div>
    <span class="subtask-modal-txt${st.done?' checked':''}">${escHtml(st.text)}</span>
    <button class="icon-btn delete-btn" onclick="event.stopPropagation();deleteSubtask(${i})" style="width:22px;height:22px;font-size:.7rem">âœ•</button>
  </div>`).join('');
}
function toggleSubtaskModal(idx){
  const t=tasks.find(x=>x.id===subtaskModalTaskId);if(!t||!t.subtasks[idx])return;
  t.subtasks[idx].done=!t.subtasks[idx].done;t.updated_at=Date.now();saveUserData();renderSubtaskModal();
  if(document.getElementById('tasksPage').classList.contains('active'))renderTasks();
}
function deleteSubtask(idx){
  const t=tasks.find(x=>x.id===subtaskModalTaskId);if(!t)return;
  t.subtasks.splice(idx,1);t.updated_at=Date.now();saveUserData();renderSubtaskModal();
}
function addSubtaskFromModal(){
  const input=document.getElementById('subtaskAddInput');const text=input.value.trim();if(!text)return;
  const t=tasks.find(x=>x.id===subtaskModalTaskId);if(!t)return;
  if(!t.subtasks)t.subtasks=[];t.subtasks.push({text,done:false});t.updated_at=Date.now();saveUserData();
  input.value='';renderSubtaskModal();playSound('add');
}
async function generateSubtasksInModal(){
  const t=tasks.find(x=>x.id===subtaskModalTaskId);if(!t)return;
  toast('Generating AI subtasks...','info');await new Promise(r=>setTimeout(r,500));
  const m=t.title.toLowerCase();let subtasks=[];
  if(m.includes('essay')||m.includes('report')||m.includes('write'))subtasks=['Research the topic','Create an outline','Write the first draft','Proofread and edit','Submit final version'];
  else if(m.includes('math')||m.includes('calculus')||m.includes('algebra'))subtasks=['Review relevant formulas','Solve practice problems','Check answers and errors','Summarise key methods'];
  else if(m.includes('code')||m.includes('program')||m.includes('project'))subtasks=['Plan architecture','Set up environment','Implement core features','Write tests','Review and debug'];
  else if(m.includes('study')||m.includes('revise')||m.includes('review'))subtasks=['Gather notes','Read through material','Make summary notes','Test yourself'];
  else subtasks=['Understand requirements','Research resources','Create action plan','Complete the work','Review before submitting'];
  t.subtasks=subtasks.map(text=>({text,done:false}));t.updated_at=Date.now();saveUserData();renderSubtaskModal();
  toast(`Generated ${subtasks.length} subtasks! ğŸ‰`,'success');
}

/* â”€â”€â”€ GOALS â”€â”€â”€ */
let goals=[];let editingGoalId=null;let selectedGoalEmoji='ğŸ¯';
function loadGoals(){goals=get(`goals_${currentUser.email}`)||[];}
function saveGoals(){set(`goals_${currentUser.email}`,goals);}
function openGoalModal(id){
  editingGoalId=id||null;loadGoals();
  if(id){const g=goals.find(x=>x.id===id);if(g){document.getElementById('goalTitle').value=g.title;document.getElementById('goalDeadline').value=g.deadline||'';document.getElementById('goalSubject').value=g.subject||'';document.getElementById('goalEmoji').value=g.emoji||'ğŸ¯';selectedGoalEmoji=g.emoji||'ğŸ¯';document.getElementById('goalMilestones').value=(g.milestones||[]).map(m=>m.text).join('\n');document.getElementById('goalModalTitle').textContent='Edit Goal';}}
  else{document.getElementById('goalTitle').value='';document.getElementById('goalDeadline').value='';document.getElementById('goalSubject').value='';document.getElementById('goalEmoji').value='ğŸ¯';selectedGoalEmoji='ğŸ¯';document.getElementById('goalMilestones').value='';document.getElementById('goalModalTitle').textContent='New Goal';}
  document.getElementById('goalModal').classList.add('show');
}
function selectGoalEmoji(el,emoji){selectedGoalEmoji=emoji;document.getElementById('goalEmoji').value=emoji;document.querySelectorAll('#goalEmojiPicker span').forEach(s=>s.style.background='');el.style.background='rgba(91,110,245,.2)';el.style.borderRadius='6px';}
function saveGoal(){
  const title=document.getElementById('goalTitle').value.trim();if(!title){toast('Title required','error');return;}
  const milestoneTexts=document.getElementById('goalMilestones').value.split('\n').map(s=>s.trim()).filter(Boolean);
  const goalData={id:editingGoalId||Date.now().toString(),title,deadline:document.getElementById('goalDeadline').value,subject:document.getElementById('goalSubject').value.trim(),emoji:selectedGoalEmoji,milestones:milestoneTexts.map(text=>({text,done:false})),created_at:editingGoalId?(goals.find(g=>g.id===editingGoalId)?.created_at||Date.now()):Date.now(),updated_at:Date.now()};
  if(editingGoalId){const idx=goals.findIndex(g=>g.id===editingGoalId);if(idx>-1)goals[idx]=goalData;else goals.unshift(goalData);}
  else goals.unshift(goalData);
  saveGoals();closeModal('goalModal');renderGoals();toast('Goal saved! ğŸ¯','success');playSound('add');
}
function deleteGoal(id){if(!confirm('Delete this goal?'))return;goals=goals.filter(g=>g.id!==id);saveGoals();renderGoals();}
function toggleMilestone(goalId,idx){
  const g=goals.find(x=>x.id===goalId);if(!g||!g.milestones[idx])return;
  g.milestones[idx].done=!g.milestones[idx].done;g.updated_at=Date.now();saveGoals();
  if(g.milestones.every(m=>m.done)){toast(`Goal "${g.title}" completed! ğŸ‰`,'success');if(typeof confetti!=='undefined')confetti({particleCount:100,spread:80,origin:{y:.6}});playSound('complete');}
  renderGoals();
}
function renderGoals(){
  loadGoals();const today=new Date();
  const total=goals.length,done=goals.filter(g=>g.milestones.length>0&&g.milestones.every(m=>m.done)).length;
  const active=goals.filter(g=>!g.milestones.every(m=>m.done)).length;
  document.getElementById('goalsStats').innerHTML=[
    {val:total,label:'Total Goals',icon:'ğŸ¯'},{val:done,label:'Achieved',icon:'ğŸ†'},
    {val:active,label:'Active',icon:'âš¡'},{val:goals.filter(g=>g.deadline&&new Date(g.deadline)<today&&!g.milestones.every(m=>m.done)).length,label:'Overdue',icon:'âš ï¸'}
  ].map(s=>`<div class="goal-stat"><div class="goal-stat-val">${s.val}</div><div class="goal-stat-label">${s.icon} ${s.label}</div></div>`).join('');
  if(!goals.length){document.getElementById('goalsGrid').innerHTML=`<div class="empty-state" style="grid-column:1/-1"><div class="es-icon">ğŸ¯</div><div class="es-title">No goals yet</div><div class="es-sub">Set your first academic goal!</div></div>`;return;}
  document.getElementById('goalsGrid').innerHTML=goals.map(g=>{
    const doneMilestones=(g.milestones||[]).filter(m=>m.done).length,totalMilestones=(g.milestones||[]).length;
    const pct=totalMilestones?Math.round((doneMilestones/totalMilestones)*100):0;
    const isComplete=totalMilestones>0&&pct===100;
    const isOverdue=g.deadline&&new Date(g.deadline)<today&&!isComplete;
    const badgeCls=isComplete?'done':isOverdue?'overdue':pct>=50?'on-track':'at-risk';
    const badgeLabel=isComplete?'âœ… Achieved':isOverdue?'âš  Overdue':pct>=50?'On Track':'Getting Started';
    const daysLeft=g.deadline?Math.ceil((new Date(g.deadline)-today)/(1000*60*60*24)):null;
    const milestonesHtml=(g.milestones||[]).map((m,i)=>`<div class="milestone-item" onclick="toggleMilestone('${g.id}',${i})"><div class="milestone-cb${m.done?' checked':''}">${m.done?'âœ“':''}</div><span class="milestone-txt${m.done?' checked':''}">${escHtml(m.text)}</span></div>`).join('');
    return`<div class="goal-card${isComplete?' gc-completed':''}">
      <div class="goal-header"><div class="goal-title">${escHtml(g.title)}</div><div class="goal-emoji">${g.emoji||'ğŸ¯'}</div></div>
      ${g.subject?`<div style="font-size:.75rem;color:var(--tx3);margin-bottom:6px">ğŸ“š ${escHtml(g.subject)}</div>`:''}
      ${g.deadline?`<div class="goal-deadline">ğŸ“… ${new Date(g.deadline+'T00:00:00').toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'})}${daysLeft!==null?` Â· <span style="color:${daysLeft<0?'var(--acc-r)':daysLeft<7?'var(--acc-y)':'var(--acc-g)'};">${daysLeft<0?`${Math.abs(daysLeft)}d overdue`:daysLeft===0?'Due today':`${daysLeft}d left`}</span>`:''}</div>`:''}
      <div class="goal-progress-wrap"><div class="goal-progress-header"><span>${pct}% complete</span><span>${doneMilestones}/${totalMilestones}</span></div><div class="goal-track"><div class="goal-fill" style="width:${pct}%"></div></div></div>
      ${totalMilestones?`<div class="goal-milestones">${milestonesHtml}</div>`:''}
      <div class="goal-footer"><span class="goal-badge ${badgeCls}">${badgeLabel}</span>
        <div style="display:flex;gap:6px"><button class="icon-btn" onclick="openGoalModal('${g.id}')" title="Edit">âœ</button><button class="icon-btn delete-btn" onclick="deleteGoal('${g.id}')" title="Delete">âœ•</button></div>
      </div>
    </div>`;
  }).join('');
}

/* â”€â”€â”€ NOTES â”€â”€â”€ */
let notes=[],currentNoteId=null;
function loadNotes(){notes=get(`notes_${currentUser.email}`)||[];}
function saveNotes(){set(`notes_${currentUser.email}`,notes);}
function newNote(){
  loadNotes();const note={id:Date.now().toString(),title:'Untitled Note',body:'',subject:'',created_at:Date.now(),updated_at:Date.now()};
  notes.unshift(note);saveNotes();currentNoteId=note.id;renderNotesList();loadNote(note.id);playSound('add');
}
function loadNote(id){
  const n=notes.find(x=>x.id===id);if(!n)return;
  currentNoteId=id;document.getElementById('noteTitleInput').value=n.title;document.getElementById('noteBody').value=n.body||'';document.getElementById('noteSubjectSelect').value=n.subject||'';updateWordCount();renderNotesList();
}
function saveCurrentNote(){
  if(!currentNoteId)return;const n=notes.find(x=>x.id===currentNoteId);if(!n)return;
  n.title=document.getElementById('noteTitleInput').value||'Untitled Note';n.body=document.getElementById('noteBody').value;n.subject=document.getElementById('noteSubjectSelect').value;n.updated_at=Date.now();
  saveNotes();renderNotesList();
}
function deleteCurrentNote(){
  if(!currentNoteId)return;if(!confirm('Delete this note?'))return;
  notes=notes.filter(x=>x.id!==currentNoteId);saveNotes();
  currentNoteId=null;document.getElementById('noteTitleInput').value='';document.getElementById('noteBody').value='';renderNotesList();
}
function renderNotesList(){
  loadNotes();const list=document.getElementById('notesList');
  if(!notes.length){list.innerHTML='<div style="color:var(--tx3);font-size:.8rem;padding:16px;text-align:center">No notes yet. Click + New!</div>';return;}
  list.innerHTML=notes.map(n=>`<div class="note-item${n.id===currentNoteId?' active':''}" onclick="loadNote('${n.id}')">
    <div class="note-item-title">${escHtml(n.title)}</div>
    <div class="note-item-date">${new Date(n.updated_at).toLocaleDateString()}</div>
    ${n.body?`<div class="note-item-preview">${escHtml(n.body.slice(0,60))}</div>`:''}
  </div>`).join('');
  // populate subject select
  const subjects=[...new Set(tasks.map(t=>t.subject).filter(Boolean))];
  const sel=document.getElementById('noteSubjectSelect');if(sel){sel.innerHTML='<option value="">No subject</option>'+subjects.map(s=>`<option value="${escHtml(s)}">${escHtml(s)}</option>`).join('');}
}
function insertFmt(before,after){
  const ta=document.getElementById('noteBody');const s=ta.selectionStart,e=ta.selectionEnd;const val=ta.value;
  ta.value=val.slice(0,s)+before+val.slice(s,e)+after+val.slice(e);ta.selectionStart=s+before.length;ta.selectionEnd=e+before.length;ta.focus();saveCurrentNote();
}
function updateWordCount(){
  const txt=document.getElementById('noteBody').value;const words=txt.trim()?txt.trim().split(/\s+/).length:0;
  const el=document.getElementById('wordCount');if(el)el.textContent=`${words} word${words!==1?'s':''}`;
}
function copyNoteText(){const txt=document.getElementById('noteBody').value;navigator.clipboard.writeText(txt).then(()=>toast('Note copied!','success'));}
function exportNoteAsTxt(){
  const n=notes.find(x=>x.id===currentNoteId);if(!n){toast('No note selected','error');return;}
  const content=`${n.title}\n${'='.repeat(n.title.length)}\n\n${n.body}`;
  const blob=new Blob([content],{type:'text/plain'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`${n.title.replace(/[^a-z0-9]/gi,'_')}.txt`;a.click();URL.revokeObjectURL(a.href);toast('Note exported!','success');
}

/* â”€â”€â”€ TIMETABLE â”€â”€â”€ */
const DAYS=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
const TIME_SLOTS=['6:00 AM','7:00 AM','8:00 AM','9:00 AM','10:00 AM','11:00 AM','12:00 PM','1:00 PM','2:00 PM','3:00 PM','4:00 PM','5:00 PM','6:00 PM','7:00 PM','8:00 PM','9:00 PM'];
const CLASS_COLORS=['#5b6ef5','#f55b5b','#5bf5a0','#f5c45b','#c45bf5','#5bc8f5','#f5835b','#a0f55b','#f55bb8','#5bf5e8'];
let timetable=[];let addClassDay=0,addClassTime=0;
function loadTimetable(){timetable=get(`tt_${currentUser.email}`)||[];}
function saveTimetable(){set(`tt_${currentUser.email}`,timetable);}
function renderTimetable(){
  loadTimetable();const grid=document.getElementById('timetableGrid');if(!grid)return;
  const todayDay=new Date().getDay();
  let html=`<div class="tt-header"></div>`+DAYS.map((d,i)=>`<div class="tt-header${i===todayDay?' today':''}">${d}</div>`).join('');
  TIME_SLOTS.forEach((time,ti)=>{
    html+=`<div class="tt-time">${time}</div>`;
    DAYS.forEach((_,di)=>{
      const cls=timetable.find(c=>c.day===di&&c.timeIdx===ti);
      if(cls){const col=cls.color||'#5b6ef5';const txtCol=isLightColor(col)?'#000':'#fff';
        html+=`<div class="tt-cell has-class"><div class="tt-class" style="background:${col}20;border-left:3px solid ${col};color:${col}">
          <div class="tt-class-name" style="color:${col}">${escHtml(cls.name)}</div>
          ${cls.teacher?`<div class="tt-class-teacher" style="color:${col}88">${escHtml(cls.teacher)}</div>`:''}
          <button class="tt-delete-cls" onclick="deleteClass('${cls.id}')" style="color:${col}">âœ•</button>
        </div></div>`;}
      else html+=`<div class="tt-cell" onclick="quickAddClass(${di},${ti})" title="Add class here"></div>`;
    });
  });
  grid.innerHTML=html;
  // Legend
  const subjects=[...new Set(timetable.map(c=>c.name))];
  document.getElementById('ttLegend').innerHTML=subjects.map(s=>{const cls=timetable.find(c=>c.name===s);return`<div class="tt-legend-item"><div class="tt-legend-dot" style="background:${cls?.color||'#5b6ef5'}"></div>${escHtml(s)}</div>`;}).join('');
}
function isLightColor(hex){const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);return(r*299+g*587+b*114)/1000>128;}
function openAddClassModal(day,timeIdx){
  addClassDay=day||0;addClassTime=timeIdx||0;
  const sel=document.getElementById('clsDay');if(sel)sel.value=addClassDay;
  const tsel=document.getElementById('clsTime');if(tsel){tsel.innerHTML=TIME_SLOTS.map((t,i)=>`<option value="${i}">${t}</option>`).join('');tsel.value=addClassTime;}
  const cp=document.getElementById('clsColorPicker');if(cp){cp.innerHTML=CLASS_COLORS.map(c=>`<div onclick="selectClsColor(this,'${c}')" style="width:26px;height:26px;border-radius:50%;background:${c};cursor:pointer;border:3px solid transparent;transition:all .15s" data-color="${c}"></div>`).join('');cp.firstChild?.setAttribute('style',`width:26px;height:26px;border-radius:50%;background:${CLASS_COLORS[0]};cursor:pointer;border:3px solid var(--tx);transition:all .15s`);}
  document.getElementById('clsName').value='';document.getElementById('clsTeacher').value='';document.getElementById('clsColor').value=CLASS_COLORS[0];
  document.getElementById('addClassModal').classList.add('show');
}
function quickAddClass(day,timeIdx){openAddClassModal(day,timeIdx);}
function selectClsColor(el,color){document.getElementById('clsColor').value=color;document.querySelectorAll('#clsColorPicker div').forEach(d=>{d.style.border=d.dataset.color===color?'3px solid var(--tx)':'3px solid transparent';});}
function saveClass(){
  const name=document.getElementById('clsName').value.trim();if(!name){toast('Subject name required','error');return;}
  const day=parseInt(document.getElementById('clsDay').value);const timeIdx=parseInt(document.getElementById('clsTime').value);
  const existing=timetable.find(c=>c.day===day&&c.timeIdx===timeIdx);if(existing){toast('Slot already taken! Delete it first.','error');return;}
  loadTimetable();timetable.push({id:Date.now().toString(),name,teacher:document.getElementById('clsTeacher').value.trim(),day,timeIdx,color:document.getElementById('clsColor').value});
  saveTimetable();closeModal('addClassModal');renderTimetable();toast(`${name} added to timetable! ğŸ“…`,'success');playSound('add');
}
function deleteClass(id){timetable=timetable.filter(c=>c.id!==id);saveTimetable();renderTimetable();}
function clearTimetable(){if(!confirm('Clear entire timetable?'))return;timetable=[];saveTimetable();renderTimetable();toast('Timetable cleared.','info');}

/* â”€â”€â”€ FRIEND CODES â”€â”€â”€ */
function generateFriendCode(email){
  let hash=0;for(let i=0;i<email.length;i++){hash=((hash<<5)-hash)+email.charCodeAt(i);hash|=0;}
  const chars='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';let code='SB-';const h=Math.abs(hash);for(let i=0;i<6;i++)code+=chars[(h>>(i*5))%chars.length];return code;
}
function renderFriendCode(){
  if(!currentUser)return;const code=generateFriendCode(currentUser.email);const el=document.getElementById('myFriendCode');if(el)el.textContent=code;
}
function copyFriendCode(){const code=document.getElementById('myFriendCode').textContent;navigator.clipboard.writeText(code).then(()=>toast('Friend code copied! ğŸ“‹','success'));}
function joinFriend(){
  const input=document.getElementById('friendCodeInput').value.trim().toUpperCase();if(!input){toast('Enter a friend code','error');return;}
  const users=get('studybot_users')||{};const match=Object.entries(users).find(([email])=>generateFriendCode(email)===input);
  if(!match){toast('Code not found. Ask your friend to register first!','error');return;}
  const friends=get(`friends_${currentUser.email}`)||[];if(friends.includes(match[0])){toast('Already friends!','info');return;}
  if(match[0]===currentUser.email){toast("That's your own code! ğŸ˜„",'info');return;}
  friends.push(match[0]);set(`friends_${currentUser.email}`,friends);renderFriendsList();toast(`Added ${match[1].name} as a friend! ğŸ‰`,'success');
}
function renderFriendsList(){
  const friends=get(`friends_${currentUser.email}`)||[];const users=get('studybot_users')||{};const el=document.getElementById('friendsList');if(!el)return;
  if(!friends.length){el.innerHTML='<div style="color:var(--tx3);font-size:.8rem">No friends added yet. Share your code!</div>';return;}
  el.innerHTML='<div style="font-size:.78rem;font-weight:700;color:var(--tx2);margin-bottom:8px">Friends</div>'+friends.map(email=>{
    const u=users[email];if(!u)return'';const score=calcScore(email);
    return`<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border)"><div class="user-av" style="width:28px;height:28px;font-size:.75rem;background:hsl(${email.charCodeAt(0)*37%360},60%,55%)">${u.name.charAt(0).toUpperCase()}</div><div style="flex:1"><div style="font-weight:600;font-size:.83rem">${escHtml(u.name)}</div><div style="font-size:.7rem;color:var(--tx3)">${score} pts Â· ${generateFriendCode(email)}</div></div><button class="btn btn-danger" style="padding:3px 8px;font-size:.7rem" onclick="removeFriend('${email}')">Remove</button></div>`;
  }).join('');
}
function removeFriend(email){let friends=get(`friends_${currentUser.email}`)||[];friends=friends.filter(e=>e!==email);set(`friends_${currentUser.email}`,friends);renderFriendsList();}

/* â”€â”€â”€ PATCH: sound on task complete + pomo â”€â”€â”€ */
const _origToggleComplete=toggleComplete;
// Override toggleComplete to add sound
const _savedToggleComplete=window.toggleComplete;
window.toggleCompleteOrig=toggleComplete;
function toggleComplete(id){
  const t=tasks.find(t=>t.id===id);const wasDone=t?.status==='completed';
  window.toggleCompleteOrig(id);
  if(!wasDone)playSound('complete');
}
// Override pomoComplete to add sound
const _origPomoComplete=pomoComplete;
window.pomoCompleteOrig=pomoComplete;
function pomoComplete(){window.pomoCompleteOrig();playSound('pomo');}

/* â”€â”€â”€ PATCH: navigate for new pages â”€â”€â”€ */
const _origNavigate=navigate;
window.navigateOrig=navigate;
function navigate(page){
  window.navigateOrig(page);
  if(page==='goals'){loadGoals();renderGoals();}
  if(page==='notes'){loadNotes();renderNotesList();if(notes.length&&!currentNoteId){currentNoteId=notes[0].id;loadNote(notes[0].id);}}
  if(page==='timetable')renderTimetable();
  if(page==='dashboard')loadMotivation();
}

/* â”€â”€â”€ PATCH: initApp for new data â”€â”€â”€ */
const _origInitApp=initApp;
window.initAppOrig=initApp;
function initApp(){
  window.initAppOrig();
  loadMotivation();
  // update quick theme btn
  const cur=document.documentElement.getAttribute('data-theme')||'midnight';
  const btn=document.getElementById('themeQuickBtn');if(btn)btn.textContent=DARK_THEMES.includes(cur)?'â˜€ï¸':'ğŸŒ™';
}
const _origRenderPerformance=renderPerformance;
window.renderPerformanceOrig=renderPerformance;
function renderPerformance(){
  window.renderPerformanceOrig();renderFriendCode();renderFriendsList();
}

/* â”€â”€â”€ CLOSE PANELS ON OUTSIDE CLICK â”€â”€â”€ */
document.addEventListener('click',e=>{
  const np=document.getElementById('notifPanel');const nb=document.getElementById('notifBtn');const tp=document.getElementById('themePanel');
  if(np&&nb&&!np.contains(e.target)&&!nb.contains(e.target))np.classList.remove('show');
  if(tp&&!tp.contains(e.target)&&!e.target.closest('[onclick="toggleThemePanel()"]'))tp.classList.remove('show');
});
</script>
</body>
</html>