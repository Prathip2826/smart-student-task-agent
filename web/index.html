<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>StudyBot â€” Smart Task Agent</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,wght@0,300;0,600;0,900;1,300&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
:root{
  --bg:#0d0d0f;--surface:#141417;--surface2:#1c1c21;--border:#2a2a32;
  --accent:#c8f060;--accent2:#60d4f0;--accent3:#f060a8;
  --text:#e8e8ec;--muted:#6b6b7a;
  --font-head:'Fraunces',Georgia,serif;--font-mono:'DM Mono',monospace;
  --r:12px;--r-lg:20px;--shadow:0 8px 40px rgba(0,0,0,0.5);
}
html{scroll-behavior:smooth;}
body{background:var(--bg);color:var(--text);font-family:var(--font-mono);font-size:14px;line-height:1.6;min-height:100vh;overflow-x:hidden;}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 60% 40% at 80% 10%,rgba(200,240,96,0.06) 0%,transparent 60%),radial-gradient(ellipse 50% 50% at 10% 80%,rgba(96,212,240,0.05) 0%,transparent 60%);pointer-events:none;z-index:0;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOGIN / REGISTER SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#authScreen{
  position:fixed;inset:0;z-index:200;
  display:flex;align-items:center;justify-content:center;
  background:var(--bg);
}
.auth-box{
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--r-lg);padding:40px;width:100%;max-width:400px;
  box-shadow:var(--shadow);animation:modalIn 0.3s ease;
}
@keyframes modalIn{from{opacity:0;transform:scale(0.95);}to{opacity:1;transform:scale(1);}}
.auth-logo{font-family:var(--font-head);font-size:28px;font-weight:900;text-align:center;margin-bottom:6px;}
.auth-logo span{color:var(--accent);}
.auth-subtitle{text-align:center;color:var(--muted);font-size:13px;margin-bottom:28px;}
.auth-tabs{display:flex;gap:0;margin-bottom:24px;border-radius:var(--r);overflow:hidden;border:1px solid var(--border);}
.auth-tab{flex:1;padding:10px;background:transparent;border:none;color:var(--muted);font-family:var(--font-mono);font-size:13px;cursor:pointer;transition:all 0.2s;}
.auth-tab.active{background:var(--accent);color:var(--bg);font-weight:600;}
.auth-field{display:flex;flex-direction:column;gap:5px;margin-bottom:14px;}
.auth-field label{font-size:11px;letter-spacing:1px;text-transform:uppercase;color:var(--muted);}
.auth-field input{background:var(--surface2);border:1px solid var(--border);border-radius:var(--r);padding:10px 14px;color:var(--text);font-family:var(--font-mono);font-size:13px;outline:none;transition:border-color 0.2s;}
.auth-field input:focus{border-color:var(--accent2);}
.auth-field input::placeholder{color:var(--muted);}
.auth-btn{width:100%;padding:12px;border-radius:var(--r);border:none;background:var(--accent);color:var(--bg);font-family:var(--font-mono);font-size:14px;font-weight:600;cursor:pointer;transition:all 0.15s;margin-top:8px;}
.auth-btn:hover{background:#d4f570;transform:translateY(-1px);}
.auth-error{color:var(--accent3);font-size:12px;text-align:center;margin-top:8px;min-height:18px;}
.auth-user-list{margin-top:16px;padding-top:16px;border-top:1px solid var(--border);}
.auth-user-list-title{font-size:11px;letter-spacing:1px;text-transform:uppercase;color:var(--muted);margin-bottom:8px;}
.auth-user-chip{display:inline-flex;align-items:center;gap:6px;padding:5px 12px;border-radius:100px;background:var(--surface2);border:1px solid var(--border);font-size:12px;cursor:pointer;margin:3px;transition:all 0.15s;}
.auth-user-chip:hover{border-color:var(--accent);color:var(--accent);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAIN APP LAYOUT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.app{position:relative;z-index:1;display:grid;grid-template-columns:240px 1fr 300px;grid-template-rows:60px 1fr;height:100vh;}
header{grid-column:1/-1;display:flex;align-items:center;justify-content:space-between;padding:0 20px;border-bottom:1px solid var(--border);background:rgba(13,13,15,0.95);backdrop-filter:blur(12px);position:sticky;top:0;z-index:50;}
.logo{font-family:var(--font-head);font-size:20px;font-weight:900;letter-spacing:-0.5px;display:flex;align-items:center;gap:8px;}
.logo span{color:var(--accent);}
.logo-dot{width:8px;height:8px;border-radius:50%;background:var(--accent);animation:pulse 2s ease-in-out infinite;}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1);}50%{opacity:0.5;transform:scale(0.8);}}
.header-right{display:flex;align-items:center;gap:12px;}
.header-stats{font-size:12px;color:var(--muted);}
.header-stats strong{color:var(--accent);}
.user-badge{display:flex;align-items:center;gap:8px;padding:6px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:100px;font-size:12px;cursor:pointer;transition:all 0.15s;}
.user-badge:hover{border-color:var(--accent3);color:var(--accent3);}
.user-avatar{width:22px;height:22px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:var(--bg);}
.hamburger{display:none;flex-direction:column;gap:5px;background:none;border:none;cursor:pointer;padding:6px;}
.hamburger span{display:block;width:22px;height:2px;background:var(--text);border-radius:2px;}
.ai-toggle{display:none;background:rgba(200,240,96,0.12);border:1px solid rgba(200,240,96,0.25);color:var(--accent);font-family:var(--font-mono);font-size:12px;padding:6px 12px;border-radius:var(--r);cursor:pointer;}

/* SIDEBAR */
.sidebar{border-right:1px solid var(--border);padding:16px 12px;overflow-y:auto;background:var(--surface);}
.sidebar-section{margin-bottom:24px;}
.sidebar-label{font-size:10px;font-weight:500;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:8px;padding:0 8px;}
.nav-btn{display:flex;align-items:center;gap:10px;width:100%;padding:9px 12px;border-radius:var(--r);border:none;background:transparent;color:var(--muted);font-family:var(--font-mono);font-size:13px;cursor:pointer;transition:all 0.15s;text-align:left;}
.nav-btn:hover{background:var(--surface2);color:var(--text);}
.nav-btn.active{background:rgba(200,240,96,0.12);color:var(--accent);}
.nav-btn .icon{font-size:16px;}
.mini-stat{display:flex;justify-content:space-between;align-items:center;padding:6px 12px;font-size:12px;color:var(--muted);}
.mini-stat .val{font-size:18px;font-family:var(--font-head);font-weight:600;color:var(--text);}
.mini-stat .val.high{color:var(--accent3);}
.mini-stat .val.done{color:var(--accent);}

/* MAIN */
.main{overflow-y:auto;padding:20px 24px;display:flex;flex-direction:column;gap:18px;}
.page{display:none;flex-direction:column;gap:18px;}
.page.active{display:flex;}
.page-title{font-family:var(--font-head);font-size:28px;font-weight:900;letter-spacing:-1px;line-height:1.1;}
.page-title em{color:var(--accent);font-style:italic;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DASHBOARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.dash-greeting{font-family:var(--font-head);font-size:24px;font-weight:900;}
.dash-greeting span{color:var(--accent);}
.dash-subtitle{color:var(--muted);font-size:13px;margin-top:4px;}
.dash-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px;}
.dash-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r-lg);padding:18px;display:flex;flex-direction:column;gap:6px;animation:cardIn 0.3s ease both;}
@keyframes cardIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
.dash-card-label{font-size:11px;letter-spacing:1px;text-transform:uppercase;color:var(--muted);}
.dash-card-val{font-family:var(--font-head);font-size:32px;font-weight:900;line-height:1;}
.dash-card-val.green{color:var(--accent);}
.dash-card-val.blue{color:var(--accent2);}
.dash-card-val.pink{color:var(--accent3);}
.dash-card-sub{font-size:12px;color:var(--muted);}
.dash-row{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
.dash-panel{background:var(--surface);border:1px solid var(--border);border-radius:var(--r-lg);padding:18px;}
.dash-panel-title{font-size:12px;letter-spacing:1px;text-transform:uppercase;color:var(--muted);margin-bottom:14px;}
.streak-row{display:flex;gap:5px;flex-wrap:wrap;}
.streak-day{width:28px;height:28px;border-radius:6px;background:var(--surface2);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:10px;color:var(--muted);}
.streak-day.active{background:rgba(200,240,96,0.2);border-color:var(--accent);color:var(--accent);}
.streak-day.today{background:var(--accent);color:var(--bg);font-weight:700;}
.recent-task-item{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border);font-size:13px;}
.recent-task-item:last-child{border-bottom:none;}
.chart-wrap{position:relative;height:160px;}

/* TOOLBAR */
.toolbar{display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
.filter-chip{padding:6px 14px;border-radius:100px;border:1px solid var(--border);background:transparent;color:var(--muted);font-family:var(--font-mono);font-size:12px;cursor:pointer;transition:all 0.15s;}
.filter-chip:hover{border-color:var(--accent);color:var(--accent);}
.filter-chip.active{background:var(--accent);color:var(--bg);border-color:var(--accent);}
.search-box{flex:1;min-width:140px;max-width:260px;padding:8px 14px;border-radius:100px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-family:var(--font-mono);font-size:13px;outline:none;transition:border-color 0.2s;}
.search-box:focus{border-color:var(--accent2);}
.search-box::placeholder{color:var(--muted);}

/* TASK CARDS */
.task-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;}
.task-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r-lg);padding:16px 18px;transition:all 0.2s;cursor:pointer;position:relative;overflow:hidden;animation:cardIn 0.3s ease both;}
.task-card:hover{border-color:var(--accent2);transform:translateY(-2px);box-shadow:0 10px 28px rgba(0,0,0,0.4);}
.task-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;border-radius:var(--r-lg) var(--r-lg) 0 0;background:var(--accent2);opacity:0;transition:opacity 0.2s;}
.task-card:hover::before{opacity:1;}
.task-card.priority-high::before{background:var(--accent3);opacity:1;}
.task-card.priority-medium::before{background:var(--accent);opacity:0.6;}
.task-card-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;}
.task-title{font-family:var(--font-head);font-size:16px;font-weight:600;line-height:1.3;flex:1;}
.task-card.completed .task-title{text-decoration:line-through;color:var(--muted);}
.task-card-actions{display:flex;gap:4px;opacity:0;transition:opacity 0.2s;}
.task-card:hover .task-card-actions{opacity:1;}
@media(hover:none){.task-card-actions{opacity:1!important;}}
.icon-btn{width:28px;height:28px;border-radius:8px;border:none;background:var(--surface2);color:var(--muted);font-size:13px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.15s;}
.icon-btn:hover{background:var(--border);color:var(--text);}
.icon-btn.danger:hover{background:rgba(240,96,168,0.2);color:var(--accent3);}
.icon-btn.ai-btn:hover{background:rgba(200,240,96,0.15);color:var(--accent);}
.task-meta{display:flex;gap:6px;flex-wrap:wrap;margin-top:10px;}
.badge{padding:3px 8px;border-radius:100px;font-size:11px;font-weight:500;border:1px solid;}
.badge-subject{background:rgba(96,212,240,0.1);color:var(--accent2);border-color:rgba(96,212,240,0.2);}
.badge-high{background:rgba(240,96,168,0.1);color:var(--accent3);border-color:rgba(240,96,168,0.2);}
.badge-medium{background:rgba(200,240,96,0.1);color:var(--accent);border-color:rgba(200,240,96,0.2);}
.badge-low{background:rgba(107,107,122,0.2);color:var(--muted);border-color:var(--border);}
.badge-pending{background:rgba(200,240,96,0.08);color:#a8c84a;border-color:rgba(200,240,96,0.15);}
.badge-in-progress{background:rgba(96,212,240,0.1);color:var(--accent2);border-color:rgba(96,212,240,0.2);}
.badge-completed{background:rgba(107,107,122,0.2);color:var(--muted);border-color:var(--border);}
.task-due{font-size:12px;color:var(--muted);margin-top:6px;}
.task-due.overdue{color:var(--accent3);}
.task-desc{font-size:12px;color:var(--muted);margin-top:5px;line-height:1.5;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
.subtasks-list{margin-top:10px;padding-top:10px;border-top:1px solid var(--border);display:flex;flex-direction:column;gap:4px;}
.subtask-item{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--muted);cursor:pointer;padding:2px 0;transition:color 0.15s;}
.subtask-item:hover{color:var(--text);}
.subtask-check{width:14px;height:14px;border-radius:3px;border:1px solid var(--border);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:9px;transition:all 0.15s;}
.subtask-item.done .subtask-check{background:var(--accent);border-color:var(--accent);color:var(--bg);}
.subtask-item.done span{text-decoration:line-through;}
.empty-state{grid-column:1/-1;text-align:center;padding:50px 20px;color:var(--muted);}
.empty-state .big{font-size:44px;margin-bottom:10px;}
.empty-state p{font-family:var(--font-head);font-style:italic;font-size:17px;}

/* ADD FORM */
.add-form{background:var(--surface);border:1px solid var(--border);border-radius:var(--r-lg);padding:20px;display:flex;flex-direction:column;gap:14px;}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.form-group{display:flex;flex-direction:column;gap:5px;}
.form-group.full{grid-column:1/-1;}
label{font-size:11px;letter-spacing:1px;text-transform:uppercase;color:var(--muted);}
input[type="text"],input[type="date"],textarea,select{background:var(--surface2);border:1px solid var(--border);border-radius:var(--r);padding:10px 12px;color:var(--text);font-family:var(--font-mono);font-size:13px;outline:none;transition:border-color 0.2s;width:100%;}
input:focus,textarea:focus,select:focus{border-color:var(--accent2);}
input::placeholder,textarea::placeholder{color:var(--muted);}
textarea{resize:vertical;min-height:70px;}
select option{background:var(--surface2);}
.btn{padding:10px 18px;border-radius:var(--r);border:none;font-family:var(--font-mono);font-size:13px;font-weight:500;cursor:pointer;transition:all 0.15s;display:inline-flex;align-items:center;gap:6px;}
.btn-primary{background:var(--accent);color:var(--bg);}
.btn-primary:hover{background:#d4f570;transform:translateY(-1px);}
.btn-secondary{background:var(--surface2);color:var(--text);border:1px solid var(--border);}
.btn-secondary:hover{border-color:var(--accent2);color:var(--accent2);}
.btn-ai{background:rgba(200,240,96,0.12);color:var(--accent);border:1px solid rgba(200,240,96,0.25);}
.btn-ai:hover{background:rgba(200,240,96,0.2);}
.form-actions{display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap;}

/* AI PANEL */
.ai-panel{border-left:1px solid var(--border);background:var(--surface);display:flex;flex-direction:column;overflow:hidden;}
.ai-header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;}
.ai-avatar{width:30px;height:30px;border-radius:9px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0;}
.ai-name{font-family:var(--font-head);font-weight:600;font-size:14px;}
.ai-status{font-size:11px;color:var(--accent);}
.ai-close{display:none;margin-left:auto;background:none;border:none;color:var(--muted);font-size:18px;cursor:pointer;padding:4px 8px;}
.ai-messages{flex:1;overflow-y:auto;padding:14px;display:flex;flex-direction:column;gap:10px;scroll-behavior:smooth;}
.msg{display:flex;gap:8px;animation:msgIn 0.2s ease both;}
@keyframes msgIn{from{opacity:0;transform:translateY(5px);}to{opacity:1;transform:translateY(0);}}
.msg.user{flex-direction:row-reverse;}
.msg-bubble{max-width:85%;padding:9px 13px;border-radius:14px;font-size:13px;line-height:1.5;}
.msg.ai .msg-bubble{background:var(--surface2);border:1px solid var(--border);border-bottom-left-radius:4px;color:var(--text);}
.msg.user .msg-bubble{background:rgba(200,240,96,0.15);border:1px solid rgba(200,240,96,0.25);border-bottom-right-radius:4px;color:var(--text);}
.msg-avatar{width:24px;height:24px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0;align-self:flex-end;}
.msg.ai .msg-avatar{background:linear-gradient(135deg,var(--accent),var(--accent2));}
.msg.user .msg-avatar{background:var(--surface2);border:1px solid var(--border);}
.quick-prompts{padding:10px 14px;display:flex;gap:6px;flex-wrap:wrap;border-top:1px solid var(--border);}
.quick-btn{padding:5px 10px;border-radius:100px;border:1px solid var(--border);background:transparent;color:var(--muted);font-family:var(--font-mono);font-size:11px;cursor:pointer;transition:all 0.15s;white-space:nowrap;}
.quick-btn:hover{border-color:var(--accent);color:var(--accent);background:rgba(200,240,96,0.08);}
.ai-input-row{padding:10px 14px;display:flex;gap:8px;border-top:1px solid var(--border);}
.ai-input{flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:var(--r);padding:9px 12px;color:var(--text);font-family:var(--font-mono);font-size:13px;outline:none;transition:border-color 0.2s;}
.ai-input:focus{border-color:var(--accent);}
.send-btn{width:36px;height:36px;border-radius:10px;border:none;background:var(--accent);color:var(--bg);font-size:15px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.15s;flex-shrink:0;}
.send-btn:hover{background:#d4f570;}
.send-btn:disabled{background:var(--surface2);color:var(--muted);cursor:default;}
.typing{display:flex;gap:4px;padding:9px 13px;}
.typing-dot{width:6px;height:6px;border-radius:50%;background:var(--muted);animation:typingAnim 1.2s ease-in-out infinite;}
.typing-dot:nth-child(2){animation-delay:0.15s;}.typing-dot:nth-child(3){animation-delay:0.3s;}
@keyframes typingAnim{0%,80%,100%{opacity:0.3;transform:scale(0.8);}40%{opacity:1;transform:scale(1.1);}}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);backdrop-filter:blur(4px);z-index:100;display:none;align-items:center;justify-content:center;padding:16px;}
.modal-overlay.open{display:flex;}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:var(--r-lg);padding:24px;width:100%;max-width:500px;box-shadow:var(--shadow);animation:modalIn 0.2s ease;max-height:90vh;overflow-y:auto;}
.modal-title{font-family:var(--font-head);font-size:20px;font-weight:900;margin-bottom:18px;display:flex;align-items:center;gap:8px;}

/* TOAST */
.toast-container{position:fixed;bottom:16px;right:16px;z-index:200;display:flex;flex-direction:column;gap:8px;}
.toast{padding:10px 16px;border-radius:var(--r);border:1px solid var(--border);background:var(--surface2);font-size:13px;animation:toastIn 0.25s ease both;max-width:260px;box-shadow:var(--shadow);}
@keyframes toastIn{from{opacity:0;transform:translateX(20px);}to{opacity:1;transform:translateX(0);}}
.toast.success{border-color:rgba(200,240,96,0.4);color:var(--accent);}
.toast.error{border-color:rgba(240,96,168,0.4);color:var(--accent3);}
.toast.info{border-color:rgba(96,212,240,0.3);color:var(--accent2);}

/* TIMELINE */
.timeline{display:flex;flex-direction:column;gap:10px;}
.timeline-item{display:flex;gap:14px;align-items:flex-start;padding:14px 18px;background:var(--surface);border:1px solid var(--border);border-radius:var(--r-lg);animation:cardIn 0.3s ease both;transition:border-color 0.2s;}
.timeline-item:hover{border-color:var(--accent2);}
.timeline-date{text-align:center;min-width:46px;flex-shrink:0;}
.timeline-day{font-family:var(--font-head);font-size:24px;font-weight:900;line-height:1;color:var(--accent);}
.timeline-month{font-size:10px;color:var(--muted);letter-spacing:1px;text-transform:uppercase;}
.timeline-content{flex:1;}
.timeline-title{font-family:var(--font-head);font-size:15px;font-weight:600;margin-bottom:4px;}

/* BOTTOM NAV */
.bottom-nav{display:none;position:fixed;bottom:0;left:0;right:0;background:rgba(20,20,23,0.97);backdrop-filter:blur(12px);border-top:1px solid var(--border);z-index:40;padding:8px 0 calc(8px + env(safe-area-inset-bottom));justify-content:space-around;align-items:center;}
.bottom-nav-btn{display:flex;flex-direction:column;align-items:center;gap:3px;background:none;border:none;color:var(--muted);font-family:var(--font-mono);font-size:10px;cursor:pointer;padding:6px 10px;border-radius:var(--r);transition:all 0.15s;min-width:50px;}
.bottom-nav-btn .bn-icon{font-size:18px;}
.bottom-nav-btn.active{color:var(--accent);}
.drawer-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:55;}
.drawer-overlay.open{display:block;}

::-webkit-scrollbar{width:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}

/* TABLET */
@media(max-width:1023px){
  .app{grid-template-columns:200px 1fr;}
  .ai-panel{position:fixed;top:0;right:-100%;width:min(340px,90vw);height:100%;z-index:60;border-left:1px solid var(--border);transition:right 0.3s ease;box-shadow:-8px 0 32px rgba(0,0,0,0.5);}
  .ai-panel.open{right:0;}
  .ai-close{display:block;}
  .ai-toggle{display:flex;align-items:center;gap:6px;}
  .header-stats{display:none;}
  .dash-row{grid-template-columns:1fr;}
}
/* MOBILE */
@media(max-width:767px){
  .app{grid-template-columns:1fr;grid-template-rows:56px 1fr;height:100vh;}
  .sidebar{position:fixed;top:0;left:-100%;width:260px;height:100%;z-index:60;border-right:1px solid var(--border);transition:left 0.3s ease;box-shadow:8px 0 32px rgba(0,0,0,0.5);padding-top:72px;}
  .sidebar.open{left:0;}
  .hamburger{display:flex;}
  .ai-toggle{display:flex;align-items:center;gap:5px;font-size:11px;}
  .header-stats{display:none;}
  header{padding:0 14px;}
  .logo{font-size:18px;}
  .main{padding:16px 14px 80px;}
  .bottom-nav{display:flex;}
  .task-grid{grid-template-columns:1fr;}
  .form-row{grid-template-columns:1fr;}
  .page-title{font-size:22px;}
  .filter-chip{font-size:11px;padding:5px 10px;}
  .search-box{max-width:100%;}
  .modal{padding:18px;}
  .form-actions{justify-content:stretch;}
  .form-actions .btn{flex:1;justify-content:center;}
  .toast-container{bottom:76px;right:12px;left:12px;}
  .toast{max-width:100%;}
  .ai-panel{position:fixed;top:0;right:-100%;width:100%;height:100%;z-index:60;transition:right 0.3s ease;}
  .ai-panel.open{right:0;}
  .ai-close{display:block;}
  .dash-grid{grid-template-columns:1fr 1fr;}
  .dash-row{grid-template-columns:1fr;}
}
@media(min-width:1400px){
  .app{grid-template-columns:260px 1fr 320px;}
  .task-grid{grid-template-columns:repeat(auto-fill,minmax(280px,1fr));}
  .page-title{font-size:32px;}
}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     AUTH SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="authScreen">
  <div class="auth-box">
    <div class="auth-logo">Study<span>Bot</span> ğŸ“š</div>
    <div class="auth-subtitle">Your AI-powered study assistant</div>
    <div class="auth-tabs">
      <button class="auth-tab active" id="loginTab" onclick="switchAuthTab('login')">Login</button>
      <button class="auth-tab" id="registerTab" onclick="switchAuthTab('register')">Register</button>
    </div>
    <div id="loginForm">
      <div class="auth-field"><label>Username</label><input type="text" id="loginUser" placeholder="Enter your username"></div>
      <div class="auth-field"><label>Password</label><input type="password" id="loginPass" placeholder="Enter your password" onkeydown="if(event.key==='Enter')doLogin()"></div>
      <button class="auth-btn" onclick="doLogin()">Login â†’</button>
      <div class="auth-error" id="loginError"></div>
      <div class="auth-user-list" id="savedUsersList"></div>
    </div>
    <div id="registerForm" style="display:none">
      <div class="auth-field"><label>Username</label><input type="text" id="regUser" placeholder="Choose a username"></div>
      <div class="auth-field"><label>Password</label><input type="password" id="regPass" placeholder="Choose a password"></div>
      <div class="auth-field"><label>Confirm Password</label><input type="password" id="regPass2" placeholder="Confirm your password" onkeydown="if(event.key==='Enter')doRegister()"></div>
      <button class="auth-btn" onclick="doRegister()">Create Account â†’</button>
      <div class="auth-error" id="registerError"></div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MAIN APP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="app" id="mainApp" style="display:none">
  <header>
    <div style="display:flex;align-items:center;gap:10px;">
      <button class="hamburger" onclick="toggleSidebar()" aria-label="Menu">
        <span></span><span></span><span></span>
      </button>
      <div class="logo"><div class="logo-dot"></div>Study<span>Bot</span></div>
    </div>
    <div class="header-right">
      <div class="header-stats" id="headerStats">Loading...</div>
      <button class="ai-toggle" onclick="toggleAI()">ğŸ¤– StudyBot</button>
      <div class="user-badge" onclick="doLogout()" id="userBadge" title="Click to logout">
        <div class="user-avatar" id="userAvatarLetter">?</div>
        <span id="userDisplayName">User</span>
        <span style="color:var(--muted);font-size:10px;">âœ•</span>
      </div>
    </div>
  </header>

  <aside class="sidebar" id="sidebar">
    <div class="sidebar-section">
      <div class="sidebar-label">Navigate</div>
      <button class="nav-btn active" data-page="dashboard" onclick="showPage('dashboard',this)"><span class="icon">ğŸ“Š</span>Dashboard</button>
      <button class="nav-btn" data-page="tasks" onclick="showPage('tasks',this)"><span class="icon">ğŸ“‹</span>All Tasks</button>
      <button class="nav-btn" data-page="upcoming" onclick="showPage('upcoming',this)"><span class="icon">ğŸ“…</span>Upcoming</button>
      <button class="nav-btn" data-page="add" onclick="showPage('add',this)"><span class="icon">âœï¸</span>Add Task</button>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-label">Overview</div>
      <div class="mini-stat"><span>Pending</span><span class="val" id="statPending">â€”</span></div>
      <div class="mini-stat"><span>In Progress</span><span class="val" id="statInProgress">â€”</span></div>
      <div class="mini-stat"><span>Done</span><span class="val done" id="statDone">â€”</span></div>
      <div class="mini-stat"><span>High Priority</span><span class="val high" id="statHigh">â€”</span></div>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-label">Filter</div>
      <button class="nav-btn" onclick="filterByStatus('pending');closeSidebar()"><span class="icon">ğŸŸ¡</span>Pending</button>
      <button class="nav-btn" onclick="filterByStatus('in-progress');closeSidebar()"><span class="icon">ğŸ”µ</span>In Progress</button>
      <button class="nav-btn" onclick="filterByStatus('completed');closeSidebar()"><span class="icon">âœ…</span>Completed</button>
      <button class="nav-btn" onclick="filterByStatus(null);closeSidebar()"><span class="icon">ğŸ”„</span>Clear Filter</button>
    </div>
  </aside>

  <main class="main">

    <!-- DASHBOARD PAGE -->
    <div class="page active" id="page-dashboard">
      <div>
        <div class="dash-greeting">Good <span id="timeGreeting">day</span>, <span id="greetName">Student</span>! ğŸ‘‹</div>
        <div class="dash-subtitle" id="dashMotivation">Loading your study overview...</div>
      </div>
      <div class="dash-grid" id="dashStats"></div>
      <div class="dash-row">
        <div class="dash-panel">
          <div class="dash-panel-title">ğŸ“ˆ Task Completion Chart</div>
          <div class="chart-wrap"><canvas id="taskChart"></canvas></div>
        </div>
        <div class="dash-panel">
          <div class="dash-panel-title">ğŸ”¥ Study Streak (Last 7 Days)</div>
          <div class="streak-row" id="streakRow"></div>
          <div style="margin-top:12px;font-size:12px;color:var(--muted);">Complete tasks daily to build your streak!</div>
        </div>
      </div>
      <div class="dash-panel">
        <div class="dash-panel-title">ğŸ“‹ Recent Tasks</div>
        <div id="recentTasks"></div>
      </div>
    </div>

    <!-- TASKS PAGE -->
    <div class="page" id="page-tasks">
      <h1 class="page-title">Your <em>Tasks</em></h1>
      <div class="toolbar">
        <input class="search-box" type="text" placeholder="ğŸ” Search tasks..." id="searchBox" oninput="renderTasks()">
        <button class="filter-chip active" onclick="setFilter('all',this)">All</button>
        <button class="filter-chip" onclick="setFilter('high',this)">ğŸ”´ High</button>
        <button class="filter-chip" onclick="setFilter('medium',this)">ğŸŸ¡ Medium</button>
        <button class="filter-chip" onclick="setFilter('low',this)">ğŸŸ¢ Low</button>
      </div>
      <div class="task-grid" id="taskGrid"></div>
    </div>

    <!-- UPCOMING PAGE -->
    <div class="page" id="page-upcoming">
      <h1 class="page-title"><em>Upcoming</em> Deadlines</h1>
      <div class="timeline" id="upcomingList"></div>
    </div>

    <!-- ADD TASK PAGE -->
    <div class="page" id="page-add">
      <h1 class="page-title">Add <em>New</em> Task</h1>
      <form class="add-form" onsubmit="submitTask(event)">
        <div class="form-group full"><label>Task Title *</label><input type="text" id="f-title" placeholder="e.g. Write Chemistry Lab Report" required></div>
        <div class="form-row">
          <div class="form-group"><label>Subject</label><input type="text" id="f-subject" placeholder="e.g. Chemistry"></div>
          <div class="form-group"><label>Due Date</label><input type="date" id="f-due"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Priority</label><select id="f-priority"><option value="medium">ğŸŸ¡ Medium</option><option value="high">ğŸ”´ High</option><option value="low">ğŸŸ¢ Low</option></select></div>
          <div class="form-group"><label>Status</label><select id="f-status"><option value="pending">Pending</option><option value="in-progress">In Progress</option><option value="completed">Completed</option></select></div>
        </div>
        <div class="form-group full"><label>Notes</label><textarea id="f-desc" placeholder="Any extra details..."></textarea></div>
        <div class="form-actions">
          <button type="button" class="btn btn-ai" onclick="aiSuggestPriorityForNew()">âœ¨ AI Priority</button>
          <button type="button" class="btn btn-secondary" onclick="resetForm()">Clear</button>
          <button type="submit" class="btn btn-primary">â• Add Task</button>
        </div>
      </form>
    </div>

  </main>

  <!-- AI PANEL -->
  <aside class="ai-panel" id="aiPanel">
    <div class="ai-header">
      <div class="ai-avatar">ğŸ¤–</div>
      <div><div class="ai-name">StudyBot AI</div><div class="ai-status">â— Online â€” Claude</div></div>
      <button class="ai-close" onclick="toggleAI()">âœ•</button>
    </div>
    <div class="ai-messages" id="aiMessages"></div>
    <div class="quick-prompts">
      <button class="quick-btn" onclick="quickPrompt('What should I focus on today?')">Focus today</button>
      <button class="quick-btn" onclick="quickPrompt('Am I overloaded this week?')">Overloaded?</button>
      <button class="quick-btn" onclick="quickPrompt('What are my high priority tasks?')">High priority</button>
      <button class="quick-btn" onclick="quickPrompt('Give me a study schedule')">Study plan</button>
    </div>
    <div class="ai-input-row">
      <input class="ai-input" id="aiInput" type="text" placeholder="Ask StudyBot..." onkeydown="if(event.key==='Enter')sendMessage()">
      <button class="send-btn" id="sendBtn" onclick="sendMessage()">â¤</button>
    </div>
  </aside>
</div>

<!-- Bottom Nav -->
<nav class="bottom-nav">
  <button class="bottom-nav-btn active" id="bn-dashboard" onclick="showPage('dashboard',null);setBottomNav('bn-dashboard')"><span class="bn-icon">ğŸ“Š</span>Dash</button>
  <button class="bottom-nav-btn" id="bn-tasks" onclick="showPage('tasks',null);setBottomNav('bn-tasks')"><span class="bn-icon">ğŸ“‹</span>Tasks</button>
  <button class="bottom-nav-btn" id="bn-upcoming" onclick="showPage('upcoming',null);setBottomNav('bn-upcoming')"><span class="bn-icon">ğŸ“…</span>Soon</button>
  <button class="bottom-nav-btn" id="bn-add" onclick="showPage('add',null);setBottomNav('bn-add')"><span class="bn-icon">â•</span>Add</button>
  <button class="bottom-nav-btn" id="bn-ai" onclick="toggleAI()"><span class="bn-icon">ğŸ¤–</span>AI</button>
</nav>

<div class="drawer-overlay" id="drawerOverlay" onclick="closeAll()"></div>

<!-- Edit Modal -->
<div class="modal-overlay" id="editModal">
  <div class="modal">
    <div class="modal-title">âœï¸ Edit Task</div>
    <form onsubmit="submitEdit(event)" style="display:flex;flex-direction:column;gap:12px">
      <input type="hidden" id="e-id">
      <div class="form-group"><label>Title</label><input type="text" id="e-title" required></div>
      <div class="form-row">
        <div class="form-group"><label>Subject</label><input type="text" id="e-subject"></div>
        <div class="form-group"><label>Due Date</label><input type="date" id="e-due"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Priority</label><select id="e-priority"><option value="medium">ğŸŸ¡ Medium</option><option value="high">ğŸ”´ High</option><option value="low">ğŸŸ¢ Low</option></select></div>
        <div class="form-group"><label>Status</label><select id="e-status"><option value="pending">Pending</option><option value="in-progress">In Progress</option><option value="completed">Completed</option></select></div>
      </div>
      <div class="form-group"><label>Notes</label><textarea id="e-desc"></textarea></div>
      <div class="form-actions">
        <button type="button" class="btn btn-ai" onclick="aiSubtasks()">âœ¨ Subtasks</button>
        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button type="submit" class="btn btn-primary">Save</button>
      </div>
    </form>
  </div>
</div>

<div class="toast-container" id="toastContainer"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STORAGE HELPERS (localStorage cache)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const USERS_KEY = 'studybot_users';
const SESSION_KEY = 'studybot_session';
const CHAT_KEY = 'studybot_chat_';

function getUsers() { try { return JSON.parse(localStorage.getItem(USERS_KEY)||'{}'); } catch{ return {}; } }
function saveUsers(u) { localStorage.setItem(USERS_KEY, JSON.stringify(u)); }
function getSession() { try { return JSON.parse(localStorage.getItem(SESSION_KEY)||'null'); } catch{ return null; } }
function saveSession(s) { localStorage.setItem(SESSION_KEY, JSON.stringify(s)); }
function clearSession() { localStorage.removeItem(SESSION_KEY); }
function getChatHistory(user) { try { return JSON.parse(localStorage.getItem(CHAT_KEY+user)||'[]'); } catch{ return []; } }
function saveChatHistory(user, hist) { localStorage.setItem(CHAT_KEY+user, JSON.stringify(hist.slice(-40))); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentUser = null;

function switchAuthTab(tab) {
  document.getElementById('loginTab').classList.toggle('active', tab==='login');
  document.getElementById('registerTab').classList.toggle('active', tab==='register');
  document.getElementById('loginForm').style.display = tab==='login'?'':'none';
  document.getElementById('registerForm').style.display = tab==='register'?'':'none';
}

function showSavedUsers() {
  const users = getUsers();
  const keys = Object.keys(users);
  const el = document.getElementById('savedUsersList');
  if (!keys.length) { el.innerHTML=''; return; }
  el.innerHTML = `<div class="auth-user-list-title">Quick login</div>` +
    keys.map(u=>`<span class="auth-user-chip" onclick="quickLogin('${u}')">ğŸ‘¤ ${u}</span>`).join('');
}

function quickLogin(username) {
  document.getElementById('loginUser').value = username;
  document.getElementById('loginPass').focus();
}

function doLogin() {
  const user = document.getElementById('loginUser').value.trim();
  const pass = document.getElementById('loginPass').value;
  const err = document.getElementById('loginError');
  if (!user||!pass) { err.textContent='Please fill in all fields.'; return; }
  const users = getUsers();
  if (!users[user]) { err.textContent='Username not found. Please register.'; return; }
  if (users[user].password !== btoa(pass)) { err.textContent='Incorrect password.'; return; }
  err.textContent='';
  saveSession({ username: user, loginTime: Date.now() });
  startApp(user);
}

function doRegister() {
  const user = document.getElementById('regUser').value.trim();
  const pass = document.getElementById('regPass').value;
  const pass2 = document.getElementById('regPass2').value;
  const err = document.getElementById('registerError');
  if (!user||!pass) { err.textContent='Please fill in all fields.'; return; }
  if (user.length < 3) { err.textContent='Username must be at least 3 characters.'; return; }
  if (pass.length < 4) { err.textContent='Password must be at least 4 characters.'; return; }
  if (pass !== pass2) { err.textContent='Passwords do not match.'; return; }
  const users = getUsers();
  if (users[user]) { err.textContent='Username already taken.'; return; }
  users[user] = { password: btoa(pass), createdAt: Date.now() };
  saveUsers(users);
  err.textContent='';
  saveSession({ username: user, loginTime: Date.now() });
  startApp(user);
}

function doLogout() {
  if (!confirm('Log out?')) return;
  // save chat before logout
  saveChatHistory(currentUser, chatHistory);
  clearSession();
  currentUser = null;
  chatHistory = [];
  document.getElementById('mainApp').style.display='none';
  document.getElementById('authScreen').style.display='flex';
  document.getElementById('loginUser').value='';
  document.getElementById('loginPass').value='';
  document.getElementById('loginError').textContent='';
  showSavedUsers();
}

function startApp(username) {
  currentUser = username;
  document.getElementById('authScreen').style.display='none';
  document.getElementById('mainApp').style.display='grid';
  document.getElementById('userDisplayName').textContent = username;
  document.getElementById('userAvatarLetter').textContent = username[0].toUpperCase();

  // restore chat history
  chatHistory = getChatHistory(username);
  restoreChatUI();

  // set greeting
  const h = new Date().getHours();
  const greet = h<12?'morning':h<17?'afternoon':'evening';
  document.getElementById('timeGreeting').textContent = greet;
  document.getElementById('greetName').textContent = username;

  loadTasks();
  setInterval(loadTasks, 30000);
  setInterval(()=>saveChatHistory(currentUser, chatHistory), 10000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// APP STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let tasks=[], filterPriority='all', filterStatus=null, chatHistory=[];
let taskChartInstance=null;

function toast(msg,type='info'){const el=document.createElement('div');el.className=`toast ${type}`;el.textContent=msg;document.getElementById('toastContainer').appendChild(el);setTimeout(()=>el.remove(),3000);}
function formatDate(s){if(!s)return null;return new Date(s+'T00:00:00').toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'});}
function isOverdue(s){return s&&new Date(s+'T23:59:59')<new Date();}
function escHtml(s){return(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}

async function api(method,path,body){
  const res=await fetch(path,{method,headers:body?{'Content-Type':'application/json'}:{},body:body?JSON.stringify(body):undefined});
  return res.json();
}

async function loadTasks(){
  try{
    tasks=await api('GET','/api/tasks');
    renderTasks();
    updateStats();
    renderDashboard();
  }catch(e){toast('Cannot connect to server','error');}
}

async function updateStats(){
  try{
    const s=await api('GET','/api/summary');
    document.getElementById('statPending').textContent=s.by_status.pending||0;
    document.getElementById('statInProgress').textContent=s.by_status['in-progress']||0;
    document.getElementById('statDone').textContent=s.by_status.completed||0;
    document.getElementById('statHigh').textContent=s.by_priority.high||0;
    document.getElementById('headerStats').innerHTML=`<strong>${s.total}</strong> tasks Â· <strong>${s.by_status.pending||0}</strong> pending`;
  }catch(e){}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDashboard(){
  const total=tasks.length;
  const done=tasks.filter(t=>t.status==='completed').length;
  const pending=tasks.filter(t=>t.status==='pending').length;
  const high=tasks.filter(t=>t.priority==='high'&&t.status!=='completed').length;
  const pct=total?Math.round(done/total*100):0;
  const overdue=tasks.filter(t=>isOverdue(t.due_date)&&t.status!=='completed').length;

  // motivation message
  const motivations=[
    `You've completed ${pct}% of your tasks. Keep going! ğŸš€`,
    `${pending} tasks waiting â€” let's tackle them one by one! ğŸ’ª`,
    `${high} high-priority tasks need your attention today! ğŸ”¥`,
    `Great work! Stay consistent and you'll crush your goals. â­`,
  ];
  document.getElementById('dashMotivation').textContent = motivations[Math.floor(Math.random()*motivations.length)];

  document.getElementById('dashStats').innerHTML=`
    <div class="dash-card"><div class="dash-card-label">Total Tasks</div><div class="dash-card-val blue">${total}</div><div class="dash-card-sub">All time</div></div>
    <div class="dash-card"><div class="dash-card-label">Completed</div><div class="dash-card-val green">${done}</div><div class="dash-card-sub">${pct}% done</div></div>
    <div class="dash-card"><div class="dash-card-label">Pending</div><div class="dash-card-val">${pending}</div><div class="dash-card-sub">To do</div></div>
    <div class="dash-card"><div class="dash-card-label">High Priority</div><div class="dash-card-val pink">${high}</div><div class="dash-card-sub">Urgent</div></div>
    <div class="dash-card"><div class="dash-card-label">Overdue</div><div class="dash-card-val ${overdue?'pink':''}">${overdue}</div><div class="dash-card-sub">${overdue?'âš ï¸ Attention':'All on time âœ…'}</div></div>
    <div class="dash-card"><div class="dash-card-label">Completion</div><div class="dash-card-val green">${pct}%</div><div class="dash-card-sub">Success rate</div></div>
  `;

  // Chart
  const ctx=document.getElementById('taskChart').getContext('2d');
  if(taskChartInstance) taskChartInstance.destroy();
  const inprog=tasks.filter(t=>t.status==='in-progress').length;
  taskChartInstance=new Chart(ctx,{
    type:'doughnut',
    data:{
      labels:['Completed','In Progress','Pending'],
      datasets:[{data:[done,inprog,pending],backgroundColor:['#c8f060','#60d4f0','#2a2a32'],borderColor:'#141417',borderWidth:2}]
    },
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#e8e8ec',font:{family:'DM Mono',size:11}}}}}
  });

  // Streak
  const days=['S','M','T','W','T','F','S'];
  const today=new Date();
  let streakHtml='';
  for(let i=6;i>=0;i--){
    const d=new Date(today);d.setDate(d.getDate()-i);
    const ds=d.toISOString().split('T')[0];
    const hasActivity=tasks.some(t=>t.updated_at&&t.updated_at.startsWith(ds)&&t.status==='completed');
    const isToday=i===0;
    streakHtml+=`<div class="streak-day ${isToday?'today':hasActivity?'active':''}" title="${ds}">${days[d.getDay()]}</div>`;
  }
  document.getElementById('streakRow').innerHTML=streakHtml;

  // Recent tasks
  const recent=[...tasks].sort((a,b)=>new Date(b.updated_at)-new Date(a.updated_at)).slice(0,5);
  document.getElementById('recentTasks').innerHTML=recent.length?recent.map(t=>`
    <div class="recent-task-item">
      <span>${escHtml(t.title)}</span>
      <span class="badge badge-${t.status}">${t.status}</span>
    </div>`).join(''):'<div style="color:var(--muted);font-size:13px;padding:10px 0;">No tasks yet â€” add one to get started!</div>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TASK RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTasks(){
  const q=document.getElementById('searchBox').value.toLowerCase();
  let filtered=tasks.filter(t=>
    (filterPriority==='all'||t.priority===filterPriority)&&
    (!filterStatus||t.status===filterStatus)&&
    (!q||t.title.toLowerCase().includes(q)||(t.subject||'').toLowerCase().includes(q)||(t.description||'').toLowerCase().includes(q))
  );
  const grid=document.getElementById('taskGrid');
  if(!filtered.length){grid.innerHTML=`<div class="empty-state"><div class="big">ğŸ“­</div><p>No tasks yet.<br>Add one to get started!</p></div>`;return;}
  grid.innerHTML=filtered.map(taskCard).join('');
}

function taskCard(t){
  const overdue=isOverdue(t.due_date)&&t.status!=='completed';
  const sub=(t.subtasks||[]).map((s,i)=>`<div class="subtask-item ${s.done?'done':''}" onclick="toggleSubtask('${t.id}',${i})"><div class="subtask-check">${s.done?'âœ“':''}</div><span>${escHtml(s.text)}</span></div>`).join('');
  return`<div class="task-card priority-${t.priority} ${t.status==='completed'?'completed':''}">
    <div class="task-card-top"><div class="task-title">${escHtml(t.title)}</div>
    <div class="task-card-actions">
      <button class="icon-btn ai-btn" onclick="openEditWithSubtasks('${t.id}')" title="AI subtasks">âœ¨</button>
      <button class="icon-btn" onclick="openEdit('${t.id}')" title="Edit">âœï¸</button>
      <button class="icon-btn" onclick="quickComplete('${t.id}')" title="Done">âœ…</button>
      <button class="icon-btn danger" onclick="deleteTask('${t.id}')" title="Delete">ğŸ—‘</button>
    </div></div>
    ${t.description?`<div class="task-desc">${escHtml(t.description)}</div>`:''}
    <div class="task-meta">
      ${t.subject?`<span class="badge badge-subject">${escHtml(t.subject)}</span>`:''}
      <span class="badge badge-${t.priority}">${t.priority}</span>
      <span class="badge badge-${t.status}">${t.status}</span>
    </div>
    ${t.due_date?`<div class="task-due ${overdue?'overdue':''}">${overdue?'âš ï¸':'ğŸ“…'} ${formatDate(t.due_date)}${overdue?' â€” Overdue!':''}</div>`:''}
    ${sub?`<div class="subtasks-list">${sub}</div>`:''}
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showPage(name,btn){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('page-'+name).classList.add('active');
  if(btn)btn.classList.add('active');
  if(name==='upcoming')loadUpcoming();
  if(name==='dashboard')renderDashboard();
  closeSidebar();
}
function setBottomNav(id){document.querySelectorAll('.bottom-nav-btn').forEach(b=>b.classList.remove('active'));document.getElementById(id)?.classList.add('active');}
function toggleSidebar(){document.getElementById('sidebar').classList.toggle('open');document.getElementById('drawerOverlay').classList.toggle('open');}
function closeSidebar(){document.getElementById('sidebar').classList.remove('open');document.getElementById('drawerOverlay').classList.remove('open');}
function toggleAI(){const p=document.getElementById('aiPanel');const o=document.getElementById('drawerOverlay');const isOpen=p.classList.toggle('open');o.classList.toggle('open',isOpen);}
function closeAll(){document.getElementById('sidebar').classList.remove('open');document.getElementById('aiPanel').classList.remove('open');document.getElementById('drawerOverlay').classList.remove('open');}

async function loadUpcoming(){
  const items=await api('GET','/api/upcoming?days=14');
  const list=document.getElementById('upcomingList');
  if(!items.length){list.innerHTML=`<div class="empty-state"><div class="big">ğŸ‰</div><p>Nothing due in the next 2 weeks!</p></div>`;return;}
  list.innerHTML=items.map(t=>{const d=new Date(t.due_date+'T00:00:00');return`
    <div class="timeline-item">
      <div class="timeline-date"><div class="timeline-day">${d.getDate()}</div><div class="timeline-month">${d.toLocaleString('en',{month:'short'})}</div></div>
      <div class="timeline-content"><div class="timeline-title">${escHtml(t.title)}</div>
      <div class="task-meta">${t.subject?`<span class="badge badge-subject">${escHtml(t.subject)}</span>`:''}<span class="badge badge-${t.priority}">${t.priority}</span></div></div>
      <div style="display:flex;gap:6px;align-items:center"><button class="icon-btn" onclick="openEdit('${t.id}')">âœï¸</button><button class="icon-btn" onclick="quickComplete('${t.id}')">âœ…</button></div>
    </div>`;}).join('');
}

function setFilter(val,btn){filterPriority=val;document.querySelectorAll('.filter-chip').forEach(c=>c.classList.remove('active'));btn.classList.add('active');renderTasks();}
function filterByStatus(val){filterStatus=val;showPage('tasks',document.querySelector('[data-page="tasks"]'));renderTasks();}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CRUD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function submitTask(e){
  e.preventDefault();
  const data={title:document.getElementById('f-title').value,subject:document.getElementById('f-subject').value,due_date:document.getElementById('f-due').value||null,priority:document.getElementById('f-priority').value,status:document.getElementById('f-status').value,description:document.getElementById('f-desc').value};
  const result=await api('POST','/api/tasks',data);
  if(result.error){toast(result.error,'error');return;}
  toast('Task added! âœ…','success');resetForm();await loadTasks();
  showPage('tasks',document.querySelector('[data-page="tasks"]'));setBottomNav('bn-tasks');
}
function resetForm(){['f-title','f-subject','f-due','f-desc'].forEach(id=>document.getElementById(id).value='');document.getElementById('f-priority').value='medium';document.getElementById('f-status').value='pending';}
async function deleteTask(id){if(!confirm('Delete this task?'))return;await api('DELETE',`/api/tasks/${id}`);toast('Task deleted','info');await loadTasks();}
async function quickComplete(id){const task=tasks.find(t=>t.id===id);if(!task)return;const ns=task.status==='completed'?'pending':'completed';await api('PUT',`/api/tasks/${id}`,{status:ns});toast(ns==='completed'?'âœ… Done!':'ğŸ”„ Reopened','success');await loadTasks();}
function toggleSubtask(taskId,idx){const task=tasks.find(t=>t.id===taskId);if(!task||!task.subtasks)return;task.subtasks[idx].done=!task.subtasks[idx].done;renderTasks();}

function openEdit(id){const t=tasks.find(t=>t.id===id);if(!t)return;document.getElementById('e-id').value=t.id;document.getElementById('e-title').value=t.title;document.getElementById('e-subject').value=t.subject||'';document.getElementById('e-due').value=t.due_date||'';document.getElementById('e-priority').value=t.priority;document.getElementById('e-status').value=t.status;document.getElementById('e-desc').value=t.description||'';document.getElementById('editModal').classList.add('open');}
function closeModal(){document.getElementById('editModal').classList.remove('open');}
async function submitEdit(e){e.preventDefault();const id=document.getElementById('e-id').value;const data={title:document.getElementById('e-title').value,subject:document.getElementById('e-subject').value,due_date:document.getElementById('e-due').value||null,priority:document.getElementById('e-priority').value,status:document.getElementById('e-status').value,description:document.getElementById('e-desc').value};const result=await api('PUT',`/api/tasks/${id}`,data);if(result.error){toast(result.error,'error');return;}toast('Task updated! âœ…','success');closeModal();await loadTasks();}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function aiSuggestPriorityForNew(){const title=document.getElementById('f-title').value;if(!title){toast('Enter a title first','info');return;}toast('âœ¨ Asking AI...','info');try{const res=await api('POST','/api/ai/chat',{message:`Suggest priority (reply with ONLY one word: low, medium, or high) for: "${title}", subject:"${document.getElementById('f-subject').value}"`,history:[]});const word=res.reply?.toLowerCase().match(/\b(low|medium|high)\b/);if(word){document.getElementById('f-priority').value=word[0];toast(`AI suggests: ${word[0]} priority`,'success');}}catch(e){toast('AI unavailable','error');}}
async function openEditWithSubtasks(id){openEdit(id);await aiSubtasksForTask(id);}
async function aiSubtasks(){await aiSubtasksForTask(document.getElementById('e-id').value);}
async function aiSubtasksForTask(id){toast('âœ¨ Generating subtasks...','info');const res=await api('POST',`/api/ai/subtasks/${id}`);if(res.error){toast(res.error,'error');return;}const task=tasks.find(t=>t.id===id);if(task){task.subtasks=res.subtasks.map(s=>({text:s,done:false}));renderTasks();toast(`Generated ${res.subtasks.length} subtasks! âœ¨`,'success');}}

async function sendMessage(){
  const input=document.getElementById('aiInput');const msg=input.value.trim();if(!msg)return;input.value='';
  appendMsg('user',msg);chatHistory.push({role:'user',content:msg});
  document.getElementById('sendBtn').disabled=true;
  const typingId='typing-'+Date.now();
  document.getElementById('aiMessages').insertAdjacentHTML('beforeend',`<div class="msg ai" id="${typingId}"><div class="msg-avatar">ğŸ¤–</div><div class="msg-bubble"><div class="typing"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div></div></div>`);
  scrollChat();
  try{
    const res=await api('POST','/api/ai/chat',{message:msg,history:chatHistory.slice(-10)});
    document.getElementById(typingId)?.remove();
    const reply=res.reply||res.error||'Something went wrong.';
    appendMsg('ai',reply);chatHistory.push({role:'assistant',content:reply});
    saveChatHistory(currentUser,chatHistory);
  }catch(e){document.getElementById(typingId)?.remove();appendMsg('ai','âš ï¸ Could not reach the server.');}
  document.getElementById('sendBtn').disabled=false;
}

function appendMsg(role,text){
  const avatar=role==='ai'?'ğŸ¤–':'ğŸ§‘';
  document.getElementById('aiMessages').insertAdjacentHTML('beforeend',
    `<div class="msg ${role}">${role==='ai'?`<div class="msg-avatar">${avatar}</div>`:''}<div class="msg-bubble">${escHtml(text).replace(/\n/g,'<br>')}</div>${role==='user'?`<div class="msg-avatar">${avatar}</div>`:''}</div>`);
  scrollChat();
}
function scrollChat(){const el=document.getElementById('aiMessages');el.scrollTop=el.scrollHeight;}
function quickPrompt(text){document.getElementById('aiInput').value=text;sendMessage();}

function restoreChatUI(){
  const container=document.getElementById('aiMessages');
  container.innerHTML='';
  if(!chatHistory.length){
    container.innerHTML=`<div class="msg ai"><div class="msg-avatar">ğŸ¤–</div><div class="msg-bubble">Hey! ğŸ‘‹ Welcome back! I'm StudyBot. I remember our previous chats and can see all your tasks.<br><br>What would you like to work on today?</div></div>`;
    return;
  }
  chatHistory.forEach(m=>appendMsg(m.role==='assistant'?'ai':'user', m.content));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT â€” check for existing session
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function init(){
  showSavedUsers();
  const session=getSession();
  if(session&&session.username){
    const users=getUsers();
    if(users[session.username]){
      startApp(session.username);
    } else {
      clearSession();
    }
  }
})();
</script>
</body>
</html>