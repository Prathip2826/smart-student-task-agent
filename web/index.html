<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>StudyBot â€” Smart Task Agent</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Fraunces:ital,wght@0,600;0,900;1,400&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
:root{
  --bg:#080c14;
  --surface:#0f1623;
  --surface2:#162032;
  --surface3:#1e2d45;
  --border:#1e3050;
  --border2:#2a4060;
  --accent:#4ade80;
  --accent2:#38bdf8;
  --accent3:#f472b6;
  --accent4:#fb923c;
  --text:#e2eaf5;
  --text2:#94a3b8;
  --text3:#64748b;
  --font:'Inter',sans-serif;
  --font-head:'Fraunces',Georgia,serif;
  --r:10px;--r-lg:16px;--r-xl:24px;
  --shadow:0 8px 40px rgba(0,0,0,0.6);
  --glow-green:0 0 20px rgba(74,222,128,0.15);
  --glow-blue:0 0 20px rgba(56,189,248,0.15);
}
html{scroll-behavior:smooth;}
body{background:var(--bg);color:var(--text);font-family:var(--font);font-size:14px;line-height:1.6;min-height:100vh;overflow-x:hidden;}
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
  background:
    radial-gradient(ellipse 80% 50% at 100% 0%,rgba(56,189,248,0.07) 0%,transparent 60%),
    radial-gradient(ellipse 60% 60% at 0% 100%,rgba(74,222,128,0.06) 0%,transparent 60%),
    radial-gradient(ellipse 40% 40% at 50% 50%,rgba(244,114,182,0.03) 0%,transparent 70%);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUTH SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#authScreen{position:fixed;inset:0;z-index:300;display:flex;align-items:center;justify-content:center;background:var(--bg);padding:16px;}
.auth-wrap{width:100%;max-width:420px;}
.auth-logo-big{font-family:var(--font-head);font-size:36px;font-weight:900;text-align:center;margin-bottom:4px;letter-spacing:-1px;}
.auth-logo-big span{color:var(--accent);}
.auth-tagline{text-align:center;color:var(--text2);font-size:13px;margin-bottom:32px;}
.auth-box{background:var(--surface);border:1px solid var(--border2);border-radius:var(--r-xl);padding:32px;box-shadow:var(--shadow);}
.auth-tabs{display:flex;background:var(--surface2);border-radius:var(--r);padding:4px;margin-bottom:24px;gap:4px;}
.auth-tab{flex:1;padding:9px;background:transparent;border:none;color:var(--text2);font-family:var(--font);font-size:13px;font-weight:500;cursor:pointer;border-radius:8px;transition:all 0.2s;}
.auth-tab.active{background:var(--accent);color:#0a1a0f;font-weight:700;}
.auth-field{margin-bottom:16px;}
.auth-field label{display:block;font-size:11px;font-weight:600;letter-spacing:1px;text-transform:uppercase;color:var(--text3);margin-bottom:6px;}
.auth-field input{width:100%;background:var(--surface2);border:1.5px solid var(--border2);border-radius:var(--r);padding:11px 14px;color:var(--text);font-family:var(--font);font-size:14px;outline:none;transition:all 0.2s;}
.auth-field input:focus{border-color:var(--accent2);box-shadow:0 0 0 3px rgba(56,189,248,0.12);}
.auth-field input::placeholder{color:var(--text3);}
.auth-submit{width:100%;padding:13px;border-radius:var(--r);border:none;background:linear-gradient(135deg,var(--accent),#22c55e);color:#052010;font-family:var(--font);font-size:14px;font-weight:700;cursor:pointer;transition:all 0.2s;margin-top:4px;letter-spacing:0.3px;}
.auth-submit:hover{transform:translateY(-1px);box-shadow:var(--glow-green);}
.auth-err{color:var(--accent3);font-size:12px;text-align:center;margin-top:10px;min-height:16px;font-weight:500;}
.auth-divider{text-align:center;color:var(--text3);font-size:12px;margin:20px 0 12px;position:relative;}
.auth-divider::before{content:'';position:absolute;left:0;top:50%;width:100%;height:1px;background:var(--border);z-index:0;}
.auth-divider span{position:relative;z-index:1;background:var(--surface);padding:0 12px;}
.quick-users{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;}
.quick-chip{display:flex;align-items:center;gap:6px;padding:6px 14px;border-radius:100px;background:var(--surface2);border:1px solid var(--border2);font-size:12px;cursor:pointer;color:var(--text2);transition:all 0.2s;}
.quick-chip:hover{border-color:var(--accent);color:var(--accent);}
.quick-chip-avatar{width:20px;height:20px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:#052010;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   APP LAYOUT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#mainApp{position:relative;z-index:1;display:grid;grid-template-columns:260px 1fr 320px;grid-template-rows:64px 1fr;height:100vh;}

header{grid-column:1/-1;display:flex;align-items:center;justify-content:space-between;padding:0 24px;border-bottom:1px solid var(--border);background:rgba(8,12,20,0.96);backdrop-filter:blur(16px);position:sticky;top:0;z-index:50;}
.logo{font-family:var(--font-head);font-size:22px;font-weight:900;letter-spacing:-0.5px;display:flex;align-items:center;gap:10px;color:var(--text);}
.logo em{color:var(--accent);font-style:normal;}
.logo-dot{width:9px;height:9px;border-radius:50%;background:var(--accent);box-shadow:0 0 8px var(--accent);animation:pulse 2s infinite;}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1);}50%{opacity:0.5;transform:scale(0.75);}}
.header-center{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--text3);}
.header-center strong{color:var(--accent);}
.header-right{display:flex;align-items:center;gap:10px;}
.notif-btn{position:relative;width:36px;height:36px;border-radius:var(--r);background:var(--surface2);border:1px solid var(--border2);color:var(--text2);font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.15s;}
.notif-btn:hover{border-color:var(--accent4);color:var(--accent4);}
.notif-badge{position:absolute;top:-4px;right:-4px;width:16px;height:16px;border-radius:50%;background:var(--accent3);font-size:9px;font-weight:700;color:#fff;display:flex;align-items:center;justify-content:center;border:2px solid var(--bg);}
.notif-badge.hidden{display:none;}
.user-pill{display:flex;align-items:center;gap:8px;padding:5px 12px 5px 5px;background:var(--surface2);border:1px solid var(--border2);border-radius:100px;cursor:pointer;transition:all 0.15s;font-size:13px;font-weight:500;}
.user-pill:hover{border-color:var(--accent3);}
.u-avatar{width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#052010;}
.hamburger{display:none;flex-direction:column;gap:5px;background:none;border:none;cursor:pointer;padding:6px;}
.hamburger span{display:block;width:22px;height:2px;background:var(--text);border-radius:2px;}
.ai-toggle-btn{display:none;align-items:center;gap:6px;padding:7px 14px;background:rgba(74,222,128,0.1);border:1px solid rgba(74,222,128,0.25);color:var(--accent);border-radius:var(--r);font-size:12px;font-weight:600;cursor:pointer;}

/* SIDEBAR */
.sidebar{background:var(--surface);border-right:1px solid var(--border);padding:20px 14px;overflow-y:auto;display:flex;flex-direction:column;gap:8px;}
.sidebar-label{font-size:10px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--text3);padding:0 10px;margin:16px 0 6px;}
.sidebar-label:first-child{margin-top:0;}
.nav-btn{display:flex;align-items:center;gap:12px;width:100%;padding:11px 14px;border-radius:var(--r);border:none;background:transparent;color:var(--text2);font-family:var(--font);font-size:13px;font-weight:500;cursor:pointer;transition:all 0.15s;text-align:left;}
.nav-btn:hover{background:var(--surface2);color:var(--text);}
.nav-btn.active{background:rgba(74,222,128,0.12);color:var(--accent);border:1px solid rgba(74,222,128,0.2);}
.nav-btn .icon{font-size:17px;width:22px;text-align:center;}
.stat-mini{display:flex;justify-content:space-between;align-items:center;padding:8px 14px;font-size:12px;color:var(--text3);}
.stat-mini-val{font-family:var(--font-head);font-size:20px;font-weight:900;color:var(--text);}
.stat-mini-val.green{color:var(--accent);}
.stat-mini-val.red{color:var(--accent3);}
.stat-mini-val.blue{color:var(--accent2);}
.sidebar-divider{height:1px;background:var(--border);margin:6px 10px;}

/* MAIN */
.main{overflow-y:auto;padding:28px 32px;display:flex;flex-direction:column;gap:24px;background:transparent;}
.page{display:none;flex-direction:column;gap:24px;}
.page.active{display:flex;}
.page-header{display:flex;flex-direction:column;gap:4px;}
.page-title{font-family:var(--font-head);font-size:30px;font-weight:900;letter-spacing:-0.5px;line-height:1.1;}
.page-title em{color:var(--accent);font-style:italic;}
.page-sub{font-size:13px;color:var(--text3);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DASHBOARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.dash-greeting{font-family:var(--font-head);font-size:26px;font-weight:900;letter-spacing:-0.5px;}
.dash-greeting span{color:var(--accent);}
.dash-sub{color:var(--text3);font-size:13px;margin-top:4px;}

.kpi-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:14px;}
.kpi-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r-lg);padding:20px 18px;display:flex;flex-direction:column;gap:8px;transition:all 0.2s;cursor:default;}
.kpi-card:hover{transform:translateY(-3px);border-color:var(--border2);box-shadow:var(--shadow);}
.kpi-icon{font-size:22px;}
.kpi-val{font-family:var(--font-head);font-size:34px;font-weight:900;line-height:1;}
.kpi-val.green{color:var(--accent);}
.kpi-val.blue{color:var(--accent2);}
.kpi-val.pink{color:var(--accent3);}
.kpi-val.orange{color:var(--accent4);}
.kpi-label{font-size:11px;color:var(--text3);font-weight:600;letter-spacing:0.3px;}
.kpi-trend{font-size:11px;color:var(--text3);}

.dash-panels{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
.panel{background:var(--surface);border:1px solid var(--border);border-radius:var(--r-lg);padding:20px;}
.panel-title{font-size:11px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--text3);margin-bottom:16px;display:flex;align-items:center;gap:8px;}
.panel-title span{font-size:14px;}
.chart-wrap{position:relative;height:170px;}

/* Streak */
.streak-days{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-bottom:14px;}
.s-day{aspect-ratio:1;border-radius:6px;background:var(--surface2);border:1px solid var(--border);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;}
.s-day .s-label{font-size:9px;color:var(--text3);font-weight:600;letter-spacing:0.5px;}
.s-day .s-dot{width:8px;height:8px;border-radius:50%;background:var(--border);}
.s-day.active .s-dot{background:var(--accent);box-shadow:0 0 6px var(--accent);}
.s-day.active .s-label{color:var(--accent);}
.s-day.today{border-color:var(--accent2);}
.s-day.today .s-label{color:var(--accent2);}
.streak-score{display:flex;align-items:center;gap:10px;padding:12px;background:var(--surface2);border-radius:var(--r);margin-top:8px;}
.streak-fire{font-size:28px;}
.streak-num{font-family:var(--font-head);font-size:24px;font-weight:900;color:var(--accent4);}
.streak-txt{font-size:12px;color:var(--text3);}

/* Performance */
.perf-item{display:flex;align-items:center;gap:10px;margin-bottom:12px;}
.perf-label{font-size:12px;color:var(--text2);width:90px;flex-shrink:0;}
.perf-bar-wrap{flex:1;height:7px;background:var(--surface2);border-radius:4px;overflow:hidden;}
.perf-bar{height:100%;border-radius:4px;transition:width 1s ease;}
.perf-pct{font-size:12px;color:var(--text2);width:32px;text-align:right;font-weight:600;}

/* Recent */
.recent-list{display:flex;flex-direction:column;gap:8px;}
.recent-item{display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--surface2);border-radius:var(--r);border:1px solid transparent;transition:border-color 0.15s;}
.recent-item:hover{border-color:var(--border2);}
.recent-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.recent-title{flex:1;font-size:13px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.recent-status{font-size:10px;padding:3px 8px;border-radius:100px;border:1px solid;font-weight:600;}

/* NOTIFICATIONS PANEL */
.notif-panel{position:fixed;top:70px;right:20px;width:340px;background:var(--surface);border:1px solid var(--border2);border-radius:var(--r-lg);box-shadow:var(--shadow);z-index:100;display:none;flex-direction:column;overflow:hidden;max-height:500px;}
.notif-panel.open{display:flex;}
.notif-header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;}
.notif-header-title{font-weight:700;font-size:14px;}
.notif-clear{background:none;border:none;color:var(--text3);font-size:12px;cursor:pointer;padding:4px 8px;border-radius:6px;transition:all 0.15s;}
.notif-clear:hover{color:var(--accent3);}
.notif-list{overflow-y:auto;flex:1;}
.notif-item{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;gap:10px;align-items:flex-start;transition:background 0.15s;}
.notif-item:hover{background:var(--surface2);}
.notif-item.unread{border-left:3px solid var(--accent4);}
.notif-icon{font-size:18px;flex-shrink:0;margin-top:1px;}
.notif-body{flex:1;}
.notif-text{font-size:13px;font-weight:500;line-height:1.4;}
.notif-time{font-size:11px;color:var(--text3);margin-top:3px;}
.notif-empty{padding:32px;text-align:center;color:var(--text3);font-size:13px;}

/* TASKS */
.toolbar{display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
.filter-chip{padding:7px 16px;border-radius:100px;border:1px solid var(--border2);background:transparent;color:var(--text3);font-family:var(--font);font-size:12px;font-weight:500;cursor:pointer;transition:all 0.15s;}
.filter-chip:hover{border-color:var(--accent);color:var(--accent);}
.filter-chip.active{background:var(--accent);color:#052010;border-color:var(--accent);font-weight:700;}
.search-box{flex:1;min-width:140px;max-width:280px;padding:9px 16px;border-radius:100px;border:1.5px solid var(--border2);background:var(--surface2);color:var(--text);font-family:var(--font);font-size:13px;outline:none;transition:all 0.2s;}
.search-box:focus{border-color:var(--accent2);box-shadow:0 0 0 3px rgba(56,189,248,0.1);}
.search-box::placeholder{color:var(--text3);}

.task-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px;}
.task-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r-lg);padding:18px 20px;transition:all 0.2s;position:relative;overflow:hidden;}
.task-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;opacity:0;transition:opacity 0.2s;}
.task-card:hover{border-color:var(--border2);transform:translateY(-2px);box-shadow:0 8px 30px rgba(0,0,0,0.4);}
.task-card:hover::before{opacity:1;}
.task-card.priority-high::before{background:var(--accent3);opacity:1;}
.task-card.priority-medium::before{background:var(--accent);opacity:0.7;}
.task-card.priority-low::before{background:var(--accent2);opacity:0.4;}
.task-card-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px;gap:8px;}
.task-title{font-family:var(--font-head);font-size:16px;font-weight:600;line-height:1.3;flex:1;}
.task-card.completed .task-title{text-decoration:line-through;color:var(--text3);}
.task-card-actions{display:flex;gap:4px;flex-shrink:0;opacity:0;transition:opacity 0.2s;}
.task-card:hover .task-card-actions{opacity:1;}
@media(hover:none){.task-card-actions{opacity:1!important;}}
.icon-btn{width:30px;height:30px;border-radius:8px;border:none;background:var(--surface2);color:var(--text3);font-size:13px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.15s;}
.icon-btn:hover{background:var(--surface3);color:var(--text);}
.icon-btn.danger:hover{background:rgba(244,114,182,0.15);color:var(--accent3);}
.icon-btn.ai-btn:hover{background:rgba(74,222,128,0.12);color:var(--accent);}
.task-desc{font-size:12px;color:var(--text3);margin-top:6px;line-height:1.5;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;white-space:normal;word-break:break-word;}
.task-meta{display:flex;gap:6px;flex-wrap:wrap;margin-top:10px;}
.badge{padding:3px 9px;border-radius:100px;font-size:11px;font-weight:600;border:1px solid;}
.badge-subject{background:rgba(56,189,248,0.1);color:var(--accent2);border-color:rgba(56,189,248,0.2);}
.badge-high{background:rgba(244,114,182,0.1);color:var(--accent3);border-color:rgba(244,114,182,0.2);}
.badge-medium{background:rgba(74,222,128,0.1);color:var(--accent);border-color:rgba(74,222,128,0.2);}
.badge-low{background:rgba(100,116,139,0.15);color:var(--text3);border-color:var(--border2);}
.badge-pending{background:rgba(251,146,60,0.1);color:var(--accent4);border-color:rgba(251,146,60,0.2);}
.badge-in-progress{background:rgba(56,189,248,0.1);color:var(--accent2);border-color:rgba(56,189,248,0.2);}
.badge-completed{background:rgba(74,222,128,0.1);color:var(--accent);border-color:rgba(74,222,128,0.2);}
.task-due{font-size:12px;color:var(--text3);margin-top:8px;display:flex;align-items:center;gap:5px;}
.task-due.overdue{color:var(--accent3);font-weight:600;}
.subtasks-list{margin-top:12px;padding-top:12px;border-top:1px solid var(--border);display:flex;flex-direction:column;gap:5px;}
.subtask-item{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--text3);cursor:pointer;padding:3px 0;transition:color 0.15s;}
.subtask-item:hover{color:var(--text);}
.subtask-check{width:15px;height:15px;border-radius:4px;border:1.5px solid var(--border2);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:9px;transition:all 0.15s;}
.subtask-item.done .subtask-check{background:var(--accent);border-color:var(--accent);color:#052010;}
.subtask-item.done span{text-decoration:line-through;color:var(--text3);}
.empty-state{grid-column:1/-1;text-align:center;padding:60px 20px;color:var(--text3);}
.empty-state .big{font-size:48px;margin-bottom:12px;}
.empty-state p{font-family:var(--font-head);font-style:italic;font-size:18px;color:var(--text2);}

/* ADD FORM */
.add-form{background:var(--surface);border:1px solid var(--border);border-radius:var(--r-lg);padding:28px;display:flex;flex-direction:column;gap:18px;}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
.form-group{display:flex;flex-direction:column;gap:6px;}
.form-group.full{grid-column:1/-1;}
label{font-size:11px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--text3);}
input[type="text"],input[type="date"],input[type="email"],input[type="password"],textarea,select{background:var(--surface2);border:1.5px solid var(--border2);border-radius:var(--r);padding:11px 14px;color:var(--text);font-family:var(--font);font-size:13px;outline:none;transition:all 0.2s;width:100%;}
input:focus,textarea:focus,select:focus{border-color:var(--accent2);box-shadow:0 0 0 3px rgba(56,189,248,0.1);}
input::placeholder,textarea::placeholder{color:var(--text3);}
textarea{resize:vertical;min-height:80px;}
select option{background:var(--surface2);}
.btn{padding:11px 20px;border-radius:var(--r);border:none;font-family:var(--font);font-size:13px;font-weight:600;cursor:pointer;transition:all 0.15s;display:inline-flex;align-items:center;gap:6px;}
.btn-primary{background:linear-gradient(135deg,var(--accent),#22c55e);color:#052010;}
.btn-primary:hover{transform:translateY(-1px);box-shadow:var(--glow-green);}
.btn-secondary{background:var(--surface2);color:var(--text);border:1.5px solid var(--border2);}
.btn-secondary:hover{border-color:var(--accent2);color:var(--accent2);}
.btn-ai{background:rgba(74,222,128,0.1);color:var(--accent);border:1.5px solid rgba(74,222,128,0.25);}
.btn-ai:hover{background:rgba(74,222,128,0.18);}
.form-actions{display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;}

/* PERFORMANCE PAGE */
.perf-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:14px;}
.perf-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r-lg);padding:20px;display:flex;flex-direction:column;gap:6px;}
.perf-card-title{font-size:11px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--text3);}
.perf-card-val{font-family:var(--font-head);font-size:32px;font-weight:900;}
.perf-card-desc{font-size:12px;color:var(--text3);}
.progress-wrap{margin-top:8px;}
.progress-bar-bg{height:6px;background:var(--surface2);border-radius:3px;overflow:hidden;}
.progress-bar-fill{height:100%;border-radius:3px;transition:width 1.2s cubic-bezier(.4,0,.2,1);}
.heatmap{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;}
.heat-cell{aspect-ratio:1;border-radius:4px;background:var(--surface2);transition:all 0.3s;}
.heat-cell.l1{background:rgba(74,222,128,0.25);}
.heat-cell.l2{background:rgba(74,222,128,0.5);}
.heat-cell.l3{background:rgba(74,222,128,0.75);}
.heat-cell.l4{background:var(--accent);}

/* TIMELINE */
.timeline{display:flex;flex-direction:column;gap:12px;}
.tl-item{display:flex;gap:16px;align-items:flex-start;padding:16px 20px;background:var(--surface);border:1px solid var(--border);border-radius:var(--r-lg);transition:all 0.2s;}
.tl-item:hover{border-color:var(--border2);transform:translateX(3px);}
.tl-date{text-align:center;min-width:44px;flex-shrink:0;}
.tl-day{font-family:var(--font-head);font-size:26px;font-weight:900;line-height:1;color:var(--accent2);}
.tl-month{font-size:10px;color:var(--text3);letter-spacing:1px;text-transform:uppercase;margin-top:2px;}
.tl-content{flex:1;}
.tl-title{font-family:var(--font-head);font-size:16px;font-weight:600;margin-bottom:6px;}
.tl-actions{display:flex;gap:6px;align-items:center;}

/* AI PANEL */
.ai-panel{background:var(--surface);border-left:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;}
.ai-head{padding:16px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;}
.ai-avatar-wrap{width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:17px;flex-shrink:0;box-shadow:var(--glow-green);}
.ai-info{flex:1;}
.ai-name{font-weight:700;font-size:14px;}
.ai-status{font-size:11px;color:var(--accent);display:flex;align-items:center;gap:4px;}
.ai-status::before{content:'';width:6px;height:6px;border-radius:50%;background:var(--accent);display:inline-block;animation:pulse 2s infinite;}
.ai-close-btn{display:none;background:none;border:none;color:var(--text3);font-size:18px;cursor:pointer;padding:4px 8px;border-radius:6px;transition:all 0.15s;margin-left:auto;}
.ai-close-btn:hover{color:var(--accent3);background:rgba(244,114,182,0.1);}
.ai-messages{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:12px;}
.msg{display:flex;gap:8px;animation:msgIn 0.25s ease both;}
@keyframes msgIn{from{opacity:0;transform:translateY(6px);}to{opacity:1;transform:translateY(0);}}
.msg.user{flex-direction:row-reverse;}
.msg-bubble{max-width:88%;padding:10px 14px;border-radius:14px;font-size:13px;line-height:1.55;}
.msg.ai .msg-bubble{background:var(--surface2);border:1px solid var(--border2);border-bottom-left-radius:4px;}
.msg.user .msg-bubble{background:rgba(74,222,128,0.12);border:1px solid rgba(74,222,128,0.2);border-bottom-right-radius:4px;}
.msg-av{width:26px;height:26px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0;align-self:flex-end;}
.msg.ai .msg-av{background:linear-gradient(135deg,var(--accent),var(--accent2));}
.msg.user .msg-av{background:var(--surface2);border:1px solid var(--border2);}
.quick-chips{padding:10px 16px;display:flex;gap:6px;flex-wrap:wrap;border-top:1px solid var(--border);}
.q-chip{padding:5px 11px;border-radius:100px;border:1px solid var(--border2);background:transparent;color:var(--text3);font-family:var(--font);font-size:11px;font-weight:500;cursor:pointer;transition:all 0.15s;white-space:nowrap;}
.q-chip:hover{border-color:var(--accent);color:var(--accent);background:rgba(74,222,128,0.06);}
.ai-input-row{padding:12px 16px;display:flex;gap:8px;border-top:1px solid var(--border);}
.ai-input{flex:1;background:var(--surface2);border:1.5px solid var(--border2);border-radius:var(--r);padding:10px 14px;color:var(--text);font-family:var(--font);font-size:13px;outline:none;transition:all 0.2s;}
.ai-input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(74,222,128,0.1);}
.send-btn{width:38px;height:38px;border-radius:10px;border:none;background:linear-gradient(135deg,var(--accent),#22c55e);color:#052010;font-size:15px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.15s;flex-shrink:0;}
.send-btn:hover{transform:scale(1.05);}
.send-btn:disabled{background:var(--surface2);color:var(--text3);cursor:default;transform:none;}
.typing-row{display:flex;gap:4px;padding:10px 14px;}
.t-dot{width:7px;height:7px;border-radius:50%;background:var(--text3);animation:tdot 1.2s ease-in-out infinite;}
.t-dot:nth-child(2){animation-delay:.15s;}.t-dot:nth-child(3){animation-delay:.3s;}
@keyframes tdot{0%,80%,100%{opacity:0.3;transform:scale(0.8);}40%{opacity:1;transform:scale(1.15);}}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.75);backdrop-filter:blur(6px);z-index:200;display:none;align-items:center;justify-content:center;padding:16px;}
.modal-overlay.open{display:flex;}
.modal{background:var(--surface);border:1px solid var(--border2);border-radius:var(--r-xl);padding:28px;width:100%;max-width:520px;box-shadow:var(--shadow);max-height:90vh;overflow-y:auto;}
.modal-title{font-family:var(--font-head);font-size:22px;font-weight:900;margin-bottom:20px;display:flex;align-items:center;gap:10px;}

/* TOAST */
.toast-container{position:fixed;bottom:20px;right:20px;z-index:500;display:flex;flex-direction:column;gap:8px;}
.toast{padding:11px 18px;border-radius:var(--r);border:1px solid var(--border2);background:var(--surface2);font-size:13px;font-weight:500;animation:toastIn .25s ease both;max-width:280px;box-shadow:var(--shadow);}
@keyframes toastIn{from{opacity:0;transform:translateX(20px);}to{opacity:1;transform:translateX(0);}}
.toast.success{border-color:rgba(74,222,128,0.4);color:var(--accent);}
.toast.error{border-color:rgba(244,114,182,0.4);color:var(--accent3);}
.toast.info{border-color:rgba(56,189,248,0.3);color:var(--accent2);}
.toast.warn{border-color:rgba(251,146,60,0.4);color:var(--accent4);}

/* BOTTOM NAV */
.bottom-nav{display:none;position:fixed;bottom:0;left:0;right:0;background:rgba(8,12,20,0.97);backdrop-filter:blur(16px);border-top:1px solid var(--border);z-index:40;padding:8px 4px calc(8px + env(safe-area-inset-bottom));justify-content:space-around;align-items:center;}
.bn-btn{display:flex;flex-direction:column;align-items:center;gap:3px;background:none;border:none;color:var(--text3);font-family:var(--font);font-size:10px;font-weight:500;cursor:pointer;padding:6px 10px;border-radius:var(--r);transition:all 0.15s;min-width:52px;}
.bn-btn .bni{font-size:19px;}
.bn-btn.active{color:var(--accent);}
.drawer-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:55;backdrop-filter:blur(2px);}
.drawer-overlay.open{display:block;}

::-webkit-scrollbar{width:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}

/* RESPONSIVE */
@media(max-width:1199px){
  #mainApp{grid-template-columns:240px 1fr;}
  .ai-panel{position:fixed;top:0;right:-100%;width:min(360px,92vw);height:100%;z-index:60;transition:right 0.3s ease;box-shadow:-12px 0 40px rgba(0,0,0,0.6);}
  .ai-panel.open{right:0;}
  .ai-close-btn{display:block;}
  .ai-toggle-btn{display:flex;}
  .header-center{display:none;}
  .dash-panels{grid-template-columns:1fr;}
}
@media(max-width:767px){
  #mainApp{grid-template-columns:1fr;grid-template-rows:60px 1fr;}
  .sidebar{position:fixed;top:0;left:-100%;width:270px;height:100%;z-index:60;transition:left 0.3s ease;padding-top:76px;box-shadow:12px 0 40px rgba(0,0,0,0.6);}
  .sidebar.open{left:0;}
  .hamburger{display:flex;}
  header{padding:0 16px;}
  .logo{font-size:19px;}
  .main{padding:18px 16px 80px;}
  .bottom-nav{display:flex;}
  .task-grid{grid-template-columns:1fr;}
  .form-row{grid-template-columns:1fr;}
  .page-title{font-size:24px;}
  .kpi-grid{grid-template-columns:1fr 1fr;}
  .modal{padding:20px;}
  .form-actions{justify-content:stretch;}
  .form-actions .btn{flex:1;justify-content:center;}
  .toast-container{bottom:76px;right:12px;left:12px;}
  .toast{max-width:100%;}
  .ai-panel{position:fixed;top:0;right:-100%;width:100%;height:100%;z-index:60;transition:right 0.3s ease;}
  .ai-panel.open{right:0;}
  .notif-panel{right:12px;left:12px;width:auto;}
  .dash-panels{grid-template-columns:1fr;}
  .add-form{padding:18px;}
  .perf-grid{grid-template-columns:1fr 1fr;}
}
@media(min-width:1400px){
  #mainApp{grid-template-columns:280px 1fr 340px;}
  .main{padding:32px 40px;}
  .kpi-grid{grid-template-columns:repeat(6,1fr);}
}
</style>
</head>
<body>

<!-- AUTH -->
<div id="authScreen">
  <div class="auth-wrap">
    <div class="auth-logo-big">Study<span>Bot</span> ğŸ“š</div>
    <div class="auth-tagline">Your AI-powered personal study assistant</div>
    <div class="auth-box">
      <div class="auth-tabs">
        <button class="auth-tab active" id="tabLogin" onclick="switchTab('login')">Login</button>
        <button class="auth-tab" id="tabReg" onclick="switchTab('register')">Register</button>
      </div>
      <!-- LOGIN -->
      <div id="loginForm">
        <div class="auth-field"><label>Email</label><input type="email" id="l-email" placeholder="you@email.com" autocomplete="email"></div>
        <div class="auth-field"><label>Password</label><input type="password" id="l-pass" placeholder="Your password" onkeydown="if(event.key==='Enter')doLogin()"></div>
        <button class="auth-submit" onclick="doLogin()">Login â†’</button>
        <div class="auth-err" id="l-err"></div>
        <div id="savedUsersWrap"></div>
      </div>
      <!-- REGISTER -->
      <div id="regForm" style="display:none">
        <div class="auth-field"><label>Name</label><input type="text" id="r-name" placeholder="Your full name"></div>
        <div class="auth-field"><label>Email</label><input type="email" id="r-email" placeholder="you@email.com" autocomplete="email"></div>
        <div class="auth-field"><label>Password</label><input type="password" id="r-pass" placeholder="Min. 4 characters"></div>
        <div class="auth-field"><label>Confirm Password</label><input type="password" id="r-pass2" placeholder="Repeat password" onkeydown="if(event.key==='Enter')doRegister()"></div>
        <button class="auth-submit" onclick="doRegister()">Create Account â†’</button>
        <div class="auth-err" id="r-err"></div>
      </div>
    </div>
  </div>
</div>

<!-- MAIN APP -->
<div id="mainApp" style="display:none">
  <header>
    <div style="display:flex;align-items:center;gap:12px;">
      <button class="hamburger" onclick="toggleSidebar()"><span></span><span></span><span></span></button>
      <div class="logo"><div class="logo-dot"></div>Study<em>Bot</em></div>
    </div>
    <div class="header-center" id="headerStats">Loading...</div>
    <div class="header-right">
      <button class="ai-toggle-btn" onclick="toggleAI()">ğŸ¤– StudyBot</button>
      <button class="notif-btn" id="notifBtn" onclick="toggleNotifPanel()" title="Notifications">
        ğŸ””
        <div class="notif-badge hidden" id="notifBadge">0</div>
      </button>
      <div class="user-pill" id="userPill" onclick="doLogout()" title="Click to logout">
        <div class="u-avatar" id="uAvatar">?</div>
        <span id="uName">User</span>
        <span style="color:var(--text3);font-size:11px;">âœ•</span>
      </div>
    </div>
  </header>

  <aside class="sidebar" id="sidebar">
    <div class="sidebar-label">Main</div>
    <button class="nav-btn active" data-page="dashboard" onclick="showPage('dashboard',this)"><span class="icon">ğŸ“Š</span>Dashboard</button>
    <button class="nav-btn" data-page="tasks" onclick="showPage('tasks',this)"><span class="icon">ğŸ“‹</span>All Tasks</button>
    <button class="nav-btn" data-page="upcoming" onclick="showPage('upcoming',this)"><span class="icon">ğŸ“…</span>Upcoming</button>
    <button class="nav-btn" data-page="performance" onclick="showPage('performance',this)"><span class="icon">ğŸ“ˆ</span>Performance</button>
    <button class="nav-btn" data-page="add" onclick="showPage('add',this)"><span class="icon">â•</span>Add Task</button>
    <div class="sidebar-divider"></div>
    <div class="sidebar-label">Overview</div>
    <div class="stat-mini"><span>Pending</span><span class="stat-mini-val" id="sPending">â€”</span></div>
    <div class="stat-mini"><span>In Progress</span><span class="stat-mini-val blue" id="sProgress">â€”</span></div>
    <div class="stat-mini"><span>Done</span><span class="stat-mini-val green" id="sDone">â€”</span></div>
    <div class="stat-mini"><span>High Priority</span><span class="stat-mini-val red" id="sHigh">â€”</span></div>
    <div class="sidebar-divider"></div>
    <div class="sidebar-label">Filter</div>
    <button class="nav-btn" onclick="quickFilter('pending')"><span class="icon">ğŸŸ¡</span>Pending</button>
    <button class="nav-btn" onclick="quickFilter('in-progress')"><span class="icon">ğŸ”µ</span>In Progress</button>
    <button class="nav-btn" onclick="quickFilter('completed')"><span class="icon">âœ…</span>Completed</button>
    <button class="nav-btn" onclick="quickFilter(null)"><span class="icon">ğŸ”„</span>Clear Filter</button>
  </aside>

  <main class="main" id="mainContent">

    <!-- DASHBOARD -->
    <div class="page active" id="page-dashboard">
      <div>
        <div class="dash-greeting" id="dashGreeting">Loading...</div>
        <div class="dash-sub" id="dashSub">Your study overview for today</div>
      </div>
      <div class="kpi-grid" id="kpiGrid"></div>
      <div class="dash-panels">
        <div class="panel">
          <div class="panel-title"><span>ğŸ“Š</span>Task Breakdown</div>
          <div class="chart-wrap"><canvas id="taskChart"></canvas></div>
        </div>
        <div class="panel">
          <div class="panel-title"><span>ğŸ”¥</span>Study Streak</div>
          <div class="streak-days" id="streakDays"></div>
          <div class="streak-score">
            <div class="streak-fire">ğŸ”¥</div>
            <div>
              <div class="streak-num" id="streakCount">0</div>
              <div class="streak-txt">day streak</div>
            </div>
          </div>
        </div>
      </div>
      <div class="panel">
        <div class="panel-title"><span>ğŸ“‹</span>Recent Activity</div>
        <div class="recent-list" id="recentList"></div>
      </div>
    </div>

    <!-- TASKS -->
    <div class="page" id="page-tasks">
      <div class="page-header">
        <div class="page-title">Your <em>Tasks</em></div>
        <div class="page-sub" id="taskCount">Loading...</div>
      </div>
      <div class="toolbar">
        <input class="search-box" type="text" placeholder="ğŸ” Search tasks..." id="searchBox" oninput="renderTasks()">
        <button class="filter-chip active" onclick="setPriorityFilter('all',this)">All</button>
        <button class="filter-chip" onclick="setPriorityFilter('high',this)">ğŸ”´ High</button>
        <button class="filter-chip" onclick="setPriorityFilter('medium',this)">ğŸŸ¡ Medium</button>
        <button class="filter-chip" onclick="setPriorityFilter('low',this)">ğŸŸ¢ Low</button>
      </div>
      <div class="task-grid" id="taskGrid"></div>
    </div>

    <!-- UPCOMING -->
    <div class="page" id="page-upcoming">
      <div class="page-header">
        <div class="page-title"><em>Upcoming</em> Deadlines</div>
        <div class="page-sub">Next 14 days</div>
      </div>
      <div class="timeline" id="upcomingList"></div>
    </div>

    <!-- PERFORMANCE -->
    <div class="page" id="page-performance">
      <div class="page-header">
        <div class="page-title">Your <em>Performance</em></div>
        <div class="page-sub">Track your progress and study habits</div>
      </div>
      <div class="perf-grid" id="perfGrid"></div>
      <div class="dash-panels">
        <div class="panel">
          <div class="panel-title"><span>ğŸ“Š</span>Subject Progress</div>
          <div id="subjectProgress"></div>
        </div>
        <div class="panel">
          <div class="panel-title"><span>ğŸ—“</span>28-Day Activity</div>
          <div class="heatmap" id="heatmap"></div>
          <div style="margin-top:10px;font-size:11px;color:var(--text3);">Each cell = 1 day. Darker = more tasks completed.</div>
        </div>
      </div>
      <div class="panel">
        <div class="panel-title"><span>ğŸ“ˆ</span>Weekly Completion</div>
        <div class="chart-wrap"><canvas id="perfChart"></canvas></div>
      </div>
    </div>

    <!-- ADD TASK -->
    <div class="page" id="page-add">
      <div class="page-header">
        <div class="page-title">Add <em>New</em> Task</div>
        <div class="page-sub">Fill in the details below</div>
      </div>
      <form class="add-form" onsubmit="submitTask(event)">
        <div class="form-group full"><label>Task Title *</label><input type="text" id="f-title" placeholder="e.g. Write Chemistry Lab Report" required></div>
        <div class="form-row">
          <div class="form-group"><label>Subject</label><input type="text" id="f-subject" placeholder="e.g. Chemistry"></div>
          <div class="form-group"><label>Due Date</label><input type="date" id="f-due"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Priority</label><select id="f-priority"><option value="medium">ğŸŸ¡ Medium</option><option value="high">ğŸ”´ High</option><option value="low">ğŸŸ¢ Low</option></select></div>
          <div class="form-group"><label>Status</label><select id="f-status"><option value="pending">Pending</option><option value="in-progress">In Progress</option><option value="completed">Completed</option></select></div>
        </div>
        <div class="form-group full"><label>Notes</label><textarea id="f-desc" placeholder="Any extra details..."></textarea></div>
        <div class="form-actions">
          <button type="button" class="btn btn-ai" onclick="aiSuggestPriority()">âœ¨ AI Priority</button>
          <button type="button" class="btn btn-secondary" onclick="resetForm()">Clear</button>
          <button type="submit" class="btn btn-primary">â• Add Task</button>
        </div>
      </form>
    </div>

  </main>

  <!-- AI PANEL -->
  <aside class="ai-panel" id="aiPanel">
    <div class="ai-head">
      <div class="ai-avatar-wrap">ğŸ¤–</div>
      <div class="ai-info">
        <div class="ai-name">StudyBot AI</div>
        <div class="ai-status">Online Â· Powered by AI</div>
      </div>
      <button class="ai-close-btn" onclick="toggleAI()">âœ•</button>
    </div>
    <div class="ai-messages" id="aiMessages"></div>
    <div class="quick-chips">
      <button class="q-chip" onclick="qp('What should I focus on today?')">Focus today</button>
      <button class="q-chip" onclick="qp('Am I overloaded this week?')">Overloaded?</button>
      <button class="q-chip" onclick="qp('What are my high priority tasks?')">High priority</button>
      <button class="q-chip" onclick="qp('Give me a study schedule')">Study plan</button>
    </div>
    <div class="ai-input-row">
      <input class="ai-input" id="aiInput" type="text" placeholder="Ask StudyBot..." onkeydown="if(event.key==='Enter')sendMsg()">
      <button class="send-btn" id="sendBtn" onclick="sendMsg()">â¤</button>
    </div>
  </aside>
</div>

<!-- Bottom Nav -->
<nav class="bottom-nav">
  <button class="bn-btn active" id="bn-dashboard" onclick="showPage('dashboard',null);setBN('bn-dashboard')"><span class="bni">ğŸ“Š</span>Dash</button>
  <button class="bn-btn" id="bn-tasks" onclick="showPage('tasks',null);setBN('bn-tasks')"><span class="bni">ğŸ“‹</span>Tasks</button>
  <button class="bn-btn" id="bn-upcoming" onclick="showPage('upcoming',null);setBN('bn-upcoming')"><span class="bni">ğŸ“…</span>Soon</button>
  <button class="bn-btn" id="bn-performance" onclick="showPage('performance',null);setBN('bn-performance')"><span class="bni">ğŸ“ˆ</span>Stats</button>
  <button class="bn-btn" id="bn-add" onclick="showPage('add',null);setBN('bn-add')"><span class="bni">â•</span>Add</button>
  <button class="bn-btn" id="bn-ai" onclick="toggleAI()"><span class="bni">ğŸ¤–</span>AI</button>
</nav>

<div class="drawer-overlay" id="drawerOverlay" onclick="closeAll()"></div>

<!-- Notifications Panel -->
<div class="notif-panel" id="notifPanel">
  <div class="notif-header">
    <div class="notif-header-title">ğŸ”” Notifications</div>
    <button class="notif-clear" onclick="clearNotifs()">Clear all</button>
  </div>
  <div class="notif-list" id="notifList"></div>
</div>

<!-- Edit Modal -->
<div class="modal-overlay" id="editModal">
  <div class="modal">
    <div class="modal-title">âœï¸ Edit Task</div>
    <form onsubmit="submitEdit(event)" style="display:flex;flex-direction:column;gap:14px;">
      <input type="hidden" id="e-id">
      <div class="form-group"><label>Title</label><input type="text" id="e-title" required></div>
      <div class="form-row">
        <div class="form-group"><label>Subject</label><input type="text" id="e-subject"></div>
        <div class="form-group"><label>Due Date</label><input type="date" id="e-due"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Priority</label><select id="e-priority"><option value="medium">ğŸŸ¡ Medium</option><option value="high">ğŸ”´ High</option><option value="low">ğŸŸ¢ Low</option></select></div>
        <div class="form-group"><label>Status</label><select id="e-status"><option value="pending">Pending</option><option value="in-progress">In Progress</option><option value="completed">Completed</option></select></div>
      </div>
      <div class="form-group"><label>Notes</label><textarea id="e-desc"></textarea></div>
      <div class="form-actions">
        <button type="button" class="btn btn-ai" onclick="genSubtasks()">âœ¨ Subtasks</button>
        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button type="submit" class="btn btn-primary">Save Changes</button>
      </div>
    </form>
  </div>
</div>

<div class="toast-container" id="toastContainer"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STORAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SK = {
  users: 'sb_users',
  session: 'sb_session',
  chat: u => `sb_chat_${u}`,
  notifs: u => `sb_notifs_${u}`,
  perf: u => `sb_perf_${u}`,
};
const ls = {
  get: k => { try { return JSON.parse(localStorage.getItem(k)); } catch { return null; } },
  set: (k,v) => localStorage.setItem(k, JSON.stringify(v)),
  del: k => localStorage.removeItem(k),
};
function getUsers(){ return ls.get(SK.users) || {}; }
function saveUsers(u){ ls.set(SK.users, u); }
function getSession(){ return ls.get(SK.session); }
function saveSession(s){ ls.set(SK.session, s); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentUser = null;

function switchTab(tab){
  document.getElementById('tabLogin').classList.toggle('active', tab==='login');
  document.getElementById('tabReg').classList.toggle('active', tab==='register');
  document.getElementById('loginForm').style.display = tab==='login' ? '' : 'none';
  document.getElementById('regForm').style.display = tab==='register' ? '' : 'none';
}

function renderSavedUsers(){
  const users = getUsers();
  const keys = Object.keys(users);
  const wrap = document.getElementById('savedUsersWrap');
  if(!keys.length){ wrap.innerHTML=''; return; }
  wrap.innerHTML = `<div class="auth-divider"><span>Quick login</span></div><div class="quick-users">${keys.map(email=>`
    <div class="quick-chip" onclick="quickFill('${email}','${users[email].name}')">
      <div class="quick-chip-avatar">${users[email].name[0].toUpperCase()}</div>
      <span>${users[email].name}</span>
    </div>`).join('')}</div>`;
}

function quickFill(email, name){
  document.getElementById('l-email').value = email;
  document.getElementById('l-pass').focus();
}

function doLogin(){
  const email = document.getElementById('l-email').value.trim().toLowerCase();
  const pass = document.getElementById('l-pass').value;
  const err = document.getElementById('l-err');
  if(!email||!pass){ err.textContent='Please fill in all fields.'; return; }
  const users = getUsers();
  if(!users[email]){ err.textContent='No account found. Please register.'; return; }
  if(users[email].password !== btoa(pass)){ err.textContent='Incorrect password.'; return; }
  err.textContent='';
  saveSession({ email, name: users[email].name, loginTime: Date.now() });
  startApp(email, users[email].name);
}

function doRegister(){
  const name = document.getElementById('r-name').value.trim();
  const email = document.getElementById('r-email').value.trim().toLowerCase();
  const pass = document.getElementById('r-pass').value;
  const pass2 = document.getElementById('r-pass2').value;
  const err = document.getElementById('r-err');
  if(!name||!email||!pass){ err.textContent='Please fill in all fields.'; return; }
  if(!email.includes('@')){ err.textContent='Please enter a valid email address.'; return; }
  if(pass.length < 4){ err.textContent='Password must be at least 4 characters.'; return; }
  if(pass !== pass2){ err.textContent='Passwords do not match.'; return; }
  const users = getUsers();
  if(users[email]){ err.textContent='An account with this email already exists. Please login.'; return; }
  users[email] = { name, password: btoa(pass), createdAt: Date.now() };
  saveUsers(users);
  err.textContent='';
  saveSession({ email, name, loginTime: Date.now() });
  startApp(email, name);
}

function doLogout(){
  if(!confirm('Log out?')) return;
  saveChatHistory();
  ls.del(SK.session);
  currentUser = null; chatHistory = []; notifications = [];
  document.getElementById('mainApp').style.display = 'none';
  document.getElementById('authScreen').style.display = 'flex';
  document.getElementById('l-email').value='';
  document.getElementById('l-pass').value='';
  document.getElementById('l-err').textContent='';
  renderSavedUsers();
}

function startApp(email, name){
  currentUser = { email, name };
  document.getElementById('authScreen').style.display = 'none';
  document.getElementById('mainApp').style.display = 'grid';
  document.getElementById('uName').textContent = name.split(' ')[0];
  document.getElementById('uAvatar').textContent = name[0].toUpperCase();

  // Greeting
  const h = new Date().getHours();
  const greet = h<12 ? 'Good morning' : h<17 ? 'Good afternoon' : 'Good evening';
  document.getElementById('dashGreeting').innerHTML = `${greet}, <span>${name.split(' ')[0]}!</span> ğŸ‘‹`;

  // Restore chat & notifs
  chatHistory = ls.get(SK.chat(email)) || [];
  notifications = ls.get(SK.notifs(email)) || [];
  restoreChatUI();
  renderNotifBadge();

  loadTasks();
  // No auto-refresh â€” only manual refresh on user actions
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let tasks=[], filterPriority='all', filterStatus=null;
let chatHistory=[], notifications=[];
let taskChartInst=null, perfChartInst=null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toast(msg,type='info'){
  const el=document.createElement('div');
  el.className=`toast ${type}`;
  el.textContent=msg;
  document.getElementById('toastContainer').appendChild(el);
  setTimeout(()=>el.remove(), 3200);
}
function escHtml(s){ return(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function fmtDate(s){ if(!s)return null; return new Date(s+'T00:00:00').toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'}); }
function isOverdue(s){ return s && new Date(s+'T23:59:59') < new Date(); }
async function api(method,path,body){
  const res=await fetch(path,{method,headers:body?{'Content-Type':'application/json'}:{},body:body?JSON.stringify(body):undefined});
  return res.json();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NOTIFICATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addNotif(text, icon='ğŸ“Œ', type='info'){
  if(!currentUser) return;
  const n = { id: Date.now(), text, icon, type, time: new Date().toLocaleTimeString(), read: false };
  notifications.unshift(n);
  notifications = notifications.slice(0,30);
  ls.set(SK.notifs(currentUser.email), notifications);
  renderNotifBadge();
  renderNotifList();
}

function renderNotifBadge(){
  const unread = notifications.filter(n=>!n.read).length;
  const badge = document.getElementById('notifBadge');
  badge.textContent = unread;
  badge.classList.toggle('hidden', unread===0);
}

function renderNotifList(){
  const list = document.getElementById('notifList');
  if(!notifications.length){
    list.innerHTML=`<div class="notif-empty">ğŸ‰ You're all caught up!</div>`;
    return;
  }
  list.innerHTML = notifications.map(n=>`
    <div class="notif-item ${n.read?'':'unread'}" onclick="markRead(${n.id})">
      <div class="notif-icon">${n.icon}</div>
      <div class="notif-body">
        <div class="notif-text">${escHtml(n.text)}</div>
        <div class="notif-time">${n.time}</div>
      </div>
    </div>`).join('');
}

function markRead(id){
  const n = notifications.find(n=>n.id===id);
  if(n) n.read=true;
  ls.set(SK.notifs(currentUser.email), notifications);
  renderNotifBadge();
  renderNotifList();
}

function clearNotifs(){
  notifications=[];
  ls.set(SK.notifs(currentUser.email), notifications);
  renderNotifBadge();
  renderNotifList();
}

function toggleNotifPanel(){
  const p=document.getElementById('notifPanel');
  p.classList.toggle('open');
  if(p.classList.contains('open')){
    notifications.forEach(n=>n.read=true);
    ls.set(SK.notifs(currentUser.email), notifications);
    renderNotifBadge();
    renderNotifList();
  }
}

function checkDeadlineNotifs(){
  const today = new Date();
  tasks.forEach(t=>{
    if(t.status==='completed' || !t.due_date) return;
    const due = new Date(t.due_date+'T23:59:59');
    const diffDays = Math.ceil((due-today)/(1000*60*60*24));
    if(diffDays<0){
      addNotif(`"${t.title}" is overdue!`, 'âš ï¸', 'error');
    } else if(diffDays===0){
      addNotif(`"${t.title}" is due today!`, 'ğŸ”¥', 'warn');
    } else if(diffDays===1){
      addNotif(`"${t.title}" is due tomorrow`, 'ğŸ“…', 'info');
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TASKS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadTasks(){
  try{
    tasks = await api('GET','/api/tasks');
    renderTasks();
    updateSidebarStats();
    renderDashboard();
    checkDeadlineNotifs();
  } catch(e){ toast('Cannot connect to server','error'); }
}

function updateSidebarStats(){
  document.getElementById('sPending').textContent = tasks.filter(t=>t.status==='pending').length;
  document.getElementById('sProgress').textContent = tasks.filter(t=>t.status==='in-progress').length;
  document.getElementById('sDone').textContent = tasks.filter(t=>t.status==='completed').length;
  document.getElementById('sHigh').textContent = tasks.filter(t=>t.priority==='high'&&t.status!=='completed').length;
  const total = tasks.length;
  const done = tasks.filter(t=>t.status==='completed').length;
  document.getElementById('headerStats').innerHTML = `<strong>${total}</strong> tasks Â· <strong>${done}</strong> completed`;
  document.getElementById('taskCount').textContent = `${tasks.length} tasks total`;
}

function renderTasks(){
  const q = document.getElementById('searchBox')?.value.toLowerCase() || '';
  const filtered = tasks.filter(t=>
    (filterPriority==='all' || t.priority===filterPriority) &&
    (!filterStatus || t.status===filterStatus) &&
    (!q || t.title.toLowerCase().includes(q) || (t.subject||'').toLowerCase().includes(q) || (t.description||'').toLowerCase().includes(q))
  );
  const grid = document.getElementById('taskGrid');
  if(!filtered.length){
    grid.innerHTML=`<div class="empty-state"><div class="big">ğŸ“­</div><p>No tasks found. Add one!</p></div>`;
    return;
  }
  grid.innerHTML = filtered.map(taskCardHtml).join('');
}

function taskCardHtml(t){
  const ov = isOverdue(t.due_date) && t.status!=='completed';
  const subs = (t.subtasks||[]).map((s,i)=>`
    <div class="subtask-item ${s.done?'done':''}" onclick="toggleSubtask('${t.id}',${i})">
      <div class="subtask-check">${s.done?'âœ“':''}</div>
      <span>${escHtml(s.text)}</span>
    </div>`).join('');
  return `<div class="task-card priority-${t.priority} ${t.status==='completed'?'completed':''}">
    <div class="task-card-top">
      <div class="task-title">${escHtml(t.title)}</div>
      <div class="task-card-actions">
        <button class="icon-btn ai-btn" onclick="genSubtasksForTask('${t.id}')" title="AI subtasks">âœ¨</button>
        <button class="icon-btn" onclick="openEdit('${t.id}')" title="Edit">âœï¸</button>
        <button class="icon-btn" onclick="toggleComplete('${t.id}')" title="Toggle done">âœ…</button>
        <button class="icon-btn danger" onclick="deleteTask('${t.id}')" title="Delete">ğŸ—‘</button>
      </div>
    </div>
    ${t.description?`<div class="task-desc">${escHtml(t.description)}</div>`:''}
    <div class="task-meta">
      ${t.subject?`<span class="badge badge-subject">${escHtml(t.subject)}</span>`:''}
      <span class="badge badge-${t.priority}">${t.priority}</span>
      <span class="badge badge-${t.status}">${t.status}</span>
    </div>
    ${t.due_date?`<div class="task-due ${ov?'overdue':''}">${ov?'âš ï¸':'ğŸ“…'} ${fmtDate(t.due_date)}${ov?' Â· Overdue!':''}</div>`:''}
    ${subs?`<div class="subtasks-list">${subs}</div>`:''}
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDashboard(){
  const total=tasks.length, done=tasks.filter(t=>t.status==='completed').length;
  const pending=tasks.filter(t=>t.status==='pending').length;
  const inprog=tasks.filter(t=>t.status==='in-progress').length;
  const high=tasks.filter(t=>t.priority==='high'&&t.status!=='completed').length;
  const overdue=tasks.filter(t=>isOverdue(t.due_date)&&t.status!=='completed').length;
  const pct=total?Math.round(done/total*100):0;

  const msgs = [
    `You've completed ${pct}% of your tasks. Keep it up! ğŸš€`,
    `${pending} tasks waiting â€” tackle them one by one ğŸ’ª`,
    high?`${high} high-priority tasks need attention ğŸ”¥`:`No urgent tasks right now â€” great job! âœ…`,
    overdue?`âš ï¸ ${overdue} overdue task${overdue>1?'s':''} need immediate attention!`:`All tasks on schedule! ğŸ‰`,
  ];
  document.getElementById('dashSub').textContent = msgs[Math.floor(Date.now()/10000)%msgs.length];

  document.getElementById('kpiGrid').innerHTML=`
    <div class="kpi-card"><div class="kpi-icon">ğŸ“‹</div><div class="kpi-val blue">${total}</div><div class="kpi-label">Total Tasks</div></div>
    <div class="kpi-card"><div class="kpi-icon">âœ…</div><div class="kpi-val green">${done}</div><div class="kpi-label">Completed</div></div>
    <div class="kpi-card"><div class="kpi-icon">â³</div><div class="kpi-val">${pending}</div><div class="kpi-label">Pending</div></div>
    <div class="kpi-card"><div class="kpi-icon">âš¡</div><div class="kpi-val blue">${inprog}</div><div class="kpi-label">In Progress</div></div>
    <div class="kpi-card"><div class="kpi-icon">ğŸ”´</div><div class="kpi-val pink">${high}</div><div class="kpi-label">High Priority</div></div>
    <div class="kpi-card"><div class="kpi-icon">ğŸ“Š</div><div class="kpi-val green">${pct}%</div><div class="kpi-label">Completion</div></div>
  `;

  // Chart
  const ctx=document.getElementById('taskChart').getContext('2d');
  if(taskChartInst) taskChartInst.destroy();
  taskChartInst=new Chart(ctx,{
    type:'doughnut',
    data:{labels:['Completed','In Progress','Pending'],datasets:[{data:[done,inprog,pending],backgroundColor:['#4ade80','#38bdf8','#1e3050'],borderColor:'#0f1623',borderWidth:3,hoverOffset:6}]},
    options:{responsive:true,maintainAspectRatio:false,cutout:'65%',plugins:{legend:{position:'bottom',labels:{color:'#94a3b8',font:{size:11},padding:16}}}}
  });

  // Streak
  const days=['Su','Mo','Tu','We','Th','Fr','Sa'];
  const today=new Date();
  let streakCount=0, checkStreak=true;
  let streakHtml='';
  for(let i=6;i>=0;i--){
    const d=new Date(today); d.setDate(d.getDate()-i);
    const ds=d.toISOString().split('T')[0];
    const active=tasks.some(t=>t.status==='completed'&&t.updated_at&&t.updated_at.startsWith(ds));
    const isToday=i===0;
    if(checkStreak){ if(active||(isToday)){ if(active)streakCount++; } else if(!isToday){ checkStreak=false; } }
    streakHtml+=`<div class="s-day ${active?'active':''} ${isToday?'today':''}"><div class="s-label">${days[d.getDay()]}</div><div class="s-dot"></div></div>`;
  }
  document.getElementById('streakDays').innerHTML=streakHtml;
  document.getElementById('streakCount').textContent=streakCount;

  // Recent
  const recent=[...tasks].sort((a,b)=>new Date(b.updated_at)-new Date(a.updated_at)).slice(0,6);
  const dotColor={pending:'#fb923c','in-progress':'#38bdf8',completed:'#4ade80'};
  document.getElementById('recentList').innerHTML=recent.length?recent.map(t=>`
    <div class="recent-item">
      <div class="recent-dot" style="background:${dotColor[t.status]||'#64748b'}"></div>
      <div class="recent-title">${escHtml(t.title)}</div>
      ${t.subject?`<span class="badge badge-subject" style="font-size:10px;">${escHtml(t.subject)}</span>`:''}
      <span class="recent-status badge badge-${t.status}">${t.status}</span>
    </div>`).join(''):'<div style="color:var(--text3);padding:12px;font-size:13px;">No tasks yet â€” add one to get started!</div>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PERFORMANCE PAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPerformance(){
  const total=tasks.length, done=tasks.filter(t=>t.status==='completed').length;
  const high=tasks.filter(t=>t.priority==='high').length, highDone=tasks.filter(t=>t.priority==='high'&&t.status==='completed').length;
  const overdue=tasks.filter(t=>isOverdue(t.due_date)&&t.status!=='completed').length;
  const pct=total?Math.round(done/total*100):0;
  const onTime=done-overdue>0?done-overdue:done;
  const onTimePct=done?Math.round(onTime/done*100):0;

  document.getElementById('perfGrid').innerHTML=`
    <div class="perf-card"><div class="perf-card-title">Completion Rate</div><div class="perf-card-val" style="color:var(--accent)">${pct}%</div><div class="perf-card-desc">${done} of ${total} tasks done</div></div>
    <div class="perf-card"><div class="perf-card-title">High Priority Done</div><div class="perf-card-val" style="color:var(--accent3)">${highDone}/${high}</div><div class="perf-card-desc">Urgent tasks tackled</div></div>
    <div class="perf-card"><div class="perf-card-title">On-Time Rate</div><div class="perf-card-val" style="color:var(--accent2)">${onTimePct}%</div><div class="perf-card-desc">Tasks completed on schedule</div></div>
    <div class="perf-card"><div class="perf-card-title">Overdue</div><div class="perf-card-val" style="color:${overdue>0?'var(--accent3)':'var(--accent)'}">${overdue}</div><div class="perf-card-desc">${overdue?'Need attention!':'Looking great! âœ…'}</div></div>
  `;

  // Subject progress
  const subjects={};
  tasks.forEach(t=>{
    const s=t.subject||'General';
    if(!subjects[s]) subjects[s]={total:0,done:0};
    subjects[s].total++;
    if(t.status==='completed') subjects[s].done++;
  });
  const colors=['#4ade80','#38bdf8','#f472b6','#fb923c','#a78bfa','#34d399'];
  document.getElementById('subjectProgress').innerHTML=Object.entries(subjects).map(([subj,data],i)=>{
    const p=data.total?Math.round(data.done/data.total*100):0;
    return`<div class="perf-item">
      <div class="perf-label">${subj}</div>
      <div class="perf-bar-wrap"><div class="perf-bar" style="width:${p}%;background:${colors[i%colors.length]}"></div></div>
      <div class="perf-pct">${p}%</div>
    </div>`;
  }).join('') || '<div style="color:var(--text3);font-size:13px;padding:12px 0;">Add tasks with subjects to see progress.</div>';

  // 28-day heatmap
  const today=new Date();
  let heatHtml='';
  for(let i=27;i>=0;i--){
    const d=new Date(today); d.setDate(d.getDate()-i);
    const ds=d.toISOString().split('T')[0];
    const count=tasks.filter(t=>t.status==='completed'&&t.updated_at&&t.updated_at.startsWith(ds)).length;
    const lvl=count===0?'':count===1?'l1':count===2?'l2':count<=4?'l3':'l4';
    heatHtml+=`<div class="heat-cell ${lvl}" title="${ds}: ${count} completed"></div>`;
  }
  document.getElementById('heatmap').innerHTML=heatHtml;

  // Weekly chart
  const ctx2=document.getElementById('perfChart').getContext('2d');
  if(perfChartInst) perfChartInst.destroy();
  const weeks=['5w ago','4w ago','3w ago','2w ago','Last week','This week'];
  const weekData=weeks.map((_,wi)=>{
    const start=new Date(today); start.setDate(start.getDate()-(5-wi)*7-6);
    const end=new Date(today); end.setDate(end.getDate()-(5-wi)*7);
    return tasks.filter(t=>{
      if(t.status!=='completed'||!t.updated_at) return false;
      const d=new Date(t.updated_at); return d>=start&&d<=end;
    }).length;
  });
  perfChartInst=new Chart(ctx2,{
    type:'bar',
    data:{labels:weeks,datasets:[{label:'Tasks Completed',data:weekData,backgroundColor:'rgba(74,222,128,0.25)',borderColor:'#4ade80',borderWidth:2,borderRadius:8}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:{color:'#64748b'},grid:{color:'rgba(30,48,80,0.5)'}},y:{ticks:{color:'#64748b',stepSize:1},grid:{color:'rgba(30,48,80,0.5)'}}}}
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showPage(name,btn){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('page-'+name).classList.add('active');
  if(btn) btn.classList.add('active');
  else { const b=document.querySelector(`[data-page="${name}"]`); if(b) b.classList.add('active'); }
  if(name==='upcoming') loadUpcoming();
  if(name==='performance') renderPerformance();
  if(name==='dashboard') renderDashboard();
  closeSidebar();
}
function setBN(id){ document.querySelectorAll('.bn-btn').forEach(b=>b.classList.remove('active')); document.getElementById(id)?.classList.add('active'); }
function toggleSidebar(){ document.getElementById('sidebar').classList.toggle('open'); document.getElementById('drawerOverlay').classList.toggle('open'); }
function closeSidebar(){ document.getElementById('sidebar').classList.remove('open'); document.getElementById('drawerOverlay').classList.remove('open'); }
function toggleAI(){ const p=document.getElementById('aiPanel'); const o=document.getElementById('drawerOverlay'); const open=p.classList.toggle('open'); o.classList.toggle('open',open); document.getElementById('notifPanel').classList.remove('open'); }
function closeAll(){ document.getElementById('sidebar').classList.remove('open'); document.getElementById('aiPanel').classList.remove('open'); document.getElementById('notifPanel').classList.remove('open'); document.getElementById('drawerOverlay').classList.remove('open'); }
function setPriorityFilter(val,btn){ filterPriority=val; document.querySelectorAll('.filter-chip').forEach(c=>c.classList.remove('active')); btn.classList.add('active'); renderTasks(); }
function quickFilter(val){ filterStatus=val; showPage('tasks',null); renderTasks(); }

async function loadUpcoming(){
  const items=await api('GET','/api/upcoming?days=14');
  const list=document.getElementById('upcomingList');
  if(!items.length){ list.innerHTML=`<div class="empty-state"><div class="big">ğŸ‰</div><p>Nothing due in the next 2 weeks!</p></div>`; return; }
  list.innerHTML=items.map(t=>{
    const d=new Date(t.due_date+'T00:00:00');
    return`<div class="tl-item">
      <div class="tl-date"><div class="tl-day">${d.getDate()}</div><div class="tl-month">${d.toLocaleString('en',{month:'short'})}</div></div>
      <div class="tl-content"><div class="tl-title">${escHtml(t.title)}</div>
      <div class="task-meta">${t.subject?`<span class="badge badge-subject">${escHtml(t.subject)}</span>`:''}<span class="badge badge-${t.priority}">${t.priority}</span></div></div>
      <div class="tl-actions"><button class="icon-btn" onclick="openEdit('${t.id}')">âœï¸</button><button class="icon-btn" onclick="toggleComplete('${t.id}')">âœ…</button></div>
    </div>`;}).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CRUD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function submitTask(e){
  e.preventDefault();
  const data={title:document.getElementById('f-title').value,subject:document.getElementById('f-subject').value,due_date:document.getElementById('f-due').value||null,priority:document.getElementById('f-priority').value,status:document.getElementById('f-status').value,description:document.getElementById('f-desc').value};
  const res=await api('POST','/api/tasks',data);
  if(res.error){ toast(res.error,'error'); return; }
  toast('Task added! âœ…','success');
  addNotif(`New task added: "${data.title}"`, 'â•');
  resetForm(); await loadTasks();
  showPage('tasks',null); setBN('bn-tasks');
}
function resetForm(){ ['f-title','f-subject','f-due','f-desc'].forEach(id=>document.getElementById(id).value=''); document.getElementById('f-priority').value='medium'; document.getElementById('f-status').value='pending'; }

async function deleteTask(id){
  if(!confirm('Delete this task?')) return;
  const t=tasks.find(t=>t.id===id);
  await api('DELETE',`/api/tasks/${id}`);
  toast('Task deleted','info');
  addNotif(`Task deleted: "${t?.title}"`, 'ğŸ—‘');
  await loadTasks();
}

async function toggleComplete(id){
  const task=tasks.find(t=>t.id===id); if(!task) return;
  const ns=task.status==='completed'?'pending':'completed';
  await api('PUT',`/api/tasks/${id}`,{status:ns});
  toast(ns==='completed'?'âœ… Task completed!':'ğŸ”„ Task reopened','success');
  if(ns==='completed') addNotif(`Completed: "${task.title}"`, 'âœ…');
  await loadTasks();
}

function toggleSubtask(taskId,idx){
  const task=tasks.find(t=>t.id===taskId); if(!task||!task.subtasks) return;
  task.subtasks[idx].done=!task.subtasks[idx].done; renderTasks();
}

function openEdit(id){
  const t=tasks.find(t=>t.id===id); if(!t) return;
  document.getElementById('e-id').value=t.id;
  document.getElementById('e-title').value=t.title;
  document.getElementById('e-subject').value=t.subject||'';
  document.getElementById('e-due').value=t.due_date||'';
  document.getElementById('e-priority').value=t.priority;
  document.getElementById('e-status').value=t.status;
  document.getElementById('e-desc').value=t.description||'';
  document.getElementById('editModal').classList.add('open');
}
function closeModal(){ document.getElementById('editModal').classList.remove('open'); }
async function submitEdit(e){
  e.preventDefault();
  const id=document.getElementById('e-id').value;
  const data={title:document.getElementById('e-title').value,subject:document.getElementById('e-subject').value,due_date:document.getElementById('e-due').value||null,priority:document.getElementById('e-priority').value,status:document.getElementById('e-status').value,description:document.getElementById('e-desc').value};
  const res=await api('PUT',`/api/tasks/${id}`,data);
  if(res.error){ toast(res.error,'error'); return; }
  toast('Updated! âœ…','success');
  closeModal(); await loadTasks();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function aiSuggestPriority(){
  const title=document.getElementById('f-title').value; if(!title){ toast('Enter a title first','info'); return; }
  toast('âœ¨ Asking AI...','info');
  try{
    const res=await api('POST','/api/ai/chat',{message:`Suggest priority (ONLY one word: low, medium, or high) for: "${title}"`,history:[]});
    const word=res.reply?.toLowerCase().match(/\b(low|medium|high)\b/);
    if(word){ document.getElementById('f-priority').value=word[0]; toast(`AI suggests: ${word[0]} priority âœ¨`,'success'); }
  }catch(e){ toast('AI unavailable','error'); }
}

async function genSubtasks(){ await genSubtasksForTask(document.getElementById('e-id').value); }
async function genSubtasksForTask(id){
  toast('âœ¨ Generating subtasks...','info');
  const res=await api('POST',`/api/ai/subtasks/${id}`);
  if(res.error){ toast(res.error,'error'); return; }
  const task=tasks.find(t=>t.id===id);
  if(task){ task.subtasks=res.subtasks.map(s=>({text:s,done:false})); renderTasks(); toast(`Generated ${res.subtasks.length} subtasks! âœ¨`,'success'); }
}

function saveChatHistory(){ if(currentUser) ls.set(SK.chat(currentUser.email), chatHistory.slice(-40)); }

async function sendMsg(){
  const input=document.getElementById('aiInput'); const msg=input.value.trim(); if(!msg) return;
  input.value='';
  appendBubble('user',msg);
  chatHistory.push({role:'user',content:msg});
  saveChatHistory();
  document.getElementById('sendBtn').disabled=true;
  const tid='t-'+Date.now();
  document.getElementById('aiMessages').insertAdjacentHTML('beforeend',`<div class="msg ai" id="${tid}"><div class="msg-av">ğŸ¤–</div><div class="msg-bubble"><div class="typing-row"><div class="t-dot"></div><div class="t-dot"></div><div class="t-dot"></div></div></div></div>`);
  scrollChat();
  try{
    const res=await api('POST','/api/ai/chat',{message:msg,history:chatHistory.slice(-10)});
    document.getElementById(tid)?.remove();
    const reply=res.reply||res.error||'Something went wrong.';
    appendBubble('ai',reply);
    chatHistory.push({role:'assistant',content:reply});
    saveChatHistory();
  }catch(e){ document.getElementById(tid)?.remove(); appendBubble('ai','âš ï¸ Could not reach the server.'); }
  document.getElementById('sendBtn').disabled=false;
}

function appendBubble(role,text){
  const av=role==='ai'?'ğŸ¤–':'ğŸ§‘';
  document.getElementById('aiMessages').insertAdjacentHTML('beforeend',
    `<div class="msg ${role}">${role==='ai'?`<div class="msg-av">${av}</div>`:''}<div class="msg-bubble">${escHtml(text).replace(/\n/g,'<br>')}</div>${role==='user'?`<div class="msg-av">${av}</div>`:''}</div>`);
  scrollChat();
}
function scrollChat(){ const el=document.getElementById('aiMessages'); el.scrollTop=el.scrollHeight; }
function qp(text){ document.getElementById('aiInput').value=text; sendMsg(); }

function restoreChatUI(){
  const c=document.getElementById('aiMessages'); c.innerHTML='';
  if(!chatHistory.length){
    c.innerHTML=`<div class="msg ai"><div class="msg-av">ğŸ¤–</div><div class="msg-bubble">Hey ${currentUser.name.split(' ')[0]}! ğŸ‘‹ I'm StudyBot. I remember our previous chats and can see all your tasks.<br><br>What would you like help with today?</div></div>`;
    return;
  }
  chatHistory.forEach(m=>{ if(m.role!=='system') appendBubble(m.role==='user'?'user':'ai', m.content); });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function init(){
  renderSavedUsers();
  const session=getSession();
  if(session?.email){
    const users=getUsers();
    if(users[session.email]){
      startApp(session.email, users[session.email].name);
    } else { ls.del(SK.session); }
  }
})();
</script>
</body>
</html>